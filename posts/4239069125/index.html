<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="private,安卓优化," />










<meta name="description" content="Android稳定性优化正确认识稳定性纬度应用的稳定性可以分为三个纬度，如下所示：  1、Crash纬度：最重要的指标就是应用的Crash率。 2、性能纬度：包括启动速度、内存、绘制等等优化方向，相对于Crash来说是次要的，在做应用性能体系化建设之前，我们必须要确保应用的功能稳定可用。 3、业务高可用纬度：它是非常关键的一步，我们需要采用多种手段来保证我们App的主流程以及核心路径的稳定性，只有">
<meta property="og:type" content="article">
<meta property="og:title" content="优化-稳定性优化">
<meta property="og:url" content="http://shenbh.github.io/posts/4239069125/index.html">
<meta property="og:site_name" content="AB">
<meta property="og:description" content="Android稳定性优化正确认识稳定性纬度应用的稳定性可以分为三个纬度，如下所示：  1、Crash纬度：最重要的指标就是应用的Crash率。 2、性能纬度：包括启动速度、内存、绘制等等优化方向，相对于Crash来说是次要的，在做应用性能体系化建设之前，我们必须要确保应用的功能稳定可用。 3、业务高可用纬度：它是非常关键的一步，我们需要采用多种手段来保证我们App的主流程以及核心路径的稳定性，只有">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/981009fdly1gm4u8uyndlj20rw0kc43e.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/981009fdly1gm4v59tu77j20rw0kcae4.jpg">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4a519cbcd0dd40f29ec6407104a04fbe~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="article:published_time" content="2020-09-03T02:31:58.000Z">
<meta property="article:modified_time" content="2022-05-05T06:52:45.261Z">
<meta property="article:author" content="阿炳">
<meta property="article:tag" content="private">
<meta property="article:tag" content="安卓优化">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://ww1.sinaimg.cn/large/981009fdly1gm4u8uyndlj20rw0kc43e.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://shenbh.github.io/posts/4239069125/"/>





  <title>优化-稳定性优化 | AB</title><meta name="robots" content="noindex">
  








<meta name="generator" content="Hexo 6.1.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">AB</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Just do IT Now.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://shenbh.github.io/posts/4239069125/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AB">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">优化-稳定性优化</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-09-03T10:31:58+08:00">
                2020-09-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Android稳定性优化"><a href="#Android稳定性优化" class="headerlink" title="Android稳定性优化"></a><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903972587716621">Android稳定性优化</a></h1><h1 id="正确认识"><a href="#正确认识" class="headerlink" title="正确认识"></a>正确认识</h1><h2 id="稳定性纬度"><a href="#稳定性纬度" class="headerlink" title="稳定性纬度"></a>稳定性纬度</h2><p>应用的稳定性可以分为三个纬度，如下所示：</p>
<ul>
<li>1、<strong>Crash纬度</strong>：最重要的指标就是应用的<strong>Crash率</strong>。</li>
<li>2、<strong>性能纬度</strong>：包括启动速度、内存、绘制等等优化方向，相对于Crash来说是次要的，在做<strong>应用性能体系化建设</strong>之前，我们必须要确保应用的功能稳定可用。</li>
<li>3、<strong>业务高可用纬度</strong>：它是非常关键的一步，我们需要<strong>采用多种手段来保证我们App的主流程以及核心路径的稳定性</strong>，只有用户经常使用我们的App，它才有可能发现别的方面的问题。</li>
</ul>
<h2 id="稳定性优化注意事项"><a href="#稳定性优化注意事项" class="headerlink" title="稳定性优化注意事项"></a>稳定性优化注意事项</h2><p>我们在做应用的稳定性优化的时候，需要注意三个要点，如下所示：</p>
<h3 id="1、重在预防、监控必不可少"><a href="#1、重在预防、监控必不可少" class="headerlink" title="1、重在预防、监控必不可少"></a>1、重在预防、监控必不可少</h3><p>对于稳定性来说，如果App已经到了线上才发现异常，那其实已经造成了损失，所以，对于稳定性的优化，其重点在于预防。<strong>从开发同学的编码环节，到测试同学的测试环节，以及到上线前的发布环节、上线后的运维环节，这些环节都需要来预防异常情况的发生</strong>。如果异常真的发生了，也需要将想方设法将损失降到最低，争取用最小的代价来暴露尽可能多的问题。</p>
<p>此外，监控也是必不可少的一步，预防做的再好，到了线上，总会有各种各样的异常发生。所以，无论如何，我们都<strong>需要有全面的监控手段来更加灵敏地发现问题</strong>。</p>
<h3 id="2、思考更深一层、重视隐含信息：如解决Crash问题时思考是否会引发同一类问题"><a href="#2、思考更深一层、重视隐含信息：如解决Crash问题时思考是否会引发同一类问题" class="headerlink" title="2、思考更深一层、重视隐含信息：如解决Crash问题时思考是否会引发同一类问题"></a>2、思考更深一层、重视隐含信息：如解决Crash问题时思考是否会引发同一类问题</h3><p>当我们看到了一个Crash的时候，不能简单地只处理这一个Crash，而是需要思考更深一层，要考虑会不会在其它地方会有一样的Crash类型发生。如果有这样的情况，我们必须<strong>对其统一处理和预防</strong>。</p>
<p>此外，我们还要关注Crash相关的隐含信息，比如，在面试过程当中，面试官问你，你们应用的Crash率是多少，这个问题表明上问的是Crash率，但是实际上它是问你一些隐含信息的，<strong>过高的Crash率就代表开发人员的水平不行，leader的架构能力不行，项目的各个阶段中优化的空间非常大</strong>，这样一来，面试官对你的印象和评价也不会好。</p>
<h3 id="3、长效保持需要科学流程"><a href="#3、长效保持需要科学流程" class="headerlink" title="3、长效保持需要科学流程"></a>3、长效保持需要科学流程</h3><p>应用稳定性的建设过程是一个细活，所以很容易出现这个版本优化好了，但是在接下来的版本中如果我们不管它，它就会发生持续恶化的情况，因此，我们<strong>必须从项目研发的每一个流程入手，建立科学完善的相关规范，才能保证长效的优化效果</strong>。</p>
<h2 id="Crash相关指标"><a href="#Crash相关指标" class="headerlink" title="Crash相关指标"></a>Crash相关指标</h2><h3 id="1、UV、PV"><a href="#1、UV、PV" class="headerlink" title="1、UV、PV"></a>1、UV、PV</h3><ul>
<li>PV（Page View）：访问量</li>
<li>UV（Unique Visitor）：独立访客，0 - 24小时内的同一终端只计算一次</li>
</ul>
<h3 id="2、UV、PV、启动、增量、存量-Crash率"><a href="#2、UV、PV、启动、增量、存量-Crash率" class="headerlink" title="2、UV、PV、启动、增量、存量 Crash率"></a>2、UV、PV、启动、增量、存量 Crash率</h3><ul>
<li><strong>UV Crash率（Crash UV &#x2F; DAU）</strong>：针对用户使用量的统计，统计一段时间内所有用户发生崩溃的占比，用于<strong>评估Crash率的影响范围</strong>，结合PV。需要注意的是，需要确保一直使用同一种衡量方式。</li>
<li><strong>PV Crash率</strong>：评估相关Crash影响的<strong>严重程度</strong>。</li>
<li><strong>启动Crash率</strong>：启动阶段，用户还没有完全打开App而发生的Crash，它是影响最严重的Crash，对用户伤害最大，无法通过热修复拯救，需结合客户端容灾，以进行App的自主修复。（这块后面会讲）</li>
<li><strong>增量、存量Crash率</strong>：增量Crash是指的<strong>新增的Crash</strong>，而存量Crash则表示一些<strong>历史遗留bug</strong>。增量Crash是新版本重点，存量Crash是需要持续啃的硬骨头，我们需要<strong>优先解决增量、持续跟进存量问题</strong>。</li>
</ul>
<h2 id="Crash率评价"><a href="#Crash率评价" class="headerlink" title="Crash率评价"></a>Crash率评价</h2><p>App的Crash率降低多少才能算是一个正常水平或优秀的水平呢？</p>
<ul>
<li>Java与Native的总崩溃率必须在千分之二以下。</li>
<li>Crash率万分位为优秀：需要注意90%的Crash都是比较容易解决的，但是要解决最后的10%需要付出巨大的努力。</li>
</ul>
<h2 id="Crash关键问题"><a href="#Crash关键问题" class="headerlink" title="Crash关键问题"></a>Crash关键问题</h2><p><strong>需要全面地采集应用发生Crash时的相关信息</strong>，如下所示：</p>
<ul>
<li>堆栈、设备、OS版本、进程、线程名、Logcat</li>
<li>前后台、使用时长、App版本、小版本、渠道</li>
<li>CPU架构、内存信息、线程数、资源包信息、用户行为日志</li>
</ul>
<p>采集完上述信息并上报到后台后，我们会在APM后台进行聚合展示，具体的展示信息如下所示：</p>
<ul>
<li>Crash现场信息</li>
<li>Crash Top机型、OS版本、分布版本、区域</li>
<li>Crash起始版本、上报趋势、是否新增、持续、量级</li>
</ul>
<p>最后，我们可以<strong>根据以上信息决定Crash是否需要立马解决以及在哪个版本进行解决</strong>，关于APM聚合展示这块可以参考 <strong>Bugly平台</strong> 的APM后台聚合展示。</p>
<h2 id="APM-Crash部分整体架构"><a href="#APM-Crash部分整体架构" class="headerlink" title="APM Crash部分整体架构"></a>APM Crash部分整体架构</h2><p>APM Crash部分的整体架构从上至下分为采集层、处理层、展示层、报警层。</p>
<h3 id="1）、采集层"><a href="#1）、采集层" class="headerlink" title="1）、采集层"></a>1）、采集层</h3><p>需要采集的信息主要为如下几种：</p>
<ul>
<li>错误堆栈</li>
<li>设备信息</li>
<li>行为日志</li>
<li>其它信息</li>
</ul>
<h3 id="2）、处理层"><a href="#2）、处理层" class="headerlink" title="2）、处理层"></a>2）、处理层</h3><ul>
<li>数据清洗：将一些不符合条件的数据过滤掉。如因一些特殊情况采集到的数据不全、上传的数据不全等要过滤掉</li>
<li>数据聚合</li>
<li>纬度分类：如Top机型下的Crash、用户Crash率的前10%等等纬度</li>
<li>趋势对比</li>
</ul>
<h3 id="3）、展示层"><a href="#3）、展示层" class="headerlink" title="3）、展示层"></a>3）、展示层</h3><ul>
<li>数据还原</li>
<li>纬度信息</li>
<li>起始版本</li>
<li>其它信息</li>
</ul>
<h3 id="4）、报警层"><a href="#4）、报警层" class="headerlink" title="4）、报警层"></a>4）、报警层</h3><p>可以通过 <strong>邮件、IM、电话、短信</strong> 等等方式通知相关的同学进行紧急处理</p>
<h2 id="责任归属"><a href="#责任归属" class="headerlink" title="责任归属"></a>责任归属</h2><ul>
<li><p>设立专项小组轮值：成立一个虚拟的专项小组，来专门跟踪每个版本线上的Crash率，<strong>组内的成员可以轮流跟踪线上的Crash</strong>，这样，就可以从源头来保证所有Crash一定会有人跟进。</p>
</li>
<li><p>自动匹配责任人：<strong>将APM平台与bug单系统打通，这样APM后台一旦发现紧急bug就能第一时间下发到bug单系统给相关责任人发提醒</strong>。</p>
</li>
<li><p>处理流程全纪录：我们需要<strong>记录Crash处理流程的每一步，确保紧急Crash的处理不会被延误</strong>。</p>
</li>
</ul>
<h1 id="Crash优化"><a href="#Crash优化" class="headerlink" title="Crash优化"></a>Crash优化</h1><h2 id="单个Crash处理方案"><a href="#单个Crash处理方案" class="headerlink" title="单个Crash处理方案"></a>单个Crash处理方案</h2><h3 id="1）、根据堆栈及现场信息找答案"><a href="#1）、根据堆栈及现场信息找答案" class="headerlink" title="1）、根据堆栈及现场信息找答案"></a>1）、根据堆栈及现场信息找答案</h3><ul>
<li>解决90%问题</li>
<li>解决完后需考虑产生Crash深层次的原因</li>
</ul>
<h3 id="2）、找共性：机型、OS、实验开关、资源包，考虑影响范围"><a href="#2）、找共性：机型、OS、实验开关、资源包，考虑影响范围" class="headerlink" title="2）、找共性：机型、OS、实验开关、资源包，考虑影响范围"></a>2）、找共性：机型、OS、实验开关、资源包，考虑影响范围</h3><h3 id="3）、线下复现、远程调试"><a href="#3）、线下复现、远程调试" class="headerlink" title="3）、线下复现、远程调试"></a>3）、线下复现、远程调试</h3><h2 id="Crash率治理方案"><a href="#Crash率治理方案" class="headerlink" title="Crash率治理方案"></a>Crash率治理方案</h2><h3 id="1）、解决线上常规Crash"><a href="#1）、解决线上常规Crash" class="headerlink" title="1）、解决线上常规Crash"></a>1）、解决线上常规Crash</h3><h3 id="2）、系统级Crash尝试Hook绕过"><a href="#2）、系统级Crash尝试Hook绕过" class="headerlink" title="2）、系统级Crash尝试Hook绕过"></a>2）、系统级Crash尝试Hook绕过</h3><h3 id="3）、疑难Crash重点突破或更换方案"><a href="#3）、疑难Crash重点突破或更换方案" class="headerlink" title="3）、疑难Crash重点突破或更换方案"></a>3）、疑难Crash重点突破或更换方案</h3><h2 id="Java-Crash"><a href="#Java-Crash" class="headerlink" title="Java Crash"></a>Java Crash</h2><p>出现未捕获的异常，导致退出。我们通过设置自定义<code>UncaughtExceptionHandler</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Thread.setDefaultUncaughtExceptionHandler();</span><br></pre></td></tr></table></figure>

<p>可以在崩溃发生的时候获取到现场信息。这个钩子针对<strong>单个进程</strong>而言，在多进程的App中，监控哪个进程，就要在哪个进程再设置一遍这个钩子。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取当前线程的堆栈信息</span></span><br><span class="line">Thread.currentThread().getStackTrace();</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取全部线程的堆栈信息</span></span><br><span class="line">Thread.getAllStackTraces();</span><br></pre></td></tr></table></figure>

<p>第三方Crash监控工具如<strong>Fabric、腾讯Bugly</strong>，都是以<strong>字符串拼接的方式将数组StackTraceElement[]转换成字符串形式</strong>，进行保存、上报和展示。</p>
<h3 id="我们如何反混淆上传的堆栈信息？"><a href="#我们如何反混淆上传的堆栈信息？" class="headerlink" title="我们如何反混淆上传的堆栈信息？"></a>我们如何反混淆上传的堆栈信息？</h3><p>有两种可选的处理方案：</p>
<ul>
<li>1、每次打包生成混淆APK的时候，需要把Mapping文件保存并上传到监控后台。</li>
<li>2、Android原生反混淆工具包是<code>retrace.jar</code>，在监控后台用来实时解析每个上报的崩溃时。<code>retrace.jar</code> 会将Mapping文件进行文本解析和对象实例化，这个过程比较耗时。因此可以<strong>将Mapping对象实例进行内存缓存</strong>，但为了防止内存泄露和内存过多占用，需要增加<strong>定期自动回收</strong>的逻辑。</li>
</ul>
<h3 id="如何获取logcat方法？"><a href="#如何获取logcat方法？" class="headerlink" title="如何获取logcat方法？"></a>如何获取logcat方法？</h3><p>logcat日志流程是这样的，<strong>应用层 –&gt; liblog.so –&gt; logd</strong>，底层使用 <strong>ring buffer</strong> 来存储数据。获取的方式有以下三种：</p>
<h4 id="1、通过logcat命令获取。"><a href="#1、通过logcat命令获取。" class="headerlink" title="1、通过logcat命令获取。"></a>1、通过logcat命令获取。</h4><ul>
<li>优点：非常简单，兼容性好。</li>
<li>缺点：整个链路比较长，可控性差，失败率高，特别是堆破坏或者堆内存不足时，基本会失败。</li>
</ul>
<h4 id="2、hook-liblog-so实现"><a href="#2、hook-liblog-so实现" class="headerlink" title="2、hook liblog.so实现"></a>2、hook liblog.so实现</h4><p>通过hook liblog.so 中的 <strong>__android_log_buf_write</strong> 方法，<strong>将内容重定向到自己的buffer中</strong>。</p>
<ul>
<li>优点：简单，兼容性相对还好。</li>
<li>缺点：要一直打开。</li>
</ul>
<h4 id="3、自定义获取代码。通过移植底层获取logcat的实现，通过socket直接跟logd交互。"><a href="#3、自定义获取代码。通过移植底层获取logcat的实现，通过socket直接跟logd交互。" class="headerlink" title="3、自定义获取代码。通过移植底层获取logcat的实现，通过socket直接跟logd交互。"></a>3、自定义获取代码。通过移植底层获取logcat的实现，通过socket直接跟logd交互。</h4><ul>
<li>优点：比较灵活，预先分配好资源，成功率也比较高。</li>
<li>缺点：实现非常复杂</li>
</ul>
<h3 id="如何获取Java-堆栈？"><a href="#如何获取Java-堆栈？" class="headerlink" title="如何获取Java 堆栈？"></a>如何获取Java 堆栈？</h3><p>当发生native崩溃时，我们<strong>通过unwind只能拿到Native堆栈</strong>。但是我们<strong>希望可以拿到当时各个线程的Java堆栈</strong>。对于这个问题，目前有两种处理方式，分别如下所示：</p>
<h4 id="1、Thread-getAllStackTraces-。"><a href="#1、Thread-getAllStackTraces-。" class="headerlink" title="1、Thread.getAllStackTraces()。"></a>1、Thread.getAllStackTraces()。</h4><h5 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h5><p>简单，兼容性好。</p>
<h5 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h5><ul>
<li>成功率不高，依靠系统接口在极端情况也会失败。</li>
<li>7.0之后这个接口是没有主线程堆栈。</li>
<li>使用Java层的接口需要暂停线程。</li>
</ul>
<h4 id="2、hook-libart-so。"><a href="#2、hook-libart-so。" class="headerlink" title="2、hook libart.so。"></a>2、hook libart.so。</h4><p>通过hook <strong>ThreadList和Thread</strong> 的函数，<strong>获得跟ANR一样的堆栈</strong>。为了稳定性，<strong>需要在fork的子进程中执行</strong>。</p>
<ul>
<li>优点：信息很全，基本跟ANR的日志一样，有native线程状态，锁信息等等。</li>
<li>缺点：黑科技的兼容性问题，失败时我们可以使用Thread.getAllStackTraces()兜底。</li>
</ul>
<h2 id="Java-Crash处理流程"><a href="#Java-Crash处理流程" class="headerlink" title="Java Crash处理流程"></a>Java Crash处理流程</h2><p><img src="http://ww1.sinaimg.cn/large/981009fdly1gm4u8uyndlj20rw0kc43e.jpg" alt="Java-Crash处理流程.png"></p>
<ol>
<li><p>首先发生Crash所在进程，在创建之初便准备好<code>defaultUncaughtHandler</code>，用来处理<code>Uncaught Exception</code>，并输出当前crash的基本信息</p>
</li>
<li><p>调用当前进程中<code>AMP .handleApplicationCrash</code>，经过<code>binder ipc</code>机制，传递到<code>System Process</code>进程</p>
</li>
<li><p>接下来，进入到<code>System Process</code>进程，调用binder服务端执行<code>AMS.handleApplicationCrash</code></p>
</li>
<li><p>从<code>mProcessNames</code>查找到目标进程的<code>ProcessRecord</code>对象；并将进程<code>crash</code>信息输出到目录<code>/data/system/dropbox</code></p>
</li>
<li><p>执行makeAppCrashingLocked</p>
<ul>
<li>创建当前用户下的crash应用的error receiver，并忽略当前应用的广播；</li>
<li>停止当前进程中所有activity中的WMS的冻结屏幕消息，并执行相关一些屏幕相关操作；</li>
</ul>
</li>
<li><p>再执行<code>handleAppCrashLocked</code>方法</p>
<ul>
<li>当1分钟内同一进程未发生连续<code>crash</code>两次时，则执行结束栈顶正在运行<code>activity</code>的流程</li>
<li>当1分钟内同一进程连续<code>crash</code>两次时，且非<code>persistent</code>进程，则直接结束该应用的所有<code>activity</code>，并杀死该进程以及同一个进程组下的所有进程。然后再恢复栈顶第一个非<code>finishing</code>状态的<code>activity</code></li>
<li>当1分钟内同一进程连续<code>crash</code>两次时，且<code>persistent</code>进程，则只执行恢复栈顶第一个非<code>finishing</code>状态的<code>activity</code></li>
</ul>
</li>
<li><p>通过<code>mUiHandler</code>发送消息<code>SHOW_ERROR_MSG</code>，弹出crash对话框</p>
</li>
<li><p>到此，system_server进程执行完成。回到crash进程开始执行杀掉当前进程的操作；</p>
</li>
<li><p>当crash进程被杀，通过binder死亡通知，告知system_server进程来执行appDiedLocked()；</p>
</li>
<li><p>最后，执行清理应用相关的四大组件信息。</p>
</li>
</ol>
<h3 id="补充加油站：binder-死亡通知原理"><a href="#补充加油站：binder-死亡通知原理" class="headerlink" title="补充加油站：binder 死亡通知原理"></a>补充加油站：binder 死亡通知原理</h3><p><img src="http://ww1.sinaimg.cn/large/981009fdly1gm4v59tu77j20rw0kcae4.jpg" alt="binder死亡通知原理.png"></p>
<p>由于<code>Crash</code>进程中拥有一个<code>Binder</code>服务端<code>ApplicationThread</code>，而应用进程在创建过程调用<code>attachApplicationLocked()</code>，从而<code>attach</code>到<code>system_server</code>进程，在<code>system_server</code>进程内有一个<code>ApplicationThreadProxy</code>，这是相对应的<code>Binder</code>客户端。当<code>Binder</code>服务端<code>ApplicationThread</code>所在进程（即<code>Crash</code>进程）挂掉后，则<code>Binder</code>客户端能收到相应的死亡通知，从而进入<code>binderDied</code>流程。</p>
<h2 id="NativeCrash"><a href="#NativeCrash" class="headerlink" title="NativeCrash"></a>NativeCrash</h2><p>特点:</p>
<ul>
<li>访问非法地址</li>
<li>地址对齐出错</li>
<li>发生程序主动abort</li>
</ul>
<p>上述都会产生相应的signal信号，导致程序异常退出。</p>
<h3 id="1、合格的异常捕获组件"><a href="#1、合格的异常捕获组件" class="headerlink" title="1、合格的异常捕获组件"></a>1、合格的异常捕获组件</h3><p>一个合格的异常捕获组件需要包含以下功能：</p>
<ul>
<li>支持在crash时进行更多扩展操作</li>
<li>打印logcat和日志</li>
<li>上报crash次数</li>
<li>对不同crash做不同恢复措施</li>
<li>可以针对业务不断改进的适应</li>
</ul>
<h3 id="2、现有方案"><a href="#2、现有方案" class="headerlink" title="2、现有方案"></a>2、现有方案</h3><h4 id="1、Google-Breakpad"><a href="#1、Google-Breakpad" class="headerlink" title="1、Google Breakpad"></a>1、Google Breakpad</h4><ul>
<li>优点：权威、跨平台</li>
<li>缺点：代码体量较大</li>
</ul>
<h4 id="2、Logcat"><a href="#2、Logcat" class="headerlink" title="2、Logcat"></a>2、Logcat</h4><ul>
<li>优点：利用安卓系统实现</li>
<li>缺点：需要在crash时启动新进程过滤logcat日志，不可靠</li>
</ul>
<h4 id="3、coffeecatch"><a href="#3、coffeecatch" class="headerlink" title="3、coffeecatch"></a>3、coffeecatch</h4><ul>
<li>优点：实现简洁、改动容易</li>
<li>缺点：有兼容性问题</li>
</ul>
<h3 id="3、Native崩溃捕获流程"><a href="#3、Native崩溃捕获流程" class="headerlink" title="3、Native崩溃捕获流程"></a>3、Native崩溃捕获流程</h3><h4 id="1、编译端"><a href="#1、编译端" class="headerlink" title="1、编译端"></a>1、编译端</h4><p>编译C&#x2F;C++需将带符号信息的文件保留下来。</p>
<h4 id="2、客户端"><a href="#2、客户端" class="headerlink" title="2、客户端"></a>2、客户端</h4><p>捕获到崩溃时，将收集到尽可能多的游泳信息写入日志文件，然后选择合适的时机上传到服务器</p>
<h4 id="3、服务端"><a href="#3、服务端" class="headerlink" title="3、服务端"></a>3、服务端</h4><p>读取客户端上报的日志文件，寻找合适的符号文件，生成可读的C&#x2F;C++调用栈。</p>
<h3 id="4、Native崩溃捕获的难点"><a href="#4、Native崩溃捕获的难点" class="headerlink" title="4、Native崩溃捕获的难点"></a>4、Native崩溃捕获的难点</h3><p>核心：如何确保客户端在各种极端情况下依然可以生成崩溃日志。</p>
<h4 id="1、文件句柄泄露，导致创建日志文件失败？"><a href="#1、文件句柄泄露，导致创建日志文件失败？" class="headerlink" title="1、文件句柄泄露，导致创建日志文件失败？"></a>1、文件句柄泄露，导致创建日志文件失败？</h4><p>提前申请文件句柄fd预留</p>
<h4 id="2、栈溢出导致日志生成失败？"><a href="#2、栈溢出导致日志生成失败？" class="headerlink" title="2、栈溢出导致日志生成失败？"></a>2、栈溢出导致日志生成失败？</h4><ul>
<li><p>使用额外的栈空间signalstack，避免栈溢出导致进程没有空间创建调用栈执行处理函数。</p>
<p>（signalstack：系统会在系统情况下把栈指针指向这个地方，使得可以在一个新的栈上运行信号处理函数）</p>
</li>
<li><p>特殊请求需直接替换当前栈，所以应在堆中预留部分空间。</p>
</li>
</ul>
<h4 id="3、堆内存耗尽导致日志生成失败？"><a href="#3、堆内存耗尽导致日志生成失败？" class="headerlink" title="3、堆内存耗尽导致日志生成失败？"></a>3、堆内存耗尽导致日志生成失败？</h4><p>参考Breakpad重新封装Linux Syscall Support的做法以避免直接调用libc去分配堆内存。</p>
<h4 id="4、堆破坏或二次崩溃导致日志生成失败？"><a href="#4、堆破坏或二次崩溃导致日志生成失败？" class="headerlink" title="4、堆破坏或二次崩溃导致日志生成失败？"></a>4、堆破坏或二次崩溃导致日志生成失败？</h4><p>Breakpad使用了fork子进程甚至孙进程的方式去收集崩溃现场，即便出现二次崩溃，也只是这部分信息丢失。</p>
<p>这里说下Breakpad缺点：</p>
<ul>
<li>生成的minidump文件是二进制的，包含过多不重要的信息，导致文件数过大。但minidump可以使用gdb调试、看到传入参数。</li>
</ul>
<p>需要了解的是，未来Chromium会使用Crashpad替代Breakpad。</p>
<h4 id="5、想要遵循Android的文本格式并添加更多重要的信息？"><a href="#5、想要遵循Android的文本格式并添加更多重要的信息？" class="headerlink" title="5、想要遵循Android的文本格式并添加更多重要的信息？"></a>5、想要遵循Android的文本格式并添加更多重要的信息？</h4><p>改造Breakpad，增加Logcat信息，Java调用栈信息、其它有用信息。</p>
<h3 id="5、Native崩溃捕获注册"><a href="#5、Native崩溃捕获注册" class="headerlink" title="5、Native崩溃捕获注册"></a>5、Native崩溃捕获注册</h3><p>一个Native Crash log信息如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4a519cbcd0dd40f29ec6407104a04fbe~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p>堆栈信息中 pc 后面跟的内存地址，就是当前函数的栈地址，我们可以通过下面的命令行得出出错的代码行数</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">arm-linux-<span class="keyword">androideabi-addr2line </span>-e 内存地址</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面列出全部的信号量以及所代表的含义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SIGHUP 1  <span class="comment">// 终端连接结束时发出(不管正常或非正常)</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGINT 2  <span class="comment">// 程序终止(例如Ctrl-C)</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGQUIT 3 <span class="comment">// 程序退出(Ctrl-\)</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGILL 4 <span class="comment">// 执行了非法指令，或者试图执行数据段，堆栈溢出</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGTRAP 5 <span class="comment">// 断点时产生，由debugger使用</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGABRT 6 <span class="comment">// 调用abort函数生成的信号，表示程序异常</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGIOT 6 <span class="comment">// 同上，更全，IO异常也会发出</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGBUS 7 <span class="comment">// 非法地址，包括内存地址对齐出错，比如访问一个4字节的整数, 但其地址不是4的倍数</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGFPE 8 <span class="comment">// 计算错误，比如除0、溢出</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGKILL 9 <span class="comment">// 强制结束程序，具有最高优先级，本信号不能被阻塞、处理和忽略</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGUSR1 10 <span class="comment">// 未使用，保留</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGSEGV 11 <span class="comment">// 非法内存操作，与 SIGBUS不同，他是对合法地址的非法访问，    比如访问没有读权限的内存，向没有写权限的地址写数据</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGUSR2 12 <span class="comment">// 未使用，保留</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGPIPE 13 <span class="comment">// 管道破裂，通常在进程间通信产生</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGALRM 14 <span class="comment">// 定时信号,</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGTERM 15 <span class="comment">// 结束程序，类似温和的 SIGKILL，可被阻塞和处理。通常程序如    果终止不了，才会尝试SIGKILL</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGSTKFLT 16  <span class="comment">// 协处理器堆栈错误</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGCHLD 17 <span class="comment">// 子进程结束时, 父进程会收到这个信号。</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGCONT 18 <span class="comment">// 让一个停止的进程继续执行</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGSTOP 19 <span class="comment">// 停止进程,本信号不能被阻塞,处理或忽略</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGTSTP 20 <span class="comment">// 停止进程,但该信号可以被处理和忽略</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGTTIN 21 <span class="comment">// 当后台作业要从用户终端读数据时, 该作业中的所有进程会收到SIGTTIN信号</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGTTOU 22 <span class="comment">// 类似于SIGTTIN, 但在写终端时收到</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGURG 23 <span class="comment">// 有紧急数据或out-of-band数据到达socket时产生</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGXCPU 24 <span class="comment">// 超过CPU时间资源限制时发出</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGXFSZ 25 <span class="comment">// 当进程企图扩大文件以至于超过文件大小资源限制</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGVTALRM 26 <span class="comment">// 虚拟时钟信号. 类似于SIGALRM, 但是计算的是该进程占用的CPU时间.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGPROF 27 <span class="comment">// 类似于SIGALRM/SIGVTALRM, 但包括该进程用的CPU时间以及系统调用的时间</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGWINCH 28 <span class="comment">// 窗口大小改变时发出</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGIO 29 <span class="comment">// 文件描述符准备就绪, 可以开始进行输入/输出操作</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGPOLL SIGIO <span class="comment">// 同上，别称</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGPWR 30 <span class="comment">// 电源异常</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGSYS 31 <span class="comment">// 非法的系统调用</span></span></span><br></pre></td></tr></table></figure>

<p>一般关注SIGILL（执行了非法指令，或者试图执行数据段，堆栈溢出）, SIGABRT（调用abort函数生成的信号，表示程序异常）, SIGBUS（非法地址，包括内存地址对齐出错，比如访问一个4字节的整数, 但其地址不是4的倍数）, SIGFPE, SIGSEGV, SIGSTKFLT, SIGSYS即可。</p>
<p>要订阅异常发生的信号，最简单的做法就是直接用一个循环遍历所有要订阅的信号，对每个信号调用sigaction()。</p>
<p><strong>注意</strong></p>
<ul>
<li>JNI_OnLoad是最适合安装信号初始函数的地方。</li>
<li>建议在上报时调用Java层的方法统一上报。Native崩溃捕获注册。</li>
</ul>
<h3 id="6、崩溃分析流程"><a href="#6、崩溃分析流程" class="headerlink" title="6、崩溃分析流程"></a>6、崩溃分析流程</h3><h2 id="疑难Crash解决方案"><a href="#疑难Crash解决方案" class="headerlink" title="疑难Crash解决方案"></a>疑难Crash解决方案</h2><p>一些疑难Crash的解决方案。</p>
<h3 id="问题1：如何解决Android-7-0-Toast-BadTokenException？"><a href="#问题1：如何解决Android-7-0-Toast-BadTokenException？" class="headerlink" title="问题1：如何解决Android 7.0 Toast BadTokenException？"></a>问题1：如何解决Android 7.0 Toast BadTokenException？</h3><p>参考Android 8.0 try catch的做法，代理Toast里的mTN（handler）就可以实现捕获异常。</p>
<h3 id="问题2：如何解决-SharedPreference-apply-引起的-ANR-问题"><a href="#问题2：如何解决-SharedPreference-apply-引起的-ANR-问题" class="headerlink" title="问题2：如何解决 SharedPreference apply 引起的 ANR 问题"></a>问题2：如何解决 SharedPreference apply 引起的 ANR 问题</h3><h4 id="apply为什么会引起ANR？"><a href="#apply为什么会引起ANR？" class="headerlink" title="apply为什么会引起ANR？"></a>apply为什么会引起ANR？</h4><p>SP 调用 apply 方法，会创建一个等待锁放到 QueuedWork 中，并将真正的数据持久化封装成一个任务放到异步队列中执行，任务执行结束会释放锁。Activity onStop 以及 Service 处理 onStop，onStartCommand 时，执行 QueuedWork.waitToFinish() 等待所有的等待锁释放。</p>
<h4 id="如何解决？"><a href="#如何解决？" class="headerlink" title="如何解决？"></a>如何解决？</h4><p>所有此类 ANR 都是经由 QueuedWork.waitToFinish() 触发的，只要在调用此函数之前，将其中保存的队列手动清空即可。</p>
<p>具体是Hook ActivityThrad的Handler变量，拿到此变量后给其设置一个Callback，Handler 的 dispatchMessage 中会先处理 callback。最后在 Callback 中调用队列的清理工作，注意队列清理需要反射调用 QueuedWork。</p>
<h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><p>apply 机制本身的失败率就比较高（1.8%左右），清理等待锁队列对持久化造成的影响不大。</p>
<h3 id="问题3：如何解决TimeoutExceptin异常？"><a href="#问题3：如何解决TimeoutExceptin异常？" class="headerlink" title="问题3：如何解决TimeoutExceptin异常？"></a>问题3：如何解决TimeoutExceptin异常？</h3><p>它是由系统的FinalizerWatchdogDaemon抛出来的。</p>
<p>这里首先介绍下看门狗 WatchDog，它的作用是监控重要服务的运行状态，当重要服务停止时，发生 Timeout 异常崩溃，WatchDog 负责将应用重启。而当关闭 WatchDog（执行stop（）方法）后，当重要服务停止时，也不会发生 Timeout 异常，是一种通过非正常手段防止异常发生的方法。</p>
<h4 id="规避方案"><a href="#规避方案" class="headerlink" title="规避方案"></a>规避方案</h4><p>stop方法，在Android 6.0之前会有线程同步问题。 因为6.0之前调用threadToStop的interrupt方法是没有加锁的，所以可能会有线程同步的问题。</p>
<p>注意：Stop的时候有一定概率导致即使没有超时也会报timeoutexception。</p>
<h4 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h4><p>只是为了避免上报异常采取的一种hack方案，并没有真正解决引起finialize超时的问题。</p>
<h3 id="问题4：如何解决输入法的内存泄漏？"><a href="#问题4：如何解决输入法的内存泄漏？" class="headerlink" title="问题4：如何解决输入法的内存泄漏？"></a>问题4：如何解决输入法的内存泄漏？</h3><p>通过反射将输入法的两个View置空。</p>
<h2 id="进程保活"><a href="#进程保活" class="headerlink" title="进程保活"></a>进程保活</h2><p>我们可以<strong>利用SyncAdapter提高进程优先级</strong>，它是Android系统提供一个<strong>账号同步机制</strong>，它属于<strong>核心进程级别</strong>，而使用了SyncAdapter的进程优先级本身也会提高，使用方式请Google，关联SyncAdapter后，进程的<strong>优先级变为1</strong>，仅低于前台正在运行的进程，因此可以<strong>降低应用被系统杀掉的概率</strong>。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>对于App的Crash优化，总的来说，我们需要考虑以下四个要点：</p>
<ul>
<li>1、重在预防：重视应用的整个流程、包括开发人员的培训、编译检查、静态扫描、规范的测试、灰度、发布流程等</li>
<li>2、不应该随意使用try catch去隐藏问题：而应该从源头入手，了解崩溃的本质原因，保证后面的运行流程。</li>
<li>3、解决崩溃的过程应该由点到面，考虑一类崩溃怎么解决。</li>
<li>4、崩溃与内存、卡顿、I&#x2F;O内存紧密相关</li>
</ul>
<h1 id="ANR优化"><a href="#ANR优化" class="headerlink" title="ANR优化"></a>ANR优化</h1><h2 id="ANR监控实现方式"><a href="#ANR监控实现方式" class="headerlink" title="ANR监控实现方式"></a>ANR监控实现方式</h2><h3 id="1、使用FileObserver监听-x2F-data-x2F-anr-x2F-traces-txt-的变化"><a href="#1、使用FileObserver监听-x2F-data-x2F-anr-x2F-traces-txt-的变化" class="headerlink" title="1、使用FileObserver监听 &#x2F;data&#x2F;anr&#x2F;traces.txt 的变化"></a>1、使用FileObserver监听 &#x2F;data&#x2F;anr&#x2F;traces.txt 的变化</h3><p>缺点：高版本ROM需要root权限</p>
<p>解决方案：</p>
<p>海外Google Play服务，国内<a target="_blank" rel="noopener" href="https://github.com/Tencent/Hardcoder">Hardcoder</a></p>
<h3 id="2、监控消息队列的运行时间"><a href="#2、监控消息队列的运行时间" class="headerlink" title="2、监控消息队列的运行时间"></a>2、监控消息队列的运行时间</h3><p>卡顿监控原理：</p>
<p>利用主线程的消息队列处理机制，应用发生卡顿，一定是在dispatchMessage中执行了耗时操作。我们通过给主线程的Looper设置一个Printer，打点统计dispatchMessage方法执行的时间，如果超出阀值，表示发生卡顿，则dump出各种信息，提供开发者分析性能瓶颈。</p>
<p>为卡顿监控代码增加ANR的线程监控，在发送消息时，在ANR线程中保存一个状态，主线程消息执行完后再Reset标志位。如果在ANR线程中收到发送消息后，超过一定时间没有复位，就可以任务发生了ANR。</p>
<h4 id="缺点-2"><a href="#缺点-2" class="headerlink" title="缺点"></a>缺点</h4><ul>
<li>无法准确判断是否真正出现ANR，只能说明APP发生了UI阻塞，需要进行二次校验。校验的方式就是等待手机系统出现发生了Error的进程，并且Error类型是NOT_RESPONDING（值为2）。</li>
</ul>
<p>在每次出现ANR弹框前，Native层都会发出signal为SIGNAL_QUIT（值为3）的信号事件，也可以监听此信号。</p>
<ul>
<li>无法得到完整ANR日志</li>
<li>隶属于卡顿优化的方式</li>
</ul>
<h3 id="3、需要考虑应用退出场景"><a href="#3、需要考虑应用退出场景" class="headerlink" title="3、需要考虑应用退出场景"></a>3、需要考虑应用退出场景</h3><ul>
<li>主动自杀</li>
<li>Process.killProcess()、exit()等。</li>
<li>崩溃</li>
<li>系统重启</li>
<li>系统异常、断电、用户重启等：通过比较应用开机运行时间是否比之前记录的值更小。</li>
<li>被系统杀死</li>
<li>被LMK杀死、从系统的任务管理器中划掉等。</li>
</ul>
<h4 id="注意-1"><a href="#注意-1" class="headerlink" title="注意"></a>注意</h4><p>由于traces.txt上传比较耗时，所以一般线下采用，线上建议综合ProcessErrorStateInfo和出现ANR时的堆栈信息来实现ANR的实时上传。</p>
<h2 id="2、ANR优化"><a href="#2、ANR优化" class="headerlink" title="2、ANR优化"></a>2、ANR优化</h2><p>ANR发生原因：没有在规定的时间内完成要完成的事情。</p>
<h3 id="ANR分类"><a href="#ANR分类" class="headerlink" title="ANR分类"></a>ANR分类</h3><h4 id="发生场景"><a href="#发生场景" class="headerlink" title="发生场景"></a>发生场景</h4><ul>
<li>Activity onCreate方法或Input事件超过5s没有完成；</li>
<li>BroadcastReceiver前台10s，后台60s；</li>
<li>ContentProvider 在publish过超时10s；</li>
<li>Service前台20s，后台200s。</li>
</ul>
<h4 id="发生原因"><a href="#发生原因" class="headerlink" title="发生原因"></a>发生原因</h4><ul>
<li>主线程有耗时操作</li>
<li>复杂布局</li>
<li>IO操作</li>
<li>被子线程同步锁block</li>
<li>被Binder对端block</li>
<li>Binder被占满导致主线程无法和SystemServer通信</li>
<li>得不到系统资源（CPU&#x2F;RAM&#x2F;IO）</li>
</ul>
<p>从进程角度看发生原因有：</p>
<ul>
<li>当前进程：主线程本身耗时或者主线程的消息队列存在耗时操作、主线程被本进程的其它子线程所blocked</li>
<li>远端进程：binder call、socket通信</li>
</ul>
<p>Andorid系统监测ANR的核心原理是消息调度和超时处理。</p>
<h3 id="ANR排查流程"><a href="#ANR排查流程" class="headerlink" title="ANR排查流程"></a>ANR排查流程</h3><h4 id="1、Log获取"><a href="#1、Log获取" class="headerlink" title="1、Log获取"></a>1、Log获取</h4><p>1、抓取bugreport</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adb <span class="keyword">shell </span><span class="keyword">bugreport </span>&gt; <span class="keyword">bugreport.txt</span></span><br><span class="line"><span class="keyword"></span>复制代码</span><br></pre></td></tr></table></figure>

<p>2、直接导出&#x2F;data&#x2F;anr&#x2F;traces.txt文件</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adb pull <span class="regexp">/data/</span>anr/traces.txt trace.txt</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<h4 id="2、搜索“ANR-in”处log关键点解读"><a href="#2、搜索“ANR-in”处log关键点解读" class="headerlink" title="2、搜索“ANR in”处log关键点解读"></a>2、搜索“ANR in”处log关键点解读</h4><ul>
<li><p>发生时间（可能会延时10-20s）</p>
</li>
<li><p>pid：当pid&#x3D;0，说明在ANR之前，进程就被LMK杀死或出现了Crash，所以无法接受到系统的广播或者按键消息，因此会出现ANR</p>
</li>
<li><p>cpu负载Load: 7.58 &#x2F; 6.21 &#x2F; 4.83</p>
<p>代表此时一分钟有平均有7.58个进程在等待 1、5、15分钟内系统的平均负荷 当系统负荷持续大于1.0，必须将值降下来 当系统负荷达到5.0，表面系统有很严重的问题</p>
</li>
<li><p>cpu使用率</p>
<p>CPU usage from 18101ms to 0ms ago 28% 2085&#x2F;system_server: 18% user + 10% kernel &#x2F; faults: 8689 minor 24 major 11% 752&#x2F;android.<a href="https://link.juejin.cn/?target=mailto:hardware.sensors@1.0-service">hardware.sensors@1.0-service</a>: 4% user + 6.9% kernel &#x2F; faults: 2 minor 9.8% 780&#x2F;surfaceflinger: 6.2% user + 3.5% kernel &#x2F; faults: 143 minor 4 major</p>
</li>
</ul>
<p>上述表示Top进程的cpu占用情况。</p>
<h5 id="注意-2"><a href="#注意-2" class="headerlink" title="注意"></a>注意</h5><p>如果CPU使用量很少，说明主线程可能阻塞。</p>
<h4 id="3、在bugreport-txt中根据pid和发生时间搜索到阻塞的log处"><a href="#3、在bugreport-txt中根据pid和发生时间搜索到阻塞的log处" class="headerlink" title="3、在bugreport.txt中根据pid和发生时间搜索到阻塞的log处"></a>3、在bugreport.txt中根据pid和发生时间搜索到阻塞的log处</h4><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">-----</span> <span class="comment">pid 10494 at 2019</span><span class="literal">-</span><span class="comment">11</span><span class="literal">-</span><span class="comment">18 15:28:29</span> <span class="literal">-----</span></span><br><span class="line"><span class="comment">复制代码</span></span><br></pre></td></tr></table></figure>

<h4 id="4、往下翻找到“main”线程则可看到对应的阻塞log"><a href="#4、往下翻找到“main”线程则可看到对应的阻塞log" class="headerlink" title="4、往下翻找到“main”线程则可看到对应的阻塞log"></a>4、往下翻找到“main”线程则可看到对应的阻塞log</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;main&quot;</span> <span class="attribute">prio</span>=5 <span class="attribute">tid</span>=1 Sleeping</span><br><span class="line">| <span class="attribute">group</span>=<span class="string">&quot;main&quot;</span> <span class="attribute">sCount</span>=1 <span class="attribute">dsCount</span>=0 <span class="attribute">flags</span>=1 <span class="attribute">obj</span>=0x746bf7f0 <span class="attribute">self</span>=0xe7c8f000</span><br><span class="line">| <span class="attribute">sysTid</span>=10494 <span class="attribute">nice</span>=-4 <span class="attribute">cgrp</span>=default <span class="attribute">sched</span>=0/0 <span class="attribute">handle</span>=0xeb6784a4</span><br><span class="line">| <span class="attribute">state</span>=S schedstat=( 5119636327 325064933 4204 ) <span class="attribute">utm</span>=460 <span class="attribute">stm</span>=51 <span class="attribute">core</span>=4 <span class="attribute">HZ</span>=100</span><br><span class="line">| <span class="attribute">stack</span>=0xff575000-0xff577000 <span class="attribute">stackSize</span>=8MB</span><br><span class="line">| held mutexes=</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>上述关键字段的含义如下所示：</p>
<ul>
<li>tid：线程号</li>
<li>sysTid：主进程线程号和进程号相同</li>
<li>Waiting&#x2F;Sleeping：各种线程状态</li>
<li>nice：nice值越小，则优先级越高，-17~16</li>
<li>schedstat：Running、Runable时间(ns)与Switch次数</li>
<li>utm：该线程在用户态的执行时间(jiffies)</li>
<li>stm：该线程在内核态的执行时间(jiffies)</li>
<li>sCount：该线程被挂起的次数</li>
<li>dsCount：该线程被调试器挂起的次数</li>
<li>self：线程本身的地址</li>
</ul>
<h4 id="补充加油站：各种线程状态"><a href="#补充加油站：各种线程状态" class="headerlink" title="补充加油站：各种线程状态"></a>补充加油站：各种线程状态</h4><p>需要注意的是，这里的各种线程状态指的是Native层的线程状态，关于Java线程状态与Native线程状态的对应关系如下所示：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">enum ThreadState &#123;</span><br><span class="line">  <span class="regexp">//</span>                                   Thread.State   JDWP state</span><br><span class="line">  kTerminated = <span class="number">66</span>,                 <span class="regexp">//</span> TERMINATED     TS_ZOMBIE    Thread.run has returned, but Thread* still around</span><br><span class="line">  kRunnable,                        <span class="regexp">//</span> RUNNABLE       TS_RUNNING   runnable</span><br><span class="line">  kTimedWaiting,                    <span class="regexp">//</span> TIMED_WAITING  TS_WAIT      <span class="keyword">in</span> Object.wait() with a timeout</span><br><span class="line">  kSleeping,                        <span class="regexp">//</span> TIMED_WAITING  TS_SLEEPING  <span class="keyword">in</span> Thread.sleep()</span><br><span class="line">  kBlocked,                         <span class="regexp">//</span> BLOCKED        TS_MONITOR   blocked on a monitor</span><br><span class="line">  kWaiting,                         <span class="regexp">//</span> WAITING        TS_WAIT      <span class="keyword">in</span> Object.wait()</span><br><span class="line">  kWaitingForLockInflation,         <span class="regexp">//</span> WAITING        TS_WAIT      blocked inflating a thin-lock</span><br><span class="line">  kWaitingForTaskProcessor,         <span class="regexp">//</span> WAITING        TS_WAIT      blocked waiting <span class="keyword">for</span> taskProcessor</span><br><span class="line">  kWaitingForGcToComplete,          <span class="regexp">//</span> WAITING        TS_WAIT      blocked waiting <span class="keyword">for</span> GC</span><br><span class="line">  kWaitingForCheckPointsToRun,      <span class="regexp">//</span> WAITING        TS_WAIT      GC waiting <span class="keyword">for</span> checkpoints to run</span><br><span class="line">  kWaitingPerformingGc,             <span class="regexp">//</span> WAITING        TS_WAIT      performing GC</span><br><span class="line">  kWaitingForDebuggerSend,          <span class="regexp">//</span> WAITING        TS_WAIT      blocked waiting <span class="keyword">for</span> events to be sent</span><br><span class="line">  kWaitingForDebuggerToAttach,      <span class="regexp">//</span> WAITING        TS_WAIT      blocked waiting <span class="keyword">for</span> debugger to attach</span><br><span class="line">  kWaitingInMainDebuggerLoop,       <span class="regexp">//</span> WAITING        TS_WAIT      blocking<span class="regexp">/reading/</span>processing debugger events</span><br><span class="line">  kWaitingForDebuggerSuspension,    <span class="regexp">//</span> WAITING        TS_WAIT      waiting <span class="keyword">for</span> debugger suspend all</span><br><span class="line">  kWaitingForJniOnLoad,             <span class="regexp">//</span> WAITING        TS_WAIT      waiting <span class="keyword">for</span> execution of dlopen and JNI on load code</span><br><span class="line">  kWaitingForSignalCatcherOutput,   <span class="regexp">//</span> WAITING        TS_WAIT      waiting <span class="keyword">for</span> signal catcher IO to complete</span><br><span class="line">  kWaitingInMainSignalCatcherLoop,  <span class="regexp">//</span> WAITING        TS_WAIT      blocking<span class="regexp">/reading/</span>processing signals</span><br><span class="line">  kWaitingForDeoptimization,        <span class="regexp">//</span> WAITING        TS_WAIT      waiting <span class="keyword">for</span> deoptimization suspend all</span><br><span class="line">  kWaitingForMethodTracingStart,    <span class="regexp">//</span> WAITING        TS_WAIT      waiting <span class="keyword">for</span> method tracing to start</span><br><span class="line">  kWaitingForVisitObjects,          <span class="regexp">//</span> WAITING        TS_WAIT      waiting <span class="keyword">for</span> visiting objects</span><br><span class="line">  kWaitingForGetObjectsAllocated,   <span class="regexp">//</span> WAITING        TS_WAIT      waiting <span class="keyword">for</span> getting the number of allocated objects</span><br><span class="line">  kWaitingWeakGcRootRead,           <span class="regexp">//</span> WAITING        TS_WAIT      waiting on the GC to read a weak root</span><br><span class="line">  kWaitingForGcThreadFlip,          <span class="regexp">//</span> WAITING        TS_WAIT      waiting on the GC thread flip (CC collector) to finish</span><br><span class="line">  kStarting,                        <span class="regexp">//</span> NEW            TS_WAIT      native thread started, not yet ready to run managed code</span><br><span class="line">  kNative,                          <span class="regexp">//</span> RUNNABLE       TS_RUNNING   running <span class="keyword">in</span> a JNI native method</span><br><span class="line">  kSuspended,                       <span class="regexp">//</span> RUNNABLE       TS_RUNNING   suspended by GC or debugger</span><br><span class="line">&#125;;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<h4 id="其它分析方法：Java线程调用分析方法"><a href="#其它分析方法：Java线程调用分析方法" class="headerlink" title="其它分析方法：Java线程调用分析方法"></a>其它分析方法：Java线程调用分析方法</h4><ul>
<li>先使用jps命令列出当前系统中运行的所有Java虚拟机进程，拿到应用进程的pid。</li>
<li>然后再使用jstack命令查看该进程中所有线程的状态以及调用关系，以及一些简单的分析结果。</li>
</ul>
<h2 id="3、关于ANR的一些常见问题"><a href="#3、关于ANR的一些常见问题" class="headerlink" title="3、关于ANR的一些常见问题"></a>3、关于ANR的一些常见问题</h2><h3 id="1、sp调用apply导致anr问题？"><a href="#1、sp调用apply导致anr问题？" class="headerlink" title="1、sp调用apply导致anr问题？"></a>1、sp调用apply导致anr问题？</h3><p>虽然apply并不会阻塞主线程，但是会将等待时间转嫁到主线程。</p>
<h3 id="2、检测运行期间是否发生过异常退出？"><a href="#2、检测运行期间是否发生过异常退出？" class="headerlink" title="2、检测运行期间是否发生过异常退出？"></a>2、检测运行期间是否发生过异常退出？</h3><p>在应用启动时设定一个标志，在主动自杀或崩溃后更新标志 ，下次启动时检测此标志即可判断。</p>
<h2 id="4、理解ANR的触发流程"><a href="#4、理解ANR的触发流程" class="headerlink" title="4、理解ANR的触发流程"></a>4、理解ANR的触发流程</h2><p>broadcast跟service超时机制大抵相同，但有一个非常隐蔽的技能点，那就是通过静态注册的广播超时会受SharedPreferences(简称SP)的影响。</p>
<p>当SP有未同步到磁盘的工作，则需等待其完成，才告知系统已完成该广播。并且只有XML静态注册的广播超时检测过程会考虑是否有SP尚未完成，动态广播并不受其影响。</p>
<ul>
<li>对于Service, Broadcast, Input发生ANR之后,最终都会调用AMS.appNotResponding。</li>
<li>对于provider,在其进程启动时publish过程可能会出现ANR, 则会直接杀进程以及清理相应信息,而不会弹出ANR的对话框。</li>
</ul>
<h3 id="1、AMS-appNotResponding流程"><a href="#1、AMS-appNotResponding流程" class="headerlink" title="1、AMS.appNotResponding流程"></a>1、AMS.appNotResponding流程</h3><ul>
<li>输出ANR Reason信息到EventLog. 也就是说ANR触发的时间点最接近的就是EventLog中输出的am_anr信息。</li>
<li>收集并输出重要进程列表中的各个线程的traces信息，该方法较耗时。</li>
<li>输出当前各个进程的CPU使用情况以及CPU负载情况。</li>
<li>将traces文件和 CPU使用情况信息保存到dropbox，即data&#x2F;system&#x2F;dropbox目录（ANR信息最为重要的信息）。</li>
<li>根据进程类型,来决定直接后台杀掉,还是弹框告知用户。</li>
</ul>
<h3 id="2、AMS-dumpStackTraces流程"><a href="#2、AMS-dumpStackTraces流程" class="headerlink" title="2、AMS.dumpStackTraces流程"></a>2、AMS.dumpStackTraces流程</h3><h4 id="1、收集firstPids进程的stacks："><a href="#1、收集firstPids进程的stacks：" class="headerlink" title="1、收集firstPids进程的stacks："></a>1、收集firstPids进程的stacks：</h4><ul>
<li>第一个是发生ANR进程；</li>
<li>第二个是system_server；</li>
<li>其余的是mLruProcesses中所有的persistent进程。</li>
</ul>
<h4 id="2、收集Native进程的stacks。-dumpNativeBacktraceToFile"><a href="#2、收集Native进程的stacks。-dumpNativeBacktraceToFile" class="headerlink" title="2、收集Native进程的stacks。(dumpNativeBacktraceToFile)"></a>2、收集Native进程的stacks。(dumpNativeBacktraceToFile)</h4><ul>
<li>依次是mediaserver,sdcard,surfaceflinger进程。</li>
</ul>
<h4 id="3、收集lastPids进程的stacks："><a href="#3、收集lastPids进程的stacks：" class="headerlink" title="3、收集lastPids进程的stacks："></a>3、收集lastPids进程的stacks：</h4><ul>
<li>依次输出CPU使用率top 5的进程；</li>
</ul>
<h5 id="注意-3"><a href="#注意-3" class="headerlink" title="注意"></a>注意</h5><p>上述导出每个进程trace时，进程之间会休眠200ms。</p>
<h1 id="移动端业务高可用方案建设"><a href="#移动端业务高可用方案建设" class="headerlink" title="移动端业务高可用方案建设"></a>移动端业务高可用方案建设</h1><h2 id="1、业务高可用重要性"><a href="#1、业务高可用重要性" class="headerlink" title="1、业务高可用重要性"></a>1、业务高可用重要性</h2><p>关于业务高可用重要性有如下五点：</p>
<ul>
<li>高可用</li>
<li>性能</li>
<li>业务</li>
<li>侧重于用户功能完整可用</li>
<li>真实影响收入</li>
</ul>
<h2 id="2、业务高可用方案建设"><a href="#2、业务高可用方案建设" class="headerlink" title="2、业务高可用方案建设"></a>2、业务高可用方案建设</h2><p>业务高可用方案建设需要注意的点比较繁杂，但是总体可以归结为如下几点：</p>
<ul>
<li>数据采集</li>
<li>梳理项目主流程、核心路径、关键节点</li>
<li>Aop自动采集、统一上报</li>
<li>报警策略：阈值报警、趋势报警、特定指标报警、直接上报（或底阈值）</li>
<li>异常监控</li>
<li>单点追查：需要针对性分析的特定问题，全量日志回捞，专项分析</li>
<li>兜底策略</li>
<li>配置中心、功能开关</li>
<li>跳转分发中心（组件化路由）</li>
</ul>
<h2 id="3、移动端容灾方案"><a href="#3、移动端容灾方案" class="headerlink" title="3、移动端容灾方案"></a>3、移动端容灾方案</h2><h3 id="灾包括："><a href="#灾包括：" class="headerlink" title="灾包括："></a>灾包括：</h3><ul>
<li>性能异常</li>
<li>业务异常</li>
</ul>
<h3 id="传统流程："><a href="#传统流程：" class="headerlink" title="传统流程："></a>传统流程：</h3><p>用户反馈、重新打包、渠道更新、不可接受。</p>
<h3 id="容灾方案建设"><a href="#容灾方案建设" class="headerlink" title="容灾方案建设"></a>容灾方案建设</h3><p>关于容灾方案的建设主要可以细分为以下七点，下面，我们分别来了解下。</p>
<h4 id="1、功能开关"><a href="#1、功能开关" class="headerlink" title="1、功能开关"></a>1、功能开关</h4><p>配置中心，服务端下发配置控制</p>
<h5 id="针对场景"><a href="#针对场景" class="headerlink" title="针对场景"></a>针对场景</h5><ul>
<li>功能新增</li>
<li>代码改动</li>
</ul>
<h4 id="2、统跳中心"><a href="#2、统跳中心" class="headerlink" title="2、统跳中心"></a>2、统跳中心</h4><ul>
<li>界面切换通过路由，路由决定是否重定向</li>
<li>Native Bug不能热修复则跳转到临时H5页面</li>
</ul>
<h4 id="3、动态化修复"><a href="#3、动态化修复" class="headerlink" title="3、动态化修复"></a>3、动态化修复</h4><p>热修复能力，可监控、灰度、回滚、清除。</p>
<h4 id="4、推拉结合、多场景调用保证到达率"><a href="#4、推拉结合、多场景调用保证到达率" class="headerlink" title="4、推拉结合、多场景调用保证到达率"></a>4、推拉结合、多场景调用保证到达率</h4><h4 id="5、Weex、RN增量更新"><a href="#5、Weex、RN增量更新" class="headerlink" title="5、Weex、RN增量更新"></a>5、Weex、RN增量更新</h4><h4 id="6、安全模式"><a href="#6、安全模式" class="headerlink" title="6、安全模式"></a>6、安全模式</h4><p>微信读书、蘑菇街、淘宝、天猫等“重运营”的APP都使用了安全模式保障客户端启动流程，启动失败后给用户自救机会。先介绍一下它的核心特点：</p>
<ul>
<li>根据Crash信息自动恢复，多次启动失败重置应用为安装初始状态</li>
<li>严重Bug可阻塞性热修复</li>
</ul>
<h5 id="安全模式设计"><a href="#安全模式设计" class="headerlink" title="安全模式设计"></a>安全模式设计</h5><p>配置后台：统一的配置后台，具备灰度发布机制</p>
<p>1、客户端能力：</p>
<ul>
<li>在APP连续Crash的情况下具备分级、无感自修复能力</li>
<li>具备同步热修复能力</li>
<li>具备指定触发某项特定功能的能力</li>
<li>具体功能注册能力，方便后期扩展安全模式</li>
</ul>
<p>2、数据统计及告警</p>
<ul>
<li>统一的数据平台</li>
<li>监控告警功能，及时发现问题</li>
<li>查看热修复成功率等数据</li>
</ul>
<p>3、快速测试</p>
<ul>
<li>优化预发布环境下测试</li>
<li>优化回归验证安全模式难点等</li>
</ul>
<h5 id="天猫安全模式原理"><a href="#天猫安全模式原理" class="headerlink" title="天猫安全模式原理"></a>天猫安全模式原理</h5><p>1、如何判断异常退出？</p>
<p>APP启动时记录一个flag值，满足以下条件时，将flag值清空</p>
<ul>
<li>APP正常启动10秒</li>
<li>用户正常退出应用</li>
<li>用户主动从前台切换到后台</li>
</ul>
<p>如果在启动阶段发生异常，则flag值不会清空，通过flag值就可以判断客户端是否异常退出，每次异常退出，flag值都+1。</p>
<p>2、安全模式的分级执行策略</p>
<p>分为两级安全模式，连续Crash 2次为一级安全模式，连续Crash 2次及以上为二级安全模式。</p>
<p>业务线可以在一级安全模式中注册行为，比如清空缓存数据，再进入该模式时，会使用注册行为尝试修复客户端 如果一级安全模式无法修复APP，则进入二级安全模式将APP恢复到初次安装状态，并将Document、Library、Cache三个根目录清空。</p>
<p>3、热修复执行策略</p>
<p>只要发现配置中需要热修复，APP就会同步阻塞进行热修复,保证修复的及时性</p>
<p>4、灰度方案</p>
<p>灰度时，配置中会包含灰度、正式两份配置及其灰度概率 APP根据特定算法算出自己是否满足灰度条件，则使用灰度配置</p>
<h5 id="易用性考量"><a href="#易用性考量" class="headerlink" title="易用性考量"></a>易用性考量</h5><p>1、接入成本</p>
<p>完善文档、接口简洁</p>
<p>2、统一配置后台</p>
<p>可按照APP、版本配置</p>
<p>3、定制性</p>
<p>支持定制功能，让接入方来决定具体行为</p>
<p>4、灰度机制</p>
<p>5、数据分析</p>
<p>采用统一数据平台，为安全模式改进提供依据</p>
<p>6、快速测试</p>
<p>创建更多的针对性测试案例，如模拟连续Crash</p>
<h4 id="7、异常熔断"><a href="#7、异常熔断" class="headerlink" title="7、异常熔断"></a>7、异常熔断</h4><p>当多次请求失败则可让网络库主动拒绝请求。</p>
<h3 id="容灾方案集合路径"><a href="#容灾方案集合路径" class="headerlink" title="容灾方案集合路径"></a>容灾方案集合路径</h3><p>功能开关 -&gt; 统跳中心 -&gt; 动态修复 -&gt; 安全模式</p>
<h1 id="稳定性长效治理"><a href="#稳定性长效治理" class="headerlink" title="稳定性长效治理"></a>稳定性长效治理</h1><p>要实现App稳定性的长效治理，我们需要从 <strong>开发阶段 &#x3D;&gt; 测试阶段 &#x3D;&gt; 合码阶段 &#x3D;&gt; 发布阶段 &#x3D;&gt; 运维阶段</strong> 这五个阶段来做针对性地处理。</p>
<h2 id="1、开发阶段"><a href="#1、开发阶段" class="headerlink" title="1、开发阶段"></a>1、开发阶段</h2><ul>
<li>统一编码规范、增强编码功底、技术评审、CodeReview机制</li>
<li>架构优化</li>
<li>能力收敛</li>
<li>统一容错：如在网络库utils中统一对返回信息进行预校验，如不合法就直接不走接下来的流程。</li>
</ul>
<h2 id="2、测试阶段"><a href="#2、测试阶段" class="headerlink" title="2、测试阶段"></a>2、测试阶段</h2><ul>
<li>功能测试、自动化测试、回归测试、覆盖安装</li>
<li>特殊场景、机型等边界测试：如服务端返回异常数据、服务端宕机</li>
<li>云测平台：提供更全面的机型进行测试</li>
</ul>
<h2 id="3、合码阶段"><a href="#3、合码阶段" class="headerlink" title="3、合码阶段"></a>3、合码阶段</h2><ul>
<li>编译检测、静态扫描</li>
<li>预编译流程、主流程自动回归</li>
</ul>
<h2 id="4、发布阶段"><a href="#4、发布阶段" class="headerlink" title="4、发布阶段"></a>4、发布阶段</h2><ul>
<li>多轮灰度</li>
<li>分场景、纬度全面覆盖</li>
</ul>
<h2 id="5、运维阶段"><a href="#5、运维阶段" class="headerlink" title="5、运维阶段"></a>5、运维阶段</h2><ul>
<li>灵敏监控</li>
<li>回滚、降级策略</li>
<li>热修复、本地容灾方案</li>
</ul>
<h1 id="稳定性优化问题"><a href="#稳定性优化问题" class="headerlink" title="稳定性优化问题"></a>稳定性优化问题</h1><h2 id="1、你们做了哪些稳定性方面的优化？"><a href="#1、你们做了哪些稳定性方面的优化？" class="headerlink" title="1、你们做了哪些稳定性方面的优化？"></a>1、你们做了哪些稳定性方面的优化？</h2><p>随着项目的逐渐成熟，用户基数逐渐增多，DAU持续升高，我们遇到了很多稳定性方面的问题，对于我们技术同学遇到了很多的挑战，用户经常使用我们的App卡顿或者是功能不可用，因此我们就针对稳定性开启了专项的优化，我们主要优化了三项：</p>
<ul>
<li><strong>Crash专项优化</strong></li>
<li><strong>性能稳定性优化</strong></li>
<li><strong>业务稳定性优化</strong></li>
</ul>
<p>通过这三方面的优化我们搭建了移动端的高可用平台。同时，也做了很多的措施来让App真正地实现了高可用。</p>
<h2 id="2、性能稳定性是怎么做的？"><a href="#2、性能稳定性是怎么做的？" class="headerlink" title="2、性能稳定性是怎么做的？"></a>2、性能稳定性是怎么做的？</h2><ul>
<li><strong>全面的性能优化</strong>：启动速度、内存优化、绘制优化</li>
<li><strong>线下发现问题、优化为主</strong></li>
<li><strong>线上监控为主</strong></li>
<li><strong>Crash专项优化</strong></li>
</ul>
<p>我们针对启动速度，内存、布局加载、卡顿、瘦身、流量、电量等多个方面做了多维的优化。</p>
<p>我们的优化主要分为了两个层次，即线上和线下，针对于线下呢，我们侧重于发现问题，直接解决，将问题尽可能在上线之前解决为目的。而真正到了线上呢，我们最主要的目的就是为了监控，对于各个性能纬度的监控呢，可以让我们尽可能早地获取到异常情况的报警。</p>
<p>同时呢，对于线上最严重的性能问题性问题：Crash，我们做了专项的优化，不仅优化了Crash的具体指标，而且也尽可能地获取了Crash发生时的详细信息，结合后端的聚合、报警等功能，便于我们快速地定位问题。</p>
<h2 id="3、业务稳定性如何保障？"><a href="#3、业务稳定性如何保障？" class="headerlink" title="3、业务稳定性如何保障？"></a>3、业务稳定性如何保障？</h2><ul>
<li><strong>数据采集 + 报警</strong></li>
<li>需要对项目的<strong>主流程与核心路径进行埋点监控</strong>，</li>
<li>同时还<strong>需知道每一步发生了多少异常</strong>，这样，我们就知道了<strong>所有业务流程的转换率以及相应界面的转换率</strong></li>
<li><strong>结合大盘，如果转换率低于某个值，进行报警</strong></li>
<li><strong>异常监控 + 单点追查</strong></li>
<li><strong>兜底策略，如天猫安全模式</strong></li>
</ul>
<p>移动端业务高可用它侧重于用户功能完整可用，主要是为了解决一些线上一些异常情况导致用户他虽然没有崩溃，也没有性能问题，但是呢，只是单纯的功能不可用的情况，我们需要对项目的主流程、核心路径进行埋点监控，来计算每一步它真实的转换率是多少，同时呢，还需要知道在每一步到底发生了多少异常。这样我们就知道了所有业务流程的转换率以及相应界面的转换率，有了大盘的数据呢，我们就知道了，如果转换率或者是某些监控的成功率低于某个值，那很有可能就是出现了线上异常，结合了相应的报警功能，我们就不需要等用户来反馈了，这个就是业务稳定性保障的基础。</p>
<p>同时呢，对于一些特殊情况，比如说，开发过程当中或代码中出现了一些catch代码块，捕获住了异常，让程序不崩溃，这其实是不合理的，程序虽然没有崩溃，当时程序的功能已经变得不可用，所以呢，这些被catch的异常我们也需要上报上来，这样我们才能知道用户到底出现了什么问题而导致的异常。此外，线上还有一些单点问题，比如说用户点击登录一直进不去，这种就属于单点问题，其实我们是无法找出其和其它问题的共性之处的，所以呢，我们就必须要找到它对应的详细信息。</p>
<p>最后，如果发生了异常情况，我们还采取了一系列措施进行快速止损。（&#x3D;&gt;4）</p>
<h2 id="4、如果发生了异常情况，怎么快速止损？"><a href="#4、如果发生了异常情况，怎么快速止损？" class="headerlink" title="4、如果发生了异常情况，怎么快速止损？"></a>4、如果发生了异常情况，怎么快速止损？</h2><ul>
<li><strong>功能开关</strong></li>
<li><strong>统跳中心</strong></li>
<li><strong>动态修复：热修复、资源包更新</strong></li>
<li><strong>自主修复：安全模式</strong></li>
</ul>
<p>首先，需要让App具备一些高级的能力，我们对于任何要上线的新功能，要加上一个功能的开关，通过配置中心下发的开关呢，来决定是否要显示新功能的入口。如果有异常情况，可以紧急关闭新功能的入口，那就可以让这个App处于可控的状态了。</p>
<p>然后，我们需要给App设立路由跳转，所有的界面跳转都需要通过路由来分发，如果我们匹配到需要跳转到有bug的这样一个新功能时，那我们就不跳转了，或者是跳转到统一的异常正处理中的界面。如果这两种方式都不可以，那就可以考虑通过热修复的方式来动态修复，目前热修复的方案其实已经比较成熟了，我们完全可以低成本地在我们的项目中添加热修复的能力，当然，如果有些功能是由RN或WeeX来实现就更好了，那就可以通过更新资源包的方式来实现动态更新。而这些如果都不可以的话呢，那就可以考虑自己去给应用加上一个自主修复的能力，如果App启动多次的话，那就可以考虑清空所有的缓存数据，将App重置到安装的状态，到了最严重的等级呢，可以阻塞主线程，此时一定要等App热修复成功之后才允许用户进入。</p>
<h1 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h1><p>Android稳定性优化是一个需要 <strong>长期投入，持续运营和维护</strong> 的一个过程，上文中我们不仅深入探讨了Java Crash、Native Crash和ANR的解决流程及方案，还分析了其内部实现原理和监控流程。到这里，可以看到，要想做好稳定性优化，我们 <strong>必须对虚拟机运行、Linux信号处理和内存分配</strong> 有一定程度的了解，<strong>只有深入了解这些底层知识，我们才能比别人设计出更好的稳定性优化方案</strong>。</p>
<!-- flag of hidden posts -->
      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>请我喝杯奶茶吧~</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt=" WeChat Pay"/>
        <p>WeChat Pay</p>
      </div>
    

    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/private/" rel="tag"># private</a>
          
            <a href="/tags/%E5%AE%89%E5%8D%93%E4%BC%98%E5%8C%96/" rel="tag"># 安卓优化</a>
          
        </div>
      

      
      
      

      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7Carchive">
              
                  <span class="site-state-item-count">248</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">49</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="mailto:shenbh@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://juejin.im/user/57ea31a1a22b9d0061656f52" target="_blank" title="掘金">
                      
                        <i class="fa fa-fw fa-fa fa-fw fa-book"></i>掘金</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/shenbh" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.wanandroid.com/" title="玩Android" target="_blank">玩Android</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://wuxiaolong.me/" title="吴小龙同学" target="_blank">吴小龙同学</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://hexo.yuanjh.cn/" title="江州司马" target="_blank">江州司马</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.yanghujun.com/" title="八归少年" target="_blank">八归少年</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://zhpanvip.gitee.io/" title="马可没有菠萝" target="_blank">马可没有菠萝</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://omooo.top/" title="Omooo" target="_blank">Omooo</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://gityuan.com/" title="Gityuan" target="_blank">Gityuan</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Android%E7%A8%B3%E5%AE%9A%E6%80%A7%E4%BC%98%E5%8C%96"><span class="nav-text">Android稳定性优化</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%AD%A3%E7%A1%AE%E8%AE%A4%E8%AF%86"><span class="nav-text">正确认识</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A8%B3%E5%AE%9A%E6%80%A7%E7%BA%AC%E5%BA%A6"><span class="nav-text">稳定性纬度</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A8%B3%E5%AE%9A%E6%80%A7%E4%BC%98%E5%8C%96%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-text">稳定性优化注意事项</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81%E9%87%8D%E5%9C%A8%E9%A2%84%E9%98%B2%E3%80%81%E7%9B%91%E6%8E%A7%E5%BF%85%E4%B8%8D%E5%8F%AF%E5%B0%91"><span class="nav-text">1、重在预防、监控必不可少</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E6%80%9D%E8%80%83%E6%9B%B4%E6%B7%B1%E4%B8%80%E5%B1%82%E3%80%81%E9%87%8D%E8%A7%86%E9%9A%90%E5%90%AB%E4%BF%A1%E6%81%AF%EF%BC%9A%E5%A6%82%E8%A7%A3%E5%86%B3Crash%E9%97%AE%E9%A2%98%E6%97%B6%E6%80%9D%E8%80%83%E6%98%AF%E5%90%A6%E4%BC%9A%E5%BC%95%E5%8F%91%E5%90%8C%E4%B8%80%E7%B1%BB%E9%97%AE%E9%A2%98"><span class="nav-text">2、思考更深一层、重视隐含信息：如解决Crash问题时思考是否会引发同一类问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81%E9%95%BF%E6%95%88%E4%BF%9D%E6%8C%81%E9%9C%80%E8%A6%81%E7%A7%91%E5%AD%A6%E6%B5%81%E7%A8%8B"><span class="nav-text">3、长效保持需要科学流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Crash%E7%9B%B8%E5%85%B3%E6%8C%87%E6%A0%87"><span class="nav-text">Crash相关指标</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81UV%E3%80%81PV"><span class="nav-text">1、UV、PV</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81UV%E3%80%81PV%E3%80%81%E5%90%AF%E5%8A%A8%E3%80%81%E5%A2%9E%E9%87%8F%E3%80%81%E5%AD%98%E9%87%8F-Crash%E7%8E%87"><span class="nav-text">2、UV、PV、启动、增量、存量 Crash率</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Crash%E7%8E%87%E8%AF%84%E4%BB%B7"><span class="nav-text">Crash率评价</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Crash%E5%85%B3%E9%94%AE%E9%97%AE%E9%A2%98"><span class="nav-text">Crash关键问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#APM-Crash%E9%83%A8%E5%88%86%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="nav-text">APM Crash部分整体架构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89%E3%80%81%E9%87%87%E9%9B%86%E5%B1%82"><span class="nav-text">1）、采集层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89%E3%80%81%E5%A4%84%E7%90%86%E5%B1%82"><span class="nav-text">2）、处理层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%EF%BC%89%E3%80%81%E5%B1%95%E7%A4%BA%E5%B1%82"><span class="nav-text">3）、展示层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%EF%BC%89%E3%80%81%E6%8A%A5%E8%AD%A6%E5%B1%82"><span class="nav-text">4）、报警层</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B4%A3%E4%BB%BB%E5%BD%92%E5%B1%9E"><span class="nav-text">责任归属</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Crash%E4%BC%98%E5%8C%96"><span class="nav-text">Crash优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%95%E4%B8%AACrash%E5%A4%84%E7%90%86%E6%96%B9%E6%A1%88"><span class="nav-text">单个Crash处理方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89%E3%80%81%E6%A0%B9%E6%8D%AE%E5%A0%86%E6%A0%88%E5%8F%8A%E7%8E%B0%E5%9C%BA%E4%BF%A1%E6%81%AF%E6%89%BE%E7%AD%94%E6%A1%88"><span class="nav-text">1）、根据堆栈及现场信息找答案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89%E3%80%81%E6%89%BE%E5%85%B1%E6%80%A7%EF%BC%9A%E6%9C%BA%E5%9E%8B%E3%80%81OS%E3%80%81%E5%AE%9E%E9%AA%8C%E5%BC%80%E5%85%B3%E3%80%81%E8%B5%84%E6%BA%90%E5%8C%85%EF%BC%8C%E8%80%83%E8%99%91%E5%BD%B1%E5%93%8D%E8%8C%83%E5%9B%B4"><span class="nav-text">2）、找共性：机型、OS、实验开关、资源包，考虑影响范围</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%EF%BC%89%E3%80%81%E7%BA%BF%E4%B8%8B%E5%A4%8D%E7%8E%B0%E3%80%81%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95"><span class="nav-text">3）、线下复现、远程调试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Crash%E7%8E%87%E6%B2%BB%E7%90%86%E6%96%B9%E6%A1%88"><span class="nav-text">Crash率治理方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89%E3%80%81%E8%A7%A3%E5%86%B3%E7%BA%BF%E4%B8%8A%E5%B8%B8%E8%A7%84Crash"><span class="nav-text">1）、解决线上常规Crash</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89%E3%80%81%E7%B3%BB%E7%BB%9F%E7%BA%A7Crash%E5%B0%9D%E8%AF%95Hook%E7%BB%95%E8%BF%87"><span class="nav-text">2）、系统级Crash尝试Hook绕过</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%EF%BC%89%E3%80%81%E7%96%91%E9%9A%BECrash%E9%87%8D%E7%82%B9%E7%AA%81%E7%A0%B4%E6%88%96%E6%9B%B4%E6%8D%A2%E6%96%B9%E6%A1%88"><span class="nav-text">3）、疑难Crash重点突破或更换方案</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Java-Crash"><span class="nav-text">Java Crash</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%88%91%E4%BB%AC%E5%A6%82%E4%BD%95%E5%8F%8D%E6%B7%B7%E6%B7%86%E4%B8%8A%E4%BC%A0%E7%9A%84%E5%A0%86%E6%A0%88%E4%BF%A1%E6%81%AF%EF%BC%9F"><span class="nav-text">我们如何反混淆上传的堆栈信息？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96logcat%E6%96%B9%E6%B3%95%EF%BC%9F"><span class="nav-text">如何获取logcat方法？</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E9%80%9A%E8%BF%87logcat%E5%91%BD%E4%BB%A4%E8%8E%B7%E5%8F%96%E3%80%82"><span class="nav-text">1、通过logcat命令获取。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81hook-liblog-so%E5%AE%9E%E7%8E%B0"><span class="nav-text">2、hook liblog.so实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E8%8E%B7%E5%8F%96%E4%BB%A3%E7%A0%81%E3%80%82%E9%80%9A%E8%BF%87%E7%A7%BB%E6%A4%8D%E5%BA%95%E5%B1%82%E8%8E%B7%E5%8F%96logcat%E7%9A%84%E5%AE%9E%E7%8E%B0%EF%BC%8C%E9%80%9A%E8%BF%87socket%E7%9B%B4%E6%8E%A5%E8%B7%9Flogd%E4%BA%A4%E4%BA%92%E3%80%82"><span class="nav-text">3、自定义获取代码。通过移植底层获取logcat的实现，通过socket直接跟logd交互。</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96Java-%E5%A0%86%E6%A0%88%EF%BC%9F"><span class="nav-text">如何获取Java 堆栈？</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81Thread-getAllStackTraces-%E3%80%82"><span class="nav-text">1、Thread.getAllStackTraces()。</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BC%98%E7%82%B9"><span class="nav-text">优点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BC%BA%E7%82%B9"><span class="nav-text">缺点</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81hook-libart-so%E3%80%82"><span class="nav-text">2、hook libart.so。</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Java-Crash%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="nav-text">Java Crash处理流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A1%A5%E5%85%85%E5%8A%A0%E6%B2%B9%E7%AB%99%EF%BC%9Abinder-%E6%AD%BB%E4%BA%A1%E9%80%9A%E7%9F%A5%E5%8E%9F%E7%90%86"><span class="nav-text">补充加油站：binder 死亡通知原理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NativeCrash"><span class="nav-text">NativeCrash</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81%E5%90%88%E6%A0%BC%E7%9A%84%E5%BC%82%E5%B8%B8%E6%8D%95%E8%8E%B7%E7%BB%84%E4%BB%B6"><span class="nav-text">1、合格的异常捕获组件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E7%8E%B0%E6%9C%89%E6%96%B9%E6%A1%88"><span class="nav-text">2、现有方案</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81Google-Breakpad"><span class="nav-text">1、Google Breakpad</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81Logcat"><span class="nav-text">2、Logcat</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81coffeecatch"><span class="nav-text">3、coffeecatch</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81Native%E5%B4%A9%E6%BA%83%E6%8D%95%E8%8E%B7%E6%B5%81%E7%A8%8B"><span class="nav-text">3、Native崩溃捕获流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E7%BC%96%E8%AF%91%E7%AB%AF"><span class="nav-text">1、编译端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-text">2、客户端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="nav-text">3、服务端</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%E3%80%81Native%E5%B4%A9%E6%BA%83%E6%8D%95%E8%8E%B7%E7%9A%84%E9%9A%BE%E7%82%B9"><span class="nav-text">4、Native崩溃捕获的难点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E6%96%87%E4%BB%B6%E5%8F%A5%E6%9F%84%E6%B3%84%E9%9C%B2%EF%BC%8C%E5%AF%BC%E8%87%B4%E5%88%9B%E5%BB%BA%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E5%A4%B1%E8%B4%A5%EF%BC%9F"><span class="nav-text">1、文件句柄泄露，导致创建日志文件失败？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E6%A0%88%E6%BA%A2%E5%87%BA%E5%AF%BC%E8%87%B4%E6%97%A5%E5%BF%97%E7%94%9F%E6%88%90%E5%A4%B1%E8%B4%A5%EF%BC%9F"><span class="nav-text">2、栈溢出导致日志生成失败？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E5%A0%86%E5%86%85%E5%AD%98%E8%80%97%E5%B0%BD%E5%AF%BC%E8%87%B4%E6%97%A5%E5%BF%97%E7%94%9F%E6%88%90%E5%A4%B1%E8%B4%A5%EF%BC%9F"><span class="nav-text">3、堆内存耗尽导致日志生成失败？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81%E5%A0%86%E7%A0%B4%E5%9D%8F%E6%88%96%E4%BA%8C%E6%AC%A1%E5%B4%A9%E6%BA%83%E5%AF%BC%E8%87%B4%E6%97%A5%E5%BF%97%E7%94%9F%E6%88%90%E5%A4%B1%E8%B4%A5%EF%BC%9F"><span class="nav-text">4、堆破坏或二次崩溃导致日志生成失败？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5%E3%80%81%E6%83%B3%E8%A6%81%E9%81%B5%E5%BE%AAAndroid%E7%9A%84%E6%96%87%E6%9C%AC%E6%A0%BC%E5%BC%8F%E5%B9%B6%E6%B7%BB%E5%8A%A0%E6%9B%B4%E5%A4%9A%E9%87%8D%E8%A6%81%E7%9A%84%E4%BF%A1%E6%81%AF%EF%BC%9F"><span class="nav-text">5、想要遵循Android的文本格式并添加更多重要的信息？</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5%E3%80%81Native%E5%B4%A9%E6%BA%83%E6%8D%95%E8%8E%B7%E6%B3%A8%E5%86%8C"><span class="nav-text">5、Native崩溃捕获注册</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6%E3%80%81%E5%B4%A9%E6%BA%83%E5%88%86%E6%9E%90%E6%B5%81%E7%A8%8B"><span class="nav-text">6、崩溃分析流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%96%91%E9%9A%BECrash%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-text">疑难Crash解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%981%EF%BC%9A%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3Android-7-0-Toast-BadTokenException%EF%BC%9F"><span class="nav-text">问题1：如何解决Android 7.0 Toast BadTokenException？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%982%EF%BC%9A%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3-SharedPreference-apply-%E5%BC%95%E8%B5%B7%E7%9A%84-ANR-%E9%97%AE%E9%A2%98"><span class="nav-text">问题2：如何解决 SharedPreference apply 引起的 ANR 问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#apply%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E5%BC%95%E8%B5%B7ANR%EF%BC%9F"><span class="nav-text">apply为什么会引起ANR？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%EF%BC%9F"><span class="nav-text">如何解决？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F"><span class="nav-text">注意</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%983%EF%BC%9A%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3TimeoutExceptin%E5%BC%82%E5%B8%B8%EF%BC%9F"><span class="nav-text">问题3：如何解决TimeoutExceptin异常？</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%84%E9%81%BF%E6%96%B9%E6%A1%88"><span class="nav-text">规避方案</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%BA%E7%82%B9-1"><span class="nav-text">缺点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%984%EF%BC%9A%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E8%BE%93%E5%85%A5%E6%B3%95%E7%9A%84%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%EF%BC%9F"><span class="nav-text">问题4：如何解决输入法的内存泄漏？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E4%BF%9D%E6%B4%BB"><span class="nav-text">进程保活</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ANR%E4%BC%98%E5%8C%96"><span class="nav-text">ANR优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ANR%E7%9B%91%E6%8E%A7%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="nav-text">ANR监控实现方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81%E4%BD%BF%E7%94%A8FileObserver%E7%9B%91%E5%90%AC-x2F-data-x2F-anr-x2F-traces-txt-%E7%9A%84%E5%8F%98%E5%8C%96"><span class="nav-text">1、使用FileObserver监听 &#x2F;data&#x2F;anr&#x2F;traces.txt 的变化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E7%9B%91%E6%8E%A7%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E8%BF%90%E8%A1%8C%E6%97%B6%E9%97%B4"><span class="nav-text">2、监控消息队列的运行时间</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%BA%E7%82%B9-2"><span class="nav-text">缺点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81%E9%9C%80%E8%A6%81%E8%80%83%E8%99%91%E5%BA%94%E7%94%A8%E9%80%80%E5%87%BA%E5%9C%BA%E6%99%AF"><span class="nav-text">3、需要考虑应用退出场景</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F-1"><span class="nav-text">注意</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81ANR%E4%BC%98%E5%8C%96"><span class="nav-text">2、ANR优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ANR%E5%88%86%E7%B1%BB"><span class="nav-text">ANR分类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%91%E7%94%9F%E5%9C%BA%E6%99%AF"><span class="nav-text">发生场景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%91%E7%94%9F%E5%8E%9F%E5%9B%A0"><span class="nav-text">发生原因</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ANR%E6%8E%92%E6%9F%A5%E6%B5%81%E7%A8%8B"><span class="nav-text">ANR排查流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81Log%E8%8E%B7%E5%8F%96"><span class="nav-text">1、Log获取</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E6%90%9C%E7%B4%A2%E2%80%9CANR-in%E2%80%9D%E5%A4%84log%E5%85%B3%E9%94%AE%E7%82%B9%E8%A7%A3%E8%AF%BB"><span class="nav-text">2、搜索“ANR in”处log关键点解读</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F-2"><span class="nav-text">注意</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E5%9C%A8bugreport-txt%E4%B8%AD%E6%A0%B9%E6%8D%AEpid%E5%92%8C%E5%8F%91%E7%94%9F%E6%97%B6%E9%97%B4%E6%90%9C%E7%B4%A2%E5%88%B0%E9%98%BB%E5%A1%9E%E7%9A%84log%E5%A4%84"><span class="nav-text">3、在bugreport.txt中根据pid和发生时间搜索到阻塞的log处</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81%E5%BE%80%E4%B8%8B%E7%BF%BB%E6%89%BE%E5%88%B0%E2%80%9Cmain%E2%80%9D%E7%BA%BF%E7%A8%8B%E5%88%99%E5%8F%AF%E7%9C%8B%E5%88%B0%E5%AF%B9%E5%BA%94%E7%9A%84%E9%98%BB%E5%A1%9Elog"><span class="nav-text">4、往下翻找到“main”线程则可看到对应的阻塞log</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A1%A5%E5%85%85%E5%8A%A0%E6%B2%B9%E7%AB%99%EF%BC%9A%E5%90%84%E7%A7%8D%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81"><span class="nav-text">补充加油站：各种线程状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B6%E5%AE%83%E5%88%86%E6%9E%90%E6%96%B9%E6%B3%95%EF%BC%9AJava%E7%BA%BF%E7%A8%8B%E8%B0%83%E7%94%A8%E5%88%86%E6%9E%90%E6%96%B9%E6%B3%95"><span class="nav-text">其它分析方法：Java线程调用分析方法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E5%85%B3%E4%BA%8EANR%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="nav-text">3、关于ANR的一些常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81sp%E8%B0%83%E7%94%A8apply%E5%AF%BC%E8%87%B4anr%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="nav-text">1、sp调用apply导致anr问题？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E6%A3%80%E6%B5%8B%E8%BF%90%E8%A1%8C%E6%9C%9F%E9%97%B4%E6%98%AF%E5%90%A6%E5%8F%91%E7%94%9F%E8%BF%87%E5%BC%82%E5%B8%B8%E9%80%80%E5%87%BA%EF%BC%9F"><span class="nav-text">2、检测运行期间是否发生过异常退出？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4%E3%80%81%E7%90%86%E8%A7%A3ANR%E7%9A%84%E8%A7%A6%E5%8F%91%E6%B5%81%E7%A8%8B"><span class="nav-text">4、理解ANR的触发流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81AMS-appNotResponding%E6%B5%81%E7%A8%8B"><span class="nav-text">1、AMS.appNotResponding流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81AMS-dumpStackTraces%E6%B5%81%E7%A8%8B"><span class="nav-text">2、AMS.dumpStackTraces流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E6%94%B6%E9%9B%86firstPids%E8%BF%9B%E7%A8%8B%E7%9A%84stacks%EF%BC%9A"><span class="nav-text">1、收集firstPids进程的stacks：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E6%94%B6%E9%9B%86Native%E8%BF%9B%E7%A8%8B%E7%9A%84stacks%E3%80%82-dumpNativeBacktraceToFile"><span class="nav-text">2、收集Native进程的stacks。(dumpNativeBacktraceToFile)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E6%94%B6%E9%9B%86lastPids%E8%BF%9B%E7%A8%8B%E7%9A%84stacks%EF%BC%9A"><span class="nav-text">3、收集lastPids进程的stacks：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F-3"><span class="nav-text">注意</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%A7%BB%E5%8A%A8%E7%AB%AF%E4%B8%9A%E5%8A%A1%E9%AB%98%E5%8F%AF%E7%94%A8%E6%96%B9%E6%A1%88%E5%BB%BA%E8%AE%BE"><span class="nav-text">移动端业务高可用方案建设</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E4%B8%9A%E5%8A%A1%E9%AB%98%E5%8F%AF%E7%94%A8%E9%87%8D%E8%A6%81%E6%80%A7"><span class="nav-text">1、业务高可用重要性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E4%B8%9A%E5%8A%A1%E9%AB%98%E5%8F%AF%E7%94%A8%E6%96%B9%E6%A1%88%E5%BB%BA%E8%AE%BE"><span class="nav-text">2、业务高可用方案建设</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E7%A7%BB%E5%8A%A8%E7%AB%AF%E5%AE%B9%E7%81%BE%E6%96%B9%E6%A1%88"><span class="nav-text">3、移动端容灾方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%81%BE%E5%8C%85%E6%8B%AC%EF%BC%9A"><span class="nav-text">灾包括：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%A0%E7%BB%9F%E6%B5%81%E7%A8%8B%EF%BC%9A"><span class="nav-text">传统流程：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%B9%E7%81%BE%E6%96%B9%E6%A1%88%E5%BB%BA%E8%AE%BE"><span class="nav-text">容灾方案建设</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E5%8A%9F%E8%83%BD%E5%BC%80%E5%85%B3"><span class="nav-text">1、功能开关</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%92%88%E5%AF%B9%E5%9C%BA%E6%99%AF"><span class="nav-text">针对场景</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E7%BB%9F%E8%B7%B3%E4%B8%AD%E5%BF%83"><span class="nav-text">2、统跳中心</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E5%8A%A8%E6%80%81%E5%8C%96%E4%BF%AE%E5%A4%8D"><span class="nav-text">3、动态化修复</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81%E6%8E%A8%E6%8B%89%E7%BB%93%E5%90%88%E3%80%81%E5%A4%9A%E5%9C%BA%E6%99%AF%E8%B0%83%E7%94%A8%E4%BF%9D%E8%AF%81%E5%88%B0%E8%BE%BE%E7%8E%87"><span class="nav-text">4、推拉结合、多场景调用保证到达率</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5%E3%80%81Weex%E3%80%81RN%E5%A2%9E%E9%87%8F%E6%9B%B4%E6%96%B0"><span class="nav-text">5、Weex、RN增量更新</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6%E3%80%81%E5%AE%89%E5%85%A8%E6%A8%A1%E5%BC%8F"><span class="nav-text">6、安全模式</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E6%A8%A1%E5%BC%8F%E8%AE%BE%E8%AE%A1"><span class="nav-text">安全模式设计</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A4%A9%E7%8C%AB%E5%AE%89%E5%85%A8%E6%A8%A1%E5%BC%8F%E5%8E%9F%E7%90%86"><span class="nav-text">天猫安全模式原理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%98%93%E7%94%A8%E6%80%A7%E8%80%83%E9%87%8F"><span class="nav-text">易用性考量</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7%E3%80%81%E5%BC%82%E5%B8%B8%E7%86%94%E6%96%AD"><span class="nav-text">7、异常熔断</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%B9%E7%81%BE%E6%96%B9%E6%A1%88%E9%9B%86%E5%90%88%E8%B7%AF%E5%BE%84"><span class="nav-text">容灾方案集合路径</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%A8%B3%E5%AE%9A%E6%80%A7%E9%95%BF%E6%95%88%E6%B2%BB%E7%90%86"><span class="nav-text">稳定性长效治理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E5%BC%80%E5%8F%91%E9%98%B6%E6%AE%B5"><span class="nav-text">1、开发阶段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E6%B5%8B%E8%AF%95%E9%98%B6%E6%AE%B5"><span class="nav-text">2、测试阶段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E5%90%88%E7%A0%81%E9%98%B6%E6%AE%B5"><span class="nav-text">3、合码阶段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4%E3%80%81%E5%8F%91%E5%B8%83%E9%98%B6%E6%AE%B5"><span class="nav-text">4、发布阶段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5%E3%80%81%E8%BF%90%E7%BB%B4%E9%98%B6%E6%AE%B5"><span class="nav-text">5、运维阶段</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%A8%B3%E5%AE%9A%E6%80%A7%E4%BC%98%E5%8C%96%E9%97%AE%E9%A2%98"><span class="nav-text">稳定性优化问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E4%BD%A0%E4%BB%AC%E5%81%9A%E4%BA%86%E5%93%AA%E4%BA%9B%E7%A8%B3%E5%AE%9A%E6%80%A7%E6%96%B9%E9%9D%A2%E7%9A%84%E4%BC%98%E5%8C%96%EF%BC%9F"><span class="nav-text">1、你们做了哪些稳定性方面的优化？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E6%80%A7%E8%83%BD%E7%A8%B3%E5%AE%9A%E6%80%A7%E6%98%AF%E6%80%8E%E4%B9%88%E5%81%9A%E7%9A%84%EF%BC%9F"><span class="nav-text">2、性能稳定性是怎么做的？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E4%B8%9A%E5%8A%A1%E7%A8%B3%E5%AE%9A%E6%80%A7%E5%A6%82%E4%BD%95%E4%BF%9D%E9%9A%9C%EF%BC%9F"><span class="nav-text">3、业务稳定性如何保障？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4%E3%80%81%E5%A6%82%E6%9E%9C%E5%8F%91%E7%94%9F%E4%BA%86%E5%BC%82%E5%B8%B8%E6%83%85%E5%86%B5%EF%BC%8C%E6%80%8E%E4%B9%88%E5%BF%AB%E9%80%9F%E6%AD%A2%E6%8D%9F%EF%BC%9F"><span class="nav-text">4、如果发生了异常情况，怎么快速止损？</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-1"><span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">阿炳</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('-1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
          if(result)$(this).text('Copied')
          else $(this).text('Copy failed')
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('Copy')
        }, 300)
      }).append(e)
    })
  </script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>