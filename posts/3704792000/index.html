<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="安卓知识点," />










<meta name="description" content="网络OKHttp中body().string()其中string()只能被使用一次，使用过后就会被清空掉。即代码中调用两次body().string()的话第二次是没有值的。如果想要则需要用个临时变量保存起来。 Regrofit">
<meta property="og:type" content="article">
<meta property="og:title" content="安卓-网络">
<meta property="og:url" content="http://shenbh.github.io/posts/3704792000/index.html">
<meta property="og:site_name" content="积跬步">
<meta property="og:description" content="网络OKHttp中body().string()其中string()只能被使用一次，使用过后就会被清空掉。即代码中调用两次body().string()的话第二次是没有值的。如果想要则需要用个临时变量保存起来。 Regrofit">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-03-24T08:03:08.000Z">
<meta property="article:modified_time" content="2025-07-02T02:27:57.868Z">
<meta property="article:author" content="阿炳">
<meta property="article:tag" content="安卓知识点">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://shenbh.github.io/posts/3704792000/"/>





  <title>安卓-网络 | 积跬步</title>
  








<meta name="generator" content="Hexo 6.1.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">积跬步</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">Just do IT Now.</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://shenbh.github.io/posts/3704792000/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="积跬步">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">安卓-网络</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-24T16:03:08+08:00">
                2020-03-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h1><p>OKHttp中<code>body().string()</code>其中<code>string()</code>只能被使用一次，使用过后就会被清空掉。即代码中调用两次<code>body().string()</code>的话第二次是没有值的。如果想要则需要用个临时变量保存起来。</p>
<h1 id="Regrofit"><a href="#Regrofit" class="headerlink" title="Regrofit"></a><code>Regrofit</code></h1><h2 id="OkHttpClickent配置超时时间"><a href="#OkHttpClickent配置超时时间" class="headerlink" title="OkHttpClickent配置超时时间"></a><code>OkHttpClickent</code>配置超时时间</h2><p>默认情况下，<code>Retrofit</code>的默认超时时间如下：</p>
<ul>
<li><code>Connection timeout</code>：10秒</li>
<li><code>Read timeout</code>：10秒</li>
<li><code>Write timeout</code>：10秒</li>
<li><code>Call timeout</code>：0秒（代表没有超时）</li>
</ul>
<h2 id="如何设置超时时间"><a href="#如何设置超时时间" class="headerlink" title="如何设置超时时间"></a>如何设置超时时间</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">OkHttpClient</span> <span class="variable">okHttpClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>.Builder()</span><br><span class="line">    .connectTimeout(<span class="number">1</span>, TimeUnit.MINUTES)</span><br><span class="line">    .readTimeout(<span class="number">30</span>, TimeUnit.SECONDS)</span><br><span class="line">    .writeTimeout(<span class="number">15</span>, TimeUnit.SECONDS)</span><br><span class="line">    .callTimeout(<span class="number">2</span>, TimeUnit.MINUTES)</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line">Retrofit.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Retrofit</span>.Builder()  </span><br><span class="line">    .baseUrl(<span class="string">&quot;http://10.0.2.2:3000/&quot;</span>)</span><br><span class="line">    .client(okHttpClient)</span><br><span class="line">    .addConverterFactory(GsonConverterFactory.create());</span><br></pre></td></tr></table></figure>

<h2 id="Connection-Timeout-连接超时"><a href="#Connection-Timeout-连接超时" class="headerlink" title="Connection Timeout-连接超时"></a>Connection Timeout-连接超时</h2><p><code>connectionTimeout</code>：从客户端发出一个请求开始到客户端与服务器端完成<code>TCP</code>的3次握手建立连接的这段时间。即，如果<code>Retrofit</code>在指定的时间无法与服务器端建立连接，那么<code>Retrofit</code>就认为此次请求失败。</p>
<p>比如，当你的用户可能会在网络状态不佳的情况下与你的服务器进行通信，那么你需要将增大这个数字。</p>
<h2 id="Read-Timeout-读取超时"><a href="#Read-Timeout-读取超时" class="headerlink" title="Read Timeout-读取超时"></a>Read Timeout-读取超时</h2><p><code>readTimeout</code>：从连接建立成功开始，<code>Retrofit</code>就会监测<strong>每个字节</strong>的数据传输的速率。如果其中某字节距离上一个字节传输成功的时间大于指定的<code>readTimeout</code>了，<code>Retrofit</code>就会认为这个请求是失败的。这个时间计数器会在读取到每个<code>byte</code>之后归零重新开始计时。所以如果你的响应当中有120个<code>bytes</code>需要传输到客户端，而每个<code>byte</code>的传输都需要5秒，这种情况下尽管完全传输需要600秒，但不会触发<code>readTimeout（30秒）error</code>。</p>
<p>另外，<code>readTimeout</code>的触发不仅限于<strong>服务器端</strong>的处理能力，也有可能是糟糕的网络状态引起。</p>
<blockquote>
<p>注意这个并不是说在指定的时间（比如30秒）内需要把响应内容完全接收，而是指相邻的两个字节之间的接收时间不能超过指定的时间（30秒）。</p>
</blockquote>
<h2 id="Write-Timeout-写入超时"><a href="#Write-Timeout-写入超时" class="headerlink" title="Write Timeout-写入超时"></a>Write Timeout-写入超时</h2><p><code>writeTimeout</code>：跟<code>readTimeout</code>相对应的反方向的数据传输。它检查的是<strong>客户端</strong>向服务器端发送数据的速率。当然，跟<code>readTimeout</code>的计时器类似，每个<code>byte</code>发送成功之后这个计时器都会被重置。如果某个<code>byte</code>的数据传输时间 超过了配置的写入超时时间，<code>Retrofit</code>就会认为这个请求是失败的。</p>
<blockquote>
<p>注意这个并不是说在指定时间（比如15秒）内需要把所有的数据都发送到服务器端，而是指相邻的两个字节之间的发送时间不能超过指定的时间（15秒）。</p>
</blockquote>
<h2 id="Call-Timeout-请求超时"><a href="#Call-Timeout-请求超时" class="headerlink" title="Call Timeout-请求超时"></a>Call Timeout-请求超时</h2><p>可从这看 <a target="_blank" rel="noopener" href="https://square.github.io/okhttp/4.x/okhttp/okhttp3/-ok-http-client/-builder/call-timeout/">https://square.github.io/okhttp/4.x/okhttp/okhttp3/-ok-http-client/-builder/call-timeout/</a></p>
<p><code>CallTimeout</code>的计时器横跨整个请求，从<code>DNS</code>解析，连接建立，发送数据到服务器，服务器端处理，然后发送响应到客户端，直到客户端完全读取响应内容。如果这个请求需要重定向或重试，这些过程都必须在指定的<code>callTimeout</code>时间区间内完成。如果不能完成<code>Retrofit</code>就会认为请求失败。</p>
<p><code>CallTimeout=0</code>：代表不考虑请求的超时</p>
<blockquote>
<p>当你的应用需要限定<code>App</code>在某个指定的时间内得到响应结果，如果在指定时间内未能得到就认为是超时的话，那么你应该用<code>callTimeout</code></p>
</blockquote>
<h1 id="利用Android的以太网共享功能模拟LAN网口"><a href="#利用Android的以太网共享功能模拟LAN网口" class="headerlink" title="利用Android的以太网共享功能模拟LAN网口"></a><a target="_blank" rel="noopener" href="https://juejin.cn/post/7500100672390856713">利用Android的以太网共享功能模拟LAN网口</a></h1><p>本文的目标是在一个安装了 Android 系统的设备上模拟软路由。这个设备拥有三个网口，最终的目标是希望模拟出一个 <a href="../%E5%85%B6%E4%BB%96IT/IT%E8%AF%8D%E8%AF%AD.md#WAN%E7%BD%91%E5%8F%A3%EF%BC%88%E5%B9%BF%E5%9F%9F%E7%BD%91%E6%8E%A5%E5%8F%A3%EF%BC%89">WAN网口</a>和两个 <a href="../%E5%85%B6%E4%BB%96IT/IT%E8%AF%8D%E8%AF%AD.md#LAN%E7%BD%91%E5%8F%A3%EF%BC%88%E5%B1%80%E5%9F%9F%E7%BD%91%E6%8E%A5%E5%8F%A3%EF%BC%89">LAN网口</a>。目标系统为 Android 14。</p>
<p>Android14提供了以太网共享网络的功能，借助这个功能，我们可以将一个网口模拟成LAN口，但可惜的是，这个功能只对一个网口生效。我们先简要分析一下其实现原理，然后再给出在有三个网口的机器上模拟出两个LAN接口的技术解决方案。</p>
<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><h3 id="Settings-设置"><a href="#Settings-设置" class="headerlink" title="Settings 设置"></a>Settings 设置</h3><p>我们从系统已有的功能出发。网络共享的功能可以在原生 Settings 中找到相应开关，因此也可以找到相应的开启以太网共享的 SDK 接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/apps/Settings/src/com/android/settings/network/tether/TetherSettings.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onPreferenceTreeClick</span><span class="params">(Preference preference)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (preference == mUsbTether) &#123;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (preference == mBluetoothTether) &#123;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (preference == mEthernetTether) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mEthernetTether.isChecked()) &#123;</span><br><span class="line">            startTethering(TETHERING_ETHERNET);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mCm.stopTethering(TETHERING_ETHERNET);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.onPreferenceTreeClick(preference);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startTethering</span><span class="params">(<span class="type">int</span> choice)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (choice == TETHERING_BLUETOOTH) &#123;</span><br><span class="line">        <span class="comment">// Turn on Bluetooth first.</span></span><br><span class="line">        <span class="type">BluetoothAdapter</span> <span class="variable">adapter</span> <span class="operator">=</span> BluetoothAdapter.getDefaultAdapter();</span><br><span class="line">        <span class="keyword">if</span> (adapter.getState() == BluetoothAdapter.STATE_OFF) &#123;</span><br><span class="line">            mBluetoothEnableForTether = <span class="literal">true</span>;</span><br><span class="line">            adapter.enable();</span><br><span class="line">            mBluetoothTether.setEnabled(<span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mCm.startTethering(choice, <span class="literal">true</span>, mStartTetheringCallback, mHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们点击界面上的 Switch 时，<code>onPreferenceTreeClick()</code>方法被回调，Settings 根据点击的按钮不同，将会使用不同的 Choice 来调用<code>startTethering</code>方法。</p>
<p><code>TetherSettings#startTethering()</code>方法调用了<code>ConnectivityManager#startTethering()</code>来启用某一种网络共享，网络共享的具体通道（蓝牙、USB 、以太网）则由参数 choice 来决定。</p>
<h3 id="ConnectivityManager-连接管理器"><a href="#ConnectivityManager-连接管理器" class="headerlink" title="ConnectivityManager 连接管理器"></a>ConnectivityManager 连接管理器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/modules/Connectivity/framework/src/android/net/ConnectivityManager.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@SystemApi</span></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="meta">@RequiresPermission(android.Manifest.permission.TETHER_PRIVILEGED)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startTethering</span><span class="params">(<span class="type">int</span> type, <span class="type">boolean</span> showProvisioningUi,</span></span><br><span class="line"><span class="params">                           <span class="keyword">final</span> OnStartTetheringCallback callback, Handler handler)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Executor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Executor</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command)</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">StartTetheringCallback</span> <span class="variable">tetheringCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StartTetheringCallback</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTetheringStarted</span><span class="params">()</span> &#123;</span><br><span class="line">            callback.onTetheringStarted();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTetheringFailed</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> error)</span> &#123;</span><br><span class="line">            callback.onTetheringFailed();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">TetheringRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TetheringRequest</span>.Builder(type)</span><br><span class="line">        .setShouldShowEntitlementUi(showProvisioningUi).build();</span><br><span class="line"></span><br><span class="line">    getTetheringManager().startTethering(request, executor, tetheringCallback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> TetheringManager <span class="title function_">getTetheringManager</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mTetheringEventCallbacks) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mTetheringManager == <span class="literal">null</span>) &#123;</span><br><span class="line">            mTetheringManager = mContext.getSystemService(TetheringManager.class);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mTetheringManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ConnectivityManager#startTethering()</code>这个 API 已经被标记为废弃了。它的实现的大意为，将回调和网络共享<code>type</code>的信息进一步封装起来，并传递给<code>TetheringManager</code>进行处理。<code>getTetheringManager()</code>的实现告诉我们 TetheringManager 实际上也对应一个 System Server，为了节约篇幅，我们跳过 Manager 直接关注其背后实现 Server 的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/modules/Connectivity/Tethering/src/com/android/networkstack/tethering/TetheringService.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startTethering</span><span class="params">(TetheringRequestParcel request, String callerPkg,</span></span><br><span class="line"><span class="params">                           String callingAttributionTag, IIntResultListener listener)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (checkAndNotifyCommonError(callerPkg, callingAttributionTag,</span><br><span class="line">        request.exemptFromEntitlementCheck <span class="comment">/* onlyAllowPrivileged */</span>, listener)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mTethering.startTethering(request, callerPkg, listener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>TetheringService</code> 在完成参数校验后，委托给<code>Tethering</code>类来处理共享的具体逻辑。</p>
<h3 id="Tethering-网络共享"><a href="#Tethering-网络共享" class="headerlink" title="Tethering 网络共享"></a>Tethering 网络共享</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/modules/Connectivity/Tethering/src/com/android/networkstack/tethering/Tethering.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">startTethering</span><span class="params">(<span class="keyword">final</span> TetheringRequestParcel request, <span class="keyword">final</span> String callerPkg,</span></span><br><span class="line"><span class="params">                    <span class="keyword">final</span> IIntResultListener listener)</span> &#123;</span><br><span class="line">    mHandler.post(() -&gt; &#123;</span><br><span class="line">        enableTetheringInternal(request.tetheringType, <span class="literal">true</span> <span class="comment">/* enabled */</span>, listener);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">enableTetheringInternal</span><span class="params">(<span class="type">int</span> type, <span class="type">boolean</span> enable,</span></span><br><span class="line"><span class="params">                                     <span class="keyword">final</span> IIntResultListener listener)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> TETHER_ERROR_NO_ERROR;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">        <span class="keyword">case</span> TETHERING_WIFI:</span><br><span class="line">            result = setWifiTethering(enable);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> TETHERING_USB:</span><br><span class="line">            result = setUsbTethering(enable);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> TETHERING_BLUETOOTH:</span><br><span class="line">            setBluetoothTethering(enable, listener);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> TETHERING_NCM:</span><br><span class="line">            result = setNcmTethering(enable);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> TETHERING_ETHERNET:</span><br><span class="line">            result = setEthernetTethering(enable);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            Log.w(TAG, <span class="string">&quot;Invalid tether type.&quot;</span>);</span><br><span class="line">            result = TETHER_ERROR_UNKNOWN_TYPE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The result of Bluetooth tethering will be sent by #setBluetoothTethering.</span></span><br><span class="line">    <span class="keyword">if</span> (type != TETHERING_BLUETOOTH) &#123;</span><br><span class="line">        sendTetherResult(listener, result, type);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">setEthernetTethering</span><span class="params">(<span class="keyword">final</span> <span class="type">boolean</span> enable)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">EthernetManager</span> <span class="variable">em</span> <span class="operator">=</span> (EthernetManager) mContext.getSystemService(</span><br><span class="line">        Context.ETHERNET_SERVICE);</span><br><span class="line">    <span class="keyword">if</span> (enable) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mEthernetCallback != <span class="literal">null</span>) &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;Ethernet tethering already started&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> TETHER_ERROR_NO_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mEthernetCallback = <span class="keyword">new</span> <span class="title class_">EthernetCallback</span>();</span><br><span class="line">        mEthernetIfaceRequest = em.requestTetheredInterface(mExecutor, mEthernetCallback);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        stopEthernetTethering();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TETHER_ERROR_NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Tethering</code>类可以处理多种不同通道的网络共享，我们重点关注的以太网共享功能，其实现关键位于<code>setEthernetTethering()</code>这个方法。</p>
<p>这个方法大意为，首先获取<code>EthernetManager</code>，然后调用<code>requestTetheredInterface</code>来尝试获取一个可用的以太网接口，<code>Tethering</code>将会在这个接口上开启一系列关键的服务，如 DHCP 等。<code>requestTetheredInterface</code>的结果将通过<code>EthernetCallback</code>这个回调接口来回传。我们先观察一下<code>EthernetCallback</code>的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/modules/Connectivity/Tethering/src/com/android/networkstack/tethering/Tethering.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">EthernetCallback</span> <span class="keyword">implements</span> <span class="title class_">EthernetManager</span>.TetheredInterfaceCallback &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAvailable</span><span class="params">(String iface)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span> != mEthernetCallback) &#123;</span><br><span class="line">            <span class="comment">// Ethernet callback arrived after Ethernet tethering stopped. Ignore.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        enableIpServing(TETHERING_ETHERNET, iface, getRequestedState(TETHERING_ETHERNET));</span><br><span class="line">        mConfiguredEthernetIface = iface;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onUnavailable</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span> != mEthernetCallback) &#123;</span><br><span class="line">            <span class="comment">// onAvailable called after stopping Ethernet tethering.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        stopEthernetTethering();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Tethering</code>获得这个接口的信息后，用这个接口的名称来调用<code>enableIpServing</code>。<code>enableIpServing</code>将会开启绑定在这个接口上的<code>IpServer</code>，这个类提供了 DHCP 等关键服务，对实现网络共享至关重要。</p>
<h3 id="EthernetManager-以太网管理器"><a href="#EthernetManager-以太网管理器" class="headerlink" title="EthernetManager 以太网管理器"></a>EthernetManager 以太网管理器</h3><p>我们跳过<code>EthernetManager#requestTetheredInterface()</code>，直接找到真正的实现<code>EthernetServiceImpl#requestTetheredInterface()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/modules/Connectivity/service-t/src/com/android/server/ethernet/EthernetServiceImpl.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestTetheredInterface</span><span class="params">(ITetheredInterfaceCallback callback)</span> &#123;</span><br><span class="line">    Objects.requireNonNull(callback, <span class="string">&quot;callback must not be null&quot;</span>);</span><br><span class="line">    PermissionUtils.enforceNetworkStackPermissionOr(</span><br><span class="line">        mContext,</span><br><span class="line">        android.Manifest.permission.NETWORK_SETTINGS</span><br><span class="line">    );</span><br><span class="line">    mTracker.requestTetheredInterface(callback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages/modules/Connectivity/service-t/src/com/android/server/ethernet/EthernetTracker.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestTetheredInterface</span><span class="params">(ITetheredInterfaceCallback callback)</span> &#123;</span><br><span class="line">    mHandler.post(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mTetheredInterfaceRequests.register(callback)) &#123;</span><br><span class="line">            <span class="comment">// Remote process has already died</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mTetheringInterfaceMode == INTERFACE_MODE_SERVER) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mTetheredInterfaceWasAvailable) &#123;</span><br><span class="line">                notifyTetheredInterfaceAvailable(callback, mTetheringInterface);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        setTetheringInterfaceMode(INTERFACE_MODE_SERVER);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>EthernetServiceImpl</code>又将具体的实现委托给了<code>EthernetTracker</code>来执行。而我们会注意到，<code>EthernetTracker</code>将直接尝试返回类变量<code>mTetheringInterface</code>，这个变量将作为以太网的共享接口。</p>
<p><code>EthernetTracker</code>对 mTetheringInterface 这个特殊的共享接口进行了许多特殊操作，另外两个与之相关的类变量是<code>mTetheredInterfaceWasAvailable</code>和<code>mTetheringInterfaceMode</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/modules/Connectivity/service-t/src/com/android/server/ethernet/EthernetTracker.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The first interface discovered is set as the mTetheringInterface. It is the interface that is</span></span><br><span class="line"><span class="comment">// returned when a tethered interface is requested; until then, it remains in client mode. Its</span></span><br><span class="line"><span class="comment">// current mode is reflected in mTetheringInterfaceMode.</span></span><br><span class="line"><span class="keyword">private</span> String mTetheringInterface;</span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">mTetheringInterfaceMode</span> <span class="operator">=</span> INTERFACE_MODE_CLIENT;</span><br><span class="line"><span class="comment">// Tracks whether clients were notified that the tethered interface is available</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">mTetheredInterfaceWasAvailable</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<p>mTetheringInterface 将在<code>maybeTrackInterface</code>这个方法内被选举出来：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/modules/Connectivity/service-t/src/com/android/server/ethernet/EthernetTracker.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">maybeTrackInterface</span><span class="params">(String iface)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isValidEthernetInterface(iface)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we don&#x27;t already track this interface, and if this interface matches</span></span><br><span class="line">    <span class="comment">// our regex, start tracking it.</span></span><br><span class="line">    <span class="keyword">if</span> (mFactory.hasInterface(iface) || iface.equals(mTetheringInterface)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DBG) Log.w(TAG, <span class="string">&quot;Ignoring already-tracked interface &quot;</span> + iface);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (DBG) Log.i(TAG, <span class="string">&quot;maybeTrackInterface: &quot;</span> + iface);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do not use an interface for tethering if it has configured NetworkCapabilities.</span></span><br><span class="line">    <span class="keyword">if</span> (mTetheringInterface == <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        !mNetworkCapabilities.containsKey(iface)) &#123;</span><br><span class="line">        mTetheringInterface = iface;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    addInterface(iface);</span><br><span class="line"></span><br><span class="line">    broadcastInterfaceStateChange(iface);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单来说，第一个没有配置<code>NetworkCapabilities</code>的以太网接口将被作为共享接口。</p>
<p>最后，我们关注一下<code>isValidEthernetInterface</code>的实现，这个方法是<code>EthernetTracker</code>判断一个接口是不是以太网接口的通用方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/modules/Connectivity/service-t/src/com/android/server/ethernet/EthernetTracker.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String mIfaceMatch;</span><br><span class="line"></span><br><span class="line">EthernetTracker() &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ConnectivityResources</span> <span class="variable">resources</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectivityResources</span>(context);</span><br><span class="line"></span><br><span class="line">    mIfaceMatch = resources.get().getString(</span><br><span class="line">        com.android.connectivity.resources.R.string.config_ethernet_iface_regex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isValidEthernetInterface</span><span class="params">(String iface)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> iface.matches(mIfaceMatch) || isValidTestInterface(iface);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>据此我们可以得出结论，确认一个接口是否是以太网接口的方式是用正则表达式对接口的名字做匹配。相关的字符串资源文件位于下方：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// packages/modules/Connectivity/service/ServiceConnectivityResources/res/values/config.xml</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">string</span> <span class="attr">translatable</span>=<span class="string">&quot;false&quot;</span> <span class="attr">name</span>=<span class="string">&quot;config_ethernet_iface_regex&quot;</span>&gt;</span>eth\\d<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>显然，默认情况下，只有以 eth 开头，并且后面接一位数字的接口才会被认为是以太网接口。</p>
<p><strong>如何获得<code>EthernetTracker</code>的信息？</strong></p>
<p>通过 <code>dumpsys ethernet</code>。</p>
<p>信息的含义请参考<code>EthernetTracker</code>的<code>dump</code>方法。</p>
<h3 id="随机子网"><a href="#随机子网" class="headerlink" title="随机子网"></a>随机子网</h3><p>无论我们是使用 Wifi 热点还是以太网网络共享，设备虚拟出来的子网是随机的，生成这些随机子网的逻辑藏在<code>IpServer</code>内：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/modules/Connectivity/Tethering/src/android/net/ip/IpServer.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> LinkAddress <span class="title function_">requestIpv4Address</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> scope, <span class="keyword">final</span> <span class="type">boolean</span> useLastAddress)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mStaticIpv4ServerAddr != <span class="literal">null</span>) <span class="keyword">return</span> mStaticIpv4ServerAddr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shouldNotConfigureBluetoothInterface()) <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LinkAddress</span>(BLUETOOTH_IFACE_ADDR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mPrivateAddressCoordinator.requestDownstreamAddress(<span class="built_in">this</span>, scope, useLastAddress);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>IpServer</code>调用了<code>PrivateAddressCoordinator</code>的相关方法来生成随机的地址。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/modules/Connectivity/Tethering/src/com/android/networkstack/tethering/PrivateAddressCoordinator.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> LinkAddress <span class="title function_">requestDownstreamAddress</span><span class="params">(<span class="keyword">final</span> IpServer ipServer, <span class="keyword">final</span> <span class="type">int</span> scope,</span></span><br><span class="line"><span class="params">                                            <span class="type">boolean</span> useLastAddress)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mConfig.shouldEnableWifiP2pDedicatedIp()</span><br><span class="line">        &amp;&amp; ipServer.interfaceType() == TETHERING_WIFI_P2P) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LinkAddress</span>(LEGACY_WIFI_P2P_IFACE_ADDRESS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">AddressKey</span> <span class="variable">addrKey</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AddressKey</span>(ipServer.interfaceType(), scope);</span><br><span class="line">    <span class="comment">// This ensures that tethering isn&#x27;t started on 2 different interfaces with the same type.</span></span><br><span class="line">    <span class="comment">// Once tethering could support multiple interface with the same type,</span></span><br><span class="line">    <span class="comment">// TetheringSoftApCallback would need to handle it among others.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">LinkAddress</span> <span class="variable">cachedAddress</span> <span class="operator">=</span> mCachedAddresses.get(addrKey);</span><br><span class="line">    <span class="keyword">if</span> (useLastAddress &amp;&amp; cachedAddress != <span class="literal">null</span></span><br><span class="line">        &amp;&amp; !isConflictWithUpstream(asIpPrefix(cachedAddress))) &#123;</span><br><span class="line">        mDownstreams.add(ipServer);</span><br><span class="line">        <span class="keyword">return</span> cachedAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (IpPrefix prefixRange : mTetheringPrefixes) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">LinkAddress</span> <span class="variable">newAddress</span> <span class="operator">=</span> chooseDownstreamAddress(prefixRange);</span><br><span class="line">        <span class="keyword">if</span> (newAddress != <span class="literal">null</span>) &#123;</span><br><span class="line">            mDownstreams.add(ipServer);</span><br><span class="line">            mCachedAddresses.put(addrKey, newAddress);</span><br><span class="line">            <span class="keyword">return</span> newAddress;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// No available address.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AddressKey</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> mTetheringType;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> mScope;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">AddressKey</span><span class="params">(<span class="type">int</span> type, <span class="type">int</span> scope)</span> &#123;</span><br><span class="line">        mTetheringType = type;</span><br><span class="line">        mScope = scope;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(<span class="meta">@Nullable</span> Object obj)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(obj <span class="keyword">instanceof</span> AddressKey)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">AddressKey</span> <span class="variable">other</span> <span class="operator">=</span> (AddressKey) obj;</span><br><span class="line"></span><br><span class="line">        <span class="type">return</span> <span class="variable">mTetheringType</span> <span class="operator">=</span>= other.mTetheringType &amp;&amp; mScope == other.mScope;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>mCachedAddresses</code>是<code>AddressKey</code>到<code>LinkAddress</code>之间的映射，从第44行<code>AddressKey</code>的<code>equals</code>方法实现来看，同一个类型的网络共享一般会命中同一个 cache，因此，一般来说同一个类型的网络分享在关闭又重新开启后，使用的依然是之前计算好的随机子网。</p>
<h3 id="网络分享内的设备为什么无法互通"><a href="#网络分享内的设备为什么无法互通" class="headerlink" title="网络分享内的设备为什么无法互通"></a>网络分享内的设备为什么无法互通</h3><p>阻碍来自 iptables 的转发规则，网络共享的转发规则会专门存放在 tetherctrl_FORWARD 表中（这个表被FORWARD表进一步引用），它的默认规则直接 DROP 掉了局域网内的流量，这直接导致通过网络共享功能连接到 Android 系统的各个设备，相互之间无法成功通信。</p>
<p>我们可以通过以下命令来查看 iptables 规则：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables <span class="operator">-</span>nvL</span><br></pre></td></tr></table></figure>

<p>如果拥有 su 权限，我们可以使用下述命令来删除 tetherctrl_FORWARD 表中的规则：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables <span class="operator">-</span>D tetherctrl_FORWARD <span class="operator">-</span>j <span class="keyword">DROP</span></span><br></pre></td></tr></table></figure>

<p>但是这是一种治标不治本的方式，每次网络变动（比如插拔网线）， tetherctrl_FORWARD 表会被重置。因此我们必须找到相关的代码来修改其行为。</p>
<p>system&#x2F;netd&#x2F;server&#x2F;TetherController.cpp 中包含了与以太网网络共享相关的 iptables 修改逻辑，我们这里指出其中两个关键的方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// system/netd/server/TetherController.cpp</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">TetherController::setDefaults</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::string v4Cmd = <span class="built_in">StringPrintf</span>(</span><br><span class="line">        <span class="string">&quot;*filter\n&quot;</span></span><br><span class="line">        <span class="string">&quot;:%s -\n&quot;</span></span><br><span class="line">        <span class="string">&quot;-A %s -j DROP\n&quot;</span></span><br><span class="line">        <span class="string">&quot;COMMIT\n&quot;</span></span><br><span class="line">        <span class="string">&quot;*nat\n&quot;</span></span><br><span class="line">        <span class="string">&quot;:%s -\n&quot;</span></span><br><span class="line">        <span class="string">&quot;COMMIT\n&quot;</span>, LOCAL_FORWARD, LOCAL_FORWARD, LOCAL_NAT_POSTROUTING);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">iptablesRestoreFunction</span>(V4, v4Cmd, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据实际效果而言，<code>setDefaults()</code>方法中填写的规则将会在 WAN 口尚未接入网线但开启了网络共享功能时生效。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">TetherController::setForwardRules</span><span class="params">(<span class="type">bool</span> add, <span class="type">const</span> <span class="type">char</span> *intIface, <span class="type">const</span> <span class="type">char</span> *extIface)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (add) &#123;</span><br><span class="line">        v4.<span class="built_in">push_back</span>(<span class="built_in">StringPrintf</span>(<span class="string">&quot;-D %s -j DROP&quot;</span>, LOCAL_FORWARD));</span><br><span class="line">        v4.<span class="built_in">push_back</span>(<span class="built_in">StringPrintf</span>(<span class="string">&quot;-A %s -j DROP&quot;</span>, LOCAL_FORWARD));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>setForwardRules()</code>方法将会在开启了网络共享功能后， WAN 口接入网线时生效。我们可以看到实现重新添加了<code>DROP</code>规则。</p>
<p>修改 iptables 规则需要小心，一旦上述规则有任何的执行错误，网络共享功能就会被停止。比如说，我们强行在命令行中影响了 iptables 规则，就有可能导致网络共享功能在网线接入或移除时被停止。</p>
<p>我们举一个例子，比如我们手动删除了 DROP 规则，根据上述代码，我们知道，网线接入时<code>TetherController</code>也会尝试删除这个规则，由于我们提前删除了，所以上述代码的第 4 行规则在执行时会出错，这个错误就会导致网络共享功能被停止。总之，<strong>网线接入&#x2F;移除时网络共享功能莫名停止，多半是 iptables 规则不对</strong>。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>根据上面的代码调研，我们发现， SDK 在多处实现中都假设以太网网络共享只会分享一个接口，原生系统无法达到获得两个类似于路由器上的 LAN 口的效果，我们必须加以改造。</p>
<p>改造的思路大致有两种：</p>
<ul>
<li>创建一个以太网网桥，并将 eth1 和 eth2 连接到网桥上，网络共享则统一使用这个网桥。</li>
<li>修改 SDK 实现，让 eth1 和 eth2 同时开启<code>IpServer</code>，每个接口将分配到不同的子网上。</li>
</ul>
<h3 id="网桥"><a href="#网桥" class="headerlink" title="网桥"></a>网桥</h3><p>我们这里省略如何编译 Android 系统上可用的网桥控制命令 brctl ，重点关注如何利用它创建网桥。我们假设 brctl 将安装到 &#x2F;system&#x2F;bin 下。首先，我们在 &#x2F;system&#x2F;bin&#x2F; 下编写一个脚本 init.brctl.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">/system/bin/brctl addbr br0</span><br><span class="line">/system/bin/brctl addif br0 eth2</span><br><span class="line">/system/bin/brctl addif br0 eth1</span><br><span class="line">/system/bin/brctl stp br0 off</span><br><span class="line">ifconfig br0 up</span><br><span class="line">ifconfig eth1 up</span><br><span class="line">ifconfig eth2 up</span><br></pre></td></tr></table></figure>

<p>然后，我们使用 initrc 机制让这个脚本在开机时得以执行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">service brctl_init <span class="operator">/</span><span class="keyword">system</span><span class="operator">/</span>bin<span class="operator">/</span>init.brctl.sh</span><br><span class="line">    <span class="keyword">user</span> root</span><br><span class="line">    <span class="keyword">group</span> root <span class="keyword">system</span></span><br><span class="line">    disabled</span><br><span class="line">    oneshot</span><br><span class="line"></span><br><span class="line"><span class="keyword">on</span> early<span class="operator">-</span>init</span><br><span class="line">    <span class="keyword">start</span> brctl_init</span><br></pre></td></tr></table></figure>

<p>完成这一步后，我们就可以在开机后得到一个新的接口<code>br0</code>，它是我们虚拟出来的以太网接口。接下来，我们需要稍微修改 framework 代码，使得这个接口可以被识别为以太网接口，并保证它一定被选择作为以太网共享接口。</p>
<p>首先，我们修改 xml 资源文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// packages/modules/Connectivity/service/ServiceConnectivityResources/res/values/config.xml</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">string</span> <span class="attr">translatable</span>=<span class="string">&quot;false&quot;</span> <span class="attr">name</span>=<span class="string">&quot;config_ethernet_iface_regex&quot;</span>&gt;</span>eth\\d|br\\d<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后，我们修改<code>EthernetTracker</code>，让它固定选中 br0 接口用来以太网共享。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/modules/Connectivity/service-t/src/com/android/server/ethernet/EthernetTracker.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">maybeTrackInterface</span><span class="params">(String iface)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// Do not use an interface for tethering if it has configured NetworkCapabilities.</span></span><br><span class="line">    <span class="keyword">if</span> (mTetheringInterface == <span class="literal">null</span> &amp;&amp; <span class="string">&quot;br0&quot;</span>.equals(iface)) &#123;</span><br><span class="line">        mTetheringInterface = iface;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了让 Settings 也能够把网桥识别为以太网共享，从而可以正常通过开关开启和关闭共享，需要修改<code>TetherSettings</code>内的正则表达式，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/apps/Settings/src/com/android/settings/network/tether/TetherSettings.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TetherSettings</span> <span class="keyword">extends</span> <span class="title class_">RestrictedSettingsFragment</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">DataSaverBackend</span>.Listener &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String mEthernetRegex;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle icicle)</span> &#123;</span><br><span class="line">        <span class="comment">//mEthernetRegex = &quot;eth\\d&quot;;</span></span><br><span class="line">        mEthernetRegex = <span class="string">&quot;eth\\d|br\\d&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="同时开启两个网口的共享"><a href="#同时开启两个网口的共享" class="headerlink" title="同时开启两个网口的共享"></a>同时开启两个网口的共享</h3><p>与第一种思路相比，这个思路的实现相对来说复杂一些，但涉及到的文件很少，只需要修改<code>Tethering</code>和<code>EthernetTracker</code>即可。</p>
<p>对于<code>Tethering</code>的修改集中在将变量<code>mConfiguredEthernetIface</code>替换为集合<code>mConfiguredEthernetIfaceSet</code>，并让<code>Tethering</code>开启两个<code>IpServer</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/modules/Connectivity/Tethering/src/com/android/networkstack/tethering/Tethering.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Set&lt;String&gt; mConfiguredEthernetIfaceSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">stopEthernetTethering</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// old</span></span><br><span class="line">    <span class="comment">//if (mConfiguredEthernetIface != null) &#123;</span></span><br><span class="line">    <span class="comment">//    ensureIpServerStopped(mConfiguredEthernetIface);</span></span><br><span class="line">    <span class="comment">//    mConfiguredEthernetIface = null;</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line">    <span class="comment">// new</span></span><br><span class="line">    <span class="keyword">for</span> (String iface: mConfiguredEthernetIfaceSet) &#123;</span><br><span class="line">        ensureIpServerStopped(iface);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// end</span></span><br><span class="line">    mConfiguredEthernetIfaceSet.clear();</span><br><span class="line">    <span class="keyword">if</span> (mEthernetCallback != <span class="literal">null</span>) &#123;</span><br><span class="line">        mEthernetIfaceRequest.release();</span><br><span class="line">        mEthernetCallback = <span class="literal">null</span>;</span><br><span class="line">        mEthernetIfaceRequest = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">EthernetCallback</span> <span class="keyword">implements</span> <span class="title class_">EthernetManager</span>.TetheredInterfaceCallback &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAvailable</span><span class="params">(String iface)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span> != mEthernetCallback) &#123;</span><br><span class="line">            <span class="comment">// Ethernet callback arrived after Ethernet tethering stopped. Ignore.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        enableIpServing(TETHERING_ETHERNET, iface, getRequestedState(TETHERING_ETHERNET));</span><br><span class="line">        <span class="comment">// old</span></span><br><span class="line">        <span class="comment">//mConfiguredEthernetIface = iface;</span></span><br><span class="line">        <span class="comment">// new</span></span><br><span class="line">        mConfiguredEthernetIfaceSet.add(iface);</span><br><span class="line">        <span class="comment">// end</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对<code>EthernetTracker</code>的修改会比较多，但思路仍然是用集合代替单一的接口变量。我们声明一个新的内部类用于同时保存接口名、状态和可用性，并打算用 HashMap 来平替之前的变量。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/modules/Connectivity/service-t/src/com/android/server/ethernet/EthernetTracker.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, TetheringInterfaceState&gt; mTetheringInterfaceStates = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">TetheringInterfaceState</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> String mTetheringInterface;</span><br><span class="line">    <span class="type">int</span> <span class="variable">mTetheringInterfaceMode</span> <span class="operator">=</span> INTERFACE_MODE_CLIENT;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">mTetheredInterfaceWasAvailable</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TetheringInterfaceState</span><span class="params">(String tetheringInterface)</span> &#123;</span><br><span class="line">        mTetheringInterface = tetheringInterface;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来就是非常琐碎的变量平替修改，我们这里仅记录 diff</p>
<figure class="highlight diff"><figcaption><span>patch</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/packages/modules/Connectivity/service-t/src/com/android/server/ethernet/EthernetTracker.java b/packages/modules/Connectivity/service-t/src/com/android/server/ethernet/EthernetTracker.java</span></span><br><span class="line"><span class="comment">index 9707adf7248..dfe66d98f98 100644</span></span><br><span class="line"><span class="comment">--- a/packages/modules/Connectivity/service-t/src/com/android/server/ethernet/EthernetTracker.java</span></span><br><span class="line"><span class="comment">+++ b/packages/modules/Connectivity/service-t/src/com/android/server/ethernet/EthernetTracker.java</span></span><br><span class="line"><span class="meta">@@ -61,8 +61,10 @@</span> import com.android.server.connectivity.ConnectivityResources;</span><br><span class="line"> import java.io.FileDescriptor;</span><br><span class="line"> import java.net.InetAddress;</span><br><span class="line"> import java.util.ArrayList;</span><br><span class="line"><span class="addition">+import java.util.HashMap;</span></span><br><span class="line"> import java.util.Iterator;</span><br><span class="line"> import java.util.List;</span><br><span class="line"><span class="addition">+import java.util.Map;</span></span><br><span class="line"> import java.util.Objects;</span><br><span class="line"> import java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@@ -134,6 +136,8 @@</span> public class EthernetTracker &#123;</span><br><span class="line">     // Tracks whether clients were notified that the tethered interface is available</span><br><span class="line">     private boolean mTetheredInterfaceWasAvailable = false;</span><br><span class="line"> </span><br><span class="line"><span class="addition">+    private final Map&lt;String, TetheringInterfaceState&gt; mTetheringInterfaceStates = new HashMap&lt;&gt;();</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line">     private int mEthernetState = ETHERNET_STATE_ENABLED;</span><br><span class="line"> </span><br><span class="line">     private class TetheredInterfaceRequestList extends</span><br><span class="line"><span class="meta">@@ -165,7 +169,8 @@</span> public class EthernetTracker &#123;</span><br><span class="line">         &#125;</span><br><span class="line"> </span><br><span class="line">         private void onNewLink(String ifname, boolean linkUp) &#123;</span><br><span class="line"><span class="deletion">-            if (!mFactory.hasInterface(ifname) &amp;&amp; !ifname.equals(mTetheringInterface)) &#123;</span></span><br><span class="line"><span class="addition">+            //if (!mFactory.hasInterface(ifname) &amp;&amp; !ifname.equals(mTetheringInterface)) &#123;</span></span><br><span class="line"><span class="addition">+            if (!mFactory.hasInterface(ifname) &amp;&amp; !mTetheringInterfaceStates.containsKey(ifname)) &#123;</span></span><br><span class="line">                 Log.i(TAG, &quot;onInterfaceAdded, iface: &quot; + ifname);</span><br><span class="line">                 maybeTrackInterface(ifname);</span><br><span class="line">             &#125;</span><br><span class="line"><span class="meta">@@ -447,8 +452,14 @@</span> public class EthernetTracker &#123;</span><br><span class="line">             for (String iface : getClientModeInterfaces(canUseRestrictedNetworks)) &#123;</span><br><span class="line">                 unicastInterfaceStateChange(listener, iface);</span><br><span class="line">             &#125;</span><br><span class="line"><span class="deletion">-            if (mTetheringInterfaceMode == INTERFACE_MODE_SERVER) &#123;</span></span><br><span class="line"><span class="deletion">-                unicastInterfaceStateChange(listener, mTetheringInterface);</span></span><br><span class="line"><span class="addition">+            //if (mTetheringInterfaceMode == INTERFACE_MODE_SERVER) &#123;</span></span><br><span class="line"><span class="addition">+            //    unicastInterfaceStateChange(listener, mTetheringInterface);</span></span><br><span class="line"><span class="addition">+            //&#125;</span></span><br><span class="line"><span class="addition">+            for (TetheringInterfaceState state: mTetheringInterfaceStates.values()) &#123;</span></span><br><span class="line"><span class="addition">+                if (state.mTetheringInterfaceMode == INTERFACE_MODE_SERVER) &#123;</span></span><br><span class="line"><span class="addition">+                    unicastInterfaceStateChange(listener, state.mTetheringInterface);</span></span><br><span class="line"><span class="addition">+                    return;</span></span><br><span class="line"><span class="addition">+                &#125;</span></span><br><span class="line">             &#125;</span><br><span class="line"> </span><br><span class="line">             unicastEthernetStateChange(listener, mEthernetState);</span><br><span class="line"><span class="meta">@@ -495,11 +506,19 @@</span> public class EthernetTracker &#123;</span><br><span class="line">                 // Remote process has already died</span><br><span class="line">                 return;</span><br><span class="line">             &#125;</span><br><span class="line"><span class="deletion">-            if (mTetheringInterfaceMode == INTERFACE_MODE_SERVER) &#123;</span></span><br><span class="line"><span class="deletion">-                if (mTetheredInterfaceWasAvailable) &#123;</span></span><br><span class="line"><span class="deletion">-                    notifyTetheredInterfaceAvailable(callback, mTetheringInterface);</span></span><br><span class="line"><span class="addition">+            //if (mTetheringInterfaceMode == INTERFACE_MODE_SERVER) &#123;</span></span><br><span class="line"><span class="addition">+            //    if (mTetheredInterfaceWasAvailable) &#123;</span></span><br><span class="line"><span class="addition">+            //        notifyTetheredInterfaceAvailable(callback, mTetheringInterface);</span></span><br><span class="line"><span class="addition">+            //    &#125;</span></span><br><span class="line"><span class="addition">+            //    return;</span></span><br><span class="line"><span class="addition">+            //&#125;</span></span><br><span class="line"><span class="addition">+            for (TetheringInterfaceState state: mTetheringInterfaceStates.values()) &#123;</span></span><br><span class="line"><span class="addition">+                if (state.mTetheringInterfaceMode == INTERFACE_MODE_SERVER) &#123;</span></span><br><span class="line"><span class="addition">+                    if (state.mTetheredInterfaceWasAvailable) &#123;</span></span><br><span class="line"><span class="addition">+                        notifyTetheredInterfaceAvailable(callback, state.mTetheringInterface);</span></span><br><span class="line"><span class="addition">+                    &#125;</span></span><br><span class="line"><span class="addition">+                    return;</span></span><br><span class="line">                 &#125;</span><br><span class="line"><span class="deletion">-                return;</span></span><br><span class="line">             &#125;</span><br><span class="line"> </span><br><span class="line">             setTetheringInterfaceMode(INTERFACE_MODE_SERVER);</span><br><span class="line"><span class="meta">@@ -531,19 +550,39 @@</span> public class EthernetTracker &#123;</span><br><span class="line"> </span><br><span class="line">     private void maybeUntetherInterface() &#123;</span><br><span class="line">         if (mTetheredInterfaceRequests.getRegisteredCallbackCount() &gt; 0) return;</span><br><span class="line"><span class="deletion">-        if (mTetheringInterfaceMode == INTERFACE_MODE_CLIENT) return;</span></span><br><span class="line"><span class="deletion">-        setTetheringInterfaceMode(INTERFACE_MODE_CLIENT);</span></span><br><span class="line"><span class="addition">+        //if (mTetheringInterfaceMode == INTERFACE_MODE_CLIENT) return;</span></span><br><span class="line"><span class="addition">+        //setTetheringInterfaceMode(INTERFACE_MODE_CLIENT);</span></span><br><span class="line"><span class="addition">+        for (TetheringInterfaceState state: mTetheringInterfaceStates.values()) &#123;</span></span><br><span class="line"><span class="addition">+            if (state.mTetheringInterfaceMode != INTERFACE_MODE_CLIENT) &#123;</span></span><br><span class="line"><span class="addition">+                setTetheringInterfaceMode(state, INTERFACE_MODE_CLIENT);</span></span><br><span class="line"><span class="addition">+            &#125;</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line">     private void setTetheringInterfaceMode(int mode) &#123;</span><br><span class="line">         Log.d(TAG, &quot;Setting tethering interface mode to &quot; + mode);</span><br><span class="line"><span class="deletion">-        mTetheringInterfaceMode = mode;</span></span><br><span class="line"><span class="deletion">-        if (mTetheringInterface != null) &#123;</span></span><br><span class="line"><span class="deletion">-            removeInterface(mTetheringInterface);</span></span><br><span class="line"><span class="deletion">-            addInterface(mTetheringInterface);</span></span><br><span class="line"><span class="addition">+        //mTetheringInterfaceMode = mode;</span></span><br><span class="line"><span class="addition">+        //if (mTetheringInterface != null) &#123;</span></span><br><span class="line"><span class="addition">+        //    removeInterface(mTetheringInterface);</span></span><br><span class="line"><span class="addition">+        //    addInterface(mTetheringInterface);</span></span><br><span class="line"><span class="addition">+        //    // when this broadcast is sent, any calls to notifyTetheredInterfaceAvailable or</span></span><br><span class="line"><span class="addition">+        //    // notifyTetheredInterfaceUnavailable have already happened</span></span><br><span class="line"><span class="addition">+        //    broadcastInterfaceStateChange(mTetheringInterface);</span></span><br><span class="line"><span class="addition">+        //&#125;</span></span><br><span class="line"><span class="addition">+        for (TetheringInterfaceState state: mTetheringInterfaceStates.values()) &#123;</span></span><br><span class="line"><span class="addition">+            setTetheringInterfaceMode(state, mode);</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+    private void setTetheringInterfaceMode(TetheringInterfaceState state, int mode) &#123;</span></span><br><span class="line"><span class="addition">+        Log.d(TAG, &quot;Setting tethering interface mode to &quot; + mode);</span></span><br><span class="line"><span class="addition">+        state.mTetheringInterfaceMode = mode;</span></span><br><span class="line"><span class="addition">+        if (state.mTetheringInterface != null) &#123;</span></span><br><span class="line"><span class="addition">+            removeInterface(state.mTetheringInterface);</span></span><br><span class="line"><span class="addition">+            addInterface(state.mTetheringInterface);</span></span><br><span class="line">             // when this broadcast is sent, any calls to notifyTetheredInterfaceAvailable or</span><br><span class="line">             // notifyTetheredInterfaceUnavailable have already happened</span><br><span class="line"><span class="deletion">-            broadcastInterfaceStateChange(mTetheringInterface);</span></span><br><span class="line"><span class="addition">+            broadcastInterfaceStateChange(state.mTetheringInterface);</span></span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@@ -572,8 +611,11 @@</span> public class EthernetTracker &#123;</span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line">     private int getInterfaceMode(final String iface) &#123;</span><br><span class="line"><span class="deletion">-        if (iface.equals(mTetheringInterface)) &#123;</span></span><br><span class="line"><span class="deletion">-            return mTetheringInterfaceMode;</span></span><br><span class="line"><span class="addition">+        //if (iface.equals(mTetheringInterface)) &#123;</span></span><br><span class="line"><span class="addition">+        //    return mTetheringInterfaceMode;</span></span><br><span class="line"><span class="addition">+        //&#125;</span></span><br><span class="line"><span class="addition">+        if (mTetheringInterfaceStates.containsKey(iface)) &#123;</span></span><br><span class="line"><span class="addition">+            return mTetheringInterfaceStates.get(iface).mTetheringInterfaceMode;</span></span><br><span class="line">         &#125;</span><br><span class="line">         return INTERFACE_MODE_CLIENT;</span><br><span class="line">     &#125;</span><br><span class="line"><span class="meta">@@ -585,9 +627,10 @@</span> public class EthernetTracker &#123;</span><br><span class="line"> </span><br><span class="line">     private void stopTrackingInterface(String iface) &#123;</span><br><span class="line">         removeInterface(iface);</span><br><span class="line"><span class="deletion">-        if (iface.equals(mTetheringInterface)) &#123;</span></span><br><span class="line"><span class="deletion">-            mTetheringInterface = null;</span></span><br><span class="line"><span class="deletion">-        &#125;</span></span><br><span class="line"><span class="addition">+        //if (iface.equals(mTetheringInterface)) &#123;</span></span><br><span class="line"><span class="addition">+        //    mTetheringInterface = null;</span></span><br><span class="line"><span class="addition">+        //&#125;</span></span><br><span class="line"><span class="addition">+        mTetheringInterfaceStates.remove(iface);</span></span><br><span class="line">         broadcastInterfaceStateChange(iface);</span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@@ -669,7 +712,9 @@</span> public class EthernetTracker &#123;</span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line">     private void maybeUpdateServerModeInterfaceState(String iface, boolean available) &#123;</span><br><span class="line"><span class="deletion">-        if (available == mTetheredInterfaceWasAvailable || !iface.equals(mTetheringInterface)) &#123;</span></span><br><span class="line"><span class="addition">+        //if (available == mTetheredInterfaceWasAvailable || !iface.equals(mTetheringInterface)) &#123;</span></span><br><span class="line"><span class="addition">+        TetheringInterfaceState state = mTetheringInterfaceStates.get(iface);</span></span><br><span class="line"><span class="addition">+        if (state == null || state.mTetheredInterfaceWasAvailable == available) &#123;</span></span><br><span class="line">             return;</span><br><span class="line">         &#125;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@@ -686,7 +731,8 @@</span> public class EthernetTracker &#123;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         mTetheredInterfaceRequests.finishBroadcast();</span><br><span class="line"><span class="deletion">-        mTetheredInterfaceWasAvailable = available;</span></span><br><span class="line"><span class="addition">+        //mTetheredInterfaceWasAvailable = available;</span></span><br><span class="line"><span class="addition">+        state.mTetheredInterfaceWasAvailable = available;</span></span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line">     private void maybeTrackInterface(String iface) &#123;</span><br><span class="line"><span class="meta">@@ -696,7 +742,8 @@</span> public class EthernetTracker &#123;</span><br><span class="line"> </span><br><span class="line">         // If we don&#x27;t already track this interface, and if this interface matches</span><br><span class="line">         // our regex, start tracking it.</span><br><span class="line"><span class="deletion">-        if (mFactory.hasInterface(iface) || iface.equals(mTetheringInterface)) &#123;</span></span><br><span class="line"><span class="addition">+        //if (mFactory.hasInterface(iface) || iface.equals(mTetheringInterface)) &#123;</span></span><br><span class="line"><span class="addition">+        if (mFactory.hasInterface(iface) || mTetheringInterfaceStates.containsKey(iface)) &#123;</span></span><br><span class="line">             if (DBG) Log.w(TAG, &quot;Ignoring already-tracked interface &quot; + iface);</span><br><span class="line">             return;</span><br><span class="line">         &#125;</span><br><span class="line"><span class="meta">@@ -704,8 +751,10 @@</span> public class EthernetTracker &#123;</span><br><span class="line"> </span><br><span class="line">         // Do not use an interface for tethering if it has configured NetworkCapabilities.</span><br><span class="line"><span class="addition">+         //if (mTetheringInterface == null &amp;&amp; !mNetworkCapabilities.containsKey(iface)) &#123;</span></span><br><span class="line"><span class="addition">+        //    mTetheringInterface = iface;</span></span><br><span class="line"><span class="addition">+        //&#125;</span></span><br><span class="line"><span class="addition">+        if (&quot;eth1&quot;.equals(iface) || &quot;eth2&quot;.equals(iface)) &#123;</span></span><br><span class="line"><span class="addition">+            mTetheringInterfaceStates.put(iface, new TetheringInterfaceState(iface));</span></span><br><span class="line">         &#125;</span><br><span class="line"> </span><br><span class="line">         addInterface(iface);</span><br><span class="line"><span class="meta">@@ -998,8 +1047,12 @@</span> public class EthernetTracker &#123;</span><br><span class="line">             pw.println(&quot;Ethernet State: &quot;</span><br><span class="line">                     + (mEthernetState == ETHERNET_STATE_ENABLED ? &quot;enabled&quot; : &quot;disabled&quot;));</span><br><span class="line">             pw.println(&quot;Ethernet interface name filter: &quot; + mIfaceMatch);</span><br><span class="line"><span class="deletion">-            pw.println(&quot;Interface used for tethering: &quot; + mTetheringInterface);</span></span><br><span class="line"><span class="deletion">-            pw.println(&quot;Tethering interface mode: &quot; + mTetheringInterfaceMode);</span></span><br><span class="line"><span class="addition">+            //pw.println(&quot;Interface used for tethering: &quot; + mTetheringInterface);</span></span><br><span class="line"><span class="addition">+            //pw.println(&quot;Tethering interface mode: &quot; + mTetheringInterfaceMode);</span></span><br><span class="line"><span class="addition">+            for (TetheringInterfaceState state: mTetheringInterfaceStates.values()) &#123;</span></span><br><span class="line"><span class="addition">+                pw.println(&quot;\tTethering interface: &quot; + state.mTetheringInterface);</span></span><br><span class="line"><span class="addition">+                pw.println(&quot;\tTethering mode: &quot; + state.mTetheringInterfaceMode);</span></span><br><span class="line"><span class="addition">+            &#125;</span></span><br><span class="line">             pw.println(&quot;Tethered interface requests: &quot;</span><br><span class="line">                     + mTetheredInterfaceRequests.getRegisteredCallbackCount());</span><br><span class="line">             pw.println(&quot;Listeners: &quot; + mListeners.getRegisteredCallbackCount());</span><br><span class="line"><span class="meta">@@ -1038,4 +1091,15 @@</span> public class EthernetTracker &#123;</span><br><span class="line">             mTransport = tokens.length &gt; 3 ? tokens[3] : null;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+    private static class TetheringInterfaceState &#123;</span></span><br><span class="line"><span class="addition">+        final String mTetheringInterface;</span></span><br><span class="line"><span class="addition">+        int mTetheringInterfaceMode = INTERFACE_MODE_CLIENT;</span></span><br><span class="line"><span class="addition">+        boolean mTetheredInterfaceWasAvailable = false;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+        public TetheringInterfaceState(String tetheringInterface) &#123;</span></span><br><span class="line"><span class="addition">+            mTetheringInterface = tetheringInterface;</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="开机后自动开启网络共享"><a href="#开机后自动开启网络共享" class="headerlink" title="开机后自动开启网络共享"></a>开机后自动开启网络共享</h3><p>重启后，Settings 并不会保存网络共享的状态，因此我们需要保证下述代码在开机后会执行一遍。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ConnectivityManager</span> <span class="variable">connectivityManager</span> <span class="operator">=</span> getSystemService(ConnectivityManager.class);</span><br><span class="line"></span><br><span class="line">connectivityManager.startTethering(</span><br><span class="line">    TETHERING_ETHERNET,</span><br><span class="line">    <span class="literal">true</span>,</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ConnectivityManager</span>.OnStartTetheringCallback() &#123;&#125;,</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Handler</span>(Looper.getMainLooper())</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h3><p>对于默认规则，我们强行让其变为<code>ACCEPT</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// system/netd/server/TetherController.cpp</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">TetherController::setDefaults</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::string v4Cmd = <span class="built_in">StringPrintf</span>(</span><br><span class="line">        <span class="string">&quot;*filter\n&quot;</span></span><br><span class="line">        <span class="string">&quot;:%s -\n&quot;</span></span><br><span class="line">        <span class="string">&quot;-A %s -j ACCEPT\n&quot;</span></span><br><span class="line">        <span class="string">&quot;COMMIT\n&quot;</span></span><br><span class="line">        <span class="string">&quot;*nat\n&quot;</span></span><br><span class="line">        <span class="string">&quot;:%s -\n&quot;</span></span><br><span class="line">        <span class="string">&quot;COMMIT\n&quot;</span>, LOCAL_FORWARD, LOCAL_FORWARD, LOCAL_NAT_POSTROUTING);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> res = <span class="built_in">iptablesRestoreFunction</span>(V4, v4Cmd, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，我们不允许其重置 DROP 规则，包括移除和添加。（在没有 DROP 规则的情况下尝试移除也会报错）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// system/netd/server/TetherController.cpp</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">TetherController::setForwardRules</span><span class="params">(<span class="type">bool</span> add, <span class="type">const</span> <span class="type">char</span> *intIface, <span class="type">const</span> <span class="type">char</span> *extIface)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (add) &#123;</span><br><span class="line">        <span class="comment">//v4.push_back(StringPrintf(&quot;-D %s -j DROP&quot;, LOCAL_FORWARD));</span></span><br><span class="line">        <span class="comment">//v4.push_back(StringPrintf(&quot;-A %s -j DROP&quot;, LOCAL_FORWARD));</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="固定共享子网地址"><a href="#固定共享子网地址" class="headerlink" title="固定共享子网地址"></a>固定共享子网地址</h3><p>修改<code>PrivateAddressCoordinator</code>这个类即可。我们可以通过<code>IpServer</code>获得当前共享的网络接口的名称，根据这个名称我们提前拦截随机分配的逻辑，下面展示双网口共享的修改方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/modules/Connectivity/Tethering/src/com/android/networkstack/tethering/PrivateAddressCoordinator.java</span></span><br><span class="line"><span class="keyword">public</span> LinkAddress <span class="title function_">requestDownstreamAddress</span><span class="params">(<span class="keyword">final</span> IpServer ipServer, <span class="keyword">final</span> <span class="type">int</span> scope,</span></span><br><span class="line"><span class="params">                                            <span class="type">boolean</span> useLastAddress)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mConfig.shouldEnableWifiP2pDedicatedIp()</span><br><span class="line">        &amp;&amp; ipServer.interfaceType() == TETHERING_WIFI_P2P) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LinkAddress</span>(LEGACY_WIFI_P2P_IFACE_ADDRESS);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">String</span> <span class="variable">iface</span> <span class="operator">=</span> ipServer.interfaceName();</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;eth1&quot;</span>.equals(iface)) &#123;</span><br><span class="line">        mDownstreams.add(ipServer);</span><br><span class="line">        <span class="keyword">return</span> getLinkAddress(<span class="keyword">new</span> <span class="title class_">IpPrefix</span>(<span class="string">&quot;192.168.51.0/24&quot;</span>), <span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;eth2&quot;</span>.equals(iface)) &#123;</span><br><span class="line">        mDownstreams.add(ipServer);</span><br><span class="line">        <span class="keyword">return</span> getLinkAddress(<span class="keyword">new</span> <span class="title class_">IpPrefix</span>(<span class="string">&quot;192.168.52.0/24&quot;</span>), <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>单网桥的修改方式类似</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/modules/Connectivity/Tethering/src/com/android/networkstack/tethering/PrivateAddressCoordinator.java</span></span><br><span class="line"><span class="keyword">public</span> LinkAddress <span class="title function_">requestDownstreamAddress</span><span class="params">(<span class="keyword">final</span> IpServer ipServer, <span class="keyword">final</span> <span class="type">int</span> scope,</span></span><br><span class="line"><span class="params">                                            <span class="type">boolean</span> useLastAddress)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mConfig.shouldEnableWifiP2pDedicatedIp()</span><br><span class="line">        &amp;&amp; ipServer.interfaceType() == TETHERING_WIFI_P2P) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LinkAddress</span>(LEGACY_WIFI_P2P_IFACE_ADDRESS);</span><br><span class="line">    &#125;     </span><br><span class="line">    <span class="type">String</span> <span class="variable">iface</span> <span class="operator">=</span> ipServer.interfaceName();</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;br0&quot;</span>.equals(iface)) &#123;</span><br><span class="line">        mDownstreams.add(ipServer);</span><br><span class="line">        <span class="keyword">return</span> getLinkAddress(<span class="keyword">new</span> <span class="title class_">IpPrefix</span>(<span class="string">&quot;192.168.51.0/24&quot;</span>), <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>  参考资料：</p>
<p>  <a href="https://link.juejin.cn/?target=https://blog.csdn.net/wenzhi20102321/article/details/141533109">Android14 以太网共享功能</a></p>
<p>  <a href="https://link.juejin.cn/?target=https://www.liyanfeng.com/post/139.html">Android下打通RNDIS(USB网络共享)与WIFI热点</a></p>
</blockquote>
<h1 id="网络相关问题"><a href="#网络相关问题" class="headerlink" title="网络相关问题"></a>网络相关问题</h1><h2 id="java-lang-RuntimeException-Parcel-unable-to-marshal-value"><a href="#java-lang-RuntimeException-Parcel-unable-to-marshal-value" class="headerlink" title="java.lang.RuntimeException: Parcel: unable to marshal value"></a>java.lang.RuntimeException: Parcel: unable to marshal value</h2><p>接口回调传递参数丢失问题</p>
<p>原因：</p>
<ol>
<li>在继承Parcel类中，需要读或写其他自定义类数据，这些自定义类数据需要实现Serializable序列化接口</li>
<li>在继承Serializabel类中，需要读或写其他自定义类，这些自定义类数据含有的对象类没有继承Serializable接口</li>
</ol>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/%E5%AE%89%E5%8D%93%E7%9F%A5%E8%AF%86%E7%82%B9/" rel="tag"># 安卓知识点</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/posts/1445596874/" rel="next" title="安卓-通信">
                <i class="fa fa-chevron-left"></i> 安卓-通信
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/posts/3424871304/" rel="prev" title="安卓-线程">
                安卓-线程 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">439</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">47</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="mailto:shenbh@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://blog.csdn.net/ptwenzi?spm=1010.2135.3001.5113" target="_blank" title="CSDN">
                      
                        <i class="fa fa-fw fa-clone"></i>CSDN</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C"><span class="nav-text">网络</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Regrofit"><span class="nav-text">Regrofit</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#OkHttpClickent%E9%85%8D%E7%BD%AE%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4"><span class="nav-text">OkHttpClickent配置超时时间</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E8%AE%BE%E7%BD%AE%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4"><span class="nav-text">如何设置超时时间</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Connection-Timeout-%E8%BF%9E%E6%8E%A5%E8%B6%85%E6%97%B6"><span class="nav-text">Connection Timeout-连接超时</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Read-Timeout-%E8%AF%BB%E5%8F%96%E8%B6%85%E6%97%B6"><span class="nav-text">Read Timeout-读取超时</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Write-Timeout-%E5%86%99%E5%85%A5%E8%B6%85%E6%97%B6"><span class="nav-text">Write Timeout-写入超时</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Call-Timeout-%E8%AF%B7%E6%B1%82%E8%B6%85%E6%97%B6"><span class="nav-text">Call Timeout-请求超时</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%A9%E7%94%A8Android%E7%9A%84%E4%BB%A5%E5%A4%AA%E7%BD%91%E5%85%B1%E4%BA%AB%E5%8A%9F%E8%83%BD%E6%A8%A1%E6%8B%9FLAN%E7%BD%91%E5%8F%A3"><span class="nav-text">利用Android的以太网共享功能模拟LAN网口</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-text">代码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Settings-%E8%AE%BE%E7%BD%AE"><span class="nav-text">Settings 设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ConnectivityManager-%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86%E5%99%A8"><span class="nav-text">ConnectivityManager 连接管理器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tethering-%E7%BD%91%E7%BB%9C%E5%85%B1%E4%BA%AB"><span class="nav-text">Tethering 网络共享</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EthernetManager-%E4%BB%A5%E5%A4%AA%E7%BD%91%E7%AE%A1%E7%90%86%E5%99%A8"><span class="nav-text">EthernetManager 以太网管理器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9A%8F%E6%9C%BA%E5%AD%90%E7%BD%91"><span class="nav-text">随机子网</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E5%88%86%E4%BA%AB%E5%86%85%E7%9A%84%E8%AE%BE%E5%A4%87%E4%B8%BA%E4%BB%80%E4%B9%88%E6%97%A0%E6%B3%95%E4%BA%92%E9%80%9A"><span class="nav-text">网络分享内的设备为什么无法互通</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-text">解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BD%91%E6%A1%A5"><span class="nav-text">网桥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8C%E6%97%B6%E5%BC%80%E5%90%AF%E4%B8%A4%E4%B8%AA%E7%BD%91%E5%8F%A3%E7%9A%84%E5%85%B1%E4%BA%AB"><span class="nav-text">同时开启两个网口的共享</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E6%9C%BA%E5%90%8E%E8%87%AA%E5%8A%A8%E5%BC%80%E5%90%AF%E7%BD%91%E7%BB%9C%E5%85%B1%E4%BA%AB"><span class="nav-text">开机后自动开启网络共享</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#iptables"><span class="nav-text">iptables</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%BA%E5%AE%9A%E5%85%B1%E4%BA%AB%E5%AD%90%E7%BD%91%E5%9C%B0%E5%9D%80"><span class="nav-text">固定共享子网地址</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98"><span class="nav-text">网络相关问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#java-lang-RuntimeException-Parcel-unable-to-marshal-value"><span class="nav-text">java.lang.RuntimeException: Parcel: unable to marshal value</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">阿炳</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('-1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  


  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
          if(result)$(this).text('Copied')
          else $(this).text('Copy failed')
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('Copy')
        }, 300)
      }).append(e)
    })
  </script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>