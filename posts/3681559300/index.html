<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="gradle" />










<meta name="description" content="Auc之解放 Gradle创建 GLog 来打印日志，跟踪编译动态创建 ConfigUtils。在 addBuildListener 的 settingsEvaluated 中解放 settings，在projectsEvaluated 中解放 module 的 apply创建 DepConfig 在ConfigUtils 的 projectsEvaluated 中继续解放 module 的 de">
<meta property="og:type" content="article">
<meta property="og:title" content="Auc-3 解放 Gradle">
<meta property="og:url" content="http://shenbh.github.io/posts/3681559300/index.html">
<meta property="og:site_name" content="AB">
<meta property="og:description" content="Auc之解放 Gradle创建 GLog 来打印日志，跟踪编译动态创建 ConfigUtils。在 addBuildListener 的 settingsEvaluated 中解放 settings，在projectsEvaluated 中解放 module 的 apply创建 DepConfig 在ConfigUtils 的 projectsEvaluated 中继续解放 module 的 de">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-01-07T07:00:07.000Z">
<meta property="article:modified_time" content="2022-05-05T06:52:45.540Z">
<meta property="article:author" content="阿炳">
<meta property="article:tag" content="private">
<meta property="article:tag" content="Gradle">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://shenbh.github.io/posts/3681559300/"/>





  <title>Auc-3 解放 Gradle | AB</title><meta name="robots" content="noindex">
  








<meta name="generator" content="Hexo 6.1.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">AB</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Just do IT Now.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://shenbh.github.io/posts/3681559300/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AB">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Auc-3 解放 Gradle</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-01-07T15:00:07+08:00">
                2020-01-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Gradle/" itemprop="url" rel="index">
                    <span itemprop="name">Gradle</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Auc之解放-Gradle"><a href="#Auc之解放-Gradle" class="headerlink" title="Auc之解放 Gradle"></a>Auc之解放 Gradle</h1><p>创建 <code>GLog</code> 来打印日志，跟踪编译动态<br>创建 <code>ConfigUtils</code>。在 <code>addBuildListener</code> 的 <code>settingsEvaluated</code> 中解放 <code>settings</code>，在<code>projectsEvaluated</code> 中解放 <code>module</code> 的 <code>apply</code><br>创建 <code>DepConfig</code> 在<code>ConfigUtils</code> 的 <code>projectsEvaluated</code> 中继续解放 <code>module</code> 的 <code>dependencies</code></p>
<p>最终：把模块放到远程，代码配置远程仓库，减少本地编译时间。</p>
<h2 id="Gradle-的-log"><a href="#Gradle-的-log" class="headerlink" title="Gradle 的 log"></a>Gradle 的 log</h2><p>在 buildSrc 中创建 GLog.groovy</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这是打印gradle的Log的，可以知道每个Gradle加载的顺序。需要在各自需要的地方调用相应的输出日志的代码</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GLog</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="keyword">static</span> debugSwitch = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> d(Object... contents) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!debugSwitch) <span class="keyword">return</span> contents</span><br><span class="line">        <span class="keyword">return</span> l(contents)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> l(Object... contents) &#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder()</span><br><span class="line">        sb.append(LogConst.BORDER_TOP)</span><br><span class="line">        sb.append(borderMsg(processContents(contents)))</span><br><span class="line">        sb.append(LogConst.BORDER_BTM)</span><br><span class="line">        print sb.toString()</span><br><span class="line">        <span class="keyword">return</span> contents</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> borderMsg(String msg) &#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder()</span><br><span class="line">        object2String(msg).split(LogConst.LINE_SEP).each &#123; line -&gt;</span><br><span class="line">            sb.append(LogConst.BORDER_LFT).append(line).append(LogConst.LINE_SEP)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> processContents(<span class="keyword">final</span> Object... contents) &#123;</span><br><span class="line">        String body = LogConst.NULL</span><br><span class="line">        <span class="keyword">if</span> (contents != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (contents.length == <span class="number">1</span>) &#123;</span><br><span class="line">                body = object2String(contents[<span class="number">0</span>])</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                StringBuilder sb = <span class="keyword">new</span> StringBuilder()</span><br><span class="line">                <span class="type">int</span> i = <span class="number">0</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> len = contents.length; i &lt; len; ++i) &#123;</span><br><span class="line">                    Object content = contents[i]</span><br><span class="line">                    sb.append(<span class="string">&quot;args[$i] = &quot;</span>)</span><br><span class="line">                            .append(object2String(content))</span><br><span class="line">                            .append(LogConst.LINE_SEP)</span><br><span class="line">                &#125;</span><br><span class="line">                body = sb.toString()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> body.length() == <span class="number">0</span> ? LogConst.NOTHING : body</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> String object2String(Object object) &#123;</span><br><span class="line">        <span class="keyword">if</span> (object == <span class="literal">null</span>) <span class="keyword">return</span> <span class="string">&quot;null&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (object.getClass().isArray()) <span class="keyword">return</span> LogFormatter.array2String(object);</span><br><span class="line">        <span class="keyword">if</span> (object <span class="keyword">instanceof</span> List) <span class="keyword">return</span> LogFormatter.list2String(object);</span><br><span class="line">        <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Map) <span class="keyword">return</span> LogFormatter.map2String(object);</span><br><span class="line">        <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Throwable) <span class="keyword">return</span> LogFormatter.throwable2String(object);</span><br><span class="line">        <span class="keyword">return</span> object.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LogFormatter</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> array2String(Object object) &#123;</span><br><span class="line">            <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Object[]) &#123;</span><br><span class="line">                <span class="keyword">return</span> Arrays.deepToString((Object[]) object);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> <span class="type">boolean</span>[]) &#123;</span><br><span class="line">                <span class="keyword">return</span> Arrays.toString((<span class="type">boolean</span>[]) object);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> <span class="type">byte</span>[]) &#123;</span><br><span class="line">                <span class="keyword">return</span> Arrays.toString((<span class="type">byte</span>[]) object);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> <span class="type">char</span>[]) &#123;</span><br><span class="line">                <span class="keyword">return</span> Arrays.toString((<span class="type">char</span>[]) object);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> <span class="type">double</span>[]) &#123;</span><br><span class="line">                <span class="keyword">return</span> Arrays.toString((<span class="type">double</span>[]) object);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> <span class="type">float</span>[]) &#123;</span><br><span class="line">                <span class="keyword">return</span> Arrays.toString((<span class="type">float</span>[]) object);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> <span class="type">int</span>[]) &#123;</span><br><span class="line">                <span class="keyword">return</span> Arrays.toString((<span class="type">int</span>[]) object);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> <span class="type">long</span>[]) &#123;</span><br><span class="line">                <span class="keyword">return</span> Arrays.toString((<span class="type">long</span>[]) object);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> <span class="type">short</span>[]) &#123;</span><br><span class="line">                <span class="keyword">return</span> Arrays.toString((<span class="type">short</span>[]) object);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Array has incompatible type: &quot;</span> + object.getClass());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> list2String(List list) &#123;</span><br><span class="line">            StringBuilder sb = <span class="keyword">new</span> StringBuilder()</span><br><span class="line">            sb.append(<span class="string">&quot;[&quot;</span>)</span><br><span class="line">            list.each &#123; v -&gt;</span><br><span class="line">                <span class="keyword">if</span> (v <span class="keyword">instanceof</span> Map || v <span class="keyword">instanceof</span> List) &#123;</span><br><span class="line">                    sb.append(String.format(<span class="string">&quot;$LogConst.LINE_SEP%$&#123;deep++ * 8&#125;s$&#123;object2String(v)&#125;,&quot;</span>, <span class="string">&quot;&quot;</span>, k))</span><br><span class="line">                    deep--</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    sb.append(String.format(<span class="string">&quot;$LogConst.LINE_SEP%$&#123;deep * 8&#125;s$v,&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            sb.deleteCharAt(sb.length() - <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> (deep - <span class="number">1</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                sb.append(<span class="string">&quot;$LogConst.LINE_SEP]&quot;</span>)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                sb.append(String.format(<span class="string">&quot;$LogConst.LINE_SEP%$&#123;(deep - 1) * 8&#125;s]&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sb.toString()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> deep = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> map2String(Map map) &#123;</span><br><span class="line">            StringBuilder sb = <span class="keyword">new</span> StringBuilder()</span><br><span class="line">            sb.append(<span class="string">&quot;[&quot;</span>)</span><br><span class="line">            map.each &#123; k, v -&gt;</span><br><span class="line">                <span class="keyword">if</span> (v <span class="keyword">instanceof</span> Map || v <span class="keyword">instanceof</span> List) &#123;</span><br><span class="line">                    sb.append(String.format(<span class="string">&quot;$LogConst.LINE_SEP%$&#123;deep++ * 8&#125;s%-26s: $&#123;object2String(v)&#125;,&quot;</span>, <span class="string">&quot;&quot;</span>, k))</span><br><span class="line">                    deep--</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    sb.append(String.format(<span class="string">&quot;$LogConst.LINE_SEP%$&#123;deep * 8&#125;s%-26s: $v,&quot;</span>, <span class="string">&quot;&quot;</span>, k))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            sb.deleteCharAt(sb.length() - <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> (deep - <span class="number">1</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                sb.append(<span class="string">&quot;$LogConst.LINE_SEP]&quot;</span>)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                sb.append(String.format(<span class="string">&quot;$LogConst.LINE_SEP%$&#123;(deep - 1) * 8&#125;s]&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sb.toString()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> throwable2String(Throwable throwable) &#123;</span><br><span class="line">            <span class="keyword">final</span> List&lt;Throwable&gt; throwableList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">while</span> (throwable != <span class="literal">null</span> &amp;&amp; !throwableList.contains(throwable)) &#123;</span><br><span class="line">                throwableList.add(throwable);</span><br><span class="line">                throwable = throwable.getCause();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> size = throwableList.size();</span><br><span class="line">            <span class="keyword">final</span> List&lt;String&gt; frames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            List&lt;String&gt; nextTrace = getStackFrameList(throwableList.get(size - <span class="number">1</span>));</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = size; --i &gt;= <span class="number">0</span>;) &#123;</span><br><span class="line">                <span class="keyword">final</span> List&lt;String&gt; trace = nextTrace;</span><br><span class="line">                <span class="keyword">if</span> (i != <span class="number">0</span>) &#123;</span><br><span class="line">                    nextTrace = getStackFrameList(throwableList.get(i - <span class="number">1</span>));</span><br><span class="line">                    removeCommonFrames(trace, nextTrace);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (i == size - <span class="number">1</span>) &#123;</span><br><span class="line">                    frames.add(throwableList.get(i).toString());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    frames.add(<span class="string">&quot; Caused by: &quot;</span> + throwableList.get(i).toString());</span><br><span class="line">                &#125;</span><br><span class="line">                frames.addAll(trace);</span><br><span class="line">            &#125;</span><br><span class="line">            StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> String <span class="attr">element :</span> frames) &#123;</span><br><span class="line">                sb.append(element).append(LogConst.LINE_SEP);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sb.toString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; getStackFrameList(<span class="keyword">final</span> Throwable throwable) &#123;</span><br><span class="line">            <span class="keyword">final</span> StringWriter sw = <span class="keyword">new</span> StringWriter();</span><br><span class="line">            <span class="keyword">final</span> PrintWriter pw = <span class="keyword">new</span> PrintWriter(sw, <span class="literal">true</span>);</span><br><span class="line">            throwable.printStackTrace(pw);</span><br><span class="line">            <span class="keyword">final</span> String stackTrace = sw.toString();</span><br><span class="line">            <span class="keyword">final</span> StringTokenizer frames = <span class="keyword">new</span> StringTokenizer(stackTrace, LogConst.LINE_SEP);</span><br><span class="line">            <span class="keyword">final</span> List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="type">boolean</span> traceStarted = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">while</span> (frames.hasMoreTokens()) &#123;</span><br><span class="line">                <span class="keyword">final</span> String token = frames.nextToken();</span><br><span class="line">                <span class="comment">// Determine if the line starts with &lt;whitespace&gt;at</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> at = token.indexOf(<span class="string">&quot;at&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (at != <span class="number">-1</span> &amp;&amp; token.substring(<span class="number">0</span>, at).trim().isEmpty()) &#123;</span><br><span class="line">                    traceStarted = <span class="literal">true</span>;</span><br><span class="line">                    list.add(token);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (traceStarted) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> list;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">void</span> removeCommonFrames(<span class="keyword">final</span> List&lt;String&gt; causeFrames, <span class="keyword">final</span> List&lt;String&gt; wrapperFrames) &#123;</span><br><span class="line">            <span class="type">int</span> causeFrameIndex = causeFrames.size() - <span class="number">1</span>;</span><br><span class="line">            <span class="type">int</span> wrapperFrameIndex = wrapperFrames.size() - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span> (causeFrameIndex &gt;= <span class="number">0</span> &amp;&amp; wrapperFrameIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// Remove the frame from the cause trace if it is the same</span></span><br><span class="line">                <span class="comment">// as in the wrapper trace</span></span><br><span class="line">                <span class="keyword">final</span> String causeFrame = causeFrames.get(causeFrameIndex);</span><br><span class="line">                <span class="keyword">final</span> String wrapperFrame = wrapperFrames.get(wrapperFrameIndex);</span><br><span class="line">                <span class="keyword">if</span> (causeFrame.equals(wrapperFrame)) &#123;</span><br><span class="line">                    causeFrames.remove(causeFrameIndex);</span><br><span class="line">                &#125;</span><br><span class="line">                causeFrameIndex--;</span><br><span class="line">                wrapperFrameIndex--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LogConst</span> &#123;</span><br><span class="line">        <span class="keyword">static</span> LINE_SEP = System.getProperty(<span class="string">&quot;line.separator&quot;</span>);</span><br><span class="line">        <span class="keyword">static</span> BORDER_TOP = <span class="string">&quot;┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────&quot;</span> + LINE_SEP</span><br><span class="line">        <span class="keyword">static</span> BORDER_LFT = <span class="string">&quot;│ &quot;</span>;</span><br><span class="line">        <span class="keyword">static</span> BORDER_BTM = <span class="string">&quot;└────────────────────────────────────────────────────────────────────────────────────────────────────────────────&quot;</span> + LINE_SEP</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> NOTHING = <span class="string">&quot;log nothing&quot;</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> NULL = <span class="string">&quot;null&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在setting.gradle、build.gradle、buildApp.gradle、buildLib.gradle 的首行分别加入：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GLog.d(<span class="string">&quot;setting.gradle&quot;</span>)</span><br><span class="line">GLog.d(project.toString() + <span class="string">&quot; -&gt; root&quot;</span>)</span><br><span class="line">GLog.d(project.toString() + <span class="string">&quot; -&gt; app&quot;</span>)</span><br><span class="line">GLog.d(project.toString() + <span class="string">&quot; -&gt; lib&quot;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="Gradle-生命周期的-hook"><a href="#Gradle-生命周期的-hook" class="headerlink" title="Gradle 生命周期的 hook"></a>Gradle 生命周期的 hook</h2><p>在 buildSrc 中创建 ConfigUtils.groovy，用来做 Gradle 生命周期的 hook<br>ConfigUtils.groovy：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.gradle.BuildListener</span><br><span class="line"><span class="keyword">import</span> org.gradle.BuildResult</span><br><span class="line"><span class="keyword">import</span> org.gradle.api.initialization.Settings</span><br><span class="line"><span class="keyword">import</span> org.gradle.api.invocation.Gradle</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConfigUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> addBuildListener(Gradle g) &#123;</span><br><span class="line">        g.addBuildListener(<span class="keyword">new</span> BuildListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="type">void</span> buildStarted(Gradle gradle) &#123;</span><br><span class="line">                GLog.d(<span class="string">&quot;buildStarted&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="type">void</span> settingsEvaluated(Settings settings) &#123;</span><br><span class="line">                GLog.d(<span class="string">&quot;settingsEvaluated&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="type">void</span> projectsLoaded(Gradle gradle) &#123;</span><br><span class="line">                GLog.d(<span class="string">&quot;projectsLoaded&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="type">void</span> projectsEvaluated(Gradle gradle) &#123;</span><br><span class="line">                GLog.d(<span class="string">&quot;projectsEvaluated&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="type">void</span> buildFinished(BuildResult buildResult) &#123;</span><br><span class="line">                GLog.d(<span class="string">&quot;buildFinished&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 setting.gradle 中添加 <code>ConfigUtils.addBuildListener(gradle)</code>即可</p>
<p>执行 gradle clean 后得到</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">setting.gradle</span><br><span class="line">settingsEvaluated</span><br><span class="line">projectsLoaded</span><br><span class="line">root project <span class="string">&#x27;AucFrameTemplate&#x27;</span> -&gt; root</span><br><span class="line">project <span class="string">&#x27;:lib:base&#x27;</span> -&gt; lib</span><br><span class="line">project <span class="string">&#x27;:lib:common&#x27;</span> -&gt; lib</span><br><span class="line">project <span class="string">&#x27;:feature:feature0:app&#x27;</span> -&gt; app</span><br><span class="line">project <span class="string">&#x27;:feature:feature0:export&#x27;</span> -&gt; lib</span><br><span class="line">project <span class="string">&#x27;:feature:feature0:pkg&#x27;</span> -&gt; lib</span><br><span class="line">project <span class="string">&#x27;:feature:feature1:app&#x27;</span> -&gt; app</span><br><span class="line">project <span class="string">&#x27;:feature:feature1:export&#x27;</span> -&gt; lib</span><br><span class="line">project <span class="string">&#x27;:feature:feature1:pkg&#x27;</span> -&gt; lib</span><br><span class="line">project <span class="string">&#x27;:feature:launcher:app&#x27;</span> -&gt; app</span><br><span class="line">projectsEvaluated</span><br><span class="line">buildFinished</span><br></pre></td></tr></table></figure>



<h2 id="解放-setting-gradle"><a href="#解放-setting-gradle" class="headerlink" title="解放 setting.gradle"></a>解放 setting.gradle</h2><p>基于上面的生命周期，我们在<code>settingsEvaluated</code>中做<code>setting.gradle</code>的任务来解放<code>setting.gradle</code></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//setting.gradle</span></span><br><span class="line">ConfigUtils.addBuildListener(gradle)</span><br><span class="line"></span><br><span class="line"><span class="comment">//ConfigUtils.groovy</span></span><br><span class="line"><span class="meta">@override</span></span><br><span class="line"><span class="type">void</span> settingsEvaluated(Settings settings)&#123;</span><br><span class="line">    GLog.d(<span class="string">&quot;settingsEvaluated&quot;</span>)</span><br><span class="line">    includeModule(settings)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> includeModule(Settings settings)&#123;</span><br><span class="line">    settings.include <span class="string">&#x27;:lib:base&#x27;</span>, <span class="string">&#x27;:lib:common&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;:feature:feature0:export&#x27;</span>, <span class="string">&#x27;:feature:feature1:export&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;:feature:feature0:pkg&#x27;</span>, <span class="string">&#x27;:feature:feature1:pkg&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;:feature:feature0:app&#x27;</span>, <span class="string">&#x27;:feature:feature1:app&#x27;</span>, <span class="string">&#x27;:feature:launcher:app&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="解放module中的-build-gradle"><a href="#解放module中的-build-gradle" class="headerlink" title="解放module中的 build.gradle"></a>解放module中的 build.gradle</h2><p>利用<code>projectsLoaded</code>这个 hook，加入如下代码</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ConfigUtils.groovy</span></span><br><span class="line"><span class="meta">@override</span></span><br><span class="line"><span class="type">void</span> projectsLoaded(Gradle gradle)&#123;</span><br><span class="line">    GLog.d(<span class="string">&quot;projectsLoaded&quot;</span>)</span><br><span class="line">    gradle.addProjectEvaluationListener(<span class="keyword">new</span> ProjectEvaluationListener()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="type">void</span> beforeEvaluate(Project project)&#123;</span><br><span class="line">            GLog.d(<span class="string">&quot;beforeEvaluate&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> (project.subprojects.isEmpty()) &#123;<span class="comment">// 定位到具体 project</span></span><br><span class="line">                <span class="keyword">if</span> (project.name == <span class="string">&quot;app&quot;</span>) &#123;</span><br><span class="line">                    GLog.l(project.toString() + <span class="string">&quot; applies buildApp.gradle&quot;</span>)</span><br><span class="line">                    project.apply &#123;</span><br><span class="line">                        from <span class="string">&quot;$&#123;project.rootDir.path&#125;/buildApp.gradle&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    GLog.l(project.toString() + <span class="string">&quot; applies buildLib.gradle&quot;</span>)</span><br><span class="line">                    project.apply &#123;</span><br><span class="line">                        from <span class="string">&quot;$&#123;project.rootDir.path&#125;/buildLib.gradle&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@override</span></span><br><span class="line">        <span class="type">void</span> afterEvaluate(Project project, ProjectState projectState)&#123;</span><br><span class="line">            GLog.d(<span class="string">&quot;afterEvaluate&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="干货：增加ConfigUtils-groovy和DepConfig-groovy来进一步解放"><a href="#干货：增加ConfigUtils-groovy和DepConfig-groovy来进一步解放" class="headerlink" title="干货：增加ConfigUtils.groovy和DepConfig.groovy来进一步解放"></a>干货：增加ConfigUtils.groovy和DepConfig.groovy来进一步解放</h2><h3 id="DepConfig-groovy实体类"><a href="#DepConfig-groovy实体类" class="headerlink" title="DepConfig.groovy实体类"></a><code>DepConfig.groovy</code>实体类</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//buildSrc/src/main/groovy/DepConfig.groovy</span></span><br><span class="line"><span class="comment">//这个是实体类，用来管理feature下各个module的apply和dependencies</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DepConfig</span>&#123;</span><br><span class="line">    <span class="type">boolean</span> useLocal    <span class="comment">//是否使用本地的</span></span><br><span class="line">    String localPath    <span class="comment">//本地路径</span></span><br><span class="line">    String remotePath   <span class="comment">//远程路径</span></span><br><span class="line">    <span class="type">boolean</span> isApply     <span class="comment">//是否应用</span></span><br><span class="line">    String path         <span class="comment">//最后的路径</span></span><br><span class="line">    <span class="keyword">def</span> dep             <span class="comment">//根据条件生成项目最终的依赖项</span></span><br><span class="line"></span><br><span class="line">    DepConfig(String path)&#123;</span><br><span class="line">        <span class="variable language_">this</span>(path, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DepConfig(String path, <span class="type">boolean</span> isApply)&#123;</span><br><span class="line">        <span class="keyword">if</span> (path.startsWith(<span class="string">&quot;:&quot;</span>))&#123;</span><br><span class="line">            <span class="variable language_">this</span>.useLocal = <span class="literal">true</span></span><br><span class="line">            <span class="variable language_">this</span>.localPath = path</span><br><span class="line">            <span class="variable language_">this</span>.isApply = isApply</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.useLocal = <span class="literal">false</span></span><br><span class="line">            <span class="variable language_">this</span>.remotePath = path</span><br><span class="line">            <span class="variable language_">this</span>.isApply = isApply</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.path = path</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DepConfig(<span class="type">boolean</span> useLocal, String localPath, String remotePath)&#123;</span><br><span class="line">        <span class="variable language_">this</span>(useLocal, localPath, remotePath, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DepConfig(<span class="type">boolean</span> useLocal, String localPath, String remotePath, <span class="type">boolean</span> isApply)&#123;</span><br><span class="line">        <span class="variable language_">this</span>.useLocal = useLocal</span><br><span class="line">        <span class="variable language_">this</span>.localPath = localPath</span><br><span class="line">        <span class="variable language_">this</span>.remotePath = remotePath</span><br><span class="line">        <span class="variable language_">this</span>.isApply = isApply</span><br><span class="line">        <span class="variable language_">this</span>.path = useLocal ? localPath : remotePath</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String toString() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;DepConfig&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;useLocal=&quot;</span> + useLocal +</span><br><span class="line">                <span class="string">&quot;, localPath=&#x27;&quot;</span> + localPath + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, remotePath=&#x27;&quot;</span> + remotePath + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, isApply=&quot;</span> + isApply +</span><br><span class="line">                <span class="string">&quot;, path=&#x27;&quot;</span> + path + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, dep=&quot;</span> + dep +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ConfigUtils-groovy解放setting-gradle和各module的apply和dependencies"><a href="#ConfigUtils-groovy解放setting-gradle和各module的apply和dependencies" class="headerlink" title="ConfigUtils.groovy解放setting.gradle和各module的apply和dependencies"></a><code>ConfigUtils.groovy</code>解放<code>setting.gradle</code>和各<code>module</code>的<code>apply</code>和<code>dependencies</code></h3><ul>
<li>在<code>settingsEvaluated</code>中根据<code>Config.groovy</code>中的配置决定是否要<code>include</code>到项目中（根据<code>module</code>的名称<code>app</code>、<code>pkg</code>设置<code>isApply</code>的开关）</li>
<li>在<code>projectsLoaded</code>中先对<code>localPath</code>加后缀<code>.dep</code>。再在<code>gradle.addProjectEvaluationListener</code>的<code>beforeEvaluate</code>中针对“最低层”module（注意<code>if(project.subprojexts.isEmpty())</code>）根据<code>project.name</code>进行<code>project.apply``buildApp.gradle</code>或<code>buildLib.gradle</code></li>
<li>注意前文给出的结构图中，标注了<code>export</code>是全量提供的，所以在这里不做处理</li>
</ul>
<h4 id="3个工具方法"><a href="#3个工具方法" class="headerlink" title="3个工具方法"></a>3个工具方法</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//buildSrc/src/main/groovy/ConfigUtils.groovy</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 列出Config.groovy中配置的所有要isApply到项目中的pkg</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> getApplyPkgs() &#123;</span><br><span class="line">    <span class="keyword">def</span> applyPkgs = getDepConfigByFilter(<span class="keyword">new</span> DepConfigFilter() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="type">boolean</span> accept(String name, DepConfig config) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!config.isApply) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            <span class="keyword">return</span> name.endsWith(<span class="string">&quot;.pkg&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    GLog.d(<span class="string">&quot;getApplyPkgs = $&#123;GLog.object2String(applyPkgs)&#125;&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> applyPkgs</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 列出Config.groovy中配置的所有要isApply到项目中的export</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> getApplyExports()&#123;</span><br><span class="line">    <span class="keyword">def</span> applyExports = getDepConfigByFilter(<span class="keyword">new</span> DepConfigFilter()&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="type">boolean</span> accept(String name, DepConfig config) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!config.isApply) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            <span class="keyword">return</span> name.endsWith(<span class="string">&quot;.export&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    GLog.d(<span class="string">&quot;getApplyExports = $&#123;GLog.object2String(applyExports)&#125;&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> applyExports</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据depConfig生成dep</span></span><br><span class="line"><span class="comment"> * @param gradle</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> generateDep(Gradle gradle)&#123;</span><br><span class="line">    <span class="keyword">def</span> config = getDepConfigByFilter(<span class="keyword">new</span> DepConfigFilter()&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="type">boolean</span> accept(String name, DepConfig config) &#123;</span><br><span class="line">            <span class="keyword">if</span> (config.useLocal)&#123;<span class="comment">//如果使用的是本地模块，那么就把它转化为project</span></span><br><span class="line">                config.dep = gradle.rootProject.findProject(config.localPath)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">//如果是远端依赖，那就直接使用远端依赖即可</span></span><br><span class="line">                config.dep = config.remotePath</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    GLog.l(<span class="string">&quot;generateDep = $&#123;GLog.object2String(config)&#125;&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> Map&lt;String, DepConfig&gt; getDepConfigByFilter(DepConfigFilter filter)&#123;</span><br><span class="line">    <span class="keyword">return</span> _getDepConfigByFilter(<span class="string">&quot;&quot;</span>, Config.depConfig, filter)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 转换module名称中“：”为“.”</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> _getDepConfigByFilter(String namePrefix, Map map, DepConfigFilter filter)&#123;</span><br><span class="line">    <span class="keyword">def</span> depConfigList = [:] <span class="comment">//结果Map</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry <span class="attr">entry:</span> map.entrySet())&#123;</span><br><span class="line">        <span class="keyword">def</span>(name, value) = [entry.getKey(), entry.getValue()]</span><br><span class="line">        <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Map)&#123; <span class="comment">//如果值是Map类型就加到结果Map中</span></span><br><span class="line">            namePrefix += (name + <span class="string">&quot;.&quot;</span>)</span><br><span class="line">            depConfigList.putAll(_getDepConfigByFilter(namePrefix, value, filter))</span><br><span class="line">            namePrefix -= (name + <span class="string">&quot;.&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">def</span> config = value <span class="keyword">as</span> DepConfig</span><br><span class="line">        <span class="keyword">if</span> (filter == <span class="literal">null</span> || filter.accept(namePrefix + name, config))&#123;</span><br><span class="line">            depConfigList.put(namePrefix + name, config) <span class="comment">//符合过滤条件就加到结果Map中</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> depConfigList</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">DepConfigFilter</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> accept(String name, DepConfig config)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="解放settings-gradle"><a href="#解放settings-gradle" class="headerlink" title="解放settings.gradle"></a>解放settings.gradle</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//buildSrc/src/main/groovy/ConfigUtils.groovy</span></span><br><span class="line"><span class="comment">//settingsEvaluated中</span></span><br><span class="line"><span class="comment">//根据Config.groovy中的配置决定是否要include到项目中（设置isApply的开关）</span></span><br><span class="line"><span class="comment">//根据appConfig和pkgConfig来include本地模块</span></span><br><span class="line"><span class="keyword">def</span> config = getDepConfigByFilter(<span class="keyword">new</span> DepConfigFilter()&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="type">boolean</span> accept(String name, DepConfig config) &#123;</span><br><span class="line">        <span class="keyword">if</span> (name.endsWith(<span class="string">&#x27;.app&#x27;</span>))&#123;<span class="comment">//如果最终是app的话</span></span><br><span class="line">            <span class="keyword">def</span> appName = name.substring(<span class="string">&#x27;feature.&#x27;</span>.length(), name.length() - <span class="number">4</span>) <span class="comment">//获取app模块的名字</span></span><br><span class="line">            <span class="keyword">if</span> (!Config.appConfig.contains(appName))&#123; <span class="comment">//如果Config.appConfig中不存在，那就不让它进依赖</span></span><br><span class="line">                config.isApply = <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!Config.pkgConfig.isEmpty())&#123; <span class="comment">//如果Config.pkgConfig 不为空，说明是pkg调试模式</span></span><br><span class="line">            <span class="keyword">if</span> (name.endsWith(<span class="string">&#x27;.pkg&#x27;</span>))&#123; <span class="comment">//如果是pkg的话</span></span><br><span class="line">                <span class="keyword">def</span> pkgName = name.substring(<span class="string">&#x27;feature.&#x27;</span>.length(), name.length() - <span class="number">4</span>) <span class="comment">//获取pkg模块的名字</span></span><br><span class="line">                <span class="keyword">if</span> (!Config.pkgConfig.contains(pkgName))&#123; <span class="comment">//如果Config.pkgConfig中不存在，那就不让它进依赖</span></span><br><span class="line">                    config.isApply = <span class="literal">false</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//过滤出本地并且apply的模块</span></span><br><span class="line">        <span class="keyword">if</span> (!config.isApply)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!config.useLocal)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (config.localPath == <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;).each &#123; _, cfg -&gt; <span class="comment">//把本地模块include进去</span></span><br><span class="line">    settings.include cfg.localPath</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="解放module的apply"><a href="#解放module的apply" class="headerlink" title="解放module的apply"></a>解放module的apply</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//buildSrc/src/main/groovy/ConfigUtils.groovy</span></span><br><span class="line"><span class="comment">//projectsLoaded中</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//给Config.groovy中每个localPath添加.dep后缀</span></span><br><span class="line">generateDep(gradle)</span><br><span class="line"></span><br><span class="line"><span class="comment">//解放feature下各module的apply</span></span><br><span class="line">gradle.addProjectEvaluationListener(<span class="keyword">new</span> ProjectEvaluationListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="type">void</span> beforeEvaluate(Project project) &#123;</span><br><span class="line">        GLog.d(<span class="string">&quot;beforeEvaluate&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> (project.subprojects.isEmpty()) &#123;<span class="comment">//定位到具体project</span></span><br><span class="line">            <span class="keyword">if</span> (project.name == <span class="string">&quot;app&quot;</span>) &#123;</span><br><span class="line">                GLog.l(project.toString() + <span class="string">&quot; applies buildApp.gradle&quot;</span>)</span><br><span class="line">                project.apply &#123;</span><br><span class="line">                    from <span class="string">&quot;$&#123;project.rootDir.path&#125;/buildApp.gradle&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                GLog.l(project.toString() + <span class="string">&quot; applies buildLlib.gradle&quot;</span>)</span><br><span class="line">                project.apply &#123;</span><br><span class="line">                    from <span class="string">&quot;$&#123;project.rootDir.path&#125;/buildLib.gradle&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="type">void</span> afterEvaluate(Project project, ProjectState projectState) &#123;</span><br><span class="line">        GLog.d(<span class="string">&quot;afterEvaluate&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="解放feature下build-gradle中的dependencies"><a href="#解放feature下build-gradle中的dependencies" class="headerlink" title="解放feature下build.gradle中的dependencies"></a>解放feature下build.gradle中的dependencies</h4><p>修改<code>buildApp.gradle</code></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    <span class="comment">//leakCanary</span></span><br><span class="line">    debugImplementation Config.depConfig.leakcanary.android.dep</span><br><span class="line">    debugImplementation Config.depConfig.leakcanary.support_fragment.dep</span><br><span class="line">    releaseImplementation Config.depConfig.leakcanary.android_no_op.dep</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据Config.pkgConfig来依赖所有pkg</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">def</span> <span class="attr">entrySet:</span> ConfigUtils.getApplyPkgs().entrySet())&#123;</span><br><span class="line">        <span class="comment">//类似于 api project(&quot;:feature:feature0:pkg&quot;)</span></span><br><span class="line">        api entrySet.value.dep</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改<code>buildLib.gradle</code></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加 dependencies</span></span><br><span class="line">dependencies &#123;</span><br><span class="line">    <span class="keyword">if</span> (project.name == <span class="string">&#x27;pkg&#x27;</span>)&#123;</span><br><span class="line">        <span class="comment">//if module&#x27;s name equals &#x27;pkg&#x27;, api all of export</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">def</span> <span class="attr">entrySet:</span> ConfigUtils.getApplyExports().entrySet())&#123;</span><br><span class="line">            api entrySet.value.dep</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (project.name == <span class="string">&#x27;export&#x27;</span>)&#123;</span><br><span class="line">        api Config.depConfig.lib.common.dep</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就可以把各个 module 的apply和dependencies注释掉（即feature下的module的build.gradle都是空的）</p>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><ol>
<li><p>launcher的dependencies是怎么关联feature0和feature1的pkg？</p>
<p>ConfigUtils中设置了所有app都关联buildApp.gradle，所有pkg、export</p>
</li>
<li></li>
</ol>
<h3 id="完整代码："><a href="#完整代码：" class="headerlink" title="完整代码："></a>完整代码：</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Config.groovy</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Config</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> applicationId = <span class="string">&#x27;com.shenbh&#x27;</span></span><br><span class="line">    <span class="keyword">static</span> appName = <span class="string">&#x27;AucFrame&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> compileSdkVersion = <span class="number">28</span></span><br><span class="line">    <span class="keyword">static</span> minSdkVersion = <span class="number">21</span></span><br><span class="line">    <span class="keyword">static</span> targetSdkVersion = <span class="number">28</span></span><br><span class="line">    <span class="keyword">static</span> versionCode = <span class="number">1</span>_000_000</span><br><span class="line">    <span class="keyword">static</span> versionName = <span class="string">&#x27;1.0.0&#x27;</span><span class="comment">// E.g. 1.9.72 =&gt; 1,009,072</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> kotlin_version = <span class="string">&#x27;1.3.10&#x27;</span></span><br><span class="line">    <span class="keyword">static</span> support_version = <span class="string">&#x27;28.1.1&#x27;</span></span><br><span class="line">    <span class="keyword">static</span> leakcanary_version = <span class="string">&#x27;1.6.3&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// appConfig 配置的是可以跑 app 模块，git 提交务必只包含 launcher</span></span><br><span class="line">    <span class="keyword">static</span> appConfig = [<span class="string">&#x27;launcher&#x27;</span>, <span class="string">&#x27;feature0&#x27;</span>]</span><br><span class="line">    <span class="comment">// pkgConfig 配置的是要依赖的功能包，为空则依赖全部，git 提交务必为空</span></span><br><span class="line">    <span class="keyword">static</span> pkgConfig = [<span class="string">&#x27;feature0&#x27;</span>]</span><br><span class="line">    <span class="keyword">static</span> depConfig = [</span><br><span class="line">            <span class="attr">feature :</span>   [</span><br><span class="line">                    <span class="attr">launcher    :</span>   [</span><br><span class="line">                            <span class="attr">app     :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;:feature:launcher:app&quot;</span>)</span><br><span class="line">                    ],</span><br><span class="line">                    <span class="attr">feature0    :</span>   [</span><br><span class="line">                            <span class="attr">app     :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;:feature:feature0:app&quot;</span>),</span><br><span class="line">                            <span class="attr">pkg     :</span> <span class="keyword">new</span> DepConfig(<span class="literal">true</span>, <span class="string">&quot;:feature:feature0:pkg&quot;</span>, <span class="string">&quot;com.blankj:feature-feature0-pkg:1.0&quot;</span>, <span class="literal">true</span>),</span><br><span class="line">                            <span class="attr">export  :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;:feature:feature0:export&quot;</span>),</span><br><span class="line">                    ],</span><br><span class="line">                    <span class="attr">feature1    :</span>   [</span><br><span class="line">                            <span class="attr">app     :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;:feature:feature1:app&quot;</span>),</span><br><span class="line">                            <span class="attr">pkg     :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;:feature:feature1:pkg&quot;</span>),</span><br><span class="line">                            <span class="attr">export  :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;:feature:feature1:export&quot;</span>),</span><br><span class="line">                    ],</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">lib     :</span>   [</span><br><span class="line">                    <span class="attr">base            :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;:lib:base&quot;</span>),</span><br><span class="line">                    <span class="attr">common          :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;:lib:common&quot;</span>)</span><br><span class="line">            ],</span><br><span class="line"></span><br><span class="line">            <span class="attr">plugin  :</span>   [</span><br><span class="line">                    <span class="attr">gradle          :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;com.android.tools.build:gradle:3.5.2&quot;</span>),</span><br><span class="line">                    <span class="attr">kotlin          :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version&quot;</span>),</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">support :</span>   [</span><br><span class="line">                    <span class="attr">appcompat_v7    :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;com.android.support:appcompat-v7:$support_version&quot;</span>),</span><br><span class="line">                    <span class="attr">design          :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;com.android.support:design:$support_version&quot;</span>),</span><br><span class="line">                    <span class="attr">multidex        :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;com.android.support:multidex:1.0.2&quot;</span>),</span><br><span class="line">                    <span class="attr">constraint      :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;com.android.support.constraint:constraint-layout:1.1.3&quot;</span>),</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">kotlin                  :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;org.jetbrains.kotlin:kotlin-stdlib-jdk7:$kotlin_version&quot;</span>),</span><br><span class="line">            <span class="attr">utilcode                :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;com.blankj:utilcode:1.25.0&quot;</span>),</span><br><span class="line">            <span class="attr">free_proguard           :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;com.blankj:free-proguard:1.0.1&quot;</span>),</span><br><span class="line">            <span class="attr">swipe_panel             :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;com.blankj:swipe-panel:1.1&quot;</span>),</span><br><span class="line"></span><br><span class="line">            <span class="attr">leakcanary  :</span> [</span><br><span class="line">                    <span class="attr">android         :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;com.squareup.leakcanary:leakcanary-android:$leakcanary_version&quot;</span>),</span><br><span class="line">                    <span class="attr">android_no_op   :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;com.squareup.leakcanary:leakcanary-android-no-op:$leakcanary_version&quot;</span>),</span><br><span class="line">                    <span class="symbol">support_fragment:</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;com.squareup.leakcanary:leakcanary-support-fragment:$leakcanary_version&quot;</span>),</span><br><span class="line">            ],</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ConfigUtils.groovy</span></span><br><span class="line"><span class="keyword">import</span> org.gradle.BuildListener</span><br><span class="line"><span class="keyword">import</span> org.gradle.BuildResult</span><br><span class="line"><span class="keyword">import</span> org.gradle.api.Project</span><br><span class="line"><span class="keyword">import</span> org.gradle.api.ProjectEvaluationListener</span><br><span class="line"><span class="keyword">import</span> org.gradle.api.ProjectState</span><br><span class="line"><span class="keyword">import</span> org.gradle.api.initialization.Settings</span><br><span class="line"><span class="keyword">import</span> org.gradle.api.invocation.Gradle</span><br><span class="line"></span><br><span class="line"><span class="comment">//Gradle生命周期的hook</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConfigUtils</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 列出Config.groovy中配置的所有要isApply到项目中的pkg</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> getApplyPkgs() &#123;</span><br><span class="line">        <span class="keyword">def</span> applyPkgs = getDepConfigByFilter(<span class="keyword">new</span> DepConfigFilter() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="type">boolean</span> accept(String name, DepConfig config) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!config.isApply) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">                <span class="keyword">return</span> name.endsWith(<span class="string">&quot;.pkg&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        GLog.d(<span class="string">&quot;getApplyPkgs = $&#123;GLog.object2String(applyPkgs)&#125;&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> applyPkgs</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 列出Config.groovy中配置的所有要isApply到项目中的export</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> getApplyExports()&#123;</span><br><span class="line">        <span class="keyword">def</span> applyExports = getDepConfigByFilter(<span class="keyword">new</span> DepConfigFilter()&#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="type">boolean</span> accept(String name, DepConfig config) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!config.isApply) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">                <span class="keyword">return</span> name.endsWith(<span class="string">&quot;.export&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        GLog.d(<span class="string">&quot;getApplyExports = $&#123;GLog.object2String(applyExports)&#125;&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> applyExports</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> addBuildListener(Gradle g)&#123;</span><br><span class="line">        g.addBuildListener(<span class="keyword">new</span> ConfigBuilderListener())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ConfigBuilderListener</span> <span class="keyword">implements</span> <span class="title class_">BuildListener</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="type">void</span> buildStarted(Gradle gradle) &#123;</span><br><span class="line">            GLog.d(<span class="string">&quot;buildStarted&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="type">void</span> settingsEvaluated(Settings settings) &#123;</span><br><span class="line">            GLog.d(<span class="string">&quot;settingsEvaluated&quot;</span>)</span><br><span class="line">            includeModule(settings)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="type">void</span> projectsLoaded(Gradle gradle) &#123;</span><br><span class="line">            GLog.d(<span class="string">&quot;projectsLoaded&quot;</span>)</span><br><span class="line">            generateDep(gradle)</span><br><span class="line"></span><br><span class="line">            <span class="comment">//解放feature下各module的apply</span></span><br><span class="line">            gradle.addProjectEvaluationListener(<span class="keyword">new</span> ProjectEvaluationListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="type">void</span> beforeEvaluate(Project project) &#123;</span><br><span class="line">                    GLog.d(<span class="string">&quot;beforeEvaluate&quot;</span>)</span><br><span class="line">                    <span class="keyword">if</span> (project.subprojects.isEmpty()) &#123;<span class="comment">//定位到具体project</span></span><br><span class="line">                        <span class="keyword">if</span> (project.name == <span class="string">&quot;app&quot;</span>) &#123;</span><br><span class="line">                            GLog.l(project.toString() + <span class="string">&quot; applies buildApp.gradle&quot;</span>)</span><br><span class="line">                            project.apply &#123;</span><br><span class="line">                                from <span class="string">&quot;$&#123;project.rootDir.path&#125;/buildApp.gradle&quot;</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            GLog.l(project.toString() + <span class="string">&quot; applies buildLlib.gradle&quot;</span>)</span><br><span class="line">                            project.apply &#123;</span><br><span class="line">                                from <span class="string">&quot;$&#123;project.rootDir.path&#125;/buildLib.gradle&quot;</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="type">void</span> afterEvaluate(Project project, ProjectState projectState) &#123;</span><br><span class="line">                    GLog.d(<span class="string">&quot;afterEvaluate&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="type">void</span> projectsEvaluated(Gradle gradle) &#123;</span><br><span class="line">            GLog.d(<span class="string">&quot;projectsEvaluated&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="type">void</span> buildFinished(BuildResult buildResult) &#123;</span><br><span class="line">            GLog.d(<span class="string">&quot;buildFinished&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据Config.groovy中的配置决定是否要include到项目中（设置isApply的开关）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> includeModule(Settings settings) &#123;</span><br><span class="line">        <span class="comment">/*settings.include &#x27;:lib:base&#x27;, &#x27;:lib:common&#x27;,</span></span><br><span class="line"><span class="comment">                &#x27;:feature:feature0:export&#x27;, &#x27;:feature:feature1:export&#x27;,</span></span><br><span class="line"><span class="comment">                &#x27;:feature:feature0:pkg&#x27;, &#x27;:feature:feature1:pkg&#x27;,</span></span><br><span class="line"><span class="comment">                &#x27;:feature:feature0:app&#x27;, &#x27;:feature:feature1:app&#x27;, &#x27;:feature:launcher:app&#x27;*/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//根据appConfig和pkgConfig来include本地模块</span></span><br><span class="line">        <span class="keyword">def</span> config = getDepConfigByFilter(<span class="keyword">new</span> DepConfigFilter()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="type">boolean</span> accept(String name, DepConfig config) &#123;</span><br><span class="line">                <span class="keyword">if</span> (name.endsWith(<span class="string">&#x27;.app&#x27;</span>))&#123;<span class="comment">//如果最终是app的话</span></span><br><span class="line">                    <span class="keyword">def</span> appName = name.substring(<span class="string">&#x27;feature.&#x27;</span>.length(), name.length() - <span class="number">4</span>) <span class="comment">//获取app模块的名字</span></span><br><span class="line">                    <span class="keyword">if</span> (!Config.appConfig.contains(appName))&#123; <span class="comment">//如果Config.appConfig中不存在，那就不让它进依赖</span></span><br><span class="line">                        config.isApply = <span class="literal">false</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!Config.pkgConfig.isEmpty())&#123; <span class="comment">//如果Config.pkgConfig 不为空，说明是pkg调试模式</span></span><br><span class="line">                    <span class="keyword">if</span> (name.endsWith(<span class="string">&#x27;.pkg&#x27;</span>))&#123; <span class="comment">//如果是pkg的话</span></span><br><span class="line">                        <span class="keyword">def</span> pkgName = name.substring(<span class="string">&#x27;feature.&#x27;</span>.length(), name.length() - <span class="number">4</span>) <span class="comment">//获取pkg模块的名字</span></span><br><span class="line">                        <span class="keyword">if</span> (!Config.pkgConfig.contains(pkgName))&#123; <span class="comment">//如果Config.pkgConfig中不存在，那就不让它进依赖</span></span><br><span class="line">                            config.isApply = <span class="literal">false</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//过滤出本地并且apply的模块</span></span><br><span class="line">                <span class="keyword">if</span> (!config.isApply)&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!config.useLocal)&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (config.localPath == <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).each &#123; _, cfg -&gt; <span class="comment">//把本地模块include进去</span></span><br><span class="line">            settings.include cfg.localPath</span><br><span class="line">        &#125;</span><br><span class="line">        GLog.l(<span class="string">&quot;includeModule = $&#123;GLog.object2String(config)&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据depConfig生成dep</span></span><br><span class="line"><span class="comment">     * @param gradle</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> generateDep(Gradle gradle)&#123;</span><br><span class="line">        <span class="keyword">def</span> config = getDepConfigByFilter(<span class="keyword">new</span> DepConfigFilter()&#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="type">boolean</span> accept(String name, DepConfig config) &#123;</span><br><span class="line">                <span class="keyword">if</span> (config.useLocal)&#123;<span class="comment">//如果使用的是本地模块，那么就把它转化为project</span></span><br><span class="line">                    config.dep = gradle.rootProject.findProject(config.localPath)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123; <span class="comment">//如果是远端依赖，那就直接使用远端依赖即可</span></span><br><span class="line">                    config.dep = config.remotePath</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        GLog.l(<span class="string">&quot;generateDep = $&#123;GLog.object2String(config)&#125;&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Map&lt;String, DepConfig&gt; getDepConfigByFilter(DepConfigFilter filter)&#123;</span><br><span class="line">        <span class="keyword">return</span> _getDepConfigByFilter(<span class="string">&quot;&quot;</span>, Config.depConfig, filter)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转换module名称中“：”为“.”</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> _getDepConfigByFilter(String namePrefix, Map map, DepConfigFilter filter)&#123;</span><br><span class="line">        <span class="keyword">def</span> depConfigList = [:] <span class="comment">//结果Map</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry <span class="attr">entry:</span> map.entrySet())&#123;</span><br><span class="line">            <span class="keyword">def</span>(name, value) = [entry.getKey(), entry.getValue()]</span><br><span class="line">            <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Map)&#123; <span class="comment">//如果值是Map类型就加到结果Map中</span></span><br><span class="line">                namePrefix += (name + <span class="string">&quot;.&quot;</span>)</span><br><span class="line">                depConfigList.putAll(_getDepConfigByFilter(namePrefix, value, filter))</span><br><span class="line">                namePrefix -= (name + <span class="string">&quot;.&quot;</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">def</span> config = value <span class="keyword">as</span> DepConfig</span><br><span class="line">            <span class="keyword">if</span> (filter == <span class="literal">null</span> || filter.accept(namePrefix + name, config))&#123;</span><br><span class="line">                depConfigList.put(namePrefix + name, config) <span class="comment">//符合过滤条件就加到结果Map中</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> depConfigList</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">DepConfigFilter</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> accept(String name, DepConfig config)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//DepConfig.groovy</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DepConfig</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> useLocal <span class="comment">// 是否使用本地的</span></span><br><span class="line">    String localPath <span class="comment">// 本地路径</span></span><br><span class="line">    String remotePath<span class="comment">// 远程路径</span></span><br><span class="line">    <span class="type">boolean</span> isApply  <span class="comment">// 是否应用</span></span><br><span class="line">    String path      <span class="comment">// 最后的路径</span></span><br><span class="line">    <span class="keyword">def</span> dep          <span class="comment">// 根据条件生成项目最终的依赖项</span></span><br><span class="line"></span><br><span class="line">    DepConfig(String path) &#123;</span><br><span class="line">        <span class="variable language_">this</span>(path, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DepConfig(String path, <span class="type">boolean</span> isApply) &#123;</span><br><span class="line">        <span class="keyword">if</span> (path.startsWith(<span class="string">&quot;:&quot;</span>)) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.useLocal = <span class="literal">true</span></span><br><span class="line">            <span class="variable language_">this</span>.localPath = path</span><br><span class="line">            <span class="variable language_">this</span>.isApply = isApply</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.useLocal = <span class="literal">false</span></span><br><span class="line">            <span class="variable language_">this</span>.remotePath = path</span><br><span class="line">            <span class="variable language_">this</span>.isApply = isApply</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.path = path</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DepConfig(<span class="type">boolean</span> useLocal, String localPath, String remotePath) &#123;</span><br><span class="line">        <span class="variable language_">this</span>(useLocal, localPath, remotePath, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DepConfig(<span class="type">boolean</span> useLocal, String localPath, String remotePath, <span class="type">boolean</span> isApply) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.useLocal = useLocal</span><br><span class="line">        <span class="variable language_">this</span>.localPath = localPath</span><br><span class="line">        <span class="variable language_">this</span>.remotePath = remotePath</span><br><span class="line">        <span class="variable language_">this</span>.isApply = isApply</span><br><span class="line">        <span class="variable language_">this</span>.path = useLocal ? localPath : remotePath</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    String toString() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;DepConfig &#123; &quot;</span> +</span><br><span class="line">                <span class="string">&quot;useLocal = &quot;</span> + useLocal +</span><br><span class="line">                (dep == <span class="literal">null</span> ? <span class="string">&quot;, path = &quot;</span> + path : (<span class="string">&quot;, dep = &quot;</span> + dep)) +</span><br><span class="line">                <span class="string">&quot;, isApply = &quot;</span> + isApply +</span><br><span class="line">                <span class="string">&quot; &#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//GLog.groovy</span></span><br><span class="line"><span class="comment">//这是打印gradle的Log的，可以知道每个Gradle加载的顺序。需要在各自需要的地方调用相应的输出日志的代码</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GLog</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="keyword">static</span> debugSwitch = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> d(Object... contents) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!debugSwitch) <span class="keyword">return</span> contents</span><br><span class="line">        <span class="keyword">return</span> l(contents)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> l(Object... contents) &#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder()</span><br><span class="line">        sb.append(LogConst.BORDER_TOP)</span><br><span class="line">        sb.append(borderMsg(processContents(contents)))</span><br><span class="line">        sb.append(LogConst.BORDER_BTM)</span><br><span class="line">        print sb.toString()</span><br><span class="line">        <span class="keyword">return</span> contents</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> borderMsg(String msg) &#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder()</span><br><span class="line">        object2String(msg).split(LogConst.LINE_SEP).each &#123; line -&gt;</span><br><span class="line">            sb.append(LogConst.BORDER_LFT).append(line).append(LogConst.LINE_SEP)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> processContents(<span class="keyword">final</span> Object... contents) &#123;</span><br><span class="line">        String body = LogConst.NULL</span><br><span class="line">        <span class="keyword">if</span> (contents != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (contents.length == <span class="number">1</span>) &#123;</span><br><span class="line">                body = object2String(contents[<span class="number">0</span>])</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                StringBuilder sb = <span class="keyword">new</span> StringBuilder()</span><br><span class="line">                <span class="type">int</span> i = <span class="number">0</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> len = contents.length; i &lt; len; ++i) &#123;</span><br><span class="line">                    Object content = contents[i]</span><br><span class="line">                    sb.append(<span class="string">&quot;args[$i] = &quot;</span>)</span><br><span class="line">                            .append(object2String(content))</span><br><span class="line">                            .append(LogConst.LINE_SEP)</span><br><span class="line">                &#125;</span><br><span class="line">                body = sb.toString()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> body.length() == <span class="number">0</span> ? LogConst.NOTHING : body</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> String object2String(Object object) &#123;</span><br><span class="line">        <span class="keyword">if</span> (object == <span class="literal">null</span>) <span class="keyword">return</span> <span class="string">&quot;null&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (object.getClass().isArray()) <span class="keyword">return</span> LogFormatter.array2String(object);</span><br><span class="line">        <span class="keyword">if</span> (object <span class="keyword">instanceof</span> List) <span class="keyword">return</span> LogFormatter.list2String(object);</span><br><span class="line">        <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Map) <span class="keyword">return</span> LogFormatter.map2String(object);</span><br><span class="line">        <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Throwable) <span class="keyword">return</span> LogFormatter.throwable2String(object);</span><br><span class="line">        <span class="keyword">return</span> object.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LogFormatter</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> array2String(Object object) &#123;</span><br><span class="line">            <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Object[]) &#123;</span><br><span class="line">                <span class="keyword">return</span> Arrays.deepToString((Object[]) object);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> <span class="type">boolean</span>[]) &#123;</span><br><span class="line">                <span class="keyword">return</span> Arrays.toString((<span class="type">boolean</span>[]) object);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> <span class="type">byte</span>[]) &#123;</span><br><span class="line">                <span class="keyword">return</span> Arrays.toString((<span class="type">byte</span>[]) object);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> <span class="type">char</span>[]) &#123;</span><br><span class="line">                <span class="keyword">return</span> Arrays.toString((<span class="type">char</span>[]) object);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> <span class="type">double</span>[]) &#123;</span><br><span class="line">                <span class="keyword">return</span> Arrays.toString((<span class="type">double</span>[]) object);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> <span class="type">float</span>[]) &#123;</span><br><span class="line">                <span class="keyword">return</span> Arrays.toString((<span class="type">float</span>[]) object);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> <span class="type">int</span>[]) &#123;</span><br><span class="line">                <span class="keyword">return</span> Arrays.toString((<span class="type">int</span>[]) object);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> <span class="type">long</span>[]) &#123;</span><br><span class="line">                <span class="keyword">return</span> Arrays.toString((<span class="type">long</span>[]) object);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> <span class="type">short</span>[]) &#123;</span><br><span class="line">                <span class="keyword">return</span> Arrays.toString((<span class="type">short</span>[]) object);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Array has incompatible type: &quot;</span> + object.getClass());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> list2String(List list) &#123;</span><br><span class="line">            StringBuilder sb = <span class="keyword">new</span> StringBuilder()</span><br><span class="line">            sb.append(<span class="string">&quot;[&quot;</span>)</span><br><span class="line">            list.each &#123; v -&gt;</span><br><span class="line">                <span class="keyword">if</span> (v <span class="keyword">instanceof</span> Map || v <span class="keyword">instanceof</span> List) &#123;</span><br><span class="line">                    sb.append(String.format(<span class="string">&quot;$LogConst.LINE_SEP%$&#123;deep++ * 8&#125;s$&#123;object2String(v)&#125;,&quot;</span>, <span class="string">&quot;&quot;</span>, k))</span><br><span class="line">                    deep--</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    sb.append(String.format(<span class="string">&quot;$LogConst.LINE_SEP%$&#123;deep * 8&#125;s$v,&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            sb.deleteCharAt(sb.length() - <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> (deep - <span class="number">1</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                sb.append(<span class="string">&quot;$LogConst.LINE_SEP]&quot;</span>)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                sb.append(String.format(<span class="string">&quot;$LogConst.LINE_SEP%$&#123;(deep - 1) * 8&#125;s]&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sb.toString()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> deep = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> map2String(Map map) &#123;</span><br><span class="line">            StringBuilder sb = <span class="keyword">new</span> StringBuilder()</span><br><span class="line">            sb.append(<span class="string">&quot;[&quot;</span>)</span><br><span class="line">            map.each &#123; k, v -&gt;</span><br><span class="line">                <span class="keyword">if</span> (v <span class="keyword">instanceof</span> Map || v <span class="keyword">instanceof</span> List) &#123;</span><br><span class="line">                    sb.append(String.format(<span class="string">&quot;$LogConst.LINE_SEP%$&#123;deep++ * 8&#125;s%-26s: $&#123;object2String(v)&#125;,&quot;</span>, <span class="string">&quot;&quot;</span>, k))</span><br><span class="line">                    deep--</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    sb.append(String.format(<span class="string">&quot;$LogConst.LINE_SEP%$&#123;deep * 8&#125;s%-26s: $v,&quot;</span>, <span class="string">&quot;&quot;</span>, k))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            sb.deleteCharAt(sb.length() - <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> (deep - <span class="number">1</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                sb.append(<span class="string">&quot;$LogConst.LINE_SEP]&quot;</span>)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                sb.append(String.format(<span class="string">&quot;$LogConst.LINE_SEP%$&#123;(deep - 1) * 8&#125;s]&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sb.toString()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> throwable2String(Throwable throwable) &#123;</span><br><span class="line">            <span class="keyword">final</span> List&lt;Throwable&gt; throwableList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">while</span> (throwable != <span class="literal">null</span> &amp;&amp; !throwableList.contains(throwable)) &#123;</span><br><span class="line">                throwableList.add(throwable);</span><br><span class="line">                throwable = throwable.getCause();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> size = throwableList.size();</span><br><span class="line">            <span class="keyword">final</span> List&lt;String&gt; frames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            List&lt;String&gt; nextTrace = getStackFrameList(throwableList.get(size - <span class="number">1</span>));</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = size; --i &gt;= <span class="number">0</span>;) &#123;</span><br><span class="line">                <span class="keyword">final</span> List&lt;String&gt; trace = nextTrace;</span><br><span class="line">                <span class="keyword">if</span> (i != <span class="number">0</span>) &#123;</span><br><span class="line">                    nextTrace = getStackFrameList(throwableList.get(i - <span class="number">1</span>));</span><br><span class="line">                    removeCommonFrames(trace, nextTrace);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (i == size - <span class="number">1</span>) &#123;</span><br><span class="line">                    frames.add(throwableList.get(i).toString());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    frames.add(<span class="string">&quot; Caused by: &quot;</span> + throwableList.get(i).toString());</span><br><span class="line">                &#125;</span><br><span class="line">                frames.addAll(trace);</span><br><span class="line">            &#125;</span><br><span class="line">            StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> String <span class="attr">element :</span> frames) &#123;</span><br><span class="line">                sb.append(element).append(LogConst.LINE_SEP);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sb.toString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; getStackFrameList(<span class="keyword">final</span> Throwable throwable) &#123;</span><br><span class="line">            <span class="keyword">final</span> StringWriter sw = <span class="keyword">new</span> StringWriter();</span><br><span class="line">            <span class="keyword">final</span> PrintWriter pw = <span class="keyword">new</span> PrintWriter(sw, <span class="literal">true</span>);</span><br><span class="line">            throwable.printStackTrace(pw);</span><br><span class="line">            <span class="keyword">final</span> String stackTrace = sw.toString();</span><br><span class="line">            <span class="keyword">final</span> StringTokenizer frames = <span class="keyword">new</span> StringTokenizer(stackTrace, LogConst.LINE_SEP);</span><br><span class="line">            <span class="keyword">final</span> List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="type">boolean</span> traceStarted = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">while</span> (frames.hasMoreTokens()) &#123;</span><br><span class="line">                <span class="keyword">final</span> String token = frames.nextToken();</span><br><span class="line">                <span class="comment">// Determine if the line starts with &lt;whitespace&gt;at</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> at = token.indexOf(<span class="string">&quot;at&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (at != <span class="number">-1</span> &amp;&amp; token.substring(<span class="number">0</span>, at).trim().isEmpty()) &#123;</span><br><span class="line">                    traceStarted = <span class="literal">true</span>;</span><br><span class="line">                    list.add(token);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (traceStarted) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> list;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">void</span> removeCommonFrames(<span class="keyword">final</span> List&lt;String&gt; causeFrames, <span class="keyword">final</span> List&lt;String&gt; wrapperFrames) &#123;</span><br><span class="line">            <span class="type">int</span> causeFrameIndex = causeFrames.size() - <span class="number">1</span>;</span><br><span class="line">            <span class="type">int</span> wrapperFrameIndex = wrapperFrames.size() - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span> (causeFrameIndex &gt;= <span class="number">0</span> &amp;&amp; wrapperFrameIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// Remove the frame from the cause trace if it is the same</span></span><br><span class="line">                <span class="comment">// as in the wrapper trace</span></span><br><span class="line">                <span class="keyword">final</span> String causeFrame = causeFrames.get(causeFrameIndex);</span><br><span class="line">                <span class="keyword">final</span> String wrapperFrame = wrapperFrames.get(wrapperFrameIndex);</span><br><span class="line">                <span class="keyword">if</span> (causeFrame.equals(wrapperFrame)) &#123;</span><br><span class="line">                    causeFrames.remove(causeFrameIndex);</span><br><span class="line">                &#125;</span><br><span class="line">                causeFrameIndex--;</span><br><span class="line">                wrapperFrameIndex--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LogConst</span> &#123;</span><br><span class="line">        <span class="keyword">static</span> LINE_SEP = System.getProperty(<span class="string">&quot;line.separator&quot;</span>);</span><br><span class="line">        <span class="keyword">static</span> BORDER_TOP = <span class="string">&quot;┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────&quot;</span> + LINE_SEP</span><br><span class="line">        <span class="keyword">static</span> BORDER_LFT = <span class="string">&quot;│ &quot;</span>;</span><br><span class="line">        <span class="keyword">static</span> BORDER_BTM = <span class="string">&quot;└────────────────────────────────────────────────────────────────────────────────────────────────────────────────&quot;</span> + LINE_SEP</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> NOTHING = <span class="string">&quot;log nothing&quot;</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> NULL = <span class="string">&quot;null&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//buildSrc--&gt;build.gradle</span></span><br><span class="line">println(<span class="string">&quot;===&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">    google()</span><br><span class="line">    jcenter()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">apply&#123;</span><br><span class="line">    plugin <span class="string">&#x27;groovy&#x27;</span></span><br><span class="line">    plugin <span class="string">&#x27;java-gradle-plugin&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation gradleApi()</span><br><span class="line">    implementation localGroovy()</span><br><span class="line"><span class="comment">//    implementation project(&quot;:dep&quot;)</span></span><br><span class="line">    implementation <span class="string">&quot;commons-io:commons-io:2.6&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//feature、launcher 里 app、pkg、export 的 gradle 都为空</span></span><br></pre></td></tr></table></figure>

<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lib--&gt;base的 build.gradle</span></span><br><span class="line"><span class="comment">//在 ConfigUtils.groovy 中的 addBuildListener 内 projectsLoaded 的里配置</span></span><br><span class="line"><span class="comment">//apply &#123;</span></span><br><span class="line"><span class="comment">//    from &quot;$&#123;project.rootDir.path&#125;/buildLib.gradle&quot;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation fileTree(<span class="attr">include:</span> [<span class="string">&#x27;*.jar&#x27;</span>], <span class="attr">dir:</span> <span class="string">&#x27;libs&#x27;</span>)</span><br><span class="line">    api Config.depConfig.utilcode.dep</span><br><span class="line">    api Config.depConfig.free_proguard.dep</span><br><span class="line">    api Config.depConfig.swipe_panel.dep</span><br><span class="line"></span><br><span class="line">    api Config.depConfig.support.appcompat_v7.dep</span><br><span class="line">    api Config.depConfig.support.design.dep</span><br><span class="line">    api Config.depConfig.support.multidex.dep</span><br><span class="line">    api Config.depConfig.support.constraint.dep</span><br><span class="line">    api Config.depConfig.kotlin.dep</span><br><span class="line">    compileOnly Config.depConfig.leakcanary.android_no_op.dep</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lib--&gt;common 的 gradle</span></span><br><span class="line"><span class="comment">//统一管理Gradle</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//在 ConfigUtils.groovy 中的 addBuildListener 内 projectsLoaded 的里配置</span></span><br><span class="line"><span class="comment">//apply&#123;</span></span><br><span class="line"><span class="comment">//    from &quot;$&#123;project.rootDir.path&#125;/buildLib.gradle&quot;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line"><span class="comment">//    api project(&quot;:lib:base&quot;)</span></span><br><span class="line">    api Config.depConfig.lib.base.dep</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//gradle-wrapper.properties版本 5.4.1</span></span><br><span class="line"><span class="comment">//根目录 build.gradle</span></span><br><span class="line">GLog.d(project.toString() + <span class="string">&quot; -&gt; root&quot;</span>)</span><br><span class="line"><span class="comment">// Top-level build file where you can add configuration options common to all sub-projects/modules.</span></span><br><span class="line"></span><br><span class="line">buildscript &#123;</span><br><span class="line">    ext.kotlin_version = <span class="string">&#x27;1.3.10&#x27;</span></span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">&#x27;com.android.tools.build:gradle:3.5.2&#x27;</span></span><br><span class="line">        classpath <span class="string">&quot;org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version&quot;</span></span><br><span class="line"><span class="comment">//        classpath Config.depConfig.plugin.gradle</span></span><br><span class="line"><span class="comment">//        classpath Config.depConfig.plugin.kotlin</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> Do not place your application dependencies here; they belong</span></span><br><span class="line">        <span class="comment">// in the individual module build.gradle files</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task clean(<span class="attr">type:</span> Delete) &#123;</span><br><span class="line">    delete rootProject.buildDir</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根目录的 buildApp.gradle</span></span><br><span class="line">GLog.d(project.toString() + <span class="string">&quot; -&gt; app&quot;</span>)</span><br><span class="line"></span><br><span class="line">apply &#123;</span><br><span class="line">    plugin <span class="string">&#x27;com.android.application&#x27;</span></span><br><span class="line">    plugin <span class="string">&#x27;kotlin-android&#x27;</span></span><br><span class="line">    plugin <span class="string">&#x27;kotlin-android-extensions&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion Config.compileSdkVersion</span><br><span class="line">    <span class="comment">//buildToolsVersion Config.buildToolsVersion</span></span><br><span class="line"></span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        applicationId Config.applicationId</span><br><span class="line">        minSdkVersion Config.minSdkVersion</span><br><span class="line">        targetSdkVersion Config.targetSdkVersion</span><br><span class="line">        versionCode Config.versionCode</span><br><span class="line">        versionName Config.versionName</span><br><span class="line">        multiDexEnabled <span class="literal">true</span></span><br><span class="line">        resValue <span class="string">&quot;string&quot;</span>, <span class="string">&quot;app_name&quot;</span>, Config.appName + suffix</span><br><span class="line">        testInstrumentationRunner <span class="string">&quot;androidx.test.runner.AndroidJUnitRunner&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        debug &#123;</span><br><span class="line">            minifyEnabled <span class="literal">false</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-android-optimize.txt&#x27;</span>), <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="literal">true</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-android-optimize.txt&#x27;</span>), <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    packagingOptions&#123;</span><br><span class="line">        exclude <span class="string">&quot;META-INF/*&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dexOptions&#123;</span><br><span class="line">        preDexLibraries <span class="literal">true</span></span><br><span class="line">        javaMaxHeapSize <span class="string">&quot;8g&quot;</span></span><br><span class="line">        maxProcessCount <span class="number">8</span></span><br><span class="line">        dexInProcess <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line"><span class="comment">//    implementation fileTree(dir: &#x27;libs&#x27;, include: [&#x27;*.jar&#x27;])</span></span><br><span class="line"><span class="comment">//    implementation &quot;org.jetbrains.kotlin:kotlin-stdlib-jdk7:$kotlin_version&quot;</span></span><br><span class="line"><span class="comment">//    implementation &#x27;androidx.appcompat:appcompat:1.0.2&#x27;</span></span><br><span class="line"><span class="comment">//    implementation &#x27;androidx.core:core-ktx:1.0.2&#x27;</span></span><br><span class="line"><span class="comment">//    implementation &#x27;androidx.constraintlayout:constraintlayout:1.1.3&#x27;</span></span><br><span class="line"><span class="comment">//    testImplementation &#x27;junit:junit:4.12&#x27;</span></span><br><span class="line"><span class="comment">//    androidTestImplementation &#x27;androidx.test.ext:junit:1.1.1&#x27;</span></span><br><span class="line"><span class="comment">//    androidTestImplementation &#x27;androidx.test.espresso:espresso-core:3.2.0&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//leakCanary</span></span><br><span class="line">    debugImplementation Config.depConfig.leakcanary.android.dep</span><br><span class="line">    debugImplementation Config.depConfig.leakcanary.support_fragment.dep</span><br><span class="line">    releaseImplementation Config.depConfig.leakcanary.android_no_op.dep</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据Config.pkgConfig来依赖所有pkg</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">def</span> <span class="attr">entrySet:</span> ConfigUtils.getApplyPkgs().entrySet())&#123;</span><br><span class="line">        api entrySet.value.dep</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取模块名</span></span><br><span class="line"><span class="keyword">def</span> getSuffix()&#123;</span><br><span class="line">    <span class="keyword">if</span>(project.path == <span class="string">&quot;:feature:launcher:app&quot;</span>) <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> project.path.replace(<span class="string">&quot;:&quot;</span>, <span class="string">&quot;_&quot;</span>).substring(<span class="string">&quot;:feature&quot;</span>.length(), project.path.length() - <span class="string">&quot;:app&quot;</span>.length())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根目录的 buildLib.gradle</span></span><br><span class="line">apply &#123;</span><br><span class="line">    plugin <span class="string">&quot;com.android.library&quot;</span></span><br><span class="line">    plugin <span class="string">&quot;kotlin-android&quot;</span></span><br><span class="line">    plugin <span class="string">&quot;kotlin-android-extensions&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion Config.compileSdkVersion</span><br><span class="line"></span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        minSdkVersion Config.minSdkVersion</span><br><span class="line">        versionCode Config.versionCode</span><br><span class="line">        versionName Config.versionName</span><br><span class="line"></span><br><span class="line">        consumerProguardFiles <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="literal">false</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-android-optimize.txt&#x27;</span>), <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lintOptions &#123;</span><br><span class="line">        abortOnError <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    <span class="comment">//pkg 模块依赖所有 export，以及 export 依赖 common 的代码</span></span><br><span class="line">    <span class="keyword">if</span> (project.name == <span class="string">&#x27;pkg&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// if module&#x27;s name equals &#x27;pkg&#x27;, api all of export</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">def</span> <span class="attr">entrySet :</span> ConfigUtils.getApplyExports().entrySet()) &#123;</span><br><span class="line">            api entrySet.value.dep</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (project.name == <span class="string">&#x27;export&#x27;</span>) &#123;</span><br><span class="line">        api Config.depConfig.lib.common.dep</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根目录的 settings.gradle</span></span><br><span class="line">GLog.d(<span class="string">&quot;setting.gradle&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//解放Gradle--》setting.gradle解放</span></span><br><span class="line">ConfigUtils.addBuildListener(gradle)</span><br><span class="line"></span><br><span class="line"><span class="comment">//在 ConfigUtils.groovy 中的 addBuildListener 内 settingsEvaluated 的里配置</span></span><br><span class="line"><span class="comment">//include &#x27;:lib:base&#x27;, &#x27;:lib:common&#x27;,</span></span><br><span class="line"><span class="comment">//        &#x27;:feature:feature0:export&#x27;, &#x27;:feature:feature1:export&#x27;,</span></span><br><span class="line"><span class="comment">//        &#x27;:feature:feature0:pkg&#x27;, &#x27;:feature:feature1:pkg&#x27;,</span></span><br><span class="line"><span class="comment">//        &#x27;:feature:feature0:app&#x27;, &#x27;:feature:feature1:app&#x27;</span></span><br></pre></td></tr></table></figure>



<hr>
<h1 id="原文：AucFrame-之解放-Gradle"><a href="#原文：AucFrame-之解放-Gradle" class="headerlink" title="原文：AucFrame 之解放 Gradle"></a>原文：AucFrame 之解放 Gradle</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>上一节统一管理 Gradle 中，我们在 <code>export</code>、<code>pkg</code>、<code>app</code> 中的 <code>build.gradle</code> 重复做着相似的事情，其实只要架构确定，我们完全可以动态写入，这里，我们就要利用一下 <code>gradle.addBuildListener</code> 这个 hook。Gradle 生命周期第一步就是执行 <code>setting.gradle</code> 中的内容，我们在此植入该 hook 即可。</p>
<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><h3 id="解放-setting-gradle-1"><a href="#解放-setting-gradle-1" class="headerlink" title="解放 setting.gradle"></a>解放 setting.gradle</h3><p><code>setting.gradle</code> 可以访问到 <code>buildSrc</code> 吗，答案是肯定的。</p>
<p>我们在此之前，先写一个日志工具方便我们了解具体生命周期，我这里提供一个实用的 <code>GLog.groovy</code>，具体可以在源码中查阅，输出是带边框的哦。</p>
<p>接下来，我们在 <code>buildSrc</code> 中创建 <code>ConfigUtils.groovy</code> 来做 Gradle 生命周期的 hook，源码如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.gradle.BuildListener</span><br><span class="line"><span class="keyword">import</span> org.gradle.BuildResult</span><br><span class="line"><span class="keyword">import</span> org.gradle.api.initialization.Settings</span><br><span class="line"><span class="keyword">import</span> org.gradle.api.invocation.Gradle</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConfigUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> addBuildListener(Gradle g) &#123;</span><br><span class="line">        g.addBuildListener(<span class="keyword">new</span> BuildListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="type">void</span> buildStarted(Gradle gradle) &#123;</span><br><span class="line">                GLog.d(<span class="string">&quot;buildStarted&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="type">void</span> settingsEvaluated(Settings settings) &#123;</span><br><span class="line">                GLog.d(<span class="string">&quot;settingsEvaluated&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="type">void</span> projectsLoaded(Gradle gradle) &#123;</span><br><span class="line">                GLog.d(<span class="string">&quot;projectsLoaded&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="type">void</span> projectsEvaluated(Gradle gradle) &#123;</span><br><span class="line">                GLog.d(<span class="string">&quot;projectsEvaluated&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="type">void</span> buildFinished(BuildResult buildResult) &#123;</span><br><span class="line">                GLog.d(<span class="string">&quot;buildFinished&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们在 <code>setting.gradle</code> 中写入如下内容：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GLog.d(<span class="string">&quot;setting.gradle&quot;</span>)</span><br><span class="line"></span><br><span class="line">ConfigUtils.addBuildListener(gradle)</span><br><span class="line"></span><br><span class="line">include <span class="string">&#x27;:lib:base&#x27;</span>, <span class="string">&#x27;:lib:common&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;:feature:feature0:export&#x27;</span>, <span class="string">&#x27;:feature:feature1:export&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;:feature:feature0:pkg&#x27;</span>, <span class="string">&#x27;:feature:feature1:pkg&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;:feature:feature0:app&#x27;</span>, <span class="string">&#x27;:feature:feature1:app&#x27;</span>, <span class="string">&#x27;:feature:launcher:app&#x27;</span></span><br></pre></td></tr></table></figure>

<p>在根目录下的 <code>build.gradle</code>、<code>buildApp.gradle</code>、<code>buildLib.gradle</code> 在首行分别加入如下内容：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GLog.d(project.toString() + <span class="string">&quot; -&gt; root&quot;</span>)</span><br><span class="line">GLog.d(project.toString() + <span class="string">&quot; -&gt; app&quot;</span>)</span><br><span class="line">GLog.d(project.toString() + <span class="string">&quot; -&gt; lib&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>然后执行 <code>./gradlew clean</code> 命令，输出如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">setting.gradle</span><br><span class="line">settingsEvaluated</span><br><span class="line">projectsLoaded</span><br><span class="line">root project <span class="string">&#x27;AucFrameTemplate&#x27;</span> -&gt; root</span><br><span class="line">project <span class="string">&#x27;:lib:base&#x27;</span> -&gt; lib</span><br><span class="line">project <span class="string">&#x27;:lib:common&#x27;</span> -&gt; lib</span><br><span class="line">project <span class="string">&#x27;:feature:feature0:app&#x27;</span> -&gt; app</span><br><span class="line">project <span class="string">&#x27;:feature:feature0:export&#x27;</span> -&gt; lib</span><br><span class="line">project <span class="string">&#x27;:feature:feature0:pkg&#x27;</span> -&gt; lib</span><br><span class="line">project <span class="string">&#x27;:feature:feature1:app&#x27;</span> -&gt; app</span><br><span class="line">project <span class="string">&#x27;:feature:feature1:export&#x27;</span> -&gt; lib</span><br><span class="line">project <span class="string">&#x27;:feature:feature1:pkg&#x27;</span> -&gt; lib</span><br><span class="line">project <span class="string">&#x27;:feature:launcher:app&#x27;</span> -&gt; app</span><br><span class="line">projectsEvaluated</span><br><span class="line">buildFinished</span><br></pre></td></tr></table></figure>

<p>这里我们可以看到其具体生命周期，基于此，我们可以在 <code>settingsEvaluated</code> 中做 <code>setting.gradle</code> 的任务可以解放 <code>setting.gradle</code>，具体如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// setting.gradle</span></span><br><span class="line">ConfigUtils.addBuildListener(gradle)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ConfigUtils.groovy</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="type">void</span> settingsEvaluated(Settings settings) &#123;</span><br><span class="line">    GLog.d(<span class="string">&quot;settingsEvaluated&quot;</span>)</span><br><span class="line">    includeModule(settings)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> includeModule(Settings settings) &#123;</span><br><span class="line">    settings.include <span class="string">&#x27;:lib:base&#x27;</span>, <span class="string">&#x27;:lib:common&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;:feature:feature0:export&#x27;</span>, <span class="string">&#x27;:feature:feature1:export&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;:feature:feature0:pkg&#x27;</span>, <span class="string">&#x27;:feature:feature1:pkg&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;:feature:feature0:app&#x27;</span>, <span class="string">&#x27;:feature:feature1:app&#x27;</span>, <span class="string">&#x27;:feature:launcher:app&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="解放-build-gradle"><a href="#解放-build-gradle" class="headerlink" title="解放 build.gradle"></a>解放 build.gradle</h3><p>我们还要解放 module 中的 <code>build.gradle</code>，我们可以利用 <code>projectsLoaded</code> 这个 hook，在其中加入如下代码：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="type">void</span> projectsLoaded(Gradle gradle) &#123;</span><br><span class="line">    GLog.d(<span class="string">&quot;projectsLoaded&quot;</span>)</span><br><span class="line">    gradle.addProjectEvaluationListener(<span class="keyword">new</span> ProjectEvaluationListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="type">void</span> beforeEvaluate(Project project) &#123;</span><br><span class="line">            GLog.d(<span class="string">&quot;beforeEvaluate&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="type">void</span> afterEvaluate(Project project, ProjectState projectState) &#123;</span><br><span class="line">            GLog.d(<span class="string">&quot;afterEvaluate&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次执行 <code>./gradlew clean</code>，会发现 <code>beforeEvaluate</code> 执行在各 module 的 <code>build.gradle</code> 之前，<code>afterEvaluate</code> 在之后，基于此，我们也就可以想到把开头的 apply 都放到这里来了，具体如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ConfigUtils.groovy</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="type">void</span> projectsLoaded(Gradle gradle) &#123;</span><br><span class="line">    GLog.d(<span class="string">&quot;projectsLoaded&quot;</span>)</span><br><span class="line">    gradle.addProjectEvaluationListener(<span class="keyword">new</span> ProjectEvaluationListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="type">void</span> beforeEvaluate(Project project) &#123;</span><br><span class="line">            <span class="keyword">if</span> (project.subprojects.isEmpty()) &#123;<span class="comment">// 定位到具体 project</span></span><br><span class="line">                <span class="keyword">if</span> (project.name == <span class="string">&quot;app&quot;</span>) &#123;</span><br><span class="line">                    GLog.l(project.toString() + <span class="string">&quot; applies buildApp.gradle&quot;</span>)</span><br><span class="line">                    project.apply &#123;</span><br><span class="line">                        from <span class="string">&quot;$&#123;project.rootDir.path&#125;/buildApp.gradle&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    GLog.l(project.toString() + <span class="string">&quot; applies buildLib.gradle&quot;</span>)</span><br><span class="line">                    project.apply &#123;</span><br><span class="line">                        from <span class="string">&quot;$&#123;project.rootDir.path&#125;/buildLib.gradle&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="type">void</span> afterEvaluate(Project project, ProjectState projectState) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到在 <code>beforeEvaluate</code> 中对 app 我们已经 <code>apply buildApp.gradle</code> 了，对 <code>lib</code> 做了 <code>apply buildLib.gradle</code>了，现在可以把各个 module 首行的 apply 都可以删去了，然后 Gradle 同步下项目查看是否成功。</p>
<p>现在 feature 下的各 module 中的 <code>build.gradle</code> 只剩下 <code>dependencies</code> 域了，现在让我们把它也去除。</p>
<p>我们考虑下是否可以把 setting 中 include 各个 project 也放到 Config 中的 <code>depConfig</code> 呢，而且支持开关配置和远程仓库的切换？接下来就让我们骚操作一番。</p>
<p><strong>下面是干货</strong><br> <strong>下面是干货</strong><br> <strong>下面是干货</strong></p>
<p>我们建立一个 <code>DepConfig.groovy</code> 来记录各个库的属性，具体如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DepConfig</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> useLocal <span class="comment">// 是否使用本地的</span></span><br><span class="line">    String localPath <span class="comment">// 本地路径</span></span><br><span class="line">    String remotePath<span class="comment">// 远程路径</span></span><br><span class="line">    <span class="type">boolean</span> isApply  <span class="comment">// 是否应用</span></span><br><span class="line">    String path      <span class="comment">// 最后的路径</span></span><br><span class="line">    <span class="keyword">def</span> dep          <span class="comment">// 根据条件生成项目最终的依赖项</span></span><br><span class="line"></span><br><span class="line">    DepConfig(String path) &#123;</span><br><span class="line">        <span class="variable language_">this</span>(path, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DepConfig(String path, <span class="type">boolean</span> isApply) &#123;</span><br><span class="line">        <span class="keyword">if</span> (path.startsWith(<span class="string">&quot;:&quot;</span>)) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.useLocal = <span class="literal">true</span></span><br><span class="line">            <span class="variable language_">this</span>.localPath = path</span><br><span class="line">            <span class="variable language_">this</span>.isApply = isApply</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.useLocal = <span class="literal">false</span></span><br><span class="line">            <span class="variable language_">this</span>.remotePath = path</span><br><span class="line">            <span class="variable language_">this</span>.isApply = isApply</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.path = path</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DepConfig(<span class="type">boolean</span> useLocal, String localPath, String remotePath) &#123;</span><br><span class="line">        <span class="variable language_">this</span>(useLocal, localPath, remotePath, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DepConfig(<span class="type">boolean</span> useLocal, String localPath, String remotePath, <span class="type">boolean</span> isApply) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.useLocal = useLocal</span><br><span class="line">        <span class="variable language_">this</span>.localPath = localPath</span><br><span class="line">        <span class="variable language_">this</span>.remotePath = remotePath</span><br><span class="line">        <span class="variable language_">this</span>.isApply = isApply</span><br><span class="line">        <span class="variable language_">this</span>.path = useLocal ? localPath : remotePath</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    String toString() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;DepConfig &#123; &quot;</span> +</span><br><span class="line">                <span class="string">&quot;useLocal = &quot;</span> + useLocal +</span><br><span class="line">                (dep == <span class="literal">null</span> ? <span class="string">&quot;, path = &quot;</span> + path : (<span class="string">&quot;, dep = &quot;</span> + dep)) +</span><br><span class="line">                <span class="string">&quot;, isApply = &quot;</span> + isApply +</span><br><span class="line">                <span class="string">&quot; &#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面我们来改造 <code>Config.depConfig</code>，改为如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// appConfig 配置的是可以跑 app 的模块，git 提交务必只包含 launcher</span></span><br><span class="line"><span class="keyword">static</span> appConfig = [<span class="string">&#x27;launcher&#x27;</span>, <span class="string">&#x27;feature0&#x27;</span>]</span><br><span class="line"><span class="comment">// pkgConfig 配置的是要依赖的功能包，为空则依赖全部，git 提交务必为空</span></span><br><span class="line"><span class="keyword">static</span> pkgConfig = [<span class="string">&#x27;feature0&#x27;</span>]</span><br><span class="line"><span class="keyword">static</span> depConfig = [</span><br><span class="line">        <span class="attr">feature      :</span> [</span><br><span class="line">                <span class="symbol">launcher:</span> [</span><br><span class="line">                        <span class="symbol">app:</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;:feature:launcher:app&quot;</span>)</span><br><span class="line">                ],</span><br><span class="line">                <span class="symbol">feature0:</span> [</span><br><span class="line">                        <span class="attr">app   :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;:feature:feature0:app&quot;</span>),</span><br><span class="line">                        <span class="attr">pkg   :</span> <span class="keyword">new</span> DepConfig(<span class="literal">true</span>, <span class="string">&quot;:feature:feature0:pkg&quot;</span>, <span class="string">&quot;com.blankj:feature-feature0-pkg:1.0&quot;</span>, <span class="literal">true</span>),</span><br><span class="line">                        <span class="symbol">export:</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;:feature:feature0:export&quot;</span>),</span><br><span class="line">                ],</span><br><span class="line">                <span class="symbol">feature1:</span> [</span><br><span class="line">                        <span class="attr">app   :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;:feature:feature1:app&quot;</span>),</span><br><span class="line">                        <span class="attr">pkg   :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;:feature:feature1:pkg&quot;</span>),</span><br><span class="line">                        <span class="symbol">export:</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;:feature:feature1:export&quot;</span>),</span><br><span class="line">                ],</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">lib          :</span> [</span><br><span class="line">                <span class="attr">base  :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;:lib:base&quot;</span>),</span><br><span class="line">                <span class="symbol">common:</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;:lib:common&quot;</span>),</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">support      :</span> [</span><br><span class="line">                <span class="symbol">appcompat_v7:</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;com.android.support:appcompat-v7:$support_version&quot;</span>),</span><br><span class="line">                <span class="attr">design      :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;com.android.support:design:$support_version&quot;</span>),</span><br><span class="line">                <span class="attr">multidex    :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;com.android.support:multidex:1.0.2&quot;</span>),</span><br><span class="line">                <span class="attr">constraint  :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;com.android.support.constraint:constraint-layout:1.1.3&quot;</span>),</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">kotlin       :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;org.jetbrains.kotlin:kotlin-stdlib-jdk7:$kotlin_version&quot;</span>),</span><br><span class="line">        <span class="attr">utilcode     :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;com.blankj:utilcode:1.25.0&quot;</span>),</span><br><span class="line">        <span class="symbol">free_proguard:</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;com.blankj:free-proguard:1.0.1&quot;</span>),</span><br><span class="line">        <span class="attr">swipe_panel  :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;com.blankj:swipe-panel:1.1&quot;</span>),</span><br><span class="line">        <span class="attr">leakcanary   :</span> [</span><br><span class="line">                <span class="attr">android         :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;com.squareup.leakcanary:leakcanary-android:$leakcanary_version&quot;</span>),</span><br><span class="line">                <span class="attr">android_no_op   :</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;com.squareup.leakcanary:leakcanary-android-no-op:$leakcanary_version&quot;</span>),</span><br><span class="line">                <span class="symbol">support_fragment:</span> <span class="keyword">new</span> DepConfig(<span class="string">&quot;com.squareup.leakcanary:leakcanary-support-fragment:$leakcanary_version&quot;</span>),</span><br><span class="line">        ],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p><code>Config.appConfig</code> 和 <code>Config.pkgConfig</code> 通过注释我已经说明得很清楚了，它们是方便我们切换工程属性的两个配置，对单模块调试或者多模块联合开发有很大的帮助。</p>
<p>后面的 <code>Config.depConfig</code> 已经从简单的 <code>String</code> 类型切换到了 <code>DepConfig</code>，我们以最复杂的 <code>:feature:feature0:pkg</code> 为例，它的配置是 <code>new DepConfig(true, &quot;:feature:feature0:pkg&quot;, &quot;com.blankj:feature-feature0-pkg:1.0&quot;, true)</code>，其参数意思在 <code>DepConfig</code> 中已经说明了，我这边再完整说一下，最后的参数 <code>isApply</code> 代表是否开启依赖，开启的话就会依赖到项目中，否则是不会依赖到项目中的，第一个参数是是否使用本地源码，如果为 <code>true</code>，那么就会使用第二个参数的本地 module 路径，否则就会使用第三个参数的远程依赖路径（com.blankj:feature-feature0-pkg:1.0 仓库并不存在，这里只是为了说明）。还存在一个问题就是，此时我们 <code>DepConfig</code> 中的本地 module 路径中只是个普通字符串，并不是我们 dependencies 中需要的 project 类型，这里我们需要在 <code>projectsLoaded</code> 中做一下处理，然后把最终的依赖赋值给 <code>DepConfig.dep</code>，最终让 dependencies 中所有都依赖 <code>DepConfig.dep</code>，下面是 <code>ConfigUtils</code> 中最主要的实现：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="type">void</span> settingsEvaluated(Settings settings) &#123;</span><br><span class="line">    GLog.d(<span class="string">&quot;settingsEvaluated&quot;</span>)</span><br><span class="line">    includeModule(settings)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在 settings.gradle 中 根据 appConfig 和 pkgConfig 来 include 本地模块</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> includeModule(Settings settings) &#123;</span><br><span class="line">    <span class="keyword">def</span> config = getDepConfigByFilter(<span class="keyword">new</span> DepConfigFilter() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="type">boolean</span> accept(String name, DepConfig config) &#123;</span><br><span class="line">            <span class="keyword">if</span> (name.endsWith(<span class="string">&#x27;.app&#x27;</span>)) &#123;<span class="comment">// 如果最终是 app 的话</span></span><br><span class="line">                <span class="keyword">def</span> appName = name.substring(<span class="string">&#x27;feature.&#x27;</span>.length(), name.length() - <span class="number">4</span>)<span class="comment">// 获取 app 模块的名字</span></span><br><span class="line">                <span class="keyword">if</span> (!Config.appConfig.contains(appName)) &#123;<span class="comment">// 如果 Config.appConfig 中不存在，那就不让它进依赖</span></span><br><span class="line">                    config.isApply = <span class="literal">false</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!Config.pkgConfig.isEmpty()) &#123;<span class="comment">// 如果 Config.pkgConfig 不为空，说明是 pkg 调试模式</span></span><br><span class="line">                <span class="keyword">if</span> (name.endsWith(<span class="string">&#x27;.pkg&#x27;</span>)) &#123;<span class="comment">// 如果是 pkg 的话</span></span><br><span class="line">                    <span class="keyword">def</span> pkgName = name.substring(<span class="string">&#x27;feature.&#x27;</span>.length(), name.length() - <span class="number">4</span>)<span class="comment">// 获取 pkg 模块的名字</span></span><br><span class="line">                    <span class="keyword">if</span> (!Config.pkgConfig.contains(pkgName)) &#123;<span class="comment">// 如果 Config.pkgConfig 中不存在，那就不让它进依赖</span></span><br><span class="line">                        config.isApply = <span class="literal">false</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 过滤出本地并且 apply 的模块</span></span><br><span class="line">            <span class="keyword">if</span> (!config.isApply) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            <span class="keyword">if</span> (!config.useLocal) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            <span class="keyword">if</span> (config.localPath == <span class="string">&quot;&quot;</span>) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).each &#123; _, cfg -&gt;<span class="comment">// 把本地模块 include 进去</span></span><br><span class="line">        settings.include cfg.localPath</span><br><span class="line">    &#125;</span><br><span class="line">    GLog.l(<span class="string">&quot;includeModule = $&#123;GLog.object2String(config)&#125;&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="type">void</span> projectsLoaded(Gradle gradle) &#123;</span><br><span class="line">    GLog.d(<span class="string">&quot;projectsLoaded&quot;</span>)</span><br><span class="line">    generateDep(gradle)</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据 depConfig 生成 dep</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> generateDep(Gradle gradle) &#123;</span><br><span class="line">    <span class="keyword">def</span> config = getDepConfigByFilter(<span class="keyword">new</span> DepConfigFilter() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="type">boolean</span> accept(String name, DepConfig config) &#123;</span><br><span class="line">            <span class="keyword">if</span> (config.useLocal) &#123;<span class="comment">// 如果使用的是本地模块，那么把它转化为 project</span></span><br><span class="line">                config.dep = gradle.rootProject.findProject(config.localPath)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;<span class="comment">// 如果是远端依赖，那就直接使用远端依赖即可</span></span><br><span class="line">                config.dep = config.remotePath</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    GLog.l(<span class="string">&quot;generateDep = $&#123;GLog.object2String(config)&#125;&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据过滤器来获取 DepConfig</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> Map&lt;String, DepConfig&gt; getDepConfigByFilter(DepConfigFilter filter) &#123;</span><br><span class="line">    <span class="keyword">return</span> _getDepConfigByFilter(<span class="string">&quot;&quot;</span>, Config.depConfig, filter)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> _getDepConfigByFilter(String namePrefix, Map map, DepConfigFilter filter) &#123;</span><br><span class="line">    <span class="keyword">def</span> depConfigList = [:]<span class="comment">// 结果 Map</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry <span class="attr">entry :</span> map.entrySet()) &#123;</span><br><span class="line">        <span class="keyword">def</span> (name, value) = [entry.getKey(), entry.getValue()]</span><br><span class="line">        <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Map) &#123;<span class="comment">// 如果值是 Map 类型就加到结果 Map 中</span></span><br><span class="line">            namePrefix += (name + <span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">            depConfigList.putAll(_getDepConfigByFilter(namePrefix, value, filter))</span><br><span class="line">            namePrefix -= (name + <span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">def</span> config = value <span class="keyword">as</span> DepConfig</span><br><span class="line">        <span class="keyword">if</span> (filter == <span class="literal">null</span> || filter.accept(namePrefix + name, config)) &#123;</span><br><span class="line">            depConfigList.put(namePrefix + name, config)<span class="comment">// 符合过滤条件就加到结果 Map 中</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> depConfigList</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">DepConfigFilter</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> accept(String name, DepConfig config);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释已经把关键的地方写得很清楚了，下面我们就可以来做取消 feature 中各模块的 dependencies 了，我们在 <code>ConfigUtils</code> 添加获取可用的 <code>pkg</code> 和 <code>export</code> 的代码：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> getApplyPkgs() &#123;</span><br><span class="line">    <span class="keyword">def</span> applyPkgs = getDepConfigByFilter(<span class="keyword">new</span> DepConfigFilter() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="type">boolean</span> accept(String name, DepConfig config) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!config.isApply) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            <span class="keyword">return</span> name.endsWith(<span class="string">&quot;.pkg&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    GLog.d(<span class="string">&quot;getApplyPkgs = $&#123;GLog.object2String(applyPkgs)&#125;&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> applyPkgs</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> getApplyExports() &#123;</span><br><span class="line">    <span class="keyword">def</span> applyExports = getDepConfigByFilter(<span class="keyword">new</span> DepConfigFilter() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="type">boolean</span> accept(String name, DepConfig config) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!config.isApply) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            <span class="keyword">return</span> name.endsWith(<span class="string">&quot;.export&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    GLog.d(<span class="string">&quot;getApplyExports = $&#123;GLog.object2String(applyExports)&#125;&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> applyExports</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在 <code>buildApp.gradle</code> 中的 dependencie 中把之前的依赖最后加 <code>.dep</code>，并加入依赖所有可用 <code>pkg</code> 的代码：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    <span class="comment">// LeakCanary</span></span><br><span class="line">    debugImplementation Config.depConfig.leakcanary.android.dep</span><br><span class="line">    debugImplementation Config.depConfig.leakcanary.support_fragment.dep</span><br><span class="line">    releaseImplementation Config.depConfig.leakcanary.android_no_op.dep</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据 Config.pkgConfig 来依赖所有 pkg</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">def</span> <span class="attr">entrySet :</span> ConfigUtils.getApplyPkgs().entrySet()) &#123;</span><br><span class="line">        api entrySet.value.dep</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在 <code>buildLib.gradle</code> 中的 dependencie 中加入如下 pkg 模块依赖所有 export，以及 export 依赖 common 的代码：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    <span class="keyword">if</span> (project.name == <span class="string">&#x27;pkg&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// if module&#x27;s name equals &#x27;pkg&#x27;, api all of export</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">def</span> <span class="attr">entrySet :</span> ConfigUtils.getApplyExports().entrySet()) &#123;</span><br><span class="line">            api entrySet.value.dep</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (project.name == <span class="string">&#x27;export&#x27;</span>) &#123;</span><br><span class="line">        api Config.depConfig.lib.common.dep</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后，我们就可以清空 feature 中所有的 <code>build.gradle</code> 中的 <code>dependencies</code> 域了，然后把 <code>common</code> 中依赖 <code>base</code> 的模块更新为 <code>Config.depConfig.lib.base.dep</code>，把 <code>base</code> 的 <code>dependencies</code> 中都加入 <code>.dep</code> 后缀，具体如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// common</span></span><br><span class="line">dependencies &#123;</span><br><span class="line">    api Config.depConfig.lib.base.dep</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// base</span></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation fileTree(<span class="attr">include:</span> [<span class="string">&#x27;*.jar&#x27;</span>], <span class="attr">dir:</span> <span class="string">&#x27;libs&#x27;</span>)</span><br><span class="line">    api Config.depConfig.utilcode.dep.dep</span><br><span class="line">    api Config.depConfig.free_proguard.dep</span><br><span class="line">    api Config.depConfig.swipe_panel.dep</span><br><span class="line"></span><br><span class="line">    api Config.depConfig.support.appcompat_v7.dep</span><br><span class="line">    api Config.depConfig.support.design.dep</span><br><span class="line">    api Config.depConfig.support.multidex.dep</span><br><span class="line">    api Config.depConfig.support.constraint.dep</span><br><span class="line">    api Config.depConfig.kotlin.dep</span><br><span class="line">    compileOnly Config.depConfig.leakcanary.android_no_op.dep</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到此，我们的 Gradle 已经完全解放了，我们 Gradle 同步一下，正常情况是不会出错的，有问题的话可以参考源码查找差异点，我们运行一下 <code>./gradlew clean</code>，可以发现我写的 <code>ConfigUtils</code> 中写的日志还是很有帮助的哦，具体如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">│ settingsEvaluated</span><br><span class="line">└────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">│ includeModule = [</span><br><span class="line">│         feature.launcher.<span class="attr">app      :</span> DepConfig &#123; useLocal = <span class="literal">true</span>, path = :<span class="attr">feature:</span><span class="attr">launcher:</span>app, isApply = <span class="literal">true</span> &#125;,</span><br><span class="line">│         feature.feature0.<span class="attr">pkg      :</span> DepConfig &#123; useLocal = <span class="literal">true</span>, path = :<span class="attr">feature:</span><span class="attr">feature0:</span>pkg, isApply = <span class="literal">true</span> &#125;,</span><br><span class="line">│         feature.feature0.<span class="attr">export   :</span> DepConfig &#123; useLocal = <span class="literal">true</span>, path = :<span class="attr">feature:</span><span class="attr">feature0:</span>export, isApply = <span class="literal">true</span> &#125;,</span><br><span class="line">│         feature.feature1.<span class="attr">pkg      :</span> DepConfig &#123; useLocal = <span class="literal">true</span>, path = :<span class="attr">feature:</span><span class="attr">feature1:</span>pkg, isApply = <span class="literal">true</span> &#125;,</span><br><span class="line">│         feature.feature1.<span class="attr">export   :</span> DepConfig &#123; useLocal = <span class="literal">true</span>, path = :<span class="attr">feature:</span><span class="attr">feature1:</span>export, isApply = <span class="literal">true</span> &#125;,</span><br><span class="line">│         lib.<span class="attr">base                  :</span> DepConfig &#123; useLocal = <span class="literal">true</span>, path = :<span class="attr">lib:</span>base, isApply = <span class="literal">true</span> &#125;,</span><br><span class="line">│         lib.<span class="attr">common                :</span> DepConfig &#123; useLocal = <span class="literal">true</span>, path = :<span class="attr">lib:</span>common, isApply = <span class="literal">true</span> &#125;</span><br><span class="line">│ ]</span><br><span class="line">└────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">│ projectsLoaded</span><br><span class="line">└────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">│ generateDep = [</span><br><span class="line">│         feature.launcher.<span class="attr">app      :</span> DepConfig &#123; useLocal = <span class="literal">true</span>, dep = project <span class="string">&#x27;:feature:launcher:app&#x27;</span>, isApply = <span class="literal">true</span> &#125;,</span><br><span class="line">│         feature.feature0.<span class="attr">app      :</span> DepConfig &#123; useLocal = <span class="literal">true</span>, path = :<span class="attr">feature:</span><span class="attr">feature0:</span>app, isApply = <span class="literal">false</span> &#125;,</span><br><span class="line">│         feature.feature0.<span class="attr">pkg      :</span> DepConfig &#123; useLocal = <span class="literal">true</span>, dep = project <span class="string">&#x27;:feature:feature0:pkg&#x27;</span>, isApply = <span class="literal">true</span> &#125;,</span><br><span class="line">│         feature.feature0.<span class="attr">export   :</span> DepConfig &#123; useLocal = <span class="literal">true</span>, dep = project <span class="string">&#x27;:feature:feature0:export&#x27;</span>, isApply = <span class="literal">true</span> &#125;,</span><br><span class="line">│         feature.feature1.<span class="attr">app      :</span> DepConfig &#123; useLocal = <span class="literal">true</span>, path = :<span class="attr">feature:</span><span class="attr">feature1:</span>app, isApply = <span class="literal">false</span> &#125;,</span><br><span class="line">│         feature.feature1.<span class="attr">pkg      :</span> DepConfig &#123; useLocal = <span class="literal">true</span>, dep = project <span class="string">&#x27;:feature:feature1:pkg&#x27;</span>, isApply = <span class="literal">true</span> &#125;,</span><br><span class="line">│         feature.feature1.<span class="attr">export   :</span> DepConfig &#123; useLocal = <span class="literal">true</span>, dep = project <span class="string">&#x27;:feature:feature1:export&#x27;</span>, isApply = <span class="literal">true</span> &#125;,</span><br><span class="line">│         lib.<span class="attr">base                  :</span> DepConfig &#123; useLocal = <span class="literal">true</span>, dep = project <span class="string">&#x27;:lib:base&#x27;</span>, isApply = <span class="literal">true</span> &#125;,</span><br><span class="line">│         lib.<span class="attr">common                :</span> DepConfig &#123; useLocal = <span class="literal">true</span>, dep = project <span class="string">&#x27;:lib:common&#x27;</span>, isApply = <span class="literal">true</span> &#125;,</span><br><span class="line">│         support.<span class="attr">appcompat_v7      :</span> DepConfig &#123; useLocal = <span class="literal">false</span>, dep = com.android.<span class="attr">support:</span>appcompat-<span class="attr">v7:</span><span class="number">27.1</span><span class="number">.1</span>, isApply = <span class="literal">true</span> &#125;,</span><br><span class="line">│         support.<span class="attr">design            :</span> DepConfig &#123; useLocal = <span class="literal">false</span>, dep = com.android.<span class="attr">support:</span><span class="attr">design:</span><span class="number">27.1</span><span class="number">.1</span>, isApply = <span class="literal">true</span> &#125;,</span><br><span class="line">│         support.<span class="attr">multidex          :</span> DepConfig &#123; useLocal = <span class="literal">false</span>, dep = com.android.<span class="attr">support:</span><span class="attr">multidex:</span><span class="number">1.0</span><span class="number">.2</span>, isApply = <span class="literal">true</span> &#125;,</span><br><span class="line">│         support.<span class="attr">constraint        :</span> DepConfig &#123; useLocal = <span class="literal">false</span>, dep = com.android.support.<span class="attr">constraint:</span>constraint-<span class="attr">layout:</span><span class="number">1.1</span><span class="number">.3</span>, isApply = <span class="literal">true</span> &#125;,</span><br><span class="line">│         <span class="attr">kotlin                    :</span> DepConfig &#123; useLocal = <span class="literal">false</span>, dep = org.jetbrains.<span class="attr">kotlin:</span>kotlin-stdlib-<span class="attr">jdk7:</span><span class="number">1.3</span><span class="number">.10</span>, isApply = <span class="literal">true</span> &#125;,</span><br><span class="line">│         <span class="attr">utilcode                  :</span> DepConfig &#123; useLocal = <span class="literal">false</span>, dep = com.<span class="attr">blankj:</span><span class="attr">utilcode:</span><span class="number">1.25</span><span class="number">.0</span>, isApply = <span class="literal">true</span> &#125;,</span><br><span class="line">│         <span class="attr">free_proguard             :</span> DepConfig &#123; useLocal = <span class="literal">false</span>, dep = com.<span class="attr">blankj:</span>free-<span class="attr">proguard:</span><span class="number">1.0</span><span class="number">.1</span>, isApply = <span class="literal">true</span> &#125;,</span><br><span class="line">│         <span class="attr">swipe_panel               :</span> DepConfig &#123; useLocal = <span class="literal">false</span>, dep = com.<span class="attr">blankj:</span>swipe-<span class="attr">panel:</span><span class="number">1.1</span>, isApply = <span class="literal">true</span> &#125;,</span><br><span class="line">│         leakcanary.<span class="attr">android        :</span> DepConfig &#123; useLocal = <span class="literal">false</span>, dep = com.squareup.<span class="attr">leakcanary:</span>leakcanary-<span class="attr">android:</span><span class="number">1.6</span><span class="number">.3</span>, isApply = <span class="literal">true</span> &#125;,</span><br><span class="line">│         leakcanary.<span class="attr">android_no_op  :</span> DepConfig &#123; useLocal = <span class="literal">false</span>, dep = com.squareup.<span class="attr">leakcanary:</span>leakcanary-android-no-<span class="attr">op:</span><span class="number">1.6</span><span class="number">.3</span>, isApply = <span class="literal">true</span> &#125;,</span><br><span class="line">│         leakcanary.<span class="attr">support_fragment:</span> DepConfig &#123; useLocal = <span class="literal">false</span>, dep = com.squareup.<span class="attr">leakcanary:</span>leakcanary-support-<span class="attr">fragment:</span><span class="number">1.6</span><span class="number">.3</span>, isApply = <span class="literal">true</span> &#125;</span><br><span class="line">│ ]</span><br><span class="line">└────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">│ project <span class="string">&#x27;:lib:base&#x27;</span> applies buildLib.gradle</span><br><span class="line">└────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">│ project <span class="string">&#x27;:lib:common&#x27;</span> applies buildLib.gradle</span><br><span class="line">└────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">│ project <span class="string">&#x27;:feature:feature0:pkg&#x27;</span> applies buildLib.gradle</span><br><span class="line">└────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">│ getApplyExports = [</span><br><span class="line">│         feature.feature0.<span class="attr">export   :</span> DepConfig &#123; useLocal = <span class="literal">true</span>, dep = project <span class="string">&#x27;:feature:feature0:export&#x27;</span>, isApply = <span class="literal">true</span> &#125;,</span><br><span class="line">│         feature.feature1.<span class="attr">export   :</span> DepConfig &#123; useLocal = <span class="literal">true</span>, dep = project <span class="string">&#x27;:feature:feature1:export&#x27;</span>, isApply = <span class="literal">true</span> &#125;</span><br><span class="line">│ ]</span><br><span class="line">└────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">│ project <span class="string">&#x27;:feature:feature1:export&#x27;</span> applies buildLib.gradle</span><br><span class="line">└────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">│ project <span class="string">&#x27;:feature:feature1:pkg&#x27;</span> applies buildLib.gradle</span><br><span class="line">└────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">│ getApplyExports = [</span><br><span class="line">│         feature.feature0.<span class="attr">export   :</span> DepConfig &#123; useLocal = <span class="literal">true</span>, dep = project <span class="string">&#x27;:feature:feature0:export&#x27;</span>, isApply = <span class="literal">true</span> &#125;,</span><br><span class="line">│         feature.feature1.<span class="attr">export   :</span> DepConfig &#123; useLocal = <span class="literal">true</span>, dep = project <span class="string">&#x27;:feature:feature1:export&#x27;</span>, isApply = <span class="literal">true</span> &#125;</span><br><span class="line">│ ]</span><br><span class="line">└────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">│ project <span class="string">&#x27;:feature:launcher:app&#x27;</span> applies buildApp.gradle</span><br><span class="line">└────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">│ getApplyPkgs = [</span><br><span class="line">│         feature.feature0.<span class="attr">pkg      :</span> DepConfig &#123; useLocal = <span class="literal">true</span>, dep = project <span class="string">&#x27;:feature:feature0:pkg&#x27;</span>, isApply = <span class="literal">true</span> &#125;,</span><br><span class="line">│         feature.feature1.<span class="attr">pkg      :</span> DepConfig &#123; useLocal = <span class="literal">true</span>, dep = project <span class="string">&#x27;:feature:feature1:pkg&#x27;</span>, isApply = <span class="literal">true</span> &#125;</span><br><span class="line">│ ]</span><br><span class="line">└────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">│ projectsEvaluated</span><br><span class="line">└────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">│ buildFinished</span><br><span class="line">└────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br></pre></td></tr></table></figure>

<p>看了这个日志岂不美哉哈，现在你可以体验下动态切换 app 和 pkg 的功能了，比如：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">appConfig = [<span class="string">&#x27;launcher&#x27;</span>, <span class="string">&#x27;feature0&#x27;</span>]</span><br><span class="line">pkgConfig = [<span class="string">&#x27;feature0&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>此时我们可以运行 <code>pkg</code> 只包括 <code>feature0</code> 的 <code>launcher-app</code> 和 <code>feature0-app</code>。</p>
<h2 id="维护"><a href="#维护" class="headerlink" title="维护"></a>维护</h2><p>随着业务越来越多，你会发现该种方式比以往的开发效率会高出很多，但随着源码越来越多，如果每个 <code>pkg</code> 和 <code>export</code> 都没有上传到远端仓库的话，跑一次 <code>launcher</code> 的全量包的话需要把所有 <code>pkg</code> 和 <code>export</code> 的源码编译时间加上，为了减少源码的编译时间，我们应该在上线一个版本前，把所有有更新的 <code>pkg</code> 和 <code>export</code> 都上传到远端，然后把 <code>pkg</code> 和 <code>export</code> 的 <code>isLocal</code> 都设置为 <code>false</code> 来依赖远端仓库，这样就大大减少了本地源码编译的时间。在下个版本开始开发的时候，除了我们自己负责的业务，其他业务都是以远端仓库的形式依赖进来，这样在打包的时候就省去了其他业务源码编译的时间，这在业务越来越多的情况下，效率可以有很大的提升。</p>
<p>如果你需要配置每个模块的代码权限，我们可以把每个模块作为一个 git 的 submodule 来使用，这样的话，就更加需要把 <code>pkg</code> 和 <code>export</code> 上传到远端仓库了，否则，在 <code>isLocal = true</code> 的情况下没有源码参与编译就会 GG 了哦。</p>
<h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><p>每次创建一个模块的 <code>app</code>、<code>pkg</code>、<code>export</code> 还是挺麻烦的，我们可以开发一个 IDEL 插件来完成三个模块的创建，由于比较忙，我没有开发，有兴趣的小伙伴可以帮我开发一个造福大家哦。但我在 feature 中为大家提供了 <code>template</code> 目录方便你直接拷贝，然后修改为你的业务名，再修改下包名，最后在 <code>Config.groovy</code> 的 feature 中加入它即可。</p>
<!-- flag of hidden posts -->
      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>请我喝杯奶茶吧~</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt=" WeChat Pay"/>
        <p>WeChat Pay</p>
      </div>
    

    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/private/" rel="tag"># private</a>
          
            <a href="/tags/Gradle/" rel="tag"># Gradle</a>
          
        </div>
      

      
      
      

      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">135</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">38</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="mailto:shenbh@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://blog.csdn.net/ptwenzi?spm=1010.2135.3001.5113" target="_blank" title="CSDN">
                      
                        <i class="fa fa-fw fa-clone"></i>CSDN</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/shenbh" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://gitee.com/shen_bh" target="_blank" title="Gitee">
                      
                        <i class="fa fa-fw fa-git"></i>Gitee</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Auc%E4%B9%8B%E8%A7%A3%E6%94%BE-Gradle"><span class="nav-text">Auc之解放 Gradle</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Gradle-%E7%9A%84-log"><span class="nav-text">Gradle 的 log</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Gradle-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%9A%84-hook"><span class="nav-text">Gradle 生命周期的 hook</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%A3%E6%94%BE-setting-gradle"><span class="nav-text">解放 setting.gradle</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%A3%E6%94%BEmodule%E4%B8%AD%E7%9A%84-build-gradle"><span class="nav-text">解放module中的 build.gradle</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B9%B2%E8%B4%A7%EF%BC%9A%E5%A2%9E%E5%8A%A0ConfigUtils-groovy%E5%92%8CDepConfig-groovy%E6%9D%A5%E8%BF%9B%E4%B8%80%E6%AD%A5%E8%A7%A3%E6%94%BE"><span class="nav-text">干货：增加ConfigUtils.groovy和DepConfig.groovy来进一步解放</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#DepConfig-groovy%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="nav-text">DepConfig.groovy实体类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ConfigUtils-groovy%E8%A7%A3%E6%94%BEsetting-gradle%E5%92%8C%E5%90%84module%E7%9A%84apply%E5%92%8Cdependencies"><span class="nav-text">ConfigUtils.groovy解放setting.gradle和各module的apply和dependencies</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E4%B8%AA%E5%B7%A5%E5%85%B7%E6%96%B9%E6%B3%95"><span class="nav-text">3个工具方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E6%94%BEsettings-gradle"><span class="nav-text">解放settings.gradle</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E6%94%BEmodule%E7%9A%84apply"><span class="nav-text">解放module的apply</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E6%94%BEfeature%E4%B8%8Bbuild-gradle%E4%B8%AD%E7%9A%84dependencies"><span class="nav-text">解放feature下build.gradle中的dependencies</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98"><span class="nav-text">问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81%EF%BC%9A"><span class="nav-text">完整代码：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8E%9F%E6%96%87%EF%BC%9AAucFrame-%E4%B9%8B%E8%A7%A3%E6%94%BE-Gradle"><span class="nav-text">原文：AucFrame 之解放 Gradle</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%83%8C%E6%99%AF"><span class="nav-text">背景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5"><span class="nav-text">实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E6%94%BE-setting-gradle-1"><span class="nav-text">解放 setting.gradle</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E6%94%BE-build-gradle"><span class="nav-text">解放 build.gradle</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%B4%E6%8A%A4"><span class="nav-text">维护</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%98%E5%8C%96"><span class="nav-text">优化</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">阿炳</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('-1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
          if(result)$(this).text('Copied')
          else $(this).text('Copy failed')
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('Copy')
        }, 300)
      }).append(e)
    })
  </script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>