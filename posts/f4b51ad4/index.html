<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="private,安卓优化," />










<meta name="description" content="包体积优化一、瘦身优化及Apk分析方案APK 组成我们都知道，Android 项目最终会编译成一个 .apk 后缀的文件，实际上它就是一个 压缩包。因此，它内部还有很多不同类型的文件，这些文件，按照大小，共分为如下四类：  1）、代码相关：classes.dex，我们在项目中所编写的 java 文件，经过编译之后会生成一个 .class 文件，而这些所有的 .class 文件呢，它最终会经过 dx">
<meta property="og:type" content="article">
<meta property="og:title" content="优化-包体积优化">
<meta property="og:url" content="http://shenbh.github.io/posts/f4b51ad4/index.html">
<meta property="og:site_name" content="AB">
<meta property="og:description" content="包体积优化一、瘦身优化及Apk分析方案APK 组成我们都知道，Android 项目最终会编译成一个 .apk 后缀的文件，实际上它就是一个 压缩包。因此，它内部还有很多不同类型的文件，这些文件，按照大小，共分为如下四类：  1）、代码相关：classes.dex，我们在项目中所编写的 java 文件，经过编译之后会生成一个 .class 文件，而这些所有的 .class 文件呢，它最终会经过 dx">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f084ed7714fe4aa792268c25e0b46bac~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bf06590ab230467793b1b32b91d0d20c~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/83226ad1274d4104a28b88c4f892e6e2~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cbef18bd19ba4997b2b025a2fa51e27f~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d9b1865b4558412c99625aa2baa195c6~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/493a202586fe4ee3825813f88b67b684~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3bc3c755789c459ca6e49f733489bf9d~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/309bb32350264ba6883254355669fd2a~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a5cbb8872294445eb2bef8de3605d87a~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c6de4da9187f4ea1bf7aa14a410953b5~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cd1ed52e19994cf085fb57a32625cdf1~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/245bd93427074030b4f41adc46e55ea0~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1eafd9da99014426b3118168443473b8~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ca10878831a848728a28f589a5569c37~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bb65eca31bbf4c1099bfcda1cf74287e~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a19bf988566e494693a2413a71e363dd~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0a0c556152a945c8a847b5fb6737ee31~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1e134ae18c474d1cbcc522110be213f0~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d952f02035f346e5a092193ff8c7fe4a~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a6eaa9bb40544b4ca512e336ad6384f2~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e55be4c952e04451b22d64b0c84825ec~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d65fc96523f04290a57774fbfa0e349a~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/95614c97a6d141509abd4b9ac5de3f06~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/68836a9c1cdd45e9afa2e387c9c654ff~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="article:published_time" content="2021-07-03T02:31:58.000Z">
<meta property="article:modified_time" content="2022-05-05T06:57:05.448Z">
<meta property="article:author" content="阿炳">
<meta property="article:tag" content="private">
<meta property="article:tag" content="安卓优化">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f084ed7714fe4aa792268c25e0b46bac~tplv-k3u1fbpfcp-zoom-1.image">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://shenbh.github.io/posts/f4b51ad4/"/>





  <title>优化-包体积优化 | AB</title><meta name="robots" content="noindex">
  








<meta name="generator" content="Hexo 6.1.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">AB</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Just do IT Now.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://shenbh.github.io/posts/f4b51ad4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AB">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">优化-包体积优化</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-07-03T10:31:58+08:00">
                2021-07-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="包体积优化"><a href="#包体积优化" class="headerlink" title="包体积优化"></a><a target="_blank" rel="noopener" href="https://juejin.cn/post/6872920643797680136">包体积优化</a></h1><h1 id="一、瘦身优化及Apk分析方案"><a href="#一、瘦身优化及Apk分析方案" class="headerlink" title="一、瘦身优化及Apk分析方案"></a>一、瘦身优化及Apk分析方案</h1><h2 id="APK-组成"><a href="#APK-组成" class="headerlink" title="APK 组成"></a>APK 组成</h2><p>我们都知道，<strong>Android</strong> 项目最终会编译成一个 <strong>.apk</strong> 后缀的文件，实际上它就是一个 <strong>压缩包</strong>。因此，它内部还有很多不同类型的文件，这些文件，按照大小，共分为如下四类：</p>
<ul>
<li>1）、<strong>代码相关</strong>：<strong>classes.dex</strong>，我们在项目中所编写的 <strong>java</strong> 文件，经过编译之后会生成一个 <strong>.class</strong> 文件，而这些所有的 <strong>.class</strong> 文件呢，它最终会经过 <strong>dx</strong> 工具编译生成一个 <strong>classes.dex</strong>。</li>
<li>2）、<strong>资源相关</strong>：<strong>res</strong>、<strong>assets</strong>、编译后的二进制资源文件 <strong>resources.arsc</strong> 和 清单文件 等等。<strong>res</strong> 和 <strong>assets</strong> 的不同在于 <strong>res</strong> 目录下的文件会在 <strong>.R</strong> 文件中生成对应的资源 <strong>ID</strong>，而 <strong>assets</strong> 不会自动生成对应的 <strong>ID</strong>，而是通过 <strong>AssetManager</strong> 类的接口来获取。此外，每当在 <strong>res</strong> 文件夹下放一个文件时，<strong>aapt</strong> 就会自动生成对应的 <strong>id</strong> 并保存在 <strong>.R</strong> 文件中，<strong>但 .R 文件仅仅只是保证编译程序不会报错，实际上在应用运行时，系统会根据 ID 寻找对应的资源路径，而 resources.arsc 文件就是用来记录这些 ID 和 资源文件位置对应关系 的文件</strong>。</li>
<li>3）、<strong>So 相关</strong>：<strong>lib</strong> 目录下的文件，这块文件的优化空间其实非常大。</li>
</ul>
<p>此外，还有 <strong>META-INF</strong>，它存放了应用的 <strong>签名信息</strong>，其中主要有 <strong>3个文件</strong>，如下所示：</p>
<ul>
<li>1）、<strong>MANIFEST.MF</strong>：其中每一个资源文件都有一个对应的 <strong>SHA-256-Digest（SHA1)</strong> 签名，<strong>MANIFEST.MF</strong> 文件的 <strong>SHA256（SHA1）</strong> 经过 <strong>base64</strong> 编码的结果即为 <strong>CERT.SF</strong> 中的 <strong>SHA256（SHA1）-Digest-Manifest</strong> 值。</li>
<li>2）、<strong>CERT.SF</strong>：除了开头处定义的 <strong>SHA256（SHA1）-Digest-Manifest</strong> 值，后面几项的值是对 <strong>MANIFEST.MF</strong> 文件中的每项再次 <strong>SHA256（SHA1）</strong> 经过 <strong>base64</strong> 编码后的值。</li>
<li>3）、<strong>CERT.RSA：其中包含了公钥、加密算法等信息。首先，对前一步生成的 CERT.SF 使用了 SHA256（SHA1）生成了数字摘要并使用了 RSA 加密，接着，利用了开发者私钥进行签名。然后，在安装时使用公钥解密。最后，将其与未加密的摘要信息（MANIFEST.MF文件）进行对比，如果相符，则表明内容没有被修改。</strong></li>
</ul>
<h2 id="APK分析"><a href="#APK分析" class="headerlink" title="APK分析"></a>APK分析</h2><p>下面，我们就来学习 <strong>APK</strong> 分析的 <strong>四种常用方式</strong>。</p>
<h3 id="1、使用-ApkTool-反编译工具分析-APK"><a href="#1、使用-ApkTool-反编译工具分析-APK" class="headerlink" title="1、使用 ApkTool 反编译工具分析 APK"></a>1、使用 ApkTool 反编译工具分析 APK</h3><p>第一种方式，就是使用 <strong>ApkTool</strong> 这个反编译工具，它的官网地址如下：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/iBotPeaches/Apktool">ApkTool 官方网站</a></p>
<p>其具体的 <strong>反编译命令</strong> 如下所示：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apktool</span> d xxx.apk</span><br></pre></td></tr></table></figure>

<p>下面，我们就来使用 ApkTool 来对应用进行反编译。</p>
<h4 id="ApkTool反编译实战"><a href="#ApkTool反编译实战" class="headerlink" title="ApkTool反编译实战"></a>ApkTool反编译实战</h4><h5 id="1、下载并配置apktool"><a href="#1、下载并配置apktool" class="headerlink" title="1、下载并配置apktool"></a>1、下载并配置apktool</h5><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/go-wild?ac=2&url=https://ibotpeaches.github.io/Apktool/install/">apktool 下载配置官方文档</a></p>
<p>我这里仅介绍 <strong>Mac OS X</strong> 平台上的下载配置，其它平台请点击上方链接查看。</p>
<ul>
<li>1）、<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/osx/apktool">下载脚本</a>，保存为 <strong>apktool</strong> 文件。</li>
<li>2）、<a target="_blank" rel="noopener" href="https://bitbucket.org/iBotPeaches/apktool/downloads/">下载最新版 apktool.jar</a>（fanqiang)</li>
<li>3）、将下载的 <strong>jar</strong> 包重命名为 <strong>apktool.jar</strong>。</li>
<li>4）、配置环境变量，这里有两种方案，如下所示：<ul>
<li>第一种是直接将 <strong>apktool</strong> 和 <strong>apktool.jar</strong> 移到 <strong>&#x2F;usr&#x2F;local&#x2F;bin</strong> 目录，但是这里需要 <strong>root</strong> 权限，命令前加 <strong>sudo</strong>，回车后输入密码即可。</li>
<li>第二种是在 <strong>~&#x2F;.bash_profile</strong> 文件下配置，首先新建 <strong>apktool</strong> 文件夹，将两个文件放到这个文件下，打开终端，使用 <strong>vim</strong> 加上环境配置，其命令如下所示：</li>
</ul>
</li>
</ul>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//</span> 1、使用vim命令在命令行打开<span class="string">.bash_profile</span>文件，并可以在命令行</span><br><span class="line"><span class="string">//</span> 上编辑，当然，你也可以直接打开<span class="string">.bash_profile</span>文件</span><br><span class="line">vim ~<span class="string">/.bash_profile</span></span><br><span class="line"><span class="string">//</span> 2、在<span class="string">.bash_profile</span>最后加上这一行即可</span><br><span class="line">export PATH=前面路径<span class="string">/apktool</span>:$PATH</span><br><span class="line"><span class="string">//</span> 3、使编辑后的配置生效</span><br><span class="line">source ~<span class="string">/.bash_profile</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>5）、最后，使用以下命令将两个文件权限设置为 <strong>可执行</strong> 即可：</p>
<p>sudo chmod a+x file</p>
</li>
</ul>
<h5 id="2、使用ApkTool分析APK"><a href="#2、使用ApkTool分析APK" class="headerlink" title="2、使用ApkTool分析APK"></a>2、使用ApkTool分析APK</h5><p>我们在命令行下输入以下命令对 <strong>APK</strong> 进行反编译，如下所示：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">java </span>-<span class="keyword">jar </span>apktool_2.<span class="number">3</span>.<span class="number">4</span>.<span class="keyword">jar </span>apktool d app-release.apk</span><br></pre></td></tr></table></figure>

<p>反编译完成之后，它就会在当前的文件夹下面生成 <strong>app-release</strong> 的目录，目录结构如下所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f084ed7714fe4aa792268c25e0b46bac~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p>这样我们就可以看到当前 <strong>App的具体组成</strong> 了。下面，我们介绍下第二种 <strong>APK 分析</strong> 的方式。</p>
<h3 id="2、使用AS-2-2之后提供的Analyze-APK"><a href="#2、使用AS-2-2之后提供的Analyze-APK" class="headerlink" title="2、使用AS 2.2之后提供的Analyze APK"></a>2、使用AS 2.2之后提供的Analyze APK</h3><p><strong>Analyze APK</strong> 具有如下功能：</p>
<ul>
<li>1）、<strong>可以直观地查看到 APK 的组成，比如大小、占比等等</strong>。</li>
<li>2）、<strong>查看 dex 文件的组成</strong>。</li>
<li>3）、<strong>对不同的 APK 进行对比分析</strong>。</li>
</ul>
<p>下面，我们就来具体实战一下，需要注意的是，我们可以 <strong>直接将电脑上的 apk 拖进 AS 中就可以自动使用 Analyze APK 打开 apk</strong>。然后，我们就可以看到 <strong>APK 文件的绝对大小以及各组成文件的百分占比</strong>，如下图所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bf06590ab230467793b1b32b91d0d20c~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p>可以看到，<a target="_blank" rel="noopener" href="https://github.com/JsonChao/Awesome-WanAndroid">Awesome-WanAndroid</a>  应用的 <strong>classes.dex</strong> 的大小为 <strong>3.3MB</strong>，总占比为 <strong>42.2%<strong>。并且，</strong>lib</strong> 和 <strong>res</strong> 目录也有 <strong>1.9MB</strong>，总占比大概为 **25%**，因此，对于 <strong>Awesome-WanAndroid App的优化方向就应该是 dex 为主、so 和 res 为辅</strong> 了。此外，我们还可以查看 <strong>classes.dex</strong> 中还包含有哪些类，如下图所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/83226ad1274d4104a28b88c4f892e6e2~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p>我们平时在做 <strong>竞品分析</strong> 的时候，就能够很方便地来 <strong>看一下我们 App 的竞品用到了哪些第三方 SDK</strong>。同时，我们也可以从清单文件中很方便地查看 <strong>APK</strong> 文件的最终版本，因为 <strong>Analyze APK</strong> 能够直接对清单文件进行解析。</p>
<p>此外，在应用右上角还有一个 <strong>Compare with previos APK</strong> 的按钮，我们点击它之后，就可以 <strong>将当前的 APK 与别的版本的 APK 进行对比</strong>，这样就可以对新旧两个版本的 <strong>APK</strong> 文件大小进行对比。</p>
<p>接下来，我们再介绍下第三种 <strong>APK</strong> 分析的方式。</p>
<h3 id="3、使用-nimbledroid-进行-APK-性能分析"><a href="#3、使用-nimbledroid-进行-APK-性能分析" class="headerlink" title="3、使用 nimbledroid 进行 APK 性能分析"></a>3、使用 nimbledroid 进行 APK 性能分析</h3><p><a target="_blank" rel="noopener" href="https://nimbledroid.com/">nimbledroid官网</a></p>
<p>nibledroid 是美国哥伦比亚大学的博士创业团队研发出来的分析 <strong>Android App</strong> 性能指标的系统，分析的方式有静态和动态两种方式，如下所示：</p>
<ul>
<li>1）、<strong>静态分析</strong>：可以分析出APK安装包中<strong>大文件排行榜，Dex 方法数和知名第三方 SDK 的方法数及占代码整体的比例</strong>。</li>
<li>2）、<strong>动态分析</strong>：可以给出 <strong>冷启动时间, 列出 Block UI 的具体方法, 内存占用, 以及 Hot Methods</strong>, 从这些分析报告中, 可以 <strong>定位出具体的优化点</strong>。</li>
</ul>
<p>它的使用方式其实非常简单，<strong>只需要直接上传APK</strong> 即可。然后，<strong>nimbledroid</strong> 网站的后台就会自动对 <strong>APK</strong> 进行分析，并最终给出一份 <strong>全面的 APK 分析报告</strong>。</p>
<p>下面，我们再来介绍最后一种 <strong>APK</strong> 分析工具，即二进制检查工具 <strong>android-classshark</strong>。</p>
<h3 id="4、使用-android-classshark-进行-APK-分析"><a href="#4、使用-android-classshark-进行-APK-分析" class="headerlink" title="4、使用 android-classshark 进行 APK 分析"></a>4、使用 android-classshark 进行 APK 分析</h3><p><a target="_blank" rel="noopener" href="https://github.com/google/android-classyshark">android-classshark项目地址</a></p>
<p><strong>android-classshark</strong> 是一个 <strong>面向 Android 开发人员的独立二进制检查工具</strong>，它可以 <strong>浏览任何的 Android 可执行文件</strong>，并且检查出信息，比如类的接口、成员变量等等，此外，它还可以支持多种格式，比如说 <strong>APK、Jar、Class、So 以及所有的 Android 二进制文件如清单文件等等</strong>。下面，我们就来使用 <strong>android-classshark</strong> 来进行一下实战。</p>
<h4 id="android-classshark-实战"><a href="#android-classshark-实战" class="headerlink" title="android-classshark 实战"></a>android-classshark 实战</h4><p>首先，我们从它的 <strong>Github</strong> 地址上下载对应的 <strong>ClassyShark.jar</strong>，地址如下所示：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/google/android-classyshark/releases">ClassyShark.jar-下载地址</a></p>
<p>然后，我们双击打开 <strong>ClassShark.jar</strong>，<strong>拖动我们的 APK 到它的工作空间即可</strong>。接下来，我们就可以看到 <strong>Apk</strong> 的分析界面了，这里我们点击 <strong>classes</strong> 下的 <strong>classes.dex</strong>，在分析界面 <strong>左边</strong> 可以看到该 <strong>dex 的方法数和文件大小</strong>，并且，<strong>最下面还显示出了该 dex 中包含有 Native Call 的类</strong>。如下图所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cbef18bd19ba4997b2b025a2fa51e27f~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p>此外，我们点击左上角的 <strong>Methods count</strong> 还可以切换到 <strong>方法数环形图标统计界面</strong>，我们不仅可以 <strong>直观地看到各个包下的方法数和相对大小</strong>，还可以看到<strong>各个子包下的方法数和相对大小</strong>。如下图所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d9b1865b4558412c99625aa2baa195c6~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<h1 id="二、代码瘦身方案探索"><a href="#二、代码瘦身方案探索" class="headerlink" title="二、代码瘦身方案探索"></a>二、代码瘦身方案探索</h1><p>在讲解如何对 <strong>Dex</strong> 进行优化之前，可能有很多同学对 <strong>Dex</strong> 还没有足够的了解，这里我们就先详细地了解下 <strong>Dex</strong>。</p>
<h2 id="1、Dex-探秘"><a href="#1、Dex-探秘" class="headerlink" title="1、Dex 探秘"></a>1、Dex 探秘</h2><p><strong>Dex</strong> 是 <strong>Android</strong> 系统的可执行文件，包含 <strong>应用程序的全部操作指令以及运行时数据</strong>。因为 <strong>Dalvik</strong> 是一种针对嵌入式设备而特殊设计的 <strong>Java</strong> 虚拟机，所以 <strong>Dex 文件与标准的 Class 文件在结构设计上有着本质的区别</strong>。当 <strong>Java</strong> 程序被编译成 <strong>class</strong> 文件之后，还需要使用 <strong>dx</strong> 工具将所有的 <strong>class</strong> 文件整合到一个 <strong>dex</strong> 文件中，这样 <strong>dex 文件就将原来每个 class 文件中都有的共有信息合成了一体</strong>，这样做的目的是 <strong>保证其中的每个类都能够共享数据</strong>，这在一定程度上 <strong>降低了信息冗余</strong>，同时也使得 <strong>文件结构更加紧凑</strong>。<strong>与传统 jar 文件相比，Dex 文件的大小能够缩减 50% 左右</strong>。关于 <strong>Class</strong> 文件与 <strong>Dex</strong> 文件的结果对比图如下所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/493a202586fe4ee3825813f88b67b684~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p>如果想深入地了解 <strong>Dex</strong> 文件格式，可以参见<a target="_blank" rel="noopener" href="https://source.android.com/devices/tech/dalvik">Google 官方教程 - Dex格式</a>。</p>
<p><strong>Dex</strong> 一般在应用包体积中占据了不少比重，并且，<strong>Dex</strong> 数量越多，<strong>App</strong> 的安装时间也会越长。所以，优化它们可以说是 <strong>重中之重</strong>。下面，我们就来看看有哪些方式可以优化 <strong>Dex</strong> 这部分的体积。</p>
<h2 id="2、ProGuard"><a href="#2、ProGuard" class="headerlink" title="2、ProGuard"></a>2、ProGuard</h2><p><strong>Java</strong> 是一种跨平台的、解释型语言，而 <strong>Java</strong> 源代码被编译成 <strong>中间 ”字节码”</strong> 存储于 <strong>Class</strong> 文件之中。</p>
<h3 id="那么，我们为什么要使用代码混淆呢？"><a href="#那么，我们为什么要使用代码混淆呢？" class="headerlink" title="那么，我们为什么要使用代码混淆呢？"></a>那么，我们为什么要使用代码混淆呢？</h3><p>由于跨平台的需要，<strong>Java</strong>   <strong>字节码</strong> 中包括了很多源代码信息，如变量名、方法名，并且通过这些名称来访问变量和方法，这些 <strong>符号带有许多语义信息</strong>，很 <strong>容易被反编译成 Java 源代码</strong>。为了防止这种现象，我们可以使用 Java 混淆器对 Java 字节码进行混淆。</p>
<p>代码混淆也被称为 <strong>花指令</strong>，它 <strong>将计算机程序的代码转换成一种功能上等价，但是难以阅读和直接理解的形式</strong>。混淆就是对发布出去的程序进行重新组织和处理，使得处理后的代码与处理前代码完成相同的功能，而混淆后的代码很难被反编译，即使反编译成功也很难得出程序的真正语义。混淆器的 <strong>作用</strong> 不仅仅是 <strong>保护代码</strong>，它也有 <strong>精简编译后程序大小</strong> 的作用，其 <strong>通过缩短变量和函数名以及丢失部分无用信息等方式，能使得应用包体积减小</strong>。</p>
<h3 id="代码混淆的形式"><a href="#代码混淆的形式" class="headerlink" title="代码混淆的形式"></a>代码混淆的形式</h3><p>目前，代码混淆的形式主要有 <strong>三种</strong>，如下所示：</p>
<ul>
<li>1）、<strong>将代码中的各个元素，比如类、函数、变量的名字改变成无意义的名字</strong>。例如将 <strong>hasValue</strong> 转换成单个的字母 <strong>a</strong>。这样，反编译阅读的人就无法通过名字来猜测用途。</li>
<li>2）、<strong>重写</strong> 代码中的 <strong>部分逻辑</strong>，将它变成 <strong>功能上等价</strong>，但是又 <strong>难以理解</strong> 的形式。比如它会 <strong>改变循环的指令、结构体</strong>。</li>
<li>3）、<strong>打乱代码的格式</strong>，比如多加一些空格或删除空格，或者将一行代码写成多行，将多行代码改成一行。</li>
</ul>
<h3 id="Proguard-的作用"><a href="#Proguard-的作用" class="headerlink" title="Proguard 的作用"></a>Proguard 的作用</h3><p>在 <strong>Android SDK</strong> 里面集成了一个工具 — <strong>Proguard</strong>，它是一个免费的 <strong>Java</strong> 类文件 <strong>压缩、优化、混淆、预先校验</strong> 的工具。它的 <strong>主要作用</strong> 大概可以概括为 <strong>两点</strong>，如下所示：</p>
<ul>
<li>1）、<strong>瘦身：它可以检测并移除未使用到的类、方法、字段以及指令、冗余代码，并能够对字节码进行深度优化。最后，它还会将类中的字段、方法、类的名称改成简短无意义的名字</strong>。</li>
<li>2）、<strong>安全：增加代码被反编译的难度，一定程度上保证代码的安全</strong>。</li>
</ul>
<p>所以说，混淆不仅是保障 <strong>Android 程序源码安全</strong> 的 <strong>第一道门槛</strong>，而且在一定程度上，使用它能够减小 优化字节码 的大小。优化字节码 的处理流程如下图所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3bc3c755789c459ca6e49f733489bf9d~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p>而它的作用具体可以细分三点，如下所示：</p>
<h4 id="1、压缩（Shrinking）"><a href="#1、压缩（Shrinking）" class="headerlink" title="1、压缩（Shrinking）"></a>1、压缩（Shrinking）</h4><p>默认开启，以减小应用体积，移除未被使用的类和成员，并且 <strong>会在优化动作执行之后再次执行</strong>，因为优化后可能会再次暴露一些未被使用的类和成员。我们可以使用如下规则来关闭压缩：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">-dontshrink 关闭压缩</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="2、优化（Optimization）"><a href="#2、优化（Optimization）" class="headerlink" title="2、优化（Optimization）"></a>2、优化（Optimization）</h4><p>默认开启，在 <strong>字节码级别执行优化</strong>，让应用 <strong>运行的更快</strong>。使用如下规则可进行优化相关操作：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">-dontoptimize 关闭优化</span></span><br><span class="line"><span class="deletion">-optimizationpasses n 表示proguard对代码进行迭代优化的次数，Android一般为5</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="3、混淆（Obfuscation）"><a href="#3、混淆（Obfuscation）" class="headerlink" title="3、混淆（Obfuscation）"></a>3、混淆（Obfuscation）</h4><p>默认开启，增大反编译难度，类和类成员会被随机命名，除非用 优化字节码 等规则进行保护。使用如下规则可以关闭混淆：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">-dontobfuscate 关闭混淆</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Proguard-的优化细节"><a href="#Proguard-的优化细节" class="headerlink" title="Proguard 的优化细节"></a>Proguard 的优化细节</h3><p><strong>Proguard</strong> 中所做的优化包括 <strong>内联、修饰符、合并类和方法等 30 多种优化项，在特定的情况下，它尽可能地做了相应的优化</strong>，下面列出了部分的 <strong>优化细节</strong>：</p>
<ul>
<li><strong>1)、优化了 Gson 库的使用</strong>。</li>
<li><strong>2)、把类都标记为 final</strong>。</li>
<li><strong>3)、把枚举类型简化为常量</strong>。</li>
<li><strong>4)、把一些类都垂直合并进当前类的结构中</strong>。</li>
<li><strong>5)、把一些类都水平合并进当前类的结构中</strong>。</li>
<li><strong>6)、移除 write-only 字段</strong>。</li>
<li><strong>7)、把类标记为私有的</strong>。</li>
<li><strong>8)、把字段的值跨方法地进行传递</strong>。</li>
<li><strong>9)、把一些方法标记为私有、静态或 final</strong>。</li>
<li><strong>10)、解除方法的 synchronized 标记</strong>。</li>
<li><strong>11)、移除没有使用的方法参数</strong>。</li>
</ul>
<h3 id="Proguard-的配置"><a href="#Proguard-的配置" class="headerlink" title="Proguard 的配置"></a>Proguard 的配置</h3><p>混淆之后，默认会在工程目录 <strong>app&#x2F;build&#x2F;outputs&#x2F;mapping&#x2F;release</strong> 下生成一个 <strong>mapping.txt</strong> 文件，这就是 <strong>混淆规则</strong>，所以我们可以根据这个文件把混淆后的代码反推回原本的代码。要使用混淆，我们只需配置如下代码即可：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">buildTypes &#123;</span><br><span class="line">    release &#123;</span><br><span class="line">        <span class="regexp">//</span> <span class="number">1</span>、是否进行混淆</span><br><span class="line">        minifyEnabled true</span><br><span class="line">        <span class="regexp">//</span> <span class="number">2</span>、开启zipAlign可以让安装包中的资源按<span class="number">4</span>字节对齐，这样可以减少应用在运行时的内存消耗</span><br><span class="line">        zipAlignEnabled true</span><br><span class="line">        <span class="regexp">//</span> <span class="number">3</span>、移除无用的resource文件：当ProGuard 把部分无用代码移除的时候，这些代码所引用的资源也会被标记为无用资源，然后系统通过资源压缩功能将它们移除。需要注意的是目前资源压缩器目前不会移除values/文件夹中定义的资源（例如字符串、尺寸、样式和颜色）开启后，Android构建工具会通过ResourceUsageAnalyzer来检查哪些资源是无用的，当检查到无用的资源时会把该资源替换成预定义的版本。主要是针对.png、.<span class="number">9</span>.png、.xml提供了TINY_PNG、TINY_9PNG、TINY_XML这<span class="number">3</span>个byte数组的预定义版本。资源压缩工具默认是采用安全压缩模式来运行，可以通过开启严格压缩模式来达到更好的瘦身效果。</span><br><span class="line">        shrinkResources true</span><br><span class="line">        <span class="regexp">//</span> <span class="number">4</span>、混淆文件的位置，其中 proguard-android.txt 为sdk默认的混淆配置，它的位置位于android-sdk<span class="regexp">/tools/</span>proguard/proguard-android.txt，此外，proguard-android-optimize.txt 也为sdk默认的混淆配置，但是它默认打开了优化开关。并且，我们可在配置混淆文件将android.util.Log置为无效代码，以去除apk中打印日志的代码。而 proguard-rules.pro 是该模块下的混淆配置。</span><br><span class="line">        proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-android-optimize.txt&#x27;</span>), <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">        signingConfig signingConfigs.release</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先，在注释1处，我们可以通过配置 <strong>minifyEnabled</strong> 来决定是否进行混淆。</p>
<p>然后，在注释2处，通过 <strong>配置 zipAlignEnabled 为 true 可以让安装包中的资源按 4 字节对齐，这样可以减少应用在运行时的内存消耗</strong>。</p>
<p>接着，在注释3处，配置 <strong>shrinkResources</strong> 为 <strong>true</strong> 可以移除无用的 <strong>resource</strong> 文件：<strong>当 ProGuard 把部分无用代码移除的时候，这些代码所引用的资源也会被标记为无用资源，然后，系统会通过资源压缩功能将它们移除</strong>。需要注意的是 <strong>目前资源压缩器目前不会移除 values &#x2F; 文件夹中定义的资源（例如字符串、尺寸、样式和颜色）</strong>。开启后，<strong>Android 构建工具会通过 ResourceUsageAnalyzer 来检查哪些资源是无用的，当检查到无用的资源时会把该资源替换成预定义的版本。主要是针对 .png、.9.png、.xml 提供了 TINY_PNG、TINY_9PNG、TINY_XML 这 3 个 byte 数组的预定义版本</strong>。资源压缩工具默认是采用 <strong>安全压缩模式</strong> 来运行，可以通过开启 <strong>严格压缩模式</strong> 来达到 <strong>更好的瘦身效果</strong>。</p>
<p>最后，在注释 4处，我们可以配置混淆文件的位置，其中 <strong>proguard-android.txt</strong> 为 <strong>sdk</strong> 默认的混淆配置，它的位置位于 <strong>android-sdk&#x2F;tools&#x2F;proguard&#x2F;proguard-android.txt</strong>，此外，<strong>proguard-android-optimize.txt</strong> 也是 <strong>sdk</strong> 默认的混淆配置，但是它 <strong>默认打开了优化开关</strong>。此外，我们也可以在配置混淆文件将 <strong>android.util.Log</strong> 置为无效代码，以去除 <strong>apk</strong> 中打印日志的代码。而 <strong>proguard-rules.pro</strong> 是该模块下的混淆配置。</p>
<p>在执行完 <strong>ProGuard</strong> 之后，ProGuard 都会在 <code>$&#123;project.buildDir&#125;/outputs/mapping/$&#123;flavorDir&#125;/</code> 生成以下文件：</p>
<table>
<thead>
<tr>
<th>文件名</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>dump.txt</td>
<td>APK中所有类文件的内部结构</td>
</tr>
<tr>
<td>mapping.txt</td>
<td>提供原始与混淆过的类、方法和字段名称之间的转换，可以通过proguard.obfuscate.MappingReader来解析</td>
</tr>
<tr>
<td>seeds.txt</td>
<td>列出未进行混淆的类和成员</td>
</tr>
<tr>
<td>usage.txt</td>
<td>列出从APK移除的代码</td>
</tr>
</tbody></table>
<p>下面，我们再回顾下混淆的基本规则。</p>
<h3 id="混淆的基本规则"><a href="#混淆的基本规则" class="headerlink" title="混淆的基本规则"></a>混淆的基本规则</h3><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># * 表示仅保持该包下的类名，而子包下的类名还是会被混淆</span></span><br><span class="line">-keep <span class="keyword">class</span> <span class="title class_">com</span>.json.chao.wanandroid.*</span><br><span class="line"><span class="meta"># ** 表示把本包和所含子包下的类名都保持</span></span><br><span class="line">-keep <span class="keyword">class</span> <span class="title class_">com</span>.json.chao.wanandroid.**</span><br><span class="line"></span><br><span class="line"><span class="meta"># 既保持类名，又保持里面的内容不被混淆</span></span><br><span class="line">-keep <span class="keyword">class</span> <span class="title class_">com</span>.json.chao.wanandroid.* &#123;*;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta"># 也可以使用Java的基本规则来保护特定类不被混淆，比如extend，implement等这些Java规则</span></span><br><span class="line">-keep <span class="keyword">public</span> <span class="keyword">class</span> * <span class="keyword">extends</span> android.app.Activity</span><br><span class="line"></span><br><span class="line"><span class="meta"># 保留MainPagerFragment内部类JavaScriptInterface中的所有public内容不被混淆</span></span><br><span class="line">-keepclassmembers <span class="keyword">class</span> <span class="title class_">com</span>.json.chao.wanandroid.ui.fragment.MainPagerFragment$JavaScriptInterface &#123;</span><br><span class="line">    <span class="keyword">public</span> *;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta"># 仅希望保护类下的特定内容时需使用匹配符</span></span><br><span class="line">&lt;init&gt;;     <span class="comment">//匹配所有构造器</span></span><br><span class="line">&lt;fields&gt;;   <span class="comment">//匹配所有字段</span></span><br><span class="line">&lt;methods&gt;;  <span class="comment">//匹配所有方法</span></span><br><span class="line"><span class="meta"># 还可以在上述匹配符前面加上private 、public、native等来进一步指定不被混淆的内 容</span></span><br><span class="line">-keep <span class="keyword">class</span> <span class="title class_">com</span>.json.chao.wanandroid.app.WanAndroidApp &#123;</span><br><span class="line">    <span class="keyword">public</span> &lt;fields&gt;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta"># 也可以加入参数，以下表示用java.lang.String作为入参的构造函数不会被混淆</span></span><br><span class="line">-keep <span class="keyword">class</span> <span class="title class_">com</span>.json.chao.wanandroid.app.WanAndroidApp &#123;</span><br><span class="line">    <span class="keyword">public</span> &lt;init&gt;(java.lang.String);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta"># 不需要保持类名，仅需要把该类下的特定成员保持不被混淆时使用keepclassmembers</span></span><br><span class="line"><span class="meta"># 如果拥有某成员，要保留类和类成员使用-keepclasseswithmembers</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>了解完上面的这些混淆规则之后，相信我们已经能够根据我们当前的应用写出相应的混淆规则了。需要注意的是，<strong>在 AndroidMainfest 中的类默认不会被混淆</strong>，所以四大组件和 <strong>Application</strong> 的子类和 <strong>Framework</strong> 层下所有的类默认不会进行混淆，并且自定义的 <strong>View</strong> 默认也不会被混淆。因此，我们不需要手动在 <strong>proguard-rules.pro</strong> 中去添加如下代码：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-keep public <span class="class"><span class="keyword">class</span> <span class="title">*</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">app</span>.<span class="title">Activity</span></span></span><br><span class="line">-keep public <span class="class"><span class="keyword">class</span> <span class="title">*</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">app</span>.<span class="title">Appliction</span></span></span><br><span class="line">-keep public <span class="class"><span class="keyword">class</span> <span class="title">*</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">app</span>.<span class="title">Service</span></span></span><br><span class="line">-keep public <span class="class"><span class="keyword">class</span> <span class="title">*</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">content</span>.<span class="title">BroadcastReceiver</span></span></span><br><span class="line">-keep public <span class="class"><span class="keyword">class</span> <span class="title">*</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">content</span>.<span class="title">ContentProvider</span></span></span><br><span class="line">-keep public <span class="class"><span class="keyword">class</span> <span class="title">*</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">app</span>.<span class="title">backup</span>.<span class="title">BackupAgentHelper</span></span></span><br><span class="line">-keep public <span class="class"><span class="keyword">class</span> <span class="title">*</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">preference</span>.<span class="title">Preference</span></span></span><br><span class="line">-keep public <span class="class"><span class="keyword">class</span> <span class="title">*</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">view</span>.<span class="title">View</span></span></span><br><span class="line">-keep public <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">android</span>.<span class="title">vending</span>.<span class="title">licensing</span>.<span class="title">ILicensingService</span></span></span><br></pre></td></tr></table></figure>

<p>而 <strong>Application</strong> 和四大组件是必须在 <strong>AndroidMainfest</strong> 中进行注册的，所以如果想要通过 <strong>混淆四大组件和 Application、自定义 View 的方式去减小APK的体积是行不通的</strong>，因为没有规则去配置如何混淆四大组件和 <strong>Application</strong>。因此，<strong>对于混淆的优化，我们能做的只能是 尽量保证 keep 范围的最小化，以此实现应用混淆程度的最大化</strong>。在混淆配置中添加下列规则还可以在混淆之后输出最终的混淆配置：</p>
<figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 输出 ProGuard 的最终配置</span></span><br><span class="line"><span class="literal">-</span>printconfiguration configuration.txt</span><br></pre></td></tr></table></figure>

<h3 id="混淆实战"><a href="#混淆实战" class="headerlink" title="混淆实战"></a>混淆实战</h3><p>这里，我们就对 <a href="https://link.juejin.cn/?target=https://github.com/JsonChao/Awesome-WanAndroid">Awesome-WanAndroid</a>  应用进行混淆，看看该应用混淆前后 <strong>APK</strong> 的体积变化。</p>
<p>下面这张图是 <a href="https://link.juejin.cn/?target=https://github.com/JsonChao/Awesome-WanAndroid">Awesome-WanAndroid</a> 混淆前的 <strong>APK</strong> 组成结构图，可以看到占用了大概 <strong>8.3MB</strong> 的体积，其中 <strong>dex</strong> 部分占用了 <strong>3.6MB</strong>。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/309bb32350264ba6883254355669fd2a~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p>混淆之后，<strong>APK</strong> 的体积会如何变化呢？我们看看 <strong>混淆后的 APK 组成结构图</strong>，如下所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a5cbb8872294445eb2bef8de3605d87a~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p>可以看到，原先两个 <strong>dex</strong> 文件变为了一个，而且 <strong>dex</strong> 的大小也缩减到了 <strong>2.2MB</strong>，大小整整缩减了 <strong>1.4MB</strong>，<strong>dex</strong> 部分的压缩效果将近 <strong>40%<strong>。</strong>APK</strong> 整体的压缩效果也有 <strong>17%<strong>。所以，</strong>混淆的确是 APK 瘦身的首选手段</strong>。此外，<strong>在 Android Studio 3.1 或之后的版本都会默认采用 D8 作为 Dex 的编译器</strong>，并且，<strong>在2019年10月，被认作为混淆的替代品的 R8 就已经默认集成进 Android Gradle plugin 中了</strong>。下面，我们就看看 D8 与 R8 到底是如何优化 APK 的 dex 部分的。</p>
<h2 id="3、D8-与-R8-优化"><a href="#3、D8-与-R8-优化" class="headerlink" title="3、D8 与 R8 优化"></a>3、D8 与 R8 优化</h2><h3 id="D8-优化"><a href="#D8-优化" class="headerlink" title="D8 优化"></a>D8 优化</h3><h4 id="优化效果"><a href="#优化效果" class="headerlink" title="优化效果"></a>优化效果</h4><p>D8 的 <strong>优化效果</strong> 总的来说可以归结为如下 <strong>四点</strong>：</p>
<ul>
<li>1）、<strong>Dex的编译时间更短</strong>。</li>
<li>2）、**.dex文件更小**。</li>
<li>3）、<strong>D8 编译的 .dex 文件拥有更好的运行时性能</strong>。</li>
<li>4）、<strong>包含 Java 8 语言支持的处理</strong>。</li>
</ul>
<h4 id="开启-D8"><a href="#开启-D8" class="headerlink" title="开启 D8"></a>开启 D8</h4><p>在 <strong>Android Studio 3.0</strong> 需要主动在 <strong>gradle.properties</strong> 文件中新增:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">android.enableD8</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><strong>Android Studio 3.1</strong> 或之后的版本 <strong>D8</strong> 将会被作为默认的 <strong>Dex</strong> 编译器。</p>
<h3 id="R8-优化"><a href="#R8-优化" class="headerlink" title="R8 优化"></a>R8 优化</h3><p><a href="https://link.juejin.cn/?target=https://r8.googlesource.com/r8">R8 官方文档（目前已经开源）</a></p>
<p><strong>R8 是 Proguard 压缩与优化部分的替代品</strong>，并且它仍然使用与 <strong>Proguard</strong> 一样的 <strong>keep</strong> 规则。如果我们仅仅想在 <strong>Android Studio</strong> 中使用 <strong>R8</strong>，当我们在 <strong>build.gradle</strong> 中打开混淆的时候，<strong>R8</strong> 就已经默认集成进 <strong>Android Gradle plugin</strong> 中了。</p>
<p>如果我们当前使用的是 Android Studio 3.4 或 Android Gradle 插件 3.4.0 及其更高版本，R8 会作为默认编译器。否则，我们 <strong>必须要在 gradle.properties 中配置如下代码让 App 的混淆去支持 R8</strong>，如下所示：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">android.enableR8</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">android.enableR8.libraries</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="那么，R8-与混淆相比优势在哪里呢？"><a href="#那么，R8-与混淆相比优势在哪里呢？" class="headerlink" title="那么，R8 与混淆相比优势在哪里呢？"></a>那么，R8 与混淆相比优势在哪里呢？</h3><p><strong>ProGuard</strong> 和 <strong>R8</strong> 都应用了基本名称混淆：它们 <strong>都使用简短，无意义的名称重命名类，字段和方法</strong>。他们还可以 <strong>删除调试属性</strong>。但是，<strong>R8 在 inline 内联容器类中更有效，并且在删除未使用的类，字段和方法上则更具侵略性</strong>。例如，<strong>R8</strong> 本身集成在 <strong>ProGuard</strong> V6.1.1 版本中，在压缩 <strong>apk</strong> 的大小方面，与 <strong>ProGuard</strong> 的 <strong>8.5％</strong> 相比，使用 <strong>R8 apk</strong> 尺寸减小了约 <strong>10％</strong>。并且，随着 <strong>Kotlin</strong> 现在成为 <strong>Android</strong> 的第一语言，<strong>R8</strong> 进行了 <strong>ProGuard</strong> 尚未提供的一些 <strong>Kotlin</strong> 的特定的优化。</p>
<p>从表面上看，<strong>ProGuard</strong> 和 <strong>R8</strong> 非常相似。它们都使用相同的配置，因此在它们之间进行切换很容易。放大来看的话，它们之间也存在一些差异。<strong>R8 能更好地内联容器类，从而避免了对象分配</strong>。但是 <strong>ProGuard</strong> 也有其自身的优势，具体有如下几点：</p>
<ul>
<li>1）、<strong>ProGuard 在将枚举类型简化为原始整数方面会更加强大</strong>。它还传递常量方法参数，这通常对于使用应用程序的特定设置调用的通用库很有用。<strong>ProGuard  的多次优化遍历通常可以产生一系列优化</strong>。例如，第一遍可以传递一个常量方法参数，以便下一遍可以删除该参数并进一步传递该值。删除日志代码时，多次传递的效果尤其明显。<strong>ProGuard 在删除所有跟踪（包括组成日志消息的字符串操作）方面更有效</strong>。</li>
<li>2）、<strong>ProGuard 中应用的模式匹配算法可以识别和替换短指令序列，从而提高代码效率并为更多优化打开了机会。在优化遍历的顺序中，尤其是数学运算和字符串运算可从中受益</strong>。</li>
<li>3、最后，<strong>ProGuard 具有独特的能力来优化使用 GSON 库将对象序列化或反序列化为 JSON 的代码</strong>。该库严重依赖反射，这很方便，但效率低下。而 <strong>ProGuard</strong>  的优化功能可以 <strong>通过更高效，直接的访问方式</strong> 来代替它。</li>
</ul>
<h3 id="R8-优化实战"><a href="#R8-优化实战" class="headerlink" title="R8 优化实战"></a>R8 优化实战</h3><p>接下来，我们就来看看 <strong>Awesome-WanAndroid</strong> 使用 <strong>R8</strong> 后，<strong>APK</strong> 体积的变化，如下图所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c6de4da9187f4ea1bf7aa14a410953b5~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p>可以看到，相较于仅使用混淆后的 <strong>APK</strong> 而言，大小减少了 <strong>0.1MB</strong>，<strong>Dex</strong> 部分的优化效果大概为 <strong>5%<strong>，</strong>APK</strong> 整体的压缩效果也有 <strong>1.5%</strong> 左右。虽然从减少的 <strong>APK</strong> 大小来看，<strong>0.1MB</strong> 很少，但是比例并不小，如果你负责的是一个像微信、淘宝等规模的 <strong>App</strong>，它们的体积一般都将近 <strong>100MB</strong>，使用 <strong>R8</strong> 后也能减小 <strong>1.5MB</strong> 的大小。</p>
<p>此外，如果想单独对 <strong>Dex 或 jar 包</strong> 使用 <strong>R8</strong>，可以根据最上面的官方文档可以很快的在 <strong>python</strong> 环境下运行起来，其具体步骤如下所示：</p>
<h4 id="1、确保本地已经安装了python-2-7或更高版本。"><a href="#1、确保本地已经安装了python-2-7或更高版本。" class="headerlink" title="1、确保本地已经安装了python 2.7或更高版本。"></a>1、确保本地已经安装了python 2.7或更高版本。</h4><h4 id="2、由于R8项目使用chromium项目提供的depot-tools管理依赖，因此先安装depot-tools。（下面仅介绍Mac版的安装）"><a href="#2、由于R8项目使用chromium项目提供的depot-tools管理依赖，因此先安装depot-tools。（下面仅介绍Mac版的安装）" class="headerlink" title="2、由于R8项目使用chromium项目提供的depot_tools管理依赖，因此先安装depot_tools。（下面仅介绍Mac版的安装）"></a>2、由于R8项目使用chromium项目提供的depot_tools管理依赖，因此先安装depot_tools。（下面仅介绍Mac版的安装）</h4><ul>
<li><p>1）、获取 depot_tools</p>
<p><code>git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git</code></p>
</li>
<li><p>2）、获取 depot_tools 当前目录</p>
<p><code>pwd</code></p>
</li>
<li><p>3）、添加环境变量</p>
<ul>
<li>vim ~&#x2F;.bash_profile：打开最后一行添加，如无此文件，可添加此文件</li>
<li>export PATH&#x3D;”$PATH:&#x2F;PWD&#x2F;depot_tools” : 其中 <strong>PWD</strong> 为刚才第二步获取的路径</li>
</ul>
</li>
<li><p>4）、生效环境变量</p>
<p><code>source ~/.bash_profile</code></p>
</li>
</ul>
<h4 id="3、Downloading-and-building-R8项目"><a href="#3、Downloading-and-building-R8项目" class="headerlink" title="3、Downloading and building R8项目"></a>3、Downloading and building R8项目</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://r8.googlesource.com/r8</span><br><span class="line"><span class="built_in">cd</span> r8</span><br><span class="line">tools/gradle.py d8 r8</span><br></pre></td></tr></table></figure>

<h4 id="4、tools-x2F-gradle-py-脚本将会生成两个-jar-文件，即-build-x2F-libs-x2F-d8-jar-与-build-x2F-libs-x2F-r8-jar。"><a href="#4、tools-x2F-gradle-py-脚本将会生成两个-jar-文件，即-build-x2F-libs-x2F-d8-jar-与-build-x2F-libs-x2F-r8-jar。" class="headerlink" title="4、tools&#x2F;gradle.py 脚本将会生成两个 jar 文件，即 build&#x2F;libs&#x2F;d8.jar  与 build&#x2F;libs&#x2F;r8.jar。"></a>4、tools&#x2F;gradle.py 脚本将会生成两个 jar 文件，即 build&#x2F;libs&#x2F;d8.jar  与 build&#x2F;libs&#x2F;r8.jar。</h4><h4 id="5、下面的代码是使用-R8-在-out-目录下去生成优化后的-dex-文件："><a href="#5、下面的代码是使用-R8-在-out-目录下去生成优化后的-dex-文件：" class="headerlink" title="5、下面的代码是使用 R8 在 out 目录下去生成优化后的 dex 文件："></a>5、下面的代码是使用 R8 在 out 目录下去生成优化后的 dex 文件：</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar build/libs/r8<span class="selector-class">.jar</span> <span class="attr">--release</span> <span class="attr">--output</span> out <span class="attr">--pg-conf</span> proguard<span class="selector-class">.cfg</span> <span class="selector-tag">input</span>.jar</span><br></pre></td></tr></table></figure>

<p>D8 与 R8 的作用非常强大，而 Jake Wharton  大神最近一年多也在研究 D8 与 R8 的知识，如果想对 D8 与 R8 的实现细节有更多地了解，可以看看他的 <a href="https://link.juejin.cn/?target=https://jakewharton.com/">个人博客</a>。</p>
<h2 id="4、去除-debug-信息与行号信息"><a href="#4、去除-debug-信息与行号信息" class="headerlink" title="4、去除 debug 信息与行号信息"></a>4、去除 debug 信息与行号信息</h2><p>在讲解什么是 <strong>deubg</strong> 信息与行号信息之前，我们需要先了解 <strong>Dex</strong> 的一些知识。</p>
<p>我们都知道，<strong>JVM</strong> 运行时加载的是 <strong>.class</strong> 文件，而 <strong>Android</strong> 为了使包大小更加紧凑、运行时更加高效就发明了 <strong>Dalvik</strong> 和 <strong>ART</strong> 虚拟机，两种虚拟机运行的都是 <strong>.dex</strong> 文件，当然 <strong>ART</strong> 虚拟机还可以同时运行 oat 文件。</p>
<p>所以 <strong>Dex</strong> 文件里的信息内容和 <strong>Class</strong> 文件包含的信息是一样的，不同的是 <strong>Dex</strong> 文件对 <strong>Class</strong> 中的信息做了去重，一个 <strong>Dex</strong> 包含了很多的 <strong>Class</strong> 文件，并且在结构上有比较大的差异，<strong>Class 是流式的结构，Dex  是分区结构，Dex 内部的各个区块间通过 offset 来进行索引</strong>。</p>
<p>为了在应用出现问题时，我们能在调试的时候去显示相应的调试信息或者上报 <strong>crash</strong> 或者主动获取调用堆栈的时候能通过 <strong>debugItem</strong> 来获取对应的行号，我们都会在混淆配置中加上下面的规则：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">-keepattributes SourceFile, LineNumberTable</span></span><br></pre></td></tr></table></figure>

<p>这样就会保留 <strong>Dex</strong> 中的 <strong>debug 与行号信息</strong>，此时的 <strong>Dex 结构图</strong> 如下所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cd1ed52e19994cf085fb57a32625cdf1~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p>从图中可以看到，<strong>Dex</strong> 文件的结构主要分为 <strong>四大块：header 区，索引区，data 区，map 区</strong>。而我们的 <strong>debug</strong> 与行号信息就保存在 <strong>data 区中的 debugItems 区域</strong>。而 <strong>debug_items</strong> 里面主要包含了 <strong>两种信息</strong>，如下所示：</p>
<ul>
<li>1）、<strong>调试的信息：包含函数的参数和所有的局部变量</strong>。</li>
<li>2）、<strong>排查问题的信息：包含所有的指令集行号与源文件行号的对应关系</strong>。</li>
</ul>
<p>根据 <strong>Google</strong> 官方的数据，<strong>debugItem 一般占 Dex 的比例有 5% 左右</strong>，如果我们能去除 <strong>debug</strong> 与行号信息，就能更进一步对 <strong>Dex</strong> 进行瘦身，但是会失去调试信息的功能，那么，<strong>有什么方式可以去掉  debugItem，同时又能让 crash 上报的时候能拿到正确的行号呢？</strong></p>
<p>我们可以尝试直接修改 <strong>Dex</strong> 文件，<strong>保留一小块  debugItem，让系统查找行号的时候指令集行号和源文件行号保持一致，这样任何监控上报的行号都直接变成了指令集行号</strong>。</p>
<p><strong>每一个方法都会有一个 debugInfoItem，每一个 debuginfoItem 里面都有一个指令集行号和源文件行号的映射关系，这了我们直接把多余的 debugInfoItem 全部删掉，只保留了一个 debugInfoItem，这样所有的方法都会指向同一个 debugInfoItem</strong>，并且这个 <strong>debugInfoItem</strong> 中的指令集行号和源文件行号保持一致，这样不管用什么方式来查找行号，拿到的都是指令集行号。需要注意的是，采用这种方案 <strong>需要兼容所有虚拟机的查找方式</strong>，因此 <strong>仅仅保留一个 debugInfoItem 是不够的，需要对 debugInfoItem 进行分区，并且 debugInfoItem 表不能太大</strong>。</p>
<p>关于如何去除 <strong>Dex</strong> 中的 <strong>Debug</strong> 信息是通过 <strong>ReDex</strong> 的 <strong>StripDebugInfoPass</strong> 来完成的，其配置如下所示：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;redex&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;passes&quot;</span> : [</span><br><span class="line">            <span class="string">&quot;StripDebugInfoPass&quot;</span>,</span><br><span class="line">            <span class="string">&quot;RegAllocPass&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;StripDebugInfoPass&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;drop_all_dbg_info&quot;</span> : <span class="type">false</span>,</span><br><span class="line">        <span class="string">&quot;drop_local_variables&quot;</span> : <span class="type">true</span>,</span><br><span class="line">        <span class="string">&quot;drop_line_numbers&quot;</span> : <span class="type">false</span>,</span><br><span class="line">        <span class="string">&quot;drop_src_files&quot;</span> : <span class="type">false</span>,</span><br><span class="line">        <span class="string">&quot;use_whitelist&quot;</span> : <span class="type">false</span>,</span><br><span class="line">        <span class="string">&quot;cls_whitelist&quot;</span> : [],</span><br><span class="line">        <span class="string">&quot;method_whitelist&quot;</span> : [],</span><br><span class="line">        <span class="string">&quot;drop_prologue_end&quot;</span> : <span class="type">true</span>,</span><br><span class="line">        <span class="string">&quot;drop_epilogue_begin&quot;</span> : <span class="type">true</span>,</span><br><span class="line">        <span class="string">&quot;drop_all_dbg_info_if_empty&quot;</span> : <span class="type">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;RegAllocPass&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;live_range_splitting&quot;</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关于 <strong>debuginfo</strong> 的实战我们下面马上会开始，在此之前，我们先讲讲 <strong>Dex</strong> 分包中的另一个优化点。</p>
<h2 id="5、Dex-分包优化"><a href="#5、Dex-分包优化" class="headerlink" title="5、Dex 分包优化"></a>5、Dex 分包优化</h2><h3 id="Dex-分包优化原理"><a href="#Dex-分包优化原理" class="headerlink" title="Dex 分包优化原理"></a>Dex 分包优化原理</h3><p>当我们的 <strong>APK</strong> 过大时，<strong>Dex</strong> 的方法数就会超过65536个，因此，必须采用 <strong>mutildex</strong> 进行分包，但是此时每一个 <strong>Dex</strong> 可能会调用到其它 <strong>Dex</strong> 中的方法，这种 <strong>跨 Dex 调用的方式会造成许多冗余信息</strong>，具体有如下两点：</p>
<ul>
<li>1）、<strong>多余的 method id：跨 Dex 调用会导致当前dex保留被调用dex中的方法id，这种冗余会导致每一个dex中可以存放的class变少，最终又会导致编译出来的dex数量增多，而dex数据的增加又会进一步加重这个问题</strong>。</li>
<li>2)、<strong>其它跨dex调用造成的信息冗余：除了需要多记录被调用的method id之外，还需多记录其所属类和当前方法的定义信息，这会造成 string_ids、type_ids、proto_ids 这几部分信息的冗余</strong>。</li>
</ul>
<p>为了减少跨 <strong>Dex</strong> 调用的情况，我们必须 <strong>尽量将有调用关系的类和方法分配到同一个 Dex 中</strong>。但是各个类相互之间的调用关系是非常复杂的，所以很难做到最优的情况。所幸的是，<strong>ReDex</strong> 的 <a href="https://link.juejin.cn/?target=https://github.com/facebook/redex/blob/master/opt/interdex/CrossDexRefMinimizer.cpp">CrossDexDefMinimizer</a> 类分析了类之间的调用关系，并 <strong>使用了贪心算法去计算局部的最优解（编译效果和dex优化效果之间的某一个平衡点）。使用 “InterDexPass” 配置项可以把互相引用的类尽量放在同个 Dex，增加类的 pre-verify，以此提升应用的冷启动速度</strong>。</p>
<p>在 <strong>ReDex</strong> 中使用 <strong>Dex</strong> 分包优化跨 <strong>dex</strong> 调用造成的信息冗余的配置代码如下所示：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;redex&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;passes&quot;</span> : [</span><br><span class="line">            <span class="string">&quot;InterDexPass&quot;</span>,</span><br><span class="line">            <span class="string">&quot;RegAllocPass&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;InterDexPass&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;minimize_cross_dex_refs&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;minimize_cross_dex_refs_method_ref_weight&quot;</span>: <span class="number">100</span>,</span><br><span class="line">        <span class="string">&quot;minimize_cross_dex_refs_field_ref_weight&quot;</span>: <span class="number">90</span>,</span><br><span class="line">        <span class="string">&quot;minimize_cross_dex_refs_type_ref_weight&quot;</span>: <span class="number">100</span>,</span><br><span class="line">        <span class="string">&quot;minimize_cross_dex_refs_string_ref_weight&quot;</span>: <span class="number">90</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;RegAllocPass&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;live_range_splitting&quot;</span>: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;string_sort_mode&quot;</span> : &quot;<span class="type">class_order</span><span class="string">&quot;,</span></span><br><span class="line"><span class="string">    &quot;</span>bytecode_sort_mode<span class="string">&quot; : &quot;</span>class_order<span class="string">&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>为了衡量优化效果，我们可以使用 <strong>Dex 信息有效率</strong> 这个指标，公式如下所示：</p>
<figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dex 信息有效率 = define <span class="keyword">methods</span>数量 / reference <span class="keyword">methods</span> 数量</span><br></pre></td></tr></table></figure>

<p><strong>如果 Dex 有效率在 80% 以上，就说明基本合格了</strong>。</p>
<h3 id="使用-ReDex-进行分包优化、去除-debug-信息及行号信息"><a href="#使用-ReDex-进行分包优化、去除-debug-信息及行号信息" class="headerlink" title="使用 ReDex 进行分包优化、去除 debug 信息及行号信息"></a>使用 ReDex 进行分包优化、去除 debug 信息及行号信息</h3><p>下面，我们就使用 <a href="https://link.juejin.cn/?target=https://fbredex.com/docs/installation">Redex</a>  来对上一步生成的 <strong>app-release-proguardwithr8.apk</strong> 进行进一步的优化。（<strong>macOS 环境下</strong>）</p>
<h4 id="1、首先，我们需要输入一下命令去去安装-Xcode-命令行工具"><a href="#1、首先，我们需要输入一下命令去去安装-Xcode-命令行工具" class="headerlink" title="1、首先，我们需要输入一下命令去去安装 Xcode 命令行工具"></a>1、首先，我们需要输入一下命令去去安装 Xcode 命令行工具</h4><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcode-<span class="keyword">select</span> <span class="comment">--install</span></span><br></pre></td></tr></table></figure>

<h4 id="2、然后，使用-homebrew-安装-redex-项目使用到的依赖库"><a href="#2、然后，使用-homebrew-安装-redex-项目使用到的依赖库" class="headerlink" title="2、然后，使用 homebrew 安装 redex 项目使用到的依赖库"></a>2、然后，使用 homebrew 安装 redex 项目使用到的依赖库</h4><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">brew </span><span class="keyword">install </span>autoconf automake libtool python3</span><br><span class="line"><span class="keyword">brew </span><span class="keyword">install </span><span class="keyword">boost </span><span class="keyword">jsoncpp</span></span><br></pre></td></tr></table></figure>

<p>需要注意的是，2020年2月10号版本源码的 <strong>redex</strong> 需要的 <strong>boost</strong> 版本为 <strong>V1.71</strong> 及以上，当你使用 <strong>brew install boost</strong> 安装 <strong>boost</strong> 时可能获取到的 <strong>boost</strong> 版本会低于 <strong>V1.71</strong>，此时可能是 <strong>brew</strong> 版本需要更新，<strong>使用 brew upgrade 去更新 brew 仓库的版本</strong> 或者可以直接从 <strong>boost</strong> 官网下载最新的 <a href="https://link.juejin.cn/?target=https://www.boost.org/">boost 源码</a> 至 <strong>&#x2F;usr&#x2F;local&#x2F;Cellar&#x2F;</strong> 目录下，我当前使用的是 <a href="https://link.juejin.cn/?target=https://dl.bintray.com/boostorg/release/1.72.0/source/">boost V1.7.2源码下载地址</a> 中的 <strong>boost_1_72_0.zip</strong>。从 <a target="_blank" rel="noopener" href="https://juejin.im/post/6844904093786308622">深入探索 Android 启动优化</a> 时就提及到了 <strong>Redex 的类重排优化</strong>，当时卡在这一步，所以一直没法真正完成类的重排优化。</p>
<h4 id="3、接着，从-Github-上获取-ReDex-的源码并切换到-redex-目录下"><a href="#3、接着，从-Github-上获取-ReDex-的源码并切换到-redex-目录下" class="headerlink" title="3、接着，从 Github 上获取 ReDex 的源码并切换到 redex 目录下"></a>3、接着，从 Github 上获取 ReDex 的源码并切换到 redex 目录下</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https:<span class="regexp">//gi</span>thub.com<span class="regexp">/facebook/</span>redex.git</span><br><span class="line">cd redex</span><br></pre></td></tr></table></figure>

<h4 id="4、下一步，使用-autoconf-和-make-去构建-ReDex"><a href="#4、下一步，使用-autoconf-和-make-去构建-ReDex" class="headerlink" title="4、下一步，使用 autoconf 和 make 去构建 ReDex"></a>4、下一步，使用 autoconf 和 make 去构建 ReDex</h4><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 如果你使用的是 gcc, 请使用 gcc-5</span></span><br><span class="line">autoreconf -ivf &amp;&amp; ./configure &amp;&amp; <span class="built_in">make</span> -j4</span><br><span class="line">sudo <span class="built_in">make</span> install</span><br></pre></td></tr></table></figure>

<h4 id="5、然后，配置-Redex-的-config-代码"><a href="#5、然后，配置-Redex-的-config-代码" class="headerlink" title="5、然后，配置 Redex 的 config 代码"></a>5、然后，配置 Redex 的 config 代码</h4><p><strong>在 Redex 在运行的时候，它是根据 redex&#x2F;config&#x2F;default.config 这个配置文件中的通道 passes 中添加不同的优化项来对 APK 的 Dex 进行处理的，我们可以参考 redex&#x2F;config&#x2F;default.config 这个默认的配置，里面的 passes 中不同的配置项都有特定的优化</strong>。为了优化 <strong>App</strong> 的包体积，我们再加上 <strong>interdex_stripdebuginfo.config</strong> 中的配置项去删除 <strong>debugInfo</strong> 和减少跨 <strong>Dex</strong> 调用的情况，最终的 <strong>interdex_stripdebuginfo.config 配置代码</strong> 如下所示：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;redex&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;passes&quot;</span> : [</span><br><span class="line">            <span class="string">&quot;StripDebugInfoPass&quot;</span>,</span><br><span class="line">            <span class="string">&quot;InterDexPass&quot;</span>,</span><br><span class="line">            <span class="string">&quot;RegAllocPass&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;StripDebugInfoPass&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;drop_all_dbg_info&quot;</span> : <span class="type">false</span>,</span><br><span class="line">        <span class="string">&quot;drop_local_variables&quot;</span> : <span class="type">true</span>,</span><br><span class="line">        <span class="string">&quot;drop_line_numbers&quot;</span> : <span class="type">false</span>,</span><br><span class="line">        <span class="string">&quot;drop_src_files&quot;</span> : <span class="type">false</span>,</span><br><span class="line">        <span class="string">&quot;use_whitelist&quot;</span> : <span class="type">false</span>,</span><br><span class="line">        <span class="string">&quot;cls_whitelist&quot;</span> : [],</span><br><span class="line">        <span class="string">&quot;method_whitelist&quot;</span> : [],</span><br><span class="line">        <span class="string">&quot;drop_prologue_end&quot;</span> : <span class="type">true</span>,</span><br><span class="line">        <span class="string">&quot;drop_epilogue_begin&quot;</span> : <span class="type">true</span>,</span><br><span class="line">        <span class="string">&quot;drop_all_dbg_info_if_empty&quot;</span> : <span class="type">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;InterDexPass&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;minimize_cross_dex_refs&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;minimize_cross_dex_refs_method_ref_weight&quot;</span>: <span class="number">100</span>,</span><br><span class="line">        <span class="string">&quot;minimize_cross_dex_refs_field_ref_weight&quot;</span>: <span class="number">90</span>,</span><br><span class="line">        <span class="string">&quot;minimize_cross_dex_refs_type_ref_weight&quot;</span>: <span class="number">100</span>,</span><br><span class="line">        <span class="string">&quot;minimize_cross_dex_refs_string_ref_weight&quot;</span>: <span class="number">90</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;RegAllocPass&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;live_range_splitting&quot;</span>: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;string_sort_mode&quot;</span> : &quot;<span class="type">class_order</span><span class="string">&quot;,</span></span><br><span class="line"><span class="string">    &quot;</span>bytecode_sort_mode<span class="string">&quot; : &quot;</span>class_order<span class="string">&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="6、最后，执行相应的-redex-优化命令"><a href="#6、最后，执行相应的-redex-优化命令" class="headerlink" title="6、最后，执行相应的 redex 优化命令"></a>6、最后，执行相应的 redex 优化命令</h4><p>这里我们使用 Redex 命令对上一 <strong>Dex</strong> 优化中得到的 <strong>app_release-proguardwithr8.apk</strong> 进行 <strong>Dex 分包优化和去除 debugInfo</strong>，它使用了贪心这种局部最优解的方式去减少跨 <strong>Dex</strong> 调用造成的信息冗余，命令如下所示（注意，<strong>在 redex 的前面可能需要加上 Android sdk 的路径，因为 redex 中使用到了sdk下的zipalign工具</strong>）：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ANDROID_SDK=<span class="regexp">/Users/</span>quchao<span class="regexp">/Library/</span>Android<span class="regexp">/sdk redex --sign -s wan-android-key.jks -a wanandroid -p wanandroid -c ~/</span>Desktop<span class="regexp">/interdex_stripdebuginfo.config -P app/</span>proguard-rules.pro -o ~<span class="regexp">/Desktop/</span>app-release-proguardwithr8-stripdebuginfo-interdex.apk ~<span class="regexp">/Desktop/</span>app-release-proguardwithr8.apk</span><br></pre></td></tr></table></figure>

<p>上述 <strong>redex</strong> 命令的 <strong>关键参数含义</strong> 如下所示：</p>
<ul>
<li><strong>–sign：对生成的apk进行签名</strong>。</li>
<li><strong>-s：配置应用的签名文件</strong>。</li>
<li><strong>-a: 配置应用签名的 key_alias</strong>。</li>
<li><strong>-p：配置应用签名的 key_password</strong>。</li>
<li><strong>-c：指定 redex 进行 Dex 处理时需要依据的 CONFIG 配置文件</strong>。</li>
<li><strong>-o：指定生成 APK 的全路径</strong>。</li>
</ul>
<p>使用上面的 redex 命令我们就可以对优化后的 <strong>APK</strong> 进行 <strong>再签名和混淆</strong>，等待一会后（如果你的 <strong>APK</strong> 的 <strong>Dex</strong> 数量和体积很大，可能会比较久），就会生成 <strong>优化后的 APK：app-release-proguardwithr8-stripdebuginfo-interdex.apk</strong>，如下图所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/245bd93427074030b4f41adc46e55ea0~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p>可以看到，我们的 <strong>APK</strong> 大小几乎没有变化，这是因为当前的 <strong>APK</strong> 只有一个 <strong>Dex</strong>，并且 <strong>第一个 Dex 默认不会优化</strong>。为了能实际看到 <strong>redex</strong> 的优化效果，我们采用一个新项目来进行实验，项目地址如下所示：</p>
<p><a href="https://link.juejin.cn/?target=https://github.com/AndroidAdvanceWithGeektime/Chapter22">redex 优化 Apk 项目地址</a></p>
<p>首先，引入一大堆开源库，尝试把 <strong>Dex</strong> 数量变多一些。然后直接通过 <strong>assembleDebug</strong> 编译即可。此外，为了可以更加清楚流程，我们可以在 <strong>命令行输入 export TRACE&#x3D;2 以便可以输出 redex 的日志</strong>。最后，我们输入下面的 redex 命令删除 dex 中的 debugInfo 和减少跨 dex 调用的情况，如下所示：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redex --sign -s ReDexSample<span class="regexp">/keystore/</span>debug.keystore -a androiddebugkey -p android -c redex-test<span class="regexp">/interdex_stripdebuginfo.config -P ReDexSample/</span>proguard-rules.pro  -o redex-test<span class="regexp">/strip_output.apk ReDexSample/</span>build<span class="regexp">/outputs/</span>apk<span class="regexp">/debug/</span>ReDexSample-debug.apk</span><br></pre></td></tr></table></figure>

<p>最终，我们看到前后的 APK 体积对比图如下所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1eafd9da99014426b3118168443473b8~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ca10878831a848728a28f589a5569c37~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p>可以看到，<strong>APK 的大小从 14.2MB 减少到了 12.8MB，优化效果大概有10%<strong>，效果还是比较明显的。此外，</strong>如果你的 App 的 Dex 数量越多，那么优化的效果就会越大</strong>。</p>
<h2 id="6、使用-XZ-Utils-进行-Dex-压缩"><a href="#6、使用-XZ-Utils-进行-Dex-压缩" class="headerlink" title="6、使用 XZ Utils 进行 Dex 压缩"></a>6、使用 XZ Utils 进行 Dex 压缩</h2><p><a href="https://link.juejin.cn/?target=https://tukaani.org/xz/">XZ Utils 官文文档</a></p>
<p>XZ Utils 是具有高压缩率的免费通用数据压缩软件，它<strong>同 7-Zip 一样，都是 LZMA Utils 的后继产品，内部使用了 LZMA&#x2F;LZMA2 算法。LZMA 提供了高压缩比和快速解压缩，因此非常适合嵌入式应用</strong>。<strong>LZMA</strong> 的 <strong>主要功能</strong> 如下：</p>
<ul>
<li>1）、<strong>压缩速度</strong>：在3 GHz双核CPU上为3 MB &#x2F; s。</li>
<li>2）、<strong>减压速度</strong>：在现代3 GHz CPU（Intel，AMD，ARM）上为20-50 MB &#x2F; s。在简单的1 GHz RISC - CPU（ARM，MIPS，PowerPC）上为5-15 MB &#x2F; s。</li>
<li>3）、<strong>解压缩的较小内存要求</strong>：8-32 KB + DictionarySize。</li>
<li>4）、<strong>用于解压缩的代码大小</strong>：2-8 KB（取决于速度优化）。</li>
</ul>
<p>相对于典型的压缩文件而言，<strong>XZ Utils 的输出比 gzip 小 30％，比 bzip2 小 15％</strong>。在 <strong>FaceBook</strong> 的 <strong>App</strong> 中就使用了 <strong>Dex 压缩</strong> 的方式，而且它 <strong>将 Dex 压缩后的文件都放在了 assets 目录中</strong>，如下图所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bb65eca31bbf4c1099bfcda1cf74287e~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a19bf988566e494693a2413a71e363dd~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p>我们先看到上图中的 <strong>classes.dex，其中仅包含了启动时要用到的类，这样可以为 Dex 压缩文件 secondary.dex.jar.xzs 的解压争取时间</strong>。</p>
<p>此外，在 secondary.dex.jar.xzs 文件的下面，我们注意到，<strong>有一系列的 secondary-x.dex.jar.xzs.tmp~.meta 文件，它保存了压缩前每一个 Dex 文件的映射元数据信息，在应用首次启动解压的时候我们还需要用到它</strong>。</p>
<p>尽管 <strong>classes.dex 为首次启动解压 Dex 压缩文件争取了时间，但是由于文件太大，在低端机上的解压时间可能会有 3~5s</strong>。</p>
<p>而且，<strong>当 Dex  非常多的时候会增加应用的安装时间，如果还使用了压缩 Dex 的方式，那么首次生成 ODEX 的时间可能就会超过1分钟</strong>。为了解决这个问题，<strong>Facebook</strong> 使用了 <strong>oatmeal</strong> 这套工具去 <strong>根据 ODEX 文件的格式，自己生成了一个 ODEX 文件</strong>。而在 <strong>正常的流程</strong> 下，<strong>系统会使用 fork 子进程的方式去处理 dex2oat 的过程</strong>。</p>
<p>但是，<strong>oatmeal</strong> 采用了 <strong>代理 dex2oat 省去 fork 进程所带来耗时</strong> 的这种方式，<strong>如果在1个 10MB 的 Dex，可以将 dex2oat 的耗时降至 100ms，而在 Android 5.0 上生成一个 ODEX 的耗时大约在 10 秒以上，在 Android 8.0 使用 speed 模式也需要 1 秒左右的时间</strong>。但是由于 <strong>每个 Android 系统版本的 ODEX 格式都有一些差异，oatmeal  需要分版本适配</strong>，因此 Dex 压缩的方案我们可以先压压箱底。</p>
<h2 id="7、三方库处理"><a href="#7、三方库处理" class="headerlink" title="7、三方库处理"></a>7、三方库处理</h2><p>实际的开发过程中，我们会用到各种各样的三方库。尤其当项目变大之后，开发人员众多，因此引入的三方库也会非常多，比如说，有人引入了一个 <strong>Fresco</strong> 图片库，然后这个库你可能不熟悉，你会引入一个 <strong>Glide</strong>，并且另一个人它可能又会引入他熟悉的图片库 <strong>Picasso</strong>，所以项目中可能会存在多个相同功能的三方 <strong>SDK</strong>，这一点，在大型项目当中一定会存在。因此，我们在做代码瘦身的时候，需要将三方库进行统一，比如说 <strong>将图片加载库、网络库、数据库以及其他基础库进行统一，去掉冗余的库</strong>。</p>
<p>同时，在选择第三方 <strong>SDK</strong> 的时候，我们可以将包大小作为选择的指标之一，我们应该 <strong>尽可能地选择那些比较小的库来实现相同的功能</strong>。例如，对于图片加载功能来说，<strong>Picasso、Glide、Fresco</strong> 它们都可以实现，但是你引入 <strong>Fresco</strong> 之后会导致包大小增加很多，而 <strong>Picasso</strong> 却只增加了不到 <strong>100kb</strong>，所以引入不同的三方 <strong>SDK</strong> 对包大小的影响是不一样的。这里，我们可以使用 <strong>AS 插件 Android Methods Count</strong>，安装之后，它会<strong>自动在 build.gradle 文件中显示你引入的三方库的方法数</strong>。</p>
<p>最后，如果我们引入三方库的时候，可以 <strong>只引入部分需要的代码</strong>，而不是将整个包的代码都引入进来。很多库的代码结构都设计的比较好，比如 <strong>Fresco</strong>，它将图片加载的各个功能，如 <strong>webp、gif 功能进行了剥离，它们都处于单个的库当中</strong>。如果我们只需要 <strong>Fresco</strong> 的 <strong>webp</strong> 功能，那我们可以将除 <strong>webp</strong> 之外的别的库都给删掉，这样你引入的三方库就很小了，包大小就降下来了。如下所图所示，我们可以<strong>仅仅保留 Fresco 的 webp 功能</strong>，其它依赖都可以去掉。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0a0c556152a945c8a847b5fb6737ee31~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p>如果你引入的三方库 <strong>没有进行过结构剥离</strong>，就需要 <strong>修改源码，只提取出来你需要的功能即可</strong>。</p>
<h2 id="8、移除无用代码"><a href="#8、移除无用代码" class="headerlink" title="8、移除无用代码"></a>8、移除无用代码</h2><p>移除无用代码时我们经常会碰到下面两个问题：</p>
<ul>
<li>1）、<strong>业务代码只增不减</strong>。</li>
<li>2）、<strong>代码太多不敢删除</strong>。</li>
</ul>
<p>这里，有一个很好的方法可以 <strong>准确地判断哪些类在线上环境下用户肯定不会用到了</strong>。我们可以通过 <strong>AOP</strong> 的方式来做，对于 <strong>Activity</strong> 来说，其实非常简单，我们只需要 <strong>在每个 Activity 的 onCreate 当中加上统计</strong> 即可，然后<strong>到了线上之后，如果这个 Activity 被统计了，就说明它还在被使用</strong>。而对于那些 <strong>不是 Activity 的类</strong>，我们可以 <strong>利用 AOP 来切它们的构造函数</strong>，一个类如果它被使用，那它的构造函数肯定会被调用到。例如，下面就是 <strong>使用 AspectJ 对某个包下的类进行构造函数切面</strong> 的代码：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@<span class="constructor">After(<span class="string">&quot;execution(org.jay.launchstarter.Task.new(..)&quot;</span>)</span></span><br><span class="line">public void <span class="keyword">new</span><span class="constructor">Object(JoinPoint <span class="params">point</span>)</span> &#123;</span><br><span class="line">    <span class="module-access"><span class="module"><span class="identifier">LogHelper</span>.</span></span>i(<span class="string">&quot; new &quot;</span> + point.get<span class="constructor">Target()</span>.get<span class="constructor">Class()</span>.get<span class="constructor">SimpleName()</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中，<strong>new</strong> 表示是 <strong>切的构造函数</strong>，括号中的 .. 表示的是 <strong>匹配所有构造参数</strong>。此外，我们也可以直接使用 <a href="https://link.juejin.cn/?target=https://github.com/bytedance/ByteX/blob/master/coverage/README-zh.md">coverage 插件</a> 来做 <strong>线上无用代码分析</strong>，需要注意的是，<strong>在注册上报数据的时候记得把服务器名改为自己的</strong>。</p>
<p>最后，我们也可以在线下使用 <a href="https://link.juejin.cn/?target=https://blog.csdn.net/Love667767/article/details/53558382">Simian工具</a> 或者 Lint 来 <strong>扫描出重复的代码</strong>。</p>
<h3 id="使用-Lint-检测无效代码"><a href="#使用-Lint-检测无效代码" class="headerlink" title="使用 Lint 检测无效代码"></a>使用 Lint 检测无效代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">步骤：点击菜单栏 Analyze -&gt; Run Inspection by Name -&gt; unused declaration -&gt; Moudule ‘app’ -&gt; OK</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="9、避免产生-Java-access-方法"><a href="#9、避免产生-Java-access-方法" class="headerlink" title="9、避免产生 Java access 方法"></a>9、避免产生 Java access 方法</h2><h3 id="access-方法是什么？"><a href="#access-方法是什么？" class="headerlink" title="access 方法是什么？"></a>access 方法是什么？</h3><p>为了能提供内部类和其外部类直接访问对方的私有成员的能力，又不违反封装性要求，<strong>Java 编译器在编译过程中自动生成 package 可见性的静态 access$xxx 方法，并且在需要访问对方私有成员的地方改为调用对应的 access 方法</strong>。</p>
<h3 id="避免产生-access-方法的方式"><a href="#避免产生-access-方法的方式" class="headerlink" title="避免产生 access 方法的方式"></a>避免产生 access 方法的方式</h3><p>主要有 <strong>两种方式</strong> 避免产生 <strong>access</strong> 方法：</p>
<ul>
<li>1）、<strong>在开发过程中需要注意在可能产生 access 方法的情况下适当调整，比如去掉 private，改为 package 可见性</strong>。</li>
<li>2）、<strong>使用 ASM 在编译时删除生成的 access 方法</strong>。</li>
</ul>
<p>因为优化效果不是很明显，这里就不多介绍了，具体的实现细节可参见 <a href="https://link.juejin.cn/?target=https://mp.weixin.qq.com/s/ZHisCVjO_ZrtvvEWBYUQFQ">西瓜视频 apk 瘦身之 Java access 方法删除</a>，此外，在 <strong>ReDex</strong> 中也提供了  <a href="https://link.juejin.cn/?target=https://github.com/facebook/redex/tree/master/opt/access-marking">access-marking</a> 这个功能去除代码中的 <strong>Access</strong> 方法，并且，在 ReDex 还有 <a href="https://link.juejin.cn/?target=https://github.com/facebook/redex/tree/master/opt/type-erasure">type-erasure</a> 的功能，它 <strong>与 access-marking 的优化效果一样，不仅能减少包大小，也能提升 App 的启动速度</strong>。</p>
<h2 id="10、利用-ByteX-Gradle-插件平台中的代码优化插件"><a href="#10、利用-ByteX-Gradle-插件平台中的代码优化插件" class="headerlink" title="10、利用 ByteX Gradle 插件平台中的代码优化插件"></a>10、利用 ByteX Gradle 插件平台中的代码优化插件</h2><p>如果你想在项目的编译阶段去除 <strong>access</strong> 方法，这里我更加建议直接使用 <strong>ByteX</strong> 的 <a href="https://link.juejin.cn/?target=https://github.com/bytedance/ByteX/blob/master/access-inline-plugin/README-zh.md">access_inline</a> 插件。除了 <strong>access_inlie</strong> 之外，在 <strong>ByteX</strong> 中还有 <strong>四个</strong> 很实用的代码优化 <strong>Gradle</strong> 插件可以帮助我们有效减小 <strong>Dex</strong> 文件的大小，如下所示：</p>
<ul>
<li>1、编译期间 <strong>内联常量字段</strong>：<a href="https://link.juejin.cn/?target=https://github.com/bytedance/ByteX/blob/master/const-inline-plugin/README-zh.md">const_inline</a>。</li>
<li>2、编译期间 <strong>移除多余赋值代码</strong>：<a href="https://link.juejin.cn/?target=https://github.com/bytedance/ByteX/blob/master/field-assign-opt-plugin/README-zh.md">field_assign_opt</a>。</li>
<li>3、编译期间 <strong>移除 Log 代码</strong>：<a href="https://link.juejin.cn/?target=https://github.com/bytedance/ByteX/blob/master/method-call-opt-plugin/README-zh.md">method_call_opt</a>。</li>
<li>4、编译期间 <strong>内联 Get &#x2F; Set 方法</strong>：<a href="https://link.juejin.cn/?target=https://github.com/bytedance/ByteX/blob/master/getter-setter-inline-plugin/README-zh.md">getter-setter-inline-plugin</a>。</li>
</ul>
<h2 id="11、小结"><a href="#11、小结" class="headerlink" title="11、小结"></a>11、小结</h2><p>回顾下我们上述使用的各种 <strong>Dex</strong> 优化方式，其中，不少优化项都使用到了 <strong>ReDex</strong>。对于 ReDex 来说，目前它提供的比较强大的功能有 <strong>五种</strong>，分别如下所示：</p>
<ul>
<li>1）、<strong>Interdex：类重排和文件重排、Dex 分包优化。其中对于类重排和文件重排，Google 在 Android 8.0 的时候引入了 Dexlayout，它是一个用于分析 dex 文件，并根据配置文件对其进行重新排序的库。与 ReDex 类似，Dexlayout 通过将经常一起访问的部分 dex  文件集中在一起，程序可以因改进文件位置从而拥有更好的内存访问模式，以节省 RAM  并缩短启动时间。不同于ReDex的是它使用了运行时配置信息对 Dex  文件的各个部分进行重新排序。因此，只有在应用运行之后，并在系统空闲维护的时候才会将 dexlayout 集成到 dex2oat 的设备进行编译</strong>。</li>
<li>2）、<strong>Oatmeal：直接生成 Odex 文件</strong>。</li>
<li>3）、<strong>StripDebugInfo：去除 Dex 中的 Debug 信息</strong>。</li>
<li>4）、<strong>源码中 access-marking 模块：删除 Java access 方法</strong>。</li>
<li>5）、<strong>源码中 type-erasure 模块：类型擦除</strong>。</li>
</ul>
<p>可以看到，<strong>ReDex</strong> 的功能非常强大，<strong>如果能够深入了解 ReDex 源码中的各个功能模块的实现，你将具有非常强硬的技术资本</strong>。</p>
<p>最近，<strong>抖音 Android 团队</strong> 已经将上述部分模块的实现以 <strong>Gradle Transform + ASM</strong> 的形式集成进了  <a href="https://link.juejin.cn/?target=https://github.com/bytedance/ByteX">ByteX</a>，建议掌握其实现原理后，大家可以直接在这个字节码插件开发平台上开发自己的 <strong>Gradle</strong> 插件。</p>
<p>最后，还有一些 <strong>代码编写方面的优化</strong>，如可以在开发过程 <strong>尽量减少 enum 的使用，每减少一个 enum 可以减少大约 1.0 到 1.4 KB 的大小</strong>。</p>
<h1 id="三、资源瘦身方案探索"><a href="#三、资源瘦身方案探索" class="headerlink" title="三、资源瘦身方案探索"></a>三、资源瘦身方案探索</h1><p>众所周知，<strong>Android</strong> 构建工具链中使用了 <strong>AAPT&#x2F;AAPT2</strong> 工具来对资源进行处理，<strong>Manifest、Resources、Assets 的资源经过相应的 ManifesMerger、ResourcesMerger、AssetsMerger 资源合并器将多个不同 moudule 的资源合并为了 MergedManifest、MergedResources、MergedAssets。然后，它们被 AAPT 处理后生成了 R.java、Proguard Configuration、Compiled Resources</strong>。如下图左上方所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1e134ae18c474d1cbcc522110be213f0~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p>其中 <strong>Proguard Configuration、Compiled Resources</strong> 的 <strong>作用</strong> 如下所示：</p>
<ul>
<li><strong>Proguard Configuration：这是AAPT工具为Manifest中声明的四大组件与布局文件中使用的各种Views所生成的混淆配置</strong>，该文件通常存放在 <code>$&#123;project.buildDir&#125;/$&#123;AndroidProject.FD_INTERMEDIATES&#125;/proguard-rules/$&#123;flavorName&#125;/$&#123;buildType&#125;/aapt_rules.txt</code>。</li>
<li><strong>Compiled Resources：它是一个Zip格式的文件</strong>，这个文件的路径通常为 <code>$&#123;project.buildDir&#125;/$&#123;AndroidProject.FD_INTERMEDIATES&#125;/res/resources-$&#123;flavorName&#125;-$&#123;buildType&#125;-stripped.ap_</code>。在经过 <strong>zip</strong> 解压之后，可以发现它 <strong>包含了res、AndroidManifest.xml和resources.arsc 这三部分</strong>。并且，从上面的 <strong>APK</strong> 构建流程中可以得知，<strong>Compiled Resources</strong> 会被 <strong>apkbuilder</strong> 打包到 <strong>APK</strong> 包中，它其实就是 <strong>APK</strong> 的<strong>资源包</strong>。因此，我们可以 <strong>通过 Compiled Resources 文件来修改不同后缀文件资源的压缩方式来达到瘦身效果的</strong>。但是需要注意的是，<strong>resources.arsc 文件最好不要压缩存储，如果压缩会影响一定的性能，尤其是在冷启动时间方面造成的影响</strong>。并且，<strong>如果在 Android 6.0 上开启了 android:extractNativeLibs&#x3D;”false” 的话，So 文件也不能被压缩</strong>。</li>
</ul>
<h2 id="1、冗余资源优化"><a href="#1、冗余资源优化" class="headerlink" title="1、冗余资源优化"></a>1、冗余资源优化</h2><h3 id="1、使用-Lint-的-Remove-Unused-Resource"><a href="#1、使用-Lint-的-Remove-Unused-Resource" class="headerlink" title="1、使用 Lint 的 Remove Unused Resource"></a>1、使用 Lint 的 Remove Unused Resource</h3><p><strong>APK</strong> 的资源主要包括图片、<strong>XML</strong>，与冗余代码一样，它也可能遗留了很多旧版本当中使用而新版本中不使用的资源，这点在快速开发的 <strong>App</strong> 中更可能出现。我们可以通过点击右键，选中 <strong>Refactor</strong>，然后点击 <strong>Remove Unused Resource &#x3D;&gt; preview</strong> 可以预览找到的无用资源，点击 <strong>Do Refactor</strong> 可以去除冗余资源。如下图所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d952f02035f346e5a092193ff8c7fe4a~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p>需要注意的，<strong>Android Lint 不会分析 assets 文件夹下的资源，因为 assets 文件可以通过文件名直接访问，不需要通过具体的引用，Lint 无法判断资源是否被用到</strong>。</p>
<h3 id="2、优化-shrinkResources-流程真正去除无用资源"><a href="#2、优化-shrinkResources-流程真正去除无用资源" class="headerlink" title="2、优化 shrinkResources 流程真正去除无用资源"></a>2、优化 shrinkResources 流程真正去除无用资源</h3><p><strong>resources.arsc</strong> 中可能会存在很多 <strong>无用的资源映射</strong>，我们可以使用 <a href="https://link.juejin.cn/?target=https://github.com/google/android-arscblamer">android-arscblamer</a>，它是一个命令行工具，能够 <strong>解析 resources.arsc  文件并检查出可以优化的部分</strong>，比如一些空的引用。</p>
<p>此外，当我们通过 <strong>shrinkResources true</strong> 来 <strong>开启资源压缩</strong>，资源压缩工具只会把无用的资源替换成预定义的版本而不是移除。那么，<strong>如何高效地对无用资源自动进行去除呢？</strong></p>
<p>我们可以 <strong>在 Android 构建工具执行 package${flavorName}Task 之前通过修改 Compiled Resources 来实现自动去除无用资源</strong>，具体的实现原理如下：</p>
<h4 id="1）、首先，收集-Compiled-Resources-中被替换的预定义版本的资源名称"><a href="#1）、首先，收集-Compiled-Resources-中被替换的预定义版本的资源名称" class="headerlink" title="1）、首先，收集 Compiled Resources 中被替换的预定义版本的资源名称"></a>1）、首先，收集 Compiled Resources 中被替换的预定义版本的资源名称</h4><p><strong>通过查看 Zip 格式资源包中每个 ZipEntry 的 CRC-32 checksum 来寻找被替换的预定义资源，预定义资源的 CRC-32 定义在 ResourceUsageAnalyze 中</strong>，如下所示：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A 1x1 pixel PNG of type BufferedImage.TYPE_BYTE_GRAY</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> TINY_PNG_CRC = <span class="number">0</span>x88b2a3b0L;</span><br><span class="line"></span><br><span class="line"><span class="comment">// A 3x3 pixel PNG of type BufferedImage.TYPE_INT_ARGB with 9-patch markers</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> TINY_9PNG_CRC = <span class="number">0</span>x1148f987L;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The XML document &lt;x/&gt; as binary-packed with AAPT</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> TINY_XML_CRC = <span class="number">0</span>xd7e65643L;</span><br></pre></td></tr></table></figure>

<h4 id="2）、然后，使用-android-chunk-utils-把-resources-arsc-中对应的定义移除。"><a href="#2）、然后，使用-android-chunk-utils-把-resources-arsc-中对应的定义移除。" class="headerlink" title="2）、然后，使用 android-chunk-utils  把 resources.arsc 中对应的定义移除。"></a>2）、然后，使用 <a href="https://link.juejin.cn/?target=https://github.com/madisp/android-chunk-utils">android-chunk-utils</a>  把 resources.arsc 中对应的定义移除。</h4><h4 id="3）、最后，删除资源包中对应的资源文件即可。"><a href="#3）、最后，删除资源包中对应的资源文件即可。" class="headerlink" title="3）、最后，删除资源包中对应的资源文件即可。"></a>3）、最后，删除资源包中对应的资源文件即可。</h4><h2 id="2、重复资源优化"><a href="#2、重复资源优化" class="headerlink" title="2、重复资源优化"></a>2、重复资源优化</h2><p>在大型 <strong>App</strong> 项目的开发中，一个 <strong>App</strong> 一般会有多个业务团队进行开发，其中每个业务团队在资源提交时的资源名称可能会有重复的，这将会 <strong>引发资源覆盖的问题</strong>，因此，每个业务团队都会为自己的 <strong>资源文件名添加前缀</strong>。这样就导致了这些资源文件虽然 <strong>内容相同</strong>，但因为 <strong>名称的不同而不能被覆盖</strong>，最终都会被集成到 <strong>APK</strong> 包中。这里，我们还是可以 <strong>在 Android 构建工具执行 package${flavorName}Task 之前通过修改 Compiled Resources 来实现重复资源的去除</strong>，具体放入实现原理可细分为如下三个步骤：</p>
<ul>
<li>1）、首先，<strong>通过资源包中的每个ZipEntry的CRC-32 checksum来筛选出重复的资源</strong>。</li>
<li>2）、然后，<strong>通过<a href="https://link.juejin.cn/?target=https://github.com/madisp/android-chunk-utils">android-chunk-utils</a>修改resources.arsc，把这些重复的资源都重定向到同一个文件上</strong>。</li>
<li>3）、最后，<strong>把其它重复的资源文件从资源包中删除，仅保留第一份资源</strong>。</li>
</ul>
<p>具体的实现代码如下所示：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">variantData.outputs.each &#123;</span><br><span class="line">    def apFile = it.packageAndroidArtifactTask.get<span class="constructor">ResourceFile()</span>;</span><br><span class="line"></span><br><span class="line">    it.packageAndroidArtifactTask.doFirst &#123;</span><br><span class="line">        def arscFile = <span class="keyword">new</span> <span class="constructor">File(<span class="params">apFile</span>.<span class="params">parentFile</span>, <span class="string">&quot;resources.arsc&quot;</span>)</span>;</span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">JarUtil</span>.</span></span>extract<span class="constructor">ZipEntry(<span class="params">apFile</span>, <span class="string">&quot;resources.arsc&quot;</span>, <span class="params">arscFile</span>)</span>;</span><br><span class="line"></span><br><span class="line">        def HashMap&lt;String, ArrayList&lt;DuplicatedEntry&gt;&gt; duplicatedResources = find<span class="constructor">DuplicatedResources(<span class="params">apFile</span>)</span>;</span><br><span class="line"></span><br><span class="line">        remove<span class="constructor">ZipEntry(<span class="params">apFile</span>, <span class="string">&quot;resources.arsc&quot;</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (arscFile.exists<span class="literal">()</span>) &#123;</span><br><span class="line">            FileInputStream arscStream = null;</span><br><span class="line">            ResourceFile resourceFile = null;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                arscStream = <span class="keyword">new</span> <span class="constructor">FileInputStream(<span class="params">arscFile</span>)</span>;</span><br><span class="line"></span><br><span class="line">                resourceFile = <span class="module-access"><span class="module"><span class="identifier">ResourceFile</span>.</span></span>from<span class="constructor">InputStream(<span class="params">arscStream</span>)</span>;</span><br><span class="line">                List&lt;Chunk&gt; chunks = resourceFile.get<span class="constructor">Chunks()</span>;</span><br><span class="line"></span><br><span class="line">                HashMap&lt;String, String&gt; toBeReplacedResourceMap = <span class="keyword">new</span> HashMap&lt;String, String&gt;(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 处理arsc并删除重复资源</span></span><br><span class="line">                Iterator&lt;Map.Entry&lt;String, ArrayList&lt;DuplicatedEntry&gt;&gt;&gt; iterator = duplicatedResources.entry<span class="constructor">Set()</span>.iterator<span class="literal">()</span>;</span><br><span class="line">                <span class="keyword">while</span> (iterator.has<span class="constructor">Next()</span>) &#123;</span><br><span class="line">                    Map.Entry&lt;String, ArrayList&lt;DuplicatedEntry&gt;&gt; duplicatedEntry = iterator.next<span class="literal">()</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 保留第一个资源，其他资源删除掉</span></span><br><span class="line">                    <span class="keyword">for</span> (def index = <span class="number">1</span>; index &lt; duplicatedEntry.value.size<span class="literal">()</span>; ++index) &#123;</span><br><span class="line">                        remove<span class="constructor">ZipEntry(<span class="params">apFile</span>, <span class="params">duplicatedEntry</span>.<span class="params">value</span>.<span class="params">get</span>(<span class="params">index</span>)</span>.name);</span><br><span class="line"></span><br><span class="line">                        toBeReplacedResourceMap.put(duplicatedEntry.value.get(index).name, duplicatedEntry.value.get(<span class="number">0</span>).name);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (def index = <span class="number">0</span>; index &lt; chunks.size<span class="literal">()</span>; ++index) &#123;</span><br><span class="line">                    Chunk chunk = chunks.get(index);</span><br><span class="line">                    <span class="keyword">if</span> (chunk instanceof ResourceTableChunk) &#123;</span><br><span class="line">                        ResourceTableChunk resourceTableChunk = (ResourceTableChunk) chunk;</span><br><span class="line">                        StringPoolChunk stringPoolChunk = resourceTableChunk.get<span class="constructor">StringPool()</span>;</span><br><span class="line">                        <span class="keyword">for</span> (def i = <span class="number">0</span>; i &lt; stringPoolChunk.stringCount; ++i) &#123;</span><br><span class="line">                            def key = stringPoolChunk.get<span class="constructor">String(<span class="params">i</span>)</span>;</span><br><span class="line">                            <span class="keyword">if</span> (toBeReplacedResourceMap.contains<span class="constructor">Key(<span class="params">key</span>)</span>) &#123;</span><br><span class="line">                                stringPoolChunk.set<span class="constructor">String(<span class="params">i</span>, <span class="params">toBeReplacedResourceMap</span>.<span class="params">get</span>(<span class="params">key</span>)</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; catch (IOException ignore) &#123;</span><br><span class="line">            &#125; catch (FileNotFoundException ignore) &#123;</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                <span class="keyword">if</span> (arscStream != null) &#123;</span><br><span class="line">                    <span class="module-access"><span class="module"><span class="identifier">IOUtils</span>.</span></span>close<span class="constructor">Quietly(<span class="params">arscStream</span>)</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                arscFile.delete<span class="literal">()</span>;</span><br><span class="line">                arscFile &lt;&lt; resourceFile.<span class="keyword">to</span><span class="constructor">ByteArray()</span>;</span><br><span class="line"></span><br><span class="line">                add<span class="constructor">ZipEntry(<span class="params">apFile</span>, <span class="params">arscFile</span>)</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，我们再看看图片压缩这一项。</p>
<h2 id="3、图片压缩"><a href="#3、图片压缩" class="headerlink" title="3、图片压缩"></a>3、图片压缩</h2><p>一般来说，<strong>1000行代码在APK中才会占用 5kb 的空间</strong>，而图片呢，一般都有 <strong>100kb</strong> 左右，所以说，对图片做压缩，它的收益明显是更大的，而往往处于快速开发的 <strong>App</strong> 没有相关的开发规范，<strong>UI</strong> 设计师或开发同学如果忘记了添加图片时进行压缩，添加的就是原图，那么包体积肯定会增大很多。对于图片压缩，我们可以在 <a href="https://link.juejin.cn/?target=https://tingpng.com/">tinypng</a> 这个网站进行图片压缩，但是如果 <strong>App</strong> 的图片过多，一个个压缩也是很麻烦的。因此，我们可以 <strong>使用 <a href="https://link.juejin.cn/?target=https://github.com/smallSohoSolo/McImage/blob/master/README-CN.md">McImage</a>、<a href="https://link.juejin.cn/?target=https://github.com/Deemonser/TinyPngPlugin">TinyPngPlugin</a> 或 <a href="https://link.juejin.cn/?target=https://github.com/meili/TinyPIC_Gradle_Plugin/blob/master/README.zh-cn.md">TinyPIC_Gradle_Plugin</a> 来对图片进行自动化批量压缩</strong>。但是，需要注意的是，<strong>在 Android 的构建流程中，AAPT 会使用内置的压缩算法来优化 res&#x2F;drawable&#x2F; 目录下的 PNG 图片，但这可能会导致本来已经优化过的图片体积变大</strong>，因此，可以通过在 <strong>build.gradle</strong> 中 <strong>设置 cruncherEnabled 来禁止 AAPT 来优化 PNG 图片</strong>，代码如下所示：</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">aaptOptions</span> &#123;</span><br><span class="line">    cruncherEnabled <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此外，我们还要注意对图片格式的选择，对于我们普遍使用更多的 <strong>png</strong> 或者是 <strong>jpg</strong> 格式来说，相同的图片转换为 <strong>webp</strong> 格式之后会有大幅度的压缩。<strong>对于 png 来说，它是一个无损格式，而 jpg 是有损格式。jpg 在处理颜色图片很多时候根据压缩率的不同，它有时候会去掉我们肉眼识别差距比较小的颜色，但是 png 会严格地保留所有的色彩</strong>。所以说，在图片尺寸大，或者是色彩鲜艳的时候，<strong>png</strong> 的体积会明显地大于 <strong>jpg</strong>。</p>
<p>下面，我们就着重讲解下如何针对性地选择图片格式。</p>
<h2 id="4、使用针对性的图片格式"><a href="#4、使用针对性的图片格式" class="headerlink" title="4、使用针对性的图片格式"></a>4、使用针对性的图片格式</h2><p>在 <strong>Google I&#x2F;O 2016</strong> 中，讲到了如何选择相应的图片格式。首先，<strong>如果能用 VectorDrawable 来表示的话，则优先使用 VectorDrawable；否则，看是否支持 WebP，支持则优先用 WebP；如果也不能使用 WebP，则优先使用 PNG，而 PNG 主要用在展示透明或者简单的图片，对于其它场景可以使用 JPG 格式</strong>。简单来说可以归结为如下套路：</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">VD（纯色<span class="function"><span class="title">icon</span>）-&gt;</span>W<span class="function"><span class="title">ebP</span>（非纯色icon）-&gt;</span>P<span class="function"><span class="title">ng</span>（更好效果） -&gt;</span>jpg（若无alpha通道）</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>用 <strong>图形化</strong> 的形式如下所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a6eaa9bb40544b4ca512e336ad6384f2~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p>使用矢量图片之后，它能够有效的减少应用中图片所占用的大小，<strong>矢量图形在 Android 中表示为 VectorDrawable 对象</strong>。它 <strong>仅仅需100字节的文件即可以生成屏幕大小的清晰图像</strong>，但是，<strong>Android 系统渲染每个 VectorDrawable 对象需要大量的时间，而较大的图像需要更长的时间</strong>。 因此，建议 <strong>只有在显示纯色小 icon 时才考虑使用矢量图形</strong>。（我们可以利用这个 <a href="https://link.juejin.cn/?target=http://inloop.github.io/svg2android/">在线工具</a> 将矢量图转换成 VectorDrawable）。</p>
<p>最后，如果要在项目中使用 VD，则以下几点需要着重注意：</p>
<ul>
<li><p>1）、<strong>必须通过 app:arcCompat 属性来使用 svg，如果通过 src，则在低版本手机上会出现不兼容的问题</strong>。</p>
</li>
<li><p>2）、可能会<strong>不兼容selector</strong>，在 <strong>Activity</strong> 中手动兼容即可，兼容代码如下所示：</p>
<p><code> static &#123;                            AppCompatDelegate.setCompatVectorFromResourcesEnabled(true)    &#125;</code></p>
</li>
<li><p>3）、<strong>不兼容第三方库</strong>。</p>
</li>
<li><p>4）、<strong>性能问题：当Vector比较简单时，效率肯定比Bitmap高，复杂则效率会不如Bitmap</strong>。</p>
</li>
<li><p>5）、<strong>不便于管理：建议原则为同目录多类型文件，以前缀区别，不同目录相同类型文件，以意义区分</strong>。</p>
</li>
</ul>
<p>与 <strong>VD</strong> 类似，还有一种矢量图标 <strong>iconFont</strong>，即 <strong>字体图标，图标就在字体文件里面，它看着是个图标，其实却是个文字</strong>。它的 <strong>优势</strong> 有如下三个方面：</p>
<ul>
<li>1）、<strong>同 VD 一样，由于 IconFont 是矢量图标,所以可以轻松解决图标适配问题</strong>。</li>
<li>2）、<strong>图标以 .ttf 字体文件的形式存在项目中，而 .ttf 文件一般放在 assets 文件夹下,它的体积很小，可以减小 APK 的体积</strong>。</li>
<li>3）、<strong>一套图标资源可以在不同平台使用且资源维护方便</strong>。</li>
</ul>
<p>它的 <strong>缺点</strong> 也很明显，大致有如下三个方面：</p>
<ul>
<li>1）、<strong>需要自定义 svg 图片，并将其转换为 ttf 文件，图标制作成本比较高</strong>。</li>
<li>2）、<strong>添加图标时需要重新制作 ttf 文件</strong>。</li>
<li>3）、<strong>只能支持单色，不支持渐变色图标</strong>。</li>
</ul>
<p>如果你想要使用 <strong>iconfont</strong>，可以在阿里的 <a href="https://link.juejin.cn/?target=https://www.iconfont.cn/">iconfont</a> 上寻找资源。此外，<strong>使用 <a href="https://link.juejin.cn/?target=https://github.com/mikepenz/Android-Iconics">Android-Iconics</a> 可以在你的应用中便于使用任何的 iconfont 或 .svg 图片作为 drawable</strong>。最后，如果我们 <strong>仅仅想提取仅需要的美化文字，以压缩 assets 下的字体文件大小，可以使用 <a href="https://link.juejin.cn/?target=https://github.com/forJrking/FontZip">FontZip</a> 字体提取工具</strong>。</p>
<p>如果不是纯色小 <strong>icon</strong> 类型的图片，则建议使用 <strong>WebP</strong>。只要你的 <strong>App</strong> 的 <strong>minSdkVersion</strong> 高于 14（Android 4.0+） 即可。<strong>WebP</strong> 不仅支持透明度，而且压缩率比 <strong>JPEG</strong> 更高，在相同画质下体积更小。但是，<strong>只有 Android 4.2.1+ 才支持显示含透明度的 WebP</strong>，此外，它的 <strong>兼容性不好，并且不便于预览，需使用浏览器打开</strong>。</p>
<p>对于应用之前就存在的图片，我们可以使用 <a href="https://link.juejin.cn/?target=https://convertio.co/zh/png-webp/">PNG转换WebP</a> 的转换工具来进行转换。但是，一个一个转换开发效率太低，因此我们可以 <strong>使用<a href="https://link.juejin.cn/?target=https://github.com/meili/WebpConvert_Gradle_Plugin/blob/master/README.zh-cn.md">WebpConvert_Gradle_Plugin</a> 这个 gradle 插件去批量进行转换</strong>，它的实现原理是 <strong>在 mergeXXXResource Task 和 processXXXResource Task 之间插入了一个 WebpConvertPlugin task 去将 png、jpg 图片批量替换成了 webp 图片</strong>。</p>
<p>此外，在 <strong>Gradle</strong> 构建 <strong>APK</strong> 的过程中，我们可以判断当前 <strong>App</strong> 的 <strong>minSdkVersion</strong> 以及图片文件的类型来选用是否能使用 <strong>WebP</strong>，代码如下所示：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">boolean is<span class="constructor">PNGWebpConvertSupported()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!is<span class="constructor">WebpConvertEnable()</span>) &#123;</span><br><span class="line">        return <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Android 4.0+</span></span><br><span class="line">    return <span class="module-access"><span class="module"><span class="identifier">GradleUtils</span>.</span></span>get<span class="constructor">AndroidExtension(<span class="params">project</span>)</span>.defaultConfig.minSdkVersion.apiLevel &gt;= <span class="number">14</span></span><br><span class="line">    <span class="comment">// 4.0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">boolean is<span class="constructor">TransparencyPNGWebpConvertSupported()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!is<span class="constructor">WebpConvertEnable()</span>) &#123;</span><br><span class="line">        return <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Lossless, Transparency, Android 4.2.1+</span></span><br><span class="line">    return <span class="module-access"><span class="module"><span class="identifier">GradleUtils</span>.</span></span>get<span class="constructor">AndroidExtension(<span class="params">project</span>)</span>.defaultConfig.minSdkVersion.apiLevel &gt;= <span class="number">18</span></span><br><span class="line">    <span class="comment">// 4.3</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def convert<span class="literal">()</span> &#123;</span><br><span class="line">    String resPath = <span class="string">&quot;$&#123;project.buildDir&#125;/$&#123;AndroidProject.FD_INTERMEDIATES&#125;/res/merged/$&#123;variant.dirName&#125;&quot;</span></span><br><span class="line">    def resDir = <span class="keyword">new</span> <span class="constructor">File(<span class="string">&quot;$&#123;resPath&#125;&quot;</span>)</span></span><br><span class="line">    resDir.each<span class="constructor">DirMatch(~<span class="operator">/</span><span class="params">drawable</span>[<span class="params">a</span>-<span class="params">z0</span>-9-]<span class="operator">*</span><span class="operator">/</span>)</span> &#123; dir -&gt;</span><br><span class="line">        FileTree tree = project.file<span class="constructor">Tree(<span class="params">dir</span>: <span class="params">dir</span>)</span></span><br><span class="line">        tree.filter &#123; File file -&gt;</span><br><span class="line">            return (is<span class="constructor">JPGWebpConvertSupported()</span><span class="operator"> &amp;&amp; </span>(file.name.ends<span class="constructor">With(SdkConstants.DOT_JPG)</span><span class="operator"> || </span>file.name.ends<span class="constructor">With(SdkConstants.DOT_JPEG)</span>))<span class="operator"> || </span>(is<span class="constructor">PNGWebpConvertSupported()</span><span class="operator"> &amp;&amp; </span>file.name.ends<span class="constructor">With(SdkConstants.DOT_PNG)</span><span class="operator"> &amp;&amp; </span>!file.name.ends<span class="constructor">With(SdkConstants.DOT_9PNG)</span>)</span><br><span class="line">        &#125;.each &#123; File file -&gt;</span><br><span class="line">            def shouldConvert = <span class="literal">true</span></span><br><span class="line">            <span class="keyword">if</span> (file.name.ends<span class="constructor">With(SdkConstants.DOT_PNG)</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!is<span class="constructor">TransparencyPNGWebpConvertSupported()</span>) &#123;</span><br><span class="line">                    shouldConvert = !<span class="module-access"><span class="module"><span class="identifier">Imaging</span>.</span></span>get<span class="constructor">ImageInfo(<span class="params">file</span>)</span>.is<span class="constructor">Transparent()</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (shouldConvert) &#123;</span><br><span class="line">                <span class="module-access"><span class="module"><span class="identifier">WebpUtils</span>.</span></span>encode(project, webpFactorQuality, file.absolutePath, webp)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;   </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最后，这里再补充下在平时项目开发中对 <strong>图片放置优化的大概思路</strong>，如下所示：</p>
<ul>
<li>1）、<strong>聊天表情出一套图 &#x3D;&gt; hdpi</strong>。</li>
<li>2）、<strong>纯色小 icon 使用 VD &#x3D;&gt; raw</strong>。</li>
<li>3）、<strong>背景大图出一套 &#x3D;&gt; xhdpi</strong>。</li>
<li>4）、<strong>logo 等权重比较大的图片出两套 &#x3D;&gt; hdpi，xhdpi</strong>。</li>
<li>5）、<strong>若某些图在真机中有异常，则用多套图</strong>。</li>
<li>6）、<strong>若遇到奇葩机型，则针对性补图</strong>。</li>
</ul>
<p>然后，我们来讲解下资源如何进行混淆。</p>
<h2 id="5、资源混淆"><a href="#5、资源混淆" class="headerlink" title="5、资源混淆"></a>5、资源混淆</h2><p>同代码混淆类似，资源混淆将 <strong>资源路径混淆成单个资源的路径</strong>，这里我们可以使用 <strong>AndroidResGuard</strong>，它可以使冗余的资源路径变短，例如将 <strong>res&#x2F;drawable&#x2F;wechat</strong> 变为 <strong>r&#x2F;d&#x2F;a</strong>。</p>
<p><a href="https://link.juejin.cn/?target=https://github.com/shwenzhang/AndResGuard/blob/master/README.zh-cn.md">AndroidResGuard 项目地址</a></p>
<p>下面，我们就使用 <strong>AndroidResGuard</strong> 来对资源进行混淆。</p>
<h3 id="1、AndroidResGuard-实战"><a href="#1、AndroidResGuard-实战" class="headerlink" title="1、AndroidResGuard 实战"></a>1、AndroidResGuard 实战</h3><h4 id="1、首先，我们在项目的根-build-gradle-文件下加入下面的插件依赖："><a href="#1、首先，我们在项目的根-build-gradle-文件下加入下面的插件依赖：" class="headerlink" title="1、首先，我们在项目的根 build.gradle 文件下加入下面的插件依赖："></a>1、首先，我们在项目的根 build.gradle 文件下加入下面的插件依赖：</h4><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">classpath</span> &#x27;com.tencent.mm:AndResGuard-gradle-plugin:<span class="number">1</span>.<span class="number">2</span>.<span class="number">17</span>&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="2、然后，在项目-module-下的-build-gradle-文件下引入其插件："><a href="#2、然后，在项目-module-下的-build-gradle-文件下引入其插件：" class="headerlink" title="2、然后，在项目 module 下的 build.gradle 文件下引入其插件："></a>2、然后，在项目 module 下的 build.gradle 文件下引入其插件：</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apply</span> plugin: <span class="string">&#x27;AndResGuard&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="3、接着，加入-AndroidResGuard-的配置项，如下是默认设置好的配置："><a href="#3、接着，加入-AndroidResGuard-的配置项，如下是默认设置好的配置：" class="headerlink" title="3、接着，加入 AndroidResGuard 的配置项，如下是默认设置好的配置："></a>3、接着，加入 AndroidResGuard 的配置项，如下是默认设置好的配置：</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">andResGuard &#123;</span><br><span class="line">    <span class="regexp">//</span> mappingFile = file(<span class="string">&quot;./resource_mapping.txt&quot;</span>)</span><br><span class="line">    mappingFile = null</span><br><span class="line">    use7zip = true</span><br><span class="line">    useSign = true</span><br><span class="line">    <span class="regexp">//</span> 打开这个开关，会keep住所有资源的原始路径，只混淆资源的名字</span><br><span class="line">    keepRoot = false</span><br><span class="line">    <span class="regexp">//</span> 设置这个值，会把arsc name列混淆成相同的名字，减少string常量池的大小</span><br><span class="line">    fixedResName = <span class="string">&quot;arg&quot;</span></span><br><span class="line">    <span class="regexp">//</span> 打开这个开关会合并所有哈希值相同的资源，但请不要过度依赖这个功能去除去冗余资源</span><br><span class="line">    mergeDuplicatedRes = true</span><br><span class="line">    whiteList = [</span><br><span class="line">        <span class="regexp">//</span> <span class="keyword">for</span> your icon</span><br><span class="line">        <span class="string">&quot;R.drawable.icon&quot;</span>,</span><br><span class="line">        <span class="regexp">//</span> <span class="keyword">for</span> fabric</span><br><span class="line">        <span class="string">&quot;R.string.com.crashlytics.*&quot;</span>,</span><br><span class="line">        <span class="regexp">//</span> <span class="keyword">for</span> google-services</span><br><span class="line">        <span class="string">&quot;R.string.google_app_id&quot;</span>,</span><br><span class="line">        <span class="string">&quot;R.string.gcm_defaultSenderId&quot;</span>,</span><br><span class="line">        <span class="string">&quot;R.string.default_web_client_id&quot;</span>,</span><br><span class="line">        <span class="string">&quot;R.string.ga_trackingId&quot;</span>,</span><br><span class="line">        <span class="string">&quot;R.string.firebase_database_url&quot;</span>,</span><br><span class="line">        <span class="string">&quot;R.string.google_api_key&quot;</span>,</span><br><span class="line">        <span class="string">&quot;R.string.google_crash_reporting_api_key&quot;</span></span><br><span class="line">    ]</span><br><span class="line">    compressFilePattern = [</span><br><span class="line">        <span class="string">&quot;*.png&quot;</span>,</span><br><span class="line">        <span class="string">&quot;*.jpg&quot;</span>,</span><br><span class="line">        <span class="string">&quot;*.jpeg&quot;</span>,</span><br><span class="line">        <span class="string">&quot;*.gif&quot;</span>,</span><br><span class="line">    ]</span><br><span class="line">    sevenzip &#123;</span><br><span class="line">        artifact = <span class="string">&#x27;com.tencent.mm:SevenZip:1.2.17&#x27;</span></span><br><span class="line">        <span class="regexp">//</span>path = <span class="string">&quot;/usr/local/bin/7za&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">    * 可选： 如果不设置则会默认覆盖assemble输出的apk</span><br><span class="line">    **/</span><br><span class="line">    <span class="regexp">//</span> finalApkBackupPath = <span class="string">&quot;$&#123;project.rootDir&#125;/final.apk&quot;</span></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">    * 可选: 指定v1签名时生成jar文件的摘要算法</span><br><span class="line">    * 默认值为“SHA-<span class="number">1</span>”</span><br><span class="line">    **/</span><br><span class="line">    <span class="regexp">//</span> digestalg = <span class="string">&quot;SHA-256&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="4、最后，我们点击右边的项目-module-x2F-Tasks-x2F-andresguard-x2F-resguardRelease-即可生成资源混淆过的-APK。如下图所示："><a href="#4、最后，我们点击右边的项目-module-x2F-Tasks-x2F-andresguard-x2F-resguardRelease-即可生成资源混淆过的-APK。如下图所示：" class="headerlink" title="4、最后，我们点击右边的项目 module&#x2F;Tasks&#x2F;andresguard&#x2F;resguardRelease 即可生成资源混淆过的 APK。如下图所示："></a>4、最后，我们点击右边的项目 module&#x2F;Tasks&#x2F;andresguard&#x2F;resguardRelease 即可生成资源混淆过的 APK。如下图所示：</h4><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e55be4c952e04451b22d64b0c84825ec~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p><strong>APK</strong> 生成目录如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d65fc96523f04290a57774fbfa0e349a~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p>对于 AndResGuard 工具，主要有 <strong>两个功能</strong>，一个是 <strong>资源混淆</strong>，一个是 <strong>资源的极限压缩</strong>。下面，我们就来分别了解下它们的实现原理。</p>
<h3 id="2、AndResGuard-的资源混淆原理"><a href="#2、AndResGuard-的资源混淆原理" class="headerlink" title="2、AndResGuard 的资源混淆原理"></a>2、AndResGuard 的资源混淆原理</h3><p>资源混淆工具主要是通过 <strong>短路径的优化</strong>，以达到 <strong>减少  resources.arsc、metadata 签名文件以及 ZIP 文件大小</strong> 的效果，其效果分别如下所示：</p>
<ul>
<li>1）、<strong>resources.arsc：它记录了资源文件的名称与路径，使用混淆后的短路径  res&#x2F;s&#x2F;a，可以减少文件的大小</strong>。</li>
<li>2）、<strong>metadata 签名文件：签名文件 MANIFEST.MF 与 CERT.SF 需要记录所有文件的路径以及它们的哈希值，使用短路径可以减少这两个文件的大小</strong>。</li>
<li>3）、<strong>ZIP 文件：ZIP 文件格式里面通过其索引记录了每个文件 Entry 的路径、压缩算法、CRC、文件大小等等信息。短路径的优化减少了记录文件路径的字符串大小</strong>。</li>
</ul>
<h3 id="3、AndResGuard-的极限压缩原理"><a href="#3、AndResGuard-的极限压缩原理" class="headerlink" title="3、AndResGuard 的极限压缩原理"></a>3、AndResGuard 的极限压缩原理</h3><p><strong>AndResGuard</strong> 使用了 <strong>7-Zip 的大字典优化</strong>，<strong>APK</strong> 的 <strong>整体压缩率可以提升 3% 左右</strong>，并且，它还支持针对 resources.arsc、PNG、JPG 以及 GIF 等文件进行强制压缩（在编译过程中，这些文件默认不会被压缩）。那么，<strong>为什么 Android 系统不会去压缩这些文件呢</strong>？主要基于以下 <strong>两点原因</strong>：</p>
<ul>
<li>1）、<strong>压缩效果不明显</strong>：上述格式的文件大部分已经被压缩过，因此，重新做 <strong>Zip</strong> 压缩效果并不明显。比如 重新压缩 <strong>PNG</strong> 和 <strong>JPG</strong> 格式只能减少 <strong>3%～5%</strong> 的大小。</li>
<li>2）、<strong>基于读取时间和内存的考虑</strong>：针对于 <strong>没有进行压缩的文件，系统可以使用 mmap 的方式直接读取</strong>，而不需要一次性解压并放在内存中。</li>
</ul>
<p>此外，抖音 Android 团队还开源了针对于海外市场 App Bundle APK 的 <a href="https://link.juejin.cn/?target=https://github.com/bytedance/AabResGuard/blob/develop/wiki/zh-cn/README.md">AabResGuard 资源混淆工具</a>，对它的实现原理有兴趣的同学可以去了解下。然后，我们再看看资源瘦身的其它方案。</p>
<h2 id="6、R-Field-的内联优化"><a href="#6、R-Field-的内联优化" class="headerlink" title="6、R Field 的内联优化"></a>6、R Field 的内联优化</h2><p>我们可以通过内联 <strong>R Field</strong> 来进一步对代码进行瘦身，此外，它也<strong>解决了 R Field 过多导致 MultiDex 65536 的问题</strong>。要想实现内联 <strong>R Field</strong>，我们需要 <strong>通过 Javassist 或者 ASM 字节码工具在构建流程中内联 R Field</strong>，其代码如下所示：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">ctBehaviors.each &#123; CtBehavior ctBehavior -&gt;</span><br><span class="line">    <span class="keyword">if</span> (!ctBehavior.is<span class="constructor">Empty()</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ctBehavior.instrument(<span class="keyword">new</span> <span class="constructor">ExprEditor()</span> &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void edit(FieldAccess f) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        def fieldClassName =  <span class="module-access"><span class="module"><span class="identifier">JavassistUtils</span>.</span></span>get<span class="constructor">ClassNameFromCtClass(<span class="params">f</span>.<span class="params">getCtClass</span>()</span>)</span><br><span class="line">                        <span class="keyword">if</span> (should<span class="constructor">InlineRField(<span class="params">className</span>, <span class="params">fieldClassName</span>)</span><span class="operator"> &amp;&amp; </span>f.is<span class="constructor">Reader()</span>) &#123;</span><br><span class="line">                            def temp = fieldClassName.substring(fieldClassName.index<span class="constructor">Of(ANDROID_RESOURCE_R_FLAG)</span> + <span class="module-access"><span class="module"><span class="identifier">ANDROID_RESOURCE_R_FLAG</span>.</span></span>length<span class="literal">()</span>)</span><br><span class="line">                            def fieldName = f.fieldName</span><br><span class="line">                            def key = <span class="string">&quot;$&#123;temp&#125;.$&#123;fieldName&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (resourceSymbols.contains<span class="constructor">Key(<span class="params">key</span>)</span>) &#123;</span><br><span class="line">                                Object obj = resourceSymbols.get(key)</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (obj instanceof Integer) &#123;</span><br><span class="line">                                        <span class="built_in">int</span> value = ((Integer) obj).<span class="built_in">int</span><span class="constructor">Value()</span></span><br><span class="line">                                        f.replace(<span class="string">&quot;\$_=$&#123;value&#125;;&quot;</span>)</span><br><span class="line">                                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj instanceof Integer<span class="literal">[]</span>) &#123;</span><br><span class="line">                                        def obj2 = ((Integer<span class="literal">[]</span>) obj)</span><br><span class="line">                                        StringBuilder stringBuilder = <span class="keyword">new</span> <span class="constructor">StringBuilder()</span></span><br><span class="line">                                        <span class="keyword">for</span> (<span class="built_in">int</span> index = <span class="number">0</span>; index &lt; obj2.length; ++index) &#123;</span><br><span class="line">                                            stringBuilder.append(obj2<span class="literal">[<span class="identifier">index</span>]</span>.<span class="built_in">int</span><span class="constructor">Value()</span>)</span><br><span class="line">                                            <span class="keyword">if</span> (index != obj2.length - <span class="number">1</span>) &#123;</span><br><span class="line">                                                stringBuilder.append(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">                                            &#125;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                        f.replace(<span class="string">&quot;\$_ = new int[]&#123;$&#123;stringBuilder.toString()&#125;&#125;;&quot;</span>)</span><br><span class="line">                                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                        throw <span class="keyword">new</span> <span class="constructor">GradleException(<span class="string">&quot;Unknown ResourceSymbols Type!&quot;</span>)</span></span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125; catch (NotFoundException e) &#123;</span><br><span class="line">                                    throw <span class="keyword">new</span> <span class="constructor">GradleException(<span class="params">e</span>.<span class="params">message</span>)</span></span><br><span class="line">                                &#125; catch (CannotCompileException e) &#123;</span><br><span class="line">                                    throw <span class="keyword">new</span> <span class="constructor">GradleException(<span class="params">e</span>.<span class="params">message</span>)</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                throw <span class="keyword">new</span> <span class="constructor">GradleException(<span class="string">&quot;******** InlineRFieldTask unprocessed $&#123;className&#125;, $&#123;fieldClassName&#125;, $&#123;f.fieldName&#125;, $&#123;key&#125;&quot;</span>)</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; catch (NotFoundException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; catch (CannotCompileException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里，我们可以 <strong>直接使用蘑菇街的 <a href="https://link.juejin.cn/?target=https://github.com/meili/ThinRPlugin/blob/master/README.zh-cn.md">ThinRPlugin</a><strong>。它的实现原理为：</strong>android 中的 R 文件，除了 styleable 类型外，所有字段都是 int 型变量&#x2F;常量，且在运行期间都不会改变。所以可以在编译时，记录 R 中所有字段名称及对应值，然后利用 ASM 工具遍历所有 Class，将除 R$styleable.class 以外的所有 R.class 删除掉，并且在引用的地方替换成对应的常量</strong>，从而达到缩减包大小和减少 <strong>Dex</strong> 个数的效果。此外，最近 <strong>ByteX</strong> 也增加了 <a href="https://link.juejin.cn/?target=https://github.com/bytedance/ByteX/blob/master/shrink-r-plugin/README-zh.md">shrink_r_class</a> 的 <strong>gradle</strong> 插件，它不仅可以在编译阶段对 <strong>R</strong> 文件常量进行内联，而且还可以 <strong>针对 App 中无用 Resource 和无用 assets 的资源进行检查</strong>。</p>
<h2 id="7、资源合并方案"><a href="#7、资源合并方案" class="headerlink" title="7、资源合并方案"></a>7、资源合并方案</h2><p>我们可以把所有的资源文件合并成一个大文件，而 <strong>一个大资源文件就相当于换肤方案中的一套皮肤</strong>。它的效果 <strong>比资源混淆的效果会更好</strong>，但是，在此之前，必须要解决 <strong>解析资源</strong> 与 <strong>管理资源</strong> 的问题。其相应的解决方案如下所示：</p>
<ul>
<li><strong>模拟系统实现资源文件的解析：我们需要使用自定义的方式把 PNG、JPG 以及 XML 文件转换为 Bitmap 或者 Drawable</strong>。</li>
<li><strong>使用 mmap 加载大资源与资源缓存池管理资源：使用 mmap 加载大资源的方式可以充分减少启动时间与系统内存的占用。而且，需要使用 Glide 等图片框架的资源缓存池 ResourceCache 去释放不再使用的资源文件</strong>。</li>
</ul>
<h2 id="8、资源文件最少化配置"><a href="#8、资源文件最少化配置" class="headerlink" title="8、资源文件最少化配置"></a>8、资源文件最少化配置</h2><p>我们需要 <strong>根据 App 目前所支持的语言版本去选用合适的语言资源</strong>，例如使用了 <strong>AppCompat</strong>，如果不做任何配置的话，最终 <strong>APK</strong> 包中会包含 <strong>AppCompat</strong> 中所有已翻译语言字符串，无论应用的其余部分是否翻译为同一语言。对此，我们可以 <strong>通过 resConfig 来配置使用哪些语言，从而让构建工具移除指定语言之外的所有资源</strong>。同理，也可以<strong>使用 resConfigs 去配置你应用需要的图片资源文件类，如 “xhdpi”、”xxhdpi” 等等</strong>，代码如下所示：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">	    <span class="string">...</span></span><br><span class="line">        resConfigs <span class="string">&quot;zh&quot;</span>, <span class="string">&quot;zh-rCN&quot;</span></span><br><span class="line">        resConfigs <span class="string">&quot;nodpi&quot;</span>, <span class="string">&quot;hdpi&quot;</span>, <span class="string">&quot;xhdpi&quot;</span>, <span class="string">&quot;xxhdpi&quot;</span>, <span class="string">&quot;xxxhdpi&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">...</span></span><br><span class="line">&#125;    </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此外，我们还以 <strong>利用 Density Splits 来选择应用应兼容的屏幕尺寸大小</strong>，代码如下所示：</p>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">android</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    splits &#123;</span><br><span class="line">        density &#123;</span><br><span class="line">            <span class="literal">enable</span> <span class="keyword">true</span></span><br><span class="line">            <span class="literal">exclude</span> <span class="string">&quot;ldpi&quot;</span>, <span class="string">&quot;tvdpi&quot;</span>, <span class="string">&quot;xxxhdpi&quot;</span></span><br><span class="line">            compatibleScreens <span class="string">&#x27;small&#x27;</span>, <span class="string">&#x27;normal&#x27;</span>, <span class="string">&#x27;large&#x27;</span>, <span class="string">&#x27;xlarge&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="9、尽量每张图片只保留一份"><a href="#9、尽量每张图片只保留一份" class="headerlink" title="9、尽量每张图片只保留一份"></a>9、尽量每张图片只保留一份</h2><p>比如说，我们统一只把图片放到 <strong>xhdpi</strong> 这个目录下，那么 <strong>在不同的分辨率下它会做自动的适配</strong>，即 <strong>等比例地拉伸或者是缩小</strong>。</p>
<h2 id="10、资源在线化"><a href="#10、资源在线化" class="headerlink" title="10、资源在线化"></a>10、资源在线化</h2><p>我们可以 <strong>将一些图片资源放在服务器</strong>，然后 <strong>结合图片预加载</strong> 的技术手段，这些 <strong>既可以满足产品的需要，同时可以减小包大小</strong>。</p>
<h2 id="11、统一应用风格"><a href="#11、统一应用风格" class="headerlink" title="11、统一应用风格"></a>11、统一应用风格</h2><p>如设定统一的 <strong>字体、尺寸、颜色和按钮按压效果、分割线 shape、selector 背景</strong> 等等。</p>
<h1 id="四、So-瘦身方案探索"><a href="#四、So-瘦身方案探索" class="headerlink" title="四、So 瘦身方案探索"></a>四、So 瘦身方案探索</h1><p>对于主要由 <strong>C&#x2F;C++</strong> 实现的 <strong>Native Library</strong> 而言，常规的优化方式就是 <strong>去除 Debug 信息，使用 C++_shared 等等</strong>。下面，对于 <strong>So</strong> 瘦身，我们看看还有哪些方案。</p>
<h2 id="1、So-移除方案"><a href="#1、So-移除方案" class="headerlink" title="1、So 移除方案"></a>1、So 移除方案</h2><p><strong>So</strong> 是 <strong>Android</strong> 上的动态链接库，在我们 <strong>Android</strong> 应用开发过程中，有时候 <strong>Java</strong> 代码不能满足需求，比如一些 <strong>加解密算法或者音视频编解码功能</strong>，这个时候就必须要通过 <strong>C</strong> 或者是 <strong>C++</strong> 来实现，之后生成 <strong>So</strong> 文件提供给 <strong>Java</strong> 层来调用，在生成 <strong>So</strong> 文件的时候就需要考虑生成市面上不同手机 <strong>CPU</strong> 架构的文件。目前，<strong>Android</strong> 一共 <strong>支持7种不同类型的 CPU 架构</strong>，比如常见的 <strong>armeabi、armeabi-v7a、X86</strong> 等等。理论上来说，<strong>对应架构的 CPU 它的执行效率是最高的</strong>，但是这样会导致 <strong>在 lib 目录下会多存放了各个平台架构的 So 文件</strong>，所以 <strong>App</strong> 的体积自然也就更大了。</p>
<p>因此，我们就需要对 <strong>lib</strong> 目录进行缩减，我们 <strong>在 build.gradle 中配置这个 abiFiliters 去设置 App 支持的 So 架构</strong>，其配置代码如下所示：</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">defaultConfig</span> &#123;</span><br><span class="line">    <span class="keyword">ndk</span> &#123;</span><br><span class="line">        abiFilters <span class="string">&quot;armeabi&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>一般情况下，应用都不需要用到 neon 指令集，我们只需留下 armeabi 目录就可以了</strong>。因为 <strong>armeabi 目录下的 So 可以兼容别的平台上的 So</strong>，相当于是一个万金油，都可以使用。但是，这样 <strong>别的平台使用时性能上就会有所损耗，失去了对特定平台的优化</strong>。</p>
<h2 id="2、So-移除方案优化版"><a href="#2、So-移除方案优化版" class="headerlink" title="2、So 移除方案优化版"></a>2、So 移除方案优化版</h2><p>上面我们说到了想要完美支持所有类型的设备代价太大，那么，我们能不能采取一个 <strong>折中的方案</strong>，就是 <strong>对于性能敏感的模块，它使用到的 So，我们都放在 armeabi 目录当中随着 Apk 发出去，然后我们在代码中来判断一下当前设备所属的 CPU 类型，根据不同设备 CPU 类型来加载对应架构的 So 文件</strong>。这里我们举一个小栗子，比如说我们 <strong>armeabi</strong> 目录下也加上了 <strong>armeabi-v7</strong> 对应的 <strong>So</strong>，然后我们就可以在代码当中做判断，如果你是 <strong>armeabi-v7</strong> 架构的手机，那我们就直接加载这个 <strong>So</strong>，以此达到最佳的性能，这样包体积其实也没有增加多少，同时也实现了高性能的目的，比如 <strong>微信和腾讯视频 App</strong> 里面就使用了这种方式，如下图所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/95614c97a6d141509abd4b9ac5de3f06~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p>看到上图中的 <strong>libimagepipeline_x86.so</strong>，下面我们就以这个 so 为例来写写加载它的伪代码，如下所示：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">String abi = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="regexp">//</span> 获取当前手机的CPU架构类型</span><br><span class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.LOLLIPOP) &#123;</span><br><span class="line">    abi = Buildl.CPU_ABI;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    abi = Build.SUPPORTED_ABIS[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (TextUtils.equals(abi, <span class="string">&quot;x86&quot;</span>)) &#123;</span><br><span class="line">    <span class="regexp">//</span> 加载特定平台的So</span><br><span class="line">    </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="regexp">//</span> 正常加载</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接下来，我们再了解下 <strong>So</strong> 优化当中别的优化方式。</p>
<h2 id="3、使用-XZ-Utils-对-Native-Library-进行压缩"><a href="#3、使用-XZ-Utils-对-Native-Library-进行压缩" class="headerlink" title="3、使用 XZ Utils 对 Native Library 进行压缩"></a>3、使用 XZ Utils 对 Native Library 进行压缩</h2><p><strong>Native Library</strong> 同 <strong>Dex</strong> 一样,也可以使用 <strong>XZ Utils</strong> 进行压缩，对于 <strong>Native Library</strong> 的压缩，我们 <strong>只需要去加载启动过程相关的 Library，而其它的都可以在应用首次启动时进行解压</strong>，并且，<strong>压缩效果与 Dex 压缩的效果是相似的</strong>。</p>
<p>此外，关于 **Nativie Library 压缩之后的解压，我们也可以使用 Facebook 的 so 加载库 <a href="https://link.juejin.cn/?target=https://github.com/facebook/SoLoader">SoLoader</a>**，它 <strong>能够解压应用的 Native Library 并能递归地加载在 Android 平台上不支持的依赖项</strong>。由于这套方案对启动时间的影响比较大，所以先把它压箱底下吧。</p>
<h2 id="4、对-Native-Library-进行合并"><a href="#4、对-Native-Library-进行合并" class="headerlink" title="4、对 Native Library 进行合并"></a>4、对 Native Library 进行合并</h2><p><strong>在 Android 4.3（API 17) 之前，单个进程加载的 SO 数量是有限制的，在 Google 的 linker.cpp 源码中有很明显的定义</strong>，如下图所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/68836a9c1cdd45e9afa2e387c9c654ff~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p>为了解决这个问题，<strong>FaceBook</strong> 写了一个 <a href="https://link.juejin.cn/?target=https://github.com/fbsamples/android-native-library-merging-demo">合并Native Library的demo</a>，我们可以 <strong>按照自身 App 的 so 情况来配置需要合并哪些对象。由于合并共享对象（即 .so 文件）在原先的构建流程中是无法实现的，因此 FaceBook 更改了链接库的方式，并把它集成到了构建系统 <a href="https://link.juejin.cn/?target=https://github.com/facebook/buck">Buck</a> 中。该功能允许每个应用程序指定应合并的 .so 库，从而避免意外引入不必要的依赖关系。然后，Buck 负责为每个合并的 .so 库收集所有对象（文件），并将它们与适当的依赖项链接在一起。</strong></p>
<h2 id="5、删除-Native-Library-中无用的导出-symbol"><a href="#5、删除-Native-Library-中无用的导出-symbol" class="headerlink" title="5、删除 Native Library 中无用的导出 symbol"></a>5、删除 Native Library 中无用的导出 symbol</h2><p>我们可以去 <strong>分析代码中的 JNI 方法以及不同 Library 库的方法调用，然后找出无用的 symbol 并删除，这样 Linker 在编译的时候也会把 symbol 对应的无用代码给删除</strong>。在 <strong>Buck 有 <a href="https://link.juejin.cn/?target=https://github.com/facebook/buck/blob/master/src/com/facebook/buck/android/relinker/NativeRelinker.java">NativeRelinker</a></strong> 这个类，它就实现了这个功能，其 <strong>类似于 Native Library 的 ProGuard Shrinking 功能</strong>。</p>
<p>至此，可以看到，<strong>FaceBook 出品的 Buck 同 ReDex 一样，里面的功能都十分强大，Buck 除了实现 Library Merge 和 Relinker 功能之外，还实现了三大功能</strong>，如下所示：</p>
<ul>
<li>1）、多语言拆分</li>
<li>2）、分包支持</li>
<li>3）、ReDex 支持</li>
</ul>
<p>如果有相应需求或对 Buck 感兴趣的同学可以去看看它们的实现源码。</p>
<h2 id="6、So-动态下载"><a href="#6、So-动态下载" class="headerlink" title="6、So 动态下载"></a>6、So 动态下载</h2><p>我们可以 <strong>将部分 So 文件使用动态下发的形式进行加载</strong>。也就是在业务代码操作之前，我们可以先从服务器下载下来 So，接下来再使用，这样包体积肯定会减少不小。但是，如果要把这项技术 <strong>稳定落地到实际生产项目中需要解决一些问题</strong>，具体的 so  动态化关键技术点和需要避免的坑可以参见 <a href="https://link.juejin.cn/?target=https://mp.weixin.qq.com/s/X58fK02imnNkvUMFt23OAg">动态下发 so 库在 Android APK 安装包瘦身方面的应用 </a>，这里就不多赘述了。</p>
<h1 id="五、其它优化方案"><a href="#五、其它优化方案" class="headerlink" title="五、其它优化方案"></a>五、其它优化方案</h1><h2 id="1、插件化"><a href="#1、插件化" class="headerlink" title="1、插件化"></a>1、插件化</h2><p>我们可以使用插件化的手段 <strong>对代码结构进行调整</strong>，如果我们 <strong>App</strong> 当中的每一个功能都是一个插件，并且都是可以从服务器下发下来的，那 <strong>App</strong> 的包体积肯定会小很多。插件化相关的知识非常多而且不属于我们的重点，并且，插件化严格来说属于 <strong>基础架构研发</strong> 这块的知识，掌握它是<strong>成为 Android 架构师的必经之路</strong>，关于 <strong>Android 架构师的学习路线</strong> 可以参考 <a href="https://link.juejin.cn/?target=https://github.com/JsonChao/Awesome-Android-Architecture">Awesome-Android-Architecture</a>，预计今年会完成部分学习内容，敬请期待。</p>
<h2 id="2、业务梳理"><a href="#2、业务梳理" class="headerlink" title="2、业务梳理"></a>2、业务梳理</h2><p>我们需要 <strong>回顾过去的业务</strong>，合理地去 <strong>评估并删除无用或者低价值的业务</strong>。</p>
<h2 id="3、转变开发模式"><a href="#3、转变开发模式" class="headerlink" title="3、转变开发模式"></a>3、转变开发模式</h2><p>如果所有的功能都不能移除，那就可能需要去转变开发模式，比如可以更多地 <strong>采用 H5、小程序</strong> 这样开发模式。</p>
<h1 id="六、包体积监控"><a href="#六、包体积监控" class="headerlink" title="六、包体积监控"></a>六、包体积监控</h1><p>对于应用包体积的监控，也应该和内存监控一样，去作为正式版本的发布流程中的一环，并且应该 <strong>尽量地去实现自动化与平台化</strong>。（这里建议 <strong>任何大于 100kb 的功能都需要审批</strong>，特别是需要引入第三方库时，更应该慎重）</p>
<h2 id="1、包体积监控的纬度"><a href="#1、包体积监控的纬度" class="headerlink" title="1、包体积监控的纬度"></a>1、包体积监控的纬度</h2><p>包体积的监控，主要可以从如下 <strong>三个纬度</strong> 来进行：</p>
<ul>
<li>1）、<strong>大小监控：通常是记录当前版本与上一个或几个版本直接的变化情况，如果当前版本体积增长较大，则需要分析具体原因，看是否有优化空间</strong>。</li>
<li>2）、<strong>依赖监控：包括J ar、aar 依赖</strong>。</li>
<li>3）、<strong>规则监控：我们可以把包体积的监控抽象为无用资源、大文件、重复文件、R  文件等这些规则</strong>。</li>
</ul>
<p>包体积的 <strong>大小监控</strong> 和 <strong>依赖监控</strong> 都很容易实现，而要实现 <strong>规则监控</strong> 却得花不少功夫，幸运的是 <strong>Matrix</strong> 中的   <a href="https://link.juejin.cn/?target=https://github.com/Tencent/matrix/wiki/Matrix-Android-ApkChecker">ApkChecker</a>  就实现了包体积的规则监控，其 <strong>使用文档与实现原理</strong> 微信团队已经写得很清楚了，这里就不再一一赘述，有兴趣的同学可以去研究下。</p>
<h1 id="七、瘦身优化常见问题"><a href="#七、瘦身优化常见问题" class="headerlink" title="七、瘦身优化常见问题"></a>七、瘦身优化常见问题</h1><p>瘦身优化是性能优化当中不那么重要的一个分支，不过对于处于稳定运营期的产品会比较有帮助。下面我们就来看看对于瘦身优化有哪些常见问题。</p>
<h2 id="1、怎么降低-Apk-包大小？"><a href="#1、怎么降低-Apk-包大小？" class="headerlink" title="1、怎么降低 Apk 包大小？"></a>1、怎么降低 Apk 包大小？</h2><p>我们在回答的时候要注意一些 <strong>可操作的干货</strong>，同时注意结合你的 <strong>项目周期</strong>。主要可以从以下 <strong>三点</strong> 来回答：</p>
<ul>
<li>1）、<strong>代码：Proguard、统一三方库、无用代码删除</strong>。</li>
<li>2）、<strong>资源：无用资源删除、资源混淆</strong>。</li>
<li>3）、<strong>So：只保留 Armeabi、更优方案</strong>。</li>
</ul>
<p>在项目初期，我们一直在不断地加功能，加入了很多的代码、资源，同时呢，也没有相应的规范，所以说，<strong>UI</strong> 同学给我们很多 <strong>UI</strong> 图的时候，都是没有经过压缩的图片，长期累积就会导致我们的包体积越来越大。到了项目稳定期的时候，我们对各种运营数据进行考核，发现 <strong>APK</strong> 的包大小影响了用户下载的意愿，于是我们就着手做包体积的优化，我们采用的是 <strong>Android Studio 自带的 Analyze APK 来做的包体积分析</strong>，主要就是做了代码、资源、So 等三个方面的重点优化。</p>
<p>首先，针对于代码瘦身，第一点，我们首先 <strong>使用 Proguard 工具进行了混淆</strong>，它将程序代码转换为功能相同，但是不容易理解的形式。比如说将一个很长的类转换为字母 a，同时，这样做还有一个好处，就是让代码更加安全了。第二点呢，我们将项目中使用到的一些 <strong>第三方库进行了统一</strong>，比如说图片库、网络库、数据库等，不允许项目中出现功能相同，但是却实现不一样的库。同时也做了 <strong>规范，之后引入的三方库，需要去考量它的大小、方法数等，而且呢，如果只是需要一个很大库的一个小功能，那我们就修改源码，只引入部分代码即可</strong>。第三点，我们将项目中的 <strong>无用代码进行了删减</strong>，我们<strong>使用了 AOP 的方式统计到了哪些 Activity 以及 fragment 在真实的场景下没有用户使用</strong>，这样你就可以删除掉了。<strong>对于那些不是 Activity 或者是 Fragment 的类，我们切了很多类的构造函数</strong>，这样你就可以统计出来这些类在线上有没有真正被调用到。但是，<strong>对于代码的瘦身效果，实际上不是很明显</strong>。</p>
<p>接下来，我们做了资源的瘦身。首先，我们 <strong>移除了项目当中冗余的资源文件</strong>，这一点在项目当中一定会遇到。然后，我们做了 <strong>资源图片的压缩，UI 同学给我们资源图片的时候，需要确认已经是压缩过的图片</strong>，同时，我们还会做一个 <strong>兜底策略，在打包的时候，如果图片没有被压缩过，那我们就会再来压缩一遍</strong>，这个效果就非常的明显。对于资源，我们还做了 <strong>资源的混淆</strong>，也就是将冗余的资源名称换成简短的名字，<strong>资源压缩的效果要比代码瘦身的效果要好的多</strong>。</p>
<p>最后，我们做了 <strong>So</strong> 的瘦身。首先，我们<strong>只保留了 armeabi 这个目录</strong>，它可以 <strong>兼容别的 CPU 架构，这点的优化效果非常的明显</strong>。移除了对别的架构适配 So 之后，我们还做了另外一个处理，<strong>对于项目当中使用到的视频模块的 So，它对性能要求非常高，所以我们采用了另外一种方式，我们将所有这个模块下的 So 都放到了 armeabi 这个目录下，然后在代码中做判断，如果是别的 CPU 架构，那我们就加载对应 CPU 架构的 So 文件即可</strong>。这样即减少了包体积，同时又达到了性能最佳。最后，通过实践可以看出 S<strong>o瘦身的效果一般是最好的</strong>。</p>
<h2 id="2、Apk-瘦身如何实现长效治理？"><a href="#2、Apk-瘦身如何实现长效治理？" class="headerlink" title="2、Apk 瘦身如何实现长效治理？"></a>2、Apk 瘦身如何实现长效治理？</h2><p>主要可以从以下 <strong>两个方面</strong> 来进行回答：</p>
<ul>
<li>1）、<strong>发版之前与上个版本包体积对比，超过阈值则必须优化</strong>。</li>
<li>2）、<strong>推进插件化架构改进</strong>。</li>
</ul>
<p>在大型项目中，最好的方式就是 <strong>结合 CI</strong>，每个开发同学 <strong>在往主干合入代码的时候需要经过一次预编译，这个预编译出来的包对比主干打出来的包大小，如果超过阈值则不允许合入，需要提交代码的同学自己去优化去提交的代码</strong>。此外，针对项目的 <strong>架构</strong>，我们可以做 <strong>插件化的改造，将每一个功能模块都改造成插件，以插件的形式来支持动态下发，这样应用的包体积就可以从根本上变小了</strong>。</p>
<h1 id="八、总结"><a href="#八、总结" class="headerlink" title="八、总结"></a>八、总结</h1><p>在本篇文章中，我们主要从以下 <strong>七个方面</strong> 讲解了 <strong>Android</strong> 包体积优化相关的知识：</p>
<ul>
<li>1）、<strong>瘦身优化及 Apk 分析方案：瘦身优势、APK 组成、APK 分析</strong>。</li>
<li>2）、<strong>代码瘦身方案探索：Dex 探秘、ProGuard、D8 与 R8 优化、去除 debug 信息与行号信息、Dex 分包优化、使用 XZ Utils 进行 Dex 压缩、三方库处理、移除无用代码、避免产生 Java access 方法、利用 ByteX Gradle  插件平台中的代码优化插件</strong>。</li>
<li>3）、<strong>资源瘦身方案探索：冗余资源优化、重复资源优化、图片压缩、使用针对性的图片格式、资源混淆、R Field 的内联优化、资源合并方案、资源文件最少化配置、尽量每张图片只保留一份、资源在线化、统一应用风格</strong>。</li>
<li>4）、<strong>So 瘦身方案探索：So 移除方案、So 移除方案优化版、使用 XZ Utils 对 Native Library 进行压缩、对 Native Library 进行合并、删除 Native Library 中无用的导出 symbol、So 动态下载</strong>。</li>
<li>5）、<strong>其它优化方案：插件化、业务梳理、转变开发模式</strong>。</li>
<li>6）、<strong>包体积监控</strong>。</li>
<li>7）、<strong>瘦身优化常见问题</strong>。</li>
</ul>
<p>如果要想对包体积做更深入的优化，我们就必须对 <strong>APK 组成，Dex、So 动态库以及 Resource 文件格式，还有 APK 的编译流程</strong> 有深入地了解，这样我们才能有 <strong>足够的内功素养</strong> 去实现包体积的深度优化。此外，在做性能优化过程中，为了提升研发效率，降低研发成本，我渐渐发现 <strong>AOP 编译插桩、Gradle 自动化构建</strong> 的知识越来越重要；并且，一旦涉及 <strong>Native</strong> 层甚至 <strong>Android</strong> 内核层的深度优化时，就越发感觉到功力不足。因此，为了 <strong>补充深度优化所需的养分</strong>，从下篇开始，笔者将暂停更新 <strong>深入探索 Android 性能优化系列文章</strong>。下篇文章，笔者的分享将会从先从 <strong>编译插桩</strong> 相关的知识开始，敬请期待~</p>
<!-- flag of hidden posts -->
      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>请我喝杯奶茶吧~</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt=" WeChat Pay"/>
        <p>WeChat Pay</p>
      </div>
    

    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/private/" rel="tag"># private</a>
          
            <a href="/tags/%E5%AE%89%E5%8D%93%E4%BC%98%E5%8C%96/" rel="tag"># 安卓优化</a>
          
        </div>
      

      
      
      

      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7Carchive">
              
                  <span class="site-state-item-count">149</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">30</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="mailto:shenbh@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://blog.csdn.net/ptwenzi?spm=1010.2135.3001.5113" target="_blank" title="CSDN">
                      
                        <i class="fa fa-fw fa-clone"></i>CSDN</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/shenbh" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://gitee.com/shen_bh" target="_blank" title="Gitee">
                      
                        <i class="fa fa-fw fa-git"></i>Gitee</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.wanandroid.com/" title="玩Android" target="_blank">玩Android</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://wuxiaolong.me/" title="吴小龙同学" target="_blank">吴小龙同学</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://hexo.yuanjh.cn/" title="江州司马" target="_blank">江州司马</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.yanghujun.com/" title="八归少年" target="_blank">八归少年</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://zhpanvip.gitee.io/" title="马可没有菠萝" target="_blank">马可没有菠萝</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://omooo.top/" title="Omooo" target="_blank">Omooo</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://gityuan.com/" title="Gityuan" target="_blank">Gityuan</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8C%85%E4%BD%93%E7%A7%AF%E4%BC%98%E5%8C%96"><span class="nav-text">包体积优化</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E7%98%A6%E8%BA%AB%E4%BC%98%E5%8C%96%E5%8F%8AApk%E5%88%86%E6%9E%90%E6%96%B9%E6%A1%88"><span class="nav-text">一、瘦身优化及Apk分析方案</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#APK-%E7%BB%84%E6%88%90"><span class="nav-text">APK 组成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#APK%E5%88%86%E6%9E%90"><span class="nav-text">APK分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81%E4%BD%BF%E7%94%A8-ApkTool-%E5%8F%8D%E7%BC%96%E8%AF%91%E5%B7%A5%E5%85%B7%E5%88%86%E6%9E%90-APK"><span class="nav-text">1、使用 ApkTool 反编译工具分析 APK</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ApkTool%E5%8F%8D%E7%BC%96%E8%AF%91%E5%AE%9E%E6%88%98"><span class="nav-text">ApkTool反编译实战</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E4%B8%8B%E8%BD%BD%E5%B9%B6%E9%85%8D%E7%BD%AEapktool"><span class="nav-text">1、下载并配置apktool</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E4%BD%BF%E7%94%A8ApkTool%E5%88%86%E6%9E%90APK"><span class="nav-text">2、使用ApkTool分析APK</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E4%BD%BF%E7%94%A8AS-2-2%E4%B9%8B%E5%90%8E%E6%8F%90%E4%BE%9B%E7%9A%84Analyze-APK"><span class="nav-text">2、使用AS 2.2之后提供的Analyze APK</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81%E4%BD%BF%E7%94%A8-nimbledroid-%E8%BF%9B%E8%A1%8C-APK-%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90"><span class="nav-text">3、使用 nimbledroid 进行 APK 性能分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%E3%80%81%E4%BD%BF%E7%94%A8-android-classshark-%E8%BF%9B%E8%A1%8C-APK-%E5%88%86%E6%9E%90"><span class="nav-text">4、使用 android-classshark 进行 APK 分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#android-classshark-%E5%AE%9E%E6%88%98"><span class="nav-text">android-classshark 实战</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E4%BB%A3%E7%A0%81%E7%98%A6%E8%BA%AB%E6%96%B9%E6%A1%88%E6%8E%A2%E7%B4%A2"><span class="nav-text">二、代码瘦身方案探索</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81Dex-%E6%8E%A2%E7%A7%98"><span class="nav-text">1、Dex 探秘</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81ProGuard"><span class="nav-text">2、ProGuard</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%82%A3%E4%B9%88%EF%BC%8C%E6%88%91%E4%BB%AC%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8%E4%BB%A3%E7%A0%81%E6%B7%B7%E6%B7%86%E5%91%A2%EF%BC%9F"><span class="nav-text">那么，我们为什么要使用代码混淆呢？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E6%B7%B7%E6%B7%86%E7%9A%84%E5%BD%A2%E5%BC%8F"><span class="nav-text">代码混淆的形式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Proguard-%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="nav-text">Proguard 的作用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E5%8E%8B%E7%BC%A9%EF%BC%88Shrinking%EF%BC%89"><span class="nav-text">1、压缩（Shrinking）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E4%BC%98%E5%8C%96%EF%BC%88Optimization%EF%BC%89"><span class="nav-text">2、优化（Optimization）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E6%B7%B7%E6%B7%86%EF%BC%88Obfuscation%EF%BC%89"><span class="nav-text">3、混淆（Obfuscation）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Proguard-%E7%9A%84%E4%BC%98%E5%8C%96%E7%BB%86%E8%8A%82"><span class="nav-text">Proguard 的优化细节</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Proguard-%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="nav-text">Proguard 的配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%B7%E6%B7%86%E7%9A%84%E5%9F%BA%E6%9C%AC%E8%A7%84%E5%88%99"><span class="nav-text">混淆的基本规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%B7%E6%B7%86%E5%AE%9E%E6%88%98"><span class="nav-text">混淆实战</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81D8-%E4%B8%8E-R8-%E4%BC%98%E5%8C%96"><span class="nav-text">3、D8 与 R8 优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#D8-%E4%BC%98%E5%8C%96"><span class="nav-text">D8 优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E6%95%88%E6%9E%9C"><span class="nav-text">优化效果</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%80%E5%90%AF-D8"><span class="nav-text">开启 D8</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#R8-%E4%BC%98%E5%8C%96"><span class="nav-text">R8 优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%82%A3%E4%B9%88%EF%BC%8CR8-%E4%B8%8E%E6%B7%B7%E6%B7%86%E7%9B%B8%E6%AF%94%E4%BC%98%E5%8A%BF%E5%9C%A8%E5%93%AA%E9%87%8C%E5%91%A2%EF%BC%9F"><span class="nav-text">那么，R8 与混淆相比优势在哪里呢？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#R8-%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98"><span class="nav-text">R8 优化实战</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E7%A1%AE%E4%BF%9D%E6%9C%AC%E5%9C%B0%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E4%BA%86python-2-7%E6%88%96%E6%9B%B4%E9%AB%98%E7%89%88%E6%9C%AC%E3%80%82"><span class="nav-text">1、确保本地已经安装了python 2.7或更高版本。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E7%94%B1%E4%BA%8ER8%E9%A1%B9%E7%9B%AE%E4%BD%BF%E7%94%A8chromium%E9%A1%B9%E7%9B%AE%E6%8F%90%E4%BE%9B%E7%9A%84depot-tools%E7%AE%A1%E7%90%86%E4%BE%9D%E8%B5%96%EF%BC%8C%E5%9B%A0%E6%AD%A4%E5%85%88%E5%AE%89%E8%A3%85depot-tools%E3%80%82%EF%BC%88%E4%B8%8B%E9%9D%A2%E4%BB%85%E4%BB%8B%E7%BB%8DMac%E7%89%88%E7%9A%84%E5%AE%89%E8%A3%85%EF%BC%89"><span class="nav-text">2、由于R8项目使用chromium项目提供的depot_tools管理依赖，因此先安装depot_tools。（下面仅介绍Mac版的安装）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81Downloading-and-building-R8%E9%A1%B9%E7%9B%AE"><span class="nav-text">3、Downloading and building R8项目</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81tools-x2F-gradle-py-%E8%84%9A%E6%9C%AC%E5%B0%86%E4%BC%9A%E7%94%9F%E6%88%90%E4%B8%A4%E4%B8%AA-jar-%E6%96%87%E4%BB%B6%EF%BC%8C%E5%8D%B3-build-x2F-libs-x2F-d8-jar-%E4%B8%8E-build-x2F-libs-x2F-r8-jar%E3%80%82"><span class="nav-text">4、tools&#x2F;gradle.py 脚本将会生成两个 jar 文件，即 build&#x2F;libs&#x2F;d8.jar  与 build&#x2F;libs&#x2F;r8.jar。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5%E3%80%81%E4%B8%8B%E9%9D%A2%E7%9A%84%E4%BB%A3%E7%A0%81%E6%98%AF%E4%BD%BF%E7%94%A8-R8-%E5%9C%A8-out-%E7%9B%AE%E5%BD%95%E4%B8%8B%E5%8E%BB%E7%94%9F%E6%88%90%E4%BC%98%E5%8C%96%E5%90%8E%E7%9A%84-dex-%E6%96%87%E4%BB%B6%EF%BC%9A"><span class="nav-text">5、下面的代码是使用 R8 在 out 目录下去生成优化后的 dex 文件：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4%E3%80%81%E5%8E%BB%E9%99%A4-debug-%E4%BF%A1%E6%81%AF%E4%B8%8E%E8%A1%8C%E5%8F%B7%E4%BF%A1%E6%81%AF"><span class="nav-text">4、去除 debug 信息与行号信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5%E3%80%81Dex-%E5%88%86%E5%8C%85%E4%BC%98%E5%8C%96"><span class="nav-text">5、Dex 分包优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Dex-%E5%88%86%E5%8C%85%E4%BC%98%E5%8C%96%E5%8E%9F%E7%90%86"><span class="nav-text">Dex 分包优化原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-ReDex-%E8%BF%9B%E8%A1%8C%E5%88%86%E5%8C%85%E4%BC%98%E5%8C%96%E3%80%81%E5%8E%BB%E9%99%A4-debug-%E4%BF%A1%E6%81%AF%E5%8F%8A%E8%A1%8C%E5%8F%B7%E4%BF%A1%E6%81%AF"><span class="nav-text">使用 ReDex 进行分包优化、去除 debug 信息及行号信息</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E9%A6%96%E5%85%88%EF%BC%8C%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E8%BE%93%E5%85%A5%E4%B8%80%E4%B8%8B%E5%91%BD%E4%BB%A4%E5%8E%BB%E5%8E%BB%E5%AE%89%E8%A3%85-Xcode-%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7"><span class="nav-text">1、首先，我们需要输入一下命令去去安装 Xcode 命令行工具</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E7%84%B6%E5%90%8E%EF%BC%8C%E4%BD%BF%E7%94%A8-homebrew-%E5%AE%89%E8%A3%85-redex-%E9%A1%B9%E7%9B%AE%E4%BD%BF%E7%94%A8%E5%88%B0%E7%9A%84%E4%BE%9D%E8%B5%96%E5%BA%93"><span class="nav-text">2、然后，使用 homebrew 安装 redex 项目使用到的依赖库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E6%8E%A5%E7%9D%80%EF%BC%8C%E4%BB%8E-Github-%E4%B8%8A%E8%8E%B7%E5%8F%96-ReDex-%E7%9A%84%E6%BA%90%E7%A0%81%E5%B9%B6%E5%88%87%E6%8D%A2%E5%88%B0-redex-%E7%9B%AE%E5%BD%95%E4%B8%8B"><span class="nav-text">3、接着，从 Github 上获取 ReDex 的源码并切换到 redex 目录下</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81%E4%B8%8B%E4%B8%80%E6%AD%A5%EF%BC%8C%E4%BD%BF%E7%94%A8-autoconf-%E5%92%8C-make-%E5%8E%BB%E6%9E%84%E5%BB%BA-ReDex"><span class="nav-text">4、下一步，使用 autoconf 和 make 去构建 ReDex</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5%E3%80%81%E7%84%B6%E5%90%8E%EF%BC%8C%E9%85%8D%E7%BD%AE-Redex-%E7%9A%84-config-%E4%BB%A3%E7%A0%81"><span class="nav-text">5、然后，配置 Redex 的 config 代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6%E3%80%81%E6%9C%80%E5%90%8E%EF%BC%8C%E6%89%A7%E8%A1%8C%E7%9B%B8%E5%BA%94%E7%9A%84-redex-%E4%BC%98%E5%8C%96%E5%91%BD%E4%BB%A4"><span class="nav-text">6、最后，执行相应的 redex 优化命令</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6%E3%80%81%E4%BD%BF%E7%94%A8-XZ-Utils-%E8%BF%9B%E8%A1%8C-Dex-%E5%8E%8B%E7%BC%A9"><span class="nav-text">6、使用 XZ Utils 进行 Dex 压缩</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7%E3%80%81%E4%B8%89%E6%96%B9%E5%BA%93%E5%A4%84%E7%90%86"><span class="nav-text">7、三方库处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8%E3%80%81%E7%A7%BB%E9%99%A4%E6%97%A0%E7%94%A8%E4%BB%A3%E7%A0%81"><span class="nav-text">8、移除无用代码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-Lint-%E6%A3%80%E6%B5%8B%E6%97%A0%E6%95%88%E4%BB%A3%E7%A0%81"><span class="nav-text">使用 Lint 检测无效代码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9%E3%80%81%E9%81%BF%E5%85%8D%E4%BA%A7%E7%94%9F-Java-access-%E6%96%B9%E6%B3%95"><span class="nav-text">9、避免产生 Java access 方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#access-%E6%96%B9%E6%B3%95%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-text">access 方法是什么？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%81%BF%E5%85%8D%E4%BA%A7%E7%94%9F-access-%E6%96%B9%E6%B3%95%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="nav-text">避免产生 access 方法的方式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10%E3%80%81%E5%88%A9%E7%94%A8-ByteX-Gradle-%E6%8F%92%E4%BB%B6%E5%B9%B3%E5%8F%B0%E4%B8%AD%E7%9A%84%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96%E6%8F%92%E4%BB%B6"><span class="nav-text">10、利用 ByteX Gradle 插件平台中的代码优化插件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11%E3%80%81%E5%B0%8F%E7%BB%93"><span class="nav-text">11、小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E8%B5%84%E6%BA%90%E7%98%A6%E8%BA%AB%E6%96%B9%E6%A1%88%E6%8E%A2%E7%B4%A2"><span class="nav-text">三、资源瘦身方案探索</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E5%86%97%E4%BD%99%E8%B5%84%E6%BA%90%E4%BC%98%E5%8C%96"><span class="nav-text">1、冗余资源优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81%E4%BD%BF%E7%94%A8-Lint-%E7%9A%84-Remove-Unused-Resource"><span class="nav-text">1、使用 Lint 的 Remove Unused Resource</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E4%BC%98%E5%8C%96-shrinkResources-%E6%B5%81%E7%A8%8B%E7%9C%9F%E6%AD%A3%E5%8E%BB%E9%99%A4%E6%97%A0%E7%94%A8%E8%B5%84%E6%BA%90"><span class="nav-text">2、优化 shrinkResources 流程真正去除无用资源</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%EF%BC%89%E3%80%81%E9%A6%96%E5%85%88%EF%BC%8C%E6%94%B6%E9%9B%86-Compiled-Resources-%E4%B8%AD%E8%A2%AB%E6%9B%BF%E6%8D%A2%E7%9A%84%E9%A2%84%E5%AE%9A%E4%B9%89%E7%89%88%E6%9C%AC%E7%9A%84%E8%B5%84%E6%BA%90%E5%90%8D%E7%A7%B0"><span class="nav-text">1）、首先，收集 Compiled Resources 中被替换的预定义版本的资源名称</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%EF%BC%89%E3%80%81%E7%84%B6%E5%90%8E%EF%BC%8C%E4%BD%BF%E7%94%A8-android-chunk-utils-%E6%8A%8A-resources-arsc-%E4%B8%AD%E5%AF%B9%E5%BA%94%E7%9A%84%E5%AE%9A%E4%B9%89%E7%A7%BB%E9%99%A4%E3%80%82"><span class="nav-text">2）、然后，使用 android-chunk-utils  把 resources.arsc 中对应的定义移除。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%EF%BC%89%E3%80%81%E6%9C%80%E5%90%8E%EF%BC%8C%E5%88%A0%E9%99%A4%E8%B5%84%E6%BA%90%E5%8C%85%E4%B8%AD%E5%AF%B9%E5%BA%94%E7%9A%84%E8%B5%84%E6%BA%90%E6%96%87%E4%BB%B6%E5%8D%B3%E5%8F%AF%E3%80%82"><span class="nav-text">3）、最后，删除资源包中对应的资源文件即可。</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E9%87%8D%E5%A4%8D%E8%B5%84%E6%BA%90%E4%BC%98%E5%8C%96"><span class="nav-text">2、重复资源优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E5%9B%BE%E7%89%87%E5%8E%8B%E7%BC%A9"><span class="nav-text">3、图片压缩</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4%E3%80%81%E4%BD%BF%E7%94%A8%E9%92%88%E5%AF%B9%E6%80%A7%E7%9A%84%E5%9B%BE%E7%89%87%E6%A0%BC%E5%BC%8F"><span class="nav-text">4、使用针对性的图片格式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5%E3%80%81%E8%B5%84%E6%BA%90%E6%B7%B7%E6%B7%86"><span class="nav-text">5、资源混淆</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81AndroidResGuard-%E5%AE%9E%E6%88%98"><span class="nav-text">1、AndroidResGuard 实战</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E9%A6%96%E5%85%88%EF%BC%8C%E6%88%91%E4%BB%AC%E5%9C%A8%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%A0%B9-build-gradle-%E6%96%87%E4%BB%B6%E4%B8%8B%E5%8A%A0%E5%85%A5%E4%B8%8B%E9%9D%A2%E7%9A%84%E6%8F%92%E4%BB%B6%E4%BE%9D%E8%B5%96%EF%BC%9A"><span class="nav-text">1、首先，我们在项目的根 build.gradle 文件下加入下面的插件依赖：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E7%84%B6%E5%90%8E%EF%BC%8C%E5%9C%A8%E9%A1%B9%E7%9B%AE-module-%E4%B8%8B%E7%9A%84-build-gradle-%E6%96%87%E4%BB%B6%E4%B8%8B%E5%BC%95%E5%85%A5%E5%85%B6%E6%8F%92%E4%BB%B6%EF%BC%9A"><span class="nav-text">2、然后，在项目 module 下的 build.gradle 文件下引入其插件：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E6%8E%A5%E7%9D%80%EF%BC%8C%E5%8A%A0%E5%85%A5-AndroidResGuard-%E7%9A%84%E9%85%8D%E7%BD%AE%E9%A1%B9%EF%BC%8C%E5%A6%82%E4%B8%8B%E6%98%AF%E9%BB%98%E8%AE%A4%E8%AE%BE%E7%BD%AE%E5%A5%BD%E7%9A%84%E9%85%8D%E7%BD%AE%EF%BC%9A"><span class="nav-text">3、接着，加入 AndroidResGuard 的配置项，如下是默认设置好的配置：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81%E6%9C%80%E5%90%8E%EF%BC%8C%E6%88%91%E4%BB%AC%E7%82%B9%E5%87%BB%E5%8F%B3%E8%BE%B9%E7%9A%84%E9%A1%B9%E7%9B%AE-module-x2F-Tasks-x2F-andresguard-x2F-resguardRelease-%E5%8D%B3%E5%8F%AF%E7%94%9F%E6%88%90%E8%B5%84%E6%BA%90%E6%B7%B7%E6%B7%86%E8%BF%87%E7%9A%84-APK%E3%80%82%E5%A6%82%E4%B8%8B%E5%9B%BE%E6%89%80%E7%A4%BA%EF%BC%9A"><span class="nav-text">4、最后，我们点击右边的项目 module&#x2F;Tasks&#x2F;andresguard&#x2F;resguardRelease 即可生成资源混淆过的 APK。如下图所示：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81AndResGuard-%E7%9A%84%E8%B5%84%E6%BA%90%E6%B7%B7%E6%B7%86%E5%8E%9F%E7%90%86"><span class="nav-text">2、AndResGuard 的资源混淆原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81AndResGuard-%E7%9A%84%E6%9E%81%E9%99%90%E5%8E%8B%E7%BC%A9%E5%8E%9F%E7%90%86"><span class="nav-text">3、AndResGuard 的极限压缩原理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6%E3%80%81R-Field-%E7%9A%84%E5%86%85%E8%81%94%E4%BC%98%E5%8C%96"><span class="nav-text">6、R Field 的内联优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7%E3%80%81%E8%B5%84%E6%BA%90%E5%90%88%E5%B9%B6%E6%96%B9%E6%A1%88"><span class="nav-text">7、资源合并方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8%E3%80%81%E8%B5%84%E6%BA%90%E6%96%87%E4%BB%B6%E6%9C%80%E5%B0%91%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="nav-text">8、资源文件最少化配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9%E3%80%81%E5%B0%BD%E9%87%8F%E6%AF%8F%E5%BC%A0%E5%9B%BE%E7%89%87%E5%8F%AA%E4%BF%9D%E7%95%99%E4%B8%80%E4%BB%BD"><span class="nav-text">9、尽量每张图片只保留一份</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10%E3%80%81%E8%B5%84%E6%BA%90%E5%9C%A8%E7%BA%BF%E5%8C%96"><span class="nav-text">10、资源在线化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11%E3%80%81%E7%BB%9F%E4%B8%80%E5%BA%94%E7%94%A8%E9%A3%8E%E6%A0%BC"><span class="nav-text">11、统一应用风格</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81So-%E7%98%A6%E8%BA%AB%E6%96%B9%E6%A1%88%E6%8E%A2%E7%B4%A2"><span class="nav-text">四、So 瘦身方案探索</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81So-%E7%A7%BB%E9%99%A4%E6%96%B9%E6%A1%88"><span class="nav-text">1、So 移除方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81So-%E7%A7%BB%E9%99%A4%E6%96%B9%E6%A1%88%E4%BC%98%E5%8C%96%E7%89%88"><span class="nav-text">2、So 移除方案优化版</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E4%BD%BF%E7%94%A8-XZ-Utils-%E5%AF%B9-Native-Library-%E8%BF%9B%E8%A1%8C%E5%8E%8B%E7%BC%A9"><span class="nav-text">3、使用 XZ Utils 对 Native Library 进行压缩</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4%E3%80%81%E5%AF%B9-Native-Library-%E8%BF%9B%E8%A1%8C%E5%90%88%E5%B9%B6"><span class="nav-text">4、对 Native Library 进行合并</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5%E3%80%81%E5%88%A0%E9%99%A4-Native-Library-%E4%B8%AD%E6%97%A0%E7%94%A8%E7%9A%84%E5%AF%BC%E5%87%BA-symbol"><span class="nav-text">5、删除 Native Library 中无用的导出 symbol</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6%E3%80%81So-%E5%8A%A8%E6%80%81%E4%B8%8B%E8%BD%BD"><span class="nav-text">6、So 动态下载</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E5%85%B6%E5%AE%83%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88"><span class="nav-text">五、其它优化方案</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E6%8F%92%E4%BB%B6%E5%8C%96"><span class="nav-text">1、插件化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E4%B8%9A%E5%8A%A1%E6%A2%B3%E7%90%86"><span class="nav-text">2、业务梳理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E8%BD%AC%E5%8F%98%E5%BC%80%E5%8F%91%E6%A8%A1%E5%BC%8F"><span class="nav-text">3、转变开发模式</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E5%8C%85%E4%BD%93%E7%A7%AF%E7%9B%91%E6%8E%A7"><span class="nav-text">六、包体积监控</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E5%8C%85%E4%BD%93%E7%A7%AF%E7%9B%91%E6%8E%A7%E7%9A%84%E7%BA%AC%E5%BA%A6"><span class="nav-text">1、包体积监控的纬度</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%83%E3%80%81%E7%98%A6%E8%BA%AB%E4%BC%98%E5%8C%96%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="nav-text">七、瘦身优化常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E6%80%8E%E4%B9%88%E9%99%8D%E4%BD%8E-Apk-%E5%8C%85%E5%A4%A7%E5%B0%8F%EF%BC%9F"><span class="nav-text">1、怎么降低 Apk 包大小？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81Apk-%E7%98%A6%E8%BA%AB%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E9%95%BF%E6%95%88%E6%B2%BB%E7%90%86%EF%BC%9F"><span class="nav-text">2、Apk 瘦身如何实现长效治理？</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AB%E3%80%81%E6%80%BB%E7%BB%93"><span class="nav-text">八、总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">阿炳</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('-1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
          if(result)$(this).text('Copied')
          else $(this).text('Copy failed')
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('Copy')
        }, 300)
      }).append(e)
    })
  </script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>