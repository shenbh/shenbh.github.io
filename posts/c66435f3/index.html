<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="private," />










<meta name="description" content="基础语法概述  [!说明]自定义变量不能与基础通用属性&#x2F;事件名重复。   装饰器： 用于装饰类、结构、方法以及变量，并赋予其特殊的含义。如上述示例中@Entry、@Component和@State都是装饰器，@Component表示自定义组件，@Entry表示该自定义组件为入口组件，@State表示组件中的状态变量，&#x3D;&#x3D;状态变量变化会触发UI刷新&#x3D;&amp;#x3D">
<meta property="og:type" content="article">
<meta property="og:title" content="声明式UI语法">
<meta property="og:url" content="http://shenbh.github.io/posts/c66435f3/index.html">
<meta property="og:site_name" content="YULI">
<meta property="og:description" content="基础语法概述  [!说明]自定义变量不能与基础通用属性&#x2F;事件名重复。   装饰器： 用于装饰类、结构、方法以及变量，并赋予其特殊的含义。如上述示例中@Entry、@Component和@State都是装饰器，@Component表示自定义组件，@Entry表示该自定义组件为入口组件，@State表示组件中的状态变量，&#x3D;&#x3D;状态变量变化会触发UI刷新&#x3D;&amp;#x3D">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://shenbh.github.io/posts/c66435f3/ArkTS%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%BB%84%E6%88%90.jpeg">
<meta property="og:image" content="http://shenbh.github.io/posts/c66435f3/%E7%8A%B6%E6%80%81%E9%A9%B1%E5%8A%A8UI%E6%9B%B4%E6%96%B0%E5%85%AC%E5%BC%8F.png">
<meta property="og:image" content="http://shenbh.github.io/posts/c66435f3/%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%B5%81%E7%A8%8B.png">
<meta property="og:image" content="http://shenbh.github.io/posts/c66435f3/ForEach%E9%94%AE%E5%80%BC%E7%94%9F%E6%88%90%E8%A7%84%E5%88%99.jpg">
<meta property="og:image" content="http://shenbh.github.io/posts/c66435f3/ForEach%E6%95%B0%E6%8D%AE%E6%BA%90%E4%B8%8D%E5%AD%98%E5%9C%A8%E7%9B%B8%E5%90%8C%E5%80%BC%E6%A1%88%E4%BE%8B%E9%A6%96%E6%AC%A1%E6%B8%B2%E6%9F%93%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C%E5%9B%BE.png">
<meta property="og:image" content="http://shenbh.github.io/posts/c66435f3/ForEach%E6%95%B0%E6%8D%AE%E6%BA%90%E4%B8%8D%E5%AD%98%E5%9C%A8%E7%9B%B8%E5%90%8C%E5%80%BC%E6%A1%88%E4%BE%8B%E9%A6%96%E6%AC%A1%E6%B8%B2%E6%9F%93%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C%E5%9B%BE.png">
<meta property="og:image" content="http://shenbh.github.io/posts/c66435f3/ForEach%E9%9D%9E%E9%A6%96%E6%AC%A1%E6%B8%B2%E6%9F%93%E6%A1%88%E4%BE%8B%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C%E5%9B%BE.gif">
<meta property="og:image" content="http://shenbh.github.io/posts/c66435f3/%E9%AA%A8%E6%9E%B6%E5%B1%8F%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C%E5%9B%BE.png">
<meta property="og:image" content="http://shenbh.github.io/posts/c66435f3/%E6%95%B0%E6%8D%AE%E6%BA%90%E6%95%B0%E7%BB%84%E9%A1%B9%E5%8F%98%E5%8C%96%E6%A1%88%E4%BE%8B%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C%E5%9B%BE.png">
<meta property="og:image" content="http://shenbh.github.io/posts/c66435f3/%E6%95%B0%E6%8D%AE%E6%BA%90%E6%95%B0%E7%BB%84%E9%A1%B9%E5%AD%90%E5%B1%9E%E6%80%A7%E5%8F%98%E5%8C%96%E6%A1%88%E4%BE%8B%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C%E5%9B%BE.png">
<meta property="og:image" content="http://shenbh.github.io/posts/c66435f3/%E6%B8%B2%E6%9F%93%E7%BB%93%E6%9E%9C%E9%9D%9E%E9%A2%84%E6%9C%9F%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C%E5%9B%BE.gif">
<meta property="og:image" content="http://shenbh.github.io/posts/c66435f3/%E6%B8%B2%E6%9F%93%E6%80%A7%E8%83%BD%E9%99%8D%E4%BD%8E%E6%A1%88%E4%BE%8B%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C%E5%9B%BE.gif">
<meta property="og:image" content="http://shenbh.github.io/posts/c66435f3/%E6%B8%B2%E6%9F%93%E6%80%A7%E8%83%BD%E9%99%8D%E4%BD%8E%E6%A1%88%E4%BE%8B%E6%97%A5%E5%BF%97%E6%89%93%E5%8D%B0%E5%9B%BE.png">
<meta property="article:published_time" content="2024-07-17T00:48:00.000Z">
<meta property="article:modified_time" content="2024-10-23T01:59:02.905Z">
<meta property="article:author" content="阿炳">
<meta property="article:tag" content="private">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://shenbh.github.io/posts/c66435f3/ArkTS%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%BB%84%E6%88%90.jpeg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://shenbh.github.io/posts/c66435f3/"/>





  <title>声明式UI语法 | YULI</title><meta name="robots" content="noindex">
  








<meta name="generator" content="Hexo 6.1.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">YULI</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Just do IT Now.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://shenbh.github.io/posts/c66435f3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YULI">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">声明式UI语法</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2024-07-17T08:48:00+08:00">
                2024-07-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HarmonyOS/" itemprop="url" rel="index">
                    <span itemprop="name">HarmonyOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="基础语法概述"><a href="#基础语法概述" class="headerlink" title="基础语法概述"></a><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/training/course/slightMooc/C101717496870909384">基础语法概述</a></h1><p><img src="/posts/c66435f3/ArkTS%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%BB%84%E6%88%90.jpeg" alt="ArkTS的基本组成"></p>
<blockquote>
<p>[!说明]<br>自定义变量不能与基础通用属性&#x2F;事件名重复。</p>
</blockquote>
<ul>
<li>装饰器： 用于装饰类、结构、方法以及变量，并赋予其特殊的含义。如上述示例中<code>@Entry</code>、<code>@Component</code>和<code>@State</code>都是装饰器，<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-create-custom-components-V5#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84">@Component</a>表示自定义组件，<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-create-custom-components-V5#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84">@Entry</a>表示该自定义组件为入口组件，<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-state-V5">@State</a>表示组件中的状态变量，&#x3D;&#x3D;状态变量变化会触发UI刷新&#x3D;&#x3D;。</li>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-declarative-ui-description-V5">UI描述</a>：以声明式的方式来描述UI的结构，例如<code>build()</code>方法中的代码块。</li>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-create-custom-components-V5">自定义组件</a>：<strong>可复用</strong>的UI单元，可组合其他组件，如上述被<code>@Component</code>装饰的struct Hello。</li>
<li>系统组件：ArkUI框架中默认内置的基础和容器组件，可直接被开发者调用，比如示例中的<code>Column</code>、<code>Text</code>、<code>Divider</code>、<code>Button</code>。</li>
<li>属性方法：组件可以通过<strong>链式调用</strong>配置多项属性，如<code>fontSize()</code>、<code>width()</code>、<code>height()</code>、<code>backgroundColor()</code>等。</li>
<li>事件方法：组件可以通过<strong>链式调用</strong>设置多个事件的响应逻辑，如跟随在<code>Button</code>后面的<code>onClick()</code>。</li>
<li>系统组件、属性方法、事件方法具体使用可参考<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-universal-events-click-V5">基于ArkTS的声明式开发范式</a>。</li>
</ul>
<p>除此之外，ArkTS扩展了多种语法范式来使开发更加便捷：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-builder-V5">@Builder</a>&#x2F;<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-builderparam-V5">@BuilderParam</a>：特殊的<strong>封装UI描述</strong>的方法，细粒度的封装和复用UI描述。</li>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-extend-V5">@Extend</a>（<strong>仅支持全局定义</strong>）&#x2F;<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-style-V5">@Styles</a>（仅支持<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-universal-attributes-size-V5">通用属性</a>和<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-universal-events-click-V5">通用事件</a>。只能在当前文件内使用，不支持export。）：<strong>扩展内置组件</strong>和<strong>封装属性样式</strong>，更灵活地组合内置组件。</li>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-statestyles-V5">stateStyles</a>：多态样式，可以依据组件的内部状态的不同，设置不同样式。</li>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-user-defined-extension-attributemodifier-V5">自定义扩展</a> AttributeModifier</li>
</ul>
<h1 id="声明式UI描述"><a href="#声明式UI描述" class="headerlink" title="声明式UI描述"></a><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/training/course/slightMooc/C101717496870909384">声明式UI描述</a></h1><p>ArkTS以<strong>声明方式组合</strong>和<strong>扩展组件</strong>来描述应用程序的UI，同时还提供了基本的属性、事件和子组件配置方法，帮助开发者实现应用交互逻辑。</p>
<h2 id="创建组件"><a href="#创建组件" class="headerlink" title="创建组件"></a>创建组件</h2><p>根据组件构造方法的不同，创建组件包含有参数和无参数两种方式。</p>
<blockquote>
<p>[!说明]<br>创建组件时不需要<code>new</code>运算符。</p>
</blockquote>
<h3 id="无参数"><a href="#无参数" class="headerlink" title="无参数"></a>无参数</h3><p>如果组件的接口定义没有包含必选构造参数，则组件后面的“<code>()</code>”不需要配置任何内容。例如，Divider组件不包含构造参数。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Column</span>() &#123;</span><br><span class="line">  <span class="title class_">Text</span>(<span class="string">&#x27;item 1&#x27;</span>)</span><br><span class="line">  <span class="title class_">Divider</span>()</span><br><span class="line">  <span class="title class_">Text</span>(<span class="string">&#x27;item 2&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="有参数"><a href="#有参数" class="headerlink" title="有参数"></a>有参数</h3><p>如果组件的接口定义包含构造参数，则在组件后面的“<code>()</code>”需要配置相应参数。</p>
<ul>
<li>Image组件的必选参数src。<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Image</span>(<span class="string">&#x27;https://xyz/test.jpg&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
<li>Text组件的非必选参数content。<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// string类型的参数</span></span><br><span class="line"><span class="title class_">Text</span>(<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line"><span class="comment">// $r形式引入应用资源，可应用于多语言场景</span></span><br><span class="line"><span class="title class_">Text</span>($r(<span class="string">&#x27;app.string.title_value&#x27;</span>))</span><br><span class="line"><span class="comment">// 无参数形式</span></span><br><span class="line"><span class="title class_">Text</span>()</span><br></pre></td></tr></table></figure></li>
<li>变量或表达式也可以用于参数赋值，其中表达式返回的结果类型必须满足参数类型要求。<br>  例如，设置变量或表达式来构造Image和Text组件的参数。  <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Image</span>(<span class="variable language_">this</span>.<span class="property">imagePath</span>)</span><br><span class="line"><span class="title class_">Image</span>(<span class="string">&#x27;https://&#x27;</span> + <span class="variable language_">this</span>.<span class="property">imageUrl</span>)</span><br><span class="line"><span class="title class_">Text</span>(<span class="string">`count: <span class="subst">$&#123;<span class="variable language_">this</span>.count&#125;</span>`</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="配置属性"><a href="#配置属性" class="headerlink" title="配置属性"></a>配置属性</h2><p>属性方法以“<code>.</code>”链式调用的方式配置系统组件的样式和其他属性，建议每个属性方法单独写一行。</p>
<ul>
<li>配置Text组件的字体大小。<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Text</span>(<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line">  .<span class="title function_">fontSize</span>(<span class="number">12</span>)</span><br></pre></td></tr></table></figure></li>
<li>配置组件的多个属性。<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Image</span>(<span class="string">&#x27;test.jpg&#x27;</span>)</span><br><span class="line">  .<span class="title function_">alt</span>(<span class="string">&#x27;error.jpg&#x27;</span>)    </span><br><span class="line">  .<span class="title function_">width</span>(<span class="number">100</span>)    </span><br><span class="line">  .<span class="title function_">height</span>(<span class="number">100</span>)</span><br></pre></td></tr></table></figure></li>
<li>除了直接传递常量参数外，还可以传递变量或表达式。<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Text</span>(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">  .<span class="title function_">fontSize</span>(<span class="variable language_">this</span>.<span class="property">size</span>)</span><br><span class="line"><span class="title class_">Image</span>(<span class="string">&#x27;test.jpg&#x27;</span>)</span><br><span class="line">  .<span class="title function_">width</span>(<span class="variable language_">this</span>.<span class="property">count</span> % <span class="number">2</span> === <span class="number">0</span> ? <span class="number">100</span> : <span class="number">200</span>)    </span><br><span class="line">  .<span class="title function_">height</span>(<span class="variable language_">this</span>.<span class="property">offset</span> + <span class="number">100</span>)</span><br></pre></td></tr></table></figure></li>
<li>对于系统组件，ArkUI还为其属性预定义了一些枚举类型供开发者调用，枚举类型可以作为参数传递，但必须满足参数类型要求。<br>  例如，可以按以下方式配置Text组件的颜色和字体样式。  <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Text</span>(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">  .<span class="title function_">fontSize</span>(<span class="number">20</span>)</span><br><span class="line">  .<span class="title function_">fontColor</span>(<span class="title class_">Color</span>.<span class="property">Red</span>)</span><br><span class="line">  .<span class="title function_">fontWeight</span>(<span class="title class_">FontWeight</span>.<span class="property">Bold</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="配置事件"><a href="#配置事件" class="headerlink" title="配置事件"></a>配置事件</h2><p>事件方法以“<code>.</code>”链式调用的方式配置系统组件支持的事件，建议每个事件方法单独写一行。</p>
<ul>
<li>使用<strong>箭头函数</strong>配置组件的事件方法。<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Button</span>(<span class="string">&#x27;Click me&#x27;</span>)</span><br><span class="line">  .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">myText</span> = <span class="string">&#x27;ArkUI&#x27;</span>;</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure></li>
<li>使用<strong>匿名函数表达式</strong>配置组件的事件方法，要求使用“<code>() =&gt; &#123;...&#125;</code>”，以确保函数与组件绑定，同时符合ArkTS语法规范。<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Button</span>(<span class="string">&#x27;add counter&#x27;</span>)</span><br><span class="line">  .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">counter</span> += <span class="number">2</span>;</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure></li>
<li>使用组件的<strong>成员函数</strong>配置组件的事件方法，<strong>需要</strong><code>bind this</code>。ArkTS语法不推荐使用成员函数配合<code>bind this</code>去配置组件的事件方法。<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">myClickHandler</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">counter</span> += <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="title class_">Button</span>(<span class="string">&#x27;add counter&#x27;</span>)</span><br><span class="line">  .<span class="title function_">onClick</span>(<span class="variable language_">this</span>.<span class="property">myClickHandler</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>))</span><br></pre></td></tr></table></figure></li>
<li>使用声明的<strong>箭头函数</strong>，可以直接调用，<strong>不需要bind this</strong>。<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fn = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">`counter: <span class="subst">$&#123;<span class="variable language_">this</span>.counter&#125;</span>`</span>)</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">counter</span>++</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="title class_">Button</span>(<span class="string">&#x27;add counter&#x27;</span>)</span><br><span class="line">  .<span class="title function_">onClick</span>(<span class="variable language_">this</span>.<span class="property">fn</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>[!说明]<br>&#x3D;&#x3D;箭头函数&#x3D;&#x3D;内部的<code>this</code>是&#x3D;&#x3D;词法作用域&#x3D;&#x3D;，由上下文确定。&#x3D;&#x3D;匿名函数&#x3D;&#x3D;可能会有<code>this</code>指向不明确问题，在ArkTS中&#x3D;&#x3D;不允许&#x3D;&#x3D;使用。</p>
</blockquote>
<h2 id="配置子组件"><a href="#配置子组件" class="headerlink" title="配置子组件"></a><strong>配置子组件</strong></h2><p>如果组件支持子组件配置，则需在<strong>尾随闭包</strong>“<code>&#123;...&#125;</code>“中为组件添加子组件的UI描述。<code>Column</code>、<code>Row</code>、<code>Stack</code>、<code>Grid</code>、<code>List</code>等组件都是<strong>容器组件</strong>。  </p>
<ul>
<li>以下是简单的<code>Column</code>组件配置子组件的示例。<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Column</span>() &#123;</span><br><span class="line">  <span class="title class_">Text</span>(<span class="string">&#x27;Hello&#x27;</span>)</span><br><span class="line">    .<span class="title function_">fontSize</span>(<span class="number">100</span>)</span><br><span class="line">  <span class="title class_">Divider</span>()</span><br><span class="line">  <span class="title class_">Text</span>(<span class="variable language_">this</span>.<span class="property">myText</span>)</span><br><span class="line">    .<span class="title function_">fontSize</span>(<span class="number">100</span>)</span><br><span class="line">    .<span class="title function_">fontColor</span>(<span class="title class_">Color</span>.<span class="property">Red</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>容器组件均支持子组件配置，可以实现相对复杂的多级嵌套。<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Column</span>() &#123;</span><br><span class="line">  <span class="title class_">Row</span>() &#123;</span><br><span class="line">    <span class="title class_">Image</span>(<span class="string">&#x27;test1.jpg&#x27;</span>)</span><br><span class="line">      .<span class="title function_">width</span>(<span class="number">100</span>)</span><br><span class="line">      .<span class="title function_">height</span>(<span class="number">100</span>)</span><br><span class="line">    <span class="title class_">Button</span>(<span class="string">&#x27;click +1&#x27;</span>)</span><br><span class="line">      .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&#x27;+1 clicked!&#x27;</span>);</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="创建自定义组件"><a href="#创建自定义组件" class="headerlink" title="创建自定义组件"></a><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/training/course/slightMooc/C101717496870909384">创建自定义组件</a></h1><p>在ArkUI中，&#x3D;&#x3D;UI显示的内容均为组件&#x3D;&#x3D;，由框架直接提供的称为系统组件，由开发者定义的称为自定义组件。在进行 UI 界面开发时，通常不是简单的将系统组件进行组合使用，而是需要考虑代码可复用性、业务逻辑与UI分离，后续版本演进等因素。因此，将UI和部分业务逻辑封装成自定义组件是不可或缺的能力。<br>自定义组件具有以下特点：  </p>
<ul>
<li>可组合：允许开发者组合使用系统组件、及其属性和方法。    </li>
<li>可重用：自定义组件可以被其他组件重用，并作为不同的实例在不同的父组件或容器中使用。</li>
<li>数据驱动UI更新：通过状态变量的改变，来驱动UI的刷新。<h2 id="自定义组件的基本用法"><a href="#自定义组件的基本用法" class="headerlink" title="自定义组件的基本用法"></a>自定义组件的基本用法</h2>以下示例展示了自定义组件的基本用法。<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">HelloComponent</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">message</span>: <span class="built_in">string</span> = <span class="string">&#x27;Hello, World!&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// HelloComponent自定义组件组合系统组件Row和Text</span></span><br><span class="line">    <span class="title class_">Row</span>() &#123;</span><br><span class="line">      <span class="title class_">Text</span>(<span class="variable language_">this</span>.<span class="property">message</span>)</span><br><span class="line">        .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// 状态变量message的改变驱动UI刷新，UI从&#x27;Hello, World!&#x27;刷新为&#x27;Hello, ArkUI!&#x27;</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">message</span> = <span class="string">&#x27;Hello, ArkUI!&#x27;</span>;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>[!注意]<br>如果在另外的文件中引用该自定义组件，需要使用export关键字导出，并在使用的页面import该自定义组件。</p>
</blockquote>
</li>
</ul>
<p>HelloComponent可以在其他自定义组件中的<code>build()</code>函数中多次创建，实现自定义组件的重用。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HelloComponentParam</span> &#123;</span><br><span class="line">  <span class="attr">message</span>: <span class="built_in">string</span> = <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">ParentComponent</span> &#123;</span><br><span class="line">  <span class="attr">param</span>: <span class="title class_">HelloComponentParam</span> = &#123;</span><br><span class="line">    <span class="attr">message</span>: <span class="string">&#x27;Hello, World!&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;ArkUI message&#x27;</span>)</span><br><span class="line">      <span class="title class_">HelloComponent</span>(<span class="variable language_">this</span>.<span class="property">param</span>);</span><br><span class="line">      <span class="title class_">Divider</span>()</span><br><span class="line">      <span class="title class_">HelloComponent</span>(<span class="variable language_">this</span>.<span class="property">param</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要完全理解上面的示例，需要了解自定义组件的以下概念定义，本文将在后面的小节中介绍：</p>
<ul>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84">自定义组件的基本结构</a></li>
<li><a href="#%E6%88%90%E5%91%98%E5%87%BD%E6%95%B0/%E5%8F%98%E9%87%8F">成员函数&#x2F;变量</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6%E7%9A%84%E5%8F%82%E6%95%B0%E8%A7%84%E5%AE%9A">自定义组件的参数规定</a></li>
<li><a href="#build()%E5%87%BD%E6%95%B0">build()函数</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6%E9%80%9A%E7%94%A8%E6%A0%B7%E5%BC%8F">自定义组件通用样式</a></li>
</ul>
<h2 id="自定义组件的基本结构"><a href="#自定义组件的基本结构" class="headerlink" title="自定义组件的基本结构"></a>自定义组件的基本结构</h2><h3 id="struct"><a href="#struct" class="headerlink" title="struct"></a>struct</h3><p>自定义组件基于struct实现，<code>struct + 自定义组件名 + &#123;...&#125;</code>的组合构成自定义组件，<strong>不能有继承关系</strong>。对于struct的实例化，可以<strong>省略new</strong>。</p>
<blockquote>
<p>[!说明]<br>自定义组件名、类名、函数名不能和系统组件名相同。  </p>
</blockquote>
<h3 id="Component"><a href="#Component" class="headerlink" title="@Component"></a>@Component</h3><p><code>@Component</code>装饰器<strong>仅能装饰struct</strong>关键字声明的数据结构。struct被@Component装饰后具备组件化的能力，需要实现build方法描述UI，一个struct只能被一个@Component装饰。@Component可以接受一个可选的bool类型参数。</p>
<blockquote>
<p>[!说明]<br>从API version 9开始，该装饰器支持在ArkTS卡片中使用。<br>从API version 11开始，@Component可以接受一个可选的bool类型参数。    </p>
</blockquote>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">MyComponent</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="freezeWhenInactive11"><a href="#freezeWhenInactive11" class="headerlink" title="freezeWhenInactive11+"></a>freezeWhenInactive11+</h4><p><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-custom-components-freeze-V5">组件冻结</a>选项。  </p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">类型</th>
<th align="left">必填</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">freezeWhenInactive</td>
<td align="left">bool</td>
<td align="left">否</td>
<td align="left">是否开启组件冻结。</td>
</tr>
</tbody></table>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(&#123; <span class="attr">freezeWhenInactive</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">struct <span class="title class_">MyComponent</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="build-函数"><a href="#build-函数" class="headerlink" title="build()函数"></a>build()函数</h3><p><code>build()</code>函数用于定义自定义组件的声明式UI描述，自定义组件<strong>必须定义</strong><code>build()</code>函数。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">MyComponent</span> &#123;</span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Entry"><a href="#Entry" class="headerlink" title="@Entry"></a>@Entry</h3><p><code>@Entry</code>装饰的自定义组件将作为UI页面的入口。在单个UI页面中，最多可以使用<code>@Entry</code>装饰一个自定义组件。<code>@Entry</code>可以接受一个可选的<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-localstorage-V5">LocalStorage</a>的参数。</p>
<blockquote>
<p>[!说明]<br>从API version 9开始，该装饰器支持在ArkTS卡片中使用。<br>从API version 10开始，@Entry可以接受一个可选的<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-localstorage-V5">LocalStorage</a>的参数或者一个可选的<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/#entryOptions">EntryOptions</a>参数。<br>从API version 11开始，该装饰器支持在元服务中使用。</p>
</blockquote>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">MyComponent</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="EntryOptions10"><a href="#EntryOptions10" class="headerlink" title="EntryOptions10+"></a>EntryOptions10+</h4><p>命名路由跳转选项。</p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">类型</th>
<th align="left">必填</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">routeName</td>
<td align="left">string</td>
<td align="left">否</td>
<td align="left">表示作为命名路由页面的名字。</td>
</tr>
<tr>
<td align="left">storage</td>
<td align="left"><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-localstorage-V5">LocalStorage</a></td>
<td align="left">否</td>
<td align="left">页面级的UI状态存储。</td>
</tr>
<tr>
<td align="left">useSharedStorage12+</td>
<td align="left">boolean</td>
<td align="left">否</td>
<td align="left">是否使用<code>LocalStorage.getShared()</code>接口返回的<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-localstorage-V5">LocalStorage</a>实例对象，默认值false。</td>
</tr>
</tbody></table>
<blockquote>
<p>[!说明]<br>当useSharedStorage设置为true，并且storage又被赋值时，useSharedStorage的值优先级更高。</p>
</blockquote>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span>(&#123; routeName : <span class="string">&#x27;myPage&#x27;</span> &#125;)</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">MyComponent</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Reusable"><a href="#Reusable" class="headerlink" title="@Reusable"></a>@Reusable</h3><p>@Reusable装饰的自定义组件具备可复用能力</p>
<blockquote>
<p>[!说明]<br>从API version 10开始，该装饰器支持在ArkTS卡片中使用。</p>
</blockquote>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Reusable</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">MyComponent</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="成员函数-x2F-变量"><a href="#成员函数-x2F-变量" class="headerlink" title="成员函数&#x2F;变量"></a>成员函数&#x2F;变量</h2><p>自定义组件除了必须要实现<code>build()</code>函数外，还可以实现其他成员函数，成员函数具有以下约束：</p>
<ul>
<li>自定义组件的成员函数为<strong>私有的</strong>，且<strong>不建议声明成静态函数</strong>。</li>
</ul>
<p>自定义组件可以包含成员变量，成员变量具有以下约束：</p>
<ul>
<li>自定义组件的成员变量为<strong>私有的</strong>，且<strong>不建议声明成静态变量</strong>。</li>
<li>自定义组件的成员变量本地初始化有些是可选的，有些是必选的。具体是否需要本地初始化，是否需要从父组件通过参数传递初始化子组件的成员变量，请参考<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-state-management-overview-V5">状态管理</a>。</li>
</ul>
<h2 id="自定义组件的参数规定"><a href="#自定义组件的参数规定" class="headerlink" title="自定义组件的参数规定"></a>自定义组件的参数规定</h2><p>从上文的示例中，我们已经了解到，可以在build方法里创建自定义组件，在创建自定义组件的过程中，根据装饰器的规则来<strong>初始化自定义组件的参数</strong>。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">MyComponent</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">countDownFrom</span>: <span class="built_in">number</span> = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">color</span>: <span class="title class_">Color</span> = <span class="title class_">Color</span>.<span class="property">Blue</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">ParentComponent</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">someColor</span>: <span class="title class_">Color</span> = <span class="title class_">Color</span>.<span class="property">Pink</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="comment">// 创建MyComponent实例，并将创建MyComponent成员变量countDownFrom初始化为10，将成员变量color初始化为this.someColor</span></span><br><span class="line">      <span class="title class_">MyComponent</span>(&#123; <span class="attr">countDownFrom</span>: <span class="number">10</span>, <span class="attr">color</span>: <span class="variable language_">this</span>.<span class="property">someColor</span> &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面的示例代码将父组件中的<strong>函数传递</strong>给子组件，并在子组件中调用。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Parent</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">cnt</span>: <span class="built_in">number</span> = <span class="number">0</span></span><br><span class="line">  <span class="attr">submit</span>: <span class="function">() =&gt;</span> <span class="built_in">void</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cnt</span>++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.cnt&#125;</span>`</span>)</span><br><span class="line">      <span class="title class_">Son</span>(&#123; <span class="attr">submitArrow</span>: <span class="variable language_">this</span>.<span class="property">submit</span> &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Son</span> &#123;</span><br><span class="line">  submitArrow?: <span class="function">() =&gt;</span> <span class="built_in">void</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Row</span>() &#123;</span><br><span class="line">      <span class="title class_">Button</span>(<span class="string">&#x27;add&#x27;</span>)</span><br><span class="line">        .<span class="title function_">width</span>(<span class="number">80</span>)</span><br><span class="line">        .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">submitArrow</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">submitArrow</span>()</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">justifyContent</span>(<span class="title class_">FlexAlign</span>.<span class="property">SpaceBetween</span>)</span><br><span class="line">    .<span class="title function_">height</span>(<span class="number">56</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="build-函数-1"><a href="#build-函数-1" class="headerlink" title="build()函数"></a>build()函数</h2><p>所有声明在build()函数的语句，我们统称为UI描述，UI描述需要遵循以下规则：</p>
<ul>
<li>@Entry装饰的自定义组件，其build()函数下的<strong>根节点唯一且必要</strong>，且必须为<strong>容器组件</strong>，其中ForEach禁止作为根节点。<br>  @Component装饰的自定义组件，其build()函数下的<strong>根节点唯一且必要</strong>，可以为<strong>非</strong>容器组件，其中ForEach禁止作为根节点。<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">MyComponent</span> &#123;</span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 根节点唯一且必要，必须为容器组件</span></span><br><span class="line">    <span class="title class_">Row</span>() &#123;</span><br><span class="line">      <span class="title class_">ChildComponent</span>() </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">ChildComponent</span> &#123;</span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 根节点唯一且必要，可为非容器组件</span></span><br><span class="line">    <span class="title class_">Image</span>(<span class="string">&#x27;test.jpg&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>不允许声明本地变量，反例如下。<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 反例：不允许声明本地变量</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">a</span>: <span class="built_in">number</span> = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>不允许在UI描述里直接使用console.info，但允许在方法或者函数里使用，反例如下。<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 反例：不允许console.info</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&#x27;print debug log&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>不允许创建本地的作用域，反例如下。<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 反例：不允许本地作用域</span></span><br><span class="line">  &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>不允许调用没有用<code>@Builder</code>装饰的方法，允许系统组件的参数是TS方法的<strong>返回值</strong>。<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">ParentComponent</span> &#123;</span><br><span class="line">  <span class="title function_">doSomeCalculations</span>(<span class="params"></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">calcTextValue</span>(): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello World&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Builder</span> <span class="title function_">doSomeRender</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Text</span>(<span class="string">`Hello World`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="comment">// 反例：不能调用没有用@Builder装饰的方法</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">doSomeCalculations</span>();</span><br><span class="line">      <span class="comment">// 正例：可以调用</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">doSomeRender</span>();</span><br><span class="line">      <span class="comment">// 正例：参数可以为调用TS方法的返回值</span></span><br><span class="line">      <span class="title class_">Text</span>(<span class="variable language_">this</span>.<span class="title function_">calcTextValue</span>())</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure></li>
<li>不允许使用switch语法，如果需要使用条件判断，请使用if。示例如下。<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title class_">Column</span>() &#123;</span><br><span class="line">    <span class="comment">// 反例：不允许使用switch语法</span></span><br><span class="line">    <span class="keyword">switch</span> (expression) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="title class_">Text</span>(<span class="string">&#x27;...&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="title class_">Image</span>(<span class="string">&#x27;...&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="title class_">Text</span>(<span class="string">&#x27;...&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 正例：使用if</span></span><br><span class="line">    <span class="keyword">if</span>(expression == <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;...&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(expression == <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="title class_">Image</span>(<span class="string">&#x27;...&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;...&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>不允许使用表达式，反例如下。<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title class_">Column</span>() &#123;</span><br><span class="line">    <span class="comment">// 反例：不允许使用表达式</span></span><br><span class="line">    (<span class="variable language_">this</span>.<span class="property">aVar</span> &gt; <span class="number">10</span>) ? <span class="title class_">Text</span>(<span class="string">&#x27;...&#x27;</span>) : <span class="title class_">Image</span>(<span class="string">&#x27;...&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">``</span><span class="string">`    </span></span><br><span class="line"><span class="string">- **不允许直接改变状态变量**，反例如下。</span></span><br><span class="line"><span class="string">	`</span><span class="string">``</span>typescript</span><br><span class="line">	<span class="meta">@Component</span></span><br><span class="line">	struct <span class="title class_">CompA</span> &#123;</span><br><span class="line">	  <span class="meta">@State</span> <span class="attr">col1</span>: <span class="title class_">Color</span> = <span class="title class_">Color</span>.<span class="property">Yellow</span>;</span><br><span class="line">	  <span class="meta">@State</span> <span class="attr">col2</span>: <span class="title class_">Color</span> = <span class="title class_">Color</span>.<span class="property">Green</span>;</span><br><span class="line">	  <span class="meta">@State</span> <span class="attr">count</span>: <span class="built_in">number</span> = <span class="number">1</span>;</span><br><span class="line">	  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">	    <span class="title class_">Column</span>() &#123;</span><br><span class="line">	      <span class="comment">// 应避免直接在Text组件内改变count的值</span></span><br><span class="line">	      <span class="title class_">Text</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.count++&#125;</span>`</span>)</span><br><span class="line">	        .<span class="title function_">width</span>(<span class="number">50</span>)</span><br><span class="line">	        .<span class="title function_">height</span>(<span class="number">50</span>)</span><br><span class="line">	        .<span class="title function_">fontColor</span>(<span class="variable language_">this</span>.<span class="property">col1</span>)</span><br><span class="line">	        .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">	          <span class="variable language_">this</span>.<span class="property">col2</span> = <span class="title class_">Color</span>.<span class="property">Red</span>;</span><br><span class="line">	        &#125;)</span><br><span class="line">	      <span class="title class_">Button</span>(<span class="string">&quot;change col1&quot;</span>).<span class="title function_">onClick</span>(<span class="function">() =&gt;</span>&#123;</span><br><span class="line">	        <span class="variable language_">this</span>.<span class="property">col1</span> = <span class="title class_">Color</span>.<span class="property">Pink</span>;</span><br><span class="line">	      &#125;)</span><br><span class="line">	    &#125;</span><br><span class="line">	    .<span class="title function_">backgroundColor</span>(<span class="variable language_">this</span>.<span class="property">col2</span>)</span><br><span class="line">	  &#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
  在ArkUI状态管理中，状态驱动UI更新。<br>  <img src="/posts/c66435f3/%E7%8A%B6%E6%80%81%E9%A9%B1%E5%8A%A8UI%E6%9B%B4%E6%96%B0%E5%85%AC%E5%BC%8F.png" alt="状态驱动UI更新公式"><br>  所以，不能在自定义组件的<code>build()</code>或<code>@Builder</code>方法里直接改变状态变量，这可能会造成<strong>循环渲染</strong>的风险。<code>Text(&#39;$&#123;this.count++&#125;&#39;)</code>在全量更新或最小化更新会产生不同的影响：<ul>
<li>全量更新： ArkUI可能会陷入一个无限的重渲染的循环里，因为Text组件的每一次渲染都会改变应用的状态，就会再引起下一轮渲染的开启。 当 <code>this.col2</code> 更改时，都会执行整个build构建函数，因此，<code>Text($&#123;this.count++&#125;)</code>绑定的文本也会更改，每次重新渲染<code>Text($&#123;this.count++&#125;)</code>，又会使<code>this.count</code>状态变量更新，导致新一轮的<code>build</code>执行，从而陷入无限循环。</li>
<li>最小化更新： 当 <code>this.col2</code> 更改时，只有Column组件会更新，Text组件不会更改。 只当 <code>this.col1</code> 更改时，会去更新整个Text组件，其所有属性函数都会执行，所以会看到<code>Text($&#123;this.count++&#125;)</code>自增。因为目前UI<strong>以组件为单位进行更新</strong>，如果组件上某一个属性发生改变，会更新整体的组件。所以整体的更新链路是：<code>this.col1 = Color.Pink</code> -&gt; Text组件整体更新-&gt;<code>this.count++</code> -&gt;Text组件整体更新。值得注意的是，这种写法在初次渲染时会导致Text组件渲染两次，从而对性能产生影响。<br>  build函数中更改应用状态的行为可能会比上面的示例更加&#x3D;&#x3D;隐蔽&#x3D;&#x3D;，比如：</li>
<li>在<code>@Builder</code>，<code>@Extend</code>或<code>@Styles</code>方法内改变状态变量 。</li>
<li>在计算参数时调用函数中改变应用状态变量，例如 <code>Text(&#39;$&#123;this.calcLabel()&#125;&#39;)</code>。</li>
<li>对当前数组做出修改，<code>sort()</code>改变了数组<code>this.arr</code>，随后的<code>filter</code>方法会返回一个新的数组。  <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 反例</span></span><br><span class="line"><span class="meta">@State</span> arr : <span class="title class_">Array</span>&lt;...&gt; = [ ... ];</span><br><span class="line"><span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="property">arr</span>.<span class="title function_">sort</span>().<span class="title function_">filter</span>(...), </span><br><span class="line">  <span class="function"><span class="params">item</span> =&gt;</span> &#123; </span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 正确的执行方式为：filter返回一个新数组，后面的sort方法才不会改变原数组this.arr</span></span><br><span class="line"><span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="property">arr</span>.<span class="title function_">filter</span>(...).<span class="title function_">sort</span>(), </span><br><span class="line">  <span class="function"><span class="params">item</span> =&gt;</span> &#123; </span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="自定义组件通用样式"><a href="#自定义组件通用样式" class="headerlink" title="自定义组件通用样式"></a>自定义组件通用样式</h2><p>自定义组件通过“<code>.</code>”链式调用的形式设置通用样式。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">MyComponent2</span> &#123;</span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Button</span>(<span class="string">`Hello World`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">MyComponent</span> &#123;</span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Row</span>() &#123;</span><br><span class="line">      <span class="title class_">MyComponent2</span>()</span><br><span class="line">        .<span class="title function_">width</span>(<span class="number">200</span>)</span><br><span class="line">        .<span class="title function_">height</span>(<span class="number">300</span>)</span><br><span class="line">        .<span class="title function_">backgroundColor</span>(<span class="title class_">Color</span>.<span class="property">Red</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>[!说明]<br>ArkUI给自定义组件设置样式时，相当于给MyComponent2<strong>套了一个不可见的容器组件</strong>，而这些样式是设置在容器组件上的，而非直接设置给MyComponent2的Button组件。通过渲染结果我们可以很清楚的看到，背景颜色红色并没有直接生效在Button上，而是生效在Button所处的开发者不可见的容器组件上。</p>
</blockquote>
<h1 id="页面和自定义组件生命周期"><a href="#页面和自定义组件生命周期" class="headerlink" title="页面和自定义组件生命周期"></a>页面和自定义组件生命周期</h1><p><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/training/course/slightMooc/C101717496870909384">页面和自定义组件生命周期</a><br>在开始之前，我们先明确自定义组件和页面的关系：</p>
<ul>
<li>自定义组件：<code>@Component</code>装饰的UI单元，可以组合多个系统组件实现UI的复用，可以调用组件的生命周期。</li>
<li>页面：即应用的UI页面。可以由一个或者多个自定义组件组成，<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-create-custom-components-V5#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84">@Entry</a>装饰的自定义组件为页面的入口组件，即页面的根节点，<strong>一个页面有且仅能有一个@Entry</strong>。只有<strong>被@Entry装饰的组件才可以调用页面的生命周期</strong>。</li>
</ul>
<p>页面生命周期，即被<code>@Entry</code>装饰的组件生命周期，提供以下生命周期接口：  </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-custom-component-lifecycle-V5#onpageshow">onPageShow</a>：页面<strong>每次显示</strong>时触发一次，包括路由过程、应用进入前台等场景，仅@Entry装饰的自定义组件生效。    </li>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-custom-component-lifecycle-V5#onpagehide">onPageHide</a>：页面<strong>每次隐藏</strong>时触发一次，包括路由过程、应用进入后台等场景，仅@Entry装饰的自定义组件生效。    </li>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-custom-component-lifecycle-V5#onbackpress">onBackPress</a>：当用户点击返回按钮时触发，仅@Entry装饰的自定义组件生效。返回true表示页面自己处理返回逻辑，不进行页面路由；返回false表示使用默认的路由返回逻辑，不设置返回值按照false处理。</li>
</ul>
<p>组件生命周期，即一般用<code>@Component</code>装饰的自定义组件的生命周期，提供以下生命周期接口：  </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-custom-component-lifecycle-V5#abouttoappear">aboutToAppear</a>：组件&#x3D;&#x3D;即将出现&#x3D;&#x3D;时回调该接口，具体时机为在创建自定义组件的新实例后，在执行其<code>build()</code>函数之前执行。允许在<code>aboutToAppear</code>函数中改变状态变量，更改将在后续执行<code>build()</code>函数中生效。实现自定义布局的自定义组件的<code>aboutToAppear</code>生命周期在布局过程中触发。 </li>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-custom-component-lifecycle-V5#ondidbuild12">onDidBuild</a>：组件<code>build()</code>函数执行&#x3D;&#x3D;完成之后&#x3D;&#x3D;回调该接口，<strong>不建议在onDidBuild函数中更改状态变量、使用animateTo等功能</strong>，这可能会导致不稳定的UI表现。    </li>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-custom-component-lifecycle-V5#abouttodisappear">aboutToDisappear</a>：<code>aboutToDisappear</code>函数在自定义组件析构&#x3D;&#x3D;销毁&#x3D;&#x3D;之前执行。不允许在<code>aboutToDisappear</code>函数中改变状态变量，特别是<code>@Link</code>变量的修改可能会导致应用程序行为不稳定。</li>
</ul>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-custom-component-lifecycle-V5#abouttoreuse10">aboutToReuse10+</a>：当一个<strong>可复用的自定义组件</strong>从复用缓存中重新加入到节点树时，触发<code>aboutToReuse</code>生命周期回调，并将组件的构造参数传递给<code>aboutToReuse</code>。</li>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-custom-component-lifecycle-V5#abouttorecycle10">aboutToRecycle10+</a>：组件的生命周期回调，在可复用组件从组件树上被加入到复用缓存之前调用。</li>
<li><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-custom-component-lifecycle-V5#onwillapplytheme12">onWillApplyTheme12+</a>：<code>onWillApplyTheme</code>函数用于获取当前组件上下文的Theme对象，在创建自定义组件的新实例后，在执行其build()函数之前执行。允许在onWillApplyTheme函数中改变状态变量，更改将在后续执行build()函数中生效。</li>
</ul>
<p>生命周期流程如下图所示，下图展示的是被<code>@Entry</code>装饰的组件（页面）生命周期。<br><img src="/posts/c66435f3/%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%B5%81%E7%A8%8B.png" alt="生命周期流程"><br>根据上面的流程图，我们从自定义组件的初始创建、重新渲染和删除来详细解释。  </p>
<h2 id="自定义组件的创建和渲染流程"><a href="#自定义组件的创建和渲染流程" class="headerlink" title="自定义组件的创建和渲染流程"></a>自定义组件的创建和渲染流程</h2><ol>
<li>自定义组件的创建：自定义组件的实例由ArkUI框架创建。  </li>
<li>初始化自定义组件的成员变量：通过本地默认值或者构造方法传递参数来初始化自定义组件的成员变量，初始化顺序为成员变量的定义顺序。    </li>
<li>如果开发者定义了<code>aboutToAppear</code>，则执行<code>aboutToAppear</code>方法。    </li>
<li>在首次渲染的时候，执行build方法渲染系统组件，如果子组件为自定义组件，则创建自定义组件的实例。在首次渲染的过程中，框架会记录状态变量和组件的映射关系，当状态变量改变时，驱动其相关的组件刷新。    </li>
<li>如果开发者定义了<code>onDidBuild</code>，则执行<code>onDidBuild</code>方法。</li>
</ol>
<h2 id="自定义组件重新渲染"><a href="#自定义组件重新渲染" class="headerlink" title="自定义组件重新渲染"></a>自定义组件重新渲染</h2><p>当事件句柄被触发（比如设置了点击事件，即触发点击事件）改变了状态变量时，或者<code>LocalStorage / AppStorage</code>中的属性更改，并导致绑定的状态变量更改其值时：  </p>
<ol>
<li>框架观察到了变化，将启动重新渲染。      </li>
<li>根据框架持有的两个map（<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B">自定义组件的创建和渲染流程</a>中第4步），框架可以知道该状态变量管理了哪些UI组件，以及这些UI组件对应的更新函数。执行这些UI组件的更新函数，实现最小化更新。</li>
</ol>
<h2 id="自定义组件的删除"><a href="#自定义组件的删除" class="headerlink" title="自定义组件的删除"></a>自定义组件的删除</h2><p>如果<code>if</code>组件的分支改变，或者<code>ForEach</code>循环渲染中数组的个数改变，组件将被删除：</p>
<ol>
<li>在删除组件之前，将调用其<code>aboutToDisappear</code>生命周期函数，标记着该节点将要被销毁。ArkUI的节点删除机制是：&#x3D;&#x3D;后端节点直接从组件树上摘下，后端节点被销毁，对前端节点解引用，前端节点已经没有引用时，将被JS虚拟机垃圾回收&#x3D;&#x3D;。    </li>
<li>自定义组件和它的变量将被删除，如果其有同步的变量，比如<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-link-V5">@Link</a>、<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-prop-V5">@Prop</a>、<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-appstorage-V5#storagelink">@StorageLink</a>，将从<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-state-management-overview-V5#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5">同步源</a>上取消注册。</li>
</ol>
<p>不建议在生命周期<code>aboutToDisappear</code>内使用<code>async await</code>，如果在生命周期的<code>aboutToDisappear</code>使用异步操作（<code>Promise</code>或者回调方法），自定义组件将被保留在<code>Promise</code>的闭包中，直到回调方法被执行完，这个行为阻止了自定义组件的垃圾回收。<br>以下示例展示了生命周期的调用时机：  </p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Index.ets</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;@ohos.router&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">MyComponent</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">showChild</span>: <span class="built_in">boolean</span> = <span class="literal">true</span>;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">btnColor</span>:<span class="built_in">string</span> = <span class="string">&quot;#FF007DFF&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 只有被@Entry装饰的组件才可以调用页面的生命周期</span></span><br><span class="line">  <span class="title function_">onPageShow</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&#x27;Index onPageShow&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 只有被@Entry装饰的组件才可以调用页面的生命周期</span></span><br><span class="line">  <span class="title function_">onPageHide</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&#x27;Index onPageHide&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 只有被@Entry装饰的组件才可以调用页面的生命周期</span></span><br><span class="line">  <span class="title function_">onBackPress</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&#x27;Index onBackPress&#x27;</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">btnColor</span> =<span class="string">&quot;#FFEE0606&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span> <span class="comment">// 返回true表示页面自己处理返回逻辑，不进行页面路由；返回false表示使用默认的路由返回逻辑，不设置返回值按照false处理</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 组件生命周期</span></span><br><span class="line">  <span class="title function_">aboutToAppear</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&#x27;MyComponent aboutToAppear&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 组件生命周期</span></span><br><span class="line">  <span class="title function_">onDidBuild</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&#x27;MyComponent onDidBuild&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 组件生命周期</span></span><br><span class="line">  <span class="title function_">aboutToDisappear</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&#x27;MyComponent aboutToDisappear&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="comment">// this.showChild为true，创建Child子组件，执行Child aboutToAppear</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">showChild</span>) &#123;</span><br><span class="line">        <span class="title class_">Child</span>()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// this.showChild为false，删除Child子组件，执行Child aboutToDisappear</span></span><br><span class="line">      <span class="title class_">Button</span>(<span class="string">&#x27;delete Child&#x27;</span>)</span><br><span class="line">      .<span class="title function_">margin</span>(<span class="number">20</span>)</span><br><span class="line">      .<span class="title function_">backgroundColor</span>(<span class="variable language_">this</span>.<span class="property">btnColor</span>)</span><br><span class="line">      .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">showChild</span> = <span class="literal">false</span>;</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="comment">// push到page页面，执行onPageHide</span></span><br><span class="line">      <span class="title class_">Button</span>(<span class="string">&#x27;push to next page&#x27;</span>)</span><br><span class="line">        .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          router.<span class="title function_">pushUrl</span>(&#123; <span class="attr">url</span>: <span class="string">&#x27;pages/page&#x27;</span> &#125;);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Child</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">title</span>: <span class="built_in">string</span> = <span class="string">&#x27;Hello World&#x27;</span>;</span><br><span class="line">  <span class="comment">// 组件生命周期</span></span><br><span class="line">  <span class="title function_">aboutToDisappear</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&#x27;[lifeCycle] Child aboutToDisappear&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 组件生命周期</span></span><br><span class="line">  <span class="title function_">onDidBuild</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&#x27;[lifeCycle] Child onDidBuild&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 组件生命周期</span></span><br><span class="line">  <span class="title function_">aboutToAppear</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&#x27;[lifeCycle] Child aboutToAppear&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Text</span>(<span class="variable language_">this</span>.<span class="property">title</span>).<span class="title function_">fontSize</span>(<span class="number">50</span>).<span class="title function_">margin</span>(<span class="number">20</span>).<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">title</span> = <span class="string">&#x27;Hello ArkUI&#x27;</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// page.ets</span></span><br><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct page &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">textColor</span>: <span class="title class_">Color</span> = <span class="title class_">Color</span>.<span class="property">Black</span>;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">num</span>: <span class="built_in">number</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">onPageShow</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">num</span> = <span class="number">5</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onPageHide</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;page onPageHide&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onBackPress</span>(<span class="params"></span>) &#123; <span class="comment">// 不设置返回值按照false处理</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">textColor</span> = <span class="title class_">Color</span>.<span class="property">Grey</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">num</span> = <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">aboutToAppear</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">textColor</span> = <span class="title class_">Color</span>.<span class="property">Blue</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">`num 的值为：<span class="subst">$&#123;<span class="variable language_">this</span>.num&#125;</span>`</span>)</span><br><span class="line">        .<span class="title function_">fontSize</span>(<span class="number">30</span>)</span><br><span class="line">        .<span class="title function_">fontWeight</span>(<span class="title class_">FontWeight</span>.<span class="property">Bold</span>)</span><br><span class="line">        .<span class="title function_">fontColor</span>(<span class="variable language_">this</span>.<span class="property">textColor</span>)</span><br><span class="line">        .<span class="title function_">margin</span>(<span class="number">20</span>)</span><br><span class="line">        .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">num</span> += <span class="number">5</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上示例中，Index页面包含两个自定义组件，一个是被@Entry装饰的MyComponent，也是页面的入口组件，即页面的根节点；一个是Child，是MyComponent的子组件。只有@Entry装饰的节点才可以使页面级别的生命周期方法生效，因此在MyComponent中声明当前Index<strong>页面的</strong>页面生命周期函数（<code>onPageShow / onPageHide / onBackPress</code>）。MyComponent和其子组件Child分别声明了<strong>各自的组件级别</strong>生命周期函数（<code>aboutToAppear / onDidBuild/aboutToDisappear</code>）。  </p>
<ul>
<li>应用冷启动的初始化流程为：<code>MyComponent aboutToAppear --&gt; MyComponent build --&gt; MyComponent onDidBuild--&gt; Child aboutToAppear --&gt; Child build --&gt; Child onDidBuild --&gt; Index onPageShow</code>。 </li>
<li>点击“delete Child”，if绑定的this.showChild变成false，删除Child组件，会执行<code>Child aboutToDisappear</code>方法。   </li>
<li>点击“push to next page”，调用<code>router.pushUrl</code>接口，跳转到另外一个页面，当前Index<strong>页面隐藏</strong>，执行页面生命周期Index onPageHide。此处调用的是<code>router.pushUrl</code>接口，Index页面被隐藏，并没有销毁，所以只调用onPageHide。跳转到新页面后，执行初始化新页面的生命周期的流程。    </li>
<li>如果调用的是<code>router.replaceUrl</code>，则当前Index<strong>页面被销毁</strong>，执行的生命周期流程将变为：<code>Index onPageHide --&gt; MyComponent aboutToDisappear --&gt; Child aboutToDisappear</code>。上文已经提到，组件的销毁是从组件树上直接摘下子树，所以先调用父组件的<code>aboutToDisappear</code>，再调用子组件的<code>aboutToDisappear</code>，然后执行初始化新页面的生命周期流程。    </li>
<li>点击返回按钮，触发页面生命周期<code>Index onBackPress</code>，且触发返回一个页面后会导致当前Index<strong>页面被销毁</strong>。    </li>
<li>最小化应用或者应用进入后台，触发<code>Index onPageHide</code>。当前Index页面没有被销毁，所以并不会执行组件的<code>aboutToDisappear</code>。应用回到前台，执行<code>Index onPageShow</code>。    </li>
<li>退出应用，执行<code>Index onPageHide --&gt; MyComponent aboutToDisappear --&gt; Child aboutToDisappear</code>。</li>
</ul>
<h2 id="自定义组件监听页面生命周期"><a href="#自定义组件监听页面生命周期" class="headerlink" title="自定义组件监听页面生命周期"></a>自定义组件监听页面生命周期</h2><p>使用<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-arkui-observer-V5#observeronrouterpageupdate11">无感监听页面路由</a>的能力，能够实现在自定义组件中监听页面的生命周期。  </p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Index.ets</span></span><br><span class="line"><span class="keyword">import</span> observer <span class="keyword">from</span> <span class="string">&#x27;@ohos.arkui.observer&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;@ohos.router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UIObserver</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@ohos.arkui.UIContext&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="attr">listener</span>: <span class="function">(<span class="params">info: observer.RouterPageInfo</span>) =&gt;</span> <span class="built_in">void</span> = <span class="function">(<span class="params">info: observer.RouterPageInfo</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">routerInfo</span>: observer.<span class="property">RouterPageInfo</span> | <span class="literal">undefined</span> = <span class="variable language_">this</span>.<span class="title function_">queryRouterPageInfo</span>();</span><br><span class="line">    <span class="keyword">if</span> (info.<span class="property">pageId</span> == routerInfo?.<span class="property">pageId</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (info.<span class="property">state</span> == observer.<span class="property">RouterPageState</span>.<span class="property">ON_PAGE_SHOW</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Index onPageShow`</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (info.<span class="property">state</span> == observer.<span class="property">RouterPageState</span>.<span class="property">ON_PAGE_HIDE</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Index onPageHide`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">aboutToAppear</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">uiObserver</span>: <span class="title class_">UIObserver</span> = <span class="variable language_">this</span>.<span class="title function_">getUIContext</span>().<span class="title function_">getUIObserver</span>();</span><br><span class="line">    uiObserver.<span class="title function_">on</span>(<span class="string">&#x27;routerPageUpdate&#x27;</span>, <span class="variable language_">this</span>.<span class="property">listener</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">aboutToDisappear</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">uiObserver</span>: <span class="title class_">UIObserver</span> = <span class="variable language_">this</span>.<span class="title function_">getUIContext</span>().<span class="title function_">getUIObserver</span>();</span><br><span class="line">    uiObserver.<span class="title function_">off</span>(<span class="string">&#x27;routerPageUpdate&#x27;</span>, <span class="variable language_">this</span>.<span class="property">listener</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">`this page is <span class="subst">$&#123;<span class="variable language_">this</span>.queryRouterPageInfo()?.pageId&#125;</span>`</span>)</span><br><span class="line">        .<span class="title function_">fontSize</span>(<span class="number">25</span>)</span><br><span class="line">      <span class="title class_">Button</span>(<span class="string">&quot;push self&quot;</span>)</span><br><span class="line">        .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          router.<span class="title function_">pushUrl</span>(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;pages/Index&#x27;</span></span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      <span class="title class_">Column</span>() &#123;</span><br><span class="line">        <span class="title class_">SubComponent</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">SubComponent</span> &#123;</span><br><span class="line">  <span class="attr">listener</span>: <span class="function">(<span class="params">info: observer.RouterPageInfo</span>) =&gt;</span> <span class="built_in">void</span> = <span class="function">(<span class="params">info: observer.RouterPageInfo</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">routerInfo</span>: observer.<span class="property">RouterPageInfo</span> | <span class="literal">undefined</span> = <span class="variable language_">this</span>.<span class="title function_">queryRouterPageInfo</span>();</span><br><span class="line">    <span class="keyword">if</span> (info.<span class="property">pageId</span> == routerInfo?.<span class="property">pageId</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (info.<span class="property">state</span> == observer.<span class="property">RouterPageState</span>.<span class="property">ON_PAGE_SHOW</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`SubComponent onPageShow`</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (info.<span class="property">state</span> == observer.<span class="property">RouterPageState</span>.<span class="property">ON_PAGE_HIDE</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`SubComponent onPageHide`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">aboutToAppear</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">uiObserver</span>: <span class="title class_">UIObserver</span> = <span class="variable language_">this</span>.<span class="title function_">getUIContext</span>().<span class="title function_">getUIObserver</span>();</span><br><span class="line">    uiObserver.<span class="title function_">on</span>(<span class="string">&#x27;routerPageUpdate&#x27;</span>, <span class="variable language_">this</span>.<span class="property">listener</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">aboutToDisappear</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">uiObserver</span>: <span class="title class_">UIObserver</span> = <span class="variable language_">this</span>.<span class="title function_">getUIContext</span>().<span class="title function_">getUIObserver</span>();</span><br><span class="line">    uiObserver.<span class="title function_">off</span>(<span class="string">&#x27;routerPageUpdate&#x27;</span>, <span class="variable language_">this</span>.<span class="property">listener</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">`SubComponent`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h1 id="if-x2F-else条件渲染"><a href="#if-x2F-else条件渲染" class="headerlink" title="if&#x2F;else条件渲染"></a><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/training/course/slightMooc/C101717496870909384">if&#x2F;else条件渲染</a></h1><p>ArkTS提供了渲染控制的能力。条件渲染可根据应用的不同状态，使用if、else和else if渲染对应状态下的UI内容。  </p>
<blockquote>
<p>[!说明]<br>从API version 9开始，该接口支持在ArkTS卡片中使用。</p>
</blockquote>
<h2 id="使用规则"><a href="#使用规则" class="headerlink" title="使用规则"></a>使用规则</h2><ul>
<li>支持if、else和else if语句。</li>
<li>if、else if后跟随的条件语句可以使用状态变量。</li>
<li>允许<strong>在容器组件内使用</strong>，通过条件渲染语句构建不同的子组件。</li>
<li>条件渲染语句在涉及到组件的父子关系时是“透明”的，当父组件和子组件之间存在一个或多个if语句时，必须遵守父组件关于子组件使用的规则。    </li>
<li>每个分支内部的构建函数必须遵循构建函数的规则，并创建一个或多个组件。无法创建组件的空构建函数会产生语法错误。    </li>
<li>某些容器组件限制子组件的类型或数量，将条件渲染语句用于这些组件内时，这些限制将同样应用于条件渲染语句内创建的组件。例如，Grid容器组件的子组件仅支持GridItem组件，在Grid内使用条件渲染语句时，条件渲染语句内仅允许使用GridItem组件。</li>
</ul>
<h2 id="更新机制"><a href="#更新机制" class="headerlink" title="更新机制"></a>更新机制</h2><p>当if、else if后跟随的状态判断中使用的状态变量值变化时，条件渲染语句会进行更新，更新步骤如下：</p>
<ol>
<li>评估if和else if的状态判断条件，如果分支没有变化，无需执行以下步骤。如果分支有变化，则执行2、3步骤：</li>
<li>&#x3D;&#x3D;删除此前构建的所有子组件&#x3D;&#x3D;。</li>
<li>执行新分支的构造函数，将获取到的组件添加到if父容器中。如果缺少适用的else分支，则不构建任何内容。<br>条件可以包括Typescript表达式。对于构造函数中的表达式，此类表达式不得更改应用程序状态。</li>
</ol>
<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><h3 id="使用if进行条件渲染"><a href="#使用if进行条件渲染" class="headerlink" title="使用if进行条件渲染"></a>使用if进行条件渲染</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">ViewA</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">count</span>: <span class="built_in">number</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">`count=<span class="subst">$&#123;<span class="variable language_">this</span>.count&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">count</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="title class_">Text</span>(<span class="string">`count is positive`</span>)</span><br><span class="line">          .<span class="title function_">fontColor</span>(<span class="title class_">Color</span>.<span class="property">Green</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="title class_">Button</span>(<span class="string">&#x27;increase count&#x27;</span>)</span><br><span class="line">        .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">count</span>++;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="title class_">Button</span>(<span class="string">&#x27;decrease count&#x27;</span>)</span><br><span class="line">        .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">count</span>--;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>if语句的每个分支都包含一个构建函数。此类构建函数必须创建一个或多个子组件。在初始渲染时，if语句会执行构建函数，并将生成的子组件添加到其父组件中。<br>每当if或else if条件语句中使用的状态变量发生变化时，条件语句都会更新并重新评估新的条件值。如果条件值评估发生了变化，这意味着需要构建另一个条件分支。此时ArkUI框架将：  </p>
<ol>
<li>删除所有以前渲染的（早期分支的）组件。    </li>
<li>执行新分支的构造函数，将生成的子组件添加到其父组件中。<br>在以上示例中，如果count从0增加到1，那么if语句更新，条件count &gt; 0将重新评估，评估结果将从false更改为true。因此，将执行条件为真分支的构造函数，创建一个Text组件，并将它添加到父组件Column中。如果后续count更改为0，则Text组件将从Column组件中删除。由于没有else分支，因此不会执行新的构造函数。</li>
</ol>
<h3 id="if-…-else-…语句和子组件状态"><a href="#if-…-else-…语句和子组件状态" class="headerlink" title="if … else …语句和子组件状态"></a>if … else …语句和子组件状态</h3><p>以下示例包含if … else …语句与拥有@State装饰变量的子组件。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">CounterView</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">counter</span>: <span class="built_in">number</span> = <span class="number">0</span>;</span><br><span class="line">  <span class="attr">label</span>: <span class="built_in">string</span> = <span class="string">&#x27;unknown&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Row</span>() &#123;</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.label&#125;</span>`</span>)</span><br><span class="line">      <span class="title class_">Button</span>(<span class="string">`counter <span class="subst">$&#123;<span class="variable language_">this</span>.counter&#125;</span> +1`</span>)</span><br><span class="line">        .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">counter</span> += <span class="number">1</span>;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">MainView</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">toggle</span>: <span class="built_in">boolean</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">toggle</span>) &#123;</span><br><span class="line">        <span class="title class_">CounterView</span>(&#123; <span class="attr">label</span>: <span class="string">&#x27;CounterView #positive&#x27;</span> &#125;)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title class_">CounterView</span>(&#123; <span class="attr">label</span>: <span class="string">&#x27;CounterView #negative&#x27;</span> &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title class_">Button</span>(<span class="string">`toggle <span class="subst">$&#123;<span class="variable language_">this</span>.toggle&#125;</span>`</span>)</span><br><span class="line">        .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">toggle</span> = !<span class="variable language_">this</span>.<span class="property">toggle</span>;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CounterView（label为 <code>&#39;CounterView #positive&#39;</code>）子组件在初次渲染时创建。此子组件携带名为counter的状态变量。当修改CounterView.counter状态变量时，CounterView（label为 <code>&#39;CounterView #positive&#39;</code>）子组件重新渲染并保留状态变量值。当MainView.toggle状态变量的值更改为false时，MainView父组件内的if语句将更新，随后将删除CounterView（label为 <code>&#39;CounterView #positive&#39;</code>）子组件。与此同时，将创建新的CounterView（label为 <code>&#39;CounterView #negative&#39;</code>）实例。而它自己的counter状态变量设置为初始值0。</p>
<blockquote>
<p>[!说明]<br>CounterView（label为 <code>&#39;CounterView #positive&#39;</code>）和CounterView（label为 <code>&#39;CounterView #negative&#39;</code>）是同一自定义组件的&#x3D;&#x3D;两个不同实例&#x3D;&#x3D;。if分支的更改，不会更新现有子组件，也不会保留状态。</p>
</blockquote>
<p>以下示例展示了条件更改时，若需要保留counter值所做的修改。  </p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">CounterView</span> &#123;</span><br><span class="line">  <span class="meta">@Link</span> <span class="attr">counter</span>: <span class="built_in">number</span>;</span><br><span class="line">  <span class="attr">label</span>: <span class="built_in">string</span> = <span class="string">&#x27;unknown&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Row</span>() &#123;</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.label&#125;</span>`</span>)</span><br><span class="line">      <span class="title class_">Button</span>(<span class="string">`counter <span class="subst">$&#123;<span class="variable language_">this</span>.counter&#125;</span> +1`</span>)</span><br><span class="line">        .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">counter</span> += <span class="number">1</span>;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">MainView</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">toggle</span>: <span class="built_in">boolean</span> = <span class="literal">true</span>;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">counter</span>: <span class="built_in">number</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">toggle</span>) &#123;</span><br><span class="line">        <span class="title class_">CounterView</span>(&#123; <span class="attr">counter</span>: $counter, <span class="attr">label</span>: <span class="string">&#x27;CounterView #positive&#x27;</span> &#125;)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title class_">CounterView</span>(&#123; <span class="attr">counter</span>: $counter, <span class="attr">label</span>: <span class="string">&#x27;CounterView #negative&#x27;</span> &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title class_">Button</span>(<span class="string">`toggle <span class="subst">$&#123;<span class="variable language_">this</span>.toggle&#125;</span>`</span>)</span><br><span class="line">        .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">toggle</span> = !<span class="variable language_">this</span>.<span class="property">toggle</span>;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此处，@State counter变量归父组件所有。因此，当CounterView组件实例被删除时，该变量不会被销毁。CounterView组件通过<code>@Link</code>装饰器引用状态。状态必须从子级移动到其父级（或父级的父级），以避免在条件内容或重复内容被销毁时丢失状态。</p>
<h3 id="嵌套if语句"><a href="#嵌套if语句" class="headerlink" title="嵌套if语句"></a>嵌套if语句</h3><p>条件语句的嵌套对父组件的相关规则没有影响。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">CompA</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">toggle</span>: <span class="built_in">boolean</span> = <span class="literal">false</span>;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">toggleColor</span>: <span class="built_in">boolean</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;Before&#x27;</span>)</span><br><span class="line">        .<span class="title function_">fontSize</span>(<span class="number">15</span>)</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">toggle</span>) &#123;</span><br><span class="line">        <span class="title class_">Text</span>(<span class="string">&#x27;Top True, positive 1 top&#x27;</span>)</span><br><span class="line">          .<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#aaffaa&#x27;</span>).<span class="title function_">fontSize</span>(<span class="number">20</span>)</span><br><span class="line">        <span class="comment">// 内部if语句</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">toggleColor</span>) &#123;</span><br><span class="line">          <span class="title class_">Text</span>(<span class="string">&#x27;Top True, Nested True, positive COLOR  Nested &#x27;</span>)</span><br><span class="line">            .<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#00aaaa&#x27;</span>).<span class="title function_">fontSize</span>(<span class="number">15</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="title class_">Text</span>(<span class="string">&#x27;Top True, Nested False, Negative COLOR  Nested &#x27;</span>)</span><br><span class="line">            .<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#aaaaff&#x27;</span>).<span class="title function_">fontSize</span>(<span class="number">15</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title class_">Text</span>(<span class="string">&#x27;Top false, negative top level&#x27;</span>).<span class="title function_">fontSize</span>(<span class="number">20</span>)</span><br><span class="line">          .<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#ffaaaa&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">toggleColor</span>) &#123;</span><br><span class="line">          <span class="title class_">Text</span>(<span class="string">&#x27;positive COLOR  Nested &#x27;</span>)</span><br><span class="line">            .<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#00aaaa&#x27;</span>).<span class="title function_">fontSize</span>(<span class="number">15</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="title class_">Text</span>(<span class="string">&#x27;Negative COLOR  Nested &#x27;</span>)</span><br><span class="line">            .<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#aaaaff&#x27;</span>).<span class="title function_">fontSize</span>(<span class="number">15</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;After&#x27;</span>)</span><br><span class="line">        .<span class="title function_">fontSize</span>(<span class="number">15</span>)</span><br><span class="line">      <span class="title class_">Button</span>(<span class="string">&#x27;Toggle Outer&#x27;</span>)</span><br><span class="line">        .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">toggle</span> = !<span class="variable language_">this</span>.<span class="property">toggle</span>;</span><br><span class="line">        &#125;)</span><br><span class="line">      <span class="title class_">Button</span>(<span class="string">&#x27;Toggle Inner&#x27;</span>)</span><br><span class="line">        .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">toggleColor</span> = !<span class="variable language_">this</span>.<span class="property">toggleColor</span>;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<h1 id="循环渲染"><a href="#循环渲染" class="headerlink" title="循环渲染"></a><a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/training/course/slightMooc/C101717496870909384">循环渲染</a></h1><p>ForEach接口基于<strong>数组类型</strong>数据来进行循环渲染，需要与容器组件配合使用，且接口返回的组件应当是允许包含在ForEach父容器组件中的子组件。例如，ListItem组件要求ForEach的父容器组件必须为<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-container-list-V5">List组件</a>。</p>
<blockquote>
<p>[!说明]<br>从API version 9开始，该接口支持在ArkTS卡片中使用。</p>
</blockquote>
<h2 id="接口描述"><a href="#接口描述" class="headerlink" title="接口描述"></a>接口描述</h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ForEach</span>(</span><br><span class="line">  <span class="attr">arr</span>: <span class="title class_">Array</span>,</span><br><span class="line">  <span class="attr">itemGenerator</span>: <span class="function">(<span class="params">item: <span class="built_in">Object</span>, index: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">void</span>,</span><br><span class="line">  keyGenerator?: <span class="function">(<span class="params">item: <span class="built_in">Object</span>, index: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">string</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>以下是参数的详细说明：</p>
<table>
<thead>
<tr>
<th align="left">参数名</th>
<th align="left">参数类型</th>
<th align="left">是否必填</th>
<th align="left">参数描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">arr</td>
<td align="left">Array<Object></Object></td>
<td align="left">是</td>
<td align="left">数据源，为Array类型的数组。<br><strong>说明：</strong><br>- 可以设置为空数组，此时不会创建子组件。<br>- 可以设置返回值为数组类型的函数，例如<code>arr.slice(1, 3</code>)，但设置的函数<strong>不应改变包括数组本身在内的任何状态变量</strong>，例如不应使用<code>Array.splice()</code>,<code>Array.sort()</code>或<code>Array.reverse()</code>这些会改变原数组的函数。</td>
</tr>
<tr>
<td align="left">itemGenerator</td>
<td align="left">(item: Object, index: number) &#x3D;&gt; void</td>
<td align="left">是</td>
<td align="left">组件生成函数。<br>- 为数组中的每个元素创建对应的组件。<br>- item参数：arr数组中的数据项。<br>- index参数（可选）：arr数组中的数据项索引。<br><strong>说明：</strong><br>- 组件的类型必须是ForEach的父容器所允许的。例如，ListItem组件要求ForEach的父容器组件必须为List组件。</td>
</tr>
<tr>
<td align="left">keyGenerator</td>
<td align="left">(item: Object, index: number) &#x3D;&gt; string</td>
<td align="left">否</td>
<td align="left">键值生成函数。<br>- 为数据源arr的每个数组项生成唯一且持久的键值。函数返回值为开发者自定义的键值生成规则。<br>- item参数：arr数组中的数据项。<br>- index参数（可选）：arr数组中的数据项索引。<br><strong>说明：</strong><br>- 如果函数缺省，框架默认的键值生成函数为<code>(item: T, index: number) =&gt; &#123; return index + &#39;__&#39; + JSON.stringify(item)</code>; }<br>- <strong>键值生成函数不应改变任何组件状态</strong>。</td>
</tr>
</tbody></table>
<blockquote>
<p>[!说明]  </p>
<ul>
<li>ForEach的itemGenerator函数可以包含if&#x2F;else条件渲染逻辑。另外，也可以在if&#x2F;else条件渲染语句中使用ForEach组件。</li>
<li>在初始化渲染时，ForEach会加载数据源的所有数据，并为每个数据项创建对应的组件，然后将其挂载到渲染树上。如果数据源非常大或有特定的性能需求，建议使用<code>LazyForEach</code>组件。</li>
</ul>
</blockquote>
<h2 id="键值生成规则"><a href="#键值生成规则" class="headerlink" title="键值生成规则"></a>键值生成规则</h2><p>在ForEach循环渲染过程中，系统会为每个数组元素生成一个唯一且持久的键值，用于标识对应的组件。当这个键值变化时，ArkUI框架将视为该数组元素已被替换或修改，并会基于新的键值创建一个新的组件。<br>ForEach提供了一个名为keyGenerator的参数，这是一个函数，开发者可以通过它自定义键值的生成规则。如果开发者没有定义keyGenerator函数，则ArkUI框架会使用默认的键值生成函数，即<code>(item: Object, index: number) =&gt; &#123; return index + &#39;__&#39; + JSON.stringify(item); &#125;</code>。</p>
<p>ArkUI框架对于ForEach的键值生成有一套特定的判断规则，这主要与itemGenerator函数的第二个参数index以及keyGenerator函数的第二个参数index有关，具体的键值生成规则判断逻辑如下图所示。</p>
<p><strong>图1</strong> ForEach键值生成规则<br><img src="/posts/c66435f3/ForEach%E9%94%AE%E5%80%BC%E7%94%9F%E6%88%90%E8%A7%84%E5%88%99.jpg" alt="ForEach键值生成规则">  </p>
<blockquote>
<p>[!说明]<br>ArkUI框架会对重复的键值发出警告。在UI更新的场景下，如果出现重复的键值，框架可能无法正常工作，具体请参见<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/#%E6%B8%B2%E6%9F%93%E7%BB%93%E6%9E%9C%E9%9D%9E%E9%A2%84%E6%9C%9F">渲染结果非预期</a>。</p>
</blockquote>
<h2 id="组件创建规则"><a href="#组件创建规则" class="headerlink" title="组件创建规则"></a>组件创建规则</h2><p>在确定键值生成规则后，ForEach的第二个参数itemGenerator函数会根据键值生成规则为数据源的每个数组项创建组件。组件的创建包括两种情况：<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/#%E9%A6%96%E6%AC%A1%E6%B8%B2%E6%9F%93">ForEach首次渲染</a>和<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/#%E9%9D%9E%E9%A6%96%E6%AC%A1%E6%B8%B2%E6%9F%93">ForEach非首次渲染</a>。</p>
<h3 id="首次渲染"><a href="#首次渲染" class="headerlink" title="首次渲染"></a>首次渲染</h3><p>在ForEach首次渲染时，会根据前述键值生成规则为数据源的每个数组项生成唯一键值，并创建相应的组件。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Parent</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">simpleList</span>: <span class="title class_">Array</span>&lt;<span class="built_in">string</span>&gt; = [<span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;two&#x27;</span>, <span class="string">&#x27;three&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Row</span>() &#123;</span><br><span class="line">      <span class="title class_">Column</span>() &#123;</span><br><span class="line">        <span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="property">simpleList</span>, <span class="function">(<span class="params">item: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title class_">ChildItem</span>(&#123; <span class="attr">item</span>: item &#125;)</span><br><span class="line">        &#125;, <span class="function">(<span class="params">item: <span class="built_in">string</span></span>) =&gt;</span> item)</span><br><span class="line">      &#125;</span><br><span class="line">      .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">      .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">backgroundColor</span>(<span class="number">0xF1F3F5</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">ChildItem</span> &#123;</span><br><span class="line">  <span class="meta">@Prop</span> <span class="attr">item</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Text</span>(<span class="variable language_">this</span>.<span class="property">item</span>)</span><br><span class="line">      .<span class="title function_">fontSize</span>(<span class="number">50</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行效果如下图所示。<br><strong>图2</strong> ForEach数据源不存在相同值案例首次渲染运行效果图<br><img src="/posts/c66435f3/ForEach%E6%95%B0%E6%8D%AE%E6%BA%90%E4%B8%8D%E5%AD%98%E5%9C%A8%E7%9B%B8%E5%90%8C%E5%80%BC%E6%A1%88%E4%BE%8B%E9%A6%96%E6%AC%A1%E6%B8%B2%E6%9F%93%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C%E5%9B%BE.png" alt="ForEach数据源不存在相同值案例首次渲染运行效果图"><br>在上述代码中，键值生成规则是keyGenerator函数的返回值item。在ForEach渲染循环时，为数据源数组项依次生成键值one、two和three，并创建对应的ChildItem组件渲染到界面上。<br>当不同数组项按照键值生成规则生成的键值相同时，框架的行为是未定义的。例如，在以下代码中，ForEach渲染相同的数据项two时，只创建了一个ChildItem组件，而没有创建多个具有相同键值的组件。  </p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Parent</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">simpleList</span>: <span class="title class_">Array</span>&lt;<span class="built_in">string</span>&gt; = [<span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;two&#x27;</span>, <span class="string">&#x27;two&#x27;</span>, <span class="string">&#x27;three&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Row</span>() &#123;</span><br><span class="line">      <span class="title class_">Column</span>() &#123;</span><br><span class="line">        <span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="property">simpleList</span>, <span class="function">(<span class="params">item: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title class_">ChildItem</span>(&#123; <span class="attr">item</span>: item &#125;)</span><br><span class="line">        &#125;, <span class="function">(<span class="params">item: <span class="built_in">string</span></span>) =&gt;</span> item)</span><br><span class="line">      &#125;</span><br><span class="line">      .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">      .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">backgroundColor</span>(<span class="number">0xF1F3F5</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">ChildItem</span> &#123;</span><br><span class="line">  <span class="meta">@Prop</span> <span class="attr">item</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Text</span>(<span class="variable language_">this</span>.<span class="property">item</span>)</span><br><span class="line">      .<span class="title function_">fontSize</span>(<span class="number">50</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行效果如下图所示。<br><strong>图3</strong> ForEach数据源存在相同值案例首次渲染运行效果图<br><img src="/posts/c66435f3/ForEach%E6%95%B0%E6%8D%AE%E6%BA%90%E4%B8%8D%E5%AD%98%E5%9C%A8%E7%9B%B8%E5%90%8C%E5%80%BC%E6%A1%88%E4%BE%8B%E9%A6%96%E6%AC%A1%E6%B8%B2%E6%9F%93%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C%E5%9B%BE.png" alt="ForEach数据源存在相同值案例首次渲染运行效果图"><br>在该示例中，最终键值生成规则为item。当ForEach遍历数据源simpleList，遍历到索引为1的two时，按照最终键值生成规则生成键值为two的组件并进行标记。当遍历到索引为2的two时，按照最终键值生成规则当前项的键值也为two，此时不再创建新的组件。  </p>
<h3 id="非首次渲染"><a href="#非首次渲染" class="headerlink" title="非首次渲染"></a>非首次渲染</h3><p>在ForEach组件进行非首次渲染时，它会检查新生成的键值是否在上次渲染中已经存在。如果键值不存在，则会创建一个新的组件；如果键值存在，则不会创建新的组件，而是直接渲染该键值所对应的组件。例如，在以下的代码示例中，通过点击事件修改了数组的第三项值为”new three”，这将触发ForEach组件进行非首次渲染。  </p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Parent</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">simpleList</span>: <span class="title class_">Array</span>&lt;<span class="built_in">string</span>&gt; = [<span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;two&#x27;</span>, <span class="string">&#x27;three&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Row</span>() &#123;</span><br><span class="line">      <span class="title class_">Column</span>() &#123;</span><br><span class="line">        <span class="title class_">Text</span>(<span class="string">&#x27;点击修改第3个数组项的值&#x27;</span>)</span><br><span class="line">          .<span class="title function_">fontSize</span>(<span class="number">24</span>)</span><br><span class="line">          .<span class="title function_">fontColor</span>(<span class="title class_">Color</span>.<span class="property">Red</span>)</span><br><span class="line">          .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">simpleList</span>[<span class="number">2</span>] = <span class="string">&#x27;new three&#x27;</span>;</span><br><span class="line">          &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="property">simpleList</span>, <span class="function">(<span class="params">item: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title class_">ChildItem</span>(&#123; <span class="attr">item</span>: item &#125;)</span><br><span class="line">            .<span class="title function_">margin</span>(&#123; <span class="attr">top</span>: <span class="number">20</span> &#125;)</span><br><span class="line">        &#125;, <span class="function">(<span class="params">item: <span class="built_in">string</span></span>) =&gt;</span> item)</span><br><span class="line">      &#125;</span><br><span class="line">      .<span class="title function_">justifyContent</span>(<span class="title class_">FlexAlign</span>.<span class="property">Center</span>)</span><br><span class="line">      .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">      .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">backgroundColor</span>(<span class="number">0xF1F3F5</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">ChildItem</span> &#123;</span><br><span class="line">  <span class="meta">@Prop</span> <span class="attr">item</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Text</span>(<span class="variable language_">this</span>.<span class="property">item</span>)</span><br><span class="line">      .<span class="title function_">fontSize</span>(<span class="number">30</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行效果如下图所示。<br><strong>图4</strong> ForEach非首次渲染案例运行效果图<br><img src="/posts/c66435f3/ForEach%E9%9D%9E%E9%A6%96%E6%AC%A1%E6%B8%B2%E6%9F%93%E6%A1%88%E4%BE%8B%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C%E5%9B%BE.gif" alt="ForEach非首次渲染案例运行效果图"><br>从本例可以看出@State 能够监听到简单数据类型数组数据源 simpleList 数组项的变化。  </p>
<ol>
<li>当 simpleList 数组项发生变化时，会触发 ForEach 进行重新渲染。</li>
<li>ForEach 遍历新的数据源 [‘one’, ‘two’, ‘new three’]，并生成对应的键值one、two和new three。</li>
<li>其中，键值one和two在上次渲染中已经存在，所以 ForEach 复用了对应的组件并进行了渲染。对于第三个数组项 “new three”，由于其通过键值生成规则 item 生成的键值new three在上次渲染中不存在，因此 ForEach 为该数组项创建了一个新的组件。</li>
</ol>
<h2 id="使用场景-1"><a href="#使用场景-1" class="headerlink" title="使用场景"></a>使用场景</h2><p>ForEach组件在开发过程中的主要应用场景包括：<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/#%E6%95%B0%E6%8D%AE%E6%BA%90%E4%B8%8D%E5%8F%98">数据源不变</a>、<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/#%E6%95%B0%E6%8D%AE%E6%BA%90%E6%95%B0%E7%BB%84%E9%A1%B9%E5%8F%91%E7%94%9F%E5%8F%98%E5%8C%96">数据源数组项发生变化</a>（如插入、删除操作）、<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/#%E6%95%B0%E6%8D%AE%E6%BA%90%E6%95%B0%E7%BB%84%E9%A1%B9%E5%AD%90%E5%B1%9E%E6%80%A7%E5%8F%98%E5%8C%96">数据源数组项子属性变化</a>。</p>
<h3 id="数据源不变"><a href="#数据源不变" class="headerlink" title="数据源不变"></a>数据源不变</h3><p>在数据源保持不变的场景中，数据源可以直接采用基本数据类型。例如，在页面加载状态时，可以使用骨架屏列表进行渲染展示。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">ArticleList</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">simpleList</span>: <span class="title class_">Array</span>&lt;<span class="built_in">number</span>&gt; = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="property">simpleList</span>, <span class="function">(<span class="params">item: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title class_">ArticleSkeletonView</span>()</span><br><span class="line">          .<span class="title function_">margin</span>(&#123; <span class="attr">top</span>: <span class="number">20</span> &#125;)</span><br><span class="line">      &#125;, <span class="function">(<span class="params">item: <span class="built_in">number</span></span>) =&gt;</span> item.<span class="title function_">toString</span>())</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">padding</span>(<span class="number">20</span>)</span><br><span class="line">    .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">textArea</span>(<span class="params">width: <span class="built_in">number</span> | Resource | <span class="built_in">string</span> = <span class="string">&#x27;100%&#x27;</span>, height: <span class="built_in">number</span> | Resource | <span class="built_in">string</span> = <span class="string">&#x27;100%&#x27;</span></span>) &#123;</span><br><span class="line">  <span class="title class_">Row</span>()</span><br><span class="line">    .<span class="title function_">width</span>(width)</span><br><span class="line">    .<span class="title function_">height</span>(height)</span><br><span class="line">    .<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#FFF2F3F4&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">ArticleSkeletonView</span> &#123;</span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Row</span>() &#123;</span><br><span class="line">      <span class="title class_">Column</span>() &#123;</span><br><span class="line">        <span class="title function_">textArea</span>(<span class="number">80</span>, <span class="number">80</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      .<span class="title function_">margin</span>(&#123; <span class="attr">right</span>: <span class="number">20</span> &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="title class_">Column</span>() &#123;</span><br><span class="line">        <span class="title function_">textArea</span>(<span class="string">&#x27;60%&#x27;</span>, <span class="number">20</span>)</span><br><span class="line">        <span class="title function_">textArea</span>(<span class="string">&#x27;50%&#x27;</span>, <span class="number">20</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      .<span class="title function_">alignItems</span>(<span class="title class_">HorizontalAlign</span>.<span class="property">Start</span>)</span><br><span class="line">      .<span class="title function_">justifyContent</span>(<span class="title class_">FlexAlign</span>.<span class="property">SpaceAround</span>)</span><br><span class="line">      .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">padding</span>(<span class="number">20</span>)</span><br><span class="line">    .<span class="title function_">borderRadius</span>(<span class="number">12</span>)</span><br><span class="line">    .<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#FFECECEC&#x27;</span>)</span><br><span class="line">    .<span class="title function_">height</span>(<span class="number">120</span>)</span><br><span class="line">    .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">justifyContent</span>(<span class="title class_">FlexAlign</span>.<span class="property">SpaceBetween</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行效果如下图所示。<br><strong>图5</strong> 骨架屏运行效果图<br><img src="/posts/c66435f3/%E9%AA%A8%E6%9E%B6%E5%B1%8F%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C%E5%9B%BE.png" alt="骨架屏运行效果图"><br>在本示例中，采用数据项item作为键值生成规则，由于数据源simpleList的数组项各不相同，因此能够保证键值的唯一性。</p>
<h3 id="数据源数组项发生变化"><a href="#数据源数组项发生变化" class="headerlink" title="数据源数组项发生变化"></a>数据源数组项发生变化</h3><p>在数据源数组项发生变化的场景下，例如进行数组插入、删除操作或者数组项索引位置发生交换时，数据源应为对象数组类型，并使用对象的唯一ID作为最终键值。例如，当在页面上通过手势上滑加载下一页数据时，会在数据源数组尾部新增新获取的数据项，从而使得数据源数组长度增大。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Article</span> &#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">title</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">brief</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">id: <span class="built_in">string</span>, title: <span class="built_in">string</span>, brief: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = id;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">title</span> = title;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">brief</span> = brief;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">ArticleListView</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">isListReachEnd</span>: <span class="built_in">boolean</span> = <span class="literal">false</span>;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">articleList</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Article</span>&gt; = [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Article</span>(<span class="string">&#x27;001&#x27;</span>, <span class="string">&#x27;第1篇文章&#x27;</span>, <span class="string">&#x27;文章简介内容&#x27;</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Article</span>(<span class="string">&#x27;002&#x27;</span>, <span class="string">&#x27;第2篇文章&#x27;</span>, <span class="string">&#x27;文章简介内容&#x27;</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Article</span>(<span class="string">&#x27;003&#x27;</span>, <span class="string">&#x27;第3篇文章&#x27;</span>, <span class="string">&#x27;文章简介内容&#x27;</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Article</span>(<span class="string">&#x27;004&#x27;</span>, <span class="string">&#x27;第4篇文章&#x27;</span>, <span class="string">&#x27;文章简介内容&#x27;</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Article</span>(<span class="string">&#x27;005&#x27;</span>, <span class="string">&#x27;第5篇文章&#x27;</span>, <span class="string">&#x27;文章简介内容&#x27;</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Article</span>(<span class="string">&#x27;006&#x27;</span>, <span class="string">&#x27;第6篇文章&#x27;</span>, <span class="string">&#x27;文章简介内容&#x27;</span>)</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  <span class="title function_">loadMoreArticles</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">articleList</span>.<span class="title function_">push</span>(<span class="keyword">new</span> <span class="title class_">Article</span>(<span class="string">&#x27;007&#x27;</span>, <span class="string">&#x27;加载的新文章&#x27;</span>, <span class="string">&#x27;文章简介内容&#x27;</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>(&#123; <span class="attr">space</span>: <span class="number">5</span> &#125;) &#123;</span><br><span class="line">      <span class="title class_">List</span>() &#123;</span><br><span class="line">        <span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="property">articleList</span>, <span class="function">(<span class="params">item: Article</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title class_">ListItem</span>() &#123;</span><br><span class="line">            <span class="title class_">ArticleCard</span>(&#123; <span class="attr">article</span>: item &#125;)</span><br><span class="line">              .<span class="title function_">margin</span>(&#123; <span class="attr">top</span>: <span class="number">20</span> &#125;)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, <span class="function">(<span class="params">item: Article</span>) =&gt;</span> item.<span class="property">id</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      .<span class="title function_">onReachEnd</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isListReachEnd</span> = <span class="literal">true</span>;</span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">parallelGesture</span>(</span><br><span class="line">        <span class="title class_">PanGesture</span>(&#123; <span class="attr">direction</span>: <span class="title class_">PanDirection</span>.<span class="property">Up</span>, <span class="attr">distance</span>: <span class="number">80</span> &#125;)</span><br><span class="line">          .<span class="title function_">onActionStart</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isListReachEnd</span>) &#123;</span><br><span class="line">              <span class="variable language_">this</span>.<span class="title function_">loadMoreArticles</span>();</span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">isListReachEnd</span> = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">      )</span><br><span class="line">      .<span class="title function_">padding</span>(<span class="number">20</span>)</span><br><span class="line">      .<span class="title function_">scrollBar</span>(<span class="title class_">BarState</span>.<span class="property">Off</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">backgroundColor</span>(<span class="number">0xF1F3F5</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">ArticleCard</span> &#123;</span><br><span class="line">  <span class="meta">@Prop</span> <span class="attr">article</span>: <span class="title class_">Article</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Row</span>() &#123;</span><br><span class="line">      <span class="title class_">Image</span>($r(<span class="string">&#x27;app.media.icon&#x27;</span>))</span><br><span class="line">        .<span class="title function_">width</span>(<span class="number">80</span>)</span><br><span class="line">        .<span class="title function_">height</span>(<span class="number">80</span>)</span><br><span class="line">        .<span class="title function_">margin</span>(&#123; <span class="attr">right</span>: <span class="number">20</span> &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="title class_">Column</span>() &#123;</span><br><span class="line">        <span class="title class_">Text</span>(<span class="variable language_">this</span>.<span class="property">article</span>.<span class="property">title</span>)</span><br><span class="line">          .<span class="title function_">fontSize</span>(<span class="number">20</span>)</span><br><span class="line">          .<span class="title function_">margin</span>(&#123; <span class="attr">bottom</span>: <span class="number">8</span> &#125;)</span><br><span class="line">        <span class="title class_">Text</span>(<span class="variable language_">this</span>.<span class="property">article</span>.<span class="property">brief</span>)</span><br><span class="line">          .<span class="title function_">fontSize</span>(<span class="number">16</span>)</span><br><span class="line">          .<span class="title function_">fontColor</span>(<span class="title class_">Color</span>.<span class="property">Gray</span>)</span><br><span class="line">          .<span class="title function_">margin</span>(&#123; <span class="attr">bottom</span>: <span class="number">8</span> &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      .<span class="title function_">alignItems</span>(<span class="title class_">HorizontalAlign</span>.<span class="property">Start</span>)</span><br><span class="line">      .<span class="title function_">width</span>(<span class="string">&#x27;80%&#x27;</span>)</span><br><span class="line">      .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">padding</span>(<span class="number">20</span>)</span><br><span class="line">    .<span class="title function_">borderRadius</span>(<span class="number">12</span>)</span><br><span class="line">    .<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#FFECECEC&#x27;</span>)</span><br><span class="line">    .<span class="title function_">height</span>(<span class="number">120</span>)</span><br><span class="line">    .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">justifyContent</span>(<span class="title class_">FlexAlign</span>.<span class="property">SpaceBetween</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>初始运行效果（左图）和手势上滑加载后效果（右图）如下图所示。<br><strong>图6</strong> 数据源数组项变化案例运行效果图<br><img src="/posts/c66435f3/%E6%95%B0%E6%8D%AE%E6%BA%90%E6%95%B0%E7%BB%84%E9%A1%B9%E5%8F%98%E5%8C%96%E6%A1%88%E4%BE%8B%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C%E5%9B%BE.png" alt="数据源数组项变化案例运行效果图"><br>在本示例中，ArticleCard组件作为ArticleListView组件的子组件，通过@Prop装饰器接收一个Article对象，用于渲染文章卡片。  </p>
<ol>
<li>当列表滚动到底部时，如果手势滑动距离超过指定的80，将触发loadMoreArticle()函数。此函数会在articleList数据源的尾部添加一个新的数据项，从而增加数据源的长度。</li>
<li>数据源被@State装饰器修饰，ArkUI框架能够感知到数据源长度的变化，并触发ForEach进行重新渲染。</li>
</ol>
<h3 id="数据源数组项子属性变化"><a href="#数据源数组项子属性变化" class="headerlink" title="数据源数组项子属性变化"></a>数据源数组项子属性变化</h3><p>当数据源的数组项为对象数据类型，并且只修改某个数组项的属性值时，由于数据源为复杂数据类型，ArkUI框架无法监听到@State装饰器修饰的数据源数组项的属性变化，从而无法触发ForEach的重新渲染。为实现ForEach重新渲染，需要结合@Observed和@ObjectLink装饰器使用。例如，在文章列表卡片上点击“点赞”按钮，从而修改文章的点赞数量。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Observed</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Article</span> &#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">title</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">brief</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">isLiked</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">likesCount</span>: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">id: <span class="built_in">string</span>, title: <span class="built_in">string</span>, brief: <span class="built_in">string</span>, isLiked: <span class="built_in">boolean</span>, likesCount: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = id;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">title</span> = title;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">brief</span> = brief;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isLiked</span> = isLiked;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">likesCount</span> = likesCount;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">ArticleListView</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">articleList</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Article</span>&gt; = [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Article</span>(<span class="string">&#x27;001&#x27;</span>, <span class="string">&#x27;第0篇文章&#x27;</span>, <span class="string">&#x27;文章简介内容&#x27;</span>, <span class="literal">false</span>, <span class="number">100</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Article</span>(<span class="string">&#x27;002&#x27;</span>, <span class="string">&#x27;第1篇文章&#x27;</span>, <span class="string">&#x27;文章简介内容&#x27;</span>, <span class="literal">false</span>, <span class="number">100</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Article</span>(<span class="string">&#x27;003&#x27;</span>, <span class="string">&#x27;第2篇文章&#x27;</span>, <span class="string">&#x27;文章简介内容&#x27;</span>, <span class="literal">false</span>, <span class="number">100</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Article</span>(<span class="string">&#x27;004&#x27;</span>, <span class="string">&#x27;第4篇文章&#x27;</span>, <span class="string">&#x27;文章简介内容&#x27;</span>, <span class="literal">false</span>, <span class="number">100</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Article</span>(<span class="string">&#x27;005&#x27;</span>, <span class="string">&#x27;第5篇文章&#x27;</span>, <span class="string">&#x27;文章简介内容&#x27;</span>, <span class="literal">false</span>, <span class="number">100</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Article</span>(<span class="string">&#x27;006&#x27;</span>, <span class="string">&#x27;第6篇文章&#x27;</span>, <span class="string">&#x27;文章简介内容&#x27;</span>, <span class="literal">false</span>, <span class="number">100</span>),</span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">List</span>() &#123;</span><br><span class="line">      <span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="property">articleList</span>, <span class="function">(<span class="params">item: Article</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title class_">ListItem</span>() &#123;</span><br><span class="line">          <span class="title class_">ArticleCard</span>(&#123;</span><br><span class="line">            <span class="attr">article</span>: item</span><br><span class="line">          &#125;)</span><br><span class="line">            .<span class="title function_">margin</span>(&#123; <span class="attr">top</span>: <span class="number">20</span> &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, <span class="function">(<span class="params">item: Article</span>) =&gt;</span> item.<span class="property">id</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">padding</span>(<span class="number">20</span>)</span><br><span class="line">    .<span class="title function_">scrollBar</span>(<span class="title class_">BarState</span>.<span class="property">Off</span>)</span><br><span class="line">    .<span class="title function_">backgroundColor</span>(<span class="number">0xF1F3F5</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">ArticleCard</span> &#123;</span><br><span class="line">  <span class="meta">@ObjectLink</span> <span class="attr">article</span>: <span class="title class_">Article</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">handleLiked</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">article</span>.<span class="property">isLiked</span> = !<span class="variable language_">this</span>.<span class="property">article</span>.<span class="property">isLiked</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">article</span>.<span class="property">likesCount</span> = <span class="variable language_">this</span>.<span class="property">article</span>.<span class="property">isLiked</span> ? <span class="variable language_">this</span>.<span class="property">article</span>.<span class="property">likesCount</span> + <span class="number">1</span> : <span class="variable language_">this</span>.<span class="property">article</span>.<span class="property">likesCount</span> - <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Row</span>() &#123;</span><br><span class="line">      <span class="title class_">Image</span>($r(<span class="string">&#x27;app.media.icon&#x27;</span>))</span><br><span class="line">        .<span class="title function_">width</span>(<span class="number">80</span>)</span><br><span class="line">        .<span class="title function_">height</span>(<span class="number">80</span>)</span><br><span class="line">        .<span class="title function_">margin</span>(&#123; <span class="attr">right</span>: <span class="number">20</span> &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="title class_">Column</span>() &#123;</span><br><span class="line">        <span class="title class_">Text</span>(<span class="variable language_">this</span>.<span class="property">article</span>.<span class="property">title</span>)</span><br><span class="line">          .<span class="title function_">fontSize</span>(<span class="number">20</span>)</span><br><span class="line">          .<span class="title function_">margin</span>(&#123; <span class="attr">bottom</span>: <span class="number">8</span> &#125;)</span><br><span class="line">        <span class="title class_">Text</span>(<span class="variable language_">this</span>.<span class="property">article</span>.<span class="property">brief</span>)</span><br><span class="line">          .<span class="title function_">fontSize</span>(<span class="number">16</span>)</span><br><span class="line">          .<span class="title function_">fontColor</span>(<span class="title class_">Color</span>.<span class="property">Gray</span>)</span><br><span class="line">          .<span class="title function_">margin</span>(&#123; <span class="attr">bottom</span>: <span class="number">8</span> &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Row</span>() &#123;</span><br><span class="line">          <span class="title class_">Image</span>(<span class="variable language_">this</span>.<span class="property">article</span>.<span class="property">isLiked</span> ? $r(<span class="string">&#x27;app.media.iconLiked&#x27;</span>) : $r(<span class="string">&#x27;app.media.iconUnLiked&#x27;</span>))</span><br><span class="line">            .<span class="title function_">width</span>(<span class="number">24</span>)</span><br><span class="line">            .<span class="title function_">height</span>(<span class="number">24</span>)</span><br><span class="line">            .<span class="title function_">margin</span>(&#123; <span class="attr">right</span>: <span class="number">8</span> &#125;)</span><br><span class="line">          <span class="title class_">Text</span>(<span class="variable language_">this</span>.<span class="property">article</span>.<span class="property">likesCount</span>.<span class="title function_">toString</span>())</span><br><span class="line">            .<span class="title function_">fontSize</span>(<span class="number">16</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">handleLiked</span>())</span><br><span class="line">        .<span class="title function_">justifyContent</span>(<span class="title class_">FlexAlign</span>.<span class="property">Center</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      .<span class="title function_">alignItems</span>(<span class="title class_">HorizontalAlign</span>.<span class="property">Start</span>)</span><br><span class="line">      .<span class="title function_">width</span>(<span class="string">&#x27;80%&#x27;</span>)</span><br><span class="line">      .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">padding</span>(<span class="number">20</span>)</span><br><span class="line">    .<span class="title function_">borderRadius</span>(<span class="number">12</span>)</span><br><span class="line">    .<span class="title function_">backgroundColor</span>(<span class="string">&#x27;#FFECECEC&#x27;</span>)</span><br><span class="line">    .<span class="title function_">height</span>(<span class="number">120</span>)</span><br><span class="line">    .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">justifyContent</span>(<span class="title class_">FlexAlign</span>.<span class="property">SpaceBetween</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码的初始运行效果（左图）和点击第1个文章卡片上的点赞图标后的运行效果（右图）如下图所示。<br><strong>图7</strong> 数据源数组项子属性变化案例运行效果图<br><img src="/posts/c66435f3/%E6%95%B0%E6%8D%AE%E6%BA%90%E6%95%B0%E7%BB%84%E9%A1%B9%E5%AD%90%E5%B1%9E%E6%80%A7%E5%8F%98%E5%8C%96%E6%A1%88%E4%BE%8B%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C%E5%9B%BE.png" alt="数据源数组项子属性变化案例运行效果图"><br>在本示例中，Article类被@Observed装饰器修饰。父组件ArticleListView传入Article对象实例给子组件ArticleCard，子组件使用@ObjectLink装饰器接收该实例。</p>
<ol>
<li>当点击第1个文章卡片上的点赞图标时，会触发ArticleCard组件的handleLiked函数。该函数修改第1个卡片对应组件里article实例的isLiked和likesCount属性值。</li>
<li>由于子组件ArticleCard中的article使用了@ObjectLink装饰器，父子组件共享同一份article数据。因此，父组件中articleList的第1个数组项的isLiked和likedCounts数值也会同步修改。</li>
<li>当父组件监听到数据源数组项属性值变化时，会触发ForEach重新渲染。</li>
<li>在此处，ForEach键值生成规则为数组项的id属性值。当ForEach遍历新数据源时，数组项的id均没有变化，不会新建组件。</li>
<li>渲染第1个数组项对应的ArticleCard组件时，读取到的isLiked和likesCount为修改后的新值。</li>
</ol>
<h2 id="使用建议"><a href="#使用建议" class="headerlink" title="使用建议"></a>使用建议</h2><ul>
<li>尽量避免在最终的键值生成规则中包含数据项索引index，以防止出现<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/#%E6%B8%B2%E6%9F%93%E7%BB%93%E6%9E%9C%E9%9D%9E%E9%A2%84%E6%9C%9F">渲染结果非预期</a>和<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/#%E6%B8%B2%E6%9F%93%E6%80%A7%E8%83%BD%E9%99%8D%E4%BD%8E">渲染性能降低</a>。如果业务确实需要使用index，例如列表需要通过index进行条件渲染，开发者需要接受ForEach在改变数据源后重新创建组件所带来的性能损耗。</li>
<li>为满足键值的唯一性，对于对象数据类型，建议使用对象数据中的唯一id作为键值。</li>
<li>基本数据类型的数据项没有唯一ID属性。如果使用基本数据类型本身作为键值，必须确保数组项无重复。因此，对于数据源会发生变化的场景，建议将基本数据类型数组转化为具备唯一ID属性的对象数据类型数组，再使用ID属性作为键值生成规则。</li>
</ul>
<h2 id="不推荐案例"><a href="#不推荐案例" class="headerlink" title="不推荐案例"></a>不推荐案例</h2><p>开发者在使用ForEach的过程中，若对于键值生成规则的理解不够充分，可能会出现错误的使用方式。错误使用一方面会导致功能层面问题，例如<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/#%E6%B8%B2%E6%9F%93%E7%BB%93%E6%9E%9C%E9%9D%9E%E9%A2%84%E6%9C%9F">渲染结果非预期</a>，另一方面会导致性能层面问题，例如<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/#%E6%B8%B2%E6%9F%93%E6%80%A7%E8%83%BD%E9%99%8D%E4%BD%8E">渲染性能降低</a>。</p>
<h3 id="渲染结果非预期"><a href="#渲染结果非预期" class="headerlink" title="渲染结果非预期"></a>渲染结果非预期</h3><p>在本示例中，通过设置ForEach的第三个参数KeyGenerator函数，自定义键值生成规则为数据源的索引index的字符串类型值。当点击父组件Parent中“在第1项后插入新项”文本组件后，界面会出现非预期的结果。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Parent</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">simpleList</span>: <span class="title class_">Array</span>&lt;<span class="built_in">string</span>&gt; = [<span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;two&#x27;</span>, <span class="string">&#x27;three&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="title class_">Button</span>() &#123;</span><br><span class="line">        <span class="title class_">Text</span>(<span class="string">&#x27;在第1项后插入新项&#x27;</span>).<span class="title function_">fontSize</span>(<span class="number">30</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">simpleList</span>.<span class="title function_">splice</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="string">&#x27;new item&#x27;</span>);</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="property">simpleList</span>, <span class="function">(<span class="params">item: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title class_">ChildItem</span>(&#123; <span class="attr">item</span>: item &#125;)</span><br><span class="line">      &#125;, <span class="function">(<span class="params">item: <span class="built_in">string</span>, index: <span class="built_in">number</span></span>) =&gt;</span> index.<span class="title function_">toString</span>())</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">justifyContent</span>(<span class="title class_">FlexAlign</span>.<span class="property">Center</span>)</span><br><span class="line">    .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">backgroundColor</span>(<span class="number">0xF1F3F5</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">ChildItem</span> &#123;</span><br><span class="line">  <span class="meta">@Prop</span> <span class="attr">item</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Text</span>(<span class="variable language_">this</span>.<span class="property">item</span>)</span><br><span class="line">      .<span class="title function_">fontSize</span>(<span class="number">30</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码的初始渲染效果和点击“在第1项后插入新项”文本组件后的渲染效果如下图所示。<br><strong>图8</strong> 渲染结果非预期运行效果图<br><img src="/posts/c66435f3/%E6%B8%B2%E6%9F%93%E7%BB%93%E6%9E%9C%E9%9D%9E%E9%A2%84%E6%9C%9F%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C%E5%9B%BE.gif" alt="渲染结果非预期运行效果图"><br>ForEach在首次渲染时，创建的键值依次为”0”、”1”、”2”。<br>插入新项后，数据源simpleList变为[‘one’, ‘new item’, ‘two’, ‘three’]，框架监听到@State装饰的数据源长度变化触发ForEach重新渲染。<br>ForEach依次遍历新数据源，遍历数据项”one”时生成键值”0”，存在相同键值，因此不创建新组件。继续遍历数据项”new item”时生成键值”1”，存在相同键值，因此不创建新组件。继续遍历数据项”two”生成键值”2”，存在相同键值，因此不创建新组件。最后遍历数据项”three”时生成键值”3”，不存在相同键值，创建内容为”three”的新组件并渲染。<br>从以上可以看出，当最终键值生成规则包含index时，期望的界面渲染结果为[‘one’, ‘new item’, ‘two’, ‘three’]，而实际的渲染结果为[‘one’, ‘two’, ‘three’, ‘three’]，渲染结果不符合开发者预期。因此，开发者在使用ForEach时应尽量避免最终键值生成规则中包含index。  </p>
<h3 id="渲染性能降低"><a href="#渲染性能降低" class="headerlink" title="渲染性能降低"></a>渲染性能降低</h3><p>在本示例中，ForEach的第三个参数KeyGenerator函数处于缺省状态。根据上述<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/#%E9%94%AE%E5%80%BC%E7%94%9F%E6%88%90%E8%A7%84%E5%88%99">键值生成规则</a>，此例使用框架默认的键值生成规则，即最终键值为字符串<code>index + &#39;__&#39; + JSON.stringify(item)</code>。当点击“在第1项后插入新项”文本组件后，ForEach将需要为第2个数组项以及其后的所有项重新创建组件。  </p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Parent</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">simpleList</span>: <span class="title class_">Array</span>&lt;<span class="built_in">string</span>&gt; = [<span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;two&#x27;</span>, <span class="string">&#x27;three&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="title class_">Button</span>() &#123;</span><br><span class="line">        <span class="title class_">Text</span>(<span class="string">&#x27;在第1项后插入新项&#x27;</span>).<span class="title function_">fontSize</span>(<span class="number">30</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">simpleList</span>.<span class="title function_">splice</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="string">&#x27;new item&#x27;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[onClick]: simpleList is <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(<span class="variable language_">this</span>.simpleList)&#125;</span>`</span>);</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="property">simpleList</span>, <span class="function">(<span class="params">item: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title class_">ChildItem</span>(&#123; <span class="attr">item</span>: item &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">justifyContent</span>(<span class="title class_">FlexAlign</span>.<span class="property">Center</span>)</span><br><span class="line">    .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">backgroundColor</span>(<span class="number">0xF1F3F5</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">ChildItem</span> &#123;</span><br><span class="line">  <span class="meta">@Prop</span> <span class="attr">item</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">aboutToAppear</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[aboutToAppear]: item is <span class="subst">$&#123;<span class="variable language_">this</span>.item&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Text</span>(<span class="variable language_">this</span>.<span class="property">item</span>)</span><br><span class="line">      .<span class="title function_">fontSize</span>(<span class="number">50</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码的初始渲染效果和点击”在第1项后插入新项”文本组件后的渲染效果如下图所示。<br><strong>图9</strong> 渲染性能降低案例运行效果图<br><img src="/posts/c66435f3/%E6%B8%B2%E6%9F%93%E6%80%A7%E8%83%BD%E9%99%8D%E4%BD%8E%E6%A1%88%E4%BE%8B%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C%E5%9B%BE.gif" alt="渲染性能降低案例运行效果图"><br>点击“在第1项后插入新项”文本组件后，IDE的日志打印结果如下所示。<br><strong>图10</strong> 渲染性能降低案例日志打印图<br><img src="/posts/c66435f3/%E6%B8%B2%E6%9F%93%E6%80%A7%E8%83%BD%E9%99%8D%E4%BD%8E%E6%A1%88%E4%BE%8B%E6%97%A5%E5%BF%97%E6%89%93%E5%8D%B0%E5%9B%BE.png" alt="渲染性能降低案例日志打印图"><br>插入新项后，ForEach为new item、 two、 three三个数组项创建了对应的组件ChildItem，并执行了组件的<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-custom-component-lifecycle-V5#abouttoappear">aboutToAppear()</a>生命周期函数。这是因为：</p>
<ol>
<li>在ForEach首次渲染时，创建的键值依次为0__one、1__two、2__three。</li>
<li>插入新项后，数据源simpleList变为[‘one’, ‘new item’, ‘two’, ‘three’]，ArkUI框架监听到@State装饰的数据源长度变化触发ForEach重新渲染。</li>
<li>ForEach依次遍历新数据源，遍历数据项one时生成键值0__one，键值已存在，因此不创建新组件。继续遍历数据项new item时生成键值1__new item，不存在相同键值，创建内容为new item的新组件并渲染。继续遍历数据项two生成键值2__two，不存在相同键值，创建内容为two的新组件并渲染。最后遍历数据项three时生成键值3__three，不存在相同键值，创建内容为three的新组件并渲染。<br>尽管此示例中界面渲染的结果符合预期，但每次插入一条新数组项时，ForEach都会为从该数组项起后面的所有数组项全部重新创建组件。当数据源数据量较大或组件结构复杂时，由于组件无法得到复用，将导致性能体验不佳。因此，除非必要，否则不推荐将第三个参数KeyGenerator函数处于缺省状态，以及在键值生成规则中包含数据项索引index。</li>
</ol>
<!-- flag of hidden posts -->
      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div></div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt=" WeChat Pay"/>
        <p>WeChat Pay</p>
      </div>
    

    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/private/" rel="tag"># private</a>
          
        </div>
      

      
      
      

      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">95</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">27</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="mailto:shenbh@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://blog.csdn.net/ptwenzi?spm=1010.2135.3001.5113" target="_blank" title="CSDN">
                      
                        <i class="fa fa-fw fa-clone"></i>CSDN</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/shenbh" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://gitee.com/shen_bh" target="_blank" title="Gitee">
                      
                        <i class="fa fa-fw fa-git"></i>Gitee</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95%E6%A6%82%E8%BF%B0"><span class="nav-text">基础语法概述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A3%B0%E6%98%8E%E5%BC%8FUI%E6%8F%8F%E8%BF%B0"><span class="nav-text">声明式UI描述</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%BB%84%E4%BB%B6"><span class="nav-text">创建组件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A0%E5%8F%82%E6%95%B0"><span class="nav-text">无参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%89%E5%8F%82%E6%95%B0"><span class="nav-text">有参数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E5%B1%9E%E6%80%A7"><span class="nav-text">配置属性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E4%BA%8B%E4%BB%B6"><span class="nav-text">配置事件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E5%AD%90%E7%BB%84%E4%BB%B6"><span class="nav-text">配置子组件</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6"><span class="nav-text">创建自定义组件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="nav-text">自定义组件的基本用法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84"><span class="nav-text">自定义组件的基本结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#struct"><span class="nav-text">struct</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Component"><span class="nav-text">@Component</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#freezeWhenInactive11"><span class="nav-text">freezeWhenInactive11+</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#build-%E5%87%BD%E6%95%B0"><span class="nav-text">build()函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Entry"><span class="nav-text">@Entry</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#EntryOptions10"><span class="nav-text">EntryOptions10+</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reusable"><span class="nav-text">@Reusable</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%88%90%E5%91%98%E5%87%BD%E6%95%B0-x2F-%E5%8F%98%E9%87%8F"><span class="nav-text">成员函数&#x2F;变量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6%E7%9A%84%E5%8F%82%E6%95%B0%E8%A7%84%E5%AE%9A"><span class="nav-text">自定义组件的参数规定</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#build-%E5%87%BD%E6%95%B0-1"><span class="nav-text">build()函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6%E9%80%9A%E7%94%A8%E6%A0%B7%E5%BC%8F"><span class="nav-text">自定义组件通用样式</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%A1%B5%E9%9D%A2%E5%92%8C%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-text">页面和自定义组件生命周期</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B"><span class="nav-text">自定义组件的创建和渲染流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6%E9%87%8D%E6%96%B0%E6%B8%B2%E6%9F%93"><span class="nav-text">自定义组件重新渲染</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6%E7%9A%84%E5%88%A0%E9%99%A4"><span class="nav-text">自定义组件的删除</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6%E7%9B%91%E5%90%AC%E9%A1%B5%E9%9D%A2%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-text">自定义组件监听页面生命周期</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#if-x2F-else%E6%9D%A1%E4%BB%B6%E6%B8%B2%E6%9F%93"><span class="nav-text">if&#x2F;else条件渲染</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E8%A7%84%E5%88%99"><span class="nav-text">使用规则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E6%9C%BA%E5%88%B6"><span class="nav-text">更新机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">使用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8if%E8%BF%9B%E8%A1%8C%E6%9D%A1%E4%BB%B6%E6%B8%B2%E6%9F%93"><span class="nav-text">使用if进行条件渲染</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#if-%E2%80%A6-else-%E2%80%A6%E8%AF%AD%E5%8F%A5%E5%92%8C%E5%AD%90%E7%BB%84%E4%BB%B6%E7%8A%B6%E6%80%81"><span class="nav-text">if … else …语句和子组件状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B5%8C%E5%A5%97if%E8%AF%AD%E5%8F%A5"><span class="nav-text">嵌套if语句</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BE%AA%E7%8E%AF%E6%B8%B2%E6%9F%93"><span class="nav-text">循环渲染</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3%E6%8F%8F%E8%BF%B0"><span class="nav-text">接口描述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%94%AE%E5%80%BC%E7%94%9F%E6%88%90%E8%A7%84%E5%88%99"><span class="nav-text">键值生成规则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%84%E4%BB%B6%E5%88%9B%E5%BB%BA%E8%A7%84%E5%88%99"><span class="nav-text">组件创建规则</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A6%96%E6%AC%A1%E6%B8%B2%E6%9F%93"><span class="nav-text">首次渲染</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9D%9E%E9%A6%96%E6%AC%A1%E6%B8%B2%E6%9F%93"><span class="nav-text">非首次渲染</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF-1"><span class="nav-text">使用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%BA%90%E4%B8%8D%E5%8F%98"><span class="nav-text">数据源不变</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%BA%90%E6%95%B0%E7%BB%84%E9%A1%B9%E5%8F%91%E7%94%9F%E5%8F%98%E5%8C%96"><span class="nav-text">数据源数组项发生变化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%BA%90%E6%95%B0%E7%BB%84%E9%A1%B9%E5%AD%90%E5%B1%9E%E6%80%A7%E5%8F%98%E5%8C%96"><span class="nav-text">数据源数组项子属性变化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%BB%BA%E8%AE%AE"><span class="nav-text">使用建议</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8D%E6%8E%A8%E8%8D%90%E6%A1%88%E4%BE%8B"><span class="nav-text">不推荐案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B8%B2%E6%9F%93%E7%BB%93%E6%9E%9C%E9%9D%9E%E9%A2%84%E6%9C%9F"><span class="nav-text">渲染结果非预期</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B8%B2%E6%9F%93%E6%80%A7%E8%83%BD%E9%99%8D%E4%BD%8E"><span class="nav-text">渲染性能降低</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">阿炳</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('-1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
          if(result)$(this).text('Copied')
          else $(this).text('Copy failed')
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('Copy')
        }, 300)
      }).append(e)
    })
  </script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>