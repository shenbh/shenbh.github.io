<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="clippings," />










<meta name="description" content="概述注：本文基于Android 9.0源码，为了文章的简洁性，引用源码的地方可能有所删减。 在Framework层也有一套Binder的通信架构，它的实现最终是通过Native层结合Binder驱动来完成的。">
<meta property="og:type" content="article">
<meta property="og:title" content="Android-Binder原理三-Framework">
<meta property="og:url" content="http://shenbh.github.io/posts/6fa3d690/index.html">
<meta property="og:site_name" content="积跬步">
<meta property="og:description" content="概述注：本文基于Android 9.0源码，为了文章的简洁性，引用源码的地方可能有所删减。 在Framework层也有一套Binder的通信架构，它的实现最终是通过Native层结合Binder驱动来完成的。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://shenbh.github.io/posts/6fa3d690/java_binder.jpg">
<meta property="article:published_time" content="2025-07-03T08:06:21.614Z">
<meta property="article:modified_time" content="2025-07-03T09:06:02.809Z">
<meta property="article:author" content="阿炳">
<meta property="article:tag" content="clippings">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://shenbh.github.io/posts/6fa3d690/java_binder.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://shenbh.github.io/posts/6fa3d690/"/>





  <title>Android-Binder原理三-Framework | 积跬步</title>
  








<meta name="generator" content="Hexo 6.1.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">积跬步</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">Just do IT Now.</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://shenbh.github.io/posts/6fa3d690/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="积跬步">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Android-Binder原理三-Framework</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2025-07-03T16:06:21+08:00">
                2025-07-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          
              <div class="post-description">
                  概述注：本文基于Android 9.0源码，为了文章的简洁性，引用源码的地方可能有所删减。 在Framework层也有一套Binder的通信架构，它的实现最终是通过Native层结合Binder驱动来完成的。
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>注：本文基于Android 9.0源码，为了文章的简洁性，引用源码的地方可能有所删减。</p>
<p>在Framework层也有一套Binder的通信架构，它的实现最终是通过Native层结合Binder驱动来完成的。</p>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><h3 id="startReg"><a href="#startReg" class="headerlink" title="startReg"></a>startReg</h3><p>在Android系统开机过程中，Zygote进程启动时会进行虚拟机注册，该过程调用AndroidRuntime::startReg方法来完成jni方法的注册：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> RegJNIRec gRegJNI[] = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">REG_JNI</span>(register_com_android_internal_os_RuntimeInit),</span><br><span class="line"></span><br><span class="line">    <span class="built_in">REG_JNI</span>(register_com_android_internal_os_ZygoteInit_nativeZygoteInit),</span><br><span class="line"></span><br><span class="line">    <span class="built_in">REG_JNI</span>(register_android_os_SystemClock),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">REG_JNI</span>(register_android_os_Binder),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">AndroidRuntime::startReg</span><span class="params">(JNIEnv* env)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">register_jni_procs</span>(gRegJNI, <span class="built_in">NELEM</span>(gRegJNI), env) &lt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// android_util_Binder.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">register_android_os_Binder</span><span class="params">(JNIEnv* env)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册Binder类的jni方法</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">int_register_android_os_Binder</span>(env) &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册BinderInternal类的jni方法</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">int_register_android_os_BinderInternal</span>(env) &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册BinderProxy类的jni方法</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">int_register_android_os_BinderProxy</span>(env) &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    jclass clazz = <span class="built_in">FindClassOrDie</span>(env, <span class="string">&quot;android/util/Log&quot;</span>);</span><br><span class="line"></span><br><span class="line">    gLogOffsets.mClass = <span class="built_in">MakeGlobalRefOrDie</span>(env, clazz);</span><br><span class="line"></span><br><span class="line">    gLogOffsets.mLogE = <span class="built_in">GetStaticMethodIDOrDie</span>(env, clazz, <span class="string">&quot;e&quot;</span>, <span class="string">&quot;(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)I&quot;</span>);</span><br><span class="line"></span><br><span class="line">    clazz = <span class="built_in">FindClassOrDie</span>(env, <span class="string">&quot;android/os/ParcelFileDescriptor&quot;</span>);</span><br><span class="line"></span><br><span class="line">    gParcelFileDescriptorOffsets.mClass = <span class="built_in">MakeGlobalRefOrDie</span>(env, clazz);</span><br><span class="line"></span><br><span class="line">    gParcelFileDescriptorOffsets.mConstructor = <span class="built_in">GetMethodIDOrDie</span>(env, clazz, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(Ljava/io/FileDescriptor;)V&quot;</span>);</span><br><span class="line"></span><br><span class="line">    clazz = <span class="built_in">FindClassOrDie</span>(env, <span class="string">&quot;android/os/StrictMode&quot;</span>);</span><br><span class="line"></span><br><span class="line">    gStrictModeCallbackOffsets.mClass = <span class="built_in">MakeGlobalRefOrDie</span>(env, clazz);</span><br><span class="line"></span><br><span class="line">    gStrictModeCallbackOffsets.mCallback = <span class="built_in">GetStaticMethodIDOrDie</span>(env, clazz, <span class="string">&quot;onBinderStrictModePolicyChange&quot;</span>, <span class="string">&quot;(I)V&quot;</span>);</span><br><span class="line"></span><br><span class="line">    clazz = <span class="built_in">FindClassOrDie</span>(env, <span class="string">&quot;java/lang/Thread&quot;</span>);</span><br><span class="line"></span><br><span class="line">    gThreadDispatchOffsets.mClass = <span class="built_in">MakeGlobalRefOrDie</span>(env, clazz);</span><br><span class="line"></span><br><span class="line">    gThreadDispatchOffsets.mDispatchUncaughtException = <span class="built_in">GetMethodIDOrDie</span>(env, clazz, <span class="string">&quot;dispatchUncaughtException&quot;</span>, <span class="string">&quot;(Ljava/lang/Throwable;)V&quot;</span>);</span><br><span class="line"></span><br><span class="line">    gThreadDispatchOffsets.mCurrentThread = <span class="built_in">GetStaticMethodIDOrDie</span>(env, clazz, <span class="string">&quot;currentThread&quot;</span>, <span class="string">&quot;()Ljava/lang/Thread;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>涉及到的相关方法如下：</p>
<ul>
<li><code>FindClassOrDie(env, kBinderPathName)</code> 相当于 <code>env-&gt;FindClass(kBinderPathName)</code></li>
<li><code>MakeGlobalRefOrDie()</code> 相当于 <code>env-&gt;NewGlobalRef()</code></li>
<li><code>GetMethodIDOrDie()</code> 相当于 <code>env-&gt;GetMethodID()</code></li>
<li><code>GetFieldIDOrDie()</code> 相当于 <code>env-&gt;GeFieldID()</code></li>
<li><code>RegisterMethodsOrDie()</code> 相当于 <code>Android::registerNativeMethods()</code></li>
</ul>
<h3 id="注册Binder类"><a href="#注册Binder类" class="headerlink" title="注册Binder类"></a>注册Binder类</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android_util_Binder.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">bindernative_offsets_t</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    jclass mClass; <span class="comment">// 记录Binder类</span></span><br><span class="line"></span><br><span class="line">    jmethodID mExecTransact; <span class="comment">// 记录execTransact()方法</span></span><br><span class="line"></span><br><span class="line">    jfieldID mObject; <span class="comment">// 记录mObject属性</span></span><br><span class="line"></span><br><span class="line">&#125; gBinderOffsets;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> JNINativeMethod gBinderMethods[] = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* name, signature, funcPtr */</span></span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;getCallingPid&quot;</span>, <span class="string">&quot;()I&quot;</span>, (<span class="type">void</span>*)android_os_Binder_getCallingPid &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;getCallingUid&quot;</span>, <span class="string">&quot;()I&quot;</span>, (<span class="type">void</span>*)android_os_Binder_getCallingUid &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;clearCallingIdentity&quot;</span>, <span class="string">&quot;()J&quot;</span>, (<span class="type">void</span>*)android_os_Binder_clearCallingIdentity &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;restoreCallingIdentity&quot;</span>, <span class="string">&quot;(J)V&quot;</span>, (<span class="type">void</span>*)android_os_Binder_restoreCallingIdentity &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;setThreadStrictModePolicy&quot;</span>, <span class="string">&quot;(I)V&quot;</span>, (<span class="type">void</span>*)android_os_Binder_setThreadStrictModePolicy &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;getThreadStrictModePolicy&quot;</span>, <span class="string">&quot;()I&quot;</span>, (<span class="type">void</span>*)android_os_Binder_getThreadStrictModePolicy &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;flushPendingCommands&quot;</span>, <span class="string">&quot;()V&quot;</span>, (<span class="type">void</span>*)android_os_Binder_flushPendingCommands &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;getNativeBBinderHolder&quot;</span>, <span class="string">&quot;()J&quot;</span>, (<span class="type">void</span>*)android_os_Binder_getNativeBBinderHolder &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;getNativeFinalizer&quot;</span>, <span class="string">&quot;()J&quot;</span>, (<span class="type">void</span>*)android_os_Binder_getNativeFinalizer &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;blockUntilThreadAvailable&quot;</span>, <span class="string">&quot;()V&quot;</span>, (<span class="type">void</span>*)android_os_Binder_blockUntilThreadAvailable &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="type">const</span> kBinderPathName = <span class="string">&quot;android/os/Binder&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">int_register_android_os_Binder</span><span class="params">(JNIEnv* env)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    jclass clazz = <span class="built_in">FindClassOrDie</span>(env, kBinderPathName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将Java层Binder类保存到mClass变量</span></span><br><span class="line"></span><br><span class="line">    gBinderOffsets.mClass = <span class="built_in">MakeGlobalRefOrDie</span>(env, clazz);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将Java层execTransact()方法保存到mExecTransact变量</span></span><br><span class="line"></span><br><span class="line">    gBinderOffsets.mExecTransact = <span class="built_in">GetMethodIDOrDie</span>(env, clazz, <span class="string">&quot;execTransact&quot;</span>, <span class="string">&quot;(IJJI)Z&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将Java层mObject属性保存到mObject变量</span></span><br><span class="line"></span><br><span class="line">    gBinderOffsets.mObject = <span class="built_in">GetFieldIDOrDie</span>(env, clazz, <span class="string">&quot;mObject&quot;</span>, <span class="string">&quot;J&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册JNI方法</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">RegisterMethodsOrDie</span>(env, kBinderPathName, gBinderMethods, <span class="built_in">NELEM</span>(gBinderMethods));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>int_register_android_os_Binder方法的主要功能：</p>
<ul>
<li>通过gBinderOffsets，保存Java层Binder类的信息，为JNI层访问Java层提供通道；</li>
<li>通过RegisterMethodsOrDie，将gBinderMethods数组完成映射关系，从而为Java层访问JNI层提供通道。也就是说该过程建立了Binder类在Native层与framework层之间的相互调用的桥梁。</li>
</ul>
<h3 id="注册BinderInternal类"><a href="#注册BinderInternal类" class="headerlink" title="注册BinderInternal类"></a>注册BinderInternal类</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">binderinternal_offsets_t</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    jclass mClass;</span><br><span class="line"></span><br><span class="line">    jmethodID mForceGc;</span><br><span class="line"></span><br><span class="line">    jmethodID mProxyLimitCallback;</span><br><span class="line"></span><br><span class="line">&#125; gBinderInternalOffsets;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> JNINativeMethod gBinderInternalMethods[] = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* name, signature, funcPtr */</span></span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;getContextObject&quot;</span>, <span class="string">&quot;()Landroid/os/IBinder;&quot;</span>, (<span class="type">void</span>*)android_os_BinderInternal_getContextObject &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;joinThreadPool&quot;</span>, <span class="string">&quot;()V&quot;</span>, (<span class="type">void</span>*)android_os_BinderInternal_joinThreadPool &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;disableBackgroundScheduling&quot;</span>, <span class="string">&quot;(Z)V&quot;</span>, (<span class="type">void</span>*)android_os_BinderInternal_disableBackgroundScheduling &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;setMaxThreads&quot;</span>, <span class="string">&quot;(I)V&quot;</span>, (<span class="type">void</span>*)android_os_BinderInternal_setMaxThreads &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;handleGc&quot;</span>, <span class="string">&quot;()V&quot;</span>, (<span class="type">void</span>*)android_os_BinderInternal_handleGc &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;nSetBinderProxyCountEnabled&quot;</span>, <span class="string">&quot;(Z)V&quot;</span>, (<span class="type">void</span>*)android_os_BinderInternal_setBinderProxyCountEnabled &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;nGetBinderProxyPerUidCounts&quot;</span>, <span class="string">&quot;()Landroid/util/SparseIntArray;&quot;</span>, (<span class="type">void</span>*)android_os_BinderInternal_getBinderProxyPerUidCounts &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;nGetBinderProxyCount&quot;</span>, <span class="string">&quot;(I)I&quot;</span>, (<span class="type">void</span>*)android_os_BinderInternal_getBinderProxyCount &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;nSetBinderProxyCountWatermarks&quot;</span>, <span class="string">&quot;(II)V&quot;</span>, (<span class="type">void</span>*)android_os_BinderInternal_setBinderProxyCountWatermarks&#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="type">const</span> kBinderInternalPathName = <span class="string">&quot;com/android/internal/os/BinderInternal&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">int_register_android_os_BinderInternal</span><span class="params">(JNIEnv* env)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    jclass clazz = <span class="built_in">FindClassOrDie</span>(env, kBinderInternalPathName);</span><br><span class="line"></span><br><span class="line">    gBinderInternalOffsets.mClass = <span class="built_in">MakeGlobalRefOrDie</span>(env, clazz);</span><br><span class="line"></span><br><span class="line">    gBinderInternalOffsets.mForceGc = <span class="built_in">GetStaticMethodIDOrDie</span>(env, clazz, <span class="string">&quot;forceBinderGc&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line"></span><br><span class="line">    gBinderInternalOffsets.mProxyLimitCallback = <span class="built_in">GetStaticMethodIDOrDie</span>(env, clazz, <span class="string">&quot;binderProxyLimitCallbackFromNative&quot;</span>, <span class="string">&quot;(I)V&quot;</span>);</span><br><span class="line"></span><br><span class="line">    jclass SparseIntArrayClass = <span class="built_in">FindClassOrDie</span>(env, <span class="string">&quot;android/util/SparseIntArray&quot;</span>);</span><br><span class="line"></span><br><span class="line">    gSparseIntArrayOffsets.classObject = <span class="built_in">MakeGlobalRefOrDie</span>(env, SparseIntArrayClass);</span><br><span class="line"></span><br><span class="line">    gSparseIntArrayOffsets.constructor = <span class="built_in">GetMethodIDOrDie</span>(env, gSparseIntArrayOffsets.classObject, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line"></span><br><span class="line">    gSparseIntArrayOffsets.put = <span class="built_in">GetMethodIDOrDie</span>(env, gSparseIntArrayOffsets.classObject, <span class="string">&quot;put&quot;</span>, <span class="string">&quot;(II)V&quot;</span>);</span><br><span class="line"></span><br><span class="line">    BpBinder::<span class="built_in">setLimitCallback</span>(android_os_BinderInternal_proxyLimitcallback);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">RegisterMethodsOrDie</span>(env, kBinderInternalPathName, gBinderInternalMethods, <span class="built_in">NELEM</span>(gBinderInternalMethods));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="注册BinderProxy类"><a href="#注册BinderProxy类" class="headerlink" title="注册BinderProxy类"></a>注册BinderProxy类</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">error_offsets_t</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    jclass mClass;</span><br><span class="line"></span><br><span class="line">&#125; gErrorOffsets;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">binderproxy_offsets_t</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    jclass mClass;</span><br><span class="line"></span><br><span class="line">    jmethodID mGetInstance;</span><br><span class="line"></span><br><span class="line">    jmethodID mSendDeathNotice;</span><br><span class="line"></span><br><span class="line">    jmethodID mDumpProxyDebugInfo;</span><br><span class="line"></span><br><span class="line">    jfieldID mNativeData;  <span class="comment">// Field holds native pointer to BinderProxyNativeData.</span></span><br><span class="line"></span><br><span class="line">&#125; gBinderProxyOffsets;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">class_offsets_t</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    jmethodID mGetName;</span><br><span class="line"></span><br><span class="line">&#125; gClassOffsets;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> JNINativeMethod gBinderProxyMethods[] = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* name, signature, funcPtr */</span></span><br><span class="line"></span><br><span class="line">    &#123;<span class="string">&quot;pingBinder&quot;</span>,          <span class="string">&quot;()Z&quot;</span>, (<span class="type">void</span>*)android_os_BinderProxy_pingBinder&#125;,</span><br><span class="line"></span><br><span class="line">    &#123;<span class="string">&quot;isBinderAlive&quot;</span>,       <span class="string">&quot;()Z&quot;</span>, (<span class="type">void</span>*)android_os_BinderProxy_isBinderAlive&#125;,</span><br><span class="line"></span><br><span class="line">    &#123;<span class="string">&quot;getInterfaceDescriptor&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>, (<span class="type">void</span>*)android_os_BinderProxy_getInterfaceDescriptor&#125;,</span><br><span class="line"></span><br><span class="line">    &#123;<span class="string">&quot;transactNative&quot;</span>,      <span class="string">&quot;(ILandroid/os/Parcel;Landroid/os/Parcel;I)Z&quot;</span>, (<span class="type">void</span>*)android_os_BinderProxy_transact&#125;,</span><br><span class="line"></span><br><span class="line">    &#123;<span class="string">&quot;linkToDeath&quot;</span>,         <span class="string">&quot;(Landroid/os/IBinder$DeathRecipient;I)V&quot;</span>, (<span class="type">void</span>*)android_os_BinderProxy_linkToDeath&#125;,</span><br><span class="line"></span><br><span class="line">    &#123;<span class="string">&quot;unlinkToDeath&quot;</span>,       <span class="string">&quot;(Landroid/os/IBinder$DeathRecipient;I)Z&quot;</span>, (<span class="type">void</span>*)android_os_BinderProxy_unlinkToDeath&#125;,</span><br><span class="line"></span><br><span class="line">    &#123;<span class="string">&quot;getNativeFinalizer&quot;</span>,  <span class="string">&quot;()J&quot;</span>, (<span class="type">void</span>*)android_os_BinderProxy_getNativeFinalizer&#125;,</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="type">const</span> kBinderProxyPathName = <span class="string">&quot;android/os/BinderProxy&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">int_register_android_os_BinderProxy</span><span class="params">(JNIEnv* env)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    jclass clazz = <span class="built_in">FindClassOrDie</span>(env, <span class="string">&quot;java/lang/Error&quot;</span>);</span><br><span class="line"></span><br><span class="line">    gErrorOffsets.mClass = <span class="built_in">MakeGlobalRefOrDie</span>(env, clazz);</span><br><span class="line"></span><br><span class="line">    clazz = <span class="built_in">FindClassOrDie</span>(env, kBinderProxyPathName);</span><br><span class="line"></span><br><span class="line">    gBinderProxyOffsets.mClass = <span class="built_in">MakeGlobalRefOrDie</span>(env, clazz);</span><br><span class="line"></span><br><span class="line">    gBinderProxyOffsets.mGetInstance = <span class="built_in">GetStaticMethodIDOrDie</span>(env, clazz, <span class="string">&quot;getInstance&quot;</span>, <span class="string">&quot;(JJ)Landroid/os/BinderProxy;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    gBinderProxyOffsets.mSendDeathNotice = <span class="built_in">GetStaticMethodIDOrDie</span>(env, clazz, <span class="string">&quot;sendDeathNotice&quot;</span>, <span class="string">&quot;(Landroid/os/IBinder$DeathRecipient;)V&quot;</span>);</span><br><span class="line"></span><br><span class="line">    gBinderProxyOffsets.mDumpProxyDebugInfo = <span class="built_in">GetStaticMethodIDOrDie</span>(env, clazz, <span class="string">&quot;dumpProxyDebugInfo&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line"></span><br><span class="line">    gBinderProxyOffsets.mNativeData = <span class="built_in">GetFieldIDOrDie</span>(env, clazz, <span class="string">&quot;mNativeData&quot;</span>, <span class="string">&quot;J&quot;</span>);</span><br><span class="line"></span><br><span class="line">    clazz = <span class="built_in">FindClassOrDie</span>(env, <span class="string">&quot;java/lang/Class&quot;</span>);</span><br><span class="line"></span><br><span class="line">    gClassOffsets.mGetName = <span class="built_in">GetMethodIDOrDie</span>(env, clazz, <span class="string">&quot;getName&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">RegisterMethodsOrDie</span>(env, kBinderProxyPathName, gBinderProxyMethods, <span class="built_in">NELEM</span>(gBinderProxyMethods));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="注册服务"><a href="#注册服务" class="headerlink" title="注册服务"></a>注册服务</h2><h3 id="ServiceManager-addService"><a href="#ServiceManager-addService" class="headerlink" title="ServiceManager.addService"></a>ServiceManager.addService</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addService</span><span class="params">(String name, IBinder service, <span class="type">boolean</span> allowIsolated,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">        <span class="type">int</span> dumpPriority)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        getIServiceManager().addService(name, service, allowIsolated, dumpPriority);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"></span><br><span class="line">        Log.e(TAG, <span class="string">&quot;error in addService&quot;</span>, e);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> IServiceManager <span class="title function_">getIServiceManager</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sServiceManager != <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sServiceManager;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sServiceManager = ServiceManagerNative.asInterface(Binder.allowBlocking(BinderInternal.getContextObject()));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sServiceManager;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// android_util_Binder.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// BinderInternal.getContextObject()对应JNI方法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> jobject <span class="title function_">android_os_BinderInternal_getContextObject</span><span class="params">(JNIEnv* env, jobject clazz)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等价于new BpBinder(0)</span></span><br><span class="line"></span><br><span class="line">    sp&lt;IBinder&gt; b = ProcessState::self()-&gt;getContextObject(NULL);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> javaObjectForIBinder(env, b);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jobject <span class="title function_">javaObjectForIBinder</span><span class="params">(JNIEnv* env, const sp&lt;IBinder&gt;&amp; val)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (val == NULL) <span class="keyword">return</span> NULL;</span><br><span class="line"></span><br><span class="line">    BinderProxyNativeData* nativeData = gNativeDataCache;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nativeData == nullptr) &#123;</span><br><span class="line"></span><br><span class="line">        nativeData = <span class="keyword">new</span> <span class="title class_">BinderProxyNativeData</span>();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用getInstance方法获取BinderProxy对象实例</span></span><br><span class="line"></span><br><span class="line">    <span class="type">jobject</span> <span class="variable">object</span> <span class="operator">=</span> env-&gt;CallStaticObjectMethod(gBinderProxyOffsets.mClass,</span><br><span class="line"></span><br><span class="line">            gBinderProxyOffsets.mGetInstance, (jlong) nativeData, (jlong) val.get());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (env-&gt;ExceptionCheck()) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// In the exception case, getInstance still took ownership of nativeData.</span></span><br><span class="line"></span><br><span class="line">        gNativeDataCache = nullptr;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NULL;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BinderProxyNativeData* actualNativeData = getBPNativeData(env, object);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (actualNativeData == nativeData) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// New BinderProxy; we still have exclusive access.</span></span><br><span class="line"></span><br><span class="line">        nativeData-&gt;mOrgue = <span class="keyword">new</span> <span class="title class_">DeathRecipientList</span>;</span><br><span class="line"></span><br><span class="line">        nativeData-&gt;mObject = val; <span class="comment">// BinderProxy.mNativeData成员变量的mObject记录BpBinder对象</span></span><br><span class="line"></span><br><span class="line">        gNativeDataCache = nullptr;</span><br><span class="line"></span><br><span class="line">        ++gNumProxies;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (gNumProxies &gt;= gProxiesWarned + PROXY_WARN_INTERVAL) &#123;</span><br><span class="line"></span><br><span class="line">            ALOGW(<span class="string">&quot;Unexpectedly many live BinderProxies: %d\n&quot;</span>, gNumProxies);</span><br><span class="line"></span><br><span class="line">            gProxiesWarned = gNumProxies;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// nativeData wasn&#x27;t used. Reuse it the next time.</span></span><br><span class="line"></span><br><span class="line">        gNativeDataCache = nativeData;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BinderProxyNativeData* getBPNativeData(JNIEnv* env, jobject obj) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (BinderProxyNativeData *) env-&gt;GetLongField(obj, gBinderProxyOffsets.mNativeData);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BinderProxy.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> BinderProxy <span class="title function_">getInstance</span><span class="params">(<span class="type">long</span> nativeData, <span class="type">long</span> iBinder)</span> &#123;</span><br><span class="line"></span><br><span class="line">    BinderProxy result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        result = sProxyMap.get(iBinder);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        result = <span class="keyword">new</span> <span class="title class_">BinderProxy</span>(nativeData);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sProxyMap.set(iBinder, result);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">BinderProxy</span><span class="params">(<span class="type">long</span> nativeData)</span> &#123;</span><br><span class="line"></span><br><span class="line">    mNativeData = nativeData;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Allow blocking calls on the given interface</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> IBinder <span class="title function_">allowBlocking</span><span class="params">(IBinder binder)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (binder <span class="keyword">instanceof</span> BinderProxy) &#123;</span><br><span class="line"></span><br><span class="line">            ((BinderProxy) binder).mWarnOnBlocking = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (binder != <span class="literal">null</span> &amp;&amp; binder.getInterfaceDescriptor() != <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">                &amp;&amp; binder.queryLocalInterface(binder.getInterfaceDescriptor()) == <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            Log.w(TAG, <span class="string">&quot;Unable to allow blocking on interface &quot;</span> + binder);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException ignored) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> binder;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ServiceManagerNative</span> <span class="keyword">extends</span> <span class="title class_">Binder</span> <span class="keyword">implements</span> <span class="title class_">IServiceManager</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> IServiceManager <span class="title function_">asInterface</span><span class="params">(IBinder obj)</span></span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (obj == <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">IServiceManager</span> <span class="variable">in</span> <span class="operator">=</span> (IServiceManager)obj.queryLocalInterface(descriptor);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in != <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> in;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceManagerProxy</span>(obj);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BinderProxy</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// BinderProxy代理类返回null（与Service不处于同一个进程）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> IInterface <span class="title function_">queryLocalInterface</span><span class="params">(String descriptor)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Binder</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Binder</span> <span class="keyword">implements</span> <span class="title class_">IBinder</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">attachInterface</span><span class="params">( IInterface owner,  String descriptor)</span> &#123;</span><br><span class="line"></span><br><span class="line">        mOwner = owner;</span><br><span class="line"></span><br><span class="line">        mDescriptor = descriptor;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Binder类返回自身（与Service处于同一个进程）</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  IInterface <span class="title function_">queryLocalInterface</span><span class="params">( String descriptor)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mDescriptor != <span class="literal">null</span> &amp;&amp; mDescriptor.equals(descriptor)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> mOwner;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServiceManagerProxy</span> <span class="keyword">implements</span> <span class="title class_">IServiceManager</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceManagerProxy</span><span class="params">(IBinder remote)</span> &#123;</span><br><span class="line"></span><br><span class="line">        mRemote = remote;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">asBinder</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mRemote;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由上可知， <code>ServiceManagerNative.asInterface(Binder.allowBlocking(BinderInternal.getContextObject()))</code> 等价于 <code>new ServiceManagerProxy(new BinderProxy(nativeData))</code> ，其中 <code>nativeData-&gt;mObject = new BpBinder(0)</code> ，BpBinder作为Binder代理端，指向Native层的Service Manager。</p>
<p>Framework层的ServiceManager的实际工作交给了ServiceManagerProxy的成员变量BinderProxy，而BinderProxy通过JNI方式最终会调用BpBinder对象，因此可知上层Binder架构的核心功能依赖于Native架构的服务来完成。</p>
<h3 id="ServiceManagerProxy-addService"><a href="#ServiceManagerProxy-addService" class="headerlink" title="ServiceManagerProxy.addService"></a>ServiceManagerProxy.addService</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ServiceManagerProxy</span> <span class="keyword">implements</span> <span class="title class_">IServiceManager</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceManagerProxy</span><span class="params">(IBinder remote)</span> &#123;</span><br><span class="line"></span><br><span class="line">        mRemote = remote;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">asBinder</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mRemote;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addService</span><span class="params">(String name, IBinder service, <span class="type">boolean</span> allowIsolated, <span class="type">int</span> dumpPriority)</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Parcel</span> <span class="variable">data</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line"></span><br><span class="line">        <span class="type">Parcel</span> <span class="variable">reply</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// static final String descriptor = &quot;android.os.IServiceManager&quot;;</span></span><br><span class="line"></span><br><span class="line">        data.writeInterfaceToken(IServiceManager.descriptor);</span><br><span class="line"></span><br><span class="line">        data.writeString(name);</span><br><span class="line"></span><br><span class="line">        data.writeStrongBinder(service);</span><br><span class="line"></span><br><span class="line">        data.writeInt(allowIsolated ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        data.writeInt(dumpPriority);</span><br><span class="line"></span><br><span class="line">        mRemote.transact(ADD_SERVICE_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        reply.recycle();</span><br><span class="line"></span><br><span class="line">        data.recycle();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">writeStrongBinder</span><span class="params">(IBinder val)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对应JNI方法android_os_Parcel_writeStrongBinder，具体可见startReg过程</span></span><br><span class="line"></span><br><span class="line">    nativeWriteStrongBinder(mNativePtr, val);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">android_os_Parcel_writeStrongBinder</span><span class="params">(JNIEnv* env, jclass clazz, jlong nativePtr, jobject object)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将Java层Parcel转换为Native层Parcel</span></span><br><span class="line"></span><br><span class="line">    Parcel* parcel = reinterpret_cast&lt;Parcel*&gt;(nativePtr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parcel != NULL) &#123;</span><br><span class="line"></span><br><span class="line">        const <span class="type">status_t</span> <span class="variable">err</span> <span class="operator">=</span> parcel-&gt;writeStrongBinder(ibinderForJavaObject(env, object));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err != NO_ERROR) &#123;</span><br><span class="line"></span><br><span class="line">            signalExceptionForError(env, clazz, err);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sp&lt;IBinder&gt; <span class="title function_">ibinderForJavaObject</span><span class="params">(JNIEnv* env, jobject obj)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (obj == NULL) <span class="keyword">return</span> NULL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Instance of Binder?</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (env-&gt;IsInstanceOf(obj, gBinderOffsets.mClass)) &#123;</span><br><span class="line"></span><br><span class="line">        JavaBBinderHolder* jbh = (JavaBBinderHolder*) env-&gt;GetLongField(obj, gBinderOffsets.mObject);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> jbh-&gt;get(env, obj);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Instance of BinderProxy?</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (env-&gt;IsInstanceOf(obj, gBinderProxyOffsets.mClass)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> getBPNativeData(env, obj)-&gt;mObject;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NULL;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JavaBBinderHolder</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    sp&lt;JavaBBinder&gt; <span class="title function_">get</span><span class="params">(JNIEnv* env, jobject obj)</span></span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        AutoMutex <span class="title function_">_l</span><span class="params">(mLock)</span>;</span><br><span class="line"></span><br><span class="line">        sp&lt;JavaBBinder&gt; b = mBinder.promote();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (b == NULL) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 首次进来，创建JavaBBinder对象</span></span><br><span class="line"></span><br><span class="line">            b = <span class="keyword">new</span> <span class="title class_">JavaBBinder</span>(env, obj);</span><br><span class="line"></span><br><span class="line">            mBinder = b;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JavaBBinder</span> : <span class="keyword">public</span> BBinder</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此可知 <code>data.writeStrongBinder(service)</code> 最终等价于 <code>parcel-&gt;writeStrongBinder(new JavaBBinder(env, obj))</code> ，至于 <code>parcel-&gt;writeStrongBinder</code> 方法，在前面的Native层解析中已经给出。</p>
<h3 id="BinderProxy-transact"><a href="#BinderProxy-transact" class="headerlink" title="BinderProxy.transact"></a>BinderProxy.transact</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">transact</span><span class="params">(<span class="type">int</span> code, Parcel data, Parcel reply, <span class="type">int</span> flags)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检测Parcel大小是否大于800k</span></span><br><span class="line"></span><br><span class="line">    Binder.checkParcel(<span class="built_in">this</span>, code, data, <span class="string">&quot;Unreasonably large binder buffer&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对应android_os_BinderProxy_transact方法</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> transactNative(code, data, reply, flags);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// android_util_Binder.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> jboolean <span class="title function_">android_os_BinderProxy_transact</span><span class="params">(JNIEnv* env, jobject obj,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">        jint code, jobject dataObj, jobject replyObj, jint flags)</span> <span class="comment">// throws RemoteException</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Java Parcel转为Native Parcel</span></span><br><span class="line"></span><br><span class="line">    Parcel* data = parcelForJavaObject(env, dataObj);</span><br><span class="line"></span><br><span class="line">    Parcel* reply = parcelForJavaObject(env, replyObj);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// BpBinder(0)对象</span></span><br><span class="line"></span><br><span class="line">    IBinder* target = getBPNativeData(env, obj)-&gt;mObject.get();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (target == NULL) &#123;</span><br><span class="line"></span><br><span class="line">        jniThrowException(env, <span class="string">&quot;java/lang/IllegalStateException&quot;</span>, <span class="string">&quot;Binder has been finalized!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">status_t</span> <span class="variable">err</span> <span class="operator">=</span> target-&gt;transact(code, *data, reply, flags);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Java层的 <code>BinderProxy.transact()</code> 最终交由Native层的 <code>BpBinder::transact()</code> 完成，具体实现过程在之前的Native解析中已经给出。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>ServiceManager.addService注册服务过程实际上是通过Native层来具体实现注册逻辑，通过BpBinder(0)来发送ADD_SERVICE_TRANSACTION命令，与Binder驱动进行数据交互，最终由service_manager进程来完成注册服务的功能。</p>
<h2 id="获取服务"><a href="#获取服务" class="headerlink" title="获取服务"></a>获取服务</h2><h3 id="ServiceManager-getService"><a href="#ServiceManager-getService" class="headerlink" title="ServiceManager.getService"></a>ServiceManager.getService</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> IBinder <span class="title function_">getService</span><span class="params">(String name)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">IBinder</span> <span class="variable">service</span> <span class="operator">=</span> sCache.get(name);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (service != <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> service;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Binder.allowBlocking(rawGetService(name));</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"></span><br><span class="line">        Log.e(TAG, <span class="string">&quot;error in getService&quot;</span>, e);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> IBinder <span class="title function_">rawGetService</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">IBinder</span> <span class="variable">binder</span> <span class="operator">=</span> getIServiceManager().getService(name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> binder;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请求获取服务过程中，先从缓存中查询是否存在，如果缓存中不存在的话，再通过binder交互来查询相应的服务，getIServiceManager返回的是ServiceManagerProxy对象。</p>
<h3 id="ServiceManagerProxy-getService"><a href="#ServiceManagerProxy-getService" class="headerlink" title="ServiceManagerProxy.getService"></a>ServiceManagerProxy.getService</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ServiceManagerProxy</span> <span class="keyword">implements</span> <span class="title class_">IServiceManager</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceManagerProxy</span><span class="params">(IBinder remote)</span> &#123;</span><br><span class="line"></span><br><span class="line">        mRemote = remote;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">asBinder</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mRemote;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">getService</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Parcel</span> <span class="variable">data</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line"></span><br><span class="line">        <span class="type">Parcel</span> <span class="variable">reply</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line"></span><br><span class="line">        data.writeInterfaceToken(IServiceManager.descriptor);</span><br><span class="line"></span><br><span class="line">        data.writeString(name);</span><br><span class="line"></span><br><span class="line">        mRemote.transact(GET_SERVICE_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">IBinder</span> <span class="variable">binder</span> <span class="operator">=</span> reply.readStrongBinder();</span><br><span class="line"></span><br><span class="line">        reply.recycle();</span><br><span class="line"></span><br><span class="line">        data.recycle();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> binder;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="BinderProxy-transact-1"><a href="#BinderProxy-transact-1" class="headerlink" title="BinderProxy.transact"></a>BinderProxy.transact</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">transact</span><span class="params">(<span class="type">int</span> code, Parcel data, Parcel reply, <span class="type">int</span> flags)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检测Parcel大小是否大于800k</span></span><br><span class="line"></span><br><span class="line">    Binder.checkParcel(<span class="built_in">this</span>, code, data, <span class="string">&quot;Unreasonably large binder buffer&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对应android_os_BinderProxy_transact方法</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> transactNative(code, data, reply, flags);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// android_util_Binder.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> jboolean <span class="title function_">android_os_BinderProxy_transact</span><span class="params">(JNIEnv* env, jobject obj,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">        jint code, jobject dataObj, jobject replyObj, jint flags)</span> <span class="comment">// throws RemoteException</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Java Parcel转为Native Parcel</span></span><br><span class="line"></span><br><span class="line">    Parcel* data = parcelForJavaObject(env, dataObj);</span><br><span class="line"></span><br><span class="line">    Parcel* reply = parcelForJavaObject(env, replyObj);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// BpBinder(0)对象</span></span><br><span class="line"></span><br><span class="line">    IBinder* target = getBPNativeData(env, obj)-&gt;mObject.get();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (target == NULL) &#123;</span><br><span class="line"></span><br><span class="line">        jniThrowException(env, <span class="string">&quot;java/lang/IllegalStateException&quot;</span>, <span class="string">&quot;Binder has been finalized!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">status_t</span> <span class="variable">err</span> <span class="operator">=</span> target-&gt;transact(code, *data, reply, flags);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟注册服务时一样，Java层的 <code>BinderProxy.transact()</code> 最终交由Native层的 <code>BpBinder::transact()</code> 完成，然后从reply中读取Binder对象。</p>
<h3 id="Parcel-readStrongBinder"><a href="#Parcel-readStrongBinder" class="headerlink" title="Parcel.readStrongBinder"></a>Parcel.readStrongBinder</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> IBinder <span class="title function_">readStrongBinder</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> nativeReadStrongBinder(mNativePtr);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> jobject <span class="title function_">android_os_Parcel_readStrongBinder</span><span class="params">(JNIEnv* env, jclass clazz, jlong nativePtr)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将Java层Parcel转换为Native层Parcel</span></span><br><span class="line"></span><br><span class="line">    Parcel* parcel = reinterpret_cast&lt;Parcel*&gt;(nativePtr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parcel != NULL) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> javaObjectForIBinder(env, parcel-&gt;readStrongBinder());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NULL;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>readStrongBinder方法过程基本上是writeStrongBinder的逆过程。经过 <code>parcel-&gt;readStrongBinder()</code> 方法，最终创建了指向Binder服务端的BpBinder代理对象，然后经过javaObjectForIBinder将Native层BpBinder对象转换为Java层BinderProxy对象，也就是说通过getService()最终获取了指向目标Binder服务端的代理对象BinderProxy。</p>
<h3 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h3><p>ServiceManager.getService获取服务过程实际上是通过Native层来具体实现注册逻辑，通过BpBinder(0)来发送GET_SERVICE_TRANSACTION命令，与Binder驱动进行数据交互，最终由service_manager进程来完成获取服务的功能。获取之后会创建BinderProxy对象，并将BpBinder对象的地址保存到BinderProxy对象中。</p>
<h2 id="死亡通知"><a href="#死亡通知" class="headerlink" title="死亡通知"></a>死亡通知</h2><h3 id="Framework：linkToDeath-x2F-unlinkToDeath"><a href="#Framework：linkToDeath-x2F-unlinkToDeath" class="headerlink" title="Framework：linkToDeath&#x2F;unlinkToDeath"></a>Framework：linkToDeath&#x2F;unlinkToDeath</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">service.linkToDeath(<span class="keyword">new</span> <span class="title class_">IBinder</span>.DeathRecipient() &#123;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">binderDied</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        Log.d(TAG, <span class="string">&quot;died...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Binder</span> <span class="keyword">implements</span> <span class="title class_">IBinder</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">linkToDeath</span><span class="params">( DeathRecipient recipient, <span class="type">int</span> flags)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">unlinkToDeath</span><span class="params">( DeathRecipient recipient, <span class="type">int</span> flags)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">BinderProxy</span> <span class="keyword">implements</span> <span class="title class_">IBinder</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">linkToDeath</span><span class="params">(DeathRecipient recipient, <span class="type">int</span> flags)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">unlinkToDeath</span><span class="params">(DeathRecipient recipient, <span class="type">int</span> flags)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BinderProxy调用linkToDeath()&#x2F;unlinkToDeath()方法是一个native方法：android_os_BinderProxy_linkToDeath&#x2F;android_os_BinderProxy_unlinkToDeath。</p>
<h3 id="linkToDeath"><a href="#linkToDeath" class="headerlink" title="linkToDeath"></a>linkToDeath</h3><h4 id="Native：linkToDeath"><a href="#Native：linkToDeath" class="headerlink" title="Native：linkToDeath"></a>Native：linkToDeath</h4><h5 id="android-os-BinderProxy-linkToDeath"><a href="#android-os-BinderProxy-linkToDeath" class="headerlink" title="android_os_BinderProxy_linkToDeath"></a>android_os_BinderProxy_linkToDeath</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">android_os_BinderProxy_linkToDeath</span><span class="params">(JNIEnv* env, jobject obj,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">        jobject recipient, jint flags)</span> <span class="comment">// throws RemoteException</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (recipient == <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">jniThrowNullPointerException</span>(env, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取BpBinder对象</span></span><br><span class="line"></span><br><span class="line">    BinderProxyNativeData *nd = <span class="built_in">getBPNativeData</span>(env, obj);</span><br><span class="line"></span><br><span class="line">    IBinder* target = nd-&gt;mObject.<span class="built_in">get</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// class BpBinder : public IBinder</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!target-&gt;<span class="built_in">localBinder</span>()) &#123;</span><br><span class="line"></span><br><span class="line">        DeathRecipientList* list = nd-&gt;mOrgue.<span class="built_in">get</span>();</span><br><span class="line"></span><br><span class="line">        sp&lt;JavaDeathRecipient&gt; jdr = <span class="keyword">new</span> <span class="built_in">JavaDeathRecipient</span>(env, recipient, list);</span><br><span class="line"></span><br><span class="line">        <span class="type">status_t</span> err = target-&gt;<span class="built_in">linkToDeath</span>(jdr, <span class="literal">NULL</span>, flags);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err != NO_ERROR) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Failure adding the death recipient, so clear its reference now.</span></span><br><span class="line"></span><br><span class="line">            jdr-&gt;<span class="built_in">clearReference</span>();</span><br><span class="line"></span><br><span class="line">            <span class="built_in">signalExceptionForError</span>(env, obj, err, <span class="literal">true</span> <span class="comment">/*canThrowRemoteException*/</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JavaDeathRecipient</span> : <span class="keyword">public</span> IBinder::DeathRecipient</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="built_in">JavaDeathRecipient</span>(JNIEnv* env, jobject object, <span class="type">const</span> sp&lt;DeathRecipientList&gt;&amp; list)</span><br><span class="line"></span><br><span class="line">        : <span class="built_in">mVM</span>(<span class="built_in">jnienv_to_javavm</span>(env)), <span class="built_in">mObject</span>(env-&gt;<span class="built_in">NewGlobalRef</span>(object)),</span><br><span class="line"></span><br><span class="line">        <span class="built_in">mObjectWeak</span>(<span class="literal">NULL</span>), <span class="built_in">mList</span>(list)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将当前对象添加到列表DeathRecipientList</span></span><br><span class="line"></span><br><span class="line">        list-&gt;<span class="built_in">add</span>(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        gNumDeathRefsCreated.<span class="built_in">fetch_add</span>(<span class="number">1</span>, std::memory_order_relaxed);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">gcIfManyNewRefs</span>(env);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clearReference</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        sp&lt;DeathRecipientList&gt; list = mList.<span class="built_in">promote</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (list != <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">            list-&gt;<span class="built_in">remove</span>(<span class="keyword">this</span>); <span class="comment">// 从列表中移除引用</span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>android_os_BinderProxy_linkToDeath过程说明:</p>
<ul>
<li>获取DeathRecipientList：记录该BinderProxy的JavaDeathRecipient列表信息，一个BpBinder可以注册多个死亡回调；</li>
<li>创建JavaDeathRecipient：继承于IBinder::DeathRecipient；</li>
<li>通过 <code>BpBinder-&gt;linkToDeath</code> 方法添加死亡回调；</li>
<li>若 <code>BpBinder-&gt;linkToDeath</code> 失败则清除list引用。</li>
</ul>
<p>JavaDeathRecipient构造方法主要功能：</p>
<ul>
<li>通过 <code>env-&gt;NewGlobalRef(object)</code> ，为recipient创建相应的全局引用，并保存到mObject成员变量；</li>
<li>将当前对象JavaDeathRecipient的指针sp添加到DeathRecipientList。</li>
</ul>
<h5 id="BpBinder-linkToDeath"><a href="#BpBinder-linkToDeath" class="headerlink" title="BpBinder.linkToDeath"></a>BpBinder.linkToDeath</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">BpBinder::linkToDeath</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> sp&lt;DeathRecipient&gt;&amp; recipient, <span class="type">void</span>* cookie, <span class="type">uint32_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    Obituary ob;</span><br><span class="line"></span><br><span class="line">    ob.recipient = recipient; <span class="comment">// JavaDeathRecipient</span></span><br><span class="line"></span><br><span class="line">    ob.cookie = cookie; <span class="comment">// cookie = NULL</span></span><br><span class="line"></span><br><span class="line">    ob.flags = flags;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        AutoMutex _l(mLock);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mObitsSent) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!mObituaries) &#123;</span><br><span class="line"></span><br><span class="line">                mObituaries = <span class="keyword">new</span> Vector&lt;Obituary&gt;;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!mObituaries) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> NO_MEMORY;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">getWeakRefs</span>()-&gt;<span class="built_in">incWeak</span>(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">                IPCThreadState* self = IPCThreadState::<span class="built_in">self</span>();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 只在mObituaries创建时发送一次</span></span><br><span class="line"></span><br><span class="line">                self-&gt;<span class="built_in">requestDeathNotification</span>(mHandle, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">                self-&gt;<span class="built_in">flushCommands</span>();</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将新创建的Obituary添加到mObituaries</span></span><br><span class="line"></span><br><span class="line">            <span class="type">ssize_t</span> res = mObituaries-&gt;<span class="built_in">add</span>(ob);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> res &gt;= (<span class="type">ssize_t</span>)NO_ERROR ? (<span class="type">status_t</span>)NO_ERROR : res;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> DEAD_OBJECT;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">IPCThreadState::requestDeathNotification</span><span class="params">(<span class="type">int32_t</span> handle, BpBinder* proxy)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    mOut.<span class="built_in">writeInt32</span>(BC_REQUEST_DEATH_NOTIFICATION);</span><br><span class="line"></span><br><span class="line">    mOut.<span class="built_in">writeInt32</span>((<span class="type">int32_t</span>)handle);</span><br><span class="line"></span><br><span class="line">    mOut.<span class="built_in">writePointer</span>((<span class="type">uintptr_t</span>)proxy);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">IPCThreadState::flushCommands</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mProcess-&gt;mDriverFD &lt;= <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">talkWithDriver</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The flush could have caused post-write refcount decrements to have</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// been executed, which in turn could result in BC_RELEASE/BC_DECREFS</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// being queued in mOut. So flush again, if we need to.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mOut.<span class="built_in">dataSize</span>() &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">talkWithDriver</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>向Kernel层的binder driver发送BC_REQUEST_DEATH_NOTIFICATION命令，经过ioctl执行到binder_ioctl_write_read()方法。</p>
<h4 id="Binder-Driver"><a href="#Binder-Driver" class="headerlink" title="Binder Driver"></a>Binder Driver</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">binder_thread_write</span><span class="params">(<span class="keyword">struct</span> binder_proc *proc,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">struct</span> binder_thread *thread,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="type">binder_uintptr_t</span> binder_buffer, <span class="type">size_t</span> size,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="type">binder_size_t</span> *consumed)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (ptr &lt; end &amp;&amp; thread-&gt;return_error.cmd == BR_OK) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> BC_REQUEST_DEATH_NOTIFICATION:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> BC_CLEAR_DEATH_NOTIFICATION: &#123;</span><br><span class="line"></span><br><span class="line">                <span class="type">uint32_t</span> target;</span><br><span class="line"></span><br><span class="line">                <span class="type">binder_uintptr_t</span> cookie;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">struct</span> <span class="title class_">binder_ref</span> *ref;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">struct</span> <span class="title class_">binder_ref_death</span> *death = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">get_user</span>(target, (<span class="type">uint32_t</span> __user *)ptr)) <span class="keyword">return</span> -EFAULT; <span class="comment">// 获取target</span></span><br><span class="line"></span><br><span class="line">                ptr += <span class="built_in">sizeof</span>(<span class="type">uint32_t</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">get_user</span>(cookie, (<span class="type">binder_uintptr_t</span> __user *)ptr)) <span class="keyword">return</span> -EFAULT; <span class="comment">// 获取BpBinder</span></span><br><span class="line"></span><br><span class="line">                ptr += <span class="built_in">sizeof</span>(<span class="type">binder_uintptr_t</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (cmd == BC_REQUEST_DEATH_NOTIFICATION) &#123;</span><br><span class="line"></span><br><span class="line">                    death = <span class="built_in">kzalloc</span>(<span class="built_in">sizeof</span>(*death), GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (death == <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">binder_proc_lock</span>(proc);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 拿到目标服务的binder_ref</span></span><br><span class="line"></span><br><span class="line">                ref = <span class="built_in">binder_get_ref_olocked</span>(proc, target, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">                <span class="built_in">binder_node_lock</span>(ref-&gt;node);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (cmd == BC_REQUEST_DEATH_NOTIFICATION) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Native BpBinder可注册多个死亡回调，但Kernel只允许注册一个</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (ref-&gt;death) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">binder_stats_created</span>(BINDER_STAT_DEATH);</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">INIT_LIST_HEAD</span>(&amp;death-&gt;work.entry);</span><br><span class="line"></span><br><span class="line">                    death-&gt;cookie = cookie;</span><br><span class="line"></span><br><span class="line">                    ref-&gt;death = death;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 当目标binder服务所在进程已死，则直接发送死亡通知</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (ref-&gt;node-&gt;proc == <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">                        ref-&gt;death-&gt;work.type = BINDER_WORK_DEAD_BINDER;</span><br><span class="line"></span><br><span class="line">                        <span class="built_in">binder_inner_proc_lock</span>(proc);</span><br><span class="line"></span><br><span class="line">                        <span class="built_in">binder_enqueue_work_ilocked</span>(&amp;ref-&gt;death-&gt;work, &amp;proc-&gt;todo);</span><br><span class="line"></span><br><span class="line">                        <span class="built_in">binder_wakeup_proc_ilocked</span>(proc);</span><br><span class="line"></span><br><span class="line">                        <span class="built_in">binder_inner_proc_unlock</span>(proc);</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">binder_node_unlock</span>(ref-&gt;node);</span><br><span class="line"></span><br><span class="line">                <span class="built_in">binder_proc_unlock</span>(proc);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在处理BC_REQUEST_DEATH_NOTIFICATION过程时如果目标Binder服务所在进程已死，则向todo队列增加BINDER_WORK_DEAD_BINDER事务，直接发送死亡通知，这属于非常规情况。更常见的场景是Binder服务所在进程死亡后，会调用binder_release方法，然后调用binder_node_release，这个过程便会发出死亡通知的回调。</p>
<h4 id="触发死亡通知：binder-release"><a href="#触发死亡通知：binder-release" class="headerlink" title="触发死亡通知：binder_release"></a>触发死亡通知：binder_release</h4><p>当Binder服务所在进程死亡后，会释放进程相关的资源，当binder的fd被释放后，此处调用相应的方法是binder_release()。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">file_operations</span> binder_fops = &#123;</span><br><span class="line"></span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line"></span><br><span class="line">    .poll = binder_poll,</span><br><span class="line"></span><br><span class="line">    .unlocked_ioctl = binder_ioctl,</span><br><span class="line"></span><br><span class="line">    .compat_ioctl = binder_ioctl,</span><br><span class="line"></span><br><span class="line">    .mmap = binder_mmap,</span><br><span class="line"></span><br><span class="line">    .open = binder_open,</span><br><span class="line"></span><br><span class="line">    .flush = binder_flush,</span><br><span class="line"></span><br><span class="line">    .release = binder_release,</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">binder_release</span><span class="params">(<span class="keyword">struct</span> inode *nodp, <span class="keyword">struct</span> file *filp)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">binder_proc</span> *proc = filp-&gt;private_data;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">debugfs_remove</span>(proc-&gt;debugfs_entry);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (proc-&gt;binderfs_entry) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">binderfs_remove_file</span>(proc-&gt;binderfs_entry);</span><br><span class="line"></span><br><span class="line">        proc-&gt;binderfs_entry = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">binder_defer_work</span>(proc, BINDER_DEFERRED_RELEASE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">binder_defer_work</span><span class="params">(<span class="keyword">struct</span> binder_proc *proc, <span class="keyword">enum</span> binder_deferred_state defer)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">mutex_lock</span>(&amp;binder_deferred_lock);</span><br><span class="line"></span><br><span class="line">    proc-&gt;deferred_work |= defer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">hlist_unhashed</span>(&amp;proc-&gt;deferred_work_node)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">hlist_add_head</span>(&amp;proc-&gt;deferred_work_node, &amp;binder_deferred_list);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">schedule_work</span>(&amp;binder_deferred_work);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">mutex_unlock</span>(&amp;binder_deferred_lock);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="title">DECLARE_WORK</span><span class="params">(binder_deferred_work, binder_deferred_func)</span></span>;</span><br><span class="line"></span><br><span class="line">    .data = <span class="built_in">WORK_DATA_STATIC_INIT</span>(),                \</span><br><span class="line"></span><br><span class="line">    .entry    = &#123; &amp;(n).entry, &amp;(n).entry &#125;,                \</span><br><span class="line"></span><br><span class="line">    .func = (f),                            \</span><br><span class="line"></span><br><span class="line">    __WORK_INIT_LOCKDEP_MAP(<span class="meta">#n, &amp;(n))                \</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="built_in">binder_deferred_func</span>(<span class="keyword">struct</span> work_struct *work)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> binder_proc *proc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> files_struct *files;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> defer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">mutex_lock</span>(&amp;binder_deferred_lock);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">hlist_empty</span>(&amp;binder_deferred_list)) &#123;</span><br><span class="line"></span><br><span class="line">            proc = <span class="built_in">hlist_entry</span>(binder_deferred_list.first,</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">struct</span> binder_proc, deferred_work_node);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">hlist_del_init</span>(&amp;proc-&gt;deferred_work_node);</span><br><span class="line"></span><br><span class="line">            defer = proc-&gt;deferred_work;</span><br><span class="line"></span><br><span class="line">            proc-&gt;deferred_work = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            proc = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">            defer = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">mutex_unlock</span>(&amp;binder_deferred_lock);</span><br><span class="line"></span><br><span class="line">        files = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (defer &amp; BINDER_DEFERRED_PUT_FILES) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">mutex_lock</span>(&amp;proc-&gt;files_lock);</span><br><span class="line"></span><br><span class="line">            files = proc-&gt;files;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (files)</span><br><span class="line"></span><br><span class="line">                proc-&gt;files = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">mutex_unlock</span>(&amp;proc-&gt;files_lock);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (defer &amp; BINDER_DEFERRED_FLUSH)</span><br><span class="line"></span><br><span class="line">            <span class="built_in">binder_deferred_flush</span>(proc);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (defer &amp; BINDER_DEFERRED_RELEASE)</span><br><span class="line"></span><br><span class="line">            <span class="built_in">binder_deferred_release</span>(proc); <span class="comment">/* frees proc */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (files)</span><br><span class="line"></span><br><span class="line">            <span class="built_in">put_files_struct</span>(files);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">while</span> (proc);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可见，binder_release最终调用的是binder_deferred_release； 同理，binder_flush最终调用的是binder_deferred_flush。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">binder_deferred_release</span><span class="params">(<span class="keyword">struct</span> binder_proc *proc)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">binder_context</span> *context = proc-&gt;context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">binder_device</span> *device;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">rb_node</span> *n;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> threads, nodes, incoming_refs, outgoing_refs, active_transactions;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">BUG_ON</span>(proc-&gt;files);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">mutex_lock</span>(&amp;binder_procs_lock);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">hlist_del</span>(&amp;proc-&gt;proc_node); <span class="comment">// 删除proc_node节点</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">mutex_unlock</span>(&amp;binder_procs_lock);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">mutex_lock</span>(&amp;context-&gt;context_mgr_node_lock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (context-&gt;binder_context_mgr_node &amp;&amp;</span><br><span class="line"></span><br><span class="line">        context-&gt;binder_context_mgr_node-&gt;proc == proc) &#123;</span><br><span class="line"></span><br><span class="line">        context-&gt;binder_context_mgr_node = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">mutex_unlock</span>(&amp;context-&gt;context_mgr_node_lock);</span><br><span class="line"></span><br><span class="line">    device = <span class="built_in">container_of</span>(proc-&gt;context, <span class="keyword">struct</span> binder_device, context);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">refcount_dec_and_test</span>(&amp;device-&gt;ref)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">kfree</span>(context-&gt;name);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">kfree</span>(device);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    proc-&gt;context = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">binder_inner_proc_lock</span>(proc);</span><br><span class="line"></span><br><span class="line">    proc-&gt;tmp_ref++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放binder_thread</span></span><br><span class="line"></span><br><span class="line">    proc-&gt;is_dead = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    threads = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    active_transactions = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((n = <span class="built_in">rb_first</span>(&amp;proc-&gt;threads))) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">binder_thread</span> *thread;</span><br><span class="line"></span><br><span class="line">        thread = <span class="built_in">rb_entry</span>(n, <span class="keyword">struct</span> binder_thread, rb_node);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">binder_inner_proc_unlock</span>(proc);</span><br><span class="line"></span><br><span class="line">        threads++;</span><br><span class="line"></span><br><span class="line">        active_transactions += <span class="built_in">binder_thread_release</span>(proc, thread);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">binder_inner_proc_lock</span>(proc);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放binder_node</span></span><br><span class="line"></span><br><span class="line">    nodes = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    incoming_refs = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((n = <span class="built_in">rb_first</span>(&amp;proc-&gt;nodes))) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">binder_node</span> *node;</span><br><span class="line"></span><br><span class="line">        node = <span class="built_in">rb_entry</span>(n, <span class="keyword">struct</span> binder_node, rb_node);</span><br><span class="line"></span><br><span class="line">        nodes++;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">binder_inc_node_tmpref_ilocked</span>(node);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">rb_erase</span>(&amp;node-&gt;rb_node, &amp;proc-&gt;nodes);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">binder_inner_proc_unlock</span>(proc);</span><br><span class="line"></span><br><span class="line">        incoming_refs = <span class="built_in">binder_node_release</span>(node, incoming_refs);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">binder_inner_proc_lock</span>(proc);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">binder_inner_proc_unlock</span>(proc);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放binder_ref</span></span><br><span class="line"></span><br><span class="line">    outgoing_refs = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">binder_proc_lock</span>(proc);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((n = <span class="built_in">rb_first</span>(&amp;proc-&gt;refs_by_desc))) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">binder_ref</span> *ref;</span><br><span class="line"></span><br><span class="line">        ref = <span class="built_in">rb_entry</span>(n, <span class="keyword">struct</span> binder_ref, rb_node_desc);</span><br><span class="line"></span><br><span class="line">        outgoing_refs++;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">binder_cleanup_ref_olocked</span>(ref);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">binder_proc_unlock</span>(proc);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">binder_free_ref</span>(ref);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">binder_proc_lock</span>(proc);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">binder_proc_unlock</span>(proc);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放binder_work</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">binder_release_work</span>(proc, &amp;proc-&gt;todo);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">binder_release_work</span>(proc, &amp;proc-&gt;delivered_death);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">binder_proc_dec_tmpref</span>(proc);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要看一下binder_node_release方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">binder_node_release</span><span class="params">(<span class="keyword">struct</span> binder_node *node, <span class="type">int</span> refs)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">binder_ref</span> *ref;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> death = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">binder_proc</span> *proc = node-&gt;proc;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">binder_release_work</span>(proc, &amp;node-&gt;async_todo);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">binder_node_lock</span>(node);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">binder_inner_proc_lock</span>(proc);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">binder_dequeue_work_ilocked</span>(&amp;node-&gt;work);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">BUG_ON</span>(!node-&gt;tmp_refs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">hlist_empty</span>(&amp;node-&gt;refs) &amp;&amp; node-&gt;tmp_refs == <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 引用为空，则直接释放节点</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">binder_inner_proc_unlock</span>(proc);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">binder_node_unlock</span>(node);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">binder_free_node</span>(node);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> refs;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    node-&gt;proc = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    node-&gt;local_strong_refs = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    node-&gt;local_weak_refs = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">binder_inner_proc_unlock</span>(proc);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">spin_lock</span>(&amp;binder_dead_nodes_lock);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">hlist_add_head</span>(&amp;node-&gt;dead_node, &amp;binder_dead_nodes);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">spin_unlock</span>(&amp;binder_dead_nodes_lock);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">hlist_for_each_entry</span>(ref, &amp;node-&gt;refs, node_entry) &#123;</span><br><span class="line"></span><br><span class="line">        refs++;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">binder_inner_proc_lock</span>(ref-&gt;proc);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!ref-&gt;death) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">binder_inner_proc_unlock</span>(ref-&gt;proc);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        death++;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加BINDER_WORK_DEAD_BINDER事务到todo队列</span></span><br><span class="line"></span><br><span class="line">        ref-&gt;death-&gt;work.type = BINDER_WORK_DEAD_BINDER;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">binder_enqueue_work_ilocked</span>(&amp;ref-&gt;death-&gt;work, &amp;ref-&gt;proc-&gt;todo);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">binder_wakeup_proc_ilocked</span>(ref-&gt;proc);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">binder_inner_proc_unlock</span>(ref-&gt;proc);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">binder_node_unlock</span>(node);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">binder_put_node</span>(node);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> refs;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该方法会遍历该binder_node所有的binder_ref，当存在binder死亡通知时，则向相应的binder_ref所在进程的todo队列添加BINDER_WORK_DEAD_BINDER事务并唤醒处于等待状态的binder线程。</p>
<h4 id="处理死亡通知"><a href="#处理死亡通知" class="headerlink" title="处理死亡通知"></a>处理死亡通知</h4><h5 id="Binder-Driver：binder-thread-read"><a href="#Binder-Driver：binder-thread-read" class="headerlink" title="Binder Driver：binder_thread_read"></a>Binder Driver：binder_thread_read</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">binder_thread_read</span><span class="params">(<span class="keyword">struct</span> binder_proc *proc,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">struct</span> binder_thread *thread,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="type">binder_uintptr_t</span> binder_buffer, <span class="type">size_t</span> size,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="type">binder_size_t</span> *consumed, <span class="type">int</span> non_block)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (w-&gt;type) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> BINDER_WORK_DEAD_BINDER:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> BINDER_WORK_DEAD_BINDER_AND_CLEAR:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> BINDER_WORK_CLEAR_DEATH_NOTIFICATION: &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">struct</span> <span class="title class_">binder_ref_death</span> *death;</span><br><span class="line"></span><br><span class="line">                <span class="type">uint32_t</span> cmd;</span><br><span class="line"></span><br><span class="line">                <span class="type">binder_uintptr_t</span> cookie;</span><br><span class="line"></span><br><span class="line">                death = <span class="built_in">container_of</span>(w, <span class="keyword">struct</span> binder_ref_death, work);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (w-&gt;type == BINDER_WORK_CLEAR_DEATH_NOTIFICATION)</span><br><span class="line"></span><br><span class="line">                    cmd = BR_CLEAR_DEATH_NOTIFICATION_DONE;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">                    cmd = BR_DEAD_BINDER;</span><br><span class="line"></span><br><span class="line">                cookie = death-&gt;cookie; <span class="comment">// 此处的cookie是前面传递的BpBinder</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (w-&gt;type == BINDER_WORK_CLEAR_DEATH_NOTIFICATION) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">binder_inner_proc_unlock</span>(proc);</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">kfree</span>(death);</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">binder_stats_deleted</span>(BINDER_STAT_DEATH);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">binder_enqueue_work_ilocked</span>(w, &amp;proc-&gt;delivered_death);</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">binder_inner_proc_unlock</span>(proc);</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">put_user</span>(cmd, (<span class="type">uint32_t</span> __user *)ptr)) <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">                ptr += <span class="built_in">sizeof</span>(<span class="type">uint32_t</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">put_user</span>(cookie, (<span class="type">binder_uintptr_t</span> __user *)ptr)) <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">                ptr += <span class="built_in">sizeof</span>(<span class="type">binder_uintptr_t</span>);</span><br><span class="line"></span><br><span class="line">                <span class="built_in">binder_stat_br</span>(proc, thread, cmd);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (cmd == BR_DEAD_BINDER)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">goto</span> done; <span class="comment">/* DEAD_BINDER notifications can cause transactions */</span></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当Binder驱动收到BINDER_WORK_DEAD_BINDER时，将命令BR_DEAD_BINDER写到用户空间。</p>
<h5 id="IPCThreadState-executeCommand"><a href="#IPCThreadState-executeCommand" class="headerlink" title="IPCThreadState.executeCommand"></a>IPCThreadState.executeCommand</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">IPCThreadState::executeCommand</span><span class="params">(<span class="type">int32_t</span> cmd)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    BBinder* obj;</span><br><span class="line"></span><br><span class="line">    RefBase::weakref_type* refs;</span><br><span class="line"></span><br><span class="line">    <span class="type">status_t</span> result = NO_ERROR;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> ((<span class="type">uint32_t</span>)cmd) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> BR_DEAD_BINDER:</span><br><span class="line"></span><br><span class="line">            &#123;</span><br><span class="line"></span><br><span class="line">                BpBinder *proxy = (BpBinder*)mIn.<span class="built_in">readPointer</span>();</span><br><span class="line"></span><br><span class="line">                proxy-&gt;<span class="built_in">sendObituary</span>();</span><br><span class="line"></span><br><span class="line">                mOut.<span class="built_in">writeInt32</span>(BC_DEAD_BINDER_DONE);</span><br><span class="line"></span><br><span class="line">                mOut.<span class="built_in">writePointer</span>((<span class="type">uintptr_t</span>)proxy);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;*** BAD COMMAND %d received from Binder driver\n&quot;</span>, cmd);</span><br><span class="line"></span><br><span class="line">            result = UNKNOWN_ERROR;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BpBinder::sendObituary</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    mAlive = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mObitsSent) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    mLock.<span class="built_in">lock</span>();</span><br><span class="line"></span><br><span class="line">    Vector&lt;Obituary&gt;* obits = mObituaries;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(obits != <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">        IPCThreadState* self = IPCThreadState::<span class="built_in">self</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 清空死亡通知</span></span><br><span class="line"></span><br><span class="line">        self-&gt;<span class="built_in">clearDeathNotification</span>(mHandle, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        self-&gt;<span class="built_in">flushCommands</span>();</span><br><span class="line"></span><br><span class="line">        mObituaries = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mObitsSent = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    mLock.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (obits != <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">const</span> <span class="type">size_t</span> N = obits-&gt;<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 发送死亡通知</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">reportOneDeath</span>(obits-&gt;<span class="built_in">itemAt</span>(i));</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">delete</span> obits;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BpBinder::reportOneDeath</span><span class="params">(<span class="type">const</span> Obituary&amp; obit)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    sp&lt;DeathRecipient&gt; recipient = obit.recipient.<span class="built_in">promote</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (recipient == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    recipient-&gt;<span class="built_in">binderDied</span>(<span class="keyword">this</span>); <span class="comment">// 回调死亡通知的方法</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="unlinkToDeath"><a href="#unlinkToDeath" class="headerlink" title="unlinkToDeath"></a>unlinkToDeath</h3><h4 id="Native：unlinkToDeath"><a href="#Native：unlinkToDeath" class="headerlink" title="Native：unlinkToDeath"></a>Native：unlinkToDeath</h4><h5 id="android-os-BinderProxy-unlinkToDeath"><a href="#android-os-BinderProxy-unlinkToDeath" class="headerlink" title="android_os_BinderProxy_unlinkToDeath"></a>android_os_BinderProxy_unlinkToDeath</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> jboolean <span class="title">android_os_BinderProxy_unlinkToDeath</span><span class="params">(JNIEnv* env, jobject obj,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">                                                 jobject recipient, jint flags)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    jboolean res = JNI_FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (recipient == <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">jniThrowNullPointerException</span>(env, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BinderProxyNativeData* nd = <span class="built_in">getBPNativeData</span>(env, obj);</span><br><span class="line"></span><br><span class="line">    IBinder* target = nd-&gt;mObject.<span class="built_in">get</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (target == <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!target-&gt;<span class="built_in">localBinder</span>()) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">status_t</span> err = NAME_NOT_FOUND;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If we find the matching recipient, proceed to unlink using that</span></span><br><span class="line"></span><br><span class="line">        DeathRecipientList* list = nd-&gt;mOrgue.<span class="built_in">get</span>();</span><br><span class="line"></span><br><span class="line">        sp&lt;JavaDeathRecipient&gt; origJDR = list-&gt;<span class="built_in">find</span>(recipient);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (origJDR != <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">            wp&lt;IBinder::DeathRecipient&gt; dr;</span><br><span class="line"></span><br><span class="line">            err = target-&gt;<span class="built_in">unlinkToDeath</span>(origJDR, <span class="literal">NULL</span>, flags, &amp;dr);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (err == NO_ERROR &amp;&amp; dr != <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">                sp&lt;IBinder::DeathRecipient&gt; sdr = dr.<span class="built_in">promote</span>();</span><br><span class="line"></span><br><span class="line">                JavaDeathRecipient* jdr = <span class="built_in">static_cast</span>&lt;JavaDeathRecipient*&gt;(sdr.<span class="built_in">get</span>());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (jdr != <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    jdr-&gt;<span class="built_in">clearReference</span>();</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="BpBinder-unlinkToDeath"><a href="#BpBinder-unlinkToDeath" class="headerlink" title="BpBinder.unlinkToDeath"></a>BpBinder.unlinkToDeath</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">BpBinder::unlinkToDeath</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> wp&lt;DeathRecipient&gt;&amp; recipient, <span class="type">void</span>* cookie, <span class="type">uint32_t</span> flags,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">    wp&lt;DeathRecipient&gt;* outRecipient)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    AutoMutex _l(mLock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mObitsSent) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> DEAD_OBJECT;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">size_t</span> N = mObituaries ? mObituaries-&gt;<span class="built_in">size</span>() : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">const</span> Obituary&amp; obit = mObituaries-&gt;<span class="built_in">itemAt</span>(i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((obit.recipient == recipient || (recipient == <span class="literal">NULL</span> &amp;&amp; obit.cookie == cookie))</span><br><span class="line"></span><br><span class="line">                &amp;&amp; obit.flags == flags) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (outRecipient != <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">                *outRecipient = mObituaries-&gt;<span class="built_in">itemAt</span>(i).recipient;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mObituaries-&gt;<span class="built_in">removeAt</span>(i); <span class="comment">// 移除死亡通知</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mObituaries-&gt;<span class="built_in">size</span>() == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">                IPCThreadState* self = IPCThreadState::<span class="built_in">self</span>();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 清理死亡通知</span></span><br><span class="line"></span><br><span class="line">                self-&gt;<span class="built_in">clearDeathNotification</span>(mHandle, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">                self-&gt;<span class="built_in">flushCommands</span>();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">delete</span> mObituaries;</span><br><span class="line"></span><br><span class="line">                mObituaries = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> NO_ERROR;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NAME_NOT_FOUND;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">IPCThreadState::clearDeathNotification</span><span class="params">(<span class="type">int32_t</span> handle, BpBinder* proxy)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    mOut.<span class="built_in">writeInt32</span>(BC_CLEAR_DEATH_NOTIFICATION);</span><br><span class="line"></span><br><span class="line">    mOut.<span class="built_in">writeInt32</span>((<span class="type">int32_t</span>)handle);</span><br><span class="line"></span><br><span class="line">    mOut.<span class="built_in">writePointer</span>((<span class="type">uintptr_t</span>)proxy);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>写入BC_CLEAR_DEATH_NOTIFICATION命令，再经过flushCommands()，则进入Kernel层。</p>
<h4 id="Binder-Driver-1"><a href="#Binder-Driver-1" class="headerlink" title="Binder Driver"></a>Binder Driver</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">binder_thread_write</span><span class="params">(<span class="keyword">struct</span> binder_proc *proc,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">struct</span> binder_thread *thread,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="type">binder_uintptr_t</span> binder_buffer, <span class="type">size_t</span> size,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="type">binder_size_t</span> *consumed)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (ptr &lt; end &amp;&amp; thread-&gt;return_error.cmd == BR_OK) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> BC_REQUEST_DEATH_NOTIFICATION:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> BC_CLEAR_DEATH_NOTIFICATION: &#123;</span><br><span class="line"></span><br><span class="line">                <span class="type">uint32_t</span> target;</span><br><span class="line"></span><br><span class="line">                <span class="type">binder_uintptr_t</span> cookie;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">struct</span> <span class="title class_">binder_ref</span> *ref;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">struct</span> <span class="title class_">binder_ref_death</span> *death = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">get_user</span>(target, (<span class="type">uint32_t</span> __user *)ptr)) <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">                ptr += <span class="built_in">sizeof</span>(<span class="type">uint32_t</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">get_user</span>(cookie, (<span class="type">binder_uintptr_t</span> __user *)ptr)) <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">                ptr += <span class="built_in">sizeof</span>(<span class="type">binder_uintptr_t</span>);</span><br><span class="line"></span><br><span class="line">                <span class="built_in">binder_proc_lock</span>(proc);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 拿到目标服务的binder_ref</span></span><br><span class="line"></span><br><span class="line">                ref = <span class="built_in">binder_get_ref_olocked</span>(proc, target, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">                <span class="built_in">binder_node_lock</span>(ref-&gt;node);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (cmd == BC_REQUEST_DEATH_NOTIFICATION) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (ref-&gt;death == <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="built_in">binder_node_unlock</span>(ref-&gt;node);</span><br><span class="line"></span><br><span class="line">                        <span class="built_in">binder_proc_unlock</span>(proc);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    death = ref-&gt;death;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (death-&gt;cookie != cookie) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 比较是否同一个BpBinder</span></span><br><span class="line"></span><br><span class="line">                        <span class="built_in">binder_node_unlock</span>(ref-&gt;node);</span><br><span class="line"></span><br><span class="line">                        <span class="built_in">binder_proc_unlock</span>(proc);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    ref-&gt;death = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">binder_inner_proc_lock</span>(proc);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">list_empty</span>(&amp;death-&gt;work.entry)) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 添加BINDER_WORK_CLEAR_DEATH_NOTIFICATION事务</span></span><br><span class="line"></span><br><span class="line">                        death-&gt;work.type = BINDER_WORK_CLEAR_DEATH_NOTIFICATION;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (thread-&gt;looper &amp; (BINDER_LOOPER_STATE_REGISTERED | BINDER_LOOPER_STATE_ENTERED))</span><br><span class="line"></span><br><span class="line">                            <span class="built_in">binder_enqueue_thread_work_ilocked</span>(thread, &amp;death-&gt;work);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                            <span class="built_in">binder_enqueue_work_ilocked</span>(&amp;death-&gt;work, &amp;proc-&gt;todo);</span><br><span class="line"></span><br><span class="line">                            <span class="built_in">binder_wakeup_proc_ilocked</span>(proc);</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="built_in">BUG_ON</span>(death-&gt;work.type != BINDER_WORK_DEAD_BINDER);</span><br><span class="line"></span><br><span class="line">                        death-&gt;work.type = BINDER_WORK_DEAD_BINDER_AND_CLEAR;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">binder_inner_proc_unlock</span>(proc);</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">binder_node_unlock</span>(ref-&gt;node);</span><br><span class="line"></span><br><span class="line">                <span class="built_in">binder_proc_unlock</span>(proc);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">binder_thread_read</span><span class="params">(<span class="keyword">struct</span> binder_proc *proc,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">struct</span> binder_thread *thread,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="type">binder_uintptr_t</span> binder_buffer, <span class="type">size_t</span> size,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="type">binder_size_t</span> *consumed, <span class="type">int</span> non_block)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (w-&gt;type) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> BINDER_WORK_DEAD_BINDER:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> BINDER_WORK_DEAD_BINDER_AND_CLEAR:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> BINDER_WORK_CLEAR_DEATH_NOTIFICATION: &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">struct</span> <span class="title class_">binder_ref_death</span> *death;</span><br><span class="line"></span><br><span class="line">                <span class="type">uint32_t</span> cmd;</span><br><span class="line"></span><br><span class="line">                <span class="type">binder_uintptr_t</span> cookie;</span><br><span class="line"></span><br><span class="line">                death = <span class="built_in">container_of</span>(w, <span class="keyword">struct</span> binder_ref_death, work);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (w-&gt;type == BINDER_WORK_CLEAR_DEATH_NOTIFICATION)</span><br><span class="line"></span><br><span class="line">                    cmd = BR_CLEAR_DEATH_NOTIFICATION_DONE; <span class="comment">// 清除完成</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">                    cmd = BR_DEAD_BINDER;</span><br><span class="line"></span><br><span class="line">                cookie = death-&gt;cookie; <span class="comment">// 此处的cookie是前面传递的BpBinder</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (w-&gt;type == BINDER_WORK_CLEAR_DEATH_NOTIFICATION) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">binder_inner_proc_unlock</span>(proc);</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">kfree</span>(death);</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">binder_stats_deleted</span>(BINDER_STAT_DEATH);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">binder_enqueue_work_ilocked</span>(w, &amp;proc-&gt;delivered_death);</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">binder_inner_proc_unlock</span>(proc);</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">put_user</span>(cmd, (<span class="type">uint32_t</span> __user *)ptr)) <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">                ptr += <span class="built_in">sizeof</span>(<span class="type">uint32_t</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">put_user</span>(cookie, (<span class="type">binder_uintptr_t</span> __user *)ptr)) <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">                ptr += <span class="built_in">sizeof</span>(<span class="type">binder_uintptr_t</span>);</span><br><span class="line"></span><br><span class="line">                <span class="built_in">binder_stat_br</span>(proc, thread, cmd);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (cmd == BR_DEAD_BINDER)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">goto</span> done; <span class="comment">/* DEAD_BINDER notifications can cause transactions */</span></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="IPCThreadState-executeCommand-1"><a href="#IPCThreadState-executeCommand-1" class="headerlink" title="IPCThreadState.executeCommand"></a>IPCThreadState.executeCommand</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">IPCThreadState::executeCommand</span><span class="params">(<span class="type">int32_t</span> cmd)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    BBinder* obj;</span><br><span class="line"></span><br><span class="line">    RefBase::weakref_type* refs;</span><br><span class="line"></span><br><span class="line">    <span class="type">status_t</span> result = NO_ERROR;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> ((<span class="type">uint32_t</span>)cmd) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> BR_CLEAR_DEATH_NOTIFICATION_DONE:</span><br><span class="line"></span><br><span class="line">            &#123;</span><br><span class="line"></span><br><span class="line">                BpBinder *proxy = (BpBinder*)mIn.<span class="built_in">readPointer</span>();</span><br><span class="line"></span><br><span class="line">                proxy-&gt;<span class="built_in">getWeakRefs</span>()-&gt;<span class="built_in">decWeak</span>(proxy);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;*** BAD COMMAND %d received from Binder driver\n&quot;</span>, cmd);</span><br><span class="line"></span><br><span class="line">            result = UNKNOWN_ERROR;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h3><p>对于Binder IPC进程都会打开&#x2F;dev&#x2F;binder文件，当进程异常退出时，Binder驱动会调用&#x2F;dev&#x2F;binder文件所对应的release回调函数，执行清理工作，并且检查BBinder是否有注册死亡通知，当发现存在死亡通知时，那么就向其对应的BpBinder端发送死亡通知消息。死亡回调DeathRecipient只有Bp才能正确使用，因为DeathRecipient用于监控Bn端挂掉的情况，如果Bn建立跟自己的死亡通知，自己进程都挂了，也就无法通知。</p>
<p>linkToDeath过程：</p>
<ul>
<li>requestDeathNotification过程向驱动传递的命令BC_REQUEST_DEATH_NOTIFICATION，参数有mHandle和BpBinder对象；</li>
<li>binder_thread_write()过程，同一个BpBinder可以注册多个死亡回调，但Kernel只允许注册一次死亡通知；</li>
<li>注册死亡回调的过程，实质就是向binder_ref结构体添加binder_ref_death指针，binder_ref_death的cookie记录BpBinder指针。</li>
</ul>
<p>触发死亡回调：</p>
<ul>
<li>服务实体进程：binder_release过程会执行binder_node_release()，循环该binder_node下所有的ref-&gt;death对象。当存在，则将BINDER_WORK_DEAD_BINDER事务添加ref-&gt;proc-&gt;todo（即ref所在进程的todo队列)；</li>
<li>引用所在进程：执行binder_thread_read()过程，向用户空间写入BR_DEAD_BINDER，并触发死亡回调；</li>
<li>发送死亡通知sendObituary。</li>
</ul>
<p>unlinkToDeath过程：</p>
<ul>
<li>unlinkToDeath只有当该BpBinder的所有mObituaries都被移除，才会向驱动层执行清除死亡通知的动作，否则只是从Native层移除某个recipient；</li>
<li>clearDeathNotification过程向驱动传递BC_CLEAR_DEATH_NOTIFICATION，参数有mHandle和BpBinder对象；</li>
<li>binder_thread_write()过程，将BINDER_WORK_CLEAR_DEATH_NOTIFICATION事务添加当前当前进程&#x2F;线程的todo队列，并将ref-&gt;death置为NULL；</li>
<li>binder_thread_read()过程，向用户空间写入BR_CLEAR_DEATH_NOTIFICATION_DONE。</li>
</ul>
<h2 id="clearCallingIdentity-x2F-restoreCallingIdentity"><a href="#clearCallingIdentity-x2F-restoreCallingIdentity" class="headerlink" title="clearCallingIdentity&#x2F;restoreCallingIdentity"></a>clearCallingIdentity&#x2F;restoreCallingIdentity</h2><p>相关源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Binder.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">clearCallingIdentity</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">restoreCallingIdentity</span><span class="params">(<span class="type">long</span> token)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// android_util_Binder.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> jlong <span class="title function_">android_os_Binder_clearCallingIdentity</span><span class="params">(JNIEnv* env, jobject clazz)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> IPCThreadState::self()-&gt;clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">android_os_Binder_restoreCallingIdentity</span><span class="params">(JNIEnv* env, jobject clazz, jlong token)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// XXX temporary sanity check to debug crashes.</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">uid</span> <span class="operator">=</span> (<span class="type">int</span>)(token&gt;&gt;<span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (uid &gt; <span class="number">0</span> &amp;&amp; uid &lt; <span class="number">999</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// In Android currently there are no uids in this range.</span></span><br><span class="line"></span><br><span class="line">        <span class="type">char</span> buf[<span class="number">128</span>];</span><br><span class="line"></span><br><span class="line">        sprintf(buf, <span class="string">&quot;Restoring bad calling ident: 0x%&quot;</span> PRIx64, token);</span><br><span class="line"></span><br><span class="line">        jniThrowException(env, <span class="string">&quot;java/lang/IllegalStateException&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IPCThreadState::self()-&gt;restoreCallingIdentity(token);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IPCThreadState.cpp</span></span><br><span class="line"></span><br><span class="line">int64_t IPCThreadState::clearCallingIdentity()</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int64_t</span> <span class="variable">token</span> <span class="operator">=</span> ((int64_t)mCallingUid&lt;&lt;<span class="number">32</span>) | mCallingPid;</span><br><span class="line"></span><br><span class="line">    clearCaller();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> token;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> IPCThreadState::clearCaller()</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    mCallingPid = getpid();</span><br><span class="line"></span><br><span class="line">    mCallingUid = getuid();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> IPCThreadState::restoreCallingIdentity(int64_t token)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    mCallingUid = (<span class="type">int</span>)(token&gt;&gt;<span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">    mCallingPid = (<span class="type">int</span>)token;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这两个方法涉及到两个属性：</p>
<ul>
<li>mCallingUid(记为UID)，保存Binder IPC通信的调用方进程的Uid</li>
<li>mCallingPid(记为PID)，保存Binder IPC通信的调用方进程的Pid</li>
</ul>
<p>由上面的源码可知：</p>
<ul>
<li>clearCallingIdentity作用是清空远程调用端的UID和PID，用当前本地进程的UID和PID替代</li>
<li>restoreCallingIdentity作用是恢复远程调用端的UID和PID信息，及clearCallingIdentity的反过程</li>
</ul>
<p>场景及作用：进程A通过Binder远程调用进程B的服务，在此过程中，进程B又通过Binder调用了当前进程的另一个服务。</p>
<ul>
<li>进程A通过Binder远程调用进程B的服务：进程B的IPCThreadState中的mCallingUid和mCallingPid保存的是进程A的UID和PID。这时进程B中调用Binder.getCallingPid()和Binder.getCallingUid()方法便可获取进程A的UID和PID，然后利用UID和PID进行权限比对，判断进程A是否有权限调用进程B的某个方法。</li>
<li>进程B通过Binder调用了当前进程的另一个服务：此时进程B是它另一个服务的调用端，则mCallingUid和mCallingPid应该保存当前进程B的PID和UID，故需要调用clearCallingIdentity()方法完成这个功能。当进程B调用完某个组件，由于进程B仍然处于进程A的服务端，因此mCallingUid和mCallingPid需要恢复成进程A的UID和PID，通过调用restoreCallingIdentity()即可。<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">IPCThreadState::executeCommand</span><span class="params">(<span class="type">int32_t</span> cmd)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> BR_TRANSACTION:</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            binder_transaction_data tr;</span><br><span class="line"></span><br><span class="line">            result = mIn.<span class="built_in">read</span>(&amp;tr, <span class="built_in">sizeof</span>(tr));<span class="comment">//将数据读取到tr中</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">            <span class="type">const</span> <span class="type">pid_t</span> origPid = mCallingPid;</span><br><span class="line"></span><br><span class="line">            <span class="type">const</span> <span class="type">uid_t</span> origUid = mCallingUid;</span><br><span class="line"></span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">            mCallingPid = tr.sender_pid;</span><br><span class="line"></span><br><span class="line">            mCallingUid = tr.sender_euid;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (tr.target.ptr) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="function">sp&lt;BBinder&gt; <span class="title">b</span><span class="params">((BBinder*)tr.cookie)</span></span>;</span><br><span class="line"></span><br><span class="line">                <span class="type">const</span> <span class="type">status_t</span> error = b-&gt;<span class="built_in">transact</span>(tr.code, buffer, &amp;reply, tr.flags);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">            mCallingPid = origPid;</span><br><span class="line"></span><br><span class="line">            mCallingUid = origUid;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在Framework层，Binder采用JNI技术来调用Native层的Binder架构，从而为上层应用程序提供服务。在Native层中Binder是C&#x2F;S架构，分为Bn端(Server)和Bp端(Client)，对于Java层在命名与架构上也比较类似，借用网上的一张图：</p>
<p><img src="/posts/6fa3d690/java_binder.jpg" alt="java_binder"></p>
<p>Framework层的ServiceManager类的实现最终是通过BinderProxy传递给Native层来完成的。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/clippings/" rel="tag"># clippings</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/posts/95f07333/" rel="next" title="Android-Binder原理二-ServiceManager">
                <i class="fa fa-chevron-left"></i> Android-Binder原理二-ServiceManager
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/posts/8ddb9e8d/" rel="prev" title="Android-Binder原理四-实例与总结">
                Android-Binder原理四-实例与总结 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">439</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">47</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="mailto:shenbh@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://blog.csdn.net/ptwenzi?spm=1010.2135.3001.5113" target="_blank" title="CSDN">
                      
                        <i class="fa fa-fw fa-clone"></i>CSDN</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-text">概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#startReg"><span class="nav-text">startReg</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E5%86%8CBinder%E7%B1%BB"><span class="nav-text">注册Binder类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E5%86%8CBinderInternal%E7%B1%BB"><span class="nav-text">注册BinderInternal类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E5%86%8CBinderProxy%E7%B1%BB"><span class="nav-text">注册BinderProxy类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1"><span class="nav-text">注册服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ServiceManager-addService"><span class="nav-text">ServiceManager.addService</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ServiceManagerProxy-addService"><span class="nav-text">ServiceManagerProxy.addService</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BinderProxy-transact"><span class="nav-text">BinderProxy.transact</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93"><span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%9C%8D%E5%8A%A1"><span class="nav-text">获取服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ServiceManager-getService"><span class="nav-text">ServiceManager.getService</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ServiceManagerProxy-getService"><span class="nav-text">ServiceManagerProxy.getService</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BinderProxy-transact-1"><span class="nav-text">BinderProxy.transact</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Parcel-readStrongBinder"><span class="nav-text">Parcel.readStrongBinder</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93-1"><span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AD%BB%E4%BA%A1%E9%80%9A%E7%9F%A5"><span class="nav-text">死亡通知</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Framework%EF%BC%9AlinkToDeath-x2F-unlinkToDeath"><span class="nav-text">Framework：linkToDeath&#x2F;unlinkToDeath</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#linkToDeath"><span class="nav-text">linkToDeath</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Native%EF%BC%9AlinkToDeath"><span class="nav-text">Native：linkToDeath</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#android-os-BinderProxy-linkToDeath"><span class="nav-text">android_os_BinderProxy_linkToDeath</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#BpBinder-linkToDeath"><span class="nav-text">BpBinder.linkToDeath</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Binder-Driver"><span class="nav-text">Binder Driver</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A6%E5%8F%91%E6%AD%BB%E4%BA%A1%E9%80%9A%E7%9F%A5%EF%BC%9Abinder-release"><span class="nav-text">触发死亡通知：binder_release</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%84%E7%90%86%E6%AD%BB%E4%BA%A1%E9%80%9A%E7%9F%A5"><span class="nav-text">处理死亡通知</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Binder-Driver%EF%BC%9Abinder-thread-read"><span class="nav-text">Binder Driver：binder_thread_read</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#IPCThreadState-executeCommand"><span class="nav-text">IPCThreadState.executeCommand</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#unlinkToDeath"><span class="nav-text">unlinkToDeath</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Native%EF%BC%9AunlinkToDeath"><span class="nav-text">Native：unlinkToDeath</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#android-os-BinderProxy-unlinkToDeath"><span class="nav-text">android_os_BinderProxy_unlinkToDeath</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#BpBinder-unlinkToDeath"><span class="nav-text">BpBinder.unlinkToDeath</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Binder-Driver-1"><span class="nav-text">Binder Driver</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IPCThreadState-executeCommand-1"><span class="nav-text">IPCThreadState.executeCommand</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93-2"><span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#clearCallingIdentity-x2F-restoreCallingIdentity"><span class="nav-text">clearCallingIdentity&#x2F;restoreCallingIdentity</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">阿炳</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('-1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  


  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
          if(result)$(this).text('Copied')
          else $(this).text('Copy failed')
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('Copy')
        }, 300)
      }).append(e)
    })
  </script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>