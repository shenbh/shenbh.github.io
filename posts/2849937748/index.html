<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="private,安卓知识点," />










<meta name="description" content="Activity4 种状态 Active Paused Stopped Killed  生命周期Activity正常生命周期    onCreate() 首次创建onStart() 用户可见onResume() 用户交互onPause() 另一个应用开启，该应用暂停onStop() 用户不可见（还在内存）–》onRestart()–》onStart()​				或者process is kille">
<meta property="og:type" content="article">
<meta property="og:title" content="安卓-四大组件-Activity">
<meta property="og:url" content="http://shenbh.github.io/posts/2849937748/index.html">
<meta property="og:site_name" content="YULI">
<meta property="og:description" content="Activity4 种状态 Active Paused Stopped Killed  生命周期Activity正常生命周期    onCreate() 首次创建onStart() 用户可见onResume() 用户交互onPause() 另一个应用开启，该应用暂停onStop() 用户不可见（还在内存）–》onRestart()–》onStart()​				或者process is kille">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://shenbh.github.io/posts/2849937748/Activity%E6%AD%A3%E5%B8%B8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%9B%BE.jpg">
<meta property="og:image" content="http://shenbh.github.io/posts/2849937748/onNewIntent%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png">
<meta property="og:image" content="http://shenbh.github.io/posts/2849937748/Activity%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B.png">
<meta property="og:image" content="http://shenbh.github.io/posts/2849937748/Activity%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%9A%84%E5%88%87%E6%8D%A2%E8%BF%87%E7%A8%8B.jpg">
<meta property="og:image" content="http://shenbh.github.io/posts/2849937748/%E5%BC%82%E5%B8%B8%E6%83%85%E5%86%B5%E4%B8%8BActivity%E7%9A%84%E9%87%8D%E5%BB%BA%E8%BF%87%E7%A8%8B.jpg">
<meta property="og:image" content="http://shenbh.github.io/posts/2849937748/configChanges%E7%9A%84%E9%A1%B9%E7%9B%AE%E5%92%8C%E5%90%AB%E4%B9%89.jpg">
<meta property="og:image" content="http://shenbh.github.io/posts/2849937748/%E7%89%B9%E6%AE%8A%E4%BB%BB%E5%8A%A1%E6%A0%881.jpg">
<meta property="og:image" content="http://shenbh.github.io/posts/2849937748/%E7%89%B9%E6%AE%8A%E4%BB%BB%E5%8A%A1%E6%A0%882.jpg">
<meta property="og:image" content="http://shenbh.github.io/posts/2849937748/Activity%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B.jpg">
<meta property="og:image" content="http://shenbh.github.io/posts/2849937748/Activity%E6%A0%88.png">
<meta property="og:image" content="http://shenbh.github.io/posts/2849937748/setContentView%E8%BF%87%E7%A8%8B.png">
<meta property="article:published_time" content="2019-12-26T02:16:58.000Z">
<meta property="article:modified_time" content="2025-02-26T02:19:34.945Z">
<meta property="article:author" content="阿炳">
<meta property="article:tag" content="private">
<meta property="article:tag" content="安卓知识点">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://shenbh.github.io/posts/2849937748/Activity%E6%AD%A3%E5%B8%B8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%9B%BE.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://shenbh.github.io/posts/2849937748/"/>





  <title>安卓-四大组件-Activity | YULI</title><meta name="robots" content="noindex">
  








<meta name="generator" content="Hexo 6.1.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">YULI</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Just do IT Now.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://shenbh.github.io/posts/2849937748/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YULI">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">安卓-四大组件-Activity</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-12-26T10:16:58+08:00">
                2019-12-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Activity"><a href="#Activity" class="headerlink" title="Activity"></a>Activity</h1><h2 id="4-种状态"><a href="#4-种状态" class="headerlink" title="4 种状态"></a>4 种状态</h2><ul>
<li>Active</li>
<li>Paused</li>
<li>Stopped</li>
<li>Killed</li>
</ul>
<h2 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h2><h3 id="Activity正常生命周期"><a href="#Activity正常生命周期" class="headerlink" title="Activity正常生命周期"></a>Activity正常生命周期</h3><p><img src="/posts/2849937748/Activity%E6%AD%A3%E5%B8%B8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%9B%BE.jpg" alt="Activity正常生命周期图.png">  </p>
<blockquote>
<p><code>onCreate()</code> 首次创建<br><code>onStart()</code> 用户可见<br><code>onResume()</code> 用户交互<br><code>onPause()</code> 另一个应用开启，该应用暂停<br><code>onStop()</code> 用户不可见（还在内存）–》<code>onRestart()</code>–》<code>onStart()</code><br>​				或者<code>process is killed on</code>–》<code>onStart()</code><br><code>onDestroy()</code> 销毁命令：当内存不足原先不用的会自动销毁<br><code>onRestart()</code> 重新启动<br><code>onRestart()</code> 后会调用<code>onNewIntent()</code>（即，<code>onNewIntent</code>和<code>onCreate</code>是不会被同时调用）</p>
</blockquote>
<h4 id="onNewIntent-被调用两次"><a href="#onNewIntent-被调用两次" class="headerlink" title="onNewIntent()被调用两次"></a><code>onNewIntent()</code>被调用两次</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(WebTestActivity.<span class="built_in">this</span>, MainActivity.class); </span><br><span class="line">intent.addFlags(Intent.FLAG_ACTIVITY_SINGLE_TOP | Intent.FLAG_ACTIVITY_CLEAR_TOP);     </span><br><span class="line"><span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(url); </span><br><span class="line">intent.setData(uri); </span><br><span class="line">startActivity(intent); </span><br></pre></td></tr></table></figure>
<p>以上面的方式经过<code>onRestart()</code>启动的话<code>onNewIntent()</code>会被调用两次。<br>解决：只设置<code>intent.addFlags(Intent.FLAG_ACTIVITY_SINGLE_TOP);</code></p>
<h3 id="onNewIntent的生命周期"><a href="#onNewIntent的生命周期" class="headerlink" title="onNewIntent的生命周期"></a>onNewIntent的生命周期</h3><p><img src="/posts/2849937748/onNewIntent%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png" alt="onNewIntent的生命周期"></p>
<ol>
<li>只对<strong>singleTop , singleTask , singlelnstance</strong>有效，因为standard每次都是新建，所以不存在onNewlntent ;  </li>
<li>只对<strong>startActivity</strong>有效，对于从Navigation切换回来的恢复无效;</li>
</ol>
<h3 id="异常情况下的生命周期"><a href="#异常情况下的生命周期" class="headerlink" title="异常情况下的生命周期"></a>异常情况下的生命周期</h3><ul>
<li><code>onSaveInstanceState</code></li>
<li><code>onRestoreInstanceState</code></li>
</ul>
<h3 id="一些特殊情况下的生命周期"><a href="#一些特殊情况下的生命周期" class="headerlink" title="一些特殊情况下的生命周期"></a>一些特殊情况下的生命周期</h3><ul>
<li><code>Activity</code>的横竖屏切换</li>
<li>什么时候单独走 <code>onPause()</code>不走 <code>onStop()</code><br>  当<code>Activity</code>被另一个透明或者<code>Dialog</code>样式的<code>Activity</code>覆盖时走<code>onPause()</code>不走<code>onStop()</code>。 此时它依然和<code>WindowManager</code>保持连接，系统继续维护其内部状态，所以它仍然可见，但它已失去焦点不能与用户交互。</li>
<li>什么情况下导致 <code>onDestory()</code>不执行<ul>
<li>极端情况下：系统内存不足时被杀死是不会调<code>onDestroy()</code>。</li>
<li>在<code>MainActivity</code>中调<code>System.exit(0)；</code>则<code>MainActivity</code>不会调用<code>onDestroy</code></li>
</ul>
</li>
</ul>
<h3 id="IdleHandler比onResume精确"><a href="#IdleHandler比onResume精确" class="headerlink" title="IdleHandler比onResume精确"></a><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/eb7d15ac052a">IdleHandler</a>比onResume精确</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">    Looper.getMainLooper().getQueue().addIdleHandler(<span class="keyword">new</span> <span class="title class_">MessageQueue</span>.IdleHandler() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">queueIdle</span><span class="params">()</span> &#123;</span><br><span class="line">            Log.e(<span class="string">&quot;DBL&quot;</span>, <span class="string">&quot;queueIdle&quot;</span>);</span><br><span class="line">            <span class="comment">// UI第一帧绘制完成（可以理解为页面可见）</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;  <span class="comment">// 返回false表示MessageQueue在执行完这段代码后将该IdleHandler删除，反之不删除，下一次继续执行</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onResume</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onResume();</span><br><span class="line">    Log.e(<span class="string">&quot;DBL&quot;</span>, <span class="string">&quot;onResume&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面例子将<code>IdleHandler</code>添加到主线程<code>MessageQueue</code>中，<code>queueIdle()</code>方法回调，<strong>说明UI第一帧绘制完成，可以理解为UI首次可见</strong>，这个比onResume精确的多，因为onResume回调的时候界面还没有开始绘制，此时界面是不可见的。</p>
<h4 id="IdleHandler应用场景"><a href="#IdleHandler应用场景" class="headerlink" title="IdleHandler应用场景"></a>IdleHandler应用场景</h4><ol>
<li>在应用启动时我们可能希望把一些优先级没那么高的操作延迟一点处理，一般会使用 Handler.postDelayed(Runnable r, long delayMillis)来实现，但是又不知道该延迟多少时间比较合适，因为手机性能不同，有的性能较差可能需要延迟较多，有的性能较好可以允许较少的延迟时间。所以在做项目性能优化的时候可以使用 IdleHandler，它在主线程空闲时执行任务，而不影响其他任务的执行。</li>
<li>想要在一个 View 绘制完成之后添加其他依赖于这个 View 的 View，当然这个用View.post()也能实现，区别就是前者会在消息队列空闲时执行</li>
<li>发送一个返回 true 的 IdleHandler，在里面让某个 View 不停闪烁，这样当用户发呆时就可以诱导用户点击这个View，这也是种很酷的操作<h4 id="IdelHandler注意事项"><a href="#IdelHandler注意事项" class="headerlink" title="IdelHandler注意事项"></a>IdelHandler注意事项</h4></li>
<li>MessageQueue 提供了add&#x2F;remove IdleHandler方法，但是我们不一定需要成对使用它们，因为IdleHandler.queueIdle() 的返回值返回 false 的时候可以移除 IdleHanlder。</li>
<li>不要将一些不重要的启动服务放到 IdleHandler 中去管理，因为它的处理时机不可控，如果 MessageQueue 一直有待处理的消息，那么它的执行时机会很靠后。</li>
<li>当 mIdleHanders 一直不为空时，为什么不会进入死循环？  <ul>
<li>只有在 pendingIdleHandlerCount 为 -1 时，才会尝试执行 mIdleHander；  </li>
<li>pendingIdlehanderCount 在 next() 中初始时为 -1，执行一遍后被置为 0，所以不会重复执行；</li>
</ul>
</li>
</ol>
<h2 id="启动模式"><a href="#启动模式" class="headerlink" title="启动模式"></a>启动模式</h2><h3 id="Activity-的任务栈"><a href="#Activity-的任务栈" class="headerlink" title="Activity 的任务栈"></a>Activity 的任务栈</h3><p><code>AndroidManifest.xml</code>的<code>activity</code>标签中加<code>taskAffinity=&quot;xxx&quot;</code>，不同<code>taskAffinity</code>创建不同栈</p>
<h3 id="使用Intent标志"><a href="#使用Intent标志" class="headerlink" title="使用Intent标志"></a>使用Intent标志</h3><ul>
<li><code>FLAG_ACTIVITY_NEW_TASK</code>	同<code>singleTask</code></li>
<li><code>FLAG_ACTIVITY_SINGLE_TOP</code>	同<code>singleTop</code></li>
<li><code>FLAG_ACTIVITY_CLEAR_TOP</code><br>如果正在启动的activity已在当前task中运行，则不会启动该activity的新实例，而是销毁其上的activity，并调用其onNewIntent()</li>
</ul>
<h3 id="启动模式的类型和特性"><a href="#启动模式的类型和特性" class="headerlink" title="启动模式的类型和特性"></a>启动模式的类型和特性</h3><h4 id="standard"><a href="#standard" class="headerlink" title="standard"></a>standard</h4><p>系统在启动它的任务中创建activity的新实例</p>
<h4 id="singleTop"><a href="#singleTop" class="headerlink" title="singleTop"></a>singleTop</h4><p>如果activity的实例已存在于当前任务的顶部，则系统通过调用其onNewIntent()</p>
<h4 id="singleTask"><a href="#singleTask" class="headerlink" title="singleTask"></a>singleTask</h4><p>系统创建新task并在task的根目录下实例化activity。但如果activity的实例已存在于单独的任务中，则调用其onNewIntent()方法。一次只能存在一个activity实例</p>
<h4 id="singleInstance"><a href="#singleInstance" class="headerlink" title="singleInstance"></a>singleInstance</h4><p>相同”singleTask”，activity始终是其task的唯一成员; 任何由此开始的activity都在一个单独的task中打开</p>
<h2 id="启动过程"><a href="#启动过程" class="headerlink" title="启动过程"></a>启动过程</h2><p><img src="/posts/2849937748/Activity%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B.png" alt="安卓/Activity启动过程"></p>
<h3 id="ActivityThread-java"><a href="#ActivityThread-java" class="headerlink" title="ActivityThread.java"></a>ActivityThread.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Activity <span class="title function_">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">ActivityInfo</span> <span class="variable">aInfo</span> <span class="operator">=</span> r.activityInfo;</span><br><span class="line">    <span class="keyword">if</span> (r.packageInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//step 1: 创建LoadedApk对象</span></span><br><span class="line">        r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</span><br><span class="line">                Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">    &#125;</span><br><span class="line">    ... <span class="comment">//component初始化过程</span></span><br><span class="line">    java.lang.<span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> r.packageInfo.getClassLoader();</span><br><span class="line">    <span class="comment">//step 2: 创建Activity对象</span></span><br><span class="line">    <span class="type">Activity</span> <span class="variable">activity</span> <span class="operator">=</span> mInstrumentation.newActivity(cl, component.getClassName(), r.intent);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//step 3: 创建Application对象</span></span><br><span class="line">    <span class="type">Application</span> <span class="variable">app</span> <span class="operator">=</span> r.packageInfo.makeApplication(<span class="literal">false</span>, mInstrumentation);</span><br><span class="line">    <span class="keyword">if</span> (activity != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//step 4: 创建ContextImpl对象</span></span><br><span class="line">        <span class="type">Context</span> <span class="variable">appContext</span> <span class="operator">=</span> createBaseContextForActivity(r, activity);</span><br><span class="line">        <span class="type">CharSequence</span> <span class="variable">title</span> <span class="operator">=</span> r.activityInfo.loadLabel(appContext.getPackageManager());</span><br><span class="line">        <span class="type">Configuration</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>(mCompatConfiguration);</span><br><span class="line">        <span class="comment">//step5: 将Application/ContextImpl都attach到Activity对象 [见小节4.1]</span></span><br><span class="line">        activity.attach(appContext, <span class="built_in">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                r.referrer, r.voiceInteractor);</span><br><span class="line">        ...</span><br><span class="line">        <span class="type">int</span> <span class="variable">theme</span> <span class="operator">=</span> r.activityInfo.getThemeResource();</span><br><span class="line">        <span class="keyword">if</span> (theme != <span class="number">0</span>) &#123;</span><br><span class="line">            activity.setTheme(theme);</span><br><span class="line">        &#125;</span><br><span class="line">        activity.mCalled = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">            <span class="comment">//step 6: 执行回调onCreate</span></span><br><span class="line">            mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">        &#125;</span><br><span class="line">        r.activity = activity;</span><br><span class="line">        r.stopped = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">            activity.performStart(); <span class="comment">//执行回调onStart</span></span><br><span class="line">            r.stopped = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">            <span class="comment">//执行回调onRestoreInstanceState</span></span><br><span class="line">            <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r.state != <span class="literal">null</span> || r.persistentState != <span class="literal">null</span>) &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state,</span><br><span class="line">                            r.persistentState);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.state != <span class="literal">null</span>) &#123;</span><br><span class="line">                mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        r.paused = <span class="literal">true</span>;</span><br><span class="line">        mActivities.put(r.token, r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Activity-组件之间的通信"><a href="#Activity-组件之间的通信" class="headerlink" title="Activity 组件之间的通信"></a>Activity 组件之间的通信</h2><h3 id="Activity–》Activity"><a href="#Activity–》Activity" class="headerlink" title="Activity–》Activity"></a>Activity–》Activity</h3><ul>
<li>Intent&#x2F;Bundle</li>
<li>类的静态变量</li>
<li>全局变量</li>
</ul>
<h3 id="Activity–》Service"><a href="#Activity–》Service" class="headerlink" title="Activity–》Service"></a>Activity–》Service</h3><ul>
<li>绑定服务，利用 ServiceConnection类</li>
<li>Intent</li>
<li>Callback+Handler，监听Service 进程变化</li>
</ul>
<h3 id="Activity–》Fragment"><a href="#Activity–》Fragment" class="headerlink" title="Activity–》Fragment"></a>Activity–》Fragment</h3><ul>
<li>Bundle</li>
<li>直接调用方法</li>
</ul>
<h3 id="Activity之间通过Intent的通信"><a href="#Activity之间通过Intent的通信" class="headerlink" title="Activity之间通过Intent的通信"></a>Activity之间通过Intent的通信</h3><p><code>Intent</code>有两个最重要的部分：动作和动作对应的数据</p>
<ul>
<li>典型的动作类型：<ul>
<li><code>MAIN</code>（activity的门户）</li>
<li><code>VIEW</code></li>
<li><code>PICK</code></li>
<li><code>EDIT</code></li>
</ul>
</li>
<li>动作对应的数据则以<code>URI</code>的形式进行表示。例如：要查看一个人的联系方式，需要创建一个动作类型为<code>VIEW</code>的<code>intent</code>，以及一个表示这个人的<code>URI</code></li>
<li>与之有关系的一个类<code>IntentFilter</code>，用于描述一个<code>activity</code>（或者<code>IntentReceiver</code>）能够操作哪些<code>intent</code></li>
</ul>
<h2 id="Scheme跳转协议"><a href="#Scheme跳转协议" class="headerlink" title="Scheme跳转协议"></a>Scheme跳转协议</h2><p><code>AndroidManifest.xml</code>清单文件中定义:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;.launcher.activity.LauncherActivity&quot;</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:configChanges</span>=<span class="string">&quot;orientation|screenSize|keyboardHidden&quot;</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:launchMode</span>=<span class="string">&quot;singleTask&quot;</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:screenOrientation</span>=<span class="string">&quot;portrait&quot;</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:theme</span>=<span class="string">&quot;@style/WithBgTheme&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.VIEW&quot;</span> /&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.DEFAULT&quot;</span> /&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.BROWSABLE&quot;</span> /&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">data</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:host</span>=<span class="string">&quot;597.com&quot;</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:scheme</span>=<span class="string">&quot;im597&quot;</span> /&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.VIEW&quot;</span> /&gt;</span> <span class="comment">&lt;!-- 显示数据 --&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.DEFAULT&quot;</span> /&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.BROWSABLE&quot;</span> /&gt;</span> <span class="comment">&lt;!-- 定义成浏览器类型，有URL需要处理时会过滤 --&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:scheme</span>=<span class="string">&quot;com597&quot;</span> /&gt;</span> <span class="comment">&lt;!-- 打开以com597协议的URL,这个自己随便定义。 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>跳转链接：</p>
<ul>
<li>简历页面 <a target="_blank" rel="noopener" href="https://m.597.com/download/app/?act=resume&rid=d5de934017675&userType=2">https://m.597.com/download/app/?act=resume&rid=d5de934017675&userType=2</a>  </li>
<li>职位管理页面 <a target="_blank" rel="noopener" href="https://m.597.com/download/app/?act=jobManage&userType=2">https://m.597.com/download/app/?act=jobManage&userType=2</a><br>代码中处理：  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	<span class="keyword">if</span> (BaseAppCache.getLauncherIntent() != <span class="literal">null</span>) &#123;  </span><br><span class="line">	    doIntent(BaseAppCache.getLauncherIntent());  </span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">	    doIntent(getIntent());  </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onRestart</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="built_in">super</span>.onRestart();  </span><br><span class="line">    AppActivityMgr.INST.finishOtherActivity(<span class="built_in">this</span>);  </span><br><span class="line">    <span class="keyword">if</span> (BaseAppCache.getLauncherIntent() != <span class="literal">null</span>) &#123;  </span><br><span class="line">        doIntent(BaseAppCache.getLauncherIntent());  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        doIntent(getIntent());  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 启动页 的广告页面点击事件  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doIntent</span><span class="params">(Intent intent)</span> &#123;  </span><br><span class="line">    <span class="keyword">if</span> (intent != <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">if</span> (intent.hasExtra(NimIntent.EXTRA_NOTIFY_CONTENT)) &#123;  </span><br><span class="line">            <span class="comment">//... </span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (intent.getData() != <span class="literal">null</span>) &#123;  </span><br><span class="line">            checkOutLinkIntent(intent);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    BaseAppCache.setLauncherIntent(<span class="literal">null</span>);  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * * <span class="doctag">@param</span> intent  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkOutLinkIntent</span><span class="params">(Intent intent)</span> &#123;  </span><br><span class="line">    <span class="type">Uri</span> <span class="variable">data</span> <span class="operator">=</span> intent.getData();  </span><br><span class="line">    <span class="keyword">if</span> (data != <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">act</span> <span class="operator">=</span> data.getQueryParameter(<span class="string">&quot;act&quot;</span>);  </span><br><span class="line">        <span class="keyword">if</span> (TextUtils.equals(act, <span class="string">&quot;jobManage&quot;</span>)) &#123;  </span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (TextUtils.equals(act, <span class="string">&quot;resume&quot;</span>))&#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">rid</span> <span class="operator">=</span> data.getQueryParameter(<span class="string">&quot;rid&quot;</span>);  </span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="源码解读-startActivity-都做了什么"><a href="#源码解读-startActivity-都做了什么" class="headerlink" title="源码解读 startActivity 都做了什么"></a>源码解读 startActivity 都做了什么</h2><h1 id="Android启动过程"><a href="#Android启动过程" class="headerlink" title="Android启动过程"></a>Android启动过程</h1><h2 id="Activity生命周期解析"><a href="#Activity生命周期解析" class="headerlink" title="Activity生命周期解析"></a>Activity生命周期解析</h2><p>Activity：直译为“活动”，翻译成“界面”会更好理解。</p>
<h3 id="典型情况下的生命周期分析"><a href="#典型情况下的生命周期分析" class="headerlink" title="典型情况下的生命周期分析"></a>典型情况下的生命周期分析</h3><p><strong>onCreate</strong>：Activity正被创建，生命周期第一个方法。可做些初始化工作：setContentView、初始化Activity所需数据。<br><strong>onRestart</strong>：Activity正被重新启动。一般从当前Activity不可见重新变为可见时触发。如：用户按Home切换到桌面再回来。<br><strong>onStart</strong>：Activity正被启动，Activity可见了，未出现在前台，还无法与用户交互。<br><strong>onResume</strong>：Activity可见了，出现在前台并开始活动，可与用户交互了。<br><strong>onPause</strong>：Activity正在停止，正常情况会紧接着调用onStop。特殊情况，快速再回到当前Activity（用户很难重现这一场景）。可做些存储数据、停止动画等工作，但不能太耗时（因为onPause走完才执行新Activity的onResume。太耗时会影响新Activity的显示）<br><strong>onStop</strong>：Activity即将停止。可做些稍微重量级的回收工作，不能太耗时。<br><strong>onDestory</strong>：Activity即将被销毁，Activity生命周期的最后一个回调。可做些回收工作和最终的资源释放。</p>
<p><img src="/posts/2849937748/Activity%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%9A%84%E5%88%87%E6%8D%A2%E8%BF%87%E7%A8%8B.jpg" alt="Activity生命周期的切换过程"></p>
<h4 id="正常情况下启动"><a href="#正常情况下启动" class="headerlink" title="正常情况下启动"></a>正常情况下启动</h4><ul>
<li><code>Activity A</code> 启动另一个<code>Activity B</code>，回调如下:<br>  <code>Activity A</code> 的<code>onPause()</code> → <code>Activity B</code>的<code>onCreate()</code> → <code>onStart()</code> → <code>onResume()</code> → <code>Activity A</code>的<code>onStop()</code>；如果B是<strong>透明</strong>主题又或则是个<code>DialogActivity</code> ，则不会回调A的<code>onStop</code>；</li>
<li>使用<code>onSaveInstanceState()</code>保存简单，轻量级的UI状态<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">lateinit <span class="keyword">var</span> textView: TextView</span><br><span class="line"><span class="keyword">var</span> gameState: String? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">override fun <span class="title function_">onCreate</span><span class="params">(savedInstanceState: Bundle?)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState)</span><br><span class="line">    gameState = savedInstanceState?.getString(GAME_STATE_KEY)</span><br><span class="line">    setContentView(R.layout.activity_main)</span><br><span class="line">    textView = findViewById(R.id.text_view)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">override fun <span class="title function_">onRestoreInstanceState</span><span class="params">(savedInstanceState: Bundle?)</span> &#123;</span><br><span class="line">    textView.text = savedInstanceState?.getString(TEXT_VIEW_KEY)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">override fun <span class="title function_">onSaveInstanceState</span><span class="params">(outState: Bundle?)</span> &#123;</span><br><span class="line">    outState?.run &#123;</span><br><span class="line">        putString(GAME_STATE_KEY, gameState)</span><br><span class="line">        putString(TEXT_VIEW_KEY, textView.text.toString())</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">super</span>.onSaveInstanceState(outState)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="几种情况："><a href="#几种情况：" class="headerlink" title="几种情况："></a>几种情况：</h4><ol>
<li>针对一个特定的<code>Activity</code>，第一次启动，回调：<code>onCreate</code>–&gt;<code>onStart</code>–&gt;<code>onResume</code></li>
<li>当打开新Activity或切换到桌面时，回调：<code>onPause</code>–&gt;<code>onStop</code>。若新<code>Activity</code>采用&#x3D;&#x3D;透明主题（或是个<code>DialogActivity</code>）&#x3D;&#x3D;，那么当前<code>Activity</code>不会回调<code>onStop</code></li>
<li>当再次回到原<code>Activity</code>时，回调：<code>onStart</code>–&gt;<code>onStart</code>–&gt;<code>onResume</code></li>
<li>当按<code>back</code>回退时，回调：<code>onPause</code>–&gt;<code>onStop</code>–&gt;<code>onDestory</code></li>
<li>当<code>Activity</code>被系统回收后再次打开，生命周期与1一样。<strong>注意，只是生命周期方法一样，不代表所有过程都一样</strong></li>
<li>从整个生命周期看<code>onCreate</code>和<code>onDestory</code>是配对的，只调一次。从<code>Activity</code>是否可见看，<code>onStart</code>和<code>onStop</code>是配对的，随用户的操作或设备息屏亮屏会调用多次。从<code>Activity</code>是否在前台看，<code>onResume</code>和<code>onPause</code>是配对的，随用户操作和息屏亮屏会调用多次。</li>
</ol>
<h4 id="两个问题"><a href="#两个问题" class="headerlink" title="两个问题"></a>两个问题</h4><ol>
<li><code>onStart</code>和<code>onResume</code>、<code>onPause</code>和<code>onStop</code>从描述上来看差不多，对我们来说有什么实质的不同呢？</li>
<li>假设当前<code>Activity为A</code>，如果这是用户打开一个新<code>ActivityB</code>，那么B的<code>onResume</code>和A的<code>onPause</code>哪个先执行呢？</li>
</ol>
<p>答案：</p>
<ol>
<li>第一个问题：实际使用我们甚至只保留其中一对。从设计层面分析，<code>onStart</code>和<code>onStop</code>应用于<code>Activity</code>是否可见这个角度；<code>onResume</code>和<code>onPause</code>应用于<code>Activity</code>是否位于前台这个角度。</li>
<li>第二个问题：<code>Activity</code>启动的请求会由<code>Instrumentation</code>来处理，然后它通过<code>Binder</code>向<code>ActivityManagerServie</code>（简称<code>AMS</code>）发请求，<code>AMS</code>内部维护一个<code>ActivityStack</code>并负责栈内的<code>Activity</code>的状态同步，<code>AMS</code>通过<code>ActivityThread</code>去同步<code>Activity</code>的状态从而完成生命周期方法的调用。</li>
</ol>
<h3 id="异常情况下的生命周期分析"><a href="#异常情况下的生命周期分析" class="headerlink" title="异常情况下的生命周期分析"></a>异常情况下的生命周期分析</h3><p>比如当资源相关的系统配置发生改变以及系统内存不足时，<code>Activity</code>就可能被杀死。下面由这两种情况进行具体分析：</p>
<ol>
<li><p>情况1：资源相关的系统配置发生改变导致<code>Activity</code>被杀死并重新创建<br> 比如旋转屏幕，由于系统配置发生了改变，默认情况下<code>Activity</code>会被销毁并且重新创建，当然我们也可以阻止系统重新创建我们的<code>Activity</code>。<br> <img src="/posts/2849937748/%E5%BC%82%E5%B8%B8%E6%83%85%E5%86%B5%E4%B8%8BActivity%E7%9A%84%E9%87%8D%E5%BB%BA%E8%BF%87%E7%A8%8B.jpg" alt="异常情况下Activity的重建过程"><br> 会调用<code>onPause</code>、<code>onStop</code>、<code>onDestroy</code>，其中可能<code>onPause</code>–&gt;<code>onSaveInstanceState</code>–&gt;<code>onStop</code>，<code>也可能onSaveInstanceState</code>–&gt;<code>onPause</code>–&gt;<code>onStop</code>。<code>onRestoreInstanceState</code>在<code>onStart</code>之后  </p>
<p><code>Activity</code>被意外终止时，<code>Activity</code>会调用<code>onSaveInstanceState</code>去保存数据，然后<code>Activity</code>会委托<code>Window</code>去保存数据，接着<code>Window</code>再委托它上面的顶级容器（是一个<code>ViewGroup</code>很可能是<code>DecorView</code>）去保存数据。最后顶层容器再去意义通知它的子元素来保存数据。–》典型的委托思想：上层委托下层、父容器委托子元素去处理一件事情，这种思想还应用在<code>View</code>的绘制过程、事件分发等。数据恢复过程也是类似。</p>
<p><code>onCreate</code>和<code>onRestoreInstanceState</code>中都可以恢复数据，官方推荐用<code>onRestoreInstanceState</code></p>
</li>
<li><p>资源内存不足导致低优先级的<code>Activity</code>被杀死</p>
<p><code>Activity</code>优先级：</p>
<ul>
<li><code>前台Activity</code>–正在和用户交互的Activity，优先级最高</li>
<li>可见但非前台Activity–比如Activity中弹出一个对话框，导致Activity可见但是位于后台无法和用户直接交互</li>
<li>后台Activity–已经被暂停的Activity，比如执行了<code>onStop</code>，优先级最低</li>
</ul>
<p>如果一个进行中如果没有四大组件在执行，此进程将很快被系统杀死，故一些后台工作不适合脱离四大组件而独自运行在后台中。较好的方式是放入<code>Service</code>中</p>
</li>
</ol>
<p>不想重新创建<code>Activity</code></p>
<p>给<code>Activity</code>指定<code>configChanges</code>属性。比如不想让<code>Activity</code>在旋转时重建 <code>android:configChanges=&quot;orientation&quot;</code></p>
<p><img src="/posts/2849937748/configChanges%E7%9A%84%E9%A1%B9%E7%9B%AE%E5%92%8C%E5%90%AB%E4%B9%89.jpg" alt="configChanges的项目和含义"></p>
<p>我们常用到的<code>configChanges</code>属性有<code>locale</code>、<code>orientation</code>、<code>keyboardHidden</code></p>
<p>注意<code>screenSize</code>和<code>smallestScreenSize</code>笔记特殊，它们的行为与编译选项有关，与运行环境无关。</p>
<p>如：<code>minSdkVersion</code>和<code>targetSdkVersion</code>有一个大于13，在旋转屏幕时不重建<code>Activity</code>要加<code>orientation</code>还要加<code>screenSize</code>，最终调<code>onConfigurationchanged</code>方法</p>
<h2 id="Activity的启动模式"><a href="#Activity的启动模式" class="headerlink" title="Activity的启动模式"></a>Activity的启动模式</h2><ul>
<li><strong>standard</strong>：标准模式。不管此实例是否存在都会重建一个新的实例。当用<code>ApplicationContext</code>（没有所谓的任务栈）去启动standard模式的Activity会报错“android.util.AndroidRuntimeException:Calling startActivity from outside of an Activity context requires the FLAG_ACTIVITY_NEW_TASK flag. Is this really what you want?”。如果加了“FLAG_ACTIVITY_NEW_TASK”其实是以singleTask模式启动的。</li>
<li><strong>singleTop</strong>：栈顶复用模式。若新Activity已位于栈顶，则不会重建，会回调onNewIntent方法（可以取出当前请求的信息），<strong>注意：这个Activity的onCreate、onStart不会被系统调用</strong></li>
<li><strong>singleTask</strong>：栈内复用模式。若Activity在栈中存在则不会重建，会回调onNewIntent。<br>具体例子：<br>1. 任务栈S1中有ABC，此时ActivityD以singleTask模式请求启动，其所需要的任务栈为S2，由于S2和D实例都不存在，那么会先创建S2，再创建D并将其入栈到S2<br>2. 任务栈S1中有ABC，此时ActivityD以singleTask模式请求启动，其所需要的任务栈为S1，由于S1已存在，那么系统直接创建D并将其入栈到S1<br>3. 任务栈S1中有ADBC，此时D不会重建，系统会把D切换到栈顶并调用其onNewIntent，同时singleTask具有clearTop效果。最终S1中是AD  </li>
<li><strong>singleInstance</strong>：单实例模式。一种加强的singleTask模式，具有singleTask所有特性外，加强了一点，此模式的Activity只能单独位于一个任务栈中。由于栈内复用的特性，后续的请求均不会重建新Activity，除非此任务栈被系统销毁了。<br>  <img src="/posts/2849937748/%E7%89%B9%E6%AE%8A%E4%BB%BB%E5%8A%A1%E6%A0%881.jpg" alt="特殊任务栈1"><br>  <img src="/posts/2849937748/%E7%89%B9%E6%AE%8A%E4%BB%BB%E5%8A%A1%E6%A0%882.jpg" alt="特殊任务栈2"></li>
</ul>
<table>
<thead>
<tr>
<th align="left">LaunchMode</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">standard</td>
<td align="left">系统在启动它的任务中创建activity的新实例</td>
</tr>
<tr>
<td align="left">singleTop</td>
<td align="left">如果activity的实例已存在于当前任务的顶部，则系统通过调用其onNewIntent()</td>
</tr>
<tr>
<td align="left">singleTask</td>
<td align="left">系统创建新task并在task的根目录下实例化activity。但如果activity的实例已存在于单独的任务中，则调用其onNewIntent()方法。一次只能存在一个activity实例</td>
</tr>
<tr>
<td align="left">singleInstance</td>
<td align="left">相同”singleTask”，activity始终是其task的唯一成员; 任何由此开始的activity都在一个单独的task中打开</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="left">使用Intent标志</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">FLAG_ACTIVITY_NEW_TASK</td>
<td align="left">同singleTask</td>
</tr>
<tr>
<td align="left">FLAG_ACTIVITY_SINGLE_TOP</td>
<td align="left">同singleTop</td>
</tr>
<tr>
<td align="left">FLAG_ACTIVITY_CLEAR_TOP</td>
<td align="left">如果正在启动的activity已在当前task中运行，则不会启动该activity的新实例，而是销毁其上的activity，并调用其onNewIntent()</td>
</tr>
</tbody></table>
<p><strong>注意：</strong>  </p>
<ol>
<li>上面说的不同栈，要在AndroidManifest.xml的activity中加 taskAffinity&#x3D;”xxx”，不同taskAffinity会创建不同栈。（注意其中xxx要直接写，不能写@string&#x2F;xxx）</li>
<li>打印taskId的代码 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onResume</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onResume();</span><br><span class="line">     getActivityTaskInfo();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">getActivityTaskInfo</span><span class="params">()</span> &#123;</span><br><span class="line">     <span class="type">ActivityManager</span> <span class="variable">manager</span> <span class="operator">=</span> (ActivityManager) getSystemService(Context.ACTIVITY_SERVICE);</span><br><span class="line">     ActivityManager.<span class="type">RunningTaskInfo</span> <span class="variable">runningTaskInfo</span> <span class="operator">=</span> manager.getRunningTasks(<span class="number">1</span>).get(<span class="number">0</span>);</span><br><span class="line">     <span class="comment">//栈内activity数量</span></span><br><span class="line">     <span class="type">int</span> <span class="variable">numActivities</span> <span class="operator">=</span> runningTaskInfo.numActivities;</span><br><span class="line">     <span class="comment">//taskId</span></span><br><span class="line">     <span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> runningTaskInfo.id;</span><br><span class="line">     <span class="type">ComponentName</span> <span class="variable">topActivity</span> <span class="operator">=</span> runningTaskInfo.topActivity;</span><br><span class="line">     <span class="comment">//栈顶activity信息</span></span><br><span class="line">     <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> topActivity.getClassName();</span><br><span class="line">     Log.e(<span class="string">&quot;activityTask&quot;</span>, <span class="string">&quot;id == &quot;</span> + id + <span class="string">&quot;\n&quot;</span> + <span class="string">&quot;numActivity == &quot;</span> + numActivities + <span class="string">&quot;\n&quot;</span> + <span class="string">&quot;className == &quot;</span> + className);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="IntentFilter的匹配规则"><a href="#IntentFilter的匹配规则" class="headerlink" title="IntentFilter的匹配规则"></a>IntentFilter的匹配规则</h2><p>启动Activity：显式调用、隐式调用。理论上两者不共存，若共存则以显式调用为主。<br>隐式调用需Intent能匹配目标组件的IntentFilter中所设置的过滤信息。IntentFilter过滤信息有action、category、data<br>举例：  </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:name</span>=<span class="string">&quot;com.ab.chapter_1.ThirdActivity&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:configChanges</span>=<span class="string">&quot;screenLayout&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:launcherMode</span>=<span class="string">&quot;singleTask&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:taskAffinity</span>=<span class="string">&quot;com.ab.task1&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.ab.chapter_1.c&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.ab.chapter_1.d&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">andorid:name</span>=<span class="string">&quot;com.ab.category.c&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">andorid:name</span>=<span class="string">&quot;com.ab.category.d&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:mimeType</span>=<span class="string">&quot;text/plain&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以有多个action、category、data。一个Intent只有同时匹配action、category、data才能进行跳转。<br>Intent必须要有一个action与过滤规则中的某个action相同。<br>Intent可以没有category。<br>若过滤规则中定义了data（两部分组成：mimeType和URI），那么Intent中必须也要定义可匹配的data。<br>​	mimeType指媒体类型比如image&#x2F;jpeg、audio&#x2F;mpeg4-generic、video&#x2F;*等。<br>​	多个data的内容可以写到同一个data内</p>
</blockquote>
<p>Intent-filter的匹配规则对于Service和BroadcastReceiver也是同样的道理，不过对于Service建议使用显式调用方式来启动服务。</p>
<p>隐式方式启动Activity时还需要加判断：PackageManager的resolveActivity()或Intent的resolveActivity()（返回最佳匹配的Activity），否则找不到匹配的Activity会返回null。PackageManager的queryIntentActivitites会返回所有成功匹配的Activity信息。</p>
<h2 id="启动过程-1"><a href="#启动过程-1" class="headerlink" title="启动过程"></a>启动过程</h2><p><img src="/posts/2849937748/Activity%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B.jpg" alt="Activity启动过程"></p>
<p><code>ActivityThread.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Activity <span class="title function_">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">ActivityInfo</span> <span class="variable">aInfo</span> <span class="operator">=</span> r.activityInfo;</span><br><span class="line">    <span class="keyword">if</span> (r.packageInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//step 1: 创建LoadedApk对象</span></span><br><span class="line">        r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</span><br><span class="line">                Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">    &#125;</span><br><span class="line">    ... <span class="comment">//component初始化过程</span></span><br><span class="line"></span><br><span class="line">    java.lang.<span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> r.packageInfo.getClassLoader();</span><br><span class="line">    <span class="comment">//step 2: 创建Activity对象</span></span><br><span class="line">    <span class="type">Activity</span> <span class="variable">activity</span> <span class="operator">=</span> mInstrumentation.newActivity(cl, component.getClassName(), r.intent);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//step 3: 创建Application对象</span></span><br><span class="line">    <span class="type">Application</span> <span class="variable">app</span> <span class="operator">=</span> r.packageInfo.makeApplication(<span class="literal">false</span>, mInstrumentation);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (activity != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//step 4: 创建ContextImpl对象</span></span><br><span class="line">        <span class="type">Context</span> <span class="variable">appContext</span> <span class="operator">=</span> createBaseContextForActivity(r, activity);</span><br><span class="line">        <span class="type">CharSequence</span> <span class="variable">title</span> <span class="operator">=</span> r.activityInfo.loadLabel(appContext.getPackageManager());</span><br><span class="line">        <span class="type">Configuration</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>(mCompatConfiguration);</span><br><span class="line">        <span class="comment">//step5: 将Application/ContextImpl都attach到Activity对象 [见小节4.1]</span></span><br><span class="line">        activity.attach(appContext, <span class="built_in">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                r.referrer, r.voiceInteractor);</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">        <span class="type">int</span> <span class="variable">theme</span> <span class="operator">=</span> r.activityInfo.getThemeResource();</span><br><span class="line">        <span class="keyword">if</span> (theme != <span class="number">0</span>) &#123;</span><br><span class="line">            activity.setTheme(theme);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        activity.mCalled = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">            <span class="comment">//step 6: 执行回调onCreate</span></span><br><span class="line">            mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        r.activity = activity;</span><br><span class="line">        r.stopped = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">            activity.performStart(); <span class="comment">//执行回调onStart</span></span><br><span class="line">            r.stopped = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">            <span class="comment">//执行回调onRestoreInstanceState</span></span><br><span class="line">            <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r.state != <span class="literal">null</span> || r.persistentState != <span class="literal">null</span>) &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state,</span><br><span class="line">                            r.persistentState);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.state != <span class="literal">null</span>) &#123;</span><br><span class="line">                mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        r.paused = <span class="literal">true</span>;</span><br><span class="line">        mActivities.put(r.token, r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h1 id="Activity的其他笔记"><a href="#Activity的其他笔记" class="headerlink" title="Activity的其他笔记"></a>Activity的其他笔记</h1><h2 id="android属性之clearTaskOnLaunch"><a href="#android属性之clearTaskOnLaunch" class="headerlink" title="android属性之clearTaskOnLaunch"></a>android属性之clearTaskOnLaunch</h2><p>需求：每次从桌面进入app都是打开根Activity<br>要求：在AndroidManifest.xml中，在根Activity中添加 <code>clearTaskOnLaunch</code> 属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="line">&lt;manifest xmlns:android=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="line">    <span class="keyword">package</span>=<span class="string">&quot;com.example.administrator.myapplication&quot;</span>&gt;</span><br><span class="line"> </span><br><span class="line">    &lt;application</span><br><span class="line">        android:allowBackup=<span class="string">&quot;true&quot;</span></span><br><span class="line">        android:icon=<span class="string">&quot;@mipmap/ic_launcher&quot;</span></span><br><span class="line">        android:label=<span class="string">&quot;@string/app_name&quot;</span></span><br><span class="line">        android:supportsRtl=<span class="string">&quot;true&quot;</span></span><br><span class="line">        android:theme=<span class="string">&quot;@style/AppTheme&quot;</span>&gt;</span><br><span class="line">        &lt;activity</span><br><span class="line">            android:name=<span class="string">&quot;.MainActivity&quot;</span></span><br><span class="line"></span><br><span class="line">            android:clearTaskOnLaunch=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">            &lt;intent-filter&gt;</span><br><span class="line">                &lt;action android:name=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span><br><span class="line">                &lt;category android:name=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span><br><span class="line">            &lt;/intent-filter&gt;</span><br><span class="line">        &lt;/activity&gt;</span><br><span class="line">        &lt;activity android:name=<span class="string">&quot;.ActivityTest&quot;</span>&gt;</span><br><span class="line">            &lt;intent-filter&gt;</span><br><span class="line">                &lt;action android:name=<span class="string">&quot;yayun&quot;</span> /&gt;</span><br><span class="line">                &lt;category android:name=<span class="string">&quot;android.intent.category.DEFAULT&quot;</span> /&gt;</span><br><span class="line">            &lt;/intent-filter&gt;</span><br><span class="line">        &lt;/activity&gt;</span><br><span class="line">    &lt;/application&gt;</span><br><span class="line">&lt;/manifest&gt;</span><br></pre></td></tr></table></figure>

<h2 id="android属性之alwaysRetainTaskState"><a href="#android属性之alwaysRetainTaskState" class="headerlink" title="android属性之alwaysRetainTaskState"></a>android属性之alwaysRetainTaskState</h2><p>常用于浏览器，用来保存浏览状态（打开很多tab），用户再次启动浏览器还能看到之前的状态<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/tao_zi7890/article/details/20064889">原文链接</a>  </p>
<ol>
<li>android:allowTaskReparenting  这个属性用来标记一个Activity实例在当前应用退居后台后，是否能从启动它的那个task移动到有共同affinity的task，“true”表示可以移动，“false”表示它必须呆在当前应用的task中，默认值为false。如果一个这个Activity的元素没有设定此属性，设定在上的此属性会对此Activity起作用。例如在一个应用中要查看一个web页面，在启动系统浏览器Activity后，这个Activity实例和当前应用处于同一个task，当我们的应用退居后台之后用户再次从主选单中启动应用，此时这个Activity实例将会重新宿主到Browser应用的task内，在我们的应用中将不会再看到这个Activity实例，而如果此时启动Browser应用，就会发现，第一个界面就是我们刚才打开的web页面，证明了这个Activity实例确实是宿主到了Browser应用的task内。 </li>
<li>android:alwaysRetainTaskState  这个属性用来标记应用的task是否保持原来的状态，“true”表示总是保持，“false”表示不能够保证，默认为“false”。此属性只对task的根Activity起作用，其他的Activity都会被忽略。  默认情况下，如果一个应用在后台呆的太久例如30分钟，用户从主选单再次选择该应用时，系统就会对该应用的task进行清理，除了根Activity，其他Activity都会被清除出栈，但是如果在根Activity中设置了此属性之后，用户再次启动应用时，仍然可以看到上一次操作的界面。 这个属性对于一些应用非常有用，例如Browser应用程序，有很多状态，比如打开很多的tab，用户不想丢失这些状态，使用这个属性就极为恰当。 </li>
<li>android:clearTaskOnLaunch  这个属性用来标记是否从task清除除根Activity之外的所有的Activity，“true”表示清除，“false”表示不清除，默认为“false”。同样，这个属性也只对根Activity起作用，其他的Activity都会被忽略。  如果设置了这个属性为“true”，每次用户重新启动这个应用时，都只会看到根Activity，task中的其他Activity都会被清除出栈。如果我们的应用中引用到了其他应用的Activity，这些Activity设置了allowTaskReparenting属性为“true”，则它们会被重新宿主到有共同affinity的task中。 </li>
<li>android:finishOnTaskLaunch  这个属性和android:allowReparenting属性相似，不同之处在于allowReparenting属性是重新宿主到有共同affinity的task中，而finishOnTaskLaunch属性是销毁实例。如果这个属性和android:allowReparenting都设定为“true”，则这个属性好些。</li>
</ol>
<h1 id="任务Task（hencoder）"><a href="#任务Task（hencoder）" class="headerlink" title="任务Task（hencoder）"></a>任务Task（hencoder）</h1><h2 id="任务的概念"><a href="#任务的概念" class="headerlink" title="任务的概念"></a><code>任务</code>的概念</h2><p>任务其实就是<code>activity</code> 的栈它由一个或多个<code>Activity</code>组成的共同完成一个完整的用户体验， 换句话说任务就是 “应用程序” （可以是一个也可以是多个，比如假设你想让用户看到某个地方的街道地图。而已经存在一个具有此功能的<code>activity</code> 了，那么你的<code>activity</code> 所需要做的工作就是把请求信息放到一个<code>Intent</code> 对象里面，并把它传递给<code>startActivity()</code>。于是地图浏览器就会显示那个地图。而当用户按下<code>BACK</code> 键的时候，你的<code>activity</code> 又会再一次的显示在屏幕上，此时任务是由2个应用程序中的相关<code>activity</code>组成的）栈底的是启动整个任务的<code>Activity</code>，栈顶的是当前运行的用户可以交互的<code>Activity</code>，当一个<code>activity</code> 启动另外一个的时候，新的<code>activity</code> 就被压入栈，并成为当前运行的<code>activity</code>。而前一个<code>activity</code> 仍保持在栈之中。当用户按下<code>BACK</code> 键的时候，当前<code>activity</code> 出栈，而前一个恢复为当前运行的<code>activity</code>。栈中保存的其实是对象，栈中的<code>Activity</code> 永远不会重排，只会压入或弹出，所以如果发生了诸如需要多个地图浏览器的情况，就会使得一个任务中出现多个同一<code>Activity</code> 子类的实例同时存在。  </p>
<p>任务中的所有<code>activity</code> 是作为一个整体进行移动的。整个的任务（即<code>activity 栈</code>）可以移到前台，或退至后台。举个例子说，比如当前任务在栈中存有四个<code>activity</code>──三个在当前<code>activity</code> 之下。当用户按下<code>HOME</code> 键的时候，回到了应用程序加载器，然后选择了一个新的应用程序（也就是一个新任务）。则当前任务遁入后台，而新任务的根<code>activity</code> 显示出来。然后，过了一小会儿，用户再次回到了应用程序加载器而又选择了前一个应用程序（上一个任务）。于是那个任务，带着它栈中所有的四个<code>activity</code>，再一次的到了前台。当用户按下<code>BACK</code> 键的时候，屏幕不会显示出用户刚才离开的<code>activity</code>（上一个任务的根<code>activity</code>）。取而代之，当前任务的栈中最上面的<code>activity</code> 被弹出，而同一任务中的上一个<code>activity</code> 显示了出来。</p>
<p><code>Activity栈</code>：先进后出规则<br><img src="/posts/2849937748/Activity%E6%A0%88.png" alt="安卓/Activity栈"></p>
<h2 id="Task工作模型、LaunchMode"><a href="#Task工作模型、LaunchMode" class="headerlink" title="Task工作模型、LaunchMode"></a>Task工作模型、LaunchMode</h2><p>观看扔物线《Android面试黑洞–当我按下Home键再切回来，会发生什么？》<br><a target="_blank" rel="noopener" href="https://b23.tv/bVmuXl">视频</a><br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/dbUXmkOd_VxmxExBSpkmyw">文章</a>  </p>
<h3 id="Task和回退栈"><a href="#Task和回退栈" class="headerlink" title="Task和回退栈"></a>Task和回退栈</h3><ul>
<li>按方块键查看最近任务，看到的就是一个个Task、任务</li>
<li>在桌面点击App图标时，配置了<code>MAIN</code>+<code>LAUNCHER</code>的<code>intent-filter</code>的<code>Activity</code>会被启动并放进刚创建的一个<code>Task</code>里</li>
<li>每个Task都有一个回退栈，它会按顺序记录用户打开的每个Activity，按回退键时会依次关闭Activity，当最后一个Activity被关闭则此Task声明也就结束了。但不会在最近任务列表里消失，仍会保留一个残影，方便下次切回去（要走App的重新创建流程）。–》<strong>“在最近任务里看见的Task未必还活着”</strong><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Standard、SingleTop：针对<span class="keyword">App</span>内</span><br><span class="line">SingleInstance：用于多<span class="keyword">App</span></span><br><span class="line">SingleTask：兼顾多<span class="keyword">App</span>和<span class="keyword">App</span>内</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Standard"><a href="#Standard" class="headerlink" title="Standard"></a>Standard</h3><p>App2的<code>BActivity</code>是标准模式。</p>
<ul>
<li>App2打开A、B；App1启动App2的<code>BActivity</code>，则App1的回退栈中有M、B(复制过来的一个新实例)。App2的回退栈中有A、B。<strong>即，标准模式下的Activity会复制多份，分别放到不同的Task中</strong></li>
</ul>
<h4 id="allowTaskReparenting"><a href="#allowTaskReparenting" class="headerlink" title="allowTaskReparenting"></a>allowTaskReparenting</h4><p>App2的<code>BActivity</code>是Standard，且加属性<code>allowTaskReparenting</code></p>
<ul>
<li>App1启动App2的<code>BActivity</code>，会在创建<code>BActivity</code>并把它挪到App1的Task栈顶。按下Home键，再切换到App2，此时<code>BActivity</code>会回到App2的Task栈顶。再切回App1看已经看不到<code>BActivity</code>了。</li>
<li>在Android9、10失效；在Android11上已修复。</li>
</ul>
<h3 id="SingleTask（唯一性：全局只有一个对象）"><a href="#SingleTask（唯一性：全局只有一个对象）" class="headerlink" title="SingleTask（唯一性：全局只有一个对象）"></a>SingleTask（唯一性：全局只有一个对象）</h3><p>App2的<code>BActivity</code>是SingleTask。</p>
<ul>
<li>App1启动App2的<code>BActivity</code>，此时<code>BActivity</code>会在App1自己的Task栈顶【此时会有切换App的动画】，而且<strong>App2的Task栈会叠加到App1的Task栈上面</strong>【Task叠加适用于前台Task】</li>
<li>当App1变成后台时（按方块键查看最近任务、按Home键），叠加的Task会拆开。<br>  注意：前台Task在<strong>最近任务列表显示出来的时候</strong>就已经进入后台，<strong>而不是在切换到其他应用之后</strong></li>
<li>App1启动App2的<code>BActivity</code>，若<code>BActivity</code>已经存在【复用】【调用onNewIntent】，则会把App2的Task栈叠加到App1的Task栈上，而且App2会移除<code>BActivity</code>上面的Activity，让<code>BActivity</code>处于栈顶</li>
</ul>
<h3 id="SingleInstance（唯一性，独占性）"><a href="#SingleInstance（唯一性，独占性）" class="headerlink" title="SingleInstance（唯一性，独占性）"></a>SingleInstance（唯一性，独占性）</h3><p>App2的<code>BActivity</code>是<code>SingleInstance</code>。</p>
<ul>
<li>具有singleTask所有特性，而且<code>BActivity</code><strong>独占一个Task</strong></li>
<li>App1启动App2的<code>BActivity</code>，此时<code>BActivity</code>会独占一个Task，也会叠加到App1的Task上</li>
<li>当App1变成后台时（按方块键查看最近任务、按Home键），叠加的Task会拆开，当在显示<code>BActivity</code>界面按回退键，再去看最近任务列表这个<code>BActivity</code>在最近任务里不可见了。但是它并没有被杀死，如果再次调起<code>BActivity</code>则走<code>onNewIntent</code>方法。–》<strong>”在最近任务里看不见的Task，也未必就死了“</strong></li>
<li>singleInstance模式的<code>BActivity</code>被藏起来是因为<code>taskAffinity</code>冲突了。</li>
</ul>
<h3 id="taskAffinity"><a href="#taskAffinity" class="headerlink" title="taskAffinity"></a>taskAffinity</h3><ul>
<li>在Android中，一个App默认只能有一个Task显示在最近任务列表里【由<code>taskAffinity</code>来甄别】。</li>
<li>每个<code>Activity</code>都有个<code>taskAffinity</code>，它的值取其所在<code>Application</code>的<code>taskAffinity</code>【默认取App的包名】</li>
<li>每个Task都有一个<code>taskAffinity</code>，取值自栈底<code>Activity</code>的<code>taskAffinity</code>。即，从打开的Activity界面调起个新的Activity【不管新Activity来自哪】，新Activity的taskAffinity会被忽略。但若<strong>新Activity</strong>是<code>singleTask</code>，则会和当前Task的<code>taskAffinity</code>比较<ul>
<li>若相同，依然正常入栈</li>
<li>若不同，<code>Activity</code>会寻找和它的<code>taskAffinity</code>值相同的Task，然后整个Task入栈。<ul>
<li>或者如果找不到，系统会为它创建一个新的Task</li>
</ul>
</li>
</ul>
</li>
<li>最近任务列表中出现的Task（任务）的<code>taskAffinity</code>值是不一样的。<strong>相同taskAffinity的Task可以被创建多个，但只会在最近任务列表里显示一个</strong>。即上面的<code>singleInstance</code>在最近任务列表里不可见是因为被相同<code>taskAffinity</code>替代了。</li>
</ul>
<h3 id="SingleTop"><a href="#SingleTop" class="headerlink" title="SingleTop"></a>SingleTop</h3><p>与<code>standard</code>比较相近，直接在当前<code>Task</code>（任务）上入栈。唯一区别：若要启动的<code>singleTop</code>的<code>Activity</code>已经打开，则调用其<code>onNewIntent</code>。<br>A：AActivity（Standard），B：BActivity（SingleTop）  </p>
<ol>
<li>A–&gt;B–&gt;B–&gt;A–&gt;B–&gt;A–&gt;A：栈中有ABABAA</li>
</ol>
<h1 id="setContentView过程"><a href="#setContentView过程" class="headerlink" title="setContentView过程"></a>setContentView过程</h1><p><img src="/posts/2849937748/setContentView%E8%BF%87%E7%A8%8B.png" alt="Android/setContentView过程"></p>
<h1 id="代码："><a href="#代码：" class="headerlink" title="代码："></a>代码：</h1><h2 id="重启Activity及状态保存"><a href="#重启Activity及状态保存" class="headerlink" title="重启Activity及状态保存"></a>重启Activity及状态保存</h2><ul>
<li>保存状态、重启、取出原状态，主题切换<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">FragmentActivity</span> <span class="keyword">implements</span> <span class="title class_">OnClickListener</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Button btn;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> mTheme;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">THEME</span> <span class="operator">=</span> <span class="string">&quot;theme&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="comment">//恢复销毁前状态</span></span><br><span class="line">        <span class="keyword">if</span> (savedInstanceState != <span class="literal">null</span>) &#123;</span><br><span class="line">            mTheme = savedInstanceState.getInt(THEME);</span><br><span class="line">            switchTheme(mTheme);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        btn = (Button) findViewById(R.id.btn);</span><br><span class="line">        btn.setOnClickListener(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onSaveInstanceState</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onSaveInstanceState(savedInstanceState);</span><br><span class="line">        Log.e(MainActivity.class.getName(), <span class="string">&quot;onSaveInstanceState&quot;</span>);</span><br><span class="line">        <span class="comment">//保存销毁前状态</span></span><br><span class="line">        savedInstanceState.putInt(THEME, mTheme);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">switchTheme</span><span class="params">(<span class="type">int</span> theme)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (mTheme) &#123;</span><br><span class="line">            <span class="keyword">case</span> android.R.style.Theme_Holo_Light:</span><br><span class="line">                mTheme = android.R.style.Theme_Black_NoTitleBar;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> android.R.style.Theme_Black_NoTitleBar:</span><br><span class="line">                mTheme = android.R.style.Theme_Holo_Light;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                mTheme = android.R.style.Theme_Holo_Light;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        setTheme(mTheme);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressLint(&quot;NewApi&quot;)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">        <span class="comment">//切换主题</span></span><br><span class="line">        recreate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>注意：<br>recreate()方法是在Android3.0引入的，所以如果在3.0之前使用会出现错误</p>
</blockquote>
<ul>
<li>调用<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> getIntent();</span><br><span class="line">finish();</span><br><span class="line">startActivity(intent);</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="集中管理Activity"><a href="#集中管理Activity" class="headerlink" title="集中管理Activity"></a>集中管理Activity</h2><p>有时候在设计软件的时候布局复杂的话不利于查看跟更改，这时候我们可以在新建几个Activity，然后用ActivityGroup来管理这些Activity （把Activity当成一个View来显示）</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyMain</span> <span class="keyword">extends</span> <span class="title class_">ActivityGroup</span> &#123;</span><br><span class="line">    <span class="comment">/** Called when the activity is first created. */</span></span><br><span class="line"></span><br><span class="line">    LinearLayout layout;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.main);     </span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="built_in">this</span>,Activity1.class);</span><br><span class="line">        layout=(LinearLayout)<span class="built_in">this</span>.findViewById(R.id.linearLayout1);</span><br><span class="line">        <span class="comment">//ActivityGroup管理Activity，Activity转为View</span></span><br><span class="line">        <span class="type">Window</span> <span class="variable">subActivity</span> <span class="operator">=</span> <span class="built_in">this</span>.getLocalActivityManager().startActivity(<span class="string">&quot;Activity&quot;</span>,intent);</span><br><span class="line">        <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> subActivity.getDecorView();</span><br><span class="line">        layout.addView(view);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="禁用返回键"><a href="#禁用返回键" class="headerlink" title="禁用返回键"></a>禁用返回键</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">dispatchKeyEvent</span><span class="params">(KeyEvent event)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (event.getKeyCode() == KeyEvent.KEYCODE_BACK)&#123;</span><br><span class="line">        <span class="comment">//禁用返回键</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.dispatchKeyEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相比于onBackPressed和onKeyDown方法有时候没有效果，这个方法能保证禁用手机的返回键。</p>
<!-- flag of hidden posts -->
      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div></div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt=" WeChat Pay"/>
        <p>WeChat Pay</p>
      </div>
    

    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/private/" rel="tag"># private</a>
          
            <a href="/tags/%E5%AE%89%E5%8D%93%E7%9F%A5%E8%AF%86%E7%82%B9/" rel="tag"># 安卓知识点</a>
          
        </div>
      

      
      
      

      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">100</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">29</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="mailto:shenbh@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://blog.csdn.net/ptwenzi?spm=1010.2135.3001.5113" target="_blank" title="CSDN">
                      
                        <i class="fa fa-fw fa-clone"></i>CSDN</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/shenbh" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://gitee.com/shen_bh" target="_blank" title="Gitee">
                      
                        <i class="fa fa-fw fa-git"></i>Gitee</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Activity"><span class="nav-text">Activity</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E7%A7%8D%E7%8A%B6%E6%80%81"><span class="nav-text">4 种状态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-text">生命周期</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Activity%E6%AD%A3%E5%B8%B8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-text">Activity正常生命周期</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#onNewIntent-%E8%A2%AB%E8%B0%83%E7%94%A8%E4%B8%A4%E6%AC%A1"><span class="nav-text">onNewIntent()被调用两次</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#onNewIntent%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-text">onNewIntent的生命周期</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E6%83%85%E5%86%B5%E4%B8%8B%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-text">异常情况下的生命周期</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%BA%9B%E7%89%B9%E6%AE%8A%E6%83%85%E5%86%B5%E4%B8%8B%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-text">一些特殊情况下的生命周期</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IdleHandler%E6%AF%94onResume%E7%B2%BE%E7%A1%AE"><span class="nav-text">IdleHandler比onResume精确</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#IdleHandler%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">IdleHandler应用场景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IdelHandler%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-text">IdelHandler注意事项</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E6%A8%A1%E5%BC%8F"><span class="nav-text">启动模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Activity-%E7%9A%84%E4%BB%BB%E5%8A%A1%E6%A0%88"><span class="nav-text">Activity 的任务栈</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Intent%E6%A0%87%E5%BF%97"><span class="nav-text">使用Intent标志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E6%A8%A1%E5%BC%8F%E7%9A%84%E7%B1%BB%E5%9E%8B%E5%92%8C%E7%89%B9%E6%80%A7"><span class="nav-text">启动模式的类型和特性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#standard"><span class="nav-text">standard</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#singleTop"><span class="nav-text">singleTop</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#singleTask"><span class="nav-text">singleTask</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#singleInstance"><span class="nav-text">singleInstance</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B"><span class="nav-text">启动过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ActivityThread-java"><span class="nav-text">ActivityThread.java</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Activity-%E7%BB%84%E4%BB%B6%E4%B9%8B%E9%97%B4%E7%9A%84%E9%80%9A%E4%BF%A1"><span class="nav-text">Activity 组件之间的通信</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Activity%E2%80%93%E3%80%8BActivity"><span class="nav-text">Activity–》Activity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Activity%E2%80%93%E3%80%8BService"><span class="nav-text">Activity–》Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Activity%E2%80%93%E3%80%8BFragment"><span class="nav-text">Activity–》Fragment</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Activity%E4%B9%8B%E9%97%B4%E9%80%9A%E8%BF%87Intent%E7%9A%84%E9%80%9A%E4%BF%A1"><span class="nav-text">Activity之间通过Intent的通信</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Scheme%E8%B7%B3%E8%BD%AC%E5%8D%8F%E8%AE%AE"><span class="nav-text">Scheme跳转协议</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-startActivity-%E9%83%BD%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88"><span class="nav-text">源码解读 startActivity 都做了什么</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Android%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B"><span class="nav-text">Android启动过程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Activity%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E8%A7%A3%E6%9E%90"><span class="nav-text">Activity生命周期解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B8%E5%9E%8B%E6%83%85%E5%86%B5%E4%B8%8B%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%88%86%E6%9E%90"><span class="nav-text">典型情况下的生命周期分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A3%E5%B8%B8%E6%83%85%E5%86%B5%E4%B8%8B%E5%90%AF%E5%8A%A8"><span class="nav-text">正常情况下启动</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%A0%E7%A7%8D%E6%83%85%E5%86%B5%EF%BC%9A"><span class="nav-text">几种情况：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%A4%E4%B8%AA%E9%97%AE%E9%A2%98"><span class="nav-text">两个问题</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E6%83%85%E5%86%B5%E4%B8%8B%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%88%86%E6%9E%90"><span class="nav-text">异常情况下的生命周期分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Activity%E7%9A%84%E5%90%AF%E5%8A%A8%E6%A8%A1%E5%BC%8F"><span class="nav-text">Activity的启动模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IntentFilter%E7%9A%84%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99"><span class="nav-text">IntentFilter的匹配规则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B-1"><span class="nav-text">启动过程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Activity%E7%9A%84%E5%85%B6%E4%BB%96%E7%AC%94%E8%AE%B0"><span class="nav-text">Activity的其他笔记</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#android%E5%B1%9E%E6%80%A7%E4%B9%8BclearTaskOnLaunch"><span class="nav-text">android属性之clearTaskOnLaunch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#android%E5%B1%9E%E6%80%A7%E4%B9%8BalwaysRetainTaskState"><span class="nav-text">android属性之alwaysRetainTaskState</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BB%BB%E5%8A%A1Task%EF%BC%88hencoder%EF%BC%89"><span class="nav-text">任务Task（hencoder）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="nav-text">任务的概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Task%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%9E%8B%E3%80%81LaunchMode"><span class="nav-text">Task工作模型、LaunchMode</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Task%E5%92%8C%E5%9B%9E%E9%80%80%E6%A0%88"><span class="nav-text">Task和回退栈</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Standard"><span class="nav-text">Standard</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#allowTaskReparenting"><span class="nav-text">allowTaskReparenting</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SingleTask%EF%BC%88%E5%94%AF%E4%B8%80%E6%80%A7%EF%BC%9A%E5%85%A8%E5%B1%80%E5%8F%AA%E6%9C%89%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%EF%BC%89"><span class="nav-text">SingleTask（唯一性：全局只有一个对象）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SingleInstance%EF%BC%88%E5%94%AF%E4%B8%80%E6%80%A7%EF%BC%8C%E7%8B%AC%E5%8D%A0%E6%80%A7%EF%BC%89"><span class="nav-text">SingleInstance（唯一性，独占性）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#taskAffinity"><span class="nav-text">taskAffinity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SingleTop"><span class="nav-text">SingleTop</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#setContentView%E8%BF%87%E7%A8%8B"><span class="nav-text">setContentView过程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%EF%BC%9A"><span class="nav-text">代码：</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%87%8D%E5%90%AFActivity%E5%8F%8A%E7%8A%B6%E6%80%81%E4%BF%9D%E5%AD%98"><span class="nav-text">重启Activity及状态保存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E4%B8%AD%E7%AE%A1%E7%90%86Activity"><span class="nav-text">集中管理Activity</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A6%81%E7%94%A8%E8%BF%94%E5%9B%9E%E9%94%AE"><span class="nav-text">禁用返回键</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">阿炳</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('-1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
          if(result)$(this).text('Copied')
          else $(this).text('Copy failed')
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('Copy')
        }, 300)
      }).append(e)
    })
  </script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>