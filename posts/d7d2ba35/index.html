<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="private,安卓优化," />










<meta name="description" content="卡顿优化在我们使用各种各样的App的时候，有时会看见有些App运行起来并不流畅，即出现了卡顿现象，那么如何去定义发生了卡顿现象呢？ 12如果App的FPS平均值小于30，最小值小于24，即表明应用发生了卡顿。  那我么又如何去分析应用是否出现了卡顿呢？下面，我们就先来了解一下解决卡顿问题时需要用到的分析方法与工具。 一、卡顿优化分析方法与工具1、背景介绍 很多性能问题不易被发现，但是卡顿问题很容易">
<meta property="og:type" content="article">
<meta property="og:title" content="优化-卡顿优化">
<meta property="og:url" content="http://shenbh.github.io/posts/d7d2ba35/index.html">
<meta property="og:site_name" content="AB">
<meta property="og:description" content="卡顿优化在我们使用各种各样的App的时候，有时会看见有些App运行起来并不流畅，即出现了卡顿现象，那么如何去定义发生了卡顿现象呢？ 12如果App的FPS平均值小于30，最小值小于24，即表明应用发生了卡顿。  那我么又如何去分析应用是否出现了卡顿呢？下面，我们就先来了解一下解决卡顿问题时需要用到的分析方法与工具。 一、卡顿优化分析方法与工具1、背景介绍 很多性能问题不易被发现，但是卡顿问题很容易">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ef94b276db234359a0133603d5886aff~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0ed4c4f85af74f5f9265369cc790943a~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cf8f7e9679d943d0b4e60d7b93f65a1e~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/67ff298aadb3465e91fbdde156bd1277~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/080a3bec391d4e85b5215ed37791c132~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="article:published_time" content="2020-09-03T02:31:58.000Z">
<meta property="article:modified_time" content="2022-05-05T06:57:05.380Z">
<meta property="article:author" content="阿炳">
<meta property="article:tag" content="private">
<meta property="article:tag" content="安卓优化">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ef94b276db234359a0133603d5886aff~tplv-k3u1fbpfcp-zoom-1.image">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://shenbh.github.io/posts/d7d2ba35/"/>





  <title>优化-卡顿优化 | AB</title><meta name="robots" content="noindex">
  








<meta name="generator" content="Hexo 6.1.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">AB</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Just do IT Now.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://shenbh.github.io/posts/d7d2ba35/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AB">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">优化-卡顿优化</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-09-03T10:31:58+08:00">
                2020-09-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="卡顿优化"><a href="#卡顿优化" class="headerlink" title="卡顿优化"></a>卡顿优化</h1><p>在我们使用各种各样的App的时候，有时会看见有些App运行起来并不流畅，即出现了卡顿现象，<strong>那么如何去定义发生了卡顿现象呢？</strong></p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">如果<span class="keyword">App</span>的FPS平均值小于30，最小值小于24，即表明应用发生了卡顿。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>那我么又如何去分析应用是否出现了卡顿呢？下面，我们就先来了解一下解决卡顿问题时需要用到的分析方法与工具。</p>
<h1 id="一、卡顿优化分析方法与工具"><a href="#一、卡顿优化分析方法与工具" class="headerlink" title="一、卡顿优化分析方法与工具"></a>一、卡顿优化分析方法与工具</h1><h2 id="1、背景介绍"><a href="#1、背景介绍" class="headerlink" title="1、背景介绍"></a>1、背景介绍</h2><ul>
<li>很多性能问题不易被发现，但是卡顿问题很容易被直观感受。</li>
<li>卡顿问题难以定位。</li>
</ul>
<h3 id="那么卡顿问题到底难在哪里呢？"><a href="#那么卡顿问题到底难在哪里呢？" class="headerlink" title="那么卡顿问题到底难在哪里呢？"></a>那么卡顿问题到底难在哪里呢？</h3><ul>
<li>1、卡顿产生的原因是错综复杂的，它涉及到代码、内存、绘制、IO、CPU等等。</li>
<li>2、线上的卡顿问题在线下是很难复现的，因为它与当时的场景是强相关的，比如说线上用户的磁盘IO空间不足了，它影响了磁盘IO的写入性能，所以导致卡顿。针对这种问题，我们最好<strong>在发现卡顿的时候尽量地去记录用户当时发生卡顿时的具体的场景信息</strong>。</li>
</ul>
<h2 id="2、卡顿分析方法之使用shell命令分析CPU耗时"><a href="#2、卡顿分析方法之使用shell命令分析CPU耗时" class="headerlink" title="2、卡顿分析方法之使用shell命令分析CPU耗时"></a>2、卡顿分析方法之使用shell命令分析CPU耗时</h2><p>尽管造成卡顿的原因有很多种，不过最终都会反映到CPU时间上。</p>
<p>CPU时间包含用户时间和系统时间。</p>
<ul>
<li>用户时间：执行用户态应用程序代码所消耗的时间。</li>
<li>系统时间：执行内核态系统调用所消耗的时间，<strong>包括I&#x2F;O、锁、中断和其它系统调用所消耗的时间。</strong></li>
</ul>
<p>CPU的问题大致可以分为以下三类：</p>
<p><strong>1、CPU资源冗余使用</strong></p>
<ul>
<li><strong>算法效率太低</strong>：明明可以遍历一次的却需要去遍历两次，<strong>主要出现在查找、排序、删除等环节。</strong></li>
<li><strong>没有使用cache</strong>：明明解码过一次的图片还去重复解码。</li>
<li><strong>计算时使用的基本类型不对：明明使用int就足够，却要使用long，这会导致CPU的运算压力多出4倍。</strong></li>
</ul>
<p><strong>2、CPU资源争抢</strong></p>
<ul>
<li><strong>抢主线程的CPU资源</strong>：这是最常见的问题，并且在Android 6.0版本之前没有renderthread的时候，主线程的繁忙程度就决定了是否会引发用户的卡顿问题。</li>
<li><strong>抢音视频的CPU资源</strong>：音视频编解码本身会消耗大量的CPU资源，并且其对于解码的速度是有硬性要求的，如果达不到就可能产生播放流畅度的问题。我们可以<strong>采取两种方式去优化：1、尽量排除非核心业务的消耗。2、优化自身的性能消耗，把CPU负载转化为GPU负载，如使用renderscript来处理视频中的影像信息。</strong></li>
<li><strong>大家平等，互相抢</strong>：比如在自定义的相册中，我开了20个线程做图片解码，那就是互相抢CPU了，结果就是会导致图片的显示速度非常慢。这简直就是三个和尚没水喝的典型案例。因此，在自定义线程池的时候我们需要按照系统核心数去控制线程数。</li>
</ul>
<p><strong>3、CPU资源利用率低</strong></p>
<p>对于启动、界面切换、音视频编解码这些场景，为了保证其速度，我们需要去好好利用CPU。<strong>而导致无法充分利用CPU的因素，不仅有磁盘和网络I&#x2F;O，还有锁操作、sleep等等。对于锁的优化，通常是尽可能地缩减锁的范围。</strong></p>
<h3 id="1、了解CPU-性能"><a href="#1、了解CPU-性能" class="headerlink" title="1、了解CPU 性能"></a>1、了解CPU 性能</h3><p>我们可以通过CPU的<strong>主频、核心数、缓存</strong>等参数去评估CPU的性能，这些参数的好坏能表现出<strong>CPU计算能力和指令执行能力的强弱</strong>，也就是<strong>CPU每秒执行的浮点计算数和每秒执行的指令数的多少</strong>。</p>
<p>此外，现在最新的主流机型都使用了<strong>多级能效的CPU架构（即多核分层架构）</strong>，以确保在平常低负荷工作时能仅使用低频核心来节省电量。</p>
<p>并且，我们还可以通过shell命令直接查看手机的CPU核心数与频率等信息，如下所示：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">//</span> 先输入adb shell进入手机的shell环境</span><br><span class="line">adb shell</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> 获取 CPU 核心数，我的手机是<span class="number">8</span>核</span><br><span class="line">platina:<span class="regexp">/ $ cat /</span>sys<span class="regexp">/devices/</span>system<span class="regexp">/cpu/</span>possible</span><br><span class="line"><span class="number">0</span>-<span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> 获取第一个 CPU 的最大频率</span><br><span class="line">platina:/ $ cat</span><br><span class="line"><span class="regexp">/sys/</span>devices<span class="regexp">/system/</span>cpu<span class="regexp">/cpu0/</span>cpufreq/cpuinfo_max_freq                         &lt;</span><br><span class="line"><span class="number">1843200</span></span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> 获取第二个CPU的最小频率</span><br><span class="line">platina:/ $ cat</span><br><span class="line"><span class="regexp">/sys/</span>devices<span class="regexp">/system/</span>cpu<span class="regexp">/cpu1/</span>cpufreq/cpuinfo_min_freq                         &lt;</span><br><span class="line"><span class="number">633600</span></span><br></pre></td></tr></table></figure>

<p>从 CPU 到 GPU 再到 AI 芯片（如专为神经网络计算打造的 NPU（Neural network Processing Unit）），随着手机 CPU 整体性能的飞跃，医疗诊断、图像超清化等一些 AI 应用场景也可以在移动端更好地落地。我们可以<strong>充分利用移动端的计算能力来降低高昂的服务器成本。</strong></p>
<p>此外，CPU的性能越好，应用就能获得更好的支持，如线程池可以根据不同手机的CPU核心数来配备不同的线程数、<strong>仅在手机主频比较高或者带有NPU的设备去开启一些高级的AI功能</strong>。</p>
<h3 id="2、通过读取-x2F-proc-x2F-stat与-x2F-proc-x2F-PID-x2F-stat文件来计算并评估系统的CPU耗时情况"><a href="#2、通过读取-x2F-proc-x2F-stat与-x2F-proc-x2F-PID-x2F-stat文件来计算并评估系统的CPU耗时情况" class="headerlink" title="2、通过读取&#x2F;proc&#x2F;stat与&#x2F;proc&#x2F;[PID]&#x2F;stat文件来计算并评估系统的CPU耗时情况"></a>2、通过读取&#x2F;proc&#x2F;stat与&#x2F;proc&#x2F;[PID]&#x2F;stat文件来计算并评估系统的CPU耗时情况</h3><p>当应用出现卡顿问题之后，首先我们应该查看系统CPU的使用率。</p>
<p>首先，我们通过<strong>读取 &#x2F;proc&#x2F;stat 文件获取总的 CPU 时间</strong>，并<strong>读取 &#x2F;proc&#x2F;[PID]&#x2F;stat 获取应用进程 的CPU 时间</strong>，然后，<strong>采样两个足够短的时间间隔的 CPU 快照与进程快照来计算其 CPU 使用率</strong>。</p>
<h4 id="计算总的-CPU-使用率"><a href="#计算总的-CPU-使用率" class="headerlink" title="计算总的 CPU 使用率"></a>计算总的 CPU 使用率</h4><p>1、采样两个足够短的时间间隔的 CPU 快照，即需要前后两次去读取 &#x2F;proc&#x2F;stat 文件，获取两个时间点对应的数据，如下所示：</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// 第一次采样</span><br><span class="line">platina:/ $ cat /proc/stat</span><br><span class="line">cpu  <span class="number">9931551</span> <span class="number">1082101</span> <span class="number">9002534</span> <span class="number">174463041</span> <span class="number">340947</span> <span class="number">1060438</span> <span class="number">1088978 0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line">cpu<span class="number">0 2244962</span> <span class="number">280573</span> <span class="number">2667000</span> <span class="number">22414199</span> <span class="number">99651 231869</span> <span class="number">439918 0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line">cpu<span class="number">1 2672378</span> <span class="number">421880</span> <span class="number">2943791</span> <span class="number">21540302</span> <span class="number">121818 236850</span> <span class="number">438733 0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line">cpu<span class="number">2 1648512</span> <span class="number">76856</span> <span class="number">1431036</span> <span class="number">25868789</span> <span class="number">46970 107094</span> <span class="number">52025 0 0</span> <span class="number">0</span></span><br><span class="line">cpu<span class="number">3 1418757</span> <span class="number">41280 1397203</span> <span class="number">25772984</span> <span class="number">40292 110168</span> <span class="number">41667 0 0</span> <span class="number">0</span></span><br><span class="line">cpu<span class="number">4 573203</span> <span class="number">79498 178263</span> <span class="number">19618235</span> <span class="number">9577</span> <span class="number">307949</span> <span class="number">10875 0 0</span> <span class="number">0</span></span><br><span class="line">cpu<span class="number">5 522638</span> <span class="number">67978 155454</span> <span class="number">19684358</span> <span class="number">8793 19787</span> <span class="number">4603 0 0</span> <span class="number">0</span></span><br><span class="line">cpu<span class="number">6 458438</span> <span class="number">64085 132252</span> <span class="number">19749439</span> <span class="number">8143 19942</span> <span class="number">98241 0 0</span> <span class="number">0</span></span><br><span class="line">cpu<span class="number">7 392663</span> <span class="number">49951 97535</span> <span class="number">19814735</span> <span class="number">5703 26779</span> <span class="number">2916 0 0</span> <span class="number">0</span></span><br><span class="line">intr...</span><br><span class="line"></span><br><span class="line">// 第二次采样</span><br><span class="line">platina:/ $ cat /proc/stat</span><br><span class="line">cpu  <span class="number">9931673</span> <span class="number">1082113</span> <span class="number">9002679</span> <span class="number">174466561</span> <span class="number">340954</span> <span class="number">1060446</span> <span class="number">1088994 0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line">cpu<span class="number">0 2244999</span> <span class="number">280578</span> <span class="number">2667032</span> <span class="number">22414604</span> <span class="number">99653 231869</span> <span class="number">439918 0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line">cpu<span class="number">1 2672434</span> <span class="number">421881</span> <span class="number">2943861</span> <span class="number">21540606</span> <span class="number">121822 236855</span> <span class="number">438747 0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line">cpu<span class="number">2 1648525</span> <span class="number">76859</span> <span class="number">1431054</span> <span class="number">25869234</span> <span class="number">46971 107095</span> <span class="number">52026 0 0</span> <span class="number">0</span></span><br><span class="line">cpu<span class="number">3 1418773</span> <span class="number">41283 1397228</span> <span class="number">25773412</span> <span class="number">40292 110170</span> <span class="number">41668 0 0</span> <span class="number">0</span></span><br><span class="line">cpu<span class="number">4 573203</span> <span class="number">79498 178263</span> <span class="number">19618720</span> <span class="number">9577</span> <span class="number">307949</span> <span class="number">10875 0 0</span> <span class="number">0</span></span><br><span class="line">cpu<span class="number">5 522638</span> <span class="number">67978 155454</span> <span class="number">19684842</span> <span class="number">8793 19787</span> <span class="number">4603 0 0</span> <span class="number">0</span></span><br><span class="line">cpu<span class="number">6 458438</span> <span class="number">64085 132252</span> <span class="number">19749923</span> <span class="number">8143 19942</span> <span class="number">98241 0 0</span> <span class="number">0</span></span><br><span class="line">cpu<span class="number">7 392663</span> <span class="number">49951 97535</span> <span class="number">19815220</span> <span class="number">5703 26779</span> <span class="number">2916 0 0</span> <span class="number">0</span></span><br><span class="line">int...    </span><br></pre></td></tr></table></figure>

<p>因为我的手机是8核，所以这里的cpu个数是8个，从cpu0到cpu7，<strong>第一行的cpu即是8个cpu的指标数据汇总</strong>，因为是要计算系统cpu的使用率，那当然应该以cpu为基准了。两次采样的CPU指标数据如下：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">cpu1</span>  <span class="number">9931551</span> <span class="number">1082101</span> <span class="number">9002534</span> <span class="number">174463041</span> <span class="number">340947</span> <span class="number">1060438</span> <span class="number">1088978</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line"><span class="attribute">cpu2</span>  <span class="number">9931673</span> <span class="number">1082113</span> <span class="number">9002679</span> <span class="number">174466561</span> <span class="number">340954</span> <span class="number">1060446</span> <span class="number">1088994</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>其对应的各项指标如下：</p>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CPU (<span class="literal">user</span>, nice, <span class="params">system</span>, idle, iowait, irq, softirq, stealstolen, guest)<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>拿cpu1（9931551 1082101 9002534 174463041 340947 1060438 1088978 0 0 0）的数据来说，下面，我就来详细地解释下这些指标的含义。</p>
<ul>
<li>user(9931551)： 表示从<strong>系统启动开始至今处于用户态的运行时间</strong>，注意<strong>不包含 nice 值为负的进程</strong>。</li>
<li>nice(1082101) ：表示<strong>从系统启动开始至今nice 值为负的进程所占用的 CPU 时间</strong>。</li>
<li>system(9002534)： 表示<strong>从系统启动开始至今处于内核态的运行时间</strong>。</li>
<li>idle(174463041) ：表示<strong>从系统启动开始至今除 IO 等待时间以外的其他等待时间</strong>。</li>
<li>iowait(340947)：表示<strong>从系统启动开始至今的IO 等待时间</strong>。(从Linux V2.5.41开始包含)</li>
<li>irq(1060438)：表示<strong>从系统启动开始至今的硬中断时间</strong>。(从Linux V2.6.0-test4开始包含)</li>
<li>softirq(1088978)：表示<strong>从系统启动开始至今的软中断时间</strong>。(从Linux V2.6.0-test4开始包含)</li>
<li>stealstolen(0) ：表示当在虚拟化环境中运行时在其他操作系统中所花费的时间。在Android系统下此值为0。(从Linux V2.6.11开始包含)</li>
<li>guest(0) ：表示当在Linux内核的控制下为其它操作系统运行虚拟CPU所花费的时间。在Android系统下此值为0。(从 V2.6.24开始包含)</li>
</ul>
<p>此外，这些数值的单位都是 jiffies，<strong>jiffies 是内核中的一个全局变量，用来记录系统启动以来产生的节拍数，在 Linux 中，一个节拍大致可以理解为操作系统进程调度的最小时间片，不同的 Linux 系统内核中的这个值可能不同，通常在 1ms 到 10ms 之间</strong>。</p>
<p>了解了&#x2F;proc&#x2F;stat命令下各项参数的含义之后，我们就可以由前后两次时间点的CPU数据计算得到cpu1与cpu2的活动时间，如下所示：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">totalCPUTime</span> = user + nice + system + idle + iowait + irq + softirq + stealstolen + guest </span><br><span class="line"><span class="attribute">cpu1</span> = <span class="number">9931551</span> + <span class="number">1082101</span> + <span class="number">9002534</span> +  <span class="number">174463041</span> + <span class="number">340947</span> + <span class="number">1060438</span> + <span class="number">1088978</span> + <span class="number">0</span>  + <span class="number">0</span> + <span class="number">0</span> = <span class="number">196969590</span>jiffies</span><br><span class="line"><span class="attribute">cpu2</span> = <span class="number">9931673</span> + <span class="number">1082113</span> + <span class="number">9002679</span> +  <span class="number">174466561</span> + <span class="number">340954</span> + <span class="number">1060446</span> + <span class="number">1088994</span> + <span class="number">0</span> + <span class="number">0</span> + <span class="number">0</span> = <span class="number">196973420</span>jiffies</span><br></pre></td></tr></table></figure>

<p>因此可得出总的CPU时间，如下所示：</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">totalCPUTime</span> <span class="operator">=</span> CPU2 – CPU1 <span class="operator">=</span> <span class="number">3830</span>jiffies</span><br></pre></td></tr></table></figure>

<p>最后，我们就可以计算出<strong>系统CPU的使用率</strong>：：</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 先计算得到CPU的空闲时间</span><br><span class="line"><span class="attribute">idleCPUTime</span> <span class="operator">=</span> idle2 – idle1 <span class="operator">=</span> <span class="number">3520</span>jiffies</span><br><span class="line">// 最后得到系统CPU的使用率</span><br><span class="line"><span class="attribute">totalCPUUse</span> <span class="operator">=</span> (totalCPUTime – idleCPUTime) / totalCPUTime <span class="operator">=</span> （<span class="number">3830</span> - <span class="number">3520</span>）/ <span class="number">3830</span> <span class="operator">=</span> <span class="number">8</span>%</span><br></pre></td></tr></table></figure>

<p>可以看到，前后两次时间点间的CPU使用率大概为8%，说明我们系统的CPU是处于空闲状态的，<strong>如果CPU 使用率一直大于 60% ，则表示系统处于繁忙状态，此时就需要进一步分析用户时间和系统时间的比例，看看到底是系统占用了CPU还是应用进程占用了CPU</strong>。</p>
<h3 id="3、使用top命令查看应用进程的CPU消耗情况"><a href="#3、使用top命令查看应用进程的CPU消耗情况" class="headerlink" title="3、使用top命令查看应用进程的CPU消耗情况"></a>3、使用top命令查看应用进程的CPU消耗情况</h3><p>此外，由于Android是基于Linux内核改造而成的操作系统，自然而然也能使用Linux的一些常用命令。比如我们可以使用top命令查看哪些进程是 CPU 的主要消耗者。</p>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 直接使用<span class="literal">top</span>命令会定时不断地输出进程的相关信息</span><br><span class="line"><span class="number">1</span>|platina:/ $ <span class="literal">top</span></span><br><span class="line">PID <span class="literal">USER</span>         PR  NI VIRT  RES  SHR S[%CPU] %MEM     TIME+ ARGS</span><br><span class="line"><span class="number">12700</span> u0_a945    <span class="number">10</span> -<span class="number">10</span> <span class="number">4.3</span>G <span class="number">122</span>M  <span class="number">67</span>M S <span class="number">15.6</span>   <span class="number">2.1</span>   <span class="number">1</span>:<span class="number">06.41</span> json.chao.com.w+</span><br><span class="line"><span class="number">753</span> <span class="params">system</span>       RT   <span class="number">0</span>  <span class="number">90</span>M <span class="number">1.1</span>M <span class="number">1.0</span>M S <span class="number">13.6</span>   <span class="number">0.0</span> <span class="number">127</span>:<span class="number">47.73</span> android.hardwar+</span><br><span class="line"><span class="number">2064</span> <span class="params">system</span>      <span class="number">18</span>  -<span class="number">2</span> <span class="number">4.6</span>G <span class="number">309</span>M <span class="number">215</span>M S <span class="number">12.3</span>   <span class="number">5.4</span> <span class="number">978</span>:<span class="number">15.18</span> <span class="params">system</span>_server</span><br><span class="line"><span class="number">22142</span> u0_a163    <span class="number">20</span>   <span class="number">0</span> <span class="number">2.0</span>G  <span class="number">97</span>M  <span class="number">41</span>M S <span class="number">10.3</span>   <span class="number">1.6</span>   <span class="number">2</span>:<span class="number">22.99</span> com.tencent.mob+</span><br><span class="line"><span class="number">2293</span> <span class="params">system</span>      <span class="number">20</span>   <span class="number">0</span> <span class="number">4.7</span>G <span class="number">250</span>M  <span class="number">87</span>M S  <span class="number">8.6</span>   <span class="number">4.3</span> <span class="number">353</span>:<span class="number">15.77</span> com.android.sys+</span><br></pre></td></tr></table></figure>

<p>从以上可知我们的Awesome-WanAndroid应用进程占用了15.6%的CPU。最后，这里再列举下最常用的top命令，如下所示：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// 排除<span class="number">0</span>%的进程信息</span><br><span class="line">adb shell top | grep -v <span class="string">&#x27;0% S&#x27;</span></span><br><span class="line"></span><br><span class="line">// 获取指定进程的CPU、内存消耗，并设置刷新间隔</span><br><span class="line">adb shell top -d <span class="number">1</span> | grep <span class="type">json</span>.chao.com.wanandroid</span><br><span class="line">|platina:/ $ top -d <span class="number">1</span>|grep <span class="type">json</span>.chao.com.w+</span><br><span class="line"><span class="number">5689</span> u0_a945      <span class="number">10</span> <span class="number">-10</span> <span class="number">4.3</span>G <span class="number">129</span>M  <span class="number">71</span>M S <span class="number">13.8</span>   <span class="number">2.2</span>   <span class="number">1</span>:<span class="number">04.46</span> <span class="type">json</span>.chao.com.w+</span><br><span class="line"><span class="number">5689</span> u0_a945      <span class="number">10</span> <span class="number">-10</span> <span class="number">4.3</span>G <span class="number">129</span>M  <span class="number">71</span>M S <span class="number">19.0</span>   <span class="number">2.2</span>   <span class="number">1</span>:<span class="number">04.51</span> <span class="type">json</span>.chao.com.w+</span><br><span class="line"><span class="number">5689</span> u0_a945      <span class="number">10</span> <span class="number">-10</span> <span class="number">4.3</span>G <span class="number">129</span>M  <span class="number">71</span>M S <span class="number">15.0</span>   <span class="number">2.2</span>   <span class="number">1</span>:<span class="number">04.70</span> <span class="type">json</span>.chao.com.w+</span><br><span class="line"><span class="number">5689</span> u0_a945      <span class="number">10</span> <span class="number">-10</span> <span class="number">4.3</span>G <span class="number">129</span>M  <span class="number">71</span>M S  <span class="number">9.0</span>   <span class="number">2.2</span>   <span class="number">1</span>:<span class="number">04.85</span> <span class="type">json</span>.chao.com.w+</span><br><span class="line"><span class="number">5689</span> u0_a945      <span class="number">10</span> <span class="number">-10</span> <span class="number">4.3</span>G <span class="number">129</span>M  <span class="number">71</span>M S <span class="number">26.0</span>   <span class="number">2.2</span>   <span class="number">1</span>:<span class="number">04.94</span> <span class="type">json</span>.chao.com.w+</span><br><span class="line"><span class="number">5689</span> u0_a945      <span class="number">10</span> <span class="number">-10</span> <span class="number">4.3</span>G <span class="number">129</span>M  <span class="number">71</span>M S  <span class="number">9.0</span>   <span class="number">2.2</span>   <span class="number">1</span>:<span class="number">05.20</span> <span class="type">json</span>.chao.com.w+</span><br><span class="line"><span class="number">5689</span> u0_a945      <span class="number">10</span> <span class="number">-10</span> <span class="number">4.3</span>G <span class="number">129</span>M  <span class="number">71</span>M R <span class="number">17.0</span>   <span class="number">2.2</span>   <span class="number">1</span>:<span class="number">05.29</span> <span class="type">json</span>.chao.com.w+</span><br><span class="line"><span class="number">5689</span> u0_a945      <span class="number">10</span> <span class="number">-10</span> <span class="number">4.3</span>G <span class="number">129</span>M  <span class="number">71</span>M S <span class="number">20.0</span>   <span class="number">2.2</span>   <span class="number">1</span>:<span class="number">05.46</span> <span class="type">json</span>.chao.com.w+</span><br><span class="line"><span class="number">5689</span> u0_a945      <span class="number">10</span> <span class="number">-10</span> <span class="number">4.3</span>G <span class="number">129</span>M  <span class="number">71</span>M S  <span class="number">9.0</span>   <span class="number">2.2</span>   <span class="number">1</span>:<span class="number">05.66</span> <span class="type">json</span>.chao.com.w+</span><br><span class="line"><span class="number">5689</span> u0_a945      <span class="number">10</span> <span class="number">-10</span> <span class="number">4.3</span>G <span class="number">129</span>M  <span class="number">71</span>M R <span class="number">21.0</span>   <span class="number">2.2</span>   <span class="number">1</span>:<span class="number">05.75</span> <span class="type">json</span>.chao.com.w+</span><br><span class="line"><span class="number">5689</span> u0_a945      <span class="number">10</span> <span class="number">-10</span> <span class="number">4.3</span>G <span class="number">129</span>M  <span class="number">71</span>M S <span class="number">14.0</span>   <span class="number">2.2</span>   <span class="number">1</span>:<span class="number">05.96</span> <span class="type">json</span>.chao.com.w+</span><br></pre></td></tr></table></figure>

<h3 id="4、PS软件"><a href="#4、PS软件" class="headerlink" title="4、PS软件"></a>4、PS软件</h3><p>除了top命令可以比较全面地查看整体的CPU信息之外，如果我们只想<strong>查看当前指定进程已经消耗的CPU时间占系统总时间的百分比或其它的状态信息</strong>的话，可以使用ps命令，常用的ps命令如下所示：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">//</span> 查看指定进程的状态信息</span><br><span class="line">platina:/ $ ps -p <span class="number">31333</span></span><br><span class="line">USER           PID  PPID     VSZ    RSS WCHAN            ADDR S NAME</span><br><span class="line">u0_a945      <span class="number">31333</span>  <span class="number">1277</span> <span class="number">4521308</span> <span class="number">127460</span> <span class="number">0</span>                   <span class="number">0</span> S json.chao.com.w+</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> 查看指定进程已经消耗的CPU时间占系统总时间的百分比</span><br><span class="line">platina:/ $ ps -o PCPU -p <span class="number">31333</span></span><br><span class="line">%CPU</span><br><span class="line"><span class="number">10.8</span></span><br></pre></td></tr></table></figure>

<p>其中输出参数的含义如下所示：</p>
<ul>
<li>USER：用户名</li>
<li>PID：进程ID</li>
<li>PPID：父进程ID</li>
<li>VSZ：虚拟内存大小（1k为单位）</li>
<li>RSS：常驻内存大小（正在使用的页）</li>
<li>WCHAN：进程在内核态中的运行时间</li>
<li>Instruction pointer：指令指针</li>
<li>NAME：进程名字</li>
</ul>
<p>最后的输出参数S表示的是进程当前的状态，总共有10种可能的状态，如下所示：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">R (<span class="name">running</span>) S (<span class="name">sleeping</span>) D (<span class="name">device</span> I/O) T (<span class="name">stopped</span>)  <span class="literal">t</span> (<span class="name">traced</span>)</span><br><span class="line">Z (<span class="name">zombie</span>)  X (<span class="name">deader</span>)   x (<span class="name">dead</span>)       K (<span class="name">wakekill</span>) W (<span class="name">waking</span>)</span><br></pre></td></tr></table></figure>

<p>可以看到，我们当前主进程是休眠的状态。</p>
<h3 id="5、dumpsys-cpuinfo"><a href="#5、dumpsys-cpuinfo" class="headerlink" title="5、dumpsys cpuinfo"></a>5、dumpsys cpuinfo</h3><p>使用dumpsys cpuinfo命令获得的信息比起top命令得到的信息要更加精炼，如下所示：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">platina</span>:/ $ dumpsys cpuinfo</span><br><span class="line"><span class="attribute">Load</span>: <span class="number">1</span>.<span class="number">92</span> / <span class="number">1</span>.<span class="number">59</span> / <span class="number">0</span>.<span class="number">97</span></span><br><span class="line"><span class="attribute">CPU</span> usage from <span class="number">45482</span>ms to <span class="number">25373</span>ms ago (<span class="number">2020</span>-<span class="number">02</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">00</span>:<span class="number">37</span>.<span class="number">666</span> to <span class="number">2020</span>-<span class="number">02</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">00</span>:<span class="number">57</span>.<span class="number">775</span>):</span><br><span class="line"><span class="attribute">33</span>% <span class="number">2060</span>/system_server: <span class="number">22</span>% user + <span class="number">10</span>% kernel / faults: <span class="number">8152</span> minor <span class="number">6</span> major</span><br><span class="line"><span class="attribute">17</span>% <span class="number">2292</span>/com.android.systemui: <span class="number">12</span>% user + <span class="number">4</span>.<span class="number">7</span>% kernel / faults: <span class="number">21636</span> minor <span class="number">3</span> major</span><br><span class="line"><span class="attribute">14</span>% <span class="number">750</span>/android.hardware.sensors@<span class="number">1</span>.<span class="number">0</span>-service: <span class="number">4</span>.<span class="number">4</span>% user + <span class="number">10</span>% kernel</span><br><span class="line"><span class="attribute">6</span>.<span class="number">1</span>% <span class="number">778</span>/surfaceflinger: <span class="number">3</span>.<span class="number">3</span>% user + <span class="number">2</span>.<span class="number">7</span>% kernel / faults: <span class="number">128</span> minor</span><br><span class="line"><span class="attribute">3</span>.<span class="number">3</span>% <span class="number">2598</span>/com.miui.home: <span class="number">2</span>.<span class="number">8</span>% user + <span class="number">0</span>.<span class="number">4</span>% kernel / faults: <span class="number">7655</span> minor <span class="number">11</span> major</span><br><span class="line"><span class="attribute">2</span>.<span class="number">2</span>% <span class="number">2914</span>/cnss_diag: <span class="number">1</span>.<span class="number">6</span>% user + <span class="number">0</span>.<span class="number">6</span>% kernel</span><br><span class="line"><span class="attribute">1</span>.<span class="number">9</span>% <span class="number">745</span>/android.hardware.graphics.composer@<span class="number">2</span>.<span class="number">1</span>-service: <span class="number">1</span>.<span class="number">4</span>% user + <span class="number">0</span>.<span class="number">5</span>% kernel / faults: <span class="number">5</span> minor</span><br><span class="line"><span class="attribute">1</span>.<span class="number">7</span>% <span class="number">4525</span>/kworker/u16:<span class="number">6</span>: <span class="number">0</span>% user + <span class="number">1</span>.<span class="number">7</span>% kernel</span><br><span class="line"><span class="attribute">1</span>.<span class="number">6</span>% <span class="number">748</span>/android.hardware.memtrack@<span class="number">1</span>.<span class="number">0</span>-service: <span class="number">0</span>.<span class="number">6</span>% user + <span class="number">0</span>.<span class="number">9</span>% kernel</span><br><span class="line"><span class="attribute">1</span>.<span class="number">4</span>% <span class="number">4551</span>/kworker/u16:<span class="number">14</span>: <span class="number">0</span>% user + <span class="number">1</span>.<span class="number">4</span>% kernel</span><br><span class="line"><span class="attribute">1</span>.<span class="number">4</span>% <span class="number">31333</span>/json.chao.com.wanandroid: <span class="number">0</span>.<span class="number">9</span>% user + <span class="number">0</span>.<span class="number">4</span>% kernel / faults: <span class="number">3995</span> minor <span class="number">22</span> major</span><br><span class="line"><span class="attribute">1</span>.<span class="number">1</span>% <span class="number">6670</span>/kworker/u16:<span class="number">0</span>: <span class="number">0</span>% user + <span class="number">1</span>.<span class="number">1</span>% kernel</span><br><span class="line"><span class="attribute">0</span>.<span class="number">9</span>% <span class="number">448</span>/mmc-cmdqd/<span class="number">0</span>: <span class="number">0</span>% user + <span class="number">0</span>.<span class="number">9</span>% kernel</span><br><span class="line"><span class="attribute">0</span>.<span class="number">7</span>% <span class="number">95</span>/system: <span class="number">0</span>% user + <span class="number">0</span>.<span class="number">7</span>% kernel</span><br><span class="line"><span class="attribute">0</span>.<span class="number">6</span>% <span class="number">4512</span>/mdss_fb0: <span class="number">0</span>% user + <span class="number">0</span>.<span class="number">6</span>% kernel</span><br><span class="line"><span class="attribute">0</span>.<span class="number">6</span>% <span class="number">7393</span>/com.android.incallui: <span class="number">0</span>.<span class="number">6</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">2272</span> minor</span><br><span class="line"><span class="attribute">0</span>.<span class="number">6</span>% <span class="number">594</span>/logd: <span class="number">0</span>.<span class="number">4</span>% user + <span class="number">0</span>.<span class="number">1</span>% kernel / faults: <span class="number">38</span> minor <span class="number">3</span> major</span><br><span class="line"><span class="attribute">0</span>.<span class="number">5</span>% <span class="number">3108</span>/com.xiaomi.xmsf: <span class="number">0</span>.<span class="number">2</span>% user + <span class="number">0</span>.<span class="number">2</span>% kernel / faults: <span class="number">1812</span> minor</span><br><span class="line"><span class="attribute">0</span>.<span class="number">5</span>% <span class="number">4526</span>/kworker/u16:<span class="number">9</span>: <span class="number">0</span>% user + <span class="number">0</span>.<span class="number">5</span>% kernel</span><br><span class="line"><span class="attribute">0</span>.<span class="number">5</span>% <span class="number">4621</span>/com.gotokeep.keep: <span class="number">0</span>.<span class="number">3</span>% user + <span class="number">0</span>.<span class="number">1</span>% kernel / faults: <span class="number">55</span> minor</span><br><span class="line"><span class="attribute">0</span>.<span class="number">5</span>% <span class="number">354</span>/irq/<span class="number">267</span>-NVT-ts: <span class="number">0</span>% user + <span class="number">0</span>.<span class="number">5</span>% kernel</span><br><span class="line"><span class="attribute">0</span>.<span class="number">5</span>% <span class="number">2572</span>/com.android.phone: <span class="number">0</span>.<span class="number">3</span>% user + <span class="number">0</span>.<span class="number">1</span>% kernel / faults: <span class="number">323</span> minor</span><br><span class="line"><span class="attribute">0</span>.<span class="number">5</span>% <span class="number">4554</span>/kworker/u16:<span class="number">15</span>: <span class="number">0</span>% user + <span class="number">0</span>.<span class="number">5</span>% kernel</span><br><span class="line"><span class="attribute">0</span>.<span class="number">4</span>% <span class="number">290</span>/kgsl_worker_thr: <span class="number">0</span>% user + <span class="number">0</span>.<span class="number">4</span>% kernel</span><br><span class="line"><span class="attribute">0</span>.<span class="number">3</span>% <span class="number">2933</span>/irq/<span class="number">61</span>-<span class="number">1008000</span>.: <span class="number">0</span>% user + <span class="number">0</span>.<span class="number">3</span>% kernel</span><br><span class="line"><span class="attribute">0</span>.<span class="number">3</span>% <span class="number">3932</span>/com.tencent.mm: <span class="number">0</span>.<span class="number">2</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">647</span> minor <span class="number">1</span> major</span><br><span class="line"><span class="attribute">0</span>.<span class="number">3</span>% <span class="number">4550</span>/kworker/u16:<span class="number">13</span>: <span class="number">0</span>% user + <span class="number">0</span>.<span class="number">3</span>% kernel</span><br><span class="line"><span class="attribute">0</span>.<span class="number">3</span>% <span class="number">744</span>/android.hardware.graphics.allocator@<span class="number">2</span>.<span class="number">0</span>-service: <span class="number">0</span>% user + <span class="number">0</span>.<span class="number">3</span>% kernel / faults: <span class="number">48</span> minor</span><br><span class="line"><span class="attribute">0</span>.<span class="number">3</span>% <span class="number">8906</span>/com.tencent.mm:appbrand0: <span class="number">0</span>.<span class="number">2</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">45</span> minor</span><br><span class="line"><span class="attribute">0</span>.<span class="number">2</span>% <span class="number">79</span>/smem_native_rpm: <span class="number">0</span>% user + <span class="number">0</span>.<span class="number">2</span>% kernel</span><br><span class="line"><span class="attribute">0</span>.<span class="number">2</span>% <span class="number">759</span>/vendor.qti.hardware.perf@<span class="number">1</span>.<span class="number">0</span>-service: <span class="number">0</span>% user + <span class="number">0</span>.<span class="number">2</span>% kernel / faults: <span class="number">46</span> minor</span><br><span class="line"><span class="attribute">0</span>.<span class="number">2</span>% <span class="number">3197</span>/com.miui.powerkeeper: <span class="number">0</span>% user + <span class="number">0</span>.<span class="number">1</span>% kernel / faults: <span class="number">141</span> minor</span><br><span class="line"><span class="attribute">0</span>.<span class="number">2</span>% <span class="number">4489</span>/kworker/<span class="number">1</span>:<span class="number">1</span>: <span class="number">0</span>% user + <span class="number">0</span>.<span class="number">2</span>% kernel</span><br><span class="line"><span class="attribute">0</span>.<span class="number">2</span>% <span class="number">595</span>/servicemanager: <span class="number">0</span>% user + <span class="number">0</span>.<span class="number">2</span>% kernel</span><br><span class="line"><span class="attribute">0</span>.<span class="number">2</span>% <span class="number">754</span>/android.hardware.wifi@<span class="number">1</span>.<span class="number">0</span>-service: <span class="number">0</span>.<span class="number">1</span>% user + <span class="number">0</span>% kernel</span><br><span class="line"><span class="attribute">0</span>.<span class="number">2</span>% <span class="number">1258</span>/jbd2/dm-<span class="number">2</span>-<span class="number">8</span>: <span class="number">0</span>% user + <span class="number">0</span>.<span class="number">2</span>% kernel</span><br><span class="line"><span class="attribute">0</span>.<span class="number">2</span>% <span class="number">5800</span>/com.eg.android.AlipayGphone: <span class="number">0</span>.<span class="number">1</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">48</span> minor</span><br><span class="line"><span class="attribute">0</span>.<span class="number">2</span>% <span class="number">21590</span>/iptables-restore: <span class="number">0</span>% user + <span class="number">0</span>.<span class="number">1</span>% kernel / faults: <span class="number">563</span> minor</span><br><span class="line"><span class="attribute">0</span>.<span class="number">2</span>% <span class="number">21592</span>/ip6tables-restore: <span class="number">0</span>% user + <span class="number">0</span>.<span class="number">1</span>% kernel / faults: <span class="number">647</span> minor</span><br><span class="line"><span class="attribute">0</span>.<span class="number">1</span>% <span class="number">3</span>/ksoftirqd/<span class="number">0</span>: <span class="number">0</span>% user + <span class="number">0</span>.<span class="number">1</span>% kernel</span><br><span class="line"><span class="attribute">0</span>.<span class="number">1</span>% <span class="number">442</span>/cfinteractive: <span class="number">0</span>% user + <span class="number">0</span>.<span class="number">1</span>% kernel</span><br><span class="line"><span class="attribute">0</span>.<span class="number">1</span>% <span class="number">568</span>/ueventd: <span class="number">0</span>% user + <span class="number">0</span>% kernel</span><br><span class="line"><span class="attribute">0</span>.<span class="number">1</span>% <span class="number">1295</span>/netd: <span class="number">0</span>% user + <span class="number">0</span>.<span class="number">1</span>% kernel / faults: <span class="number">250</span> minor</span><br><span class="line"><span class="attribute">0</span>.<span class="number">1</span>% <span class="number">3002</span>/com.miui.securitycenter.remote: <span class="number">0</span>.<span class="number">1</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">818</span> minor <span class="number">1</span> major</span><br><span class="line"><span class="attribute">0</span>.<span class="number">1</span>% <span class="number">20555</span>/com.eg.android.AlipayGphone:push: <span class="number">0</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">20</span> minor</span><br><span class="line"><span class="attribute">0</span>.<span class="number">1</span>% <span class="number">7</span>/rcu_preempt: <span class="number">0</span>% user + <span class="number">0</span>.<span class="number">1</span>% kernel</span><br><span class="line"><span class="attribute">0</span>.<span class="number">1</span>% <span class="number">15</span>/ksoftirqd/<span class="number">1</span>: <span class="number">0</span>% user + <span class="number">0</span>.<span class="number">1</span>% kernel</span><br><span class="line"><span class="attribute">0</span>.<span class="number">1</span>% <span class="number">76</span>/lpass_smem_glin: <span class="number">0</span>% user + <span class="number">0</span>.<span class="number">1</span>% kernel</span><br><span class="line"><span class="attribute">0</span>.<span class="number">1</span>% <span class="number">1299</span>/rild: <span class="number">0</span>.<span class="number">1</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">12</span> minor</span><br><span class="line"><span class="attribute">0</span>.<span class="number">1</span>% <span class="number">1448</span>/android.process.acore: <span class="number">0</span>.<span class="number">1</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">1719</span> minor</span><br><span class="line"><span class="attribute">0</span>% <span class="number">4419</span>/com.google.android.webview:s: <span class="number">0</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">602</span> minor</span><br><span class="line"><span class="attribute">0</span>% <span class="number">20465</span>/com.miui.hybrid: <span class="number">0</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">1575</span> minor</span><br><span class="line"><span class="attribute">0</span>% <span class="number">10</span>/rcuop/<span class="number">0</span>: <span class="number">0</span>% user + <span class="number">0</span>% kernel</span><br><span class="line"><span class="attribute">0</span>% <span class="number">75</span>/smem_native_lpa: <span class="number">0</span>% user + <span class="number">0</span>% kernel</span><br><span class="line"><span class="attribute">0</span>% <span class="number">90</span>/kcompactd0: <span class="number">0</span>% user + <span class="number">0</span>% kernel</span><br><span class="line"><span class="attribute">0</span>% <span class="number">1508</span>/msm_irqbalance: <span class="number">0</span>% user + <span class="number">0</span>% kernel</span><br><span class="line"><span class="attribute">0</span>% <span class="number">1745</span>/cds_mc_thread: <span class="number">0</span>% user + <span class="number">0</span>% kernel</span><br><span class="line"><span class="attribute">0</span>% <span class="number">2899</span>/charge_logger: <span class="number">0</span>% user + <span class="number">0</span>% kernel</span><br><span class="line"><span class="attribute">0</span>% <span class="number">3612</span>/com.tencent.mm:tools: <span class="number">0</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">29</span> minor</span><br><span class="line"><span class="attribute">0</span>% <span class="number">4203</span>/kworker/<span class="number">0</span>:<span class="number">0</span>: <span class="number">0</span>% user + <span class="number">0</span>% kernel</span><br><span class="line"><span class="attribute">0</span>% <span class="number">7377</span>/com.android.server.telecom:ui: <span class="number">0</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">1083</span> minor</span><br><span class="line"><span class="attribute">0</span>% <span class="number">32113</span>/com.tencent.mobileqq: <span class="number">0</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">49</span> minor</span><br><span class="line"><span class="attribute">0</span>% <span class="number">8</span>/rcu_sched: <span class="number">0</span>% user + <span class="number">0</span>% kernel</span><br><span class="line"><span class="attribute">0</span>% <span class="number">22</span>/ksoftirqd/<span class="number">2</span>: <span class="number">0</span>% user + <span class="number">0</span>% kernel</span><br><span class="line"><span class="attribute">0</span>% <span class="number">25</span>/rcuop/<span class="number">2</span>: <span class="number">0</span>% user + <span class="number">0</span>% kernel</span><br><span class="line"><span class="attribute">0</span>% <span class="number">29</span>/ksoftirqd/<span class="number">3</span>: <span class="number">0</span>% user + <span class="number">0</span>% kernel</span><br><span class="line"><span class="attribute">0</span>% <span class="number">39</span>/rcuop/<span class="number">4</span>: <span class="number">0</span>% user + <span class="number">0</span>% kernel</span><br><span class="line"><span class="attribute">0</span>% <span class="number">53</span>/rcuop/<span class="number">6</span>: <span class="number">0</span>% user + <span class="number">0</span>% kernel</span><br><span class="line"><span class="attribute">0</span>% <span class="number">487</span>/irq/<span class="number">715</span>-ima-rdy: <span class="number">0</span>% user + <span class="number">0</span>% kernel</span><br><span class="line"><span class="attribute">0</span>% <span class="number">749</span>/android.hardware.power@<span class="number">1</span>.<span class="number">0</span>-service: <span class="number">0</span>% user + <span class="number">0</span>% kernel</span><br><span class="line"><span class="attribute">0</span>% <span class="number">764</span>/healthd: <span class="number">0</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">2</span> minor</span><br><span class="line"><span class="attribute">0</span>% <span class="number">845</span>/wlan_logging_th: <span class="number">0</span>% user + <span class="number">0</span>% kernel</span><br><span class="line"><span class="attribute">0</span>% <span class="number">860</span>/mm-pp-dpps: <span class="number">0</span>% user + <span class="number">0</span>% kernel</span><br><span class="line"><span class="attribute">0</span>% <span class="number">1297</span>/wificond: <span class="number">0</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">12</span> minor</span><br><span class="line"> <span class="attribute">0</span>% <span class="number">1309</span>/com.miui.weather2: <span class="number">0</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">729</span> minor <span class="number">23</span> major</span><br><span class="line"><span class="attribute">0</span>% <span class="number">1542</span>/rild: <span class="number">0</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">3</span> minor</span><br><span class="line"><span class="attribute">0</span>% <span class="number">2915</span>/tcpdump: <span class="number">0</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">6</span> minor</span><br><span class="line"><span class="attribute">0</span>% <span class="number">2974</span>/com.tencent.mobileqq:MSF: <span class="number">0</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">121</span> minor</span><br><span class="line"><span class="attribute">0</span>% <span class="number">3044</span>/com.miui.contentcatcher: <span class="number">0</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">315</span> minor</span><br><span class="line"><span class="attribute">0</span>% <span class="number">3057</span>/com.miui.dmregservice: <span class="number">0</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">332</span> minor</span><br><span class="line"><span class="attribute">0</span>% <span class="number">3095</span>/com.xiaomi.mircs: <span class="number">0</span>% user + <span class="number">0</span>% kernel</span><br><span class="line"><span class="attribute">0</span>% <span class="number">3115</span>/com.xiaomi.finddevice: <span class="number">0</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">270</span> minor <span class="number">3</span> major</span><br><span class="line"><span class="attribute">0</span>% <span class="number">3513</span>/com.xiaomi.metoknlp: <span class="number">0</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">136</span> minor</span><br><span class="line"><span class="attribute">0</span>% <span class="number">3603</span>/com.tencent.mm:toolsmp: <span class="number">0</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">35</span> minor</span><br><span class="line"><span class="attribute">0</span>% <span class="number">4527</span>/kworker/u16:<span class="number">11</span>: <span class="number">0</span>% user + <span class="number">0</span>% kernel</span><br><span class="line"><span class="attribute">0</span>% <span class="number">4841</span>/com.gotokeep.keep:xg_service_v4: <span class="number">0</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">275</span> minor</span><br><span class="line"><span class="attribute">0</span>% <span class="number">5064</span>/com.sohu.inputmethod.sogou.xiaomi: <span class="number">0</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">102</span> minor</span><br><span class="line"><span class="attribute">0</span>% <span class="number">5257</span>/kworker/<span class="number">0</span>:<span class="number">1</span>: <span class="number">0</span>% user + <span class="number">0</span>% kernel</span><br><span class="line"><span class="attribute">0</span>% <span class="number">5839</span>/com.tencent.mm:push: <span class="number">0</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">98</span> minor</span><br><span class="line"><span class="attribute">0</span>% <span class="number">6644</span>/kworker/<span class="number">3</span>:<span class="number">2</span>: <span class="number">0</span>% user + <span class="number">0</span>% kernel</span><br><span class="line"><span class="attribute">0</span>% <span class="number">6657</span>/com.miui.wmsvc: <span class="number">0</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">52</span> minor</span><br><span class="line"><span class="attribute">0</span>% <span class="number">6945</span>/com.xiaomi.account:accountservice: <span class="number">0</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">1</span> minor</span><br><span class="line"><span class="attribute">0</span>% <span class="number">9387</span>/com.tencent.mm:appbrand1: <span class="number">0</span>% user + <span class="number">0</span>% kernel / faults: <span class="number">27</span> minor</span><br><span class="line"><span class="attribute">13</span>% TOTAL: <span class="number">6</span>.<span class="number">8</span>% user + <span class="number">5</span>.<span class="number">3</span>% kernel + <span class="number">0</span>.<span class="number">2</span>% iowait + <span class="number">0</span>.<span class="number">3</span>% irq + <span class="number">0</span>.<span class="number">4</span>% softirq</span><br></pre></td></tr></table></figure>

<p>从上述信息可知，<strong>第一行显示的是cpuload （负载平均值）信息</strong>：Load: 1.92 &#x2F; 1.59 &#x2F; 0.97 这<strong>三个数字表示逐渐变长的时间段（平均一分钟，五分钟和十五分钟）的平均值，而较低的数字则更好</strong>。数字越大表示有问题或机器过载。需要注意的是，这里的<strong>Load需要除以核心数</strong>，比如我这里的系统核心数为8核，所以最终每一个单核CPU的Load为0.24 &#x2F; 0.20 &#x2F; 0.12，<strong>如果Load超过1，则表示出现了问题</strong>。</p>
<p>此外，<strong>占用系统CPU资源最高的是system_server进程</strong>，而我们的wanandroid应用进程仅占用了 1.4%的CPU资源，其中有0.9%的是用户态所占用的时间，0.4%是内核态所占用的时间。最后，我们可以看到系统总占用的CPU时间是13%，这个值是根据<strong>前面所有值加起来 &#x2F; 系统CPU数</strong>的处理的，也就是**104% &#x2F;  8 &#x3D; 13%**。</p>
<p>除了上述方式来分析系统与应用的CPU使用情况之外，我们还应该关注卡顿率与卡顿树这两个指标。它们能帮助我们有效地去评估、并且更有针对性地去优化应用发生的卡顿。</p>
<h4 id="卡顿率"><a href="#卡顿率" class="headerlink" title="卡顿率"></a>卡顿率</h4><p>类似于<a href="https://link.juejin.cn/?target=https://jsonchao.github.io/2019/11/24/%E6%B7%B1%E5%85%A5%E6%8E%A2%E7%B4%A2Android%E7%A8%B3%E5%AE%9A%E6%80%A7%E4%BC%98%E5%8C%96/">深入探索Android稳定性优化</a>一文中讲到的UV、PV崩溃率，卡顿也可以有其对应的UV、PV卡顿率，<strong>UV就是Unique visitor，指的就是一台手机客户端为一个访客，00:00-24:00内相同的客户端只被计算一次</strong>。而<strong>PV即Page View，即页面浏览量或点击量</strong>。所以UV、PV卡顿率的定义即为如下所示：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">//</span> UV 卡顿率可以评估卡顿的影响范围</span><br><span class="line">UV 卡顿率 = 发生过卡顿 UV / 开启卡顿采集 UV</span><br><span class="line"><span class="regexp">//</span> PV 卡顿率评估卡顿的严重程度</span><br><span class="line">PV 卡顿率 = 发生过卡顿 PV / 启动采集 PV</span><br></pre></td></tr></table></figure>

<p>因为卡顿问题的采样规则跟内存问题是相似的，一般都是采取<strong>抽样上报</strong>的方式，并且都应该<strong>按照单个用户来抽样</strong>。<strong>一个用户如果命中采集，那么在一天内都会持续的采集数据</strong>。</p>
<h4 id="卡顿树"><a href="#卡顿树" class="headerlink" title="卡顿树"></a>卡顿树</h4><p>我们可以实现卡顿的火焰图，即卡顿树，在一张图里就可以看到卡顿的整体信息。由于卡顿的具体耗时跟手机性能，还有当时的使用场景、环境等密切相关，而且卡顿问题在日活大的应用上出现的场景非常多，所以对于大于我们指定的卡顿阈值如1s\2s\3s时，我们就可以抛弃具体的耗时，只<strong>按照相同堆栈出现的比例来聚合各类卡顿信息</strong>。这样我们就能够<strong>很直观地从卡顿树上看到到底哪些堆栈出现的卡顿问题最多</strong>，以便于我们能够<strong>优先去解决 Top 的卡顿问题</strong>，达到使用最少的精力获取最大的优化效果的目的。</p>
<h2 id="3、卡顿优化工具"><a href="#3、卡顿优化工具" class="headerlink" title="3、卡顿优化工具"></a>3、卡顿优化工具</h2><h3 id="1、CPU-Profiler回顾"><a href="#1、CPU-Profiler回顾" class="headerlink" title="1、CPU Profiler回顾"></a>1、CPU Profiler回顾</h3><p>CPU Profiler的使用笔者已经在<a href="https://link.juejin.cn/?target=https://jsonchao.github.io/2019/11/10/%E6%B7%B1%E5%85%A5%E6%8E%A2%E7%B4%A2Android%E5%90%AF%E5%8A%A8%E9%80%9F%E5%BA%A6%E4%BC%98%E5%8C%96/">深入探索Android启动速度优化</a>中详细分析过了，如果对CPU Profiler还不是很熟悉的话，可以去看看这篇文章。</p>
<p>下面我们来简单来回顾一下CPU Profiler。</p>
<h4 id="优势："><a href="#优势：" class="headerlink" title="优势："></a>优势：</h4><ul>
<li>图形的形式展示执行时间、调用栈等。</li>
<li>信息全面，包含所有线程。</li>
</ul>
<h4 id="劣势："><a href="#劣势：" class="headerlink" title="劣势："></a>劣势：</h4><p>运行时开销严重，整体都会变慢，可能会带偏我们的优化方向。</p>
<h4 id="使用方式："><a href="#使用方式：" class="headerlink" title="使用方式："></a>使用方式：</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="module-access"><span class="module"><span class="identifier">Debug</span>.</span></span>start<span class="constructor">MethodTracing(<span class="string">&quot;&quot;</span>)</span>;</span><br><span class="line"><span class="comment">// 需要检测的代码片段</span><span class="operator"></span></span><br><span class="line"><span class="operator">...</span></span><br><span class="line"><span class="operator"></span><span class="module-access"><span class="module"><span class="identifier">Debug</span>.</span></span>stop<span class="constructor">MethodTracing()</span>;</span><br></pre></td></tr></table></figure>

<p>最终生成的生成文件在sd卡：Android&#x2F;data&#x2F;packagename&#x2F;files。</p>
<h3 id="2、Systrace回顾"><a href="#2、Systrace回顾" class="headerlink" title="2、Systrace回顾"></a>2、Systrace回顾</h3><p>systrace 利用了 <strong>Linux 的ftrace调试工具（ftrace是用于了解Linux内核内部运行情况的调试工具），相当于在系统各个关键位置都添加了一些性能探针，也就是在代码里加了一些性能监控的埋点。Android 在 ftrace 的基础上封装了atrace，并增加了更多特有的探针，比如Graphics、Activity Manager、Dalvik VM、System Server 等等</strong>。对于Systrace的使用笔者在<a href="https://link.juejin.cn/?target=https://jsonchao.github.io/2019/11/10/%E6%B7%B1%E5%85%A5%E6%8E%A2%E7%B4%A2Android%E5%90%AF%E5%8A%A8%E9%80%9F%E5%BA%A6%E4%BC%98%E5%8C%96/">深入探索Android启动速度优化</a>这篇文章中已经详细分析过了，如果对Systrace还不是很熟悉的话可以去看看这篇文章。</p>
<p>下面我们来简单回顾一下Systrace。</p>
<h4 id="作用："><a href="#作用：" class="headerlink" title="作用："></a>作用：</h4><p>监控和跟踪API调用、线程运行情况，生成HTML报告。</p>
<h4 id="建议："><a href="#建议：" class="headerlink" title="建议："></a>建议：</h4><p>API 18以上使用，推荐使用TraceCompat。</p>
<h4 id="使用方式：-1"><a href="#使用方式：-1" class="headerlink" title="使用方式："></a>使用方式：</h4><p>使用python命令执行脚本，后面加上一系列参数，如下所示：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python systrace.py -t <span class="number">10</span> [other-<span class="keyword">options</span>] [categories]</span><br><span class="line"><span class="comment">// 笔者通常使用的systrace配置</span></span><br><span class="line">python <span class="regexp">/Users/</span>quchao<span class="regexp">/Library/</span>Android<span class="regexp">/sdk/</span>platform-tools<span class="regexp">/systrace/</span>systrace.py -t <span class="number">20</span> sched gfx view wm am app webview -a <span class="string">&quot;com.wanandroid.json.chao&quot;</span> -o ~<span class="regexp">/Documents/</span>open-<span class="keyword">project</span><span class="regexp">/systrace_data/</span>wanandroid_start_1.html</span><br></pre></td></tr></table></figure>

<p>具体参数含义如下：</p>
<ul>
<li>-t：指定统计时间为20s。</li>
<li>shced：cpu调度信息。</li>
<li>gfx：图形信息。</li>
<li>view：视图。</li>
<li>wm：窗口管理。</li>
<li>am：活动管理。</li>
<li>app：应用信息。</li>
<li>webview：webview信息。</li>
<li>-a：指定目标应用程序的包名。</li>
<li>-o：生成的systrace.html文件。</li>
</ul>
<h4 id="优势：-1"><a href="#优势：-1" class="headerlink" title="优势："></a>优势：</h4><ul>
<li>1、轻量级，开销小。</li>
<li>2、它能够直观地反映CPU的利用率。</li>
<li>3、右侧的Alerts能够根据我们应用的问题给出具体的建议，比如说，它会告诉我们App界面的<strong>绘制比较慢或者GC比较频繁</strong>。</li>
</ul>
<p>最后，我们还可以通过编译时给每个函数插桩的方式来实现线下自动增加应用程序的耗时分析，但是要注意需<strong>过滤大部分的短函数，以减少性能损耗</strong>（这一点可以<strong>通过黑名单配置的方式去过滤短函数或调用非常频繁的函数</strong>）。使用这种方式我们就可以看到<strong>整个应用程序的调用流程。包括应用关键线程的函数调用，例如渲染耗时、线程锁，GC 耗时等等</strong>。这里可以使用zhengcx的<a href="https://link.juejin.cn/?target=https://github.com/zhengcx/MethodTraceMan/blob/master/README.md">MethodTraceMan</a>，但是目前仅仅能实现对包名和类名的过滤配置，所以需要对源码进行定制化，以支持过滤短函数或调用非常频繁函数的配置功能。</p>
<p>基于性能的考虑，<strong>如果要在线上使用此方案，最好只去监控主线程的耗时</strong>。虽然插桩方案对性能的影响并不是很大，但是建议仅在线下或灰度环境中使用。</p>
<p>此外，如果你需要分析Native 函数的调用，请使用Android 5.0 新增的<a href="https://link.juejin.cn/?target=https://android.googlesource.com/platform/system/extras/+/master/simpleperf/doc/README.md">Simpleperf</a>性能分析工具，它<strong>利用了 CPU 的性能监控单元（PMU）提供的硬件 perf 事件</strong>。使用 Simpleperf 可以看到所有的 Native 代码的耗时，对<strong>一些 Android 系统库的调用</strong>，在分析问题时有比较大的帮助，例如分析<strong>加载 dex、verify class 的耗时等等</strong>。此外，在 Android Studio 3.2 中的 Profiler 也直接支持了 Simpleper（SampleNative性能分析工具 (API Level 26+)），这更加方便了native代码的调试。</p>
<h3 id="3、StrictMode"><a href="#3、StrictMode" class="headerlink" title="3、StrictMode"></a>3、StrictMode</h3><p>StrictMode是Android 2.3引入的一个工具类，它被称为严苛模式，是Android提供的一种<strong>运行时检测机制</strong>，可以用来帮助开发人员用来检测代码中一些不规范的问题。对于我们的项目当中，可能会成千上万行代码，如果我们用肉眼Review，这样不仅效率非常低效，而且比较容易出问题。使用StrictMode之后，<strong>系统会自动检测出来在主线程中的一些异常情况，并按照我们的配置给出相应的反应</strong>。</p>
<p>StrictMode这个工具是非常强大的，但是我们可能因为对它不熟悉而忽略掉它。StrictMode主要用来检测两大问题：</p>
<h4 id="1、线程策略"><a href="#1、线程策略" class="headerlink" title="1、线程策略"></a>1、线程策略</h4><p>线程策略的检测内容，是一些<strong>自定义的耗时调用、磁盘读取操作以及网络请求等</strong>。</p>
<h4 id="2、虚拟机策略"><a href="#2、虚拟机策略" class="headerlink" title="2、虚拟机策略"></a>2、虚拟机策略</h4><p>虚拟机策略的检测内容如下：</p>
<ul>
<li><strong>Activity泄漏</strong></li>
<li><strong>Sqlite对象泄漏</strong></li>
<li><strong>检测实例数量</strong></li>
</ul>
<h4 id="StrictMode实战"><a href="#StrictMode实战" class="headerlink" title="StrictMode实战"></a>StrictMode实战</h4><p>如果要在应用中使用StrictMode，只需要在Applicaitoin的onCreate方法中对StrictMode进行统一配置，代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initStrictMode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1、设置Debug标志位，仅仅在线下环境才使用StrictMode</span></span><br><span class="line">    <span class="keyword">if</span> (DEV_MODE) &#123;</span><br><span class="line">        <span class="comment">// 2、设置线程策略</span></span><br><span class="line">        StrictMode.setThreadPolicy(<span class="keyword">new</span> <span class="title class_">StrictMode</span>.ThreadPolicy.Builder()</span><br><span class="line">                .detectCustomSlowCalls() <span class="comment">//API等级11，使用StrictMode.noteSlowCode</span></span><br><span class="line">                .detectDiskReads()</span><br><span class="line">                .detectDiskWrites()</span><br><span class="line">                .detectNetwork() <span class="comment">// or .detectAll() for all detectable problems</span></span><br><span class="line">                .penaltyLog() <span class="comment">//在Logcat 中打印违规异常信息</span></span><br><span class="line"><span class="comment">//              .penaltyDialog() //也可以直接跳出警报dialog</span></span><br><span class="line"><span class="comment">//              .penaltyDeath() //或者直接崩溃</span></span><br><span class="line">                .build());</span><br><span class="line">        <span class="comment">// 3、设置虚拟机策略</span></span><br><span class="line">        StrictMode.setVmPolicy(<span class="keyword">new</span> <span class="title class_">StrictMode</span>.VmPolicy.Builder()</span><br><span class="line">                .detectLeakedSqlLiteObjects()</span><br><span class="line">                <span class="comment">// 给NewsItem对象的实例数量限制为1</span></span><br><span class="line">                .setClassInstanceLimit(NewsItem.class, <span class="number">1</span>)</span><br><span class="line">                .detectLeakedClosableObjects() <span class="comment">//API等级11</span></span><br><span class="line">                .penaltyLog()</span><br><span class="line">                .build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后，在日志输出栏中注意使用“StrictMode”关键字过滤出对应的log即可。</p>
<h2 id="4、Profilo"><a href="#4、Profilo" class="headerlink" title="4、Profilo"></a>4、Profilo</h2><p>Profilo是一个用于收集应用程序生产版本的性能跟踪的Android库。</p>
<p>对于Profilo来说，它<strong>集成了atrace功能，ftrace 所有的性能埋点数据都会通过 trace_marker 文件写入到内核缓冲区，Profilo 使用了 PLT Hook 拦截了写入操作，以选择部分关心的事件去做特定的分析</strong>。这样所有的 systrace 的探针我们都可以拿到，例如<strong>四大组件生命周期、锁等待时间、类校验、GC 时间等等</strong>。不过大部分的 atrace 事件都比较笼统，从事件“B|pid|activityStart”，我们无法明确知道该事件具体是由哪个 Activity 来创建的。</p>
<p>此外，使用Profilo还能够快速获取Java堆栈。<strong>由于获取堆栈需要暂停主线程的运行，所以profilo通过间隔发送 SIGPROF 信号这样一种类似 Native 崩溃捕捉的方式去快速获取 Java 堆栈</strong>。</p>
<p><strong>Profilo能够低耗时地快速获取Java堆栈的具体实现原理为当Signal Handler 捕获到信号后，它就会获取到当前正在执行的 Thread，通过 Thread 对象就可以拿到当前线程的 ManagedStack，ManagedStack 是一个单链表，它保存了当前的 ShadowFrame 或者 QuickFrame 栈指针，先依次遍历 ManagedStack 链表，然后遍历其内部的 ShadowFrame 或者 QuickFrame 还原一个可读的调用栈，从而 unwind 出当前的 Java 堆栈</strong>。关于ManagedStack与ShadowFrame、QuickFrame三者的关系如下图所示:</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ef94b276db234359a0133603d5886aff~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p>Profilo通过这种方式，就可以实现线程同步运行的同时，我们还可以去帮它做检查，并且耗时基本可以忽略不计。但是目前 Profilo 快速获取堆栈的功能不支持 Android 8.0 和 Android 9.0，并且它内部使用了Hook等大量的黑科技手段，鉴于稳定性问题，建议采取<strong>抽样部分用户</strong>的方式来开启该功能。</p>
<p><a href="https://link.juejin.cn/?target=https://github.com/facebookincubator/profilo">Profilo项目地址</a></p>
<p>前面我们说过，Profilo最终也使用了ftrace，而Systrace主要也是根据Linux的ftrace机制来实现的，而<strong>ftrace的作用是帮助我们了解 Linux 内核的运行时行为，以便进行故障调试或性能分析</strong>。ftrace的整体架构如下所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0ed4c4f85af74f5f9265369cc790943a~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p>由上图可知，<strong>Ftrace 有两大组成部分，一个是 framework，另外就是一系列的 tracer 。每个 tracer 用于完成不同的功能，并且它们统一由 framework 管理。 ftrace 的 trace 信息保存在 ring buffer 中，由 framework 负责管理。 Framework 利用 debugfs 系统在 &#x2F;debugfs 下建立 tracing 目录，并提供了一系列的控制文件。</strong></p>
<p>下面，我这里给出使用 PLTHook 技术来获取 Atrace 日志的一个项目。</p>
<h3 id="1、使用profilo的PLTHook来hook-libc-so的-write-与-write-chk-方法"><a href="#1、使用profilo的PLTHook来hook-libc-so的-write-与-write-chk-方法" class="headerlink" title="1、使用profilo的PLTHook来hook libc.so的 write 与 __write_chk 方法"></a>1、使用profilo的PLTHook来hook libc.so的 write 与 __write_chk 方法</h3><p><a href="https://link.juejin.cn/?target=https://github.com/AndroidAdvanceWithGeektime/Chapter06">使用 PLTHook 技术来获取 Atrace 的日志-项目地址</a></p>
<p>运行项目后，我们点击按钮开启Atrace日志，然后就可以在Logcat中看到如下的native层日志信息：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">873</span> <span class="number">13052</span>-<span class="number">13052</span>/com.dodola.atrace I/HOOOOOOOOK: ===============install systrace hoook==================</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">879</span> <span class="number">13052</span>-<span class="number">13052</span>/com.dodola.atrace I/HOOOOOOOOK: ========= B|<span class="number">13052</span>|inflate</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">880</span> <span class="number">13052</span>-<span class="number">13052</span>/com.dodola.atrace I/HOOOOOOOOK: ========= B|<span class="number">13052</span>|LinearLayout</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">881</span> <span class="number">13052</span>-<span class="number">13052</span>/com.dodola.atrace I/HOOOOOOOOK: ========= E</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">882</span> <span class="number">13052</span>-<span class="number">13052</span>/com.dodola.atrace I/HOOOOOOOOK: ========= B|<span class="number">13052</span>|TextView</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">884</span> <span class="number">13052</span>-<span class="number">13052</span>/com.dodola.atrace I/HOOOOOOOOK: ========= E</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">885</span> <span class="number">13052</span>-<span class="number">13052</span>/com.dodola.atrace I/HOOOOOOOOK: ========= E</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">888</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= B|<span class="number">13052</span>|notifyFramePending</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">888</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= E</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">889</span> <span class="number">13052</span>-<span class="number">13052</span>/com.dodola.atrace I/HOOOOOOOOK: ========= B|<span class="number">13052</span>|Choreographer#doFrame</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">889</span> <span class="number">13052</span>-<span class="number">13052</span>/com.dodola.atrace I/HOOOOOOOOK: ========= B|<span class="number">13052</span>|input</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">889</span> <span class="number">13052</span>-<span class="number">13052</span>/com.dodola.atrace I/HOOOOOOOOK: ========= E</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">889</span> <span class="number">13052</span>-<span class="number">13052</span>/com.dodola.atrace I/HOOOOOOOOK: ========= B|<span class="number">13052</span>|traversal</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">889</span> <span class="number">13052</span>-<span class="number">13052</span>/com.dodola.atrace I/HOOOOOOOOK: ========= B|<span class="number">13052</span>|draw</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">890</span> <span class="number">13052</span>-<span class="number">13052</span>/com.dodola.atrace I/HOOOOOOOOK: ========= B|<span class="number">13052</span>|Record View#draw()</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">891</span> <span class="number">13052</span>-<span class="number">13052</span>/com.dodola.atrace I/HOOOOOOOOK: ========= E</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">891</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= B|<span class="number">13052</span>|DrawFrame</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">891</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= B|<span class="number">13052</span>|syncFrameState</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">891</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= B|<span class="number">13052</span>|prepareTree</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">891</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= E</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">891</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= E</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">891</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= B|<span class="number">13052</span>|query</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">891</span> <span class="number">13052</span>-<span class="number">13052</span>/com.dodola.atrace I/HOOOOOOOOK: ========= E</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">891</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= E</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">891</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= B|<span class="number">13052</span>|query</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">891</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= E</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">892</span> <span class="number">13052</span>-<span class="number">13052</span>/com.dodola.atrace I/HOOOOOOOOK: ========= E</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">892</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= B|<span class="number">13052</span>|query</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">892</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= E</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">892</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= B|<span class="number">13052</span>|query</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">892</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= E</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">892</span> <span class="number">13052</span>-<span class="number">13052</span>/com.dodola.atrace I/HOOOOOOOOK: ========= E</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">892</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= B|<span class="number">13052</span>|query</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">892</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= E</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">892</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= B|<span class="number">13052</span>|query</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">892</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= E</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">892</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= B|<span class="number">13052</span>|setBuffersDimensions</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">892</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= E</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">892</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= B|<span class="number">13052</span>|dequeueBuffer</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">894</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= B|<span class="number">13052</span>|importBuffer</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">894</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= B|<span class="number">13052</span>|HIDL::IMapper::importBuffer::passthrough</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">894</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= E</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">894</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= E</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">894</span> <span class="number">13052</span>-<span class="number">13058</span>/com.dodola.atrace I/HOOOOOOOOK: ========= B|<span class="number">13052</span>|Compiling</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">894</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= E</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">00</span>.<span class="number">894</span> <span class="number">13052</span>-<span class="number">13075</span>/com.dodola.atrace I/HOOOOOOOOK: ========= B|<span class="number">13052</span>|query</span><br></pre></td></tr></table></figure>

<p>需要注意的是，日志中的B代表begin，也就是对应时间开始的时间，而E代表End，即对应事件结束的时间，并且，B|事件和E|事件是成对出现的，这样我们就可以<strong>通过该事件的结束时间减去对应的开始时间来获得每个事件使用的时间</strong>。例如，上述log中我们可以看出TextView的draw方法显示使用了3ms。</p>
<p>此外，在下面这个项目里展示了如何使用 PLTHook 技术来获取线程创建的堆栈。</p>
<h3 id="2、使用PLTHook技术来获取线程创建的堆栈"><a href="#2、使用PLTHook技术来获取线程创建的堆栈" class="headerlink" title="2、使用PLTHook技术来获取线程创建的堆栈"></a>2、使用PLTHook技术来获取线程创建的堆栈</h3><p><a href="https://link.juejin.cn/?target=https://github.com/AndroidAdvanceWithGeektime/Chapter06-plus">使用 PLTHook 技术来获取线程创建的堆栈-项目地址</a></p>
<p>运行项目后，我们点击开启 Thread Hook按钮，然后点击新建 Thread按钮。最后可以在Logcat 中看到Thread创建的堆栈信息：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">13</span>:<span class="number">47</span>:<span class="number">59.006</span> <span class="number">20159</span>-<span class="number">20159</span>/com<span class="selector-class">.dodola</span><span class="selector-class">.thread</span> E/HOOOOOOOOK: stack:com<span class="selector-class">.dodola</span><span class="selector-class">.thread</span><span class="selector-class">.ThreadHook</span><span class="selector-class">.getStack</span>(ThreadHook<span class="selector-class">.java</span>:<span class="number">16</span>)</span><br><span class="line">com<span class="selector-class">.dodola</span><span class="selector-class">.thread</span>.MainActivity$<span class="number">2</span><span class="selector-class">.onClick</span>(MainActivity<span class="selector-class">.java</span>:<span class="number">40</span>)</span><br><span class="line">android<span class="selector-class">.view</span><span class="selector-class">.View</span><span class="selector-class">.performClick</span>(View<span class="selector-class">.java</span>:<span class="number">6311</span>)</span><br><span class="line">android<span class="selector-class">.view</span>.View<span class="variable">$PerformClick</span><span class="selector-class">.run</span>(View<span class="selector-class">.java</span>:<span class="number">24833</span>)</span><br><span class="line">android<span class="selector-class">.os</span><span class="selector-class">.Handler</span><span class="selector-class">.handleCallback</span>(Handler<span class="selector-class">.java</span>:<span class="number">794</span>)</span><br><span class="line">android<span class="selector-class">.os</span><span class="selector-class">.Handler</span><span class="selector-class">.dispatchMessage</span>(Handler<span class="selector-class">.java</span>:<span class="number">99</span>)</span><br><span class="line">android<span class="selector-class">.os</span><span class="selector-class">.Looper</span><span class="selector-class">.loop</span>(Looper<span class="selector-class">.java</span>:<span class="number">173</span>)</span><br><span class="line">android<span class="selector-class">.app</span><span class="selector-class">.ActivityThread</span><span class="selector-class">.main</span>(ActivityThread<span class="selector-class">.java</span>:<span class="number">6653</span>)</span><br><span class="line">java<span class="selector-class">.lang</span><span class="selector-class">.reflect</span><span class="selector-class">.Method</span><span class="selector-class">.invoke</span>(Native Method)</span><br><span class="line">com<span class="selector-class">.android</span><span class="selector-class">.internal</span><span class="selector-class">.os</span>.RuntimeInit<span class="variable">$MethodAndArgsCaller</span><span class="selector-class">.run</span>(RuntimeInit<span class="selector-class">.java</span>:<span class="number">547</span>)</span><br><span class="line">com<span class="selector-class">.android</span><span class="selector-class">.internal</span><span class="selector-class">.os</span><span class="selector-class">.ZygoteInit</span><span class="selector-class">.main</span>(ZygoteInit<span class="selector-class">.java</span>:<span class="number">821</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">13</span>:<span class="number">47</span>:<span class="number">59.007</span> <span class="number">20159</span>-<span class="number">20339</span>/com<span class="selector-class">.dodola</span><span class="selector-class">.thread</span> E/HOOOOOOOOK: thread name:Thread-<span class="number">2</span></span><br><span class="line"><span class="number">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">13</span>:<span class="number">47</span>:<span class="number">59.008</span> <span class="number">20159</span>-<span class="number">20339</span>/com<span class="selector-class">.dodola</span><span class="selector-class">.thread</span> E/HOOOOOOOOK: thread id:<span class="number">1057</span></span><br><span class="line"><span class="number">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">13</span>:<span class="number">47</span>:<span class="number">59.009</span> <span class="number">20159</span>-<span class="number">20339</span>/com<span class="selector-class">.dodola</span><span class="selector-class">.thread</span> E/HOOOOOOOOK: stack:com<span class="selector-class">.dodola</span><span class="selector-class">.thread</span><span class="selector-class">.ThreadHook</span><span class="selector-class">.getStack</span>(ThreadHook<span class="selector-class">.java</span>:<span class="number">16</span>)</span><br><span class="line">com<span class="selector-class">.dodola</span><span class="selector-class">.thread</span>.MainActivity$<span class="number">2</span>$<span class="number">1</span><span class="selector-class">.run</span>(MainActivity<span class="selector-class">.java</span>:<span class="number">38</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">13</span>:<span class="number">47</span>:<span class="number">59.011</span> <span class="number">20159</span>-<span class="number">20340</span>/com<span class="selector-class">.dodola</span><span class="selector-class">.thread</span> E/HOOOOOOOOK: inner thread name:Thread-<span class="number">3</span></span><br><span class="line"><span class="number">2020</span>-<span class="number">02</span>-<span class="number">05</span> <span class="number">13</span>:<span class="number">47</span>:<span class="number">59.012</span> <span class="number">20159</span>-<span class="number">20340</span>/com<span class="selector-class">.dodola</span><span class="selector-class">.thread</span> E/HOOOOOOOOK: inner thread id:<span class="number">1058</span></span><br></pre></td></tr></table></figure>

<p>由于Profilo与PLT Hook涉及了大量的C&#x2F;C++、NDK开发的知识，限于篇幅，所以这部分不做详细讲解，如对NDK开发感兴趣的同学可以期待下我后面的<a href="https://link.juejin.cn/?target=https://github.com/JsonChao/Awesome-Android-NDK">Awesome-Android-NDK系列文章</a>，等性能优化系列文章更新完毕之后，就会开始去系统地学习NDK相关的开发知识，敬请期待。</p>
<h1 id="二、自动化卡顿检测方案及优化"><a href="#二、自动化卡顿检测方案及优化" class="headerlink" title="二、自动化卡顿检测方案及优化"></a>二、自动化卡顿检测方案及优化</h1><h2 id="1、为什么需要自动化卡顿检测方案？"><a href="#1、为什么需要自动化卡顿检测方案？" class="headerlink" title="1、为什么需要自动化卡顿检测方案？"></a>1、为什么需要自动化卡顿检测方案？</h2><p>主要有以下两点原因：</p>
<ul>
<li>1、Cpu Profiler、Systrace等系统工具仅适合线下针对性分析。</li>
<li>2、线上及测试环境需要自动化的卡顿检方案来定位卡顿，同时，更重要的是，它能记录卡顿发生时的场景。</li>
</ul>
<h2 id="2、卡顿检测方案原理"><a href="#2、卡顿检测方案原理" class="headerlink" title="2、卡顿检测方案原理"></a>2、卡顿检测方案原理</h2><p>它的原理源于Android的消息处理机制，<strong>一个线程不管有多少Handler，它只会有一个Looper存在，主线程执行的任何代码都会通过Looper.loop()方法执行。而在Looper函数中，它有一个mLogging对象，这个对象在每个message处理前后都会被调用。主线程发生了卡顿，那一定是在dispatchMessage()方法中执行了耗时操作。那么，我们就可以通过这个mLogging对象对dispatchMessage()进行监控</strong>。</p>
<h3 id="卡顿检测方案的具体实现步骤"><a href="#卡顿检测方案的具体实现步骤" class="headerlink" title="卡顿检测方案的具体实现步骤"></a>卡顿检测方案的具体实现步骤</h3><p>首先，我们看下Looper用于执行消息循环的loop()方法，关键代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Run the message queue in this thread. Be sure to call</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #quit()&#125; to end the loop.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> queue.next(); <span class="comment">// might block</span></span><br><span class="line">        <span class="keyword">if</span> (msg == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// No message indicates that the message queue is quitting.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This must be in a local variable, in case a UI event sets the logger</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Printer</span> <span class="variable">logging</span> <span class="operator">=</span> me.mLogging;</span><br><span class="line">        <span class="keyword">if</span> (logging != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 1</span></span><br><span class="line">            logging.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt; Dispatching to &quot;</span> + msg.target + <span class="string">&quot; &quot;</span> +</span><br><span class="line">                    msg.callback + <span class="string">&quot;: &quot;</span> + msg.what);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">             <span class="comment">// 2 </span></span><br><span class="line">             msg.target.dispatchMessage(msg);</span><br><span class="line">            dispatchEnd = needEndTime ? SystemClock.uptimeMillis() : <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (traceTag != <span class="number">0</span>) &#123;</span><br><span class="line">                Trace.traceEnd(traceTag);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (logging != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 3</span></span><br><span class="line">            logging.println(<span class="string">&quot;&lt;&lt;&lt;&lt;&lt; Finished to &quot;</span> + msg.target + <span class="string">&quot; &quot;</span> + msg.callback);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>在Looper的loop()方法中，在其执行每一个消息（注释2处）的前后都由logging进行了一次打印输出。可以看到，在执行消息前是输出的”&gt;&gt;&gt;&gt;&gt; Dispatching to “，在执行消息后是输出的”&lt;&lt;&lt;&lt;&lt; Finished to “,它们打印的日志是不一样的，我们就可以由此来判断消息执行的前后时间点。</p>
<p>所以，具体的实现可以归纳为如下步骤：</p>
<ul>
<li>1、<strong>首先，我们需要使用Looper.getMainLooper().setMessageLogging()去设置我们自己的Printer实现类去打印输出logging。这样，在每个message执行的之前和之后都会调用我们设置的这个Printer实现类。</strong></li>
<li>2、<strong>如果我们匹配到”&gt;&gt;&gt;&gt;&gt; Dispatching to “之后，我们就可以执行一行代码：也就是在指定的时间阈值之后，我们在子线程去执行一个任务，这个任务就是去获取当前主线程的堆栈信息以及当前的一些场景信息，比如：内存大小、电脑、网络状态等。</strong></li>
<li>3、<strong>如果在指定的阈值之内匹配到了”&lt;&lt;&lt;&lt;&lt; Finished to “，那么说明message就被执行完成了，则表明此时没有产生我们认为的卡顿效果，那我们就可以将这个子线程任务取消掉。</strong></li>
</ul>
<h2 id="3、AndroidPerformanceMonitor"><a href="#3、AndroidPerformanceMonitor" class="headerlink" title="3、AndroidPerformanceMonitor"></a>3、AndroidPerformanceMonitor</h2><p>它是一个非侵入式的性能监控组件，可以通过通知的形式弹出卡顿信息。它的原理就是我们刚刚讲述到的卡顿监控的实现原理。</p>
<p>接下我们通过一个简单的示例来讲解一下它的使用。</p>
<p>首先，我们需要在moudle的build.gradle下配置它的依赖，如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// release：项目中实现了线上监控体系的时候去使用</span></span><br><span class="line">api <span class="string">&#x27;com.github.markzhai:blockcanary-android:1.5.0&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 仅在debug包启用BlockCanary进行卡顿监控和提示的话，可以这么用</span></span><br><span class="line">debugApi <span class="string">&#x27;com.github.markzhai:blockcanary-android:1.5.0&#x27;</span></span><br><span class="line">releaseApi <span class="string">&#x27;com.github.markzhai:blockcanary-no-op:1.5.0&#x27;</span></span><br></pre></td></tr></table></figure>

<p>其次，在Application的onCreate方法中开启卡顿监控：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 注意在主进程初始化调用</span></span><br><span class="line">BlockCanary.install(<span class="built_in">this</span>, <span class="keyword">new</span> <span class="title class_">AppBlockCanaryContext</span>()).start();</span><br></pre></td></tr></table></figure>

<p>最后，继承BlockCanaryContext类去实现自己的监控配置上下文类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppBlockCanaryContext</span> <span class="keyword">extends</span> <span class="title class_">BlockCanaryContext</span> &#123;</span><br><span class="line">    <span class="comment">// 实现各种上下文，包括应用标识符，用户uid，网络类型，卡顿判断阙值，Log保存位置等等</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 提供应用的标识符</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> 标识符能够在安装的时候被指定，建议为 version + flavor.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">provideQualifier</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 提供用户uid，以便在上报时能够将对应的</span></span><br><span class="line"><span class="comment">    * 用户信息上报至服务器 </span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> user id</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">provideUid</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;uid&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 提供当前的网络类型</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> &#123;<span class="doctag">@link</span> String&#125; like 2G, 3G, 4G, wifi, etc.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">provideNetworkType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 配置监控的时间区间，超过这个时间区间    ，BlockCanary将会停止, use</span></span><br><span class="line"><span class="comment">    * with &#123;<span class="doctag">@code</span> BlockCanary&#125;&#x27;s isMonitorDurationEnd</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> monitor last duration (in hour)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">provideMonitorDuration</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 指定判定为卡顿的阈值threshold (in millis),  </span></span><br><span class="line"><span class="comment">    * 你可以根据不同设备的性能去指定不同的阈值</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> threshold in mills</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">provideBlockThreshold</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 设置线程堆栈dump的间隔, 当阻塞发生的时候使用, BlockCanary 将会根据</span></span><br><span class="line"><span class="comment">    * 当前的循环周期在主线程去dump堆栈信息</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;</span></span><br><span class="line"><span class="comment">    * 由于依赖于Looper的实现机制, 真实的dump周期 </span></span><br><span class="line"><span class="comment">    * 将会比设定的dump间隔要长(尤其是当CPU很繁忙的时候).</span></span><br><span class="line"><span class="comment">    * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> dump interval (in millis)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">provideDumpInterval</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> provideBlockThreshold();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 保存log的路径, 比如 &quot;/blockcanary/&quot;, 如果权限允许的话，</span></span><br><span class="line"><span class="comment">    * 会保存在本地sd卡中</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> path of log files</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">providePath</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/blockcanary/&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 是否需要通知去通知用户发生阻塞</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> true if need, else if not need.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">displayNotification</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 用于将多个文件压缩为一个.zip文件</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> src  files before compress</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> dest files compressed</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> true if compression is successful</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">zip</span><span class="params">(File[] src, File dest)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 用于将已经被压缩好的.zip log文件上传至</span></span><br><span class="line"><span class="comment">    * APM后台</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> zippedFile zipped file</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">upload</span><span class="params">(File zippedFile)</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 用于设定包名, 默认使用进程名，</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> null if simply concern only package with process name.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">concernPackages</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 使用 @&#123;code concernPackages&#125;方法指定过滤的堆栈信息 </span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> true if filter, false it not.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">filterNonConcernStack</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 指定一个白名单, 在白名单的条目将不会出现在展示阻塞信息的UI中</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> return null if you don&#x27;t need white-list filter.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">provideWhiteList</span><span class="params">()</span> &#123;</span><br><span class="line">        LinkedList&lt;String&gt; whiteList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        whiteList.add(<span class="string">&quot;org.chromium&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> whiteList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 使用白名单的时候，是否去删除堆栈在白名单中的文件</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> true if delete, false it not.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deleteFilesInWhiteList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 阻塞拦截器, 我们可以指定发生阻塞时应该做的工作</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onBlock</span><span class="params">(Context context, BlockInfo blockInfo)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，在上述配置中，我们指定了卡顿的阈值为1000ms。接下来，我们可以测试一下BlockCanary监测卡顿时的效果，这里我在Activity的onCreate方法中添加如下代码使线程休眠3s：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，我们运行项目，打开App，即可看到类似LeakCanary界面那样的卡顿信息堆栈。</p>
<p>除了发生卡顿时BlockCanary提供的图形界面可供开发和测试人员直接查看卡顿原因之外。其最大的作用还是在线上环境或者自动化monkey测试的环节进行大范围的log采集与分析，对于分析的纬度，可以从以下两个纬度来进行：</p>
<ul>
<li>卡顿时间。</li>
<li>根据同堆栈出现的卡顿次数来进行排序和归类。</li>
</ul>
<h3 id="BlockCanary的优势如下"><a href="#BlockCanary的优势如下" class="headerlink" title="BlockCanary的优势如下"></a>BlockCanary的优势如下</h3><ul>
<li>非侵入式。</li>
<li>方便精准，能够定位到代码的某一行代码。</li>
</ul>
<h3 id="那么这种自动检测卡顿的方案有什么问题吗？"><a href="#那么这种自动检测卡顿的方案有什么问题吗？" class="headerlink" title="那么这种自动检测卡顿的方案有什么问题吗？"></a>那么这种自动检测卡顿的方案有什么问题吗？</h3><p>在卡顿的周期之内，应用确实发生了卡顿，但是获取到的卡顿信息可能会不准确，和我们的OOM一样，也就是<strong>最后的堆栈信息仅仅只是一个表象，并不是真正发生问题时的一个堆栈</strong>。下面，我们先看下如下的一个示意图：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cf8f7e9679d943d0b4e60d7b93f65a1e~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p>假设主线程在T1到T2的时间段内发生了卡顿，卡顿检测方案获取卡顿时的堆栈信息是T2时刻，但是实际上发生卡顿的时刻可能是在这段时间区域内另一个耗时过长的函数，那么可能在我们捕获卡顿的时刻时，真正的卡顿时机已经执行完成了，所以在T2时刻捕获到的一个卡顿信息并不能够反映卡顿的现场，也就是最后呈现出来的堆栈信息仅仅只是一个表象，并不是真正问题的藏身之处。</p>
<h3 id="那么，我们如何对这种情况进行优化呢？"><a href="#那么，我们如何对这种情况进行优化呢？" class="headerlink" title="那么，我们如何对这种情况进行优化呢？"></a>那么，我们如何对这种情况进行优化呢？</h3><p>我们可以<strong>获取卡顿周期内的多个堆栈</strong>，而不仅仅是最后一个，这样的话，如果发生了卡顿，我们就可以<strong>根据这些堆栈信息来清晰地还原整个卡顿现场</strong>。因为我们有卡顿现场的多个堆栈信息，我们完全知道卡顿时究竟发生了什么，<strong>到底哪些函数它的调用时间比较长</strong>。接下来，我们看看下面的卡顿检测优化流程图：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/67ff298aadb3465e91fbdde156bd1277~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p>根据图中，可以梳理出优化后的具体实现步骤为：</p>
<ul>
<li>1、首先，我们会通过startMonitor方法对这个过程进行监控。</li>
<li>2、接着，我们就开始<strong>高频采集堆栈信息。如果发生了卡顿，我们就会调用endMonitor方法</strong>。</li>
<li>3、然后，将之前我们采集的多个堆栈信息记录到文件中。</li>
<li>4、最后，在合适的时机上报给我们的服务器。</li>
</ul>
<p>通过上述的优化，我们就可以知道在整个卡顿周期之内，究竟是哪些方法在执行，哪些方法比较耗时。</p>
<p>但是这种海量卡顿堆栈的处理又存在着另一个问题，那就是高频卡顿上报量太大，服务器压力较大，这里我们来分析下<strong>如何减少服务端对堆栈信息的处理量</strong>。</p>
<p>在出现卡顿的情况下，我们<strong>采集到了多个堆栈，大概率的情况下，可能会存在多个重复的堆栈</strong>，而这个重复的堆栈信息才是我们应该关注的地方。我们可以<strong>对一个卡顿下的堆栈进行能hash排重，找出重复的堆栈</strong>。这样，<strong>服务器需要处理的数据量就会大大减少，同时也过滤出了我们需要重点关注的对象</strong>。对于开发人员来说，就能更快地找到卡顿的原因。</p>
<h2 id="4、小结"><a href="#4、小结" class="headerlink" title="4、小结"></a>4、小结</h2><p>在本节中，我们学习了自动化卡顿检测的原理，然后，我们使用这种方案进行了实战，最后，我还介绍了这种方案的问题和它的优化思路。</p>
<h1 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h1><p>在本篇文章中，我们主要对卡顿优化分析方法与工具 、自动化卡顿检测方案及优化相关的知识进行了全面且深入地讲解，这里再简单总结一下本篇文章涉及的两大主题：</p>
<ul>
<li>1、卡顿优化分析方法与工具：背景介绍、卡顿分析方法之使用shell命令分析CPU耗时、卡顿优化工具。</li>
<li>2、自动化卡顿检测方案及优化：卡顿检测方案原理、AndroidPerformanceMonitor实战及其优化。</li>
</ul>
<p><strong>卡顿时间过长，一定会造成应用发生ANR</strong>。下面，我们就来从应用的ANR分析与实战来开始今天的探索之旅。</p>
<h1 id="一、ANR分析与实战"><a href="#一、ANR分析与实战" class="headerlink" title="一、ANR分析与实战"></a>一、ANR分析与实战</h1><h2 id="1、ANR介绍与实战"><a href="#1、ANR介绍与实战" class="headerlink" title="1、ANR介绍与实战"></a>1、ANR介绍与实战</h2><p>首先，我们再来回顾一下ANR的几种常见的类型，如下所示：</p>
<ul>
<li>1、KeyDispatchTimeout：按键事件在<strong>5s</strong>的时间内没有处理完成。</li>
<li>2、BroadcastTimeout：广播接收器在<strong>前台10s，后台60s</strong>的时间内没有响应完成。</li>
<li>3、ServiceTimeout：服务在<strong>前台20s，后台200s</strong>的时间内没有处理完成。</li>
</ul>
<p>具体的时间定义我们可以在AMS（ActivityManagerService）中找到：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// How long we allow a receiver to run before giving up on it.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">BROADCAST_FG_TIMEOUT</span> <span class="operator">=</span> <span class="number">10</span>*<span class="number">1000</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">BROADCAST_BG_TIMEOUT</span> <span class="operator">=</span> <span class="number">60</span>*<span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// How long we wait until we timeout on key dispatching.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">KEY_DISPATCHING_TIMEOUT</span> <span class="operator">=</span> <span class="number">5</span>*<span class="number">1000</span>;</span><br></pre></td></tr></table></figure>

<p>接下来，我们来看一下ANR的执行流程。</p>
<h3 id="ANR执行流程"><a href="#ANR执行流程" class="headerlink" title="ANR执行流程"></a>ANR执行流程</h3><ul>
<li>1、首先，我们的应用发生了ANR。</li>
<li>2、然后，我们的进程就会接收到异常终止信息，并开始写入进程ANR信息，也就是当时应用的场景信息，它包含了应用所有的堆栈信息、CPU、IO等使用的情况。</li>
<li>3、最后，会弹出一个ANR提示框，看你是要选择继续等待还是退出应用，需要注意这个ANR提示框不一定会弹出，根据不同ROM，它的表现情况也不同。因为有些手机厂商它会默认去掉这个提示框，以避免带来不好的用户体验。</li>
</ul>
<p>分析完ANR的执行流程之后，我们来分析下怎样去解决ANR，究竟哪里可以作为我们的一个突破点。</p>
<p>在上面我们说过，当应用发生ANR时，会写入当时发生ANR的场景信息到文件中，<strong>那么，我们可不可以通过这个文件来判断是否发生了ANR呢？</strong></p>
<p>关于根据ANR log进行ANR问题的排查与解决的方式笔者已经在<a href="https://link.juejin.cn/?target=https://jsonchao.github.io/2019/11/24/%E6%B7%B1%E5%85%A5%E6%8E%A2%E7%B4%A2Android%E7%A8%B3%E5%AE%9A%E6%80%A7%E4%BC%98%E5%8C%96/">深入探索Android稳定性优化</a>的第三节ANR优化中讲解过了，这里就不多赘述了。</p>
<h3 id="线上ANR监控方式"><a href="#线上ANR监控方式" class="headerlink" title="线上ANR监控方式"></a>线上ANR监控方式</h3><p>在<a href="https://link.juejin.cn/?target=https://jsonchao.github.io/2019/11/24/%E6%B7%B1%E5%85%A5%E6%8E%A2%E7%B4%A2Android%E7%A8%B3%E5%AE%9A%E6%80%A7%E4%BC%98%E5%8C%96/">深入探索Android稳定性优化</a>的第三节ANR优化中我说到了<strong>使用FileObserver可以监听 &#x2F;data&#x2F;anr&#x2F;traces.txt的变化，利用它可以实现线上ANR的监控</strong>，但是它有一个致命的缺点，就是<strong>高版本ROM需要root权限，解决方案是只能通过海外Google Play服务、国内Hardcoder的方式去规避</strong>。但是，这在国内显然是不现实的，那么，有没有更好的实现方式呢？</p>
<p>那就是<strong>ANR-WatchDog</strong>，下面我就来详细地介绍一下它。</p>
<p><a href="https://link.juejin.cn/?target=https://github.com/SalomonBrys/ANR-WatchDog">ANR-WatchDog项目地址</a></p>
<p>ANR-WatchDog是一种非侵入式的ANR监控组件，可以用于<strong>线上ANR的监控</strong>，接下来，我们就使用ANR-WatchDog来监控ANR。</p>
<p>首先，在我们项目的app&#x2F;build.gradle中添加如下依赖：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation <span class="string">&#x27;com.github.anrwatchdog:anrwatchdog:1.4.0&#x27;</span></span><br></pre></td></tr></table></figure>

<p>然后，在应用的Application的onCreate方法中添加如下代码启动ANR-WatchDog：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">ANRWatchDog</span>().start();</span><br></pre></td></tr></table></figure>

<p>可以看到，它的初始化方式非常地简单，同时，它内部的实现也非常简单，整个库只有两个类，一个是ANRWatchDog，另一个是ANRError。</p>
<p>接下来我们来看一下ANRWatchDog的实现方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* A watchdog timer thread that detects when the UI thread has frozen.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ANRWatchDog</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br></pre></td></tr></table></figure>

<p>可以看到，ANRWatchDog实际上是继承了Thread类，也就是它是一个线程，对于线程来说，最重要的就是其run方法，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_ANR_TIMEOUT</span> <span class="operator">=</span> <span class="number">5000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">long</span> <span class="variable">_tick</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">_reported</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Runnable</span> <span class="variable">_ticker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        _tick = <span class="number">0</span>;</span><br><span class="line">        _reported = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1、首先，将线程命名为|ANR-WatchDog|。</span></span><br><span class="line">    setName(<span class="string">&quot;|ANR-WatchDog|&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、接着，声明了一个默认的超时间隔时间，默认的值为5000ms。</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">interval</span> <span class="operator">=</span> _timeoutInterval;</span><br><span class="line">    <span class="comment">// 3、然后，在while循环中通过_uiHandler去post一个_ticker Runnable。</span></span><br><span class="line">    <span class="keyword">while</span> (!isInterrupted()) &#123;</span><br><span class="line">        <span class="comment">// 3.1 这里的_tick默认是0，所以needPost即为true。</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">needPost</span> <span class="operator">=</span> _tick == <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 这里的_tick加上了默认的5000ms</span></span><br><span class="line">        _tick += interval;</span><br><span class="line">        <span class="keyword">if</span> (needPost) &#123;</span><br><span class="line">            _uiHandler.post(_ticker);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 接下来，线程会sleep一段时间，默认值为5000ms。</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(interval);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            _interruptionListener.onInterrupted(e);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4、如果主线程没有处理Runnable，即_tick的值没有被赋值为0，则说明发生了ANR，第二个_reported标志位是为了避免重复报道已经处理过的ANR。</span></span><br><span class="line">        <span class="keyword">if</span> (_tick != <span class="number">0</span> &amp;&amp; !_reported) &#123;</span><br><span class="line">            <span class="comment">//noinspection ConstantConditions</span></span><br><span class="line">            <span class="keyword">if</span> (!_ignoreDebugger &amp;&amp; (Debug.isDebuggerConnected() || Debug.waitingForDebugger())) &#123;</span><br><span class="line">                Log.w(<span class="string">&quot;ANRWatchdog&quot;</span>, <span class="string">&quot;An ANR was detected but ignored because the debugger is connected (you can prevent this with setIgnoreDebugger(true))&quot;</span>);</span><br><span class="line">                _reported = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">continue</span> ;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            interval = _anrInterceptor.intercept(_tick);</span><br><span class="line">            <span class="keyword">if</span> (interval &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> ANRError error;</span><br><span class="line">            <span class="keyword">if</span> (_namePrefix != <span class="literal">null</span>) &#123;</span><br><span class="line">                error = ANRError.New(_tick, _namePrefix, _logThreadsWithoutStackTrace);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 5、如果没有主动给ANR_Watchdog设置线程名，则会默认会使用ANRError的NewMainOnly方法去处理ANR。</span></span><br><span class="line">                error = ANRError.NewMainOnly(_tick);</span><br><span class="line">            &#125;</span><br><span class="line">           </span><br><span class="line">           <span class="comment">// 6、最后会通过ANRListener调用它的onAppNotResponding方法，其默认的处理会直接抛出当前的ANRError，导致程序崩溃。 _anrListener.onAppNotResponding(error);</span></span><br><span class="line">            interval = _timeoutInterval;</span><br><span class="line">            _reported = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先，在注释1处，我们将线程命名为了|ANR-WatchDog|。接着，在注释2处，声明了一个默认的超时间隔时间，默认的值为5000ms。然后，注释3处，在while循环中通过_uiHandler去post一个_ticker Runnable。注意这里的_tick默认是0，所以needPost即为true。接下来，线程会sleep一段时间，默认值为5000ms。在注释4处，<strong>如果主线程没有处理Runnable，即_tick的值没有被赋值为0，则说明发生了ANR，第二个_reported标志位是为了避免重复报道已经处理过的ANR。如果发生了ANR</strong>，就会调用接下来的代码，开始会处理debug的情况，然后，我们看到注释5处，如果没有主动给ANR_Watchdog设置线程名，则会默认会使用ANRError的NewMainOnly方法去处理ANR。ANRError的NewMainOnly方法如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The minimum duration, in ms, for which the main thread has been blocked. May be more.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">long</span> duration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> ANRError <span class="title function_">NewMainOnly</span><span class="params">(<span class="type">long</span> duration)</span> &#123;</span><br><span class="line">    <span class="comment">// 1、获取主线程的堆栈信息</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">mainThread</span> <span class="operator">=</span> Looper.getMainLooper().getThread();</span><br><span class="line">    <span class="keyword">final</span> StackTraceElement[] mainStackTrace = mainThread.getStackTrace();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、返回一个包含主线程名、主线程堆栈信息以及发生ANR的最小时间值的实例。</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ANRError</span>(<span class="keyword">new</span> <span class="title class_">$</span>(getThreadTitle(mainThread), mainStackTrace).<span class="keyword">new</span> <span class="title class_">_Thread</span>(<span class="literal">null</span>), duration);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，在注释1处，首先获了主线程的堆栈信息，然后返回了一个包含主线程名、主线程堆栈信息以及发生ANR的最小时间值的实例。（我们可以<strong>改造其源码在此时添加更多的卡顿现场信息，如CPU 使用率和调度信息、内存相关信息、I&#x2F;O 和网络相关的信息等等</strong>）</p>
<p>接下来，我们再回到ANRWatchDog的run方法中的注释6处，最后这里会通过ANRListener调用它的onAppNotResponding方法，其默认的处理会直接抛出当前的ANRError，导致程序崩溃。对应的代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ANRListener</span> <span class="variable">DEFAULT_ANR_LISTENER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ANRListener</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAppNotResponding</span><span class="params">(ANRError error)</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>了解了ANRWatchDog的实现原理之后，我们试一试它的效果如何。首先，我们给MainActivity中的悬浮按钮添加主线程休眠10s的代码，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnClick(&#123;R.id.main_floating_action_btn&#125;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (view.getId()) &#123;</span><br><span class="line">        <span class="keyword">case</span> R.id.main_floating_action_btn:</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 对应项目中的第170行</span></span><br><span class="line">                Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            jumpToTheTop();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，我们重新安装运行项目，点击悬浮按钮，发现在10s内都不能触发屏幕点击和触摸事件，并且在10s之后，应用直接发生了崩溃。接着，我们在Logcat过滤栏中输入<strong>fatal</strong>关键字，找出致命的错误，log如下所示：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020</span><span class="number">-01</span><span class="number">-18</span> <span class="number">09</span>:<span class="number">55</span>:<span class="number">53.459</span> <span class="number">29924</span><span class="number">-29969</span>/? E/AndroidRuntime: FATAL <span class="keyword">EXCEPTION</span>: |ANR-WatchDog|</span><br><span class="line">Process: <span class="type">json</span>.chao.com.wanandroid, PID: <span class="number">29924</span></span><br><span class="line">com.github.anrwatchdog.ANRError: Application <span class="keyword">Not</span> Responding <span class="keyword">for</span> at least <span class="number">5000</span> ms.</span><br><span class="line">Caused <span class="keyword">by</span>: com.github.anrwatchdog.ANRError?$_Thread: main (state = TIMED_WAITING)</span><br><span class="line">    at java.lang.Thread.sleep(Native <span class="keyword">Method</span>)</span><br><span class="line">    at java.lang.Thread.sleep(Thread.java:<span class="number">373</span>)</span><br><span class="line">    at java.lang.Thread.sleep(Thread.java:<span class="number">314</span>)</span><br><span class="line">    // <span class="number">1</span></span><br><span class="line">    at <span class="type">json</span>.chao.com.wanandroid.ui.main.activity.MainActivity.onClick(MainActivity.java:<span class="number">170</span>)</span><br><span class="line">    at <span class="type">json</span>.chao.com.wanandroid.ui.main.activity.MainActivity_ViewBinding<span class="meta">$1</span>.doClick(MainActivity_ViewBinding.java:<span class="number">45</span>)</span><br><span class="line">    at butterknife.internal.DebouncingOnClickListener.onClick(DebouncingOnClickListener.java:<span class="number">22</span>)</span><br><span class="line">    at android.<span class="keyword">view</span>.<span class="keyword">View</span>.performClick(<span class="keyword">View</span>.java:<span class="number">6311</span>)</span><br><span class="line">    at android.<span class="keyword">view</span>.<span class="keyword">View</span>$PerformClick.run(<span class="keyword">View</span>.java:<span class="number">24833</span>)</span><br><span class="line">    at android.os.<span class="keyword">Handler</span>.handleCallback(<span class="keyword">Handler</span>.java:<span class="number">794</span>)</span><br><span class="line">    at android.os.<span class="keyword">Handler</span>.dispatchMessage(<span class="keyword">Handler</span>.java:<span class="number">99</span>)</span><br><span class="line">    at android.os.Looper.<span class="keyword">loop</span>(Looper.java:<span class="number">173</span>)</span><br><span class="line">    at android.app.ActivityThread.main(ActivityThread.java:<span class="number">6653</span>)</span><br><span class="line">    at java.lang.reflect.<span class="keyword">Method</span>.invoke(Native <span class="keyword">Method</span>)</span><br><span class="line">    at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:<span class="number">547</span>)</span><br><span class="line">    at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:<span class="number">821</span>)</span><br><span class="line"> Caused <span class="keyword">by</span>: com.github.anrwatchdog.ANRError?$_Thread: AndroidFileLogger./<span class="keyword">storage</span>/emulated/<span class="number">0</span>/Android/data/<span class="type">json</span>.chao.com.wanandroid/<span class="keyword">log</span>/ (state = RUNNABLE)</span><br></pre></td></tr></table></figure>

<p>可以看到，发生崩溃的线程正是|ANR-WatchDog|。我们重点关注注释1，这里发生崩溃的位置是在MainActivity的onClick方法，对应的行数为170行，从前可知，这里正是线程休眠的地方。</p>
<p>接下来，我们来分析一下ANR-WatchDog的实现原理。</p>
<h2 id="2、ANR-WatchDog原理"><a href="#2、ANR-WatchDog原理" class="headerlink" title="2、ANR-WatchDog原理"></a>2、ANR-WatchDog原理</h2><ul>
<li>首先，我们调用了ANR-WatchDog的start方法，然后这个线程就会开始工作。</li>
<li>然后，我们<strong>通过主线程的Handler post一个消息将主线程的某个值进行一个加值的操作</strong>。</li>
<li>post完成之后呢，我们这个线程就sleep一段时间。</li>
<li><strong>在sleep之后呢，它就会来检测我们这个值有没有被修改，如果这个值被修改了，那就说明我们在主线程中执行了这个message，即表明主线程没有发生卡顿，否则，则说明主线程发生了卡顿</strong>。</li>
<li>最后，ANR-WatchDog就会判断发生了ANR，抛出一个异常给我们。</li>
</ul>
<p>最后，ANR-WatchDog的工作流程简图如下所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/080a3bec391d4e85b5215ed37791c132~tplv-k3u1fbpfcp-zoom-1.image" alt="image"></p>
<p>上面我们最后说到，如果检测到主线程发生了卡顿，则会抛出一个ANR异常，这将会导致应用崩溃，显然不能将这种方案带到线上，那么，<strong>有什么方式能够自定义最后发生卡顿时的处理过程吗？</strong></p>
<p>其实ANR-WatchDog自身就实现了一个我们自身也可以去实现的<strong>ANRListener，通过它，我们就可以对ANR事件去做一个自定义的处理</strong>，比如将堆栈信息压缩后保存到本地，并在适当的时间上传到APM后台。</p>
<h2 id="3、小结"><a href="#3、小结" class="headerlink" title="3、小结"></a>3、小结</h2><p>ANR-WatchDog是一种非侵入式的ANR监控方案，它能够弥补我们在高版本中没有权限去读取traces.txt文件的问题，需要注意的是，在线上这两种方案我们需要结合使用。</p>
<p>在之前，我们还讲到了<strong>AndroidPerformanceMonitor，那么它和ANR-WatchDog有什么区别呢？</strong></p>
<p>对于AndroidPerformanceMonitor来说，它是<strong>监控我们主线程中每一个message的执行，它会在主线程的每一个message的前后打印一个时间戳，然后，我们就可以据此计算每一个message的具体执行时间，但是我们需要注意的是一个message的执行时间通常是非常短暂的，也就是很难达到ANR这个级别</strong>。然后我们来看看ANR-WatchDog的原理，它是<strong>不管应用是如何执行的，它只会看最终的结果，即sleep 5s之后，我就看主线程的这个值有没有被更改。如果说被改过，就说明没有发生ANR，否则，就表明发生了ANR</strong>。</p>
<p>根据这两个库的原理，我们便可以判断出它们分别的适用场景，<strong>对于AndroidPerformanceMonitor来说，它适合监控卡顿，因为每一个message它执行的时间并不长。对于ANR-WatchDog来说，它更加适合于ANR监控的补充</strong>。</p>
<p>此外，虽然ANR-WatchDog解决了在高版本系统没有权限读取 &#x2F;data&#x2F;anr&#x2F;traces.txt 文件的问题，但是<strong>在Java层去获取所有线程堆栈以及各种信息非常耗时，对于卡顿场景不一定合适</strong>，它可能会进一步加剧用户的卡顿。如果是<strong>对性能要求比较高的应用,可以通过Hook Native层的方式去获得所有线程的堆栈信息</strong>，具体为如下两个步骤：</p>
<ul>
<li>通过libart.so、dlsym调用<a href="https://link.juejin.cn/?target=http://androidxref.com/9.0.0_r3/xref/art/runtime/thread_list.cc%231501">ThreadList::ForEach</a>方法，拿到所有的 Native 线程对象。</li>
<li>遍历线程对象列表，调用<a href="https://link.juejin.cn/?target=http://androidxref.com/9.0.0_r3/xref/art/runtime/thread.cc%231615">Thread::DumpState</a>方法。</li>
</ul>
<p>通过这种方式就大致模拟了系统打印 ANR 日志的流程，但是由于采用的是Hook方式，所以可能会产生一些异常甚至崩溃的情况，这个时候就需要通过 <strong>fork 子进程方式去避免这种问题</strong>，而且使用 子进程去获取堆栈信息的方式可以做到完全不卡住我们主进程。</p>
<p>但是需要注意的是，<strong>fork 进程会导致进程号发生改变，此时需要通过指定 &#x2F;proc&#x2F;[父进程 id]的方式重新获取应用主进程的堆栈信息</strong>。</p>
<p>通过 Native Hook 的 方式我们实现了一套“无损”获取所有 Java 线程堆栈与详细信息的卡顿监控体系。<strong>为了降低上报数据量，建议只有主线程的 Java 线程状态是 WAITING、TIME_WAITING 或者 BLOCKED 的时候，才去使用这套方案</strong>。</p>
<h1 id="二、卡顿单点问题检测方案"><a href="#二、卡顿单点问题检测方案" class="headerlink" title="二、卡顿单点问题检测方案"></a>二、卡顿单点问题检测方案</h1><p>除了自动化的卡顿与ANR监控之外，我们还需要进行卡顿单点问题的检测，因为上述两种检测方案的并不能满足所有场景的检测要求，这里我举一个小栗子：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">比如我有很多的<span class="keyword">message</span>要执行，但是每一个<span class="keyword">message</span>的执行时间</span><br><span class="line">都不到卡顿的阈值，那自动化卡顿检测方案也就不能够检测出卡</span><br><span class="line">顿，但是对用户来说，用户就觉得你的App就是有些卡顿。</span><br></pre></td></tr></table></figure>

<p>除此之外，为了建立体系化的监控解决方案，我们就<strong>必须在上线之前将问题尽可能地暴露出来</strong>。</p>
<h2 id="1、IPC单点问题检测方案"><a href="#1、IPC单点问题检测方案" class="headerlink" title="1、IPC单点问题检测方案"></a>1、IPC单点问题检测方案</h2><p>常见的单点问题有主线程IPC、DB操作等等，这里我就拿主线程IPC来说，因为IPC其实是一个很耗时的操作，但是在实际开发过程中，我们可能对IPC操作没有足够的重视，所以，我们经常在主程序中去做频繁IPC操作，所以说，这种耗时它可能并不到你设定卡顿的一个阈值，接下来，我们看一下，对于IPC问题，我们应该去监测哪些指标。</p>
<ul>
<li>1、IPC调用类型：如PackageManager、TelephoneManager的调用。</li>
<li>2、每一个的调用次数与耗时。</li>
<li>3、IPC的调用堆栈（表明哪行代码调用的）、发生线程。</li>
</ul>
<h3 id="常规方案"><a href="#常规方案" class="headerlink" title="常规方案"></a>常规方案</h3><p>常规方案就是在<strong>IPC的前后加上埋点</strong>。但是，这种方式<strong>不够优雅</strong>，而且，在平常开发过程中我们经常<strong>忘记某个埋点的真正用处</strong>，同时它的<strong>维护成本也非常大</strong>。</p>
<p>接下来，我们讲解一下IPC问题监测的技巧。</p>
<h3 id="IPC问题监测技巧"><a href="#IPC问题监测技巧" class="headerlink" title="IPC问题监测技巧"></a>IPC问题监测技巧</h3><p>在线下，我们可以通过adb命令的方式来进行监测，如下所示：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">//</span> <span class="number">1</span>、首先，对IPC操作开始进行监控</span><br><span class="line">adb shell am trace-ipc start</span><br><span class="line"><span class="regexp">//</span> <span class="number">2</span>、然后，结束IPC操作的监控，同时，将监控到的信息存放到指定的文件当中</span><br><span class="line">adb shell am trace-ipc stop -dump-file <span class="regexp">/data/</span>local<span class="regexp">/tmp/i</span>pc-trace.txt</span><br><span class="line"><span class="regexp">//</span> <span class="number">3</span>、最后，将监控到的ipc-trace导出到电脑查看</span><br><span class="line">adb pull <span class="regexp">/data/</span>local<span class="regexp">/tmp/i</span>pc-trace.txt</span><br></pre></td></tr></table></figure>

<p>然后，这里我们介绍一种优雅的实现方案，看过<a target="_blank" rel="noopener" href="https://juejin.im/post/6844904047355363341">深入探索Android布局优化（上）</a>的同学可能知道这里的实现方案无非就是ARTHook或AspectJ这两种方案，这里我们需要去监控IPC操作，那么，我们应该选用哪种方式会更好一些呢？（利用<a href="https://link.juejin.cn/?target=https://github.com/tiann/epic">epic</a>实现ARTHook)</p>
<p>要回答这个问题，就需要我们对ARTHook和AspectJ这两者的思想有足够的认识，<strong>对应ARTHook来说，其实我们可以用它来去Hook系统的一些方法，因为对于系统代码来说，我们无法对它进行更改，但是我们可以Hook住它的一个方法，在它的方法体里面去加上自己的一些代码。但是，对于AspectJ来说，它只能针对于那些非系统方法，也就是我们App自己的源码，或者是我们所引用到的一些jar、aar包</strong>。因为AspectJ实际上是往我们的具体方法里面插入相对应的代码，所以说，他不能够针对于我们的系统方法去做操作，在这里，我们就需要<strong>采用ARTHook的方式去进行IPC操作的监控</strong>。</p>
<p>在使用ARTHook去监控IPC操作之前，我们首先思考一下，哪些操作是IPC操作呢？</p>
<p>比如说，我们通过PackageManager去拿到我们应用的一些信息，或者去拿到设备的DeviceId这样的信息以及AMS相关的信息等等，这些其实都涉及到了IPC的操作，而这些操作都会通过固定的方式进行IPC，并最终会调用到<strong>android.os.BinderProxy</strong>，接下来，我们来看看它的transact方法，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">transact</span><span class="params">(<span class="type">int</span> code, Parcel data, Parcel reply, <span class="type">int</span> flags)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br></pre></td></tr></table></figure>

<p>这里我们仅仅关注transact方法的参数即可，第一个参数是一个行动编码，为int类型，它是在FIRST_CALL_TRANSACTION与LAST_CALL_TRANSACTION之间的某个值，第二、三个参数都是Parcel类型的参数，用于获取和回复相应的数据，第四个参数为一个int类型的标记值，为0表示一个正常的IPC调用，否则表明是一个单向的IPC调用。然后，我们在项目中的Application的onCreate方法中<strong>使用ARTHook对android.os.BinderProxy类的transact方法进行Hook</strong>，代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    DexposedBridge.findAndHookMethod(Class.forName(<span class="string">&quot;android.os.BinderProxy&quot;</span>), <span class="string">&quot;transact&quot;</span>,<span class="type">int</span>.class, Parcel.class, Parcel.class, <span class="type">int</span>.class, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">            LogHelper.i( <span class="string">&quot;BinderProxy beforeHookedMethod &quot;</span> + param.thisObject.getClass().getSimpleName()</span><br><span class="line">                        + <span class="string">&quot;\n&quot;</span> + Log.getStackTraceString(<span class="keyword">new</span> <span class="title class_">Throwable</span>()));</span><br><span class="line">            <span class="built_in">super</span>.beforeHookedMethod(param);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重新安装应用，即可看到如下的Log信息：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ WanAndroidApp$<span class="number">1</span><span class="selector-class">.beforeHookedMethod</span>  (WanAndroidApp<span class="selector-class">.java</span>:<span class="number">160</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │    LogHelper<span class="selector-class">.i</span>  (LogHelper<span class="selector-class">.java</span>:<span class="number">37</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: ├┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ <span class="selector-attr">[WanAndroidApp.java | 160 | beforeHookedMethod]</span> BinderProxy beforeHookedMethod BinderProxy</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ java<span class="selector-class">.lang</span><span class="selector-class">.Throwable</span></span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span><span class="selector-class">.app</span>.WanAndroidApp$<span class="number">1</span><span class="selector-class">.beforeHookedMethod</span>(WanAndroidApp<span class="selector-class">.java</span>:<span class="number">160</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at com<span class="selector-class">.taobao</span><span class="selector-class">.android</span><span class="selector-class">.dexposed</span><span class="selector-class">.DexposedBridge</span><span class="selector-class">.handleHookedArtMethod</span>(DexposedBridge<span class="selector-class">.java</span>:<span class="number">237</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at me<span class="selector-class">.weishu</span><span class="selector-class">.epic</span><span class="selector-class">.art</span><span class="selector-class">.entry</span><span class="selector-class">.Entry64</span><span class="selector-class">.onHookBoolean</span>(Entry64<span class="selector-class">.java</span>:<span class="number">72</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at me<span class="selector-class">.weishu</span><span class="selector-class">.epic</span><span class="selector-class">.art</span><span class="selector-class">.entry</span><span class="selector-class">.Entry64</span><span class="selector-class">.referenceBridge</span>(Entry64<span class="selector-class">.java</span>:<span class="number">237</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at me<span class="selector-class">.weishu</span><span class="selector-class">.epic</span><span class="selector-class">.art</span><span class="selector-class">.entry</span><span class="selector-class">.Entry64</span><span class="selector-class">.booleanBridge</span>(Entry64<span class="selector-class">.java</span>:<span class="number">86</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.os</span><span class="selector-class">.ServiceManagerProxy</span><span class="selector-class">.getService</span>(ServiceManagerNative<span class="selector-class">.java</span>:<span class="number">123</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.os</span><span class="selector-class">.ServiceManager</span><span class="selector-class">.getService</span>(ServiceManager<span class="selector-class">.java</span>:<span class="number">56</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.os</span><span class="selector-class">.ServiceManager</span><span class="selector-class">.getServiceOrThrow</span>(ServiceManager<span class="selector-class">.java</span>:<span class="number">71</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.app</span><span class="selector-class">.UiModeManager</span>.&lt;init&gt;(UiModeManager<span class="selector-class">.java</span>:<span class="number">127</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.app</span>.SystemServiceRegistry$<span class="number">42</span><span class="selector-class">.createService</span>(SystemServiceRegistry<span class="selector-class">.java</span>:<span class="number">511</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.app</span>.SystemServiceRegistry$<span class="number">42</span><span class="selector-class">.createService</span>(SystemServiceRegistry<span class="selector-class">.java</span>:<span class="number">509</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.app</span>.SystemServiceRegistry<span class="variable">$CachedServiceFetcher</span><span class="selector-class">.getService</span>(SystemServiceRegistry<span class="selector-class">.java</span>:<span class="number">970</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.app</span><span class="selector-class">.SystemServiceRegistry</span><span class="selector-class">.getSystemService</span>(SystemServiceRegistry<span class="selector-class">.java</span>:<span class="number">920</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.app</span><span class="selector-class">.ContextImpl</span><span class="selector-class">.getSystemService</span>(ContextImpl<span class="selector-class">.java</span>:<span class="number">1677</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.view</span><span class="selector-class">.ContextThemeWrapper</span><span class="selector-class">.getSystemService</span>(ContextThemeWrapper<span class="selector-class">.java</span>:<span class="number">171</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.app</span><span class="selector-class">.Activity</span><span class="selector-class">.getSystemService</span>(Activity<span class="selector-class">.java</span>:<span class="number">6003</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.support</span><span class="selector-class">.v7</span><span class="selector-class">.app</span><span class="selector-class">.AppCompatDelegateImplV23</span>.&lt;init&gt;(AppCompatDelegateImplV23<span class="selector-class">.java</span>:<span class="number">33</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.support</span><span class="selector-class">.v7</span><span class="selector-class">.app</span><span class="selector-class">.AppCompatDelegateImplN</span>.&lt;init&gt;(AppCompatDelegateImplN<span class="selector-class">.java</span>:<span class="number">31</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.support</span><span class="selector-class">.v7</span><span class="selector-class">.app</span><span class="selector-class">.AppCompatDelegate</span><span class="selector-class">.create</span>(AppCompatDelegate<span class="selector-class">.java</span>:<span class="number">198</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.support</span><span class="selector-class">.v7</span><span class="selector-class">.app</span><span class="selector-class">.AppCompatDelegate</span><span class="selector-class">.create</span>(AppCompatDelegate<span class="selector-class">.java</span>:<span class="number">183</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.support</span><span class="selector-class">.v7</span><span class="selector-class">.app</span><span class="selector-class">.AppCompatActivity</span><span class="selector-class">.getDelegate</span>(AppCompatActivity<span class="selector-class">.java</span>:<span class="number">519</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.support</span><span class="selector-class">.v7</span><span class="selector-class">.app</span><span class="selector-class">.AppCompatActivity</span><span class="selector-class">.onCreate</span>(AppCompatActivity<span class="selector-class">.java</span>:<span class="number">70</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at me<span class="selector-class">.yokeyword</span><span class="selector-class">.fragmentation</span><span class="selector-class">.SupportActivity</span><span class="selector-class">.onCreate</span>(SupportActivity<span class="selector-class">.java</span>:<span class="number">38</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span><span class="selector-class">.base</span><span class="selector-class">.activity</span><span class="selector-class">.AbstractSimpleActivity</span><span class="selector-class">.onCreate</span>(AbstractSimpleActivity<span class="selector-class">.java</span>:<span class="number">29</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span><span class="selector-class">.base</span><span class="selector-class">.activity</span><span class="selector-class">.BaseActivity</span><span class="selector-class">.onCreate</span>(BaseActivity<span class="selector-class">.java</span>:<span class="number">37</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.app</span><span class="selector-class">.Activity</span><span class="selector-class">.performCreate</span>(Activity<span class="selector-class">.java</span>:<span class="number">7098</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.app</span><span class="selector-class">.Activity</span><span class="selector-class">.performCreate</span>(Activity<span class="selector-class">.java</span>:<span class="number">7089</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.app</span><span class="selector-class">.Instrumentation</span><span class="selector-class">.callActivityOnCreate</span>(Instrumentation<span class="selector-class">.java</span>:<span class="number">1215</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.app</span><span class="selector-class">.ActivityThread</span><span class="selector-class">.performLaunchActivity</span>(ActivityThread<span class="selector-class">.java</span>:<span class="number">2770</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.app</span><span class="selector-class">.ActivityThread</span><span class="selector-class">.handleLaunchActivity</span>(ActivityThread<span class="selector-class">.java</span>:<span class="number">2895</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.app</span><span class="selector-class">.ActivityThread</span>.<span class="built_in">-wrap11</span>(Unknown Source:<span class="number">0</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.app</span>.ActivityThread<span class="variable">$H</span><span class="selector-class">.handleMessage</span>(ActivityThread<span class="selector-class">.java</span>:<span class="number">1616</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.os</span><span class="selector-class">.Handler</span><span class="selector-class">.dispatchMessage</span>(Handler<span class="selector-class">.java</span>:<span class="number">106</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.os</span><span class="selector-class">.Looper</span><span class="selector-class">.loop</span>(Looper<span class="selector-class">.java</span>:<span class="number">173</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at android<span class="selector-class">.app</span><span class="selector-class">.ActivityThread</span><span class="selector-class">.main</span>(ActivityThread<span class="selector-class">.java</span>:<span class="number">6653</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at java<span class="selector-class">.lang</span><span class="selector-class">.reflect</span><span class="selector-class">.Method</span><span class="selector-class">.invoke</span>(Native Method)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at com<span class="selector-class">.android</span><span class="selector-class">.internal</span><span class="selector-class">.os</span>.RuntimeInit<span class="variable">$MethodAndArgsCaller</span><span class="selector-class">.run</span>(RuntimeInit<span class="selector-class">.java</span>:<span class="number">547</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">52</span>:<span class="number">47.657</span> <span class="number">10683</span>-<span class="number">10683</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ 	at com<span class="selector-class">.android</span><span class="selector-class">.internal</span><span class="selector-class">.os</span><span class="selector-class">.ZygoteInit</span><span class="selector-class">.main</span>(ZygoteInit<span class="selector-class">.java</span>:<span class="number">821</span>)</span><br></pre></td></tr></table></figure>

<p>可以看出，这里弹出了应用中某一个IPC调用的所有堆栈信息。在这里，具体是在AbstractSimpleActivity的onCreate方法中调用了ServiceManager的getService方法，它是一个IPC调用的方法。这样，应用的IPC调用我们就能很方便地捕获到了。</p>
<p>大家可以看到，通过这种方式我们可以很方便地拿到应用中所有的IPC操作，并可以获得到<strong>IPC调用的类型、调用耗时、发生次数、调用的堆栈等等一系列信息</strong>。当然，除了IPC调用的问题之外，还有I<strong>O、DB、View绘制</strong>等一系列单点问题需要去建立与之对应的检测方案。</p>
<h2 id="2、卡顿问题检测方案"><a href="#2、卡顿问题检测方案" class="headerlink" title="2、卡顿问题检测方案"></a>2、卡顿问题检测方案</h2><p>对于卡顿问题检测方案的建设，主要是<strong>利用ARTHook去完善线下的检测工具，尽可能地去Hook相对应的操作，以暴露、分析问题</strong>。这样，才能更好地实现卡顿的体系化解决方案。</p>
<h1 id="三、如何实现界面秒开？"><a href="#三、如何实现界面秒开？" class="headerlink" title="三、如何实现界面秒开？"></a>三、如何实现界面秒开？</h1><p>界面的打开速度对用户体验来说是至关重要的，那么如何实现界面秒开呢？</p>
<p>其实界面秒开就是一个小的启动优化，其优化的思想可以<strong>借鉴启动速度优化与布局优化的一些实现思路</strong>。</p>
<h2 id="1、界面秒开实现"><a href="#1、界面秒开实现" class="headerlink" title="1、界面秒开实现"></a>1、界面秒开实现</h2><p>首先，我们可以<strong>通过Systrace来观察CPU的运行状况，比如有没有跑满CPU；然后，我们在启动优化中学习到的优雅异步以及优雅延迟初始化等等一些方案；其次，针对于我们的界面布局，我们可以使用异步Inflate、X2C、其它的绘制优化措施等等；最后，我们可以使用预加载的方式去提前获取页面的数据，以避免网络或磁盘IO速度的影响，或者也可以将获取数据的方法放到onCreate方法的第一行</strong>。</p>
<h3 id="那么我们如何去衡量界面的打开速度呢？"><a href="#那么我们如何去衡量界面的打开速度呢？" class="headerlink" title="那么我们如何去衡量界面的打开速度呢？"></a>那么我们如何去衡量界面的打开速度呢？</h3><p>通常，我们是通过<strong>界面秒开率</strong>去统计页面的打开速度的，具体就是计算onCreate到onWindowFocusChanged的时间。当然，在某些特定的场景下，把onWindowFocusChanged作为页面打开的结束点并不是特别的精确，那我们可以去<strong>实现一个特定的接口来适配我们的Activity或Fragment，我们可以把那个接口方法作为页面打开的结束点</strong>。</p>
<p>那么，除了以上说到的一些界面秒开的实现方式之外，还没有更好的方式呢？</p>
<p>那就是Lancet。</p>
<h2 id="2、Lancet"><a href="#2、Lancet" class="headerlink" title="2、Lancet"></a>2、Lancet</h2><p>Lancet是一个轻量级的Android AOP框架，它具有如下优势：</p>
<ul>
<li>1、编译速度快，支持增量编译。</li>
<li>2、API简单，没有任何多余代码插入apk。（这一点对应包体积优化时至关重要的）</li>
</ul>
<p>然后，我来简单地讲解下Lancet的用法。Lancet自身提供了一些注解用于Hook，如下所示：</p>
<ul>
<li>@Prxoy：通常是用于对系统API调用的Hook。</li>
<li>@Insert：经常用于操作App或者是Library当中的一些类。</li>
</ul>
<p>接下来，我们就是使用Lancet来进行一下实战演练。</p>
<p>首先，我们需要在项目根目录的 build.gradle 添加如下依赖:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dependencies&#123;</span><br><span class="line">    classpath <span class="string">&#x27;me.ele:lancet-plugin:1.0.5&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，在 app 目录的’build.gradle’ 添加：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="attr">plugin:</span> <span class="string">&#x27;me.ele.lancet&#x27;</span></span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    compileOnly <span class="string">&#x27;me.ele:lancet-base:1.0.5&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，我们就可以使用Lancet了，这里我们需要先新建一个类去进行专门的Hook操作，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActivityHooker</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Proxy(&quot;i&quot;)</span></span><br><span class="line">    <span class="meta">@TargetClass(&quot;android.util.Log&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">i</span><span class="params">(String tag, String msg)</span> &#123;</span><br><span class="line">        msg = msg + <span class="string">&quot;JsonChao&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">int</span>) Origin.call();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述的方法就是对android.util.Log的i方法进行Hook，并在所有的msg后面加上”JsonChao”字符串，注意这里的i方法我们需要从android.util.Log里面将它的i方法复制过来，确保方法名和对应的参数信息一致；然后，方法上面的@TargetClass与@Proxy分别是指定对应的全路径类名与方法名；最后，我们需要通过Lancet提供的Origin类去调用它的call方法来实现返回原来的调用信息。完成之后，我们重新运行项目，会出现如下log信息：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">2020</span>-<span class="number">01</span>-<span class="number">23</span> <span class="number">13</span>:<span class="number">13</span>:<span class="number">34</span>.<span class="number">124</span> <span class="number">7277</span>-<span class="number">7277</span>/json.chao.com.wanandroid I/MultiDex: VM with version <span class="number">2</span>.<span class="number">1</span>.<span class="number">0</span> has multidex supportJsonChao</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">01</span>-<span class="number">23</span> <span class="number">13</span>:<span class="number">13</span>:<span class="number">34</span>.<span class="number">124</span> <span class="number">7277</span>-<span class="number">7277</span>/json.chao.com.wanandroid I/MultiDex: Installing applicationJsonChao</span><br></pre></td></tr></table></figure>

<p>可以看到，log后面都加上了我们预先添加的字符串，说明Hook成功了。下面，我们就可以用Lancet来统计一下项目界面的秒开率了，代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ActivityRecord sActivityRecord;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    sActivityRecord = <span class="keyword">new</span> <span class="title class_">ActivityRecord</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Insert(value = &quot;onCreate&quot;,mayCreateSuper = true)</span></span><br><span class="line"><span class="meta">@TargetClass(value = &quot;android.support.v7.app.AppCompatActivity&quot;,scope = Scope.ALL)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    sActivityRecord.mOnCreateTime = System.currentTimeMillis();</span><br><span class="line">    <span class="comment">// 调用当前Hook类方法中原先的逻辑</span></span><br><span class="line">    Origin.callVoid();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Insert(value = &quot;onWindowFocusChanged&quot;,mayCreateSuper = true)</span></span><br><span class="line"><span class="meta">@TargetClass(value = &quot;android.support.v7.app.AppCompatActivity&quot;,scope = Scope.ALL)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onWindowFocusChanged</span><span class="params">(<span class="type">boolean</span> hasFocus)</span> &#123;</span><br><span class="line">    sActivityRecord.mOnWindowsFocusChangedTime = System.currentTimeMillis();</span><br><span class="line">    LogHelper.i(getClass().getCanonicalName() + <span class="string">&quot; onWindowFocusChanged cost &quot;</span>+(sActivityRecord.mOnWindowsFocusChangedTime - sActivityRecord.mOnCreateTime));</span><br><span class="line">    Origin.callVoid();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面，我们通过@TargetClass和@Insert两个注解实现Hook了android.support.v7.app.AppCompatActivity的onCreate与onWindowFocusChanged方法。我们注意到，这里@Insert注解可以指定两个参数，其源码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Insert &#123;</span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">mayCreateSuper</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二个参数mayCreateSuper设定为true则表明如果没有重写父类的方法，则会默认去重写这个方法。对应到我们ActivityHooker里面实现的@Insert注解方法就是如果当前的Activity没有重写父类的onCreate和 onWindowFocusChanged方法，则此时默认会去重写父类的这个方法，以<strong>避免因某些Activity不存在该方法而Hook失败的情况</strong>。</p>
<p>然后，我们注意到@TargetClass也可以指定两个参数，其源码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@java</span>.lang.annotation.Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> TargetClass &#123;</span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    Scope <span class="title function_">scope</span><span class="params">()</span> <span class="keyword">default</span> Scope.SELF;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二个参数scope指定的值是一个枚举，可选的值如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">Scope</span> &#123;</span><br><span class="line">    SELF,</span><br><span class="line">    DIRECT,</span><br><span class="line">    ALL,</span><br><span class="line">    LEAF</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于Scope.SELF，它代表仅匹配目标value所指定的一个匹配类；对于DIRECT，它代表匹配value所指定的类的一个直接子类；如果是Scope.ALL，它就表明会去匹配value所指定的类的所有子类，而我们上面指定的value值为android.support.v7.app.AppCompatActivity，因为scope指定为了Scope.ALL，则说明会去匹配AppCompatActivity的所有子类。而最后的Scope.LEAF 代表匹配 value 指定类的最终子类，因为java是单继承，所以继承关系是树形结构，所以这里代表了指定类为顶点的继承树的所有叶子节点。</p>
<p>最后，我们设定了一个ActivityRecord类去记录onCreate与onWindowFocusChanged的时间戳，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActivityRecord</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 避免没有仅执行onResume就去统计界面打开速度的情况，如息屏、亮屏等等</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> isNewCreate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> mOnCreateTime;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> mOnWindowsFocusChangedTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过sActivityRecord.mOnWindowsFocusChangedTime - sActivityRecord.mOnCreateTime得到的时间即为界面的打开速度，最后，重新运行项目，会得到如下log信息：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">23</span> <span class="number">14</span>:<span class="number">12</span>:<span class="number">16.406</span> <span class="number">15098</span>-<span class="number">15098</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ <span class="selector-attr">[null | 57 | json_chao_com_wanandroid_aop_ActivityHooker_onWindowFocusChanged]</span> json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span><span class="selector-class">.ui</span><span class="selector-class">.main</span><span class="selector-class">.activity</span><span class="selector-class">.SplashActivity</span> onWindowFocusChanged cost <span class="number">257</span></span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">23</span> <span class="number">14</span>:<span class="number">12</span>:<span class="number">18.930</span> <span class="number">15098</span>-<span class="number">15098</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ <span class="selector-attr">[null | 57 | json_chao_com_wanandroid_aop_ActivityHooker_onWindowFocusChanged]</span> json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span><span class="selector-class">.ui</span><span class="selector-class">.main</span><span class="selector-class">.activity</span><span class="selector-class">.MainActivity</span> onWindowFocusChanged cost <span class="number">608</span></span><br></pre></td></tr></table></figure>

<p>从上面的log信息，我们就可以知道 SplashActivity 和 MainActivity 的界面打开速度分别是257ms和608ms。</p>
<p>最后，我们来看下界面秒开的监控纬度。</p>
<h2 id="3、界面秒开监控纬度"><a href="#3、界面秒开监控纬度" class="headerlink" title="3、界面秒开监控纬度"></a>3、界面秒开监控纬度</h2><p>对于界面秒开的监控纬度，主要分为以下三个方面：</p>
<ul>
<li>总体耗时</li>
<li>生命周期耗时</li>
<li>生命周期间隔耗时</li>
</ul>
<p>首先，我们会<strong>监控界面打开的整体耗时</strong>，也就是onCreate到onWindowFocusChanged这个方法的耗时；当然，如果我们是在一个特殊的界面，我们需要更精确的知道界面打开的一个时间，这个我们可以用自定义的接口去实现。其次，我们也需要去<strong>监控生命周期的一个耗时</strong>，如onCreate、onStart、onResume等等。最后，我们也需要去做<strong>生命周期间隔的耗时监控</strong>，这点经常被我们所忽略，比如onCreate的结束到onStart开始的这一段时间，也是有时间损耗的，我们可以监控它是不是在一个合理的范围之内。<strong>通过这三个方面的监控纬度，我们就能够非常细粒度地去检测页面秒开各个方面的情况</strong>。</p>
<h1 id="四、优雅监控耗时盲区"><a href="#四、优雅监控耗时盲区" class="headerlink" title="四、优雅监控耗时盲区"></a>四、优雅监控耗时盲区</h1><p>尽管我们在应用中监控了很多的耗时区间，但是还是有一些耗时区间我们还没有捕捉到，如onResume到列表展示的间隔时间，这些时间在我们的统计过程中很容易被忽视，这里我们举一个小栗子：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">我们在Activity的生命周期中post了一个<span class="keyword">message</span>，那这个<span class="keyword">message</span>很可能其中</span><br><span class="line">执行了一段耗时操作，那你知道这个<span class="keyword">message</span>它的具体执行时间吗？这个<span class="keyword">message</span>其实</span><br><span class="line">很有可能在列表展示之前就执行了，如果这个<span class="keyword">message</span>耗时<span class="number">1</span>s，那么列表的展示</span><br><span class="line">时间就会延迟<span class="number">1</span>s，如果是<span class="number">200</span>ms，那么我们设定的自动化卡顿检测就无法</span><br><span class="line">发现它，那么列表的展示时间就会延迟<span class="number">200</span>ms。</span><br></pre></td></tr></table></figure>

<p>其实这种场景非常常见，接下来，我们就在项目中来进行实战演练。</p>
<p>首先，我们在MainActivity的onCreate中加上post消息的一段代码，其中模拟了延迟1000ms的耗时操作，代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 以下代码是为了演示Msg导致的主线程卡顿</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Handler</span>().post(() -&gt; &#123;</span><br><span class="line">    LogHelper.i(<span class="string">&quot;Msg 执行&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>接着，我们在RecyclerView对应的Adapter中将列表展示的时间打印出来，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (helper.getLayoutPosition() == <span class="number">1</span> &amp;&amp; !mHasRecorded) &#123;</span><br><span class="line">    mHasRecorded = <span class="literal">true</span>;</span><br><span class="line">    helper.getView(R.id.item_search_pager_group).getViewTreeObserver().addOnPreDrawListener(<span class="keyword">new</span> <span class="title class_">ViewTreeObserver</span>.OnPreDrawListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onPreDraw</span><span class="params">()</span> &#123;</span><br><span class="line">            helper.getView(R.id.item_search_pager_group).getViewTreeObserver().removeOnPreDrawListener(<span class="built_in">this</span>);</span><br><span class="line">            LogHelper.i(<span class="string">&quot;FeedShow&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后，我们重新运行下项目，看看两者的执行时间，log信息如下：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">21</span>:<span class="number">55.076</span> <span class="number">19091</span>-<span class="number">19091</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ <span class="selector-attr">[MainActivity.java | 108 | lambda$initEventAndData$1$MainActivity]</span> Msg 执行</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">21</span>:<span class="number">56.264</span> <span class="number">19091</span>-<span class="number">19091</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ <span class="selector-attr">[null | 57 | json_chao_com_wanandroid_aop_ActivityHooker_onWindowFocusChanged]</span> json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span><span class="selector-class">.ui</span><span class="selector-class">.main</span><span class="selector-class">.activity</span><span class="selector-class">.MainActivity</span> onWindowFocusChanged cost <span class="number">1585</span></span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">21</span>:<span class="number">57.207</span> <span class="number">19091</span>-<span class="number">19091</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ ArticleListAdapter$<span class="number">1</span><span class="selector-class">.onPreDraw</span>  (ArticleListAdapter<span class="selector-class">.java</span>:<span class="number">93</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">21</span>:<span class="number">57.208</span> <span class="number">19091</span>-<span class="number">19091</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │    LogHelper<span class="selector-class">.i</span>  (LogHelper<span class="selector-class">.java</span>:<span class="number">37</span>)</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">21</span>:<span class="number">57.208</span> <span class="number">19091</span>-<span class="number">19091</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: ├┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄</span><br><span class="line"><span class="number">2020</span>-<span class="number">01</span>-<span class="number">23</span> <span class="number">15</span>:<span class="number">21</span>:<span class="number">57.208</span> <span class="number">19091</span>-<span class="number">19091</span>/json<span class="selector-class">.chao</span><span class="selector-class">.com</span><span class="selector-class">.wanandroid</span> I/WanAndroid-LOG: │ <span class="selector-attr">[ArticleListAdapter.java | 93 | onPreDraw]</span> FeedShow</span><br></pre></td></tr></table></figure>

<p>从log信息中可以看到，MAinActivity的onWindowFocusChanged方法延迟了1000ms才被调用，与此同时，列表页时延迟了1000ms才展示出来。也就是说，<strong>post的这个message消息是执行在界面、列表展示之前的</strong>。因为任何一个开发都有可能在某一个生命周期或者是某一个阶段以及一些第三方的SDK里面，回去做一些handler post的相关操作，这样，他的handler post的message的执行，很有可能在我们的界面或列表展示之前就被执行，所以说，出现这种耗时的盲区是非常普遍的，而且也不好排查，下面，我们分析下耗时盲区存在的难点。</p>
<h2 id="1、耗时盲区监控难点"><a href="#1、耗时盲区监控难点" class="headerlink" title="1、耗时盲区监控难点"></a>1、耗时盲区监控难点</h2><p>首先，我们可以通过细化监控的方式去获取耗时的一些盲区，但是我们却不知道在这个盲区中它执行了什么操作。其次，对于线上的一些耗时盲区，我们是无法进行排查的。</p>
<p>这里，我们先来看看如何建立耗时盲区监控的线下方案。</p>
<h2 id="2、耗时盲区监控线下方案"><a href="#2、耗时盲区监控线下方案" class="headerlink" title="2、耗时盲区监控线下方案"></a>2、耗时盲区监控线下方案</h2><p>这里我们直接<strong>使用TraceView去检测</strong>即可，因为它能够<strong>清晰地记录线程在具体的时间内到底做了什么操作</strong>，特别适合一段时间内的盲区监控。</p>
<p>然后，我们来看下如何建立耗时盲区监控的线上方案。</p>
<h2 id="3、耗时盲区监控线上方案"><a href="#3、耗时盲区监控线上方案" class="headerlink" title="3、耗时盲区监控线上方案"></a>3、耗时盲区监控线上方案</h2><p>我们知道主线程的所有方法都是通过message来执行的，还记得在之前我们学习了一个库：AndroidPerformanceMonitor，我们是否可以通过这个mLogging来做盲区检测呢？通过这个mLogging确实可以知道我们主线程发生的message，但是通过mLogging无法获取具体的调用栈信息，因为它所<strong>获取的调用栈信息都是系统回调回来的，它并不知道当前的message是被谁抛出来的</strong>，所以说，这个方案并不够完美。</p>
<p>那么，我们是否可以通过<strong>AOP的方式去切Handler方法</strong>呢？比如sendMessage、sendMessageDeleayd方法等等，这样我们就可以知道发生message的一个堆栈，但是这种方案也存在着一个问题，就是它<strong>不清楚准确的执行时间</strong>，我们切了这个handler的方法，仅仅只知道它具体是在哪个地方被发的和它所对应的堆栈信息，但是无法获取准确的执行时间。如果我们想知道在onResume到列表展示之间执行了哪些message，那么通过AOP的方式也无法实现。</p>
<p>那么，<strong>最终的耗时盲区监控的一个线上方案就是使用一个统一的Handler</strong>，定制了它的两个方法，一个是sendMessageAtTime，另外一个是dispatchMessage方法。因为对于发送message，不管调用哪个方法最终都会调用到一个是sendMessageAtTime这个方法，而处理message呢，它最终会调用dispatchMessage方法。然后，我们需要<strong>定制一个gradle插件，来实现自动化的接入我们定制好的handler，通过这种方式，我们就能在编译期间去动态地替换所有使用Handler的父类为我们定制好的这个handler。这样，在整个项目中，所有的sendMessage和handleMessage都会经过我们的回调方法</strong>。接下来，我们来进行一下实战演练。</p>
<p>首先，我这里给出定制好的全局Handler类，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalHandler</span> <span class="keyword">extends</span> <span class="title class_">Handler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">mStartTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GlobalHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(Looper.myLooper(), <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GlobalHandler</span><span class="params">(Callback callback)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(Looper.myLooper(), callback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GlobalHandler</span><span class="params">(Looper looper, Callback callback)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(looper, callback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GlobalHandler</span><span class="params">(Looper looper)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">sendMessageAtTime</span><span class="params">(Message msg, <span class="type">long</span> uptimeMillis)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">send</span> <span class="operator">=</span> <span class="built_in">super</span>.sendMessageAtTime(msg, uptimeMillis);</span><br><span class="line">        <span class="comment">// 1</span></span><br><span class="line">        <span class="keyword">if</span> (send) &#123;</span><br><span class="line">            GetDetailHandlerHelper.getMsgDetail().put(msg, Log.getStackTraceString(<span class="keyword">new</span> <span class="title class_">Throwable</span>()).replace(<span class="string">&quot;java.lang.Throwable&quot;</span>, <span class="string">&quot;&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> send;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dispatchMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">        mStartTime = System.currentTimeMillis();</span><br><span class="line">        <span class="built_in">super</span>.dispatchMessage(msg);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (GetDetailHandlerHelper.getMsgDetail().containsKey(msg)</span><br><span class="line">            &amp;&amp; Looper.myLooper() == Looper.getMainLooper()) &#123;</span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 2</span></span><br><span class="line">                jsonObject.put(<span class="string">&quot;Msg_Cost&quot;</span>, System.currentTimeMillis() - mStartTime);</span><br><span class="line">                jsonObject.put(<span class="string">&quot;MsgTrace&quot;</span>, msg.getTarget() + <span class="string">&quot; &quot;</span> + GetDetailHandlerHelper.getMsgDetail().get(msg));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 3</span></span><br><span class="line">                LogHelper.i(<span class="string">&quot;MsgDetail &quot;</span> + jsonObject.toString());</span><br><span class="line">                GetDetailHandlerHelper.getMsgDetail().remove(msg);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的GlobalHandler将会是我们项目中所有Handler的一个父类。在注释1处，我们在sendMessageAtTime这个方法里面判断如果message发送成功，将会把当前message对象对应的调用栈信息都保存到一个ConcurrentHashMap中，GetDetailHandlerHelper类的代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GetDetailHandlerHelper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ConcurrentHashMap&lt;Message, String&gt; sMsgDetail = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ConcurrentHashMap&lt;Message, String&gt; <span class="title function_">getMsgDetail</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sMsgDetail;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，我们就能够知道这个message它是被谁发送过来的。然后，在dispatchMessage方法里面，我们可以计算拿到其处理消息的一个耗时，并在注释2处将这个耗时保存到一个jsonObject对象中，同时，我们也可以通过GetDetailHandlerHelper类的ConcurrentHashMap对象拿到这个message对应的堆栈信息，并在注释3处将它们输出到log控制台上。当然，如果是线上监控，则会把这些信息保存到本地，然后选择合适的时间去上传。最后，我们还可以在方法体里面做一个判断，我们设置一个阈值，比如阈值为20ms，超过了20ms就把这些保存好的信息上报到APM后台。</p>
<p>在前面的实战演练中，我们使用了handler post的方式去发送一个消息，通过gradle插件将所有handler的父类替换为我们定制好的GlobalHandler之后，我们就可以优雅地去监控应用中的耗时盲区了。</p>
<p>对于实现全局替换handler的gradle插件，除了使用AspectJ实现之外，这里推荐一个已有的项目：<a href="https://link.juejin.cn/?target=https://github.com/didi/DroidAssist">DroidAssist</a>。</p>
<p>然后，重新运行项目，关键的log信息如下所示：</p>
<figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MsgDetail &#123;&quot;<span class="attribute">Msg_Cost&quot;</span>:1001,&quot;MsgTrace&quot;:&quot;Handler (com<span class="variable">.json</span><span class="variable">.chao</span><span class="variable">.com</span><span class="variable">.wanandroid</span><span class="variable">.performance</span><span class="variable">.handler</span><span class="variable">.GlobalHandler</span>) &#123;b0d4d48&#125; \n\tat </span><br><span class="line">com<span class="variable">.json</span><span class="variable">.chao</span><span class="variable">.com</span><span class="variable">.wanandroid</span><span class="variable">.performance</span><span class="variable">.handler</span><span class="variable">.GlobalHandler</span><span class="variable">.sendMessageAtTime</span>(GlobalHandler<span class="variable">.java</span>:36)\n\tat</span><br><span class="line">json<span class="variable">.chao</span><span class="variable">.com</span><span class="variable">.wanandroid</span><span class="variable">.ui</span><span class="variable">.main</span><span class="variable">.activity</span><span class="variable">.MainActivity</span><span class="variable">.initEventAndData</span>$__twin__(MainActivity<span class="variable">.java</span>:107)\n\tat&quot;</span><br></pre></td></tr></table></figure>

<p>从以上信息我们不仅可以知道message执行的时间，还可以从对应的堆栈信息中得到发送message的位置，这里的位置是MainActivity的107行，也就是new Handler().post()这一行代码。使用这种方式我们就可以知道在列表展示之前到底执行了哪些自定义的message，我们一眼就可以知道哪些message其实是不符合我们预期的，比如说<strong>message的执行时间过长，或者说这个message其实可以延后执行，这个我们都可以根据实际的项目和业务需求进行相应地修改</strong>。</p>
<h2 id="4、耗时盲区监控方案总结"><a href="#4、耗时盲区监控方案总结" class="headerlink" title="4、耗时盲区监控方案总结"></a>4、耗时盲区监控方案总结</h2><p>耗时盲区监控是我们卡顿监控中不可或缺的一个环节，也是卡顿监控全面性的一个重要保障。而需要注意的是，TraceView仅仅适用于线下的一个场景，同时对于TraceView来说，它可以用于监控我们系统的message。而最后介绍的动态替换的方式其实是适合于线上的，同时，它仅仅监控应用自身的一个message。</p>
<h1 id="五、卡顿优化技巧总结"><a href="#五、卡顿优化技巧总结" class="headerlink" title="五、卡顿优化技巧总结"></a>五、卡顿优化技巧总结</h1><h2 id="1、卡顿优化实践经验"><a href="#1、卡顿优化实践经验" class="headerlink" title="1、卡顿优化实践经验"></a>1、卡顿优化实践经验</h2><p>如果应用出现了卡顿现象，那么可以考虑以下方式进行优化：</p>
<ul>
<li>首先，对于耗时的操作，我们可以考虑<strong>异步或延迟初始化</strong>的方式，这样可以解决大多数的问题。但是，大家一定要注意代码的优雅性。</li>
<li>对于布局加载优化，可以采用<strong>AsyncLayoutInflater或者是X2C的方式来优化主线程IO以及反射导致的消耗</strong>，同时，需要注意，对于重绘问题，要给与一定的重视。</li>
<li>此外，内存问题也可能会导致应用界面的卡顿，我们可以通过<strong>降低内存占用的方式来减少GC的次数以及时间</strong>，而GC的次数和时间我们可以通过log查看。</li>
</ul>
<p>然后，我们来看看卡顿优化的工具建设。</p>
<h2 id="2、卡顿优化工具建设"><a href="#2、卡顿优化工具建设" class="headerlink" title="2、卡顿优化工具建设"></a>2、卡顿优化工具建设</h2><p>工具建设这块经常容易被大家所忽视，但是它的收益却非常大，也是卡顿优化的一个重点。首先，对于系统工具而言，我们要有一个认识，同时一定要学会使用它，这里我们再回顾一下。</p>
<ul>
<li>对于Systrace来说，我们可以很方便地看出来它的CPU使用情况。另外，它的开销也比较小。</li>
<li>对于TraceView来说，我们可以很方便地看出来每一个线程它在特定的时间内做了什么操作，但是TraceView它的开销相对比较大，有时候可能会被带偏优化方向。</li>
<li>同时，需要注意，StrictMode也是一个非常强大的工具。</li>
</ul>
<p>然后，我们介绍了自动化工具建设以及优化方案。我们介绍了两个工具，AndroidPerformanceMonitor以及ANR-WatchDog。同时<strong>针对于AndroidPerformanceMonitor的问题，我们采用了高频采集，以找出重复率高的堆栈这样一种方式进行优化</strong>，在学习的过程中，我们不仅需要学会怎样去使用工具，更要去理解它们的实现原理以及各自的使用场景。</p>
<p>同时，我们对于<strong>卡顿优化工具的建设也做了细化，对于单点问题，比如说IPC监控，我们通过Hook的手段来做到尽早的发现问题。对于耗时盲区的监控，我们在线上采用的是替换Handler的方式来监控所有子线程message执行的耗时以及调用堆栈</strong>。</p>
<p>最后，我们来看一下卡顿监控的指标。我们会计算应用<strong>整体的卡顿率，ANR率、界面秒开率以及交换时间、生命周期时间等等</strong>。在<strong>上报ANR信息的同时</strong>，我们也需要<strong>上报环境和场景信息</strong>，这样不仅方便我们在<strong>不同版本之间进行横向对比</strong>，同时，也可以<strong>结合我们的报警平台在第一时间感知到异常</strong>。</p>
<h1 id="六、常见卡顿问题解决方案总结"><a href="#六、常见卡顿问题解决方案总结" class="headerlink" title="六、常见卡顿问题解决方案总结"></a>六、常见卡顿问题解决方案总结</h1><h2 id="1、CPU资源争抢引发的卡顿问题如何解决？"><a href="#1、CPU资源争抢引发的卡顿问题如何解决？" class="headerlink" title="1、CPU资源争抢引发的卡顿问题如何解决？"></a>1、CPU资源争抢引发的卡顿问题如何解决？</h2><p>此时，我们的应用不仅应该控制好核心功能的CPU消耗，也需要尽量减少非核心需求的CPU消耗。</p>
<h2 id="2、要注意Android-Java中提供的哪些低效的API？"><a href="#2、要注意Android-Java中提供的哪些低效的API？" class="headerlink" title="2、要注意Android Java中提供的哪些低效的API？"></a>2、要注意Android Java中提供的哪些低效的API？</h2><p>比如List.removeall方法，它内部会遍历一次需要过滤的消息列表，在已经存在循环列表的情况下会造成CPU资源的冗余使用，此时应该去优化相关的算法，避免使用List.removeall这个方法。</p>
<h2 id="3、如何减少图形处理的CPU消耗？"><a href="#3、如何减少图形处理的CPU消耗？" class="headerlink" title="3、如何减少图形处理的CPU消耗？"></a>3、如何减少图形处理的CPU消耗？</h2><p>这个时候我们需要使用神器renderscript来图形处理的相关运算，将CPU转换到GPU。关于renderscript的背景知识可以看看笔者之前写的<a target="_blank" rel="noopener" href="https://juejin.im/post/6844904048068395015#heading-25">深入探索Android布局优化（下）</a>。</p>
<h2 id="4、硬件加速长中文字体渲染时造成的卡顿如何解决？"><a href="#4、硬件加速长中文字体渲染时造成的卡顿如何解决？" class="headerlink" title="4、硬件加速长中文字体渲染时造成的卡顿如何解决？"></a>4、硬件加速长中文字体渲染时造成的卡顿如何解决？</h2><p>此时只能<strong>关闭文本TextView的硬件加速</strong>，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">textView.setLayerType(View.LAYER_TYPE_SOFTWARE, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure>

<p>当开启了硬件加速进行长中文字体的渲染时，首先会调用ViewRootImpl.draw()方法，最后会调用GLES20Canvas.nDrawDisplayList()方法开始通过JNI调整到Native层。在这个方法里，会继续调用OpenGLRenderer.drawDisplayList()方法，它通过<strong>调用DisplayList的replay方法，以回放前面录制的DisplayList执行绘制操作</strong>。</p>
<p>DisplayList的replay方法会遍历DisplayList中保存的每一个操作。其中渲染字体的操作名是DrawText，当遍历到一个DrawText操作时，会调用OpenGLRender::drawText方法区渲染字体。最终，<strong>会在OpenGLRender::drawText方法里去调用Font::render()方法渲染字体，而在这个方法中有一个很关键的操作，即获取字体缓存</strong>。我们都知道每一个中文的编码都是不同的，因此中文的缓存效果非常不理想，但是对于英文而言，只需要缓存26个字母就可以了。在Android 4.1.2版本之前对文本的Buffer设置过小，所以情况比较严重，如果你的<strong>应用在其它版本的渲染性能尚可，就可以仅仅把Android 4.0.x的硬件加速关闭</strong>，代码如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// AndroidManifest中</span><br><span class="line"><span class="tag">&lt;<span class="name">Applicaiton</span></span></span><br><span class="line"><span class="tag">        <span class="attr">...</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:hardwareAccelerated</span>=<span class="string">&quot;@bool/hardware_acceleration&quot;</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">// value-v14、value-v15中设置相应的Bool</span><br><span class="line">值即可</span><br><span class="line"><span class="tag">&lt;<span class="name">bool</span> <span class="attr">name</span>=<span class="string">&quot;hardware_acceleration&quot;</span>&gt;</span>false<span class="tag">&lt;/<span class="name">bool</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>此外，硬件渲染还有一些其它的问题在使用时需要注意，具体为如下所示：</p>
<ul>
<li>1、在软件渲染的情况下，如果需要重绘某个父View的所有子View，只需要调用这个Parent View的invalidate()方法即可，但如果开启了硬件加速，这么做是行不通的，需要遍历整个子View并调用invalidate()。</li>
<li>2、在软件渲染的情况下，会常常使用Bitmap重用的方式来节省内存，但是如果开启了硬件加速，这将会无效。</li>
<li>3、当开启硬件加速的UI在前台运行时，需要耗费额外的内存。当硬件加速的UI切换到后台时，上述额外内存有可能不会释放，这大多存在于Android 4.1.2版本中。</li>
<li>4、长或宽大于2048像素的Bitmap无法绘制，显示为一片透明。原因是OpenGL的材质大小上限为2048 * 2048，因此对于超过2048像素的Bitmap，需要将其切割成2048 * 2048以内的图片块，最后在显示的时候拼起来。</li>
<li>5、当UI中存在过渡绘制时，可能会发生花屏，一般来说绘制少于5层不会出现花屏现象，如果有大块红色区域就要十分小心了。</li>
<li>6、需要注意，关于LAYER_TYPE_SOFTWARE，虽然无论在App打开硬件加速或没有打开硬件加速的时候，都会通过软件绘制Bitmap作为离屏缓存，但区别在于打开硬件加速的时候，Bitmap最终还会通过硬件加速方式drawDisplayList去渲染这个Bitmap。</li>
</ul>
<h1 id="七、卡顿优化的常见问题"><a href="#七、卡顿优化的常见问题" class="headerlink" title="七、卡顿优化的常见问题"></a>七、卡顿优化的常见问题</h1><h2 id="1、你是怎么做卡顿优化的？"><a href="#1、你是怎么做卡顿优化的？" class="headerlink" title="1、你是怎么做卡顿优化的？"></a>1、你是怎么做卡顿优化的？</h2><p>从项目的初期到壮大期，最后再到成熟期，每一个阶段都针对卡顿优化做了不同的处理。各个阶段所做的事情如下所示：</p>
<ul>
<li>1、系统工具定位、解决</li>
<li>2、自动化卡顿方案及优化</li>
<li>3、线上监控及线下监测工具的建设</li>
</ul>
<p>我做卡顿优化也是经历了一些阶段，最初我们的项目当中的一些模块出现了卡顿之后，我是通过系统工具进行了定位，我使用了Systrace，然后看了卡顿周期内的CPU状况，同时结合代码，对这个模块进行了重构，将部分代码进行了异步和延迟，在项目初期就是这样解决了问题。</p>
<p>但是呢，随着我们项目的扩大，线下卡顿的问题也越来越多，同时，在线上，也有卡顿的反馈，但是线上的反馈卡顿，我们在线下难以复现，于是我们开始寻找自动化的卡顿监测方案，其思路是来自于Android的消息处理机制，主线程执行任何代码都会回到Looper.loop方法当中，而这个方法中有一个mLogging对象，它会在每个message的执行前后都会被调用，我们就是利用这个前后处理的时机来做到的自动化监测方案的。同时，在这个阶段，我们也完善了线上ANR的上报，我们采取的方式就是监控ANR的信息，同时结合了ANR-WatchDog，作为高版本没有文件权限的一个补充方案。</p>
<p>在做完这个卡顿检测方案之后呢，我们还做了线上监控及线下检测工具的建设，最终实现了一整套完善，多维度的解决方案。</p>
<h2 id="2、你是怎么样自动化的获取卡顿信息？"><a href="#2、你是怎么样自动化的获取卡顿信息？" class="headerlink" title="2、你是怎么样自动化的获取卡顿信息？"></a>2、你是怎么样自动化的获取卡顿信息？</h2><p>我们的思路是来自于Android的消息处理机制，主线程执行任何代码它都会走到Looper.loop方法当中，而这个函数当中有一个<strong>mLogging</strong>对象，它会在每个message处理前后都会被调用，而主线程发生了卡顿，那就一定会在dispatchMessage方法中执行了耗时的代码，那我们在这个message执行之前呢，我们可以在子线程当中去postDelayed一个任务，这个Delayed的时间就是我们设定的阈值，如果主线程的messaege在这个阈值之内完成了，那就取消掉这个子线程当中的任务，如果主线程的message在阈值之内没有被完成，那子线程当中的任务就会被执行，它会获取到当前主线程执行的一个堆栈，那我们就可以知道哪里发生了卡顿。</p>
<p>经过实践，我们发现这种方案获取的堆栈信息它不一定是准确的，因为获取到的堆栈信息它很可能是主线程最终执行的一个位置，而真正耗时的地方其实已经执行完成了，于是呢，我们就对这个方案做了一些优化，我们采取了<strong>高频采集</strong>的方案，也就是在一个周期内我们会多次采集主线程的堆栈信息，如果发生了卡顿，那我们就将这些卡顿信息压缩之后上报给APM后台，然后找出重复的堆栈信息，这些重复发生的堆栈大概率就是卡顿发生的一个位置，这样就提高了获取卡顿信息的一个准确性。</p>
<h2 id="3、卡顿的一整套解决方案是怎么做的？"><a href="#3、卡顿的一整套解决方案是怎么做的？" class="headerlink" title="3、卡顿的一整套解决方案是怎么做的？"></a>3、卡顿的一整套解决方案是怎么做的？</h2><p>首先，针对卡顿，我们采用了<strong>线上、线下工具相结合</strong>的方式，线下工具我们需要尽可能早地去暴露问题，而针对于线上工具呢，我们侧重于监控的全面性、自动化以及异常感知的灵敏度。</p>
<p>同时呢，卡顿问题还有很多的难题。比如说<strong>有的代码呢，它不到你卡顿的一个阈值，但是执行过多，或者它错误地执行了很多次，它也会导致用户感官上的一个卡顿</strong>，所以我们在线下通过AOP的方式对常见的耗时代码进行了Hook，然后对一段时间内获取到的数据进行分析，我们就可以知道这些耗时的代码发生的时机和次数以及耗时情况。然后，看它是不是满足我们的一个预期，不满足预期的话，我们就可以直接到线下进行修改。同时，卡顿监控它还有很多容易被忽略的一个<strong>盲区</strong>，比如说生命周期的一个间隔，那对于这种特定的问题呢，我们就采用了编译时注解的方式修改了项目当中所有Handler的父类，对于其中的两个方法进行了监控，我们就可以知道主线程message的执行时间以及它们的调用堆栈。</p>
<p>对于<strong>线上卡顿</strong>，我们除了计算App的卡顿率、ANR率等常规指标之外呢，我们还计算了页面的秒开率、生命周期的执行时间等等。而且，在卡顿发生的时刻，我们也尽可能多地保存下来了当前的一个场景信息，这为我们之后解决或者复现这个卡顿留下了依据。</p>
<h1 id="八、总结"><a href="#八、总结" class="headerlink" title="八、总结"></a>八、总结</h1><p>恭喜你，如果你看到了这里，你会发现要做好应用的卡顿优化的确不是一件简单的事，它需要你有成体系的知识构建基底。最后，我们再来回顾一下面对卡顿优化，我们已经探索的以下九大主题：</p>
<ul>
<li>1、卡顿优化分析方法与工具：背景介绍、卡顿分析方法之使用shell命令分析CPU耗时、卡顿优化工具。</li>
<li>2、自动化卡顿检测方案及优化：卡顿检测方案原理、AndroidPerformanceMonitor实战及其优化。</li>
<li>3、ANR分析与实战：ANR执行流程、线上ANR监控方式、ANR-WatchDog原理。</li>
<li>4、卡顿单点问题检测方案：IPC单点问题检测方案、卡顿问题检测方案。</li>
<li>5、如何实现界面秒开？：界面秒开实现、Lancet、界面秒开监控纬度。</li>
<li>6、优雅监控耗时盲区：耗时盲区监控难点以及线上与线下的监控方案。</li>
<li>7、卡顿优化技巧总结：卡顿优化实践经验、卡顿优化工具建设。</li>
<li>8︎、常见卡顿问题解决方案总结</li>
<li>9、卡顿优化的常见问题</li>
</ul>
<p>相信看到这里，你一定收获满满，但是要记住，方案再好，也只有自己动手去实践，才能真正地掌握它。<strong>只有重视实践，充分运用感性认知潜能，在项目中磨炼自己，才是正确的学习之道。在实践中，在某些关键动作上刻意练习，也会取得事半功倍的效果。</strong></p>
<!-- flag of hidden posts -->
      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>请我喝杯奶茶吧~</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt=" WeChat Pay"/>
        <p>WeChat Pay</p>
      </div>
    

    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/private/" rel="tag"># private</a>
          
            <a href="/tags/%E5%AE%89%E5%8D%93%E4%BC%98%E5%8C%96/" rel="tag"># 安卓优化</a>
          
        </div>
      

      
      
      

      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7Carchive">
              
                  <span class="site-state-item-count">248</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">49</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="mailto:shenbh@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://juejin.im/user/57ea31a1a22b9d0061656f52" target="_blank" title="掘金">
                      
                        <i class="fa fa-fw fa-fa fa-fw fa-book"></i>掘金</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/shenbh" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.wanandroid.com/" title="玩Android" target="_blank">玩Android</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://wuxiaolong.me/" title="吴小龙同学" target="_blank">吴小龙同学</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://hexo.yuanjh.cn/" title="江州司马" target="_blank">江州司马</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.yanghujun.com/" title="八归少年" target="_blank">八归少年</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://zhpanvip.gitee.io/" title="马可没有菠萝" target="_blank">马可没有菠萝</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://omooo.top/" title="Omooo" target="_blank">Omooo</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://gityuan.com/" title="Gityuan" target="_blank">Gityuan</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96"><span class="nav-text">卡顿优化</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96%E5%88%86%E6%9E%90%E6%96%B9%E6%B3%95%E4%B8%8E%E5%B7%A5%E5%85%B7"><span class="nav-text">一、卡顿优化分析方法与工具</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E8%83%8C%E6%99%AF%E4%BB%8B%E7%BB%8D"><span class="nav-text">1、背景介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%82%A3%E4%B9%88%E5%8D%A1%E9%A1%BF%E9%97%AE%E9%A2%98%E5%88%B0%E5%BA%95%E9%9A%BE%E5%9C%A8%E5%93%AA%E9%87%8C%E5%91%A2%EF%BC%9F"><span class="nav-text">那么卡顿问题到底难在哪里呢？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E5%8D%A1%E9%A1%BF%E5%88%86%E6%9E%90%E6%96%B9%E6%B3%95%E4%B9%8B%E4%BD%BF%E7%94%A8shell%E5%91%BD%E4%BB%A4%E5%88%86%E6%9E%90CPU%E8%80%97%E6%97%B6"><span class="nav-text">2、卡顿分析方法之使用shell命令分析CPU耗时</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81%E4%BA%86%E8%A7%A3CPU-%E6%80%A7%E8%83%BD"><span class="nav-text">1、了解CPU 性能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E9%80%9A%E8%BF%87%E8%AF%BB%E5%8F%96-x2F-proc-x2F-stat%E4%B8%8E-x2F-proc-x2F-PID-x2F-stat%E6%96%87%E4%BB%B6%E6%9D%A5%E8%AE%A1%E7%AE%97%E5%B9%B6%E8%AF%84%E4%BC%B0%E7%B3%BB%E7%BB%9F%E7%9A%84CPU%E8%80%97%E6%97%B6%E6%83%85%E5%86%B5"><span class="nav-text">2、通过读取&#x2F;proc&#x2F;stat与&#x2F;proc&#x2F;[PID]&#x2F;stat文件来计算并评估系统的CPU耗时情况</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%A1%E7%AE%97%E6%80%BB%E7%9A%84-CPU-%E4%BD%BF%E7%94%A8%E7%8E%87"><span class="nav-text">计算总的 CPU 使用率</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81%E4%BD%BF%E7%94%A8top%E5%91%BD%E4%BB%A4%E6%9F%A5%E7%9C%8B%E5%BA%94%E7%94%A8%E8%BF%9B%E7%A8%8B%E7%9A%84CPU%E6%B6%88%E8%80%97%E6%83%85%E5%86%B5"><span class="nav-text">3、使用top命令查看应用进程的CPU消耗情况</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%E3%80%81PS%E8%BD%AF%E4%BB%B6"><span class="nav-text">4、PS软件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5%E3%80%81dumpsys-cpuinfo"><span class="nav-text">5、dumpsys cpuinfo</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%A1%E9%A1%BF%E7%8E%87"><span class="nav-text">卡顿率</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%A1%E9%A1%BF%E6%A0%91"><span class="nav-text">卡顿树</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96%E5%B7%A5%E5%85%B7"><span class="nav-text">3、卡顿优化工具</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81CPU-Profiler%E5%9B%9E%E9%A1%BE"><span class="nav-text">1、CPU Profiler回顾</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E5%8A%BF%EF%BC%9A"><span class="nav-text">优势：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8A%A3%E5%8A%BF%EF%BC%9A"><span class="nav-text">劣势：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F%EF%BC%9A"><span class="nav-text">使用方式：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81Systrace%E5%9B%9E%E9%A1%BE"><span class="nav-text">2、Systrace回顾</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%9C%E7%94%A8%EF%BC%9A"><span class="nav-text">作用：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BB%BA%E8%AE%AE%EF%BC%9A"><span class="nav-text">建议：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F%EF%BC%9A-1"><span class="nav-text">使用方式：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E5%8A%BF%EF%BC%9A-1"><span class="nav-text">优势：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81StrictMode"><span class="nav-text">3、StrictMode</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E7%BA%BF%E7%A8%8B%E7%AD%96%E7%95%A5"><span class="nav-text">1、线程策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%AD%96%E7%95%A5"><span class="nav-text">2、虚拟机策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#StrictMode%E5%AE%9E%E6%88%98"><span class="nav-text">StrictMode实战</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4%E3%80%81Profilo"><span class="nav-text">4、Profilo</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81%E4%BD%BF%E7%94%A8profilo%E7%9A%84PLTHook%E6%9D%A5hook-libc-so%E7%9A%84-write-%E4%B8%8E-write-chk-%E6%96%B9%E6%B3%95"><span class="nav-text">1、使用profilo的PLTHook来hook libc.so的 write 与 __write_chk 方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E4%BD%BF%E7%94%A8PLTHook%E6%8A%80%E6%9C%AF%E6%9D%A5%E8%8E%B7%E5%8F%96%E7%BA%BF%E7%A8%8B%E5%88%9B%E5%BB%BA%E7%9A%84%E5%A0%86%E6%A0%88"><span class="nav-text">2、使用PLTHook技术来获取线程创建的堆栈</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E8%87%AA%E5%8A%A8%E5%8C%96%E5%8D%A1%E9%A1%BF%E6%A3%80%E6%B5%8B%E6%96%B9%E6%A1%88%E5%8F%8A%E4%BC%98%E5%8C%96"><span class="nav-text">二、自动化卡顿检测方案及优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E8%87%AA%E5%8A%A8%E5%8C%96%E5%8D%A1%E9%A1%BF%E6%A3%80%E6%B5%8B%E6%96%B9%E6%A1%88%EF%BC%9F"><span class="nav-text">1、为什么需要自动化卡顿检测方案？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E5%8D%A1%E9%A1%BF%E6%A3%80%E6%B5%8B%E6%96%B9%E6%A1%88%E5%8E%9F%E7%90%86"><span class="nav-text">2、卡顿检测方案原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%A1%E9%A1%BF%E6%A3%80%E6%B5%8B%E6%96%B9%E6%A1%88%E7%9A%84%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4"><span class="nav-text">卡顿检测方案的具体实现步骤</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81AndroidPerformanceMonitor"><span class="nav-text">3、AndroidPerformanceMonitor</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BlockCanary%E7%9A%84%E4%BC%98%E5%8A%BF%E5%A6%82%E4%B8%8B"><span class="nav-text">BlockCanary的优势如下</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%82%A3%E4%B9%88%E8%BF%99%E7%A7%8D%E8%87%AA%E5%8A%A8%E6%A3%80%E6%B5%8B%E5%8D%A1%E9%A1%BF%E7%9A%84%E6%96%B9%E6%A1%88%E6%9C%89%E4%BB%80%E4%B9%88%E9%97%AE%E9%A2%98%E5%90%97%EF%BC%9F"><span class="nav-text">那么这种自动检测卡顿的方案有什么问题吗？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%82%A3%E4%B9%88%EF%BC%8C%E6%88%91%E4%BB%AC%E5%A6%82%E4%BD%95%E5%AF%B9%E8%BF%99%E7%A7%8D%E6%83%85%E5%86%B5%E8%BF%9B%E8%A1%8C%E4%BC%98%E5%8C%96%E5%91%A2%EF%BC%9F"><span class="nav-text">那么，我们如何对这种情况进行优化呢？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4%E3%80%81%E5%B0%8F%E7%BB%93"><span class="nav-text">4、小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E6%80%BB%E7%BB%93"><span class="nav-text">三、总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81ANR%E5%88%86%E6%9E%90%E4%B8%8E%E5%AE%9E%E6%88%98"><span class="nav-text">一、ANR分析与实战</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81ANR%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%AE%9E%E6%88%98"><span class="nav-text">1、ANR介绍与实战</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ANR%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-text">ANR执行流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E4%B8%8AANR%E7%9B%91%E6%8E%A7%E6%96%B9%E5%BC%8F"><span class="nav-text">线上ANR监控方式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81ANR-WatchDog%E5%8E%9F%E7%90%86"><span class="nav-text">2、ANR-WatchDog原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E5%B0%8F%E7%BB%93"><span class="nav-text">3、小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E5%8D%A1%E9%A1%BF%E5%8D%95%E7%82%B9%E9%97%AE%E9%A2%98%E6%A3%80%E6%B5%8B%E6%96%B9%E6%A1%88"><span class="nav-text">二、卡顿单点问题检测方案</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81IPC%E5%8D%95%E7%82%B9%E9%97%AE%E9%A2%98%E6%A3%80%E6%B5%8B%E6%96%B9%E6%A1%88"><span class="nav-text">1、IPC单点问题检测方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%84%E6%96%B9%E6%A1%88"><span class="nav-text">常规方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IPC%E9%97%AE%E9%A2%98%E7%9B%91%E6%B5%8B%E6%8A%80%E5%B7%A7"><span class="nav-text">IPC问题监测技巧</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E5%8D%A1%E9%A1%BF%E9%97%AE%E9%A2%98%E6%A3%80%E6%B5%8B%E6%96%B9%E6%A1%88"><span class="nav-text">2、卡顿问题检测方案</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%95%8C%E9%9D%A2%E7%A7%92%E5%BC%80%EF%BC%9F"><span class="nav-text">三、如何实现界面秒开？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E7%95%8C%E9%9D%A2%E7%A7%92%E5%BC%80%E5%AE%9E%E7%8E%B0"><span class="nav-text">1、界面秒开实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%82%A3%E4%B9%88%E6%88%91%E4%BB%AC%E5%A6%82%E4%BD%95%E5%8E%BB%E8%A1%A1%E9%87%8F%E7%95%8C%E9%9D%A2%E7%9A%84%E6%89%93%E5%BC%80%E9%80%9F%E5%BA%A6%E5%91%A2%EF%BC%9F"><span class="nav-text">那么我们如何去衡量界面的打开速度呢？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81Lancet"><span class="nav-text">2、Lancet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E7%95%8C%E9%9D%A2%E7%A7%92%E5%BC%80%E7%9B%91%E6%8E%A7%E7%BA%AC%E5%BA%A6"><span class="nav-text">3、界面秒开监控纬度</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E4%BC%98%E9%9B%85%E7%9B%91%E6%8E%A7%E8%80%97%E6%97%B6%E7%9B%B2%E5%8C%BA"><span class="nav-text">四、优雅监控耗时盲区</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E8%80%97%E6%97%B6%E7%9B%B2%E5%8C%BA%E7%9B%91%E6%8E%A7%E9%9A%BE%E7%82%B9"><span class="nav-text">1、耗时盲区监控难点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E8%80%97%E6%97%B6%E7%9B%B2%E5%8C%BA%E7%9B%91%E6%8E%A7%E7%BA%BF%E4%B8%8B%E6%96%B9%E6%A1%88"><span class="nav-text">2、耗时盲区监控线下方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E8%80%97%E6%97%B6%E7%9B%B2%E5%8C%BA%E7%9B%91%E6%8E%A7%E7%BA%BF%E4%B8%8A%E6%96%B9%E6%A1%88"><span class="nav-text">3、耗时盲区监控线上方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4%E3%80%81%E8%80%97%E6%97%B6%E7%9B%B2%E5%8C%BA%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93"><span class="nav-text">4、耗时盲区监控方案总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A7%E6%80%BB%E7%BB%93"><span class="nav-text">五、卡顿优化技巧总结</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96%E5%AE%9E%E8%B7%B5%E7%BB%8F%E9%AA%8C"><span class="nav-text">1、卡顿优化实践经验</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96%E5%B7%A5%E5%85%B7%E5%BB%BA%E8%AE%BE"><span class="nav-text">2、卡顿优化工具建设</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E5%B8%B8%E8%A7%81%E5%8D%A1%E9%A1%BF%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93"><span class="nav-text">六、常见卡顿问题解决方案总结</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81CPU%E8%B5%84%E6%BA%90%E4%BA%89%E6%8A%A2%E5%BC%95%E5%8F%91%E7%9A%84%E5%8D%A1%E9%A1%BF%E9%97%AE%E9%A2%98%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%EF%BC%9F"><span class="nav-text">1、CPU资源争抢引发的卡顿问题如何解决？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E8%A6%81%E6%B3%A8%E6%84%8FAndroid-Java%E4%B8%AD%E6%8F%90%E4%BE%9B%E7%9A%84%E5%93%AA%E4%BA%9B%E4%BD%8E%E6%95%88%E7%9A%84API%EF%BC%9F"><span class="nav-text">2、要注意Android Java中提供的哪些低效的API？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E5%A6%82%E4%BD%95%E5%87%8F%E5%B0%91%E5%9B%BE%E5%BD%A2%E5%A4%84%E7%90%86%E7%9A%84CPU%E6%B6%88%E8%80%97%EF%BC%9F"><span class="nav-text">3、如何减少图形处理的CPU消耗？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4%E3%80%81%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F%E9%95%BF%E4%B8%AD%E6%96%87%E5%AD%97%E4%BD%93%E6%B8%B2%E6%9F%93%E6%97%B6%E9%80%A0%E6%88%90%E7%9A%84%E5%8D%A1%E9%A1%BF%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%EF%BC%9F"><span class="nav-text">4、硬件加速长中文字体渲染时造成的卡顿如何解决？</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%83%E3%80%81%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96%E7%9A%84%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="nav-text">七、卡顿优化的常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E4%BD%A0%E6%98%AF%E6%80%8E%E4%B9%88%E5%81%9A%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96%E7%9A%84%EF%BC%9F"><span class="nav-text">1、你是怎么做卡顿优化的？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E4%BD%A0%E6%98%AF%E6%80%8E%E4%B9%88%E6%A0%B7%E8%87%AA%E5%8A%A8%E5%8C%96%E7%9A%84%E8%8E%B7%E5%8F%96%E5%8D%A1%E9%A1%BF%E4%BF%A1%E6%81%AF%EF%BC%9F"><span class="nav-text">2、你是怎么样自动化的获取卡顿信息？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E5%8D%A1%E9%A1%BF%E7%9A%84%E4%B8%80%E6%95%B4%E5%A5%97%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%98%AF%E6%80%8E%E4%B9%88%E5%81%9A%E7%9A%84%EF%BC%9F"><span class="nav-text">3、卡顿的一整套解决方案是怎么做的？</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AB%E3%80%81%E6%80%BB%E7%BB%93"><span class="nav-text">八、总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">阿炳</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('-1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
          if(result)$(this).text('Copied')
          else $(this).text('Copy failed')
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('Copy')
        }, 300)
      }).append(e)
    })
  </script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>