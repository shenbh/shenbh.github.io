<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="private,安卓UI," />










<meta name="description" content="Webview基本使用WebView 12345678910111213141516171819&#x2F;&#x2F; 获取当前页面的URLpublic String getUrl();&#x2F;&#x2F; 获取当前页面的原始URL(重定向后可能当前url不同)&#x2F;&#x2F; 就是http headers的Referer参数，loadUrl时为nullpublic String getOriginalUrl();&#x2F;&#x2F; 获取当前页面的标题pu">
<meta property="og:type" content="article">
<meta property="og:title" content="UI-WebView">
<meta property="og:url" content="http://shenbh.github.io/posts/3599255197/index.html">
<meta property="og:site_name" content="YULI">
<meta property="og:description" content="Webview基本使用WebView 12345678910111213141516171819&#x2F;&#x2F; 获取当前页面的URLpublic String getUrl();&#x2F;&#x2F; 获取当前页面的原始URL(重定向后可能当前url不同)&#x2F;&#x2F; 就是http headers的Referer参数，loadUrl时为nullpublic String getOriginalUrl();&#x2F;&#x2F; 获取当前页面的标题pu">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2017/9a2f8beb.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200224172427258.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0V2ZXI2OQ==,size_16,color_FFFFFF,t_70">
<meta property="article:published_time" content="2020-03-16T02:18:58.000Z">
<meta property="article:modified_time" content="2024-04-28T03:02:52.552Z">
<meta property="article:author" content="阿炳">
<meta property="article:tag" content="private">
<meta property="article:tag" content="安卓UI">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2017/9a2f8beb.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://shenbh.github.io/posts/3599255197/"/>





  <title>UI-WebView | YULI</title><meta name="robots" content="noindex">
  








<meta name="generator" content="Hexo 6.1.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">YULI</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Just do IT Now.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://shenbh.github.io/posts/3599255197/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YULI">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">UI-WebView</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-16T10:18:58+08:00">
                2020-03-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Webview"><a href="#Webview" class="headerlink" title="Webview"></a>Webview</h1><h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><p><strong>WebView</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取当前页面的URL</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getUrl</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">// 获取当前页面的原始URL(重定向后可能当前url不同)</span></span><br><span class="line"><span class="comment">// 就是http headers的Referer参数，loadUrl时为null</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getOriginalUrl</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">// 获取当前页面的标题</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getTitle</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">// 获取当前页面的favicon</span></span><br><span class="line"><span class="keyword">public</span> Bitmap <span class="title function_">getFavicon</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">// 获取当前页面的加载进度</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getProgress</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通知WebView内核网络状态</span></span><br><span class="line"><span class="comment">// 用于设置JS属性`window.navigator.isOnline`和产生HTML5事件`online/offline`</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNetworkAvailable</span><span class="params">(<span class="type">boolean</span> networkUp)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置初始缩放比例</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setInitialScale</span><span class="params">(<span class="type">int</span> scaleInPercent)</span>；</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">webview.setScrollContainer(<span class="literal">false</span>); 			  <span class="comment">//内容是否可以滚动</span></span><br><span class="line">webview.setHorizontalScrollBarEnabled(<span class="literal">false</span>); <span class="comment">//是否显示水平方向的滚动条</span></span><br><span class="line">webview.setVerticalScrollBarEnabled(<span class="literal">false</span>);	  <span class="comment">//是否显示垂直方向的滚动条</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//加载内容</span></span><br><span class="line"><span class="keyword">if</span> (data.length() &gt; <span class="number">7</span> &amp;&amp; data.contains(<span class="string">&quot;&lt;p&gt;&quot;</span>) &amp;&amp; data.contains(<span class="string">&quot;&lt;/p&gt;&quot;</span>))&#123;</span><br><span class="line">    data = data.replaceAll(<span class="string">&quot;&lt;p&gt;&quot;</span>, <span class="string">&quot;&lt;p style=\&quot;word-break:break-all\&quot;&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">webview.loadDataWithBaseURL(<span class="literal">null</span>, data, <span class="string">&quot;text/html&quot;</span>, <span class="string">&quot;utf-8&quot;</span>, <span class="literal">null</span>); <span class="comment">//加载html字符串</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>WebSettings</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebSettings</span> <span class="variable">settings</span> <span class="operator">=</span> web.getSettings();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 存储(storage)</span></span><br><span class="line"><span class="comment">// 启用HTML5 DOM storage API，默认值 false</span></span><br><span class="line">settings.setDomStorageEnabled(<span class="literal">true</span>); </span><br><span class="line"><span class="comment">// 启用Web SQL Database API，这个设置会影响同一进程内的所有WebView，默认值 false</span></span><br><span class="line"><span class="comment">// 此API已不推荐使用，参考：https://www.w3.org/TR/webdatabase/</span></span><br><span class="line">settings.setDatabaseEnabled(<span class="literal">true</span>);  </span><br><span class="line"><span class="comment">// 启用Application Caches API，必需设置有效的缓存路径才能生效，默认值 false</span></span><br><span class="line"><span class="comment">// 此API已废弃，参考：https://developer.mozilla.org/zh-CN/docs/Web/HTML/Using_the_application_cache</span></span><br><span class="line">settings.setAppCacheEnabled(<span class="literal">true</span>); </span><br><span class="line">settings.setAppCachePath(context.getCacheDir().getAbsolutePath());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定位(location)</span></span><br><span class="line">settings.setGeolocationEnabled(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否保存表单数据</span></span><br><span class="line">settings.setSaveFormData(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">// 是否当webview调用requestFocus时为页面的某个元素设置焦点，默认值 true</span></span><br><span class="line">settings.setNeedInitialFocus(<span class="literal">true</span>);  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否支持viewport属性，默认值 false</span></span><br><span class="line"><span class="comment">// 页面通过`&lt;meta name=&quot;viewport&quot; ... /&gt;`自适应手机屏幕</span></span><br><span class="line">settings.setUseWideViewPort(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">// 是否使用overview mode加载页面，默认值 false</span></span><br><span class="line"><span class="comment">// 当页面宽度大于WebView宽度时，缩小使页面宽度等于WebView宽度</span></span><br><span class="line">settings.setLoadWithOverviewMode(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">// 布局算法【支持内容重新布局】</span></span><br><span class="line">settings.setLayoutAlgorithm(WebSettings.LayoutAlgorithm.NORMAL); <span class="comment">//NORMAL 正常不做任何渲染</span></span><br><span class="line">																<span class="comment">//NARROW_COLUMNS 可能的话所有列的宽度不超过屏幕宽度</span></span><br><span class="line">																<span class="comment">//SINGLE_COLUMN 把所有内容放到webview等宽的一列中（会导致超出屏幕的部分不显示）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否支持Javascript，默认值false</span></span><br><span class="line">settings.setJavaScriptEnabled(<span class="literal">true</span>); </span><br><span class="line"><span class="comment">// 是否支持多窗口，默认值false</span></span><br><span class="line">settings.setSupportMultipleWindows(<span class="literal">false</span>);</span><br><span class="line"><span class="comment">// 是否可用Javascript(window.open)打开窗口，默认值 false</span></span><br><span class="line">settings.setJavaScriptCanOpenWindowsAutomatically(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 资源访问</span></span><br><span class="line">settings.setAllowContentAccess(<span class="literal">true</span>); <span class="comment">// 是否可访问Content Provider的资源，默认值 true</span></span><br><span class="line">settings.setAllowFileAccess(<span class="literal">true</span>);    <span class="comment">// 是否可访问本地文件，默认值 true</span></span><br><span class="line"><span class="comment">// 是否允许通过file url加载的Javascript读取本地文件，默认值 false</span></span><br><span class="line">settings.setAllowFileAccessFromFileURLs(<span class="literal">false</span>);  </span><br><span class="line"><span class="comment">// 是否允许通过file url加载的Javascript读取全部资源(包括文件,http,https)，默认值 false</span></span><br><span class="line">settings.setAllowUniversalAccessFromFileURLs(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 资源加载</span></span><br><span class="line">settings.setLoadsImagesAutomatically(<span class="literal">true</span>); <span class="comment">// 是否自动加载图片</span></span><br><span class="line">settings.setBlockNetworkImage(<span class="literal">false</span>);       <span class="comment">// 禁止加载网络图片</span></span><br><span class="line">settings.setBlockNetworkLoads(<span class="literal">false</span>);       <span class="comment">// 禁止加载所有网络资源</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 缩放(zoom)</span></span><br><span class="line">settings.setSupportZoom(<span class="literal">true</span>);          <span class="comment">// 是否支持缩放</span></span><br><span class="line">settings.setBuiltInZoomControls(<span class="literal">false</span>); <span class="comment">// 是否使用内置缩放机制。为true的话 setSupportZoom默认为true</span></span><br><span class="line">settings.setDisplayZoomControls(<span class="literal">true</span>);  <span class="comment">// 是否显示内置缩放控件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认文本编码，默认值 &quot;UTF-8&quot;</span></span><br><span class="line">settings.setDefaultTextEncodingName(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">settings.setDefaultFontSize(<span class="number">16</span>);        <span class="comment">// 默认文字尺寸，默认值16，取值范围1-72</span></span><br><span class="line">settings.setDefaultFixedFontSize(<span class="number">16</span>);   <span class="comment">// 默认等宽字体尺寸，默认值16</span></span><br><span class="line">settings.setMinimumFontSize(<span class="number">8</span>);         <span class="comment">// 最小文字尺寸，默认值 8</span></span><br><span class="line">settings.setMinimumLogicalFontSize(<span class="number">8</span>);  <span class="comment">// 最小文字逻辑尺寸，默认值 8</span></span><br><span class="line">settings.setTextZoom(<span class="number">100</span>);              <span class="comment">// 文字缩放百分比，默认值 100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 字体</span></span><br><span class="line">settings.setStandardFontFamily(<span class="string">&quot;sans-serif&quot;</span>);   <span class="comment">// 标准字体，默认值 &quot;sans-serif&quot;</span></span><br><span class="line">settings.setSerifFontFamily(<span class="string">&quot;serif&quot;</span>);           <span class="comment">// 衬线字体，默认值 &quot;serif&quot;</span></span><br><span class="line">settings.setSansSerifFontFamily(<span class="string">&quot;sans-serif&quot;</span>);  <span class="comment">// 无衬线字体，默认值 &quot;sans-serif&quot;</span></span><br><span class="line">settings.setFixedFontFamily(<span class="string">&quot;monospace&quot;</span>);       <span class="comment">// 等宽字体，默认值 &quot;monospace&quot;</span></span><br><span class="line">settings.setCursiveFontFamily(<span class="string">&quot;cursive&quot;</span>);       <span class="comment">// 手写体(草书)，默认值 &quot;cursive&quot;</span></span><br><span class="line">settings.setFantasyFontFamily(<span class="string">&quot;fantasy&quot;</span>);       <span class="comment">// 幻想体，默认值 &quot;fantasy&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) &#123;</span><br><span class="line">    <span class="comment">// 用户是否需要通过手势播放媒体(不会自动播放)，默认值 true</span></span><br><span class="line">    settings.setMediaPlaybackRequiresUserGesture(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) &#123;</span><br><span class="line">    <span class="comment">// 5.0以上允许加载http和https混合的页面(5.0以下默认允许，5.0+默认禁止)</span></span><br><span class="line">    settings.setMixedContentMode(WebSettings.MIXED_CONTENT_ALWAYS_ALLOW);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) &#123;</span><br><span class="line">    <span class="comment">// 是否在离开屏幕时光栅化(会增加内存消耗)，默认值 false</span></span><br><span class="line">    settings.setOffscreenPreRaster(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isNetworkConnected(context)) &#123;</span><br><span class="line">    <span class="comment">// 根据cache-control决定是否从网络上取数据</span></span><br><span class="line">    settings.setCacheMode(WebSettings.LOAD_DEFAULT);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 没网，离线加载，优先加载缓存(即使已经过期)</span></span><br><span class="line">    settings.setCacheMode(WebSettings.LOAD_CACHE_ELSE_NETWORK);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// deprecated</span></span><br><span class="line">settings.setRenderPriority(WebSettings.RenderPriority.HIGH);</span><br><span class="line">settings.setDatabasePath(context.getDir(<span class="string">&quot;database&quot;</span>, Context.MODE_PRIVATE).getPath());</span><br><span class="line">settings.setGeolocationDatabasePath(context.getFilesDir().getPath());</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>WebViewClient</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 拦截页面加载，返回true表示宿主app拦截并处理了该url，否则返回false由当前WebView处理</span></span><br><span class="line"><span class="comment">// 此方法在API24被废弃，不处理POST请求</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拦截页面加载，返回true表示宿主app拦截并处理了该url，否则返回false由当前WebView处理</span></span><br><span class="line"><span class="comment">// 此方法添加于API24，不处理POST请求，可拦截处理子frame的非http请求</span></span><br><span class="line"><span class="meta">@TargetApi(Build.VERSION_CODES.N)</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, WebResourceRequest request)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> shouldOverrideUrlLoading(view, request.getUrl().toString());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 此方法废弃于API21，调用于非UI线程</span></span><br><span class="line"><span class="comment">// 拦截资源请求并返回响应数据，返回null时WebView将继续加载资源</span></span><br><span class="line"><span class="keyword">public</span> WebResourceResponse <span class="title function_">shouldInterceptRequest</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 此方法添加于API21，调用于非UI线程</span></span><br><span class="line"><span class="comment">// 拦截资源请求并返回数据，返回null时WebView将继续加载资源</span></span><br><span class="line"><span class="meta">@TargetApi(Build.VERSION_CODES.LOLLIPOP)</span></span><br><span class="line"><span class="keyword">public</span> WebResourceResponse <span class="title function_">shouldInterceptRequest</span><span class="params">(WebView view, WebResourceRequest request)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> shouldInterceptRequest(view, request.getUrl().toString());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 页面(url)开始加载</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPageStarted</span><span class="params">(WebView view, String url, Bitmap favicon)</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 页面(url)完成加载</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPageFinished</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将要加载资源(url)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLoadResource</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这个回调添加于API23，仅用于主框架的导航</span></span><br><span class="line"><span class="comment">// 通知应用导航到之前页面时，其遗留的WebView内容将不再被绘制。</span></span><br><span class="line"><span class="comment">// 这个回调可以用来决定哪些WebView可见内容能被安全地回收，以确保不显示陈旧的内容</span></span><br><span class="line"><span class="comment">// 它最早被调用，以此保证WebView.onDraw不会绘制任何之前页面的内容，随后绘制背景色或需要加载的新内容。</span></span><br><span class="line"><span class="comment">// 当HTTP响应body已经开始加载并体现在DOM上将在随后的绘制中可见时，这个方法会被调用。</span></span><br><span class="line"><span class="comment">// 这个回调发生在文档加载的早期，因此它的资源(css,和图像)可能不可用。</span></span><br><span class="line"><span class="comment">// 如果需要更细粒度的视图更新，查看 postVisualStateCallback(long, WebView.VisualStateCallback).</span></span><br><span class="line"><span class="comment">// 请注意这上边的所有条件也支持 postVisualStateCallback(long ,WebView.VisualStateCallback)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPageCommitVisible</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 此方法废弃于API23</span></span><br><span class="line"><span class="comment">// 主框架加载资源时出错</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceivedError</span><span class="params">(WebView view, <span class="type">int</span> errorCode, String description, String failingUrl)</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 此方法添加于API23</span></span><br><span class="line"><span class="comment">// 加载资源时出错，通常意味着连接不到服务器</span></span><br><span class="line"><span class="comment">// 由于所有资源加载错误都会调用此方法，所以此方法应尽量逻辑简单</span></span><br><span class="line"><span class="meta">@TargetApi(Build.VERSION_CODES.M)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceivedError</span><span class="params">(WebView view, WebResourceRequest request, WebResourceError error)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (request.isForMainFrame()) &#123;</span><br><span class="line">        onReceivedError(view, error.getErrorCode(), error.getDescription().toString(), request.getUrl().toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 此方法添加于API23</span></span><br><span class="line"><span class="comment">// 在加载资源(iframe,image,js,css,ajax...)时收到了 HTTP 错误(状态码&gt;=400)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceivedHttpError</span><span class="params">(WebView view, WebResourceRequest request, WebResourceResponse errorResponse)</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否重新提交表单，默认不重发</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFormResubmission</span><span class="params">(WebView view, Message dontResend, Message resend)</span> &#123;</span><br><span class="line">    dontResend.sendToTarget();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通知应用可以将当前的url存储在数据库中，意味着当前的访问url已经生效并被记录在内核当中。</span></span><br><span class="line"><span class="comment">// 此方法在网页加载过程中只会被调用一次，网页前进后退并不会回调这个函数。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doUpdateVisitedHistory</span><span class="params">(WebView view, String url, <span class="type">boolean</span> isReload)</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载资源时发生了一个SSL错误，应用必需响应(继续请求或取消请求)</span></span><br><span class="line"><span class="comment">// 处理决策可能被缓存用于后续的请求，默认行为是取消请求</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceivedSslError</span><span class="params">(WebView view, SslErrorHandler handler, SslError error)</span> &#123;</span><br><span class="line">    handler.cancel();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 此方法添加于API21，在UI线程被调用</span></span><br><span class="line"><span class="comment">// 处理SSL客户端证书请求，必要的话可显示一个UI来提供KEY。</span></span><br><span class="line"><span class="comment">// 有三种响应方式：proceed()/cancel()/ignore()，默认行为是取消请求</span></span><br><span class="line"><span class="comment">// 如果调用proceed()或cancel()，Webview 将在内存中保存响应结果且对相同的&quot;host:port&quot;不会再次调用 onReceivedClientCertRequest</span></span><br><span class="line"><span class="comment">// 多数情况下，可通过KeyChain.choosePrivateKeyAlias启动一个Activity供用户选择合适的私钥</span></span><br><span class="line"><span class="meta">@TargetApi(Build.VERSION_CODES.LOLLIPOP)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceivedClientCertRequest</span><span class="params">(WebView view, ClientCertRequest request)</span> &#123;</span><br><span class="line">    request.cancel();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理HTTP认证请求，默认行为是取消请求</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceivedHttpAuthRequest</span><span class="params">(WebView view, HttpAuthHandler handler, String host, String realm)</span> &#123;</span><br><span class="line">    handler.cancel();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通知应用有个已授权账号自动登陆了</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceivedLoginRequest</span><span class="params">(WebView view, String realm, String account, String args)</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 给应用一个机会处理按键事件</span></span><br><span class="line"><span class="comment">// 如果返回true，WebView不处理该事件，否则WebView会一直处理，默认返回false</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideKeyEvent</span><span class="params">(WebView view, KeyEvent event)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理未被WebView消费的按键事件</span></span><br><span class="line"><span class="comment">// WebView总是消费按键事件，除非是系统按键或shouldOverrideKeyEvent返回true</span></span><br><span class="line"><span class="comment">// 此方法在按键事件分派时被异步调用</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onUnhandledKeyEvent</span><span class="params">(WebView view, KeyEvent event)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onUnhandledKeyEvent(view, event);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通知应用页面缩放系数变化</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onScaleChanged</span><span class="params">(WebView view, <span class="type">float</span> oldScale, <span class="type">float</span> newScale)</span> &#123;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p><strong>WebChromeClient</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获得所有访问历史项目的列表，用于链接着色。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getVisitedHistory</span><span class="params">(ValueCallback&lt;String[]&gt; callback)</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt;video /&gt; 控件在未播放时，会展示为一张海报图，HTML中可通过它的&#x27;poster&#x27;属性来指定。</span></span><br><span class="line"><span class="comment">// 如果未指定&#x27;poster&#x27;属性，则通过此方法提供一个默认的海报图。</span></span><br><span class="line"><span class="keyword">public</span> Bitmap <span class="title function_">getDefaultVideoPoster</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当全屏的视频正在缓冲时，此方法返回一个占位视图(比如旋转的菊花)。</span></span><br><span class="line"><span class="keyword">public</span> View <span class="title function_">getVideoLoadingProgressView</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收当前页面的加载进度</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onProgressChanged</span><span class="params">(WebView view, <span class="type">int</span> newProgress)</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收文档标题</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceivedTitle</span><span class="params">(WebView view, String title)</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收图标(favicon)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceivedIcon</span><span class="params">(WebView view, Bitmap icon)</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Android中处理Touch Icon的方案</span></span><br><span class="line"><span class="comment">// http://droidyue.com/blog/2015/01/18/deal-with-touch-icon-in-android/index.html</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceivedTouchIconUrl</span><span class="params">(WebView view, String url, <span class="type">boolean</span> precomposed)</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通知应用当前页进入了全屏模式，此时应用必须显示一个包含网页内容的自定义View</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onShowCustomView</span><span class="params">(View view, CustomViewCallback callback)</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通知应用当前页退出了全屏模式，此时应用必须隐藏之前显示的自定义View</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onHideCustomView</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示一个alert对话框</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onJsAlert</span><span class="params">(WebView view, String url, String message, JsResult result)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示一个confirm对话框</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onJsConfirm</span><span class="params">(WebView view, String url, String message, JsResult result)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示一个prompt对话框</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onJsPrompt</span><span class="params">(WebView view, String url, String message, String defaultValue, JsPromptResult result)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示一个对话框让用户选择是否离开当前页面</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onJsBeforeUnload</span><span class="params">(WebView view, String url, String message, JsResult result)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 指定源的网页内容在没有设置权限状态下尝试使用地理位置API。</span></span><br><span class="line"><span class="comment">// 从API24开始，此方法只为安全的源(https)调用，非安全的源会被自动拒绝</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onGeolocationPermissionsShowPrompt</span><span class="params">(String origin, GeolocationPermissions.Callback callback)</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当前一个调用 onGeolocationPermissionsShowPrompt() 取消时，隐藏相关的UI。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onGeolocationPermissionsHidePrompt</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通知应用打开新窗口</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onCreateWindow</span><span class="params">(WebView view, <span class="type">boolean</span> isDialog, <span class="type">boolean</span> isUserGesture, Message resultMsg)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通知应用关闭窗口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCloseWindow</span><span class="params">(WebView window)</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 请求获取取焦点</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onRequestFocus</span><span class="params">(WebView view)</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通知应用网页内容申请访问指定资源的权限(该权限未被授权或拒绝)</span></span><br><span class="line"><span class="meta">@TargetApi(Build.VERSION_CODES.LOLLIPOP)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPermissionRequest</span><span class="params">(PermissionRequest request)</span> &#123;</span><br><span class="line">    request.deny();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通知应用权限的申请被取消，隐藏相关的UI。</span></span><br><span class="line"><span class="meta">@TargetApi(Build.VERSION_CODES.LOLLIPOP)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPermissionRequestCanceled</span><span class="params">(PermissionRequest request)</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为&#x27;&lt;input type=&quot;file&quot; /&gt;&#x27;显示文件选择器，返回false使用默认处理</span></span><br><span class="line"><span class="meta">@TargetApi(Build.VERSION_CODES.LOLLIPOP)</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onShowFileChooser</span><span class="params">(WebView webView, ValueCallback&lt;Uri[]&gt; filePathCallback, FileChooserParams fileChooserParams)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收JavaScript控制台消息</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onConsoleMessage</span><span class="params">(ConsoleMessage consoleMessage)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Webview-加载优化"><a href="#Webview-加载优化" class="headerlink" title="Webview 加载优化"></a>Webview 加载优化</h2><ul>
<li>使用本地资源替代</li>
</ul>
<p>可以 将一些资源文件放在本地的 asset s目录, 然后重 写WebViewClient 的 <code>shouldInterceptRequest</code> 方法，对访问地址进行拦截，当 url 地址命中本地配置的url时，使用本地资源替代，否则就使用网络上的资源。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">mWebview.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>() &#123;   </span><br><span class="line">     <span class="comment">// 设置不用系统浏览器打开,</span></span><br><span class="line">    <span class="meta">@Override</span>    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> &#123;      </span><br><span class="line">        view.loadUrl(url);     </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;    </span><br><span class="line">    &#125;   </span><br><span class="line">         </span><br><span class="line">    <span class="meta">@Override</span>    </span><br><span class="line">    <span class="keyword">public</span> WebResourceResponse <span class="title function_">shouldInterceptRequest</span><span class="params">(WebView view, String url)</span> &#123;      <span class="comment">// 如果命中本地资源, 使用本地资源替代      </span></span><br><span class="line">        <span class="keyword">if</span> (mDataHelper.hasLocalResource(url))&#123;         </span><br><span class="line">             <span class="type">WebResourceResponse</span> <span class="variable">response</span> <span class="operator">=</span> mDataHelper.getReplacedWebResourceResponse(getApplicationContext(), url);          </span><br><span class="line">            <span class="keyword">if</span> (response != <span class="literal">null</span>) &#123;              </span><br><span class="line">                <span class="keyword">return</span> response;</span><br><span class="line">            &#125;      </span><br><span class="line">        &#125;      </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.shouldInterceptRequest(view, url);    </span><br><span class="line">    &#125;   </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@TargetApi(VERSION_CODES.LOLLIPOP)</span><span class="meta">@Override</span>    </span><br><span class="line">    <span class="keyword">public</span> WebResourceResponse <span class="title function_">shouldInterceptRequest</span><span class="params">(WebView view,WebResourceRequest request)</span> &#123;      </span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> request.getUrl().toString();      </span><br><span class="line">        <span class="keyword">if</span> (mDataHelper.hasLocalResource(url)) &#123;         </span><br><span class="line">            <span class="type">WebResourceResponse</span> <span class="variable">response</span> <span class="operator">=</span>  mDataHelper.getReplacedWebResourceResponse(getApplicationContext(), url);          </span><br><span class="line">            <span class="keyword">if</span> (response != <span class="literal">null</span>) &#123;              </span><br><span class="line">                <span class="keyword">return</span> response;          </span><br><span class="line">            &#125;      </span><br><span class="line">        &#125;      </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.shouldInterceptRequest(view, request);    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;); </span><br></pre></td></tr></table></figure>

<ul>
<li><p>WebView初始化慢，可以在初始化同时先请求数据，让后端和网络不要闲着。</p>
</li>
<li><p>后端处理慢，可以让服务器分trunk输出，在后端计算的同时前端也加载网络静态资源。</p>
</li>
<li><p>脚本执行慢，就让脚本在最后运行，不阻塞页面解析。</p>
</li>
<li><p>同时，合理的预加载、预缓存可以让加载速度的瓶颈更小。</p>
</li>
<li><p>WebView初始化慢，就随时初始化好一个WebView待用。</p>
</li>
<li><p>DNS和链接慢，想办法复用客户端使用的域名和链接。</p>
</li>
<li><p>脚本执行慢，可以把框架代码拆分出来，在请求页面之前就执行好。</p>
</li>
</ul>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2017/9a2f8beb.png"></p>
<h2 id="内存泄漏"><a href="#内存泄漏" class="headerlink" title="内存泄漏"></a>内存泄漏</h2><h2 id="与JS交互"><a href="#与JS交互" class="headerlink" title="与JS交互"></a>与JS交互</h2><h3 id="JS调用原生"><a href="#JS调用原生" class="headerlink" title="JS调用原生"></a>JS调用原生</h3><h3 id="原生操作JS"><a href="#原生操作JS" class="headerlink" title="原生操作JS"></a>原生操作JS</h3><h2 id="加日志"><a href="#加日志" class="headerlink" title="加日志"></a>加日志</h2><ol>
<li><p>setWebChromeClient中添加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onConsoleMessage</span><span class="params">(ConsoleMessage consoleMessage)</span> &#123;</span><br><span class="line">    DebugLog.log(<span class="string">&quot;onConsoleMessage:&quot;</span>+ consoleMessage.message());</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.onConsoleMessage(consoleMessage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>setWebViewClient中添加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceivedError</span><span class="params">(WebView view, WebResourceRequest request, WebResourceError error)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onReceivedError(view, request, error);</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) &#123;</span><br><span class="line">        DebugLog.log(<span class="string">&quot;onReceivedError:&quot;</span></span><br><span class="line">                     + request.getUrl().toString() + <span class="string">&quot; &quot;</span></span><br><span class="line">                     + error.getErrorCode() + <span class="string">&quot; &quot;</span></span><br><span class="line">                     + error.getDescription().toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="WebView缓存"><a href="#WebView缓存" class="headerlink" title="WebView缓存"></a>WebView缓存</h1><p>Android WebView自带的缓存机制有5种：</p>
<ol>
<li>浏览器 缓存机制</li>
<li>Application Cache缓存机制</li>
<li>Dom Storage缓存机制</li>
<li>Web SQL Database缓存机制</li>
<li>Indexed Database缓存机制</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Ever69/article/details/104479626">https://blog.csdn.net/Ever69/article/details/104479626</a></p>
<h2 id="浏览器-缓存机制"><a href="#浏览器-缓存机制" class="headerlink" title="浏览器 缓存机制"></a>浏览器 缓存机制</h2><p>根据HTTP协议头里的Cache-Control（或Expires）和Last-Modified（或Etag）等字段来控制文件缓存的机制。</p>
<p>Cache-Control：用于控制文件在本地缓存有效时长</p>
<blockquote>
<p>HTTP1.1中新加的字段。如服务器回包：Cache-Control:max-age&#x3D;600，表示该文件在本地缓存的有效时长是600秒</p>
</blockquote>
<p>Expires：与Cache-Control功能相同，即控制缓存的有效时间</p>
<blockquote>
<p>HTTP1.0标准中的字段，若和Cache-Control同时出现，则后者优先级更高。</p>
</blockquote>
<p>Last-Modified：标识文件在服务器上的最新更新时间</p>
<blockquote>
<p>下次请求，如果文件缓存过期，浏览器会通过 <code>if-Modified-Since</code>这个字段带上这个时间发给服务器，由服务器判断文件是否有修改。若没有修改，服务器返回304告诉浏览器继续使用缓存；若有修改，则返回200同时返回最新的文件</p>
</blockquote>
<p>Etag：功能同 Last-Modified，即标识文件在服务器上的最新更新时间。</p>
<p>不同的是，Etag的取值是一个对文件进行标识的特征字串。</p>
<blockquote>
<p>在向服务器查询文件是否有更新时，浏览器通过 <code>If-None-Match</code> 字段把特征字串发送给服务器，由服务器判断文件是否有更新。若没有更新回包304，若有更新回包200</p>
</blockquote>
<p>注意：Etag和Last-Modified同时使用时，只要满足其中一个条件，就认为文件没有更新。</p>
<p>常见用法：</p>
<ol>
<li>Cache-Control和Last-Modified一起使用；</li>
<li>Expires和Etag一起使用；</li>
</ol>
<h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><p>优点：支持Http协议层</p>
<p>不足：缓存文件需要首次加载后才产生；浏览器缓存的存储空间有限，缓存有被清除的可能；缓存的文件没有校验。对于上述问题可以参考手Q的离线包。</p>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><p>静态资源文件的存储，如<code>JS</code>、<code>CSS</code>、字体、图片等。</p>
<p>Android WebView会将缓存的文件记录及文件内容存在当前app的data目录中</p>
<h3 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h3><p>Android WebView内置自动实现</p>
<h2 id="Application-Cache缓存机制"><a href="#Application-Cache缓存机制" class="headerlink" title="Application Cache缓存机制"></a>Application Cache缓存机制</h2><p>已文件为单位进行缓存，且文件有一定更新机制（类似于浏览器缓存机制）</p>
<p>APPCache原理有两个关键点：manifest属性和manifest文件。</p>
<p>HTML在头中通过 manifest 属性 引用 manifest 文件。</p>
<p>manifest文件：就是以 appcache 结尾的一个普通文件</p>
<h3 id="特点-1"><a href="#特点-1" class="headerlink" title="特点"></a>特点</h3><p>方便构建Web App的缓存，专门为Web App离线使用而开发的缓存机制，AppCache是对浏览器缓存机制的补充。</p>
<h3 id="应用场景-1"><a href="#应用场景-1" class="headerlink" title="应用场景"></a>应用场景</h3><p>存储静态文件（如JS、CSS、字体文件等）</p>
<h3 id="具体实现-1"><a href="#具体实现-1" class="headerlink" title="具体实现"></a>具体实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过设置WebView的settings来实现</span></span><br><span class="line"><span class="type">WebSettings</span> <span class="variable">settings</span> <span class="operator">=</span> getSettings();</span><br><span class="line"><span class="type">String</span> <span class="variable">cacheDirPath</span> <span class="operator">=</span> context.getFilesDir().getAbsolutePath()+<span class="string">&quot;cache/&quot;</span>;</span><br><span class="line"><span class="comment">// 1. 设置缓存路径</span></span><br><span class="line">settings.setAppCachePath(cacheDirPath);</span><br><span class="line"><span class="comment">// 2. 设置缓存大小</span></span><br><span class="line">settings.setAppCacheMaxSize(<span class="number">20</span>*<span class="number">1024</span>*<span class="number">1024</span>);</span><br><span class="line"><span class="comment">// 3. 开启Application Cache存储机制</span></span><br><span class="line">settings.setAppCacheEnabled(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：每个Application只调用一次<code>WebSettings.setAppCachePath()</code>和<code>WebSettings.setAppCacheMaxSize()</code></p>
</blockquote>
<h2 id="Dom-Storage缓存机制"><a href="#Dom-Storage缓存机制" class="headerlink" title="Dom Storage缓存机制"></a>Dom Storage缓存机制</h2><p>通过存储字符串的 Key-Value 来提供</p>
<p>Dom Storage分为 sessionStorage 和 localStorage；二者使用方法基本相同，区别在于作用范围不同</p>
<ol>
<li>sessionStorage：具备临时性，即存储与页面相关的数据，在页面关闭后无法使用</li>
<li>localStorage：具备持久性，即 保存的数据在页面关闭后仍可使用</li>
</ol>
<h3 id="特点-2"><a href="#特点-2" class="headerlink" title="特点"></a>特点</h3><ul>
<li>存储空间大（5MB）：存储空间对于不同浏览器不同，如Cookies才4KB</li>
<li>存储安全、便捷：Dom Storage存储的数据在本地，不需要经常和服务器进行交互</li>
<li>不像Cookies每次请求一次页面，都会向服务器发送网络请求</li>
</ul>
<h3 id="应用场景-2"><a href="#应用场景-2" class="headerlink" title="应用场景"></a>应用场景</h3><ul>
<li>存储临时、简单的数据</li>
<li>代替将不需要让服务器知道的信息的存储到cookies这种传统方法</li>
<li>Dom Storage机制类似于 Android 的 SharedPreference 机制</li>
</ul>
<h3 id="具体实现-2"><a href="#具体实现-2" class="headerlink" title="具体实现"></a>具体实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过设置 `WebView`的`Settings`类实现</span></span><br><span class="line"><span class="type">WebSettings</span> <span class="variable">settings</span> <span class="operator">=</span> getSettings();</span><br><span class="line"><span class="comment">// 开启DOM storage</span></span><br><span class="line">settings.setDomStorageEnabled(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>



<h2 id="Web-SQL-Database缓存机制"><a href="#Web-SQL-Database缓存机制" class="headerlink" title="Web SQL Database缓存机制"></a><del>Web SQL Database缓存机制</del></h2><p>基于 SQL 的数据库存储机制</p>
<h3 id="特点-3"><a href="#特点-3" class="headerlink" title="特点"></a>特点</h3><p>充分利用数据库的优势，可方便对数据进行增删查改</p>
<h3 id="应用场景-3"><a href="#应用场景-3" class="headerlink" title="应用场景"></a>应用场景</h3><p>存储适合数据库的结构化数据</p>
<h3 id="具体实现-3"><a href="#具体实现-3" class="headerlink" title="具体实现"></a>具体实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过设置WebView的settings实现</span></span><br><span class="line"><span class="type">WebSettings</span> <span class="variable">settings</span> <span class="operator">=</span> getSettings();</span><br><span class="line"><span class="type">String</span> <span class="variable">cacheDirPath</span> <span class="operator">=</span> context.getFilesDir().getAbsolutePath()+<span class="string">&quot;cache/&quot;</span>;</span><br><span class="line"><span class="comment">// 设置缓存路径</span></span><br><span class="line">settings.setDatabasePath(cacheDirPath);</span><br><span class="line"><span class="comment">// 开启 数据库存储机制</span></span><br><span class="line">settings.setDatabaseEnabled(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>官方说明，Web SQL Database存储机制不再推荐使用（不再维护），取而代之的是 IndexedDB 缓存机制</p>
</blockquote>
<h2 id="Indexed-Database缓存机制"><a href="#Indexed-Database缓存机制" class="headerlink" title="Indexed Database缓存机制"></a>Indexed Database缓存机制</h2><p>数据 NoSQL 数据库，通过存储字符串 key-value 对来提供。</p>
<p>类似于 Dom Storage 存储机制的 key-value  存储方式</p>
<h3 id="特点-4"><a href="#特点-4" class="headerlink" title="特点"></a>特点</h3><ul>
<li>功能强大、使用简单 ，通过数据的事务机制进行数据操作，可对对象任何熟悉生成索引，方便查询；</li>
<li>存储空间大，默认 250MB，比Dom Storage大很多；</li>
<li>使用灵活，以 key-value 方式存取对象，可以使任何类型值或对象，包括二进制</li>
<li>异步API调用，避免造成等待而影响体验</li>
</ul>
<h3 id="应用场景-4"><a href="#应用场景-4" class="headerlink" title="应用场景"></a>应用场景</h3><p>存储复杂、数据量大的结构化数据</p>
<h3 id="具体实现-4"><a href="#具体实现-4" class="headerlink" title="具体实现"></a>具体实现</h3><p>通过设置WebView的settings实现，只需设置支持JS就自动打开IndexedDB存储机制，Android在4.4开始加入对 IndexedDB 的支持，只需打开允许 JS 执行的开关就好</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebSettings</span> <span class="variable">settings</span> <span class="operator">=</span> getSettings();</span><br><span class="line">settings.setJavaScriptEnabled(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<h2 id="File-System"><a href="#File-System" class="headerlink" title="File System"></a>File System</h2><p>为H5页面的数据提供一个虚拟的文件系统</p>
<h3 id="特点-5"><a href="#特点-5" class="headerlink" title="特点"></a>特点</h3><p>可存储数据体积较大的二进制数据，可预加载资源文件，可直接编辑文件</p>
<h3 id="应用场景-5"><a href="#应用场景-5" class="headerlink" title="应用场景"></a>应用场景</h3><p>通过文件系统，管理数据</p>
<h3 id="具体使用"><a href="#具体使用" class="headerlink" title="具体使用"></a>具体使用</h3><p>由于 File System 是H5 新加入的缓存机制，所以 Android We吧View 暂不支持</p>
<p><img src="https://img-blog.csdnimg.cn/20200224172427258.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0V2ZXI2OQ==,size_16,color_FFFFFF,t_70" alt="缓存机制汇总"></p>
<h1 id="WebView对比与使用"><a href="#WebView对比与使用" class="headerlink" title="WebView对比与使用"></a>WebView对比与使用</h1><table>
<thead>
<tr>
<th></th>
<th>WebView</th>
<th>腾讯X5内核</th>
<th>JsBridge</th>
<th>AgentWeb</th>
<th>UC内核</th>
<th>SuperWeb</th>
<th>DSBridge-Android</th>
</tr>
</thead>
<tbody><tr>
<td>地址</td>
<td></td>
<td></td>
<td><a target="_blank" rel="noopener" href="https://github.com/lzyzsd/JsBridge">https://github.com/lzyzsd/JsBridge</a></td>
<td><a target="_blank" rel="noopener" href="https://github.com/Justson/AgentWeb">https://github.com/Justson/AgentWeb</a></td>
<td></td>
<td><a target="_blank" rel="noopener" href="https://github.com/Victory-Over/SuperWeb">https://github.com/Victory-Over/SuperWeb</a></td>
<td><a target="_blank" rel="noopener" href="https://github.com/wendux/DSBridge-Android">https://github.com/wendux/DSBridge-Android</a></td>
</tr>
<tr>
<td>说明</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>基于腾讯X5内核</td>
<td>侧重js与原生app交互，写法类似JSBridge</td>
</tr>
<tr>
<td>大小</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>占内存大小</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>加载速度</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>无网是否支持缓存</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>是否可定制窗口大小</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>进度条和自定义进度条</td>
<td>有进度条</td>
<td></td>
<td></td>
<td>支持进度条和自定义进度条</td>
<td></td>
<td>支持进度条</td>
<td></td>
</tr>
<tr>
<td>进度条显隐是否页面抖动</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>支持原生交互</td>
<td></td>
<td></td>
<td></td>
<td>true</td>
<td></td>
<td>true</td>
<td></td>
</tr>
<tr>
<td>Easy of use</td>
<td>麻烦</td>
<td></td>
<td></td>
<td>简洁</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>支持文件浏览</td>
<td>false</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>true</td>
<td></td>
</tr>
<tr>
<td>支持文件下载</td>
<td>false</td>
<td></td>
<td></td>
<td>true</td>
<td></td>
<td>true</td>
<td></td>
</tr>
<tr>
<td>支持文件下载断点续传</td>
<td></td>
<td></td>
<td></td>
<td>true</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>支持下载通知形式提示进度</td>
<td></td>
<td></td>
<td></td>
<td>true</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>支持文件上传</td>
<td>false</td>
<td></td>
<td></td>
<td>true</td>
<td></td>
<td>true</td>
<td></td>
</tr>
<tr>
<td>加强web安全</td>
<td></td>
<td></td>
<td></td>
<td>true</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>全屏播放视频</td>
<td>不支持</td>
<td></td>
<td></td>
<td>true</td>
<td></td>
<td>true</td>
<td></td>
</tr>
<tr>
<td>兼容低版本Js安全通信</td>
<td></td>
<td></td>
<td></td>
<td>true</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>支持调起微信支付</td>
<td></td>
<td></td>
<td></td>
<td>true</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>支持调起支付宝</td>
<td></td>
<td></td>
<td></td>
<td>true</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>支持传入WebLayout（下拉回弹效果）</td>
<td></td>
<td></td>
<td></td>
<td>true</td>
<td></td>
<td>true</td>
<td></td>
</tr>
<tr>
<td>支持定位</td>
<td></td>
<td></td>
<td></td>
<td>true</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>支持自定义WebView</td>
<td></td>
<td></td>
<td></td>
<td>true</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>支持Js通信</td>
<td>true</td>
<td></td>
<td></td>
<td>更简洁</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>支持JsBridge</td>
<td></td>
<td></td>
<td></td>
<td>true</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>是否线程安全</td>
<td>false</td>
<td></td>
<td></td>
<td>true</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>star数</td>
<td></td>
<td></td>
<td>8.4k</td>
<td>8k</td>
<td></td>
<td>835</td>
<td>3k</td>
</tr>
<tr>
<td>本地html字体大小适配</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>大厂使用</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<blockquote>
<p>如果更喜欢腾讯X5内核，可用<a target="_blank" rel="noopener" href="https://github.com/Justson/AgentWebX5">AgentWebX5</a>，该库3年前作者已通知已不再维护</p>
<p>AgentWeb、SuperWeb上一次在两三年前维护</p>
</blockquote>
<h2 id="腾讯X5内核使用"><a href="#腾讯X5内核使用" class="headerlink" title="腾讯X5内核使用"></a>腾讯X5内核使用</h2><p><strong>配置</strong></p>
<ol>
<li><code>build.gradle</code>添加依赖。添加<code>ndk</code>配置</li>
</ol>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">android&#123;</span><br><span class="line">    defaultConfig&#123;</span><br><span class="line">        ndk&#123;</span><br><span class="line">            abiFilters “armeabi”, “armeabi-v7a”, “x86”, “mips”</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123; </span><br><span class="line">    api <span class="string">&#x27;com.tencent.tbs.tbssdk:sdk:43903’</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>自行导入os文件（需要从<a target="_blank" rel="noopener" href="https://x5.tencent.com/">官网</a>下载sdk文件）</p>
<p>sdk接入示例，复制整个jniLibs到自己的项目中（放在与java、res同一级）</p>
</li>
<li><p>AndroidManifest.xml文件中加入</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.ACCESS_NETWORK_STATE&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.ACCESS_WIFI_STATE&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.READ_PHONE_STATE&quot;</span> /&gt;</span>  </span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>使用</strong></p>
<ol>
<li><p>初始化<code>X5WebView</code>，下面方法复制可直接调用，记得在加载WebView之前调用，所以最好是放在打开项目的时候就调用该方法，提前加载X5替换webview配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**************腾讯X5webview**************/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initX5WebView</span><span class="params">()</span> &#123;  <span class="comment">//使用腾讯x5 webview，解决安卓原生wenview不适配不同机型问题</span></span><br><span class="line">    <span class="comment">//搜集本地tbs内核信息并上报服务器，服务器返回结果决定使用哪个内核。</span></span><br><span class="line">    QbSdk.<span class="type">PreInitCallback</span> <span class="variable">cb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QbSdk</span>.PreInitCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onViewInitFinished</span><span class="params">(<span class="type">boolean</span> arg0)</span> &#123;</span><br><span class="line">            <span class="comment">//x5內核初始化完成的回调，为true表示x5内核加载成功，否则表示x5内核加载失败，会自动切换到系统内核。</span></span><br><span class="line">            <span class="keyword">if</span>(arg0)&#123;<span class="comment">//true</span></span><br><span class="line">                Log.e(<span class="string">&quot;腾讯X5&quot;</span>, <span class="string">&quot; onViewInitFinished 加载 成功 &quot;</span>+arg0);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                Log.e(<span class="string">&quot;腾讯X5&quot;</span>, <span class="string">&quot; onViewInitFinished 加载 失败！！！使用原生安卓webview &quot;</span>+arg0);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCoreInitFinished</span><span class="params">()</span> &#123;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//x5内核初始化接口</span></span><br><span class="line">    QbSdk.initX5Environment(getApplicationContext(),  cb);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**************腾讯X5webview**************/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>替换xml中<code>webview</code>布局为<code>com.tencent.smtt.sdk.WebView</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">com.tencent.smtt.sdk.WebView</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:id</span>=<span class="string">&quot;@+id/TX_X5_webview&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">com.tencent.smtt.sdk.WebView</span>&gt;</span></span><br><span class="line">   </span><br><span class="line">//  <span class="tag">&lt;<span class="name">WebView</span></span></span><br><span class="line"><span class="tag">//      <span class="attr">android:id</span>=<span class="string">&quot;@+id/nromal_webview&quot;</span></span></span><br><span class="line"><span class="tag">//      <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">//      <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span>&gt;</span></span><br><span class="line">//  <span class="tag">&lt;/<span class="name">WebView</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>java中使用 X5 webview</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">com.tencent.smtt.sdk.WebView TX_X5_webView;<span class="comment">//全局变量</span></span><br><span class="line">TX_X5_webView = findViewById(R.id.TX_X5_webView);</span><br><span class="line">TX_X5_webView.setBackgroundColor(<span class="number">0</span>);</span><br><span class="line">TX_X5_webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">TX_X5_webView.loadUrl(<span class="string">&quot;https://www.baidu.com/&quot;</span>)</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="使用腾讯X5内核的一些坑"><a href="#使用腾讯X5内核的一些坑" class="headerlink" title="使用腾讯X5内核的一些坑"></a>使用腾讯X5内核的一些坑</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ruiruiddd/article/details/107063988">onViewInitFinished回调一直是false</a></p>
<ol>
<li><p>初始化腾讯内核在加载webview之后</p>
</li>
<li><p>AndroidManifest配置权限少了</p>
</li>
<li><p>缺少os文件</p>
</li>
<li><p>本地运行没问题，打包出来运行加载X5失败，查看日志发现<code>NoClassDefFoundError:com.tencent.smtt.export.extern</code>错误，需要加混淆配置</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">-dontwarn dalvik.**</span></span><br><span class="line"><span class="deletion">-dontwarn com.tencent.smtt.**</span></span><br><span class="line"><span class="deletion">-keep class com.tencent.** &#123;</span></span><br><span class="line">*;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>网络清单配置没有对tbs开放权限，所以网络请求初始化加载X5被阻止了，因为腾讯都是https请求。安卓7.0版本以上需要配置网络清单</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">includeSubdomains</span>=<span class="string">&quot;true&quot;</span>&gt;</span>android.bugly.qq.com<span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">includeSubdomains</span>=<span class="string">&quot;true&quot;</span>&gt;</span>cfg.imtt.qq.com<span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">includeSubdomains</span>=<span class="string">&quot;true&quot;</span>&gt;</span>tbs.imtt.qq.com<span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">includeSubdomains</span>=<span class="string">&quot;true&quot;</span>&gt;</span>x5.tencent.com<span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>将关于腾讯的域名添加到网络清单配置中即可</p>
<p><code>res</code>下新建<code>xml</code>文件夹，文件夹下新建<code>nextwork_security_config.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">network-security-config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">domain-config</span> <span class="attr">cleartextTrafficPermitted</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">domain</span> <span class="attr">includeSubdomains</span>=<span class="string">&quot;true&quot;</span>&gt;</span>android.bugly.qq.com<span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">domain</span> <span class="attr">includeSubdomains</span>=<span class="string">&quot;true&quot;</span>&gt;</span>cfg.imtt.qq.com<span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">domain</span> <span class="attr">includeSubdomains</span>=<span class="string">&quot;true&quot;</span>&gt;</span>tbs.imtt.qq.com<span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">domain</span> <span class="attr">includeSubdomains</span>=<span class="string">&quot;true&quot;</span>&gt;</span>x5.tencent.com<span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">domain-config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">network-security-config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在项目的清单文件<code>AndroidManifest.xml</code>的<code>&lt;application</code>中添加</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:networkSecurityConfig=&quot;@xml/network_security_config&quot;</span><br></pre></td></tr></table></figure>



<p>另，可以在测试的时候用省事的写法，把<code>nextwork_security_config.xml</code>内容写为以下（正式的不要这么写，不安全）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">network-security-config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">base-config</span> <span class="attr">cleartextTrafficPermitted</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">network-security-config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>其中还可以加其他参数</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">base-config</span> <span class="attr">cleartextTrafficPermitted</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">trust-anchors</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">certificates</span> <span class="attr">src</span>=<span class="string">&quot;system&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">certificates</span> <span class="attr">src</span>=<span class="string">&quot;user&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">trust-anchors</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">base-config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>system 设备中预装的系统证书</p>
<p>user 用户自装证书</p>
<p>resourceID &#x2F;raw文件下的证书</p>
</blockquote>
</li>
<li><p>使用了以下写法，需去除</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.*;</span><br><span class="line"><span class="keyword">import</span> android.webkit.*;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebStorage.*;</span><br><span class="line"><span class="keyword">import</span> android.net.*;</span><br><span class="line"><span class="keyword">import</span> android.net.http.*;</span><br></pre></td></tr></table></figure>
</li>
<li><p>回调是false，但是加载显示webview内容没问题，那可能是版本过低导致X5自动切回了原生webview</p>
</li>
</ol>
<h2 id="JsBridge使用"><a href="#JsBridge使用" class="headerlink" title="JsBridge使用"></a>JsBridge使用</h2><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/910e058a1d63">JsBridge原理与使用</a></p>
<ol>
<li><p>添加依赖</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">repositories</span> &#123;  </span><br><span class="line">   maven &#123;url <span class="string">&quot;https://jitpack.io&quot;</span>&#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">dependencies</span> &#123;  </span><br><span class="line">   <span class="keyword">compile</span> <span class="string">&#x27;com.github.lzyzsd:jsbridge:1.0.4&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者下载源码拷贝到自己的工程内当类库</p>
</li>
<li><p>提供给JS调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">webView.registerHandler(<span class="string">&quot;submitFromWeb&quot;</span>, <span class="keyword">new</span> <span class="title class_">BridgeHandler</span>()&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handler</span><span class="params">(String data, CallBackFunction function)</span>&#123;</span><br><span class="line">        function.onCallBack(<span class="string">&quot;submitFrom web exe, response data from java&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Js调用Java提供的方法【值要写“submitFromWeb”，这个是Java定的】</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">WebViewJavascriptBridge</span>.<span class="title function_">callHandler</span>(</span><br><span class="line">    <span class="string">&#x27;submitFromWeb&#x27;</span>,</span><br><span class="line">    &#123;<span class="string">&#x27;param&#x27;</span>:str1&#125;,</span><br><span class="line">    <span class="keyword">function</span>(<span class="params">responseData</span>)&#123;</span><br><span class="line">        <span class="comment">//这里打印的应该是上面Handler实现方法中的callback的入参：submitFrom web exe, response data from java</span></span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;show&quot;</span>).<span class="property">innerHTML</span> = <span class="string">&quot;response data from java, data = &quot;</span>+responseData</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>还有一种简单的没有回调的调用方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Java中提供的方法</span></span><br><span class="line">webView.setDefaultHandler(<span class="keyword">new</span> <span class="title class_">DefaultHandler</span>());</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Js中的调用方式</span></span><br><span class="line"><span class="title class_">WebViewJavascriptBridge</span>.<span class="title function_">send</span>(</span><br><span class="line">    data,</span><br><span class="line">    <span class="keyword">function</span>(<span class="params">responseData</span>)&#123;</span><br><span class="line">        <span class="comment">//java中DefaultHandler所实现的方法中callback所定义的入参</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
<li><p>提供给Java调用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Js中定义方法</span></span><br><span class="line"><span class="title class_">WebViewJavascriptBridge</span>.<span class="title function_">registerHandler</span>(<span class="string">&quot;functionInJs&quot;</span>, <span class="keyword">function</span>(<span class="params">data, responseCallback</span>) &#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;show&quot;</span>).<span class="property">innerHTML</span> = (<span class="string">&quot;data from Java: = &quot;</span> + data);</span><br><span class="line">    <span class="keyword">var</span> responseData = <span class="string">&quot;Javascript Says Right back aka!&quot;</span>;</span><br><span class="line">    <span class="title function_">responseCallback</span>(responseData);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Java调用Handler，与Js的一样</span></span><br><span class="line">webView.callHandler(<span class="string">&quot;functionInJs&quot;</span>, <span class="keyword">new</span> <span class="title class_">Gson</span>().toJson(user),</span><br><span class="line">   <span class="keyword">new</span> <span class="title class_">CallBackFunction</span>()&#123;</span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCallBack</span><span class="params">(String data)</span>&#123;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>同样的，在Js中也可注册默认的Handler，以方便Java调用，通过send方法发送数据</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bridge.<span class="title function_">init</span>(<span class="keyword">function</span>(<span class="params">message, responseCallback</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;JS got a message&#x27;</span>, message);</span><br><span class="line">    <span class="keyword">var</span> data = &#123;</span><br><span class="line">        <span class="string">&#x27;Javascript Responds&#x27;</span>: <span class="string">&#x27;Wee!&#x27;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;JS responding with&#x27;</span>, data);</span><br><span class="line">    <span class="title function_">responseCallback</span>(data);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Java中调用send方法给js发送消息</span></span><br><span class="line">webView.send(<span class="string">&quot;hello&quot;</span>);</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="AgentWeb使用"><a href="#AgentWeb使用" class="headerlink" title="AgentWeb使用"></a>AgentWeb使用</h2><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/10155227f492">agentweb与自带webview比较</a></p>
<ol>
<li><p>添加依赖 build.gradle</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">&#x27;com.just.agentweb:agentweb:2.0.0&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>加载网页，以京东首页为例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mAgentWeb = AgentWeb.with(<span class="built_in">this</span>)<span class="comment">//传入Activity</span></span><br><span class="line">                .setAgentWebParent(mLinearLayout, <span class="keyword">new</span> <span class="title class_">LinearLayout</span>.LayoutParams(-<span class="number">1</span>, -<span class="number">1</span>))<span class="comment">//传入AgentWeb 的父控件 ，如果父控件为 RelativeLayout ， 那么第二参数需要传入 RelativeLayout.LayoutParams ,第一个参数和第二个参数应该对应。</span></span><br><span class="line">                .useDefaultIndicator()<span class="comment">// 使用默认进度条</span></span><br><span class="line">                .defaultProgressBarColor() <span class="comment">// 使用默认进度条颜色</span></span><br><span class="line">                .setReceivedTitleCallback(mCallback) <span class="comment">//设置 Web 页面的 title 回调</span></span><br><span class="line">                .createAgentWeb()<span class="comment">//</span></span><br><span class="line">                .ready()</span><br><span class="line">                .go(<span class="string">&quot;http://www.jd.com&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>不用配置 Setting ， 不用添加 WebChromeClient 就有进度条 。</p>
</li>
<li><p>安卓调用JavaScript方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Javascript 方法</span></span><br><span class="line">function <span class="title function_">callByAndroid</span><span class="params">()</span>&#123;</span><br><span class="line">      console.log(<span class="string">&quot;callByAndroid&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//Android 端</span></span><br><span class="line">mAgentWeb.getJsEntraceAccess().quickCallJs(<span class="string">&quot;callByAndroid&quot;</span>);</span><br><span class="line"><span class="comment">//结果</span></span><br><span class="line">consoleMessage:callByAndroid  lineNumber:<span class="number">27</span></span><br></pre></td></tr></table></figure>

<p>JavaScript调用安卓方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Android 端 ， AndroidInterface 是一个注入类 ，里面有一个无参数方法：callAndroid </span></span><br><span class="line">mAgentWeb.getJsInterfaceHolder().addJavaObject(<span class="string">&quot;android&quot;</span>,<span class="keyword">new</span> <span class="title class_">AndroidInterface</span>(mAgentWeb,<span class="built_in">this</span>)); </span><br><span class="line"><span class="comment">//在 Js 里就能通过 </span></span><br><span class="line">window.android.callAndroid() <span class="comment">//调用 Java 层的 AndroidInterface 类里 callAndroid 方法</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>跟随 Activity 或者 Fragment 生命周期 ， 释放 CPU和资源， 更省电</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onPause</span><span class="params">()</span> &#123;</span><br><span class="line">    mAgentWeb.getWebLifeCycle().onPause();</span><br><span class="line">    <span class="built_in">super</span>.onPause();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onResume</span><span class="params">()</span> &#123;</span><br><span class="line">    mAgentWeb.getWebLifeCycle().onResume();</span><br><span class="line">    <span class="built_in">super</span>.onResume();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="SuperWeb使用"><a href="#SuperWeb使用" class="headerlink" title="SuperWeb使用"></a>SuperWeb使用</h2><h1 id="Android和H5进行交互的模板代码"><a href="#Android和H5进行交互的模板代码" class="headerlink" title="Android和H5进行交互的模板代码"></a>Android和H5进行交互的模板代码</h1><span id="more"></span>

<h2 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h2><ol>
<li><p>构建用户交互的对象 <code>TestObject</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">TestObject</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WeakReference&lt;Activity&gt; wfActivity;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TestObject</span><span class="params">(Activity ac)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.wfActivity = <span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;&gt;(ac);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理html按钮触发事件</span></span><br><span class="line">    <span class="meta">@JavascriptInterface</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">login</span><span class="params">(String uid)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (wfActivity.get() != <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JavascriptInterface</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loginOut</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>WebView</code>设置<code>WebViewClient</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">mWebView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, WebResourceRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.shouldOverrideUrlLoading(view, request);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.shouldOverrideUrlLoading(view, url);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPageStarted</span><span class="params">(WebView view, String url, Bitmap favicon)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onPageStarted(view, url, favicon);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPageFinished</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">    	<span class="comment">//把数据传给html</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">UserInfo</span> <span class="variable">bean</span> <span class="operator">=</span> DataSourceManager.getUserInfoBen();</span><br><span class="line">        <span class="keyword">if</span> (bean != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> ACache.get(context).getAsString(Constants.TOKEN);</span><br><span class="line">            mWebView.evaluateJavascript(<span class="string">&quot;javascript:getUserInfo(&#x27;&quot;</span> + bean.user_id + <span class="string">&quot;&#x27;,&#x27;&quot;</span> + bean.avatar + <span class="string">&quot;&#x27;,&#x27;&quot;</span> + token + <span class="string">&quot;&#x27;)&quot;</span>, <span class="keyword">new</span> <span class="title class_">ValueC</span></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceiveValue</span><span class="params">(String value)</span> &#123;</span><br><span class="line">                    <span class="comment">//Log.e(&quot;123&quot;, &quot;onReceiveValue getUserInfo : &quot; + value);</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">super</span>.onPageFinished(view, url);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doUpdateVisitedHistory</span><span class="params">(WebView view, String url, <span class="type">boolean</span> isReload)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.doUpdateVisitedHistory(view, url, isReload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">mWebView.addJavascriptInterface(<span class="keyword">new</span> <span class="title class_">TestObject</span>(mMainActivity), <span class="string">&quot;testObject&quot;</span>);</span><br><span class="line">mWebView.loadUrl(<span class="string">&quot;https://xxx.net/xxx/xxx&quot;</span>);</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="Html"><a href="#Html" class="headerlink" title="Html"></a>Html</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;zh-cn&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">	<span class="comment">//h5接收移动端传过来的用户信息</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">getUserInfo</span>(<span class="params">uid,pwd,avatar</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">           <span class="keyword">return</span> <span class="string">&quot;用户信息:&quot;</span>+ uid+<span class="string">&quot;  &quot;</span>+pwd +<span class="string">&quot; &quot;</span>+avatar;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">	<span class="comment">//h5接收移动端退出动作</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">exitUser</span>(<span class="params">uid</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">           <span class="keyword">return</span> <span class="string">&quot;退出账号: &quot;</span>+ uid;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    </span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">bgcolor</span>=<span class="string">&quot;#BCBCBC&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;testObject.login(uid);&quot;</span>&gt;</span>h5把用户信息给移动端, </span><br><span class="line">        	移动端处理对应的 login 方法进行登录</span><br><span class="line">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;testObject.loginOut(uid);&quot;</span>&gt;</span>html用户退出操作, </span><br><span class="line">        	移动端处理 loginOut 方法<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>







<h1 id="WebView问题"><a href="#WebView问题" class="headerlink" title="WebView问题"></a>WebView问题</h1><h2 id="WebView不支持拨打电话"><a href="#WebView不支持拨打电话" class="headerlink" title="WebView不支持拨打电话"></a>WebView不支持拨打电话</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Web视图</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">webViewClient</span> <span class="keyword">extends</span> <span class="title class_">WebViewClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ShowWebActivity.<span class="built_in">this</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//调用拨号程序</span></span><br><span class="line">        <span class="keyword">if</span> (url.startsWith(<span class="string">&quot;mailto:&quot;</span>) || url.startsWith(<span class="string">&quot;geo:&quot;</span>) || url.startsWith(<span class="string">&quot;tel:&quot;</span>) || url.startsWith(<span class="string">&quot;smsto:&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_VIEW, Uri.parse(url));</span><br><span class="line">            startActivity(intent);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置Web视图</span></span><br><span class="line">webview.setWebViewClient(<span class="keyword">new</span> <span class="title class_">webViewClient</span>());</span><br></pre></td></tr></table></figure>

<h2 id="让WebView各Android版本正常播放"><a href="#让WebView各Android版本正常播放" class="headerlink" title="让WebView各Android版本正常播放"></a>让WebView各Android版本正常播放</h2><p><code>AndroidManifest.xml</code>中对应Activity添加硬件加速</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">...</span> <span class="attr">android:hardwareAccelerated</span>=<span class="string">&quot;true&quot;</span> &gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>这是针对单个Activity起作用。若要整个App起作用，那么要在application标签内添加。</p>
<p>也可在代码中动态添加：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">getWindow.setFlags(WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED,</span><br><span class="line">WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED);</span><br><span class="line">//一些<span class="keyword">View</span>不需要硬件加速，则加上</span><br><span class="line"><span class="keyword">view</span>.setLayerType(<span class="keyword">View</span>.LAYER_TYPE_SOFTWARE, <span class="keyword">null</span>);</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="WebView无法全屏播放"><a href="#WebView无法全屏播放" class="headerlink" title="WebView无法全屏播放"></a><a target="_blank" rel="noopener" href="https://www.cnblogs.com/renhui/p/5893593.html">WebView无法全屏播放</a></h2><p>在onShowCustomView方法中，将获取到的view放到当前Activity的最上方，在onHideCustomView中，将之前的view隐藏或者删除，将原来被覆盖的webview放回来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebVideoActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> WebView webView;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 视频全屏参数 */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> FrameLayout.<span class="type">LayoutParams</span> <span class="variable">COVER_SCREEN_PARAMS</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FrameLayout</span>.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT);</span><br><span class="line">    <span class="keyword">private</span> View customView;</span><br><span class="line">    <span class="keyword">private</span> FrameLayout fullscreenContainer;</span><br><span class="line">    <span class="keyword">private</span> WebChromeClient.CustomViewCallback customViewCallback;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle bundle)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(bundle);</span><br><span class="line">        setContentView(R.layout.activity_xx);</span><br><span class="line">        webView = (WebView) findViewById(R.id.xx);</span><br><span class="line">        initWebView();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onStop</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onStop();</span><br><span class="line">        webView.reload();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 展示网页界面 **/</span>　　<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initWebView</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">WebChromeClient</span> <span class="variable">wvcc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebChromeClient</span>();</span><br><span class="line">        <span class="type">WebSettings</span> <span class="variable">webSettings</span> <span class="operator">=</span> webView.getSettings();</span><br><span class="line">        webSettings.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">        webSettings.setUseWideViewPort(<span class="literal">true</span>); <span class="comment">// 关键点</span></span><br><span class="line">        webSettings.setLoadWithOverviewMode(<span class="literal">true</span>);</span><br><span class="line">        webSettings.setCacheMode(WebSettings.LOAD_NO_CACHE); <span class="comment">// 不加载缓存内容</span></span><br><span class="line"></span><br><span class="line">        webView.setWebChromeClient(wvcc);</span><br><span class="line">        <span class="type">WebViewClient</span> <span class="variable">wvc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebViewClient</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">                webView.loadUrl(url);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        webView.setWebViewClient(wvc);</span><br><span class="line"></span><br><span class="line">        webView.setWebChromeClient(<span class="keyword">new</span> <span class="title class_">WebChromeClient</span>() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*** 视频播放相关的方法 **/</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> View <span class="title function_">getVideoLoadingProgressView</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="type">FrameLayout</span> <span class="variable">frameLayout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FrameLayout</span>(WebVideoActivity.<span class="built_in">this</span>);</span><br><span class="line">                frameLayout.setLayoutParams(<span class="keyword">new</span> <span class="title class_">LayoutParams</span>(LayoutParams.MATCH_PARENT, LayoutParams.MATCH_PARENT));</span><br><span class="line">                <span class="keyword">return</span> frameLayout;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onShowCustomView</span><span class="params">(View view, CustomViewCallback callback)</span> &#123;</span><br><span class="line">                showCustomView(view, callback);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onHideCustomView</span><span class="params">()</span> &#123;</span><br><span class="line">                hideCustomView();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 加载Web地址</span></span><br><span class="line">        webView.loadUrl(webUrl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 视频播放全屏 **/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">showCustomView</span><span class="params">(View view, CustomViewCallback callback)</span> &#123;</span><br><span class="line">        <span class="comment">// if a view already exists then immediately terminate the new one</span></span><br><span class="line">        <span class="keyword">if</span> (customView != <span class="literal">null</span>) &#123;</span><br><span class="line">            callback.onCustomViewHidden();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        WebVideoActivity.<span class="built_in">this</span>.getWindow().getDecorView();</span><br><span class="line"></span><br><span class="line">        <span class="type">FrameLayout</span> <span class="variable">decor</span> <span class="operator">=</span> (FrameLayout) getWindow().getDecorView();</span><br><span class="line">        fullscreenContainer = <span class="keyword">new</span> <span class="title class_">FullscreenHolder</span>(WebVideoActivity.<span class="built_in">this</span>);</span><br><span class="line">        fullscreenContainer.addView(view, COVER_SCREEN_PARAMS);</span><br><span class="line">        decor.addView(fullscreenContainer, COVER_SCREEN_PARAMS);</span><br><span class="line">        customView = view;</span><br><span class="line">        setStatusBarVisibility(<span class="literal">false</span>);</span><br><span class="line">        customViewCallback = callback;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 隐藏视频全屏 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">hideCustomView</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (customView == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        setStatusBarVisibility(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">FrameLayout</span> <span class="variable">decor</span> <span class="operator">=</span> (FrameLayout) getWindow().getDecorView();</span><br><span class="line">        decor.removeView(fullscreenContainer);</span><br><span class="line">        fullscreenContainer = <span class="literal">null</span>;</span><br><span class="line">        customView = <span class="literal">null</span>;</span><br><span class="line">        customViewCallback.onCustomViewHidden();</span><br><span class="line">        webView.setVisibility(View.VISIBLE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 全屏容器界面 */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">FullscreenHolder</span> <span class="keyword">extends</span> <span class="title class_">FrameLayout</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">FullscreenHolder</span><span class="params">(Context ctx)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(ctx);</span><br><span class="line">            setBackgroundColor(ctx.getResources().getColor(android.R.color.black));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onTouchEvent</span><span class="params">(MotionEvent evt)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setStatusBarVisibility</span><span class="params">(<span class="type">boolean</span> visible)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">flag</span> <span class="operator">=</span> visible ? <span class="number">0</span> : WindowManager.LayoutParams.FLAG_FULLSCREEN;</span><br><span class="line">        getWindow().setFlags(flag, WindowManager.LayoutParams.FLAG_FULLSCREEN);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onKeyUp</span><span class="params">(<span class="type">int</span> keyCode, KeyEvent event)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (keyCode) &#123;</span><br><span class="line">            <span class="keyword">case</span> KeyEvent.KEYCODE_BACK:</span><br><span class="line">                <span class="comment">/** 回退键 事件处理 优先级:视频播放全屏-网页回退-关闭页面 */</span></span><br><span class="line">                <span class="keyword">if</span> (customView != <span class="literal">null</span>) &#123;</span><br><span class="line">                    hideCustomView();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (webView.canGoBack()) &#123;</span><br><span class="line">                    webView.goBack();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    finish();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">super</span>.onKeyUp(keyCode, event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="WebView明文存储密码带来的安全漏洞"><a href="#WebView明文存储密码带来的安全漏洞" class="headerlink" title="WebView明文存储密码带来的安全漏洞"></a>WebView明文存储密码带来的安全漏洞</h2><p>WebView组件默认开启了密码保存功能，会提示用户是否保存密码，当用户选择保存在WebView中输入的用户名和密码，则会被明文保存到应用数据目录的databases&#x2F;webview.db中。攻击者可能通过root的方式访问该应用的WebView数据库，从而窃取本地明文存储的用户名和密码。</p>
<p><strong>解决方案</strong></p>
<p>开发者调用 WebView.getSettings().setSavePassword(false)，显示调用API设置为false，让WebView不存储密码。</p>
<h2 id="WebView远程代码执行漏洞"><a href="#WebView远程代码执行漏洞" class="headerlink" title="WebView远程代码执行漏洞"></a>WebView远程代码执行漏洞</h2><p>Android API level 17以及之前的系统版本，由于程序没有正确限制使用addJavascriptInterface方法，远程攻击者可通过使用Java Reflection API利用该漏洞执行任意Java对象的方法。通过addJavascriptInterface给WebView加入一个 JavaScript桥接接口，JavaScript通过调用这个接口可以直接与本地的Java接口进行交互。就有可能出现手机被安装木马程序、发送扣费短信、通信录或者短信被窃取，甚至手机被远程控制等安全问题。</p>
<p><strong>解决方案</strong></p>
<p>如果一定要使用addJavascriptInterface接口，需使用以下方法：</p>
<ol>
<li>设置minSdkVersion值大于或等于17，使应用不能在4.2以下系统上运行</li>
<li>允许被JavaScript调用的方法必须以@JavascriptInterface进行注解声明</li>
</ol>
<h2 id="未移除有风险的WebView系统隐藏接口漏洞"><a href="#未移除有风险的WebView系统隐藏接口漏洞" class="headerlink" title="未移除有风险的WebView系统隐藏接口漏洞"></a>未移除有风险的WebView系统隐藏接口漏洞</h2><p>根据CVE披露的WebView远程代码执行漏洞信息（CVE-2012-663、CVE-2014-7224），Android系统中存在一共三个有远程代码执行漏洞的隐藏接口。分别是位于android&#x2F;webkit&#x2F;webview中的“searchBoxJavaBridge”接口、android&#x2F;webkit&#x2F;AccessibilityInjector.java中的“accessibility”接口和“accessibilityTraversal”接口。调用此三个接口的APP在开启辅助功能选项中第三方服务的Android系统上将面临远程代码执行漏洞。</p>
<p><strong>解决方案</strong></p>
<p>如果应用内使用了WebView组件，那么使用 WebView.removeJavascriptInterface(String name) API时，显示的移除searchBoxJavaBridge、accessibility、accessibilityTraversal这三个接口。</p>
<h2 id="减少webview引起的内存泄漏"><a href="#减少webview引起的内存泄漏" class="headerlink" title="减少webview引起的内存泄漏"></a>减少webview引起的内存泄漏</h2><p>直接 new WebView 并传入 application context 代替在 XML 里面声明以防止 activity 引用被滥用，能解决90+%的 WebView 内存泄漏。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vWeb =  <span class="keyword">new</span> <span class="title class_">WebView</span>(getContext().getApplicationContext());</span><br><span class="line">container.addView(vWeb);</span><br></pre></td></tr></table></figure>

<p>销毁 WebView</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (vWeb != <span class="literal">null</span>) &#123;</span><br><span class="line">    vWeb.setWebViewClient(<span class="literal">null</span>);</span><br><span class="line">    vWeb.setWebChromeClient(<span class="literal">null</span>);</span><br><span class="line">    vWeb.loadDataWithBaseURL(<span class="literal">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;text/html&quot;</span>, <span class="string">&quot;utf-8&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">    vWeb.clearHistory();</span><br><span class="line"></span><br><span class="line">    ((ViewGroup) vWeb.getParent()).removeView(vWeb);</span><br><span class="line">    vWeb.destroy();</span><br><span class="line">    vWeb = <span class="literal">null</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>



<h2 id="升级到API33，pdf无法显示"><a href="#升级到API33，pdf无法显示" class="headerlink" title="升级到API33，pdf无法显示"></a>升级到API33，pdf无法显示</h2><p>解决：下载到App的内置目录，<del>再用本地的 <code>assets/pdfjs/web/viewer.html【3.11.174pdj】</code> 进行展示【某些机型无法展示，用<a href="mailto:&#x70;&#x64;&#102;&#106;&#x73;&#45;&#x64;&#x69;&#115;&#116;&#x40;&#x32;&#x2e;&#51;&#46;&#x32;&#48;&#48;">&#x70;&#x64;&#102;&#106;&#x73;&#45;&#x64;&#x69;&#115;&#116;&#x40;&#x32;&#x2e;&#51;&#46;&#x32;&#48;&#48;</a>可以】</del></p>
<blockquote>
<p>其中 assets&#x2F;pdfjs 从 <a target="_blank" rel="noopener" href="https://mozilla.github.io/pdf.js/getting_started/">https://mozilla.github.io/pdf.js/getting_started/</a> 下载</p>
<p>或从 <a target="_blank" rel="noopener" href="https://github.com/mozilla/pdf.js/releases/tag/v3.11.174">https://github.com/mozilla/pdf.js/releases/tag/v3.11.174</a> 下载</p>
</blockquote>
<p>WebSettings添加</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 支持javascript</span></span><br><span class="line">settings.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">settings.setAllowFileAccess(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">//允许加载本地文件</span></span><br><span class="line">settings.setAllowFileAccessFromFileURLs(<span class="literal">true</span>);</span><br><span class="line">settings.setAllowUniversalAccessFromFileURLs(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<p>添加下载：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">webView.setDownloadListener((url, userAgent, contentDisposition, mimetype, contentLength) -&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (isresumerow) &#123;</span><br><span class="line">        downloadPdf(url, <span class="string">&quot;preview&quot;</span>, <span class="string">&quot;附件简历&quot;</span>, <span class="string">&quot;preview.pdf&quot;</span>, userAgent, mimetype);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> DownloadManagerUtils downloadManagerUtils;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">downloadPdf</span><span class="params">(String url, String title, String msg, String fileName, String userAgent, String mimetype)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (downloadManagerUtils == <span class="literal">null</span>) &#123;</span><br><span class="line">        downloadManagerUtils = <span class="keyword">new</span> <span class="title class_">DownloadManagerUtils</span>(<span class="built_in">this</span>);</span><br><span class="line">        <span class="comment">//注册广播和下载完成监听</span></span><br><span class="line">        downloadManagerUtils.registerReceiver(<span class="keyword">new</span> <span class="title class_">DownloadManagerUtils</span>.OnDownloadCompleted() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDownloadCompleted</span><span class="params">(<span class="type">long</span> completeDownloadId)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (mBinding != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> downloadManagerUtils.getPathFromId(completeDownloadId);</span><br><span class="line">                    <span class="comment">//展示</span></span><br><span class="line">                    webView.loadUrl(<span class="string">&quot;file:///android_asset/pdfjs/web/viewer.html?file=&quot;</span> + filePath);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">id</span> <span class="operator">=</span> downloadManagerUtils.download(url, title, msg, fileName, userAgent, mimetype);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>上面的代码在某些手机上无法展示：报 <code>SyntaxError: Unexpected token &#39;.&#39;</code></p>
<p>把<code>webView.loadUrl(&quot;file:///android_asset/pdfjs/web/viewer.html?file=&quot; + filePath);</code>改成</p>
<p><code>webView.loadUrl(&quot;file:///android_asset/pdf.html?&quot; + filePath);</code>【其中版本是<code>pdfjs-dist@2.3.200</code>】</p>
<blockquote>
<p>用的 assets&#x2F;pdf.html、assets&#x2F;pdf.js 并非带源码的那种</p>
</blockquote>
<p><code>ssets/pdf.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">content</span>=<span class="string">&quot;width=device-width,initial-scale=1.0,maximum-scale=2.0,user-scalable=yes&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>PDF查看<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">canvas</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border</span>: <span class="number">1px</span> solid black;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/pdfjs-dist@2.3.200/build/pdf.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;pdf.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>assets/pdf.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> url = location.<span class="property">search</span>.<span class="title function_">substring</span>(<span class="number">1</span>);</span><br><span class="line">pdfjsLib.<span class="property">cMapUrl</span> = <span class="string">&#x27;https://unpkg.com/pdfjs-dist@2.3.200/cmaps/&#x27;</span>;</span><br><span class="line">pdfjsLib.<span class="property">cMapPacked</span> = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">var</span> pdfDoc = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createPage</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> div = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;canvas&quot;</span>);</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(div);</span><br><span class="line">    <span class="keyword">return</span> div;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">renderPage</span>(<span class="params">num</span>) &#123;</span><br><span class="line">    pdfDoc.<span class="title function_">getPage</span>(num).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">page</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> viewport = page.<span class="title function_">getViewport</span>(&#123;<span class="attr">scale</span>:<span class="number">2.0</span>&#125;);</span><br><span class="line">        <span class="keyword">var</span> canvas = <span class="title function_">createPage</span>();</span><br><span class="line">        <span class="keyword">var</span> ctx = canvas.<span class="title function_">getContext</span>(<span class="string">&#x27;2d&#x27;</span>);</span><br><span class="line">        canvas.<span class="property">height</span> = viewport.<span class="property">height</span>;</span><br><span class="line">        canvas.<span class="property">width</span> = viewport.<span class="property">width</span>;</span><br><span class="line">        page.<span class="title function_">render</span>(&#123;</span><br><span class="line">            <span class="attr">canvasContext</span>: ctx,</span><br><span class="line">            <span class="attr">viewport</span>: viewport</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">pdfjsLib.<span class="title function_">getDocument</span>(url).<span class="property">promise</span>.<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">pdf</span>) &#123;</span><br><span class="line">    pdfDoc = pdf;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt;= pdfDoc.<span class="property">numPages</span>; i++) &#123;</span><br><span class="line">        <span class="title function_">renderPage</span>(i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>上述的 <code>DownloadManagerUtils.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.app.DownloadManager;</span><br><span class="line"><span class="keyword">import</span> android.content.ActivityNotFoundException;</span><br><span class="line"><span class="keyword">import</span> android.content.BroadcastReceiver;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.content.IntentFilter;</span><br><span class="line"><span class="keyword">import</span> android.content.pm.PackageManager;</span><br><span class="line"><span class="keyword">import</span> android.database.Cursor;</span><br><span class="line"><span class="keyword">import</span> android.net.Uri;</span><br><span class="line"><span class="keyword">import</span> android.os.Environment;</span><br><span class="line"><span class="keyword">import</span> android.webkit.CookieManager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xm597.common.debug.DebugLog;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DownloadManagerUtils</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Context context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DownloadManagerUtils</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.context = context;</span><br><span class="line">        getService();</span><br><span class="line">        downLoadCompleteReceiver = <span class="keyword">new</span> <span class="title class_">DownloadCompleteReceiver</span>();</span><br><span class="line">        downloadIds = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Long&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前下载的所有任务 id</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Long&gt; <span class="title function_">getDownloadIds</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> downloadIds;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据任务id打开安装界面</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> downloadApkId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">installApk</span><span class="params">(<span class="type">long</span> downloadApkId)</span> &#123;</span><br><span class="line">        <span class="type">Intent</span> <span class="variable">install</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_VIEW);</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">downloadFileUri</span> <span class="operator">=</span> downloadManager.getUriForDownloadedFile(downloadApkId);<span class="comment">//获取下载文件路径</span></span><br><span class="line">        <span class="keyword">if</span> (downloadFileUri != <span class="literal">null</span>) &#123;</span><br><span class="line">            install.setDataAndType(downloadFileUri, <span class="string">&quot;application/vnd.android.package-archive&quot;</span>);</span><br><span class="line">            install.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                context.startActivity(install);<span class="comment">//打开安装界面</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (ActivityNotFoundException ex) &#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解除注册广播</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unregisterReceiver</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (downloadIds != <span class="literal">null</span>&amp;&amp;!downloadIds.isEmpty()) &#123;</span><br><span class="line">            <span class="type">long</span>[] removeList = <span class="keyword">new</span> <span class="title class_">long</span>[downloadIds.size()];</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; downloadIds.size(); i++) &#123;</span><br><span class="line">                removeList[i] = downloadIds.get(i);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                downloadManager.remove(removeList);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        context.unregisterReceiver(downLoadCompleteReceiver);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DownloadCompleteReceiver downLoadCompleteReceiver;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册广播并注册监听接口</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> onDownloadCompleted</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerReceiver</span><span class="params">(OnDownloadCompleted onDownloadCompleted)</span> &#123;</span><br><span class="line">        context.registerReceiver(downLoadCompleteReceiver,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">IntentFilter</span>(DownloadManager.ACTION_DOWNLOAD_COMPLETE));</span><br><span class="line">        <span class="built_in">this</span>.onDownloadCompleted = onDownloadCompleted;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    OnDownloadCompleted onDownloadCompleted;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下载完成监听</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">DownloadCompleteReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">action</span> <span class="operator">=</span> intent.getAction();</span><br><span class="line">            <span class="keyword">if</span> (DownloadManager.ACTION_DOWNLOAD_COMPLETE.equals(action)) &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">completeDownloadId</span> <span class="operator">=</span> intent.getLongExtra(DownloadManager.EXTRA_DOWNLOAD_ID, -<span class="number">1</span>);<span class="comment">//获取下载完成任务的id</span></span><br><span class="line">                <span class="keyword">if</span> (completeDownloadId != -<span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (onDownloadCompleted !=<span class="literal">null</span>) &#123;</span><br><span class="line">                        onDownloadCompleted.onDownloadCompleted(completeDownloadId);<span class="comment">//调用下载完成接口方法</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//下载完成后删除id</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; downloadIds.size(); i++) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (completeDownloadId == downloadIds.get(i)) &#123;</span><br><span class="line">                            downloadIds.remove(i);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下载完成监听</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OnDownloadCompleted</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDownloadCompleted</span><span class="params">(<span class="type">long</span> completeDownloadId)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断下载组件是否可用</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">canDownloadState</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">state</span> <span class="operator">=</span> context.getPackageManager().getApplicationEnabledSetting(<span class="string">&quot;com.android.providers.downloads&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (state == PackageManager.COMPONENT_ENABLED_STATE_DISABLED</span><br><span class="line">                    || state == PackageManager.COMPONENT_ENABLED_STATE_DISABLED_USER</span><br><span class="line">                    || state == PackageManager.COMPONENT_ENABLED_STATE_DISABLED_UNTIL_USED) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启用下载组件</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">enableDowaload</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">packageName</span> <span class="operator">=</span> <span class="string">&quot;com.android.providers.downloads&quot;</span>;</span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(android.provider.Settings.ACTION_APPLICATION_DETAILS_SETTINGS);</span><br><span class="line">        intent.setData(Uri.parse(<span class="string">&quot;package:&quot;</span> + packageName));</span><br><span class="line">        context.startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;Long&gt; downloadIds;<span class="comment">//记录所有下载任务id</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uil         下载地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> title       通知栏标题</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> description 描述</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">download</span><span class="params">(String uil, String title, String description, String fileName, String userAgent, String mimetype)</span> &#123;</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(uil);</span><br><span class="line">        DownloadManager.<span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DownloadManager</span>.Request(uri);<span class="comment">//设置下载地址</span></span><br><span class="line">        request.addRequestHeader(<span class="string">&quot;userAgent&quot;</span>, userAgent);</span><br><span class="line">        request.addRequestHeader(<span class="string">&quot;mimetype&quot;</span>, mimetype);</span><br><span class="line">        <span class="type">CookieManager</span> <span class="variable">cookieManager</span> <span class="operator">=</span> CookieManager.getInstance(); <span class="comment">// 获取 CookieManager 实例</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">cookie</span> <span class="operator">=</span> cookieManager.getCookie(uil); <span class="comment">// 获取指定 URL 的 Cookie</span></span><br><span class="line">        request.addRequestHeader(<span class="string">&quot;Cookie&quot;</span>, cookie);</span><br><span class="line">        request.setTitle(title);<span class="comment">//设置Notification的title信息</span></span><br><span class="line">        request.setDescription(description);<span class="comment">//设置Notification的message信息</span></span><br><span class="line">        request.setNotificationVisibility(DownloadManager.Request.VISIBILITY_HIDDEN);<span class="comment">//设置通知栏下载通知不可见状态</span></span><br><span class="line">        <span class="comment">//下载到download文件夹下</span></span><br><span class="line"><span class="comment">//        request.setDestinationInExternalPublicDir(Environment.DIRECTORY_DOWNLOADS, fileName);</span></span><br><span class="line">        <span class="comment">//保存在app下可以访问</span></span><br><span class="line">        request.setDestinationInExternalFilesDir(context, Environment.DIRECTORY_DOWNLOADS, fileName);</span><br><span class="line">        <span class="comment">//只能在WiFi下进行下载(这个是两个环境都可以)</span></span><br><span class="line">        request.setAllowedNetworkTypes(DownloadManager.Request.NETWORK_WIFI | DownloadManager.Request.NETWORK_MOBILE);</span><br><span class="line">        <span class="comment">//reference变量是系统为当前的下载请求分配的一个唯一的ID，我们可以通过这个ID重新获得这个下载任务，进行一些自己想要进行的操作或者查询</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">id</span> <span class="operator">=</span> downloadManager.enqueue(request);</span><br><span class="line">        downloadIds.add(id);</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">download</span><span class="params">(String uil, String title, String description, String fileName)</span> &#123;</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(uil);</span><br><span class="line">        DownloadManager.<span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DownloadManager</span>.Request(uri);<span class="comment">//设置下载地址</span></span><br><span class="line">        request.setTitle(title);<span class="comment">//设置Notification的title信息</span></span><br><span class="line">        request.setDescription(description);<span class="comment">//设置Notification的message信息</span></span><br><span class="line">        request.setNotificationVisibility(DownloadManager.Request.VISIBILITY_VISIBLE_NOTIFY_COMPLETED);<span class="comment">//设置通知栏下载通知显示状态</span></span><br><span class="line">        <span class="comment">//下载到download文件夹下</span></span><br><span class="line">        request.setDestinationInExternalPublicDir(Environment.DIRECTORY_DOWNLOADS, fileName);</span><br><span class="line">        <span class="comment">//只能在WiFi下进行下载(这个是两个环境都可以)</span></span><br><span class="line">        request.setAllowedNetworkTypes(DownloadManager.Request.NETWORK_WIFI | DownloadManager.Request.NETWORK_MOBILE);</span><br><span class="line">        <span class="comment">//reference变量是系统为当前的下载请求分配的一个唯一的ID，我们可以通过这个ID重新获得这个下载任务，进行一些自己想要进行的操作或者查询</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">id</span> <span class="operator">=</span> downloadManager.enqueue(request);</span><br><span class="line">        downloadIds.add(id);</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> downloadId 实际的下载任务 ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPathFromId</span><span class="params">(<span class="type">long</span> downloadId)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (context == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">DownloadManager</span> <span class="variable">downloadManager</span> <span class="operator">=</span> (DownloadManager) context.getSystemService(Context.DOWNLOAD_SERVICE);</span><br><span class="line">		<span class="comment">// 查询下载任务</span></span><br><span class="line">        DownloadManager.<span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DownloadManager</span>.Query();</span><br><span class="line">        query.setFilterById(downloadId);</span><br><span class="line">        <span class="type">Cursor</span> <span class="variable">cursor</span> <span class="operator">=</span> downloadManager.query(query);</span><br><span class="line">        <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">		<span class="comment">// 获取查询结果</span></span><br><span class="line">        <span class="keyword">if</span> (cursor.moveToFirst()) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">columnIndex</span> <span class="operator">=</span> cursor.getColumnIndex(DownloadManager.COLUMN_LOCAL_URI);</span><br><span class="line">            filePath = cursor.getString(columnIndex);</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// 关闭 Cursor 和 DownloadManager</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            cursor.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> filePath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DownloadManager downloadManager;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化downloadManager</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">getService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">serviceString</span> <span class="operator">=</span> Context.DOWNLOAD_SERVICE;</span><br><span class="line">        downloadManager = (DownloadManager) context.getSystemService(serviceString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//    private void testDownload()&#123;</span></span><br><span class="line"><span class="comment">//        DownloadManagerUtils  downloadManagerUtils  = new DownloadManagerUtils(this);</span></span><br><span class="line"><span class="comment">//        long id = downloadManagerUtils.download(&quot;https://cdn.597.com/hrTemplate/在职证明.docx&quot;,&quot;测试下载&quot;,&quot;这是一次测试下载&quot;,&quot;在职证明.docx&quot;);</span></span><br><span class="line"><span class="comment">//        downloadManagerUtils.registerReceiver(new DownloadManagerUtils.OnDownloadCompleted() &#123;//注册广播和下载完成监听</span></span><br><span class="line"><span class="comment">//            @Override</span></span><br><span class="line"><span class="comment">//            public void onDownloadCompleted(long completeDownloadId) &#123;</span></span><br><span class="line"><span class="comment">//                showtoast(&quot;在职证明.docx下载完成&quot;);</span></span><br><span class="line"><span class="comment">//                downloadManagerUtils.installApk(completeDownloadId);//调用这个是下载</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    @Override</span></span><br><span class="line"><span class="comment">//    protected void onDestroy() &#123;</span></span><br><span class="line"><span class="comment">//        downloadManagerUtils.unregisterReceiver();//销毁是解除注册</span></span><br><span class="line"><span class="comment">//        super.onDestroy();</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<!-- flag of hidden posts -->
      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div></div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt=" WeChat Pay"/>
        <p>WeChat Pay</p>
      </div>
    

    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/private/" rel="tag"># private</a>
          
            <a href="/tags/%E5%AE%89%E5%8D%93UI/" rel="tag"># 安卓UI</a>
          
        </div>
      

      
      
      

      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">95</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">27</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="mailto:shenbh@189.cn" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://blog.csdn.net/ptwenzi?spm=1010.2135.3001.5113" target="_blank" title="CSDN">
                      
                        <i class="fa fa-fw fa-clone"></i>CSDN</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/shenbh" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://gitee.com/shen_bh" target="_blank" title="Gitee">
                      
                        <i class="fa fa-fw fa-git"></i>Gitee</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Webview"><span class="nav-text">Webview</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="nav-text">基本使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Webview-%E5%8A%A0%E8%BD%BD%E4%BC%98%E5%8C%96"><span class="nav-text">Webview 加载优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F"><span class="nav-text">内存泄漏</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8EJS%E4%BA%A4%E4%BA%92"><span class="nav-text">与JS交互</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JS%E8%B0%83%E7%94%A8%E5%8E%9F%E7%94%9F"><span class="nav-text">JS调用原生</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%94%9F%E6%93%8D%E4%BD%9CJS"><span class="nav-text">原生操作JS</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A0%E6%97%A5%E5%BF%97"><span class="nav-text">加日志</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WebView%E7%BC%93%E5%AD%98"><span class="nav-text">WebView缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8-%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6"><span class="nav-text">浏览器 缓存机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%B9%E7%82%B9"><span class="nav-text">特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">应用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="nav-text">具体实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Application-Cache%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6"><span class="nav-text">Application Cache缓存机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%B9%E7%82%B9-1"><span class="nav-text">特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF-1"><span class="nav-text">应用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0-1"><span class="nav-text">具体实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dom-Storage%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6"><span class="nav-text">Dom Storage缓存机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%B9%E7%82%B9-2"><span class="nav-text">特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF-2"><span class="nav-text">应用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0-2"><span class="nav-text">具体实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Web-SQL-Database%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6"><span class="nav-text">Web SQL Database缓存机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%B9%E7%82%B9-3"><span class="nav-text">特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF-3"><span class="nav-text">应用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0-3"><span class="nav-text">具体实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Indexed-Database%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6"><span class="nav-text">Indexed Database缓存机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%B9%E7%82%B9-4"><span class="nav-text">特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF-4"><span class="nav-text">应用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0-4"><span class="nav-text">具体实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#File-System"><span class="nav-text">File System</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%B9%E7%82%B9-5"><span class="nav-text">特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF-5"><span class="nav-text">应用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B7%E4%BD%93%E4%BD%BF%E7%94%A8"><span class="nav-text">具体使用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WebView%E5%AF%B9%E6%AF%94%E4%B8%8E%E4%BD%BF%E7%94%A8"><span class="nav-text">WebView对比与使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%85%BE%E8%AE%AFX5%E5%86%85%E6%A0%B8%E4%BD%BF%E7%94%A8"><span class="nav-text">腾讯X5内核使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E8%85%BE%E8%AE%AFX5%E5%86%85%E6%A0%B8%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9D%91"><span class="nav-text">使用腾讯X5内核的一些坑</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JsBridge%E4%BD%BF%E7%94%A8"><span class="nav-text">JsBridge使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AgentWeb%E4%BD%BF%E7%94%A8"><span class="nav-text">AgentWeb使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SuperWeb%E4%BD%BF%E7%94%A8"><span class="nav-text">SuperWeb使用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Android%E5%92%8CH5%E8%BF%9B%E8%A1%8C%E4%BA%A4%E4%BA%92%E7%9A%84%E6%A8%A1%E6%9D%BF%E4%BB%A3%E7%A0%81"><span class="nav-text">Android和H5进行交互的模板代码</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Android"><span class="nav-text">Android</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Html"><span class="nav-text">Html</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WebView%E9%97%AE%E9%A2%98"><span class="nav-text">WebView问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#WebView%E4%B8%8D%E6%94%AF%E6%8C%81%E6%8B%A8%E6%89%93%E7%94%B5%E8%AF%9D"><span class="nav-text">WebView不支持拨打电话</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%A9WebView%E5%90%84Android%E7%89%88%E6%9C%AC%E6%AD%A3%E5%B8%B8%E6%92%AD%E6%94%BE"><span class="nav-text">让WebView各Android版本正常播放</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WebView%E6%97%A0%E6%B3%95%E5%85%A8%E5%B1%8F%E6%92%AD%E6%94%BE"><span class="nav-text">WebView无法全屏播放</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WebView%E6%98%8E%E6%96%87%E5%AD%98%E5%82%A8%E5%AF%86%E7%A0%81%E5%B8%A6%E6%9D%A5%E7%9A%84%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E"><span class="nav-text">WebView明文存储密码带来的安全漏洞</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WebView%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E"><span class="nav-text">WebView远程代码执行漏洞</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AA%E7%A7%BB%E9%99%A4%E6%9C%89%E9%A3%8E%E9%99%A9%E7%9A%84WebView%E7%B3%BB%E7%BB%9F%E9%9A%90%E8%97%8F%E6%8E%A5%E5%8F%A3%E6%BC%8F%E6%B4%9E"><span class="nav-text">未移除有风险的WebView系统隐藏接口漏洞</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%8F%E5%B0%91webview%E5%BC%95%E8%B5%B7%E7%9A%84%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F"><span class="nav-text">减少webview引起的内存泄漏</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%87%E7%BA%A7%E5%88%B0API33%EF%BC%8Cpdf%E6%97%A0%E6%B3%95%E6%98%BE%E7%A4%BA"><span class="nav-text">升级到API33，pdf无法显示</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">阿炳</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('-1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
          if(result)$(this).text('Copied')
          else $(this).text('Copy failed')
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('Copy')
        }, 300)
      }).append(e)
    })
  </script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>