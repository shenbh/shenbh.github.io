<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="private,flutter," />










<meta name="description" content="容器宽高相关问题Container 设置宽高不生效一般是由于父级容器的 constraints 属性引起的，在 Flutter 中，子组件的大小会被父组件的  constraints  属性限制，例如 1234567891011ConstrainedBox(  constraints: BoxConstraints(    minWidth: 100.0, &#x2F;&#x2F; 最小宽度为 100 像素    m">
<meta property="og:type" content="article">
<meta property="og:title" content="Flutter相关问题">
<meta property="og:url" content="http://shenbh.github.io/posts/136519660/index.html">
<meta property="og:site_name" content="AB">
<meta property="og:description" content="容器宽高相关问题Container 设置宽高不生效一般是由于父级容器的 constraints 属性引起的，在 Flutter 中，子组件的大小会被父组件的  constraints  属性限制，例如 1234567891011ConstrainedBox(  constraints: BoxConstraints(    minWidth: 100.0, &#x2F;&#x2F; 最小宽度为 100 像素    m">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/2/28/1708b07cd338e0ca?imageslim">
<meta property="og:image" content="http://shenbh.github.io/posts/136519660/blur_img.jpg">
<meta property="article:published_time" content="2019-12-18T14:15:34.000Z">
<meta property="article:modified_time" content="2022-11-18T07:54:42.875Z">
<meta property="article:author" content="阿炳">
<meta property="article:tag" content="private">
<meta property="article:tag" content="flutter">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://user-gold-cdn.xitu.io/2020/2/28/1708b07cd338e0ca?imageslim">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://shenbh.github.io/posts/136519660/"/>





  <title>Flutter相关问题 | AB</title><meta name="robots" content="noindex">
  








<meta name="generator" content="Hexo 6.1.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">AB</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Just do IT Now.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://shenbh.github.io/posts/136519660/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AB">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Flutter相关问题</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-12-18T22:15:34+08:00">
                2019-12-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Flutter/" itemprop="url" rel="index">
                    <span itemprop="name">Flutter</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="容器宽高相关问题"><a href="#容器宽高相关问题" class="headerlink" title="容器宽高相关问题"></a>容器宽高相关问题</h1><h2 id="Container-设置宽高不生效"><a href="#Container-设置宽高不生效" class="headerlink" title="Container 设置宽高不生效"></a>Container 设置宽高不生效</h2><p>一般是由于父级容器的 <code>constraints</code> 属性引起的，在 Flutter 中，子组件的大小会被父组件的  <code>constraints</code>  属性限制，例如</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ConstrainedBox(</span><br><span class="line"><span class="symbol">  constraints:</span> BoxConstraints(</span><br><span class="line"><span class="symbol">    minWidth:</span> <span class="number">100.0</span>, <span class="comment">// 最小宽度为 100 像素</span></span><br><span class="line"><span class="symbol">    minHeight:</span> <span class="number">50.0</span> <span class="comment">// 最小高度为 50 像素</span></span><br><span class="line">  ),</span><br><span class="line"><span class="symbol">  child:</span> Container(</span><br><span class="line"><span class="symbol">    height:</span> <span class="number">5.0</span>,<span class="comment">// 高度为 5 逻辑像素</span></span><br><span class="line"><span class="symbol">    child:</span> redBox </span><br><span class="line">  ),</span><br><span class="line">)</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>上面的代码中，<code>Container</code> 组件设置高度为 5 像素，是无法生效的，因为父级容器已经设置了最小高度为 50 像素，所以 <code>Container</code> 组件的最终高度将会是 50 像素。</p>
<p>当然，这肯定不是我们想要的效果，我们就想让  <code>Container</code>  组件的最终高度是 5 像素怎么办？其实很简单，可以使用 <code>UnconstraindBox</code> 解除父级容器的 <code>constraints</code> 属性对子组件大小的限制。例如：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ConstrainedBox(</span><br><span class="line"><span class="symbol">  constraints:</span> BoxConstraints(</span><br><span class="line"><span class="symbol">    minWidth:</span> <span class="number">100.0</span>, <span class="comment">// 最小宽度为 100 像素</span></span><br><span class="line"><span class="symbol">    minHeight:</span> <span class="number">50.0</span> <span class="comment">// 最小高度为 50 像素</span></span><br><span class="line">  ),</span><br><span class="line"><span class="symbol">  child:</span> UnconstraintsBox(</span><br><span class="line"><span class="symbol">    child:</span> Container(</span><br><span class="line"><span class="symbol">      height:</span> <span class="number">5.0</span>, </span><br><span class="line"><span class="symbol">      child:</span> redBox </span><br><span class="line">    ),</span><br><span class="line">  ),</span><br><span class="line">)</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p><code>UnconstrainedBox</code> 允许其子组件按照其自身的大小绘制，我们很少直接使用此组件，除非对于 Material 自带的一些组件，如 <code>Appbar</code> 的 icon 被官方限制了固定的大小，利用该组件可以解除限制，而一般情况下，我们在组件外面套一层布局类组件就可以解决需求，例如以下组件：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">Row</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">Column</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">Align</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">Center</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">Flex</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">Wrap</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">Flow</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">Stack</span><span class="params">()</span></span></span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<h2 id="SignleChildScrollView-不满一屏高度时无法撑满全屏"><a href="#SignleChildScrollView-不满一屏高度时无法撑满全屏" class="headerlink" title="SignleChildScrollView 不满一屏高度时无法撑满全屏"></a>SignleChildScrollView 不满一屏高度时无法撑满全屏</h2><p>其实和上面这个问题是相似的，可以使用布局类组件解决，或者用如下方式：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Container</span>(</span><br><span class="line">  alignment: Alignment<span class="selector-class">.topLeft</span>,</span><br><span class="line">  child: <span class="built_in">SingleChildScrollView</span>(),</span><br><span class="line">),</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>如果你看过 <code>Container</code> 的源码你会发现其实设置 <code>alignment</code> 属性，和用 <code>Align</code> 组件是一回事，源码也是使用 <code>Align</code> 组件，这就是个语法糖，仅此而已。</p>
<p>说到语法糖，其实 <code>Center</code> 组件也是 <code>Align</code> 组件的语法糖，当你不给 <code>Align</code> 传递任何参数时，使用 <code>Center()</code> 和使用 <code>Align()</code> 是一模一样的效果，我的习惯是不管什么情况，都是只用<code>Align</code> 组件。</p>
<h2 id="Container-设置-borderRadius-不生效"><a href="#Container-设置-borderRadius-不生效" class="headerlink" title="Container  设置 borderRadius 不生效"></a>Container  设置 borderRadius 不生效</h2><p>设置 <code>borderRadius</code> 有两种做法，第一种使用 <code>Container</code> 等组件自带的 <code>borderRadius</code> 属性，第二种是，直接用 <code>ClipRRect</code> 等 clip 组件对容器进行裁剪，第二种比第一种更加暴力、消耗性能，但更有效。</p>
<p>例如给 <code>TabView</code> 的容器设置 <code>borderRadius</code>，你会发现无法生效，而使用 <code>ClipRRect</code> 则可以解决，我的理解是 <code>ClipRRect</code> 会直接裁剪成圆角形状，而 <code>BorderRadius</code> 的圆角外的弧形范围是透明的，类似 <code>css</code> 中的 <code>display:none</code> 与 <code>opaticy:0</code> 的区别，实际具体是什么原因，我也没有去细究，复制粘贴、能跑就行。</p>
<h1 id="元素显示层级问题"><a href="#元素显示层级问题" class="headerlink" title="元素显示层级问题"></a>元素显示层级问题</h1><p>可以认为 Flutter 中 <code>widget</code> 布局的层级关系是递进的，例如 <code>child</code> 的层级比父 <code>Widget</code> 层级更高， <code>Column</code>、<code>Row</code> 等组件的 <code>children</code> 中同级 <code>widget</code>，谁在后面谁的层级就更高，和 <code>Stack</code> 其 <code>children</code> 的层级关系相同。</p>
<h2 id="显示隐藏的几种做法"><a href="#显示隐藏的几种做法" class="headerlink" title="显示隐藏的几种做法"></a>显示隐藏的几种做法</h2><p>第一种，利用 <code>IndexedStack</code> 组件控制层级，上面也提到过，子组件谁在后面谁的层级就高，Flutter 中虽然没有 <code>z-index</code> 这一说法，但其实原理和 css 的 <code>z-index</code> 是类似的，index 越大，层级越高，当然这里的 <code>IndexedStack</code> 的 <code>index</code> 属性是用来控制当前显示的某一个 children，只能显示一个。该方法常用于 APP 首页切换底部导航。</p>
<p>第二种，利用 <code>IgnorePointer</code> 及 <code>Opacity</code> 组件组合隐藏 widget，可以使用 <code>AnimationOpacity</code> 组件达到以前 <code>JQuery</code> 中常用的 <code>fadeIn</code> 效果。</p>
<p>第三种，利用 <code>Positioned</code> 或 <code>Transform.translate</code> 移动到屏幕外，需要显示时再移动回来，这种做法非常适合动画切换，例如视频进度条等效果。</p>
<p>第四种，利用 <code>Offstage</code> 组件，前三种都是利用视觉效果将元素隐藏起来，其实在布局上并未发生改变，而此组件就是类似于 css 中的 <code>display:none</code>，直接让元素在布局中隐藏，不会在布局上继续占用空间。</p>
<p>最后一种，在 build 方法中提前判断，不符合条件直接不渲染，或者返回空 box，这就类似于 HTML 中删除 dom 元素，我人没了，还显示个🔨，这是最恐怖的。</p>
<h1 id="GestureDetector-设置-onTap-不生效"><a href="#GestureDetector-设置-onTap-不生效" class="headerlink" title="GestureDetector 设置 onTap 不生效"></a>GestureDetector 设置 onTap 不生效</h1><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Listener` 默认的 `behavior` 是 `HitTestBehavior.deferToChild</span><br></pre></td></tr></table></figure>

<p>如果 <code>Listener</code> 的子组件是一个 <code>Container</code>，这个 <code>Container</code> 不设置 <code>decoration</code> 的情况下，即透明背景色、无边框，则点击 <code>Container</code> 时，无法触发 <code>down、up</code> 等事件。</p>
<p>同理，<code>GestureDetector</code> 是对 <code>Listener</code> 的封装，无法触发 <code>onTap</code> 等事件也是必然的，那么解决办法也很简单，有以下两种解决办法：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 给 Container 设置 decoration</span><br><span class="line"><span class="bullet">2.</span> 将 behavior 属性设置为 opaque 或 translucent</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>





<h1 id="调用-setState-或-markNeedsBuild-后报错"><a href="#调用-setState-或-markNeedsBuild-后报错" class="headerlink" title="调用 setState 或 markNeedsBuild 后报错"></a>调用 setState 或 markNeedsBuild 后报错</h1><h2 id="第一种报错"><a href="#第一种报错" class="headerlink" title="第一种报错"></a>第一种报错</h2><blockquote>
<p>setState() or markNeedsBuild() called during build</p>
</blockquote>
<p>遇到此提示，一般解决思路都是利用 <code>addPostFrameCallback</code> 来解决，例如：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="module-access"><span class="module"><span class="identifier">WidgetsBinding</span>.</span></span>instance.add<span class="constructor">PostFrameCallback((<span class="params">_</span>)</span>&#123;</span><br><span class="line">    <span class="module-access"><span class="module"><span class="identifier">_model</span>.</span></span>set<span class="constructor">Opacity(<span class="params">opacity</span>)</span>;</span><br><span class="line">&#125;);</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<h2 id="第二种报错"><a href="#第二种报错" class="headerlink" title="第二种报错"></a>第二种报错</h2><blockquote>
<p>setState() called after dispose()</p>
</blockquote>
<p>一般定时器在 app 返回桌面后仍在调用 <code>setState</code> 或 页面 pop 销毁后异步任务才完成，此时调用了 <code>setState</code> 必然会出现该提示，那么解决办法也很简单，判断生命周期再执行重构逻辑。</p>
<figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="operator">!</span><span class="variable">mounted</span>) <span class="keyword">return</span>;</span><br><span class="line"><span class="title function_">setState</span>(() &#123;</span><br><span class="line">  <span class="comment">// do somthing</span></span><br><span class="line">&#125;);</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<h2 id="动态更改-TabBar-的长度后-setState-报错"><a href="#动态更改-TabBar-的长度后-setState-报错" class="headerlink" title="动态更改 TabBar 的长度后 setState 报错"></a>动态更改 TabBar 的长度后 setState 报错</h2><p>其实这个问题肯定是由于使用了 <code>SingleTickerProviderStateMixin</code> 造成的，解决方案有两种。</p>
<p>第一种是使用 <code>DefaultTabController</code> 来解决，这个方案比较适合大佬造轮子，因为需要自己写 <code>TabBar</code> 的切换效果，非常之麻烦。</p>
<p>第二种方案就是我目前正在使用的，非常简单，只需要将 <code>SingleTickerProviderStateMixin</code> 替换为 <code>TickerProviderStateMixin</code> 即可，相关代码如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EntryPage</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  createState() =&gt; _EntryPageState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_EntryPageState</span> <span class="keyword">extends</span> <span class="title">State&lt;EntryPage&gt;</span> <span class="keyword">with</span> <span class="title">TickerProviderStateMixin</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">TabController</span> tabController;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> tabs = &lt;<span class="type">DanceSort</span>&gt;[</span><br><span class="line">    <span class="type">DanceSort</span>.fromJson(&#123;<span class="string">&quot;id&quot;</span>: <span class="number">-1</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;推荐&quot;</span>&#125;),</span><br><span class="line">    <span class="type">DanceSort</span>.fromJson(&#123;<span class="string">&quot;id&quot;</span>: <span class="number">0</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;关注&quot;</span>&#125;),</span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  <span class="type">Future</span>&lt;void&gt; getTabBar() async &#123;</span><br><span class="line">    <span class="keyword">final</span> danceSorts = await <span class="type">EntryApi</span>.getDanceSorts();</span><br><span class="line">    <span class="keyword">if</span> (danceSorts == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    tabs.addAll(danceSorts);</span><br><span class="line">    tabController.dispose();</span><br><span class="line">    tabController = <span class="type">TabController</span>(length: tabs.length, vsync: <span class="keyword">this</span>);</span><br><span class="line">    setState(() &#123;&#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  initState() &#123;</span><br><span class="line">    getTabBar();</span><br><span class="line">    tabController = <span class="type">TabController</span>(length: tabs.length, vsync: <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  dispose() &#123;</span><br><span class="line">    tabController.dispose();</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  get tabBar =&gt; <span class="type">TabBar</span>(</span><br><span class="line">    controller: tabController,</span><br><span class="line">    tabs: tabs.map&lt;<span class="type">Tab</span>&gt;((v) =&gt; <span class="type">Tab</span>(text: v.name)).toList(),</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  get tabBarView =&gt; <span class="type">TabBarView</span>(</span><br><span class="line">    controller: tabController,</span><br><span class="line">    children: tabs.map&lt;<span class="type">RecommendList</span>&gt;((v) =&gt; <span class="type">RecommendList</span>(v.id)).toList(),</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="type">Widget</span> build(<span class="type">BuildContext</span> context) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">FloatingScrollView</span>(</span><br><span class="line">      tabBar: tabBar,</span><br><span class="line">      tabBarView: tabBarView,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>在 <code>initState</code> 时，先初始化本地默认的 tab，通过 Api 请求到服务端的 tab 数据后，再将原 <code>tabController</code> 销毁，生成一个新的 <code>tabController</code>，由于使用的是 <code>TickerProviderStateMixin</code>，所以并不会因为 <code>Single</code> 而报错。</p>
<p>为了便于理解，这个例子使用的 <code>setState</code> 来重新构建布局，其实完全可以使用 Provider 进行优化，我的项目也是全部使用 Provider 来进行管理的，利用 <code>Selector</code> 将构建范围缩小至最小，能很大地改善重构布局时的性能问题，例如上面 <code>tabBar</code> 部分可以换成：</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">get tabBar =&gt; Selector&lt;HomeModel, TabController&gt;(</span><br><span class="line">  selector: <span class="function">(<span class="params">context, model</span>) =&gt;</span> model.tabController,</span><br><span class="line">  <span class="attr">builder</span>: <span class="function">(<span class="params">context, controller, _</span>) =&gt;</span> TabBar(</span><br><span class="line">    controller: controller,</span><br><span class="line">    <span class="attr">tabs</span>: model.tabs.<span class="built_in">map</span>&lt;<span class="literal">Tab</span>&gt;<span class="function">(<span class="params">(v</span>) =&gt;</span> <span class="literal">Tab</span>(<span class="built_in">text</span>: v.name)).toList(),</span><br><span class="line">  ),</span><br><span class="line">);</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>





<h1 id="键盘相关问题"><a href="#键盘相关问题" class="headerlink" title="键盘相关问题"></a>键盘相关问题</h1><h2 id="键盘弹出后将布局顶起来了，而不是遮住布局"><a href="#键盘弹出后将布局顶起来了，而不是遮住布局" class="headerlink" title="键盘弹出后将布局顶起来了，而不是遮住布局"></a>键盘弹出后将布局顶起来了，而不是遮住布局</h2><p>解决办法：在 <code>scafold</code> 里设置 <code>resizeToAvoidBottomInset: false</code>，键盘会遮住布局，而不是顶起布局。</p>
<h2 id="就想让键盘顶起布局，布局却溢出了怎么办？"><a href="#就想让键盘顶起布局，布局却溢出了怎么办？" class="headerlink" title="就想让键盘顶起布局，布局却溢出了怎么办？"></a>就想让键盘顶起布局，布局却溢出了怎么办？</h2><p>溢出肯定是因为没有键盘时，整体高度没有一屏高，键盘出现了，却超出了一屏的高度。解决办法很简单，首先将布局使用 <code>SingleChildScrolleView</code> 之类的滚动组件包裹住，将布局改变为可滚动的，这样键盘弹出后布局就不会溢出了。</p>
<p>接着可以使用 <code>WidgetsBindingObserver</code> 类来监听键盘弹起事件，每次弹起键盘出触发 <code>didChangeMetrics</code> 钩子，在该钩子里执行逻辑即可，例如将 <code>SingleChildScrolleView</code> 的当前位置调整至最底部，相关代码如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#x27;<span class="keyword">package</span>:flutter/material.dart&#x27;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  createState() =&gt; _DemoState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_DemoState</span> <span class="keyword">extends</span> <span class="title">State&lt;Demo&gt;</span> <span class="keyword">with</span> <span class="title">WidgetsBindingObserver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> _scrollController = <span class="type">ScrollController</span>();</span><br><span class="line">  <span class="keyword">final</span> _phoneController = <span class="type">TextEditingController</span>();</span><br><span class="line"></span><br><span class="line">  <span class="type">FocusNode</span> _phoneFocusNode = <span class="type">FocusNode</span>();</span><br><span class="line">  <span class="type">FocusScopeNode</span> _focusScopeNode;</span><br><span class="line"></span><br><span class="line">  get _phoneTextFiled =&gt; <span class="type">TextField</span>(</span><br><span class="line">    controller: _phoneController,</span><br><span class="line">    focusNode: _phoneFocusNode,</span><br><span class="line">    keyboardType: <span class="type">TextInputType</span>.phone,</span><br><span class="line">    maxLength: <span class="number">11</span>,</span><br><span class="line">    decoration: <span class="type">InputDecoration</span>(</span><br><span class="line">      hintText: &#x27;请输入手机号&#x27;,</span><br><span class="line">      border: <span class="type">InputBorder</span>.none,</span><br><span class="line">      counterText: &#x27;&#x27;,</span><br><span class="line">    ),</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  void handlePostFrame() &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_phoneFocusNode.hasFocus) &#123;</span><br><span class="line">      print(&#x27;requestFocus&#x27;);</span><br><span class="line">      _focusScopeNode.requestFocus(_phoneFocusNode);</span><br><span class="line">    &#125;</span><br><span class="line">    print(&#x27;jumpTo&#x27;);</span><br><span class="line">    _scrollController.jumpTo(_scrollController.position.maxScrollExtent);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  void initState() &#123;</span><br><span class="line">    <span class="type">WidgetsBinding</span>.instance.addObserver(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  void didChangeMetrics() &#123;</span><br><span class="line">    <span class="type">WidgetsBinding</span>.instance.addPostFrameCallback(handlePostFrame);</span><br><span class="line">    <span class="keyword">super</span>.didChangeMetrics();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  void dispose() &#123;</span><br><span class="line">    <span class="type">WidgetsBinding</span>.instance.removeObserver(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<h2 id="键盘弹起和收回会引起页面重新build"><a href="#键盘弹起和收回会引起页面重新build" class="headerlink" title="键盘弹起和收回会引起页面重新build"></a>键盘弹起和收回会引起页面重新build</h2><p>我的项目中有一个接近 1 万行代码的视频详情页，全部使用 <code>Provider</code> 进行状态管理，如果键盘弹起、收回引起重新 build，就可能出现一些奇怪的 BUG，比如当前的滚动组件在屏幕中的位置发生变化。</p>
<p>我的解决方案是利用 <code>showBottomSheet</code> 方法，页面中展示的 <code>TextField</code> 上盖一层透明遮罩，使用户无法点击，而点击遮罩时，则触发 <code>showBottomSheet</code>， push 进一个新的路由，弹起键盘，却不会引起重新 build，收起键盘时，则会 pop 回页面，其实视觉上一直都保持在同一页面中，和普通的弹起键盘没区别，并且性能也非常棒，相关代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">  get textField =&gt; <span class="title function_ invoke__">TextField</span>(</span><br><span class="line">    <span class="attr">autofocus</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">cursorColor</span>: currentTheme.hoverColor,</span><br><span class="line">    <span class="attr">cursorWidth</span>: <span class="number">1.0</span>,</span><br><span class="line">    <span class="attr">textInputAction</span>: TextInputAction.done,</span><br><span class="line">    <span class="attr">style</span>: <span class="title function_ invoke__">TextStyle</span>(</span><br><span class="line">      <span class="attr">color</span>: currentTheme.primaryColorLight,</span><br><span class="line">      <span class="attr">fontSize</span>: <span class="title function_ invoke__">setSp</span>(<span class="number">32</span>),</span><br><span class="line">    ),</span><br><span class="line">    <span class="attr">decoration</span>: <span class="title function_ invoke__">InputDecoration</span>(</span><br><span class="line">      <span class="attr">hintText</span>: <span class="string">&#x27;发一句友善的评论来见证当下吧&#x27;</span>,</span><br><span class="line">      <span class="attr">hintStyle</span>: <span class="title function_ invoke__">TextStyle</span>(<span class="attr">fontSize</span>: <span class="title function_ invoke__">setSp</span>(<span class="number">28</span>)),</span><br><span class="line">      <span class="attr">contentPadding</span>: EdgeInsets.<span class="title function_ invoke__">symmetric</span>(<span class="attr">horizontal</span>: <span class="title function_ invoke__">setWidth</span>(<span class="number">31</span>)),</span><br><span class="line">      <span class="attr">filled</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">fillColor</span>: currentTheme.primaryColorDark,</span><br><span class="line">      <span class="attr">border</span>: <span class="title function_ invoke__">OutlineInputBorder</span>(</span><br><span class="line">          <span class="attr">borderRadius</span>: BorderRadius.<span class="title function_ invoke__">circular</span>(<span class="title function_ invoke__">setWidth</span>(<span class="number">30</span>)),</span><br><span class="line">          <span class="attr">borderSide</span>: BorderSide.none</span><br><span class="line">      ),</span><br><span class="line">    ),</span><br><span class="line">    <span class="attr">onSubmitted</span>: (value) &#123;&#125;,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  Widget <span class="title function_ invoke__">buildTextFieldPage</span>(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> SizedBox.<span class="title function_ invoke__">expand</span>(</span><br><span class="line">      <span class="attr">child</span>: <span class="title function_ invoke__">Stack</span>(</span><br><span class="line">        <span class="attr">alignment</span>: Alignment.bottomLeft,</span><br><span class="line">        <span class="attr">children</span>: &lt;Widget&gt;[</span><br><span class="line">          Positioned.<span class="title function_ invoke__">fill</span>(</span><br><span class="line">            <span class="attr">child</span>: <span class="title function_ invoke__">GestureDetector</span>(</span><br><span class="line">              <span class="attr">behavior</span>: HitTestBehavior.opaque,</span><br><span class="line">              <span class="attr">onTap</span>: () =&gt; Navigator.<span class="title function_ invoke__">pop</span>(context),</span><br><span class="line">              <span class="attr">child</span>: <span class="title function_ invoke__">Container</span>(<span class="attr">color</span>: Colors.black.<span class="title function_ invoke__">withOpacity</span>(<span class="number">.5</span>)),</span><br><span class="line">            ),</span><br><span class="line">          ),</span><br><span class="line">          <span class="title function_ invoke__">buildInput</span>(),</span><br><span class="line">        ],</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_ invoke__">buildInput</span>(&#123;hasTextField = <span class="literal">true</span>&#125;) &#123;</span><br><span class="line">    Widget child;</span><br><span class="line"></span><br><span class="line">    child = hasTextField</span><br><span class="line">        ? <span class="title function_ invoke__">Container</span>(</span><br><span class="line">            <span class="attr">decoration</span>: <span class="title function_ invoke__">BoxDecoration</span>(</span><br><span class="line">              <span class="attr">color</span>: currentTheme.backgroundColor,</span><br><span class="line">              <span class="attr">borderRadius</span>: BorderRadius.<span class="title function_ invoke__">circular</span>(<span class="title function_ invoke__">setWidth</span>(<span class="number">31</span>)),</span><br><span class="line">            ),</span><br><span class="line">            <span class="attr">child</span>: textField,</span><br><span class="line">          )</span><br><span class="line">        : <span class="title function_ invoke__">GestureDetector</span>(</span><br><span class="line">            <span class="attr">onTap</span>: () &#123;</span><br><span class="line">              <span class="title function_ invoke__">showBottomSheet</span>(</span><br><span class="line">                <span class="attr">context</span>: context,</span><br><span class="line">                <span class="attr">backgroundColor</span>: Colors.transparent,</span><br><span class="line">                <span class="attr">builder</span>: buildTextFieldPage,</span><br><span class="line">              );</span><br><span class="line">            &#125;,</span><br><span class="line">            child: <span class="title function_ invoke__">Container</span>(</span><br><span class="line">              <span class="attr">decoration</span>: <span class="title function_ invoke__">BoxDecoration</span>(</span><br><span class="line">                <span class="attr">color</span>: currentTheme.backgroundColor,</span><br><span class="line">                <span class="attr">borderRadius</span>: BorderRadius.<span class="title function_ invoke__">circular</span>(<span class="title function_ invoke__">setWidth</span>(<span class="number">31</span>)),</span><br><span class="line">              ),</span><br><span class="line">            ),</span><br><span class="line">          );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">Container</span>(</span><br><span class="line">      <span class="attr">height</span>: <span class="title function_ invoke__">setWidth</span>(<span class="number">103</span>),</span><br><span class="line">      <span class="attr">padding</span>: EdgeInsets.<span class="title function_ invoke__">symmetric</span>(</span><br><span class="line">        <span class="attr">vertical</span>: <span class="title function_ invoke__">setWidth</span>(<span class="number">20</span>),</span><br><span class="line">        <span class="attr">horizontal</span>: <span class="title function_ invoke__">setWidth</span>(<span class="number">25</span>),</span><br><span class="line">      ),</span><br><span class="line">      <span class="attr">decoration</span>: <span class="title function_ invoke__">BoxDecoration</span>(</span><br><span class="line">        <span class="attr">border</span>: <span class="title function_ invoke__">Border</span>(<span class="attr">top</span>: commentDivider),</span><br><span class="line">        <span class="attr">color</span>: currentTheme.primaryColor,</span><br><span class="line">      ),</span><br><span class="line">      <span class="attr">child</span>: <span class="title function_ invoke__">Row</span>(</span><br><span class="line">        <span class="attr">children</span>: &lt;Widget&gt;[</span><br><span class="line">          <span class="title function_ invoke__">Expanded</span>(<span class="attr">child</span>: child),</span><br><span class="line">          <span class="title function_ invoke__">Container</span>(</span><br><span class="line">            <span class="attr">width</span>: <span class="title function_ invoke__">setWidth</span>(<span class="number">66</span>),</span><br><span class="line">            <span class="attr">padding</span>: EdgeInsets.<span class="title function_ invoke__">only</span>(<span class="attr">left</span>: <span class="title function_ invoke__">setWidth</span>(<span class="number">25</span>)),</span><br><span class="line">            <span class="attr">alignment</span>: Alignment.center,</span><br><span class="line">            <span class="attr">child</span>: <span class="title function_ invoke__">Icon</span>(</span><br><span class="line">              IcoMoon.send,</span><br><span class="line">              <span class="attr">color</span>: currentTheme.hoverColor.<span class="title function_ invoke__">withOpacity</span>(<span class="number">.5</span>),</span><br><span class="line">              <span class="attr">size</span>: <span class="title function_ invoke__">setWidth</span>(<span class="number">42</span>),</span><br><span class="line">            ),</span><br><span class="line">          ),</span><br><span class="line">        ],</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>相关效果如下：</p>
<p>![input.gif](data:image&#x2F;svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="599" height="1238"/>)</p>
<h2 id="TextField-如何根据内容自适应高度"><a href="#TextField-如何根据内容自适应高度" class="headerlink" title="TextField 如何根据内容自适应高度"></a>TextField 如何根据内容自适应高度</h2><p><code>TextField</code> 在最大行数为一行时，可以直接通过父级 <code>Container</code> 限制 <code>TextField</code> 的高度，不需要设置额外属性，但是在多行高度时，这种做法就不太灵验。</p>
<p>可以看到上图中评论框会根据输出的内容自动调整高度，并且限制了最大行数为 4，而这种需求又是特别常见的，我是如何做到的呢？</p>
<p>首先，需要设置 <code>TextField</code> 的 <code>maxLine</code> 属性为 <code>null</code>，这样 <code>TextField</code> 就会根据内容自动调整高度</p>
<p>接着，设置 <code>decoration: InputDecoration(isDense:true)</code>，这样 <code>TextField</code> 将允许我们限制 <code>TexField</code> 的最大高度</p>
<p>最后，利用父级容器限制 <code>TextField</code> 的最大高度，例如</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Container</span>(</span><br><span class="line">  <span class="attribute">constraints</span>: BoxConstraints(<span class="attribute">maxHeight</span>: <span class="number">200</span>),</span><br><span class="line">  <span class="attribute">child</span>: TextField(),</span><br><span class="line">)</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>通过以上设置后， <code>TextField</code> 的高度就是根据内容自动适应，并且会被限制最大高度，但是还需要说明一点，如何保证最大高度刚好是 4 行的高度？</p>
<p>由于 <code>TextField</code> 没有属性是用来限制每行高度的，所以这就需要我们自己计算 <code>contentPadding</code> 了，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">decoration: <span class="title function_ invoke__">InputDecoration</span>(</span><br><span class="line">  <span class="attr">isDense</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">contentPadding</span>: EdgeInsets.<span class="title function_ invoke__">symmetric</span>(<span class="attr">vertical</span>: <span class="number">20</span>),</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<h2 id="TextField-设置-border-不生效"><a href="#TextField-设置-border-不生效" class="headerlink" title="TextField 设置 border 不生效"></a>TextField 设置 border 不生效</h2><p>TextField 的 <code>border</code> 有如下 3 种，需要针对性地设置，只设置一个是无法生效的：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">decoration: <span class="constructor">InputDecoration(<span class="params">border</span> <span class="params">enabledBorder</span> <span class="params">focusBorder</span>)</span></span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>ps：设置 <code>maxLength</code> 属性后，<code>decoration</code> 里需要设置 <code>counterText: &#39;&#39;</code>，否则默认会附带一个统计字数的样式。</p>
<h1 id="路由跳转相关问题"><a href="#路由跳转相关问题" class="headerlink" title="路由跳转相关问题"></a>路由跳转相关问题</h1><h2 id="push、pop-常见需求"><a href="#push、pop-常见需求" class="headerlink" title="push、pop 常见需求"></a>push、pop 常见需求</h2><p>例如浏览记录中有如下 4 个页面，当前页面为 <code>d</code>：</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">a</span>-&gt;</span><span class="function"><span class="title">b</span>-&gt;</span><span class="function"><span class="title">c</span>-&gt;</span>d</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>在当前页面使用 <code>Navigator.popUtil(context, ModalRoute.withName(&#39;a&#39;))</code>，可以直接返回至 <code>a</code> 页面，并销毁 <code>b</code>、<code>c</code> 页面。</p>
<p>在当前页面使用 <code>Navigator.pushNamedAndRemoveUntil(context, &#39;e&#39;, (route) =&gt; false)</code>，可以进入 <code>e</code> 页面之前，销毁所有历史记录，即 <code>e</code> 页面变成第一页，<code>e</code> 页面里无法继续 <code>pop</code> 返回上一页。</p>
<h2 id="如何在-initState-阶段就能使用-context"><a href="#如何在-initState-阶段就能使用-context" class="headerlink" title="如何在 initState 阶段就能使用 context"></a>如何在 initState 阶段就能使用 context</h2><p>Flutter 有一些需要使用 <code>context</code> 的方法，例如 <code>Theme.of(context)</code>、<code>Navigator.of(context)</code> 等等，一般情况下，我们需要在 build 方法中才能拿到 <code>context</code>，如果我们在定义类的属性时就直接使用 <code>Theme.of(context)</code> 显然是没办法做到的，编辑器都会直接提示语法错误。</p>
<p>解决办法也很简单，首先创建一个文件 <code>constants.dart</code> 用于保存项目的全局变量，在 <code>Contants</code> 类中声明一个 <code>navigatorKey</code>：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Constants</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="type">GlobalKey</span>&lt;<span class="type">NavigatorState</span>&gt; navigatorKey <span class="operator">=</span> <span class="type">GlobalKey</span>&lt;<span class="type">NavigatorState</span>&gt;();</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>接着在 <code>MaterailApp</code> 下挂载 <code>navigatorKey</code> ：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor">MaterialApp(<span class="params">navigatorKey</span>: Constants.<span class="params">navigatorKey</span>)</span></span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>最后在 <code>constants.dart</code> 中声明如下 3 个 <code>getter</code>：</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NavigatorState get navigatorState <span class="operator">=</span>&gt; Constants.navigatorKey.currentState<span class="comment">;</span></span><br><span class="line">BuildContext get currentContext <span class="operator">=</span>&gt; navigatorState.context<span class="comment">;</span></span><br><span class="line">ThemeData get currentTheme <span class="operator">=</span>&gt; Theme.of(currentContext)<span class="comment">;</span></span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>由于所有组件都是挂载在 <code>MaterialApp</code> 下的，所以我们在任何一个组件中引入了 <code>constants.dart</code>，就可以使用这 3 个 <code>getter</code>，用法如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginPage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> box = <span class="type">GestureDetector</span>(</span><br><span class="line">    onTap: navigatorState.pop,</span><br><span class="line">    child: <span class="type">Text</span>(&#x27;返回上一页&#x27;),</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">final</span> userModel = <span class="type">Provider</span>.of&lt;<span class="type">UserModel</span>&gt;(currentContext, listen: <span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">final</span> primaryColor = currentTheme.primaryColor;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>上面的代码等价于：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginPage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="type">Widget</span> box;</span><br><span class="line">  <span class="type">UserModel</span> userModel;</span><br><span class="line">  <span class="type">Color</span> primaryColor;</span><br><span class="line">  </span><br><span class="line">  build(context) &#123;</span><br><span class="line">    box = <span class="type">GestureDetector</span>(</span><br><span class="line">      onTap: <span class="type">Navigator</span>.of(context).pop,</span><br><span class="line">      child: <span class="type">Text</span>(&#x27;返回上一页&#x27;),</span><br><span class="line">    );</span><br><span class="line">    userModel = <span class="type">Provider</span>.of&lt;<span class="type">UserModel</span>&gt;(context, listen: <span class="literal">false</span>);</span><br><span class="line">    primaryColor = <span class="type">Theme</span>.of(context).primaryColor;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>





<h1 id="Mac-环境-build-时的错误"><a href="#Mac-环境-build-时的错误" class="headerlink" title="Mac 环境 build 时的错误"></a>Mac 环境 build 时的错误</h1><p>提示如下：</p>
<p>Automatically assigning platform <code>iOS</code> with version <code>9.0</code> on target <code>Runner</code> because no platform was specified. Please specify a platform for this target in your Podfile.</p>
<p>解决办法是：删除 <code>pod</code> 文件中 <code>platform</code>前的 <code>#</code></p>
<p>因为没有做过原生开发，所以对于这种 build 问题真的是一脸茫然，最开始遇到过几次类似错误，我通过网上搜索答案、群里问大佬来解决，非常之麻烦。所以后来我在 Mac 环境 build 产生错误时，都是直接重建项目，把逻辑代码复制进新项目里，再重新 build 就不会发生各种乱七八糟看不懂的错误了，效率也快。</p>
<h1 id="PageView、ListView-等滚动组件切换页面返回后的高度位置被改变了"><a href="#PageView、ListView-等滚动组件切换页面返回后的高度位置被改变了" class="headerlink" title="PageView、ListView 等滚动组件切换页面返回后的高度位置被改变了"></a>PageView、ListView 等滚动组件切换页面返回后的高度位置被改变了</h1><p>解决办法：给滚动组件加上 <code>key</code> 属性，用于保存位置信息，例如： <code>key: PageStorageKey(1)</code></p>
<p>其实一般的 ListView 还无法满足我们日常开发中各种花式的需求，推荐使用法佬的 <a target="_blank" rel="noopener" href="https://github.com/fluttercandies/extended_nested_scroll_view">NestedScrollView</a></p>
<p>法佬已经给我们解决了很多奇怪的 bug，还要什么自行车？</p>
<h1 id="如何监听-App-返回桌面事件"><a href="#如何监听-App-返回桌面事件" class="headerlink" title="如何监听 App 返回桌面事件"></a>如何监听 App 返回桌面事件</h1><p>我需要当 app 返回桌面时暂停视频的播放，从桌面返回 app 后再继续播放，解决方案如下：</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class _DemoState extends State<span class="variable">&lt;Demo&gt;</span> with WidgetsBindingObserver &#123;</span><br><span class="line">  @override</span><br><span class="line">  void didChangeAppLifecycleState(AppLifecycleState <span class="keyword">state</span>) &#123;</span><br><span class="line">    print(&#x27;app lifecycle <span class="keyword">state</span>: <span class="variable">$state</span>&#x27;);</span><br><span class="line">    if (<span class="keyword">state</span> == AppLifecycleState.inactive) &#123;</span><br><span class="line">      _playerModel.pausePlayer();</span><br><span class="line">    &#125; else if (<span class="keyword">state</span> == AppLifecycleState.resumed) &#123;</span><br><span class="line">      if (_homeModel.isFindPage) _playerModel.startPlayer();</span><br><span class="line">    &#125;</span><br><span class="line">    super.didChangeAppLifecycleState(<span class="keyword">state</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>WidgetsBindingObserver 这个类我经常使用，例如监听键盘弹起事件也会用到这个类。</p>
<h1 id="Dio-小技巧"><a href="#Dio-小技巧" class="headerlink" title="Dio 小技巧"></a>Dio 小技巧</h1><p>使用 Dio 进行 HTTP 请求时，请求头 <code>content-type</code> 的默认值是</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">application/json; <span class="attribute">charset</span>=utf-8</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>如果返回头的 <code>content-type</code> 是</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">application</span>/json</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>Dio 将自动解析返回 json 数据为 Dart 相应的数据类型，而不需要手动地调用 <code>jsonDecode</code> 方法，所以客户端、服务端的统一使用 <code>application/json</code> 作为  <code>content-type</code>，他好我也好。</p>
<h1 id="Android-打包后无法进行网络请求"><a href="#Android-打包后无法进行网络请求" class="headerlink" title="Android 打包后无法进行网络请求"></a>Android 打包后无法进行网络请求</h1><p>在我第一次使用 Flutter 打包项目时遇到了这个问题，最后发现是没有网络请求的权限，类似的，储存读取本地文件时可能也会有类似问题，这种问题设置权限就可以解决了。</p>
<p>在 <code>android/app/src/profile/AndroidManifest.xml</code> 中</p>
<p>以及 <code>android/app/src/main/AndroidManifest.xml</code> 两个文件的 <code>manifest</code> 标签内添加如下子标签即可：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.READ_PHONE_STATE&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.ACCESS_NETWORK_STATE&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.ACCESS_WIFI_STATE&quot;</span> /&gt;</span></span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>





<h1 id="对于类中的属性和方法的定义规范的一些建议"><a href="#对于类中的属性和方法的定义规范的一些建议" class="headerlink" title="对于类中的属性和方法的定义规范的一些建议"></a>对于类中的属性和方法的定义规范的一些建议</h1><ul>
<li>不引用其他属性的成员，定义为属性</li>
<li>引用其他属性，且不接收参数的成员，定义为getter</li>
<li>引用其他属性，且接受参数的成员，定义为function</li>
</ul>
<h1 id="全屏相关设置"><a href="#全屏相关设置" class="headerlink" title="全屏相关设置"></a>全屏相关设置</h1><p>强制竖屏：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">void <span class="built_in">initState</span>() &#123;</span><br><span class="line">  SystemChrome<span class="selector-class">.setPreferredOrientations</span>([</span><br><span class="line">    DeviceOrientation.portraitUp,</span><br><span class="line">    DeviceOrientation.portraitDown</span><br><span class="line">  ]);</span><br><span class="line">  super<span class="selector-class">.initState</span>();</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>强制横屏：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">initState</span>() &#123;</span><br><span class="line">  SystemChrome<span class="selector-class">.setPreferredOrientations</span>([</span><br><span class="line">    DeviceOrientation.landscapeLeft,</span><br><span class="line">    DeviceOrientation.landscapeRight</span><br><span class="line">  ]);</span><br><span class="line">  super<span class="selector-class">.initState</span>();</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>







<h1 id="Transform-3D-转换"><a href="#Transform-3D-转换" class="headerlink" title="Transform 3D 转换"></a>Transform 3D 转换</h1><p>推荐使用 <code>Transform</code> 组件来完成动画效果，例如 <code>Transform.translate</code> 和  <code>Transform.scale</code> 可以完成位置、缩放的变化， <code>Transform.rotate</code>  可以完成旋转角度的变化。</p>
<p><code>Transform.rotate</code>  和 <code>RotateBox</code> 都可以完成旋转功能，他们之间有什么区别？</p>
<p>使用 <code>RotateBox</code> 渲染 widget 是在 layout 阶段，渲染完毕后就会占用实际位置，而 <code>Transform</code> 组件则是在 layout 之后的绘制阶段， <code>Transform</code> 只是一个视觉效果，实际所占空间大小是 transform 变化之前所占用的空间大小，所以重新渲染 <code>Transform.rotate</code> 组件比重新渲染 <code>RotateBox</code> 开销更小。</p>
<p>Flutter 的 <code>Transform</code> 组件的这个特性和 CSS 的 <code>transform</code> 属性非常相似，都可以用来提升动画性能。</p>
<p>不过做视频全屏功能时，可以用 <code>IndexedStack</code> + <code>RotateBox</code> 替代 push 一个横屏的路由的做法，<code>RotateBox</code> 它会使容器填充全屏，而 <code>IndexedStack</code> 可以控制是否显示全屏，这里如果使用 <code>Transform</code> 则无法填充全屏，因为容器的宽高在 layout 时就已经确定了，所以只能使用 <code>RotateBox</code>。</p>
<h2 id="视频镜像翻转"><a href="#视频镜像翻转" class="headerlink" title="视频镜像翻转"></a>视频镜像翻转</h2><p>我在项目中不仅使用 RotatedBox 完成视频全屏功能，还利用了 <code>Transform</code> 来完成镜像翻转功能，写法如下：</p>
<figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Selector&lt;VideoModel, bool&gt;(</span><br><span class="line">  <span class="name">selector</span>: <span class="function"><span class="params">(context, model)</span> =&gt;</span> model.isMirror,</span><br><span class="line">    <span class="name">builder</span>: <span class="function"><span class="params">(context, isMirror, child)</span> =&gt;</span> Transform(</span><br><span class="line">      <span class="name">alignment</span>: Alignment.center,</span><br><span class="line">      <span class="name">transform</span>: Matrix4.identity()..setEntry(<span class="number">3</span>, <span class="number">2</span>, <span class="number">0.006</span>)..rotateY(isMirror ? <span class="built_in">math</span>.pi : <span class="number">0</span>),</span><br><span class="line">      <span class="name">child</span>: child,</span><br><span class="line">    ),</span><br><span class="line">    <span class="name">child</span>: FijkView(</span><br><span class="line">    <span class="name">player</span>: model.player,</span><br><span class="line">    <span class="name">color</span>: Colors.black,</span><br><span class="line">    <span class="name">panelBuilder</span>: <span class="function"><span class="params">(player, context, size, pos)</span> =&gt;</span> emptyBox,</span><br><span class="line">  ),</span><br><span class="line">)</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>原理很简单，FijkView 是 fijkplayer 提供的视频容器，我将视频容器以中心位置为圆心，沿 Y 轴做一个 180 度的旋转，即可满足需求。</p>
<p><code>setEntry</code> 用于设置透视，否则将无法看到 Y 轴及 X 轴的立体转换效果</p>
<p><code>rotateY</code> 则与 css 中的 <code>rotateY</code> 是相同含义，即沿 Y 轴旋转。在 css 中可以设置 <code>transform: rotateY(180deg)</code> 来达到相同的效果。</p>
<h1 id="状态栏相关设置"><a href="#状态栏相关设置" class="headerlink" title="状态栏相关设置"></a>状态栏相关设置</h1><p>隐藏状态栏：</p>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import <span class="string">&#x27;package:flutter/services.dart&#x27;</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">void toggleFullscreen() &#123;</span><br><span class="line">  _isFullscreen = !_isFullscreen<span class="comment">;</span></span><br><span class="line">  _isFullscreen</span><br><span class="line">      ? <span class="params">System</span>Chrome.setEnabled<span class="params">System</span>UIOverlays([])</span><br><span class="line">      : <span class="params">System</span>Chrome.setEnabled<span class="params">System</span>UIOverlays(<span class="params">System</span>UiOverlay.values)<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>改变状态栏颜色，则需要使用插件：<code>flutter_statusbarcolor</code>，下面是用法示例：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 改变状态栏背景颜色，默认改变为透明</span></span><br><span class="line"><span class="function">Future&lt;<span class="keyword">void</span>&gt; <span class="title">changeStatusColor</span>(<span class="params">&#123;Color color: Colors.transparent&#125;</span>) <span class="keyword">async</span></span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> FlutterStatusbarcolor.setStatusBarColor(</span><br><span class="line">      color,</span><br><span class="line">      animate: <span class="literal">true</span>,</span><br><span class="line">    );</span><br><span class="line">    FlutterStatusbarcolor.setStatusBarWhiteForeground(<span class="literal">true</span>);</span><br><span class="line">    FlutterStatusbarcolor.setNavigationBarWhiteForeground(<span class="literal">true</span>);</span><br><span class="line">  &#125; <span class="function"><span class="keyword">on</span> PlatformException <span class="title">catch</span> (<span class="params">e</span>)</span> &#123;</span><br><span class="line">    debugPrint(e.toString());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>下面介绍一个用法，我的 home 页使用 <code>indexStack</code>  组件包含了 4 个 tab 页，每次更改 tab 会改变 <code>currentHomeTab</code> 的值，但不会触发重新 build，而由于路由 <code>push</code> 或 <code>pop</code> 又会触发重新 build，所以如果需要当进入 home 页的 <code>发现 tab 页</code> 时改变为黑色状态栏，则可以用下面这种做法：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在发现页的 build 方法里进行判断</span></span><br><span class="line">@override</span><br><span class="line">Widget build(BuildContext context) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="module-access"><span class="module"><span class="identifier">ModalRoute</span>.</span></span><span class="keyword">of</span>(context).isCurrent<span class="operator"> &amp;&amp; </span>currentHomeTab<span class="operator"> == </span>&#x27;发现&#x27;) &#123;</span><br><span class="line">    change<span class="constructor">StatusColor(<span class="params">color</span>: Colors.<span class="params">black</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>







<h1 id="fijkplayer-秒开、进度跳转等优化"><a href="#fijkplayer-秒开、进度跳转等优化" class="headerlink" title="fijkplayer 秒开、进度跳转等优化"></a>fijkplayer 秒开、进度跳转等优化</h1><p>fijkplayer 默认情况下，进度跳转、播放可能会有性能问题，针对这些问题，可以进行以下优化：</p>
<figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">_player.setDataSource(_video.src);</span><br><span class="line">await _player.applyOptions(</span><br><span class="line">    FijkOptio<span class="meta">n</span>()</span><br><span class="line">      ..setFormatOptio<span class="meta">n</span>(<span class="string">&#x27;flush_packets&#x27;</span>, 1)</span><br><span class="line">      ..setFormatOptio<span class="meta">n</span>(<span class="string">&#x27;analyzemaxduration&#x27;</span>, 100)</span><br><span class="line">      ..setFormatOptio<span class="meta">n</span>(<span class="string">&#x27;analyzeduration&#x27;</span>, 1)</span><br><span class="line">      ..setCodecOptio<span class="meta">n</span>(<span class="string">&#x27;skip_loop_filter&#x27;</span>, 48)</span><br><span class="line">      ..setPlayerOptio<span class="meta">n</span>(<span class="string">&#x27;start-on-prepared&#x27;</span>, 1)</span><br><span class="line">      ..setPlayerOptio<span class="meta">n</span>(<span class="string">&#x27;packet-buffering&#x27;</span>, 0)</span><br><span class="line">      ..setPlayerOptio<span class="meta">n</span>(<span class="string">&#x27;framedrop&#x27;</span>, 1)</span><br><span class="line">      ..setPlayerOptio<span class="meta">n</span>(<span class="string">&#x27;enable-accurate-seek&#x27;</span>, 1)</span><br><span class="line">      ..setPlayerOptio<span class="meta">n</span>(<span class="string">&#x27;find_stream_info&#x27;</span>, 0)</span><br><span class="line">      ..setPlayerOptio<span class="meta">n</span>(<span class="string">&#x27;render-wait-start&#x27;</span>, 1)</span><br><span class="line">);</span><br><span class="line">await _player.prepareAsync();</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>参考链接：</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/c8c755ed61ee">IjkPlayer 起播速度优化</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/843c86a9e9ad">IjkPlayer 播放器秒开优化以及常用 Option 设置</a></p>
<h1 id="LayoutBuilder-相关的实践"><a href="#LayoutBuilder-相关的实践" class="headerlink" title="LayoutBuilder 相关的实践"></a>LayoutBuilder 相关的实践</h1><h2 id="如何实现微信朋友圈、哔哩哔哩评论的多行文本收起、展开功能"><a href="#如何实现微信朋友圈、哔哩哔哩评论的多行文本收起、展开功能" class="headerlink" title="如何实现微信朋友圈、哔哩哔哩评论的多行文本收起、展开功能"></a>如何实现微信朋友圈、哔哩哔哩评论的多行文本收起、展开功能</h2><p>我写了下面这个工具类，简单、好用得我都枯了，原理是利用先 <code>LayoutBuilder</code> 判断是否超出指定的行数，如果超出则返回 <code>Column</code>，如果未超出则返回原 widget</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line">import <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExpandableText</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> String text;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> maxLines;</span><br><span class="line">  <span class="keyword">final</span> TextStyle style;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">bool</span> expand;</span><br><span class="line">  <span class="keyword">final</span> TextStyle markerStyle;</span><br><span class="line">  <span class="keyword">final</span> String atName;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="variable constant_">ExpandableText</span>(this.text, &#123;</span><br><span class="line">    Key key,</span><br><span class="line">    this.maxLines,</span><br><span class="line">    this.style,</span><br><span class="line">    this.markerStyle,</span><br><span class="line">    this.expand = <span class="literal">false</span>,</span><br><span class="line">    this.atName = <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  &#125;) : <span class="title function_ invoke__">super</span>(<span class="attr">key</span>: key);</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  <span class="title function_ invoke__">createState</span>() =&gt; <span class="title function_ invoke__">_ExpandableTextState</span>();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_ExpandableTextState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">ExpandableText</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">bool</span> expand;</span><br><span class="line">  TextStyle style;</span><br><span class="line">  <span class="keyword">int</span> maxLines;</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  <span class="keyword">void</span> <span class="title function_ invoke__">initState</span>() &#123;</span><br><span class="line">    expand = widget.expand;</span><br><span class="line">    style = widget.style;</span><br><span class="line">    maxLines = widget.maxLines;</span><br><span class="line">    super.<span class="title function_ invoke__">initState</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Widget <span class="title function_ invoke__">buildOrdinaryText</span>() &#123;</span><br><span class="line">    <span class="keyword">final</span> text = widget.text;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">LayoutBuilder</span>(<span class="attr">builder</span>: (_, size) &#123;</span><br><span class="line">      <span class="keyword">final</span> tp = <span class="title function_ invoke__">TextPainter</span>(</span><br><span class="line">        <span class="attr">text</span>: <span class="title function_ invoke__">TextSpan</span>(<span class="attr">text</span>: text, <span class="attr">style</span>: style),</span><br><span class="line">        <span class="attr">maxLines</span>: maxLines,</span><br><span class="line">        <span class="attr">textDirection</span>: TextDirection.ltr,</span><br><span class="line">      );</span><br><span class="line">      tp.<span class="title function_ invoke__">layout</span>(<span class="attr">maxWidth</span>: size.maxWidth);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!tp.didExceedMaxLines) <span class="keyword">return</span> <span class="title function_ invoke__">Text</span>(text, <span class="attr">style</span>: style);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="title function_ invoke__">Builder</span>(</span><br><span class="line">        <span class="attr">builder</span>: (context) =&gt; <span class="title function_ invoke__">Column</span>(</span><br><span class="line">          <span class="attr">crossAxisAlignment</span>: CrossAxisAlignment.start,</span><br><span class="line">          <span class="attr">children</span>: &lt;Widget&gt;[</span><br><span class="line">            <span class="title function_ invoke__">Text</span>(text, <span class="attr">maxLines</span>: expand ? <span class="literal">null</span> : widget.maxLines, <span class="attr">style</span>: style),</span><br><span class="line">            <span class="title function_ invoke__">GestureDetector</span>(</span><br><span class="line">              <span class="attr">onTap</span>: () &#123;</span><br><span class="line">                expand = !expand;</span><br><span class="line">                (context <span class="keyword">as</span> Element).<span class="title function_ invoke__">markNeedsBuild</span>();</span><br><span class="line">              &#125;,</span><br><span class="line">              child: <span class="title function_ invoke__">Text</span>(</span><br><span class="line">                expand ? <span class="string">&#x27;收起&#x27;</span> : <span class="string">&#x27;展开&#x27;</span>,</span><br><span class="line">                <span class="attr">style</span>: widget.markerStyle,</span><br><span class="line">              ),</span><br><span class="line">            ),</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">      );</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Widget <span class="title function_ invoke__">buildAtText</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">LayoutBuilder</span>(<span class="attr">builder</span>: (_, size) &#123;</span><br><span class="line">      <span class="keyword">final</span> tp = <span class="title function_ invoke__">TextPainter</span>(</span><br><span class="line">        <span class="attr">text</span>: <span class="title function_ invoke__">TextSpan</span>(<span class="attr">text</span>: <span class="string">&#x27;回复 @$&#123;widget.text&#125;：&#x27;</span>, <span class="attr">style</span>: style),</span><br><span class="line">        <span class="attr">maxLines</span>: maxLines,</span><br><span class="line">        <span class="attr">textDirection</span>: TextDirection.ltr,</span><br><span class="line">      );</span><br><span class="line">      tp.<span class="title function_ invoke__">layout</span>(<span class="attr">maxWidth</span>: size.maxWidth);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!tp.didExceedMaxLines) <span class="keyword">return</span> Text.<span class="title function_ invoke__">rich</span>(</span><br><span class="line">        <span class="title function_ invoke__">TextSpan</span>(</span><br><span class="line">          <span class="attr">children</span>: [</span><br><span class="line">            <span class="title function_ invoke__">TextSpan</span>(<span class="attr">text</span>: <span class="string">&#x27;回复 &#x27;</span>),</span><br><span class="line">            <span class="title function_ invoke__">TextSpan</span>(<span class="attr">text</span>: <span class="string">&#x27;@$&#123;widget.atName&#125;&#x27;</span>, <span class="attr">style</span>: widget.markerStyle),</span><br><span class="line">            <span class="title function_ invoke__">TextSpan</span>(<span class="attr">text</span>: <span class="string">&#x27;：$&#123;widget.text&#125;&#x27;</span>),</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">        <span class="attr">style</span>: style,</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="title function_ invoke__">Builder</span>(</span><br><span class="line">        <span class="attr">builder</span>: (context) =&gt; <span class="title function_ invoke__">Column</span>(</span><br><span class="line">          <span class="attr">crossAxisAlignment</span>: CrossAxisAlignment.start,</span><br><span class="line">          <span class="attr">children</span>: &lt;Widget&gt;[</span><br><span class="line">            Text.<span class="title function_ invoke__">rich</span>(</span><br><span class="line">              <span class="title function_ invoke__">TextSpan</span>(</span><br><span class="line">                <span class="attr">children</span>: [</span><br><span class="line">                  <span class="title function_ invoke__">TextSpan</span>(<span class="attr">text</span>: <span class="string">&#x27;回复 &#x27;</span>),</span><br><span class="line">                  <span class="title function_ invoke__">TextSpan</span>(<span class="attr">text</span>: <span class="string">&#x27;@$&#123;widget.atName&#125;&#x27;</span>, <span class="attr">style</span>: widget.markerStyle),</span><br><span class="line">                  <span class="title function_ invoke__">TextSpan</span>(<span class="attr">text</span>: <span class="string">&#x27;：$&#123;widget.text&#125;&#x27;</span>),</span><br><span class="line">                ],</span><br><span class="line">              ),</span><br><span class="line">              <span class="attr">maxLines</span>: expand ? <span class="literal">null</span> : widget.maxLines,</span><br><span class="line">              <span class="attr">style</span>: style,</span><br><span class="line">            ),</span><br><span class="line">            <span class="title function_ invoke__">GestureDetector</span>(</span><br><span class="line">              <span class="attr">onTap</span>: () &#123;</span><br><span class="line">                expand = !expand;</span><br><span class="line">                (context <span class="keyword">as</span> Element).<span class="title function_ invoke__">markNeedsBuild</span>();</span><br><span class="line">              &#125;,</span><br><span class="line">              child: <span class="title function_ invoke__">Text</span>(</span><br><span class="line">                expand ? <span class="string">&#x27;收起&#x27;</span> : <span class="string">&#x27;展开&#x27;</span>,</span><br><span class="line">                <span class="attr">style</span>: widget.markerStyle,</span><br><span class="line">              ),</span><br><span class="line">            ),</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">      );</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  <span class="title function_ invoke__">build</span>(context) =&gt; widget.atName == <span class="string">&#x27;&#x27;</span> ? <span class="title function_ invoke__">buildOrdinaryText</span>() : <span class="title function_ invoke__">buildAtText</span>();</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>调用方法如下：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Container</span>(</span><br><span class="line">  <span class="attribute">padding</span>: EdgeInsets.only(<span class="attribute">top</span>: setWidth(<span class="number">6</span>), <span class="attribute">bottom</span>: setWidth(<span class="number">11</span>)),</span><br><span class="line">  <span class="attribute">alignment</span>: Alignment.centerLeft,</span><br><span class="line">  <span class="attribute">child</span>: ExpandableText(</span><br><span class="line">    reply.content,</span><br><span class="line">    <span class="attribute">maxLines</span>: <span class="number">4</span>,</span><br><span class="line">    <span class="attribute">style</span>: commentTextStyle,</span><br><span class="line">    <span class="attribute">markerStyle</span>: commentMarkerStyle,</span><br><span class="line">    <span class="attribute">atName</span>: reply.isDirect &gt; <span class="number">0</span> ? <span class="string">&#x27;&#x27;</span> : reply.pNickname,</span><br><span class="line">  ),</span><br><span class="line">),</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>相关效果如下：</p>
<p>![extendable.gif](data:image&#x2F;svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="599" height="750"/>)</p>
<h2 id="监听父级-widget-的实际宽高信息"><a href="#监听父级-widget-的实际宽高信息" class="headerlink" title="监听父级 widget 的实际宽高信息"></a>监听父级 widget 的实际宽高信息</h2><p>LayoutBuilder 的作用非常大，可以用它来监听某个widget的宽高信息，我在项目中遇到了 一个需求，需要根据某个 widget 的高度来弹出 BottomSheet，而这个 widget 的高度是可以滑动改变的，那么 <code>LayoutBuilder</code>  就派上用场了，做法如下：</p>
<p>需要监听的 <code>widget</code> 是 <code>Body()</code> 组件，给 Body() 组件套上一个 <code>Stack</code></p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">get <span class="keyword">body </span>=&gt; Stack(</span><br><span class="line"><span class="symbol">  children:</span> &lt;Widget&gt;[</span><br><span class="line">    <span class="keyword">Body(),</span></span><br><span class="line"><span class="keyword"></span>    <span class="keyword">BodyLayout(model),</span></span><br><span class="line"><span class="keyword"></span>  ],</span><br><span class="line">);</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>然后用 <code>BodyLayout</code> 组件来监听：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#x27;<span class="keyword">package</span>:flutter/material.dart&#x27;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#x27;<span class="keyword">package</span>:vhiphop/provider/video/video_model.dart&#x27;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BodyLayout</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="type">VideoModel</span> model;</span><br><span class="line">  <span class="type">BodyLayout</span>(<span class="keyword">this</span>.model);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="type">Widget</span> build(<span class="type">BuildContext</span> context) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">LayoutBuilder</span>(builder: (_, <span class="type">BoxConstraints</span> constraints) &#123;</span><br><span class="line">      model.bottomSheetDy = constraints.maxHeight;</span><br><span class="line">      <span class="keyword">return</span> emptyBox;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>当 <code>Body()</code> 组件高度发生变化时，会触发 <code>LayoutBuilder</code> 的 <code>builder</code> 回调函数，在此函数中将高度信息传递给 <code>model</code> ，那么每次弹出 <code>BottomSheet</code> 之前，我就可以从 model 中拿到高度，以设置 BottomSheet 的高度。</p>
<h1 id="底部弹出动画的两种实现方式"><a href="#底部弹出动画的两种实现方式" class="headerlink" title="底部弹出动画的两种实现方式"></a>底部弹出动画的两种实现方式</h1><p>这种动画在 App 中是很常见的效果，例如 App 分享功能，点击分享按钮后，会从页面底部弹出分享组件。</p>
<p>第一种，利用 <code>showModalBottomSheet</code>，相关实现代码如下：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">  <span class="selector-tag">void</span> <span class="selector-tag">showShareBottomSheet</span>() &#123;</span><br><span class="line">    <span class="selector-tag">showModalBottomSheet</span>(</span><br><span class="line">      <span class="attribute">elevation</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attribute">backgroundColor</span>: currentTheme.highlightColor,</span><br><span class="line">      <span class="attribute">context</span>: context,</span><br><span class="line">      <span class="attribute">builder</span>: (context) =&gt; Container(</span><br><span class="line">        <span class="attribute">width</span>: Screens.<span class="attribute">width</span>,</span><br><span class="line">        <span class="attribute">decoration</span>: BoxDecoration(<span class="attribute">color</span>: currentTheme.primaryColor),</span><br><span class="line">        <span class="attribute">child</span>: Column(</span><br><span class="line">          <span class="attribute">mainAxisSize</span>: MainAxisSize.min,</span><br><span class="line">          <span class="attribute">children</span>: &lt;Widget&gt;[</span><br><span class="line">            Container(</span><br><span class="line">              <span class="attribute">alignment</span>: Alignment.bottomLeft,</span><br><span class="line">              <span class="attribute">height</span>: setWidth(<span class="number">59</span>),</span><br><span class="line">              <span class="attribute">padding</span>: EdgeInsets.<span class="keyword">only</span>(<span class="attribute">left</span>: setWidth(<span class="number">42</span>)),</span><br><span class="line">              <span class="attribute">child</span>: Text(</span><br><span class="line">                <span class="string">&#x27;分享&#x27;</span>,</span><br><span class="line">                <span class="attribute">style</span>: TextStyle(</span><br><span class="line">                  <span class="attribute">fontSize</span>: setSp(<span class="number">32</span>),</span><br><span class="line">                  <span class="attribute">color</span>: currentTheme.highlightColor,</span><br><span class="line">                ),</span><br><span class="line">              ),</span><br><span class="line">            ),</span><br><span class="line">            Container(</span><br><span class="line">              <span class="attribute">height</span>: setWidth(<span class="number">206</span>),</span><br><span class="line">              <span class="attribute">padding</span>: EdgeInsets.<span class="keyword">only</span>(<span class="attribute">top</span>: setWidth(<span class="number">33</span>), <span class="attribute">left</span>: setWidth(<span class="number">33</span>)),</span><br><span class="line">              <span class="attribute">alignment</span>: Alignment.topLeft,</span><br><span class="line">              <span class="attribute">decoration</span>: BoxDecoration(</span><br><span class="line">                <span class="attribute">border</span>: Border(</span><br><span class="line">                  <span class="attribute">bottom</span>: BorderSide(</span><br><span class="line">                    <span class="attribute">width</span>: setWidth(.<span class="number">7</span>),</span><br><span class="line">                    <span class="attribute">color</span>: currentTheme.dividerColor,</span><br><span class="line">                  ),</span><br><span class="line">                ),</span><br><span class="line">              ),</span><br><span class="line">              <span class="attribute">child</span>: Row(</span><br><span class="line">                <span class="attribute">children</span>: &lt;Widget&gt;[</span><br><span class="line">                  shareIconOfQQ,</span><br><span class="line">                  shareIconOfQQZone,</span><br><span class="line">                  shareIconOfWeChat,</span><br><span class="line">                  shareIconOfWeChatMoments,</span><br><span class="line">                  shareIconOfMicroBlog,</span><br><span class="line">                ],</span><br><span class="line">              ),</span><br><span class="line">            ),</span><br><span class="line">            Container(</span><br><span class="line">              <span class="attribute">height</span>: setWidth(<span class="number">206</span>),</span><br><span class="line">              <span class="attribute">padding</span>: EdgeInsets.<span class="keyword">only</span>(<span class="attribute">top</span>: setWidth(<span class="number">33</span>), <span class="attribute">left</span>: setWidth(<span class="number">33</span>)),</span><br><span class="line">              <span class="attribute">alignment</span>: Alignment.topLeft,</span><br><span class="line">              <span class="attribute">child</span>: Row(</span><br><span class="line">                <span class="attribute">children</span>: &lt;Widget&gt;[</span><br><span class="line">                  shareIconOfLink,</span><br><span class="line">                ],</span><br><span class="line">              ),</span><br><span class="line">            ),</span><br><span class="line">            GestureDetector(</span><br><span class="line">              <span class="attribute">onTap</span>: () &#123;</span><br><span class="line">                Navigator.pop(context);</span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="attribute">child</span>: Container(</span><br><span class="line">                <span class="attribute">width</span>: Screens.<span class="attribute">width</span>,</span><br><span class="line">                <span class="attribute">height</span>: setWidth(<span class="number">125</span>),</span><br><span class="line">                <span class="attribute">alignment</span>: Alignment.center,</span><br><span class="line">                <span class="attribute">decoration</span>: BoxDecoration(</span><br><span class="line">                  <span class="attribute">border</span>: Border(</span><br><span class="line">                    <span class="attribute">top</span>: BorderSide(</span><br><span class="line">                      <span class="attribute">width</span>: setWidth(<span class="number">10</span>),</span><br><span class="line">                      <span class="attribute">color</span>: currentTheme.backgroundColor,</span><br><span class="line">                    ),</span><br><span class="line">                  ),</span><br><span class="line">                ),</span><br><span class="line">                <span class="attribute">child</span>: Text(</span><br><span class="line">                  <span class="string">&#x27;取消&#x27;</span>,</span><br><span class="line">                  <span class="attribute">style</span>: TextStyle(</span><br><span class="line">                    <span class="attribute">fontSize</span>: setSp(<span class="number">36</span>),</span><br><span class="line">                    <span class="attribute">color</span>: currentTheme.highlightColor,</span><br><span class="line">                  ),</span><br><span class="line">                ),</span><br><span class="line">              ),</span><br><span class="line">            ),</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<h2 id="使用-translate-实现"><a href="#使用-translate-实现" class="headerlink" title="使用 translate 实现"></a>使用 translate 实现</h2><p>我在项目中使用  <code>showModalBottomSheet</code> 时发现动画有点卡顿，可能是测试手机不行，只花了 1000 大洋，但咱是个倔强穷人，非要找一种性能更好的方式，那就是 <code>translate</code> 了。</p>
<p>这种方法比 <code>showModalBottomSheet</code> 动画性能更高，在我 1000 大洋的测试机 debug 模式下都非常地丝滑流畅，只是代码实现更复杂一点，并且需要依赖 Provider 来更新，我比较喜欢这种方式。</p>
<p>整个页面都使用 <code>Stack</code> 构建，而 bottomSheet 与遮罩 box 则使用 <code>Positioned</code> 定位至页面底部：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">get <span class="attr">body</span> <span class="operator">=</span>&gt; Stack(</span><br><span class="line"><span class="symbol">  children:</span> <span class="params">&lt;Widget&gt;</span>[</span><br><span class="line">    page,</span><br><span class="line">    Positioned(</span><br><span class="line"><span class="symbol">      left:</span> <span class="number">0</span>,</span><br><span class="line"><span class="symbol">      bottom:</span> <span class="number">0</span>,</span><br><span class="line"><span class="symbol">      right:</span> <span class="number">0</span>,</span><br><span class="line"><span class="symbol">      child:</span> bottomSheetBox,</span><br><span class="line">    ),</span><br><span class="line">    Positioned(</span><br><span class="line"><span class="symbol">      left:</span> <span class="number">0</span>,</span><br><span class="line"><span class="symbol">      top:</span> <span class="number">0</span>,</span><br><span class="line"><span class="symbol">      right:</span> <span class="number">0</span>,</span><br><span class="line"><span class="symbol">      bottom:</span> shareBottomSheetHeight,</span><br><span class="line"><span class="symbol">      child:</span> bottomSheetBoxMask,</span><br><span class="line">    ),</span><br><span class="line">  ],</span><br><span class="line">)<span class="punctuation">;</span></span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>接着使用我定义的一个工具类，名字叫 <code>AnimatedTranslateBox</code>，我发现 Animated 家族有各种动画组件，比如 <code>AnimatedPadding</code>、<code>AnimatedPositioned</code> 等等，唯独没有 <code>Translate</code>，不知道官方是什么意思，可能他们觉得 <code>Positioned</code>  来调整位置就够用了叭，可是 <code>translate</code> 动画性能更高，它不香吗？没关系，咱自己造了一个，代码如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#x27;<span class="keyword">package</span>:flutter/material.dart&#x27;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnimatedTranslateBox</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="type">AnimatedTranslateBox</span>(&#123;</span><br><span class="line">    <span class="type">Key</span> key,</span><br><span class="line">    <span class="keyword">this</span>.dx,</span><br><span class="line">    <span class="keyword">this</span>.dy,</span><br><span class="line">    <span class="keyword">this</span>.child,</span><br><span class="line">    <span class="keyword">this</span>.curve = <span class="type">Curves</span>.linear,</span><br><span class="line">    <span class="keyword">this</span>.duration = const <span class="type">Duration</span>(milliseconds: <span class="number">200</span>),</span><br><span class="line">    <span class="keyword">this</span>.reverseDuration,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> double dx;</span><br><span class="line">  <span class="keyword">final</span> double dy;</span><br><span class="line">  <span class="keyword">final</span> <span class="type">Widget</span> child;</span><br><span class="line">  <span class="keyword">final</span> <span class="type">Duration</span> duration;</span><br><span class="line">  <span class="keyword">final</span> <span class="type">Curve</span> curve;</span><br><span class="line">  <span class="keyword">final</span> <span class="type">Duration</span> reverseDuration;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  createState() =&gt; _AnimatedTranslateBoxState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_AnimatedTranslateBoxState</span> <span class="keyword">extends</span> <span class="title">State&lt;AnimatedTranslateBox&gt;</span></span></span><br><span class="line">    <span class="keyword">with</span> <span class="type">SingleTickerProviderStateMixin</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">AnimationController</span> controller;</span><br><span class="line">  <span class="type">Animation</span>&lt;double&gt; animation;</span><br><span class="line">  <span class="type">Tween</span>&lt;double&gt; tween;</span><br><span class="line"></span><br><span class="line">  void _updateCurve() &#123;</span><br><span class="line">    animation = widget.curve == <span class="literal">null</span></span><br><span class="line">      ? controller</span><br><span class="line">      : <span class="type">CurvedAnimation</span>(parent: controller, curve: widget.curve);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  void initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    controller = <span class="type">AnimationController</span>(</span><br><span class="line">      duration: widget.duration,</span><br><span class="line">      reverseDuration: widget.reverseDuration,</span><br><span class="line">      vsync: <span class="keyword">this</span>,</span><br><span class="line">    );</span><br><span class="line">    tween = <span class="type">Tween</span>&lt;double&gt;(begin: widget.dx ?? widget.dy);</span><br><span class="line">    _updateCurve();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  void didUpdateWidget(<span class="type">AnimatedTranslateBox</span> oldWidget) &#123;</span><br><span class="line">    <span class="keyword">super</span>.didUpdateWidget(oldWidget);</span><br><span class="line">    <span class="keyword">if</span> (widget.curve != oldWidget.curve) _updateCurve();</span><br><span class="line">    controller</span><br><span class="line">      ..duration = widget.duration</span><br><span class="line">      ..reverseDuration = widget.reverseDuration;</span><br><span class="line">    <span class="keyword">if</span> ((widget.dx ?? widget.dy) != (tween.end ?? tween.begin)) &#123;</span><br><span class="line">      tween</span><br><span class="line">        ..begin = tween.evaluate(animation)</span><br><span class="line">        ..end = widget.dx ?? widget.dy;</span><br><span class="line">      controller</span><br><span class="line">        ..value = <span class="number">0.0</span></span><br><span class="line">        ..forward();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  void dispose() &#123;</span><br><span class="line">    controller.dispose();</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  build(context) =&gt; <span class="type">AnimatedBuilder</span>(</span><br><span class="line">    animation: animation,</span><br><span class="line">    builder: (context, child) =&gt; widget.dx == <span class="literal">null</span></span><br><span class="line">        ? <span class="type">Transform</span>.translate(</span><br><span class="line">            offset: <span class="type">Offset</span>(<span class="number">0</span>, tween.animate(animation).value),</span><br><span class="line">            child: child,</span><br><span class="line">          )</span><br><span class="line">        : <span class="type">Transform</span>.translate(</span><br><span class="line">            offset: <span class="type">Offset</span>(tween.animate(animation).value, <span class="number">0</span>),</span><br><span class="line">            child: child,</span><br><span class="line">          ),</span><br><span class="line">    child: widget.child,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>调用很简单，使用 <code>Selector</code> 依赖 model 中的布尔值，用于控制显示隐藏：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">get</span> <span class="string">bottomSheetBox</span> <span class="string">=&gt;</span> <span class="string">Selector&lt;VideoModel,</span> <span class="string">bool&gt;(</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="string">(context,</span> <span class="string">model)</span> <span class="string">=&gt;</span> <span class="string">model.showBottomSheet,</span></span><br><span class="line">  <span class="attr">builder:</span> <span class="string">(context,</span> <span class="string">show,</span> <span class="string">child)</span> <span class="string">=&gt;</span> <span class="string">AnimatedOpacity(</span></span><br><span class="line">    <span class="attr">opacity:</span> <span class="string">show</span> <span class="string">?</span> <span class="attr">1 :</span> <span class="number">0</span><span class="string">,</span></span><br><span class="line">    <span class="attr">curve:</span> <span class="string">show</span> <span class="string">?</span> <span class="attr">Curves.easeOut :</span> <span class="string">Curves.easeIn,</span></span><br><span class="line">    <span class="attr">duration:</span> <span class="string">bottomSheetDuration,</span></span><br><span class="line">    <span class="attr">child:</span> <span class="string">AnimatedTranslateBox(</span></span><br><span class="line">      <span class="attr">dy:</span> <span class="string">show</span> <span class="string">?</span> <span class="attr">0 :</span> <span class="string">bottomSheetHeight,</span></span><br><span class="line">      <span class="attr">curve:</span> <span class="string">show</span> <span class="string">?</span> <span class="attr">Curves.easeOut :</span> <span class="string">Curves.easeIn,</span></span><br><span class="line">      <span class="attr">duration:</span> <span class="string">bottomSheetDuration,</span></span><br><span class="line">      <span class="attr">child:</span> <span class="string">child,</span></span><br><span class="line">    <span class="string">),</span></span><br><span class="line">  <span class="string">),</span></span><br><span class="line">  <span class="attr">child:</span> <span class="string">Container(</span></span><br><span class="line">    <span class="attr">height:</span> <span class="string">bottomSheetHeight,</span></span><br><span class="line">    <span class="attr">child:</span> <span class="string">bottomSheet,</span></span><br><span class="line">  <span class="string">),</span></span><br><span class="line"><span class="string">);</span></span><br><span class="line"><span class="string">复制代码</span></span><br></pre></td></tr></table></figure>

<p>每当 <code>dx</code> 或 <code>dy</code> 的值发生改变，<code>AnimatedTranslateBox</code> 的 child 就会根据 <code>dx</code> 或 <code>dy</code> 的值进行 y 轴 或 x 轴的移动动画。</p>
<p>相关的效果如下：</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/2/28/1708b07cd338e0ca?imageslim" alt="bottom_sheet.gif"></p>
<h1 id="Provider-调用问题"><a href="#Provider-调用问题" class="headerlink" title="Provider 调用问题"></a>Provider 调用问题</h1><p>我发现如果在 <code>MaterialApp</code> 下全局挂载了 Provider ，则在 Home 页初始化完成前，是无法使 Provider 的，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> _userModel = <span class="title function_ invoke__">UserModel</span>();</span><br><span class="line">  <span class="keyword">final</span> _homeModel = <span class="title function_ invoke__">HomeModel</span>();</span><br><span class="line"></span><br><span class="line">  Widget <span class="title function_ invoke__">build</span>(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">OKToast</span>(</span><br><span class="line">      <span class="attr">dismissOtherOnShow</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">child</span>: <span class="title function_ invoke__">MultiProvider</span>(</span><br><span class="line">        <span class="attr">providers</span>: [</span><br><span class="line">          ChangeNotifierProvider.<span class="title function_ invoke__">value</span>(<span class="attr">value</span>: _userModel),</span><br><span class="line">          ChangeNotifierProvider.<span class="title function_ invoke__">value</span>(<span class="attr">value</span>: _homeModel),</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">child</span>: Selector&lt;ThemeModel, ThemeData&gt;(</span><br><span class="line">          <span class="attr">selector</span>: (context, model) =&gt; model.theme,</span><br><span class="line">          <span class="attr">builder</span>: (context, theme, child) =&gt; <span class="title function_ invoke__">MaterialApp</span>(</span><br><span class="line">            <span class="attr">navigatorKey</span>: Constants.navigatorKey,</span><br><span class="line">            <span class="attr">debugShowCheckedModeBanner</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">theme</span>: theme,</span><br><span class="line">            <span class="attr">initialRoute</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">            <span class="attr">routes</span>: &#123;</span><br><span class="line">              <span class="string">&#x27;/&#x27;</span>: (context) =&gt; <span class="title function_ invoke__">HomePage</span>(),</span><br><span class="line">            &#125;,</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>上面的代码声明了 <code>MultiProvider</code>，如果在首页做如下调用：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@override</span><br><span class="line">init<span class="constructor">State()</span> &#123;</span><br><span class="line">  _model = <span class="module-access"><span class="module"><span class="identifier">Provider</span>.</span></span><span class="keyword">of</span>&lt;HomeModel&gt;(context);</span><br><span class="line">  _userModel = <span class="module-access"><span class="module"><span class="identifier">Provider</span>.</span></span><span class="keyword">of</span>&lt;UserModel&gt;(context);</span><br><span class="line">  super.init<span class="constructor">State()</span>;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>则会报错：</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">I</span><span class="operator">/</span><span class="variable">flutter</span> <span class="punctuation">(</span> <span class="number">8380</span><span class="punctuation">)</span><span class="operator">:</span> ══╡ <span class="variable">EXCEPTION</span> <span class="variable">CAUGHT</span> <span class="variable">BY</span> <span class="variable">WIDGETS</span> <span class="variable">LIBRARY</span> ╞═══════════════════════════════════════════════════════════</span><br><span class="line"><span class="built_in">I</span><span class="operator">/</span><span class="variable">flutter</span> <span class="punctuation">(</span> <span class="number">8380</span><span class="punctuation">)</span><span class="operator">:</span> <span class="variable">The</span> <span class="variable">following</span> <span class="variable">assertion</span> <span class="variable">was</span> <span class="variable">thrown</span> <span class="variable">building</span> <span class="variable">Builder</span><span class="operator">:</span></span><br><span class="line"><span class="built_in">I</span><span class="operator">/</span><span class="variable">flutter</span> <span class="punctuation">(</span> <span class="number">8380</span><span class="punctuation">)</span><span class="operator">:</span> <span class="variable">dependOnInheritedWidgetOfExactType</span><span class="operator">&lt;_</span><span class="variable">DefaultInheritedProviderScope</span><span class="operator">&lt;</span><span class="variable">HomeModel</span><span class="operator">&gt;&gt;</span><span class="punctuation">(</span><span class="punctuation">)</span> <span class="variable">or</span></span><br><span class="line"><span class="built_in">I</span><span class="operator">/</span><span class="variable">flutter</span> <span class="punctuation">(</span> <span class="number">8380</span><span class="punctuation">)</span><span class="operator">:</span> <span class="variable">dependOnInheritedElement</span><span class="punctuation">(</span><span class="punctuation">)</span> <span class="variable">was</span> <span class="variable">called</span> <span class="variable">before</span> <span class="type">_HomePageState</span><span class="operator">.</span><span class="variable">initState</span><span class="punctuation">(</span><span class="punctuation">)</span> <span class="variable">completed</span><span class="operator">.</span></span><br><span class="line"><span class="built_in">I</span><span class="operator">/</span><span class="variable">flutter</span> <span class="punctuation">(</span> <span class="number">8380</span><span class="punctuation">)</span><span class="operator">:</span> <span class="variable">When</span> <span class="variable">an</span> <span class="variable">inherited</span> <span class="variable">widget</span> <span class="variable">changes</span><span class="operator">,</span> <span class="variable">for</span> <span class="variable">example</span> <span class="variable">if</span> <span class="variable">the</span> <span class="variable">value</span> <span class="variable">of</span> <span class="variable">Theme</span><span class="operator">.</span><span class="variable">of</span><span class="punctuation">(</span><span class="punctuation">)</span> <span class="variable">changes</span><span class="operator">,</span> <span class="variable">its</span> <span class="variable">dependent</span></span><br><span class="line"><span class="built_in">I</span><span class="operator">/</span><span class="variable">flutter</span> <span class="punctuation">(</span> <span class="number">8380</span><span class="punctuation">)</span><span class="operator">:</span> <span class="variable">widgets</span> <span class="variable">are</span> <span class="variable">rebuilt</span><span class="operator">.</span> <span class="built_in">If</span> <span class="variable">the</span> <span class="variable">dependent</span> <span class="variable">widget</span><span class="operator">&#x27;</span><span class="variable">s</span> <span class="variable">reference</span> <span class="variable">to</span> <span class="variable">the</span> <span class="variable">inherited</span> <span class="variable">widget</span> <span class="variable">is</span> <span class="variable">in</span> <span class="variable">a</span> <span class="variable">constructor</span></span><br><span class="line"><span class="built_in">I</span><span class="operator">/</span><span class="variable">flutter</span> <span class="punctuation">(</span> <span class="number">8380</span><span class="punctuation">)</span><span class="operator">:</span> <span class="variable">or</span> <span class="variable">an</span> <span class="variable">initState</span><span class="punctuation">(</span><span class="punctuation">)</span> <span class="variable">method</span><span class="operator">,</span> <span class="variable">then</span> <span class="variable">the</span> <span class="variable">rebuilt</span> <span class="variable">dependent</span> <span class="variable">widget</span> <span class="variable">will</span> <span class="variable">not</span> <span class="variable">reflect</span> <span class="variable">the</span> <span class="variable">changes</span> <span class="variable">in</span> <span class="variable">the</span></span><br><span class="line"><span class="built_in">I</span><span class="operator">/</span><span class="variable">flutter</span> <span class="punctuation">(</span> <span class="number">8380</span><span class="punctuation">)</span><span class="operator">:</span> <span class="variable">inherited</span> <span class="variable">widget</span><span class="operator">.</span></span><br><span class="line"><span class="built_in">I</span><span class="operator">/</span><span class="variable">flutter</span> <span class="punctuation">(</span> <span class="number">8380</span><span class="punctuation">)</span><span class="operator">:</span> <span class="variable">Typically</span> <span class="variable">references</span> <span class="variable">to</span> <span class="variable">inherited</span> <span class="variable">widgets</span> <span class="variable">should</span> <span class="variable">occur</span> <span class="variable">in</span> <span class="variable">widget</span> <span class="variable">build</span><span class="punctuation">(</span><span class="punctuation">)</span> <span class="variable">methods</span><span class="operator">.</span> <span class="variable">Alternatively</span><span class="operator">,</span></span><br><span class="line"><span class="built_in">I</span><span class="operator">/</span><span class="variable">flutter</span> <span class="punctuation">(</span> <span class="number">8380</span><span class="punctuation">)</span><span class="operator">:</span> <span class="variable">initialization</span> <span class="variable">based</span> <span class="variable">on</span> <span class="variable">inherited</span> <span class="variable">widgets</span> <span class="variable">can</span> <span class="variable">be</span> <span class="variable">placed</span> <span class="variable">in</span> <span class="variable">the</span> <span class="variable">didChangeDependencies</span> <span class="variable">method</span><span class="operator">,</span> <span class="variable">which</span></span><br><span class="line"><span class="built_in">I</span><span class="operator">/</span><span class="variable">flutter</span> <span class="punctuation">(</span> <span class="number">8380</span><span class="punctuation">)</span><span class="operator">:</span> <span class="variable">is</span> <span class="variable">called</span> <span class="variable">after</span> <span class="variable">initState</span> <span class="variable">and</span> <span class="variable">whenever</span> <span class="variable">the</span> <span class="variable">dependencies</span> <span class="variable">change</span> <span class="variable">thereafter</span><span class="operator">.</span></span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>提示 <code>initState</code> 必须调用完成，才能使用 <code>Provider.of</code> 来获取祖先节点的 model，非要使用怎么办？办法也很简单， <code>of</code> 方法有一个属性值 <code>listen</code>，默认值为 <code>true</code>，将此值设置为 <code>false</code> 则不会建立与 Provider 的依赖关系，其实我在 Provider 的手册中也发现，建议在 <code>initState</code> 方法中调用 <code>of</code> 时，将 <code>listen</code> 设置为 <code>false</code>：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@<span class="function"><span class="keyword">override</span></span></span><br><span class="line"><span class="function"><span class="title">initState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  _userModel = Provider.<span class="built_in">of</span>&lt;UserModel&gt;(context, listen: <span class="literal">false</span>);</span><br><span class="line">  _model = Provider.<span class="built_in">of</span>&lt;HomeModel&gt;(context, listen: <span class="literal">false</span>);</span><br><span class="line">  super.<span class="built_in">initState</span>();</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>





<h1 id="如何实现网易云音乐、QQ音乐播放页面的背景图片模糊效果"><a href="#如何实现网易云音乐、QQ音乐播放页面的背景图片模糊效果" class="headerlink" title="如何实现网易云音乐、QQ音乐播放页面的背景图片模糊效果"></a>如何实现网易云音乐、QQ音乐播放页面的背景图片模糊效果</h1><p>分析一下，其实这种效果特别简单，首先放大背景图片，其次对图片进行高斯模糊，直接上代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">import <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line">import <span class="string">&#x27;dart:ui&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">main</span>() =&gt; <span class="title function_ invoke__">runApp</span>(<span class="title function_ invoke__">MyApp</span>());</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> image = Image.<span class="title function_ invoke__">asset</span>(</span><br><span class="line">    <span class="string">&#x27;assets/images/test.jpg&#x27;</span>,</span><br><span class="line">    <span class="attr">fit</span>: BoxFit.cover,</span><br><span class="line">    <span class="attr">width</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="attr">height</span>: <span class="number">200</span>,</span><br><span class="line">  );</span><br><span class="line">  </span><br><span class="line">  get blurImage =&gt; <span class="title function_ invoke__">ClipRRect</span>(</span><br><span class="line">    <span class="attr">child</span>: <span class="title function_ invoke__">Stack</span>(</span><br><span class="line">      <span class="attr">children</span>: &lt;Widget&gt;[</span><br><span class="line">        Transform.<span class="title function_ invoke__">scale</span>(</span><br><span class="line">          <span class="attr">scale</span>: <span class="number">1.5</span>,</span><br><span class="line">          <span class="attr">child</span>: image,</span><br><span class="line">        ),</span><br><span class="line">        <span class="title function_ invoke__">BackdropFilter</span>(</span><br><span class="line">          <span class="attr">filter</span>: ImageFilter.<span class="title function_ invoke__">blur</span>(<span class="attr">sigmaX</span>: <span class="number">5</span>, <span class="attr">sigmaY</span>: <span class="number">5</span>),</span><br><span class="line">          <span class="attr">child</span>: <span class="title function_ invoke__">Container</span>(</span><br><span class="line">            <span class="attr">width</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">height</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">alignment</span>: Alignment.center,</span><br><span class="line">            <span class="attr">color</span>: Colors.black.<span class="title function_ invoke__">withOpacity</span>(<span class="number">.3</span>),</span><br><span class="line">            <span class="attr">child</span>: <span class="title function_ invoke__">Text</span>(</span><br><span class="line">              <span class="string">&#x27;1 个内容&#x27;</span>,</span><br><span class="line">              <span class="attr">style</span>: <span class="title function_ invoke__">TextStyle</span>(</span><br><span class="line">                <span class="attr">fontSize</span>: <span class="number">24</span>,</span><br><span class="line">                <span class="attr">color</span>: Colors.white,</span><br><span class="line">              ),</span><br><span class="line">            ),</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">      ],</span><br><span class="line">    ),</span><br><span class="line">);</span><br><span class="line">  </span><br><span class="line">  @override</span><br><span class="line">  Widget <span class="title function_ invoke__">build</span>(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">MaterialApp</span>(</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&#x27;Flutter Demo app&#x27;</span>,</span><br><span class="line">      <span class="attr">theme</span>: <span class="title function_ invoke__">ThemeData</span>(<span class="attr">primarySwatch</span>: Colors.blue),</span><br><span class="line">      <span class="attr">home</span>: <span class="title function_ invoke__">Scaffold</span>(</span><br><span class="line">        <span class="attr">appBar</span>: <span class="title function_ invoke__">AppBar</span>(<span class="attr">title</span>: <span class="title function_ invoke__">Text</span>(<span class="string">&#x27;blur image demo&#x27;</span>)),</span><br><span class="line">        <span class="attr">body</span>: <span class="title function_ invoke__">Row</span>(</span><br><span class="line">          <span class="attr">mainAxisAlignment</span>: MainAxisAlignment.center,</span><br><span class="line">          <span class="attr">children</span>: &lt;Widget&gt;[</span><br><span class="line">            <span class="title function_ invoke__">Column</span>(</span><br><span class="line">              <span class="attr">mainAxisAlignment</span>: MainAxisAlignment.center,</span><br><span class="line">              <span class="attr">children</span>: &lt;Widget&gt;[</span><br><span class="line">                <span class="title function_ invoke__">Container</span>(</span><br><span class="line">                  <span class="attr">margin</span>: EdgeInsets.<span class="title function_ invoke__">only</span>(<span class="attr">bottom</span>: <span class="number">30</span>),</span><br><span class="line">                  <span class="attr">child</span>: image,</span><br><span class="line">                ),</span><br><span class="line">                blurImage,</span><br><span class="line">              ],</span><br><span class="line">            ),</span><br><span class="line">          ],</span><br><span class="line">        )</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>这个效果其实没什么难度，主要的知识点在于 <code>BackdropFilter</code> 组件默认的模糊效果是全屏的，必须使用 <code>ClipRRect</code> 进行裁剪，而且 <code>Transform</code> 的几个命名构造函数，如 <code>Transform.translate</code> 带来的效果是在绘制阶段发生的，会超出 <code>widget</code> 实际占用的空间，也需要使用 <code>ClipRRect</code> 进行裁剪，最后的效果图如下：</p>
<p><img src="/posts/136519660/blur_img.jpg" alt="blur_img.jpg"></p>
<h2 id="Dart-SDK-is-not-found-in-the-specified-location"><a href="#Dart-SDK-is-not-found-in-the-specified-location" class="headerlink" title="Dart SDK is not found in the specified location"></a>Dart SDK is not found in the specified location</h2><p>删除<code>flutter\bin</code>下的<code>cache</code>文件夹，重新运行<code>flutter doctor</code></p>
<!-- flag of hidden posts -->
      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div></div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt=" WeChat Pay"/>
        <p>WeChat Pay</p>
      </div>
    

    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/private/" rel="tag"># private</a>
          
            <a href="/tags/flutter/" rel="tag"># flutter</a>
          
        </div>
      

      
      
      

      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">74</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">31</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="mailto:shenbh@189.cn" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://blog.csdn.net/ptwenzi?spm=1010.2135.3001.5113" target="_blank" title="CSDN">
                      
                        <i class="fa fa-fw fa-clone"></i>CSDN</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/shenbh" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://gitee.com/shen_bh" target="_blank" title="Gitee">
                      
                        <i class="fa fa-fw fa-git"></i>Gitee</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E5%AE%BD%E9%AB%98%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98"><span class="nav-text">容器宽高相关问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Container-%E8%AE%BE%E7%BD%AE%E5%AE%BD%E9%AB%98%E4%B8%8D%E7%94%9F%E6%95%88"><span class="nav-text">Container 设置宽高不生效</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SignleChildScrollView-%E4%B8%8D%E6%BB%A1%E4%B8%80%E5%B1%8F%E9%AB%98%E5%BA%A6%E6%97%B6%E6%97%A0%E6%B3%95%E6%92%91%E6%BB%A1%E5%85%A8%E5%B1%8F"><span class="nav-text">SignleChildScrollView 不满一屏高度时无法撑满全屏</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Container-%E8%AE%BE%E7%BD%AE-borderRadius-%E4%B8%8D%E7%94%9F%E6%95%88"><span class="nav-text">Container  设置 borderRadius 不生效</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%83%E7%B4%A0%E6%98%BE%E7%A4%BA%E5%B1%82%E7%BA%A7%E9%97%AE%E9%A2%98"><span class="nav-text">元素显示层级问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%98%BE%E7%A4%BA%E9%9A%90%E8%97%8F%E7%9A%84%E5%87%A0%E7%A7%8D%E5%81%9A%E6%B3%95"><span class="nav-text">显示隐藏的几种做法</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#GestureDetector-%E8%AE%BE%E7%BD%AE-onTap-%E4%B8%8D%E7%94%9F%E6%95%88"><span class="nav-text">GestureDetector 设置 onTap 不生效</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%B0%83%E7%94%A8-setState-%E6%88%96-markNeedsBuild-%E5%90%8E%E6%8A%A5%E9%94%99"><span class="nav-text">调用 setState 或 markNeedsBuild 后报错</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E7%A7%8D%E6%8A%A5%E9%94%99"><span class="nav-text">第一种报错</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E7%A7%8D%E6%8A%A5%E9%94%99"><span class="nav-text">第二种报错</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E6%9B%B4%E6%94%B9-TabBar-%E7%9A%84%E9%95%BF%E5%BA%A6%E5%90%8E-setState-%E6%8A%A5%E9%94%99"><span class="nav-text">动态更改 TabBar 的长度后 setState 报错</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%94%AE%E7%9B%98%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98"><span class="nav-text">键盘相关问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%94%AE%E7%9B%98%E5%BC%B9%E5%87%BA%E5%90%8E%E5%B0%86%E5%B8%83%E5%B1%80%E9%A1%B6%E8%B5%B7%E6%9D%A5%E4%BA%86%EF%BC%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E9%81%AE%E4%BD%8F%E5%B8%83%E5%B1%80"><span class="nav-text">键盘弹出后将布局顶起来了，而不是遮住布局</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%B1%E6%83%B3%E8%AE%A9%E9%94%AE%E7%9B%98%E9%A1%B6%E8%B5%B7%E5%B8%83%E5%B1%80%EF%BC%8C%E5%B8%83%E5%B1%80%E5%8D%B4%E6%BA%A2%E5%87%BA%E4%BA%86%E6%80%8E%E4%B9%88%E5%8A%9E%EF%BC%9F"><span class="nav-text">就想让键盘顶起布局，布局却溢出了怎么办？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%94%AE%E7%9B%98%E5%BC%B9%E8%B5%B7%E5%92%8C%E6%94%B6%E5%9B%9E%E4%BC%9A%E5%BC%95%E8%B5%B7%E9%A1%B5%E9%9D%A2%E9%87%8D%E6%96%B0build"><span class="nav-text">键盘弹起和收回会引起页面重新build</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TextField-%E5%A6%82%E4%BD%95%E6%A0%B9%E6%8D%AE%E5%86%85%E5%AE%B9%E8%87%AA%E9%80%82%E5%BA%94%E9%AB%98%E5%BA%A6"><span class="nav-text">TextField 如何根据内容自适应高度</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TextField-%E8%AE%BE%E7%BD%AE-border-%E4%B8%8D%E7%94%9F%E6%95%88"><span class="nav-text">TextField 设置 border 不生效</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E8%B7%B3%E8%BD%AC%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98"><span class="nav-text">路由跳转相关问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#push%E3%80%81pop-%E5%B8%B8%E8%A7%81%E9%9C%80%E6%B1%82"><span class="nav-text">push、pop 常见需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E5%9C%A8-initState-%E9%98%B6%E6%AE%B5%E5%B0%B1%E8%83%BD%E4%BD%BF%E7%94%A8-context"><span class="nav-text">如何在 initState 阶段就能使用 context</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Mac-%E7%8E%AF%E5%A2%83-build-%E6%97%B6%E7%9A%84%E9%94%99%E8%AF%AF"><span class="nav-text">Mac 环境 build 时的错误</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PageView%E3%80%81ListView-%E7%AD%89%E6%BB%9A%E5%8A%A8%E7%BB%84%E4%BB%B6%E5%88%87%E6%8D%A2%E9%A1%B5%E9%9D%A2%E8%BF%94%E5%9B%9E%E5%90%8E%E7%9A%84%E9%AB%98%E5%BA%A6%E4%BD%8D%E7%BD%AE%E8%A2%AB%E6%94%B9%E5%8F%98%E4%BA%86"><span class="nav-text">PageView、ListView 等滚动组件切换页面返回后的高度位置被改变了</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E7%9B%91%E5%90%AC-App-%E8%BF%94%E5%9B%9E%E6%A1%8C%E9%9D%A2%E4%BA%8B%E4%BB%B6"><span class="nav-text">如何监听 App 返回桌面事件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Dio-%E5%B0%8F%E6%8A%80%E5%B7%A7"><span class="nav-text">Dio 小技巧</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Android-%E6%89%93%E5%8C%85%E5%90%8E%E6%97%A0%E6%B3%95%E8%BF%9B%E8%A1%8C%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82"><span class="nav-text">Android 打包后无法进行网络请求</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AF%B9%E4%BA%8E%E7%B1%BB%E4%B8%AD%E7%9A%84%E5%B1%9E%E6%80%A7%E5%92%8C%E6%96%B9%E6%B3%95%E7%9A%84%E5%AE%9A%E4%B9%89%E8%A7%84%E8%8C%83%E7%9A%84%E4%B8%80%E4%BA%9B%E5%BB%BA%E8%AE%AE"><span class="nav-text">对于类中的属性和方法的定义规范的一些建议</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%A8%E5%B1%8F%E7%9B%B8%E5%85%B3%E8%AE%BE%E7%BD%AE"><span class="nav-text">全屏相关设置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Transform-3D-%E8%BD%AC%E6%8D%A2"><span class="nav-text">Transform 3D 转换</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%86%E9%A2%91%E9%95%9C%E5%83%8F%E7%BF%BB%E8%BD%AC"><span class="nav-text">视频镜像翻转</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%8A%B6%E6%80%81%E6%A0%8F%E7%9B%B8%E5%85%B3%E8%AE%BE%E7%BD%AE"><span class="nav-text">状态栏相关设置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#fijkplayer-%E7%A7%92%E5%BC%80%E3%80%81%E8%BF%9B%E5%BA%A6%E8%B7%B3%E8%BD%AC%E7%AD%89%E4%BC%98%E5%8C%96"><span class="nav-text">fijkplayer 秒开、进度跳转等优化</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#LayoutBuilder-%E7%9B%B8%E5%85%B3%E7%9A%84%E5%AE%9E%E8%B7%B5"><span class="nav-text">LayoutBuilder 相关的实践</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%BE%AE%E4%BF%A1%E6%9C%8B%E5%8F%8B%E5%9C%88%E3%80%81%E5%93%94%E5%93%A9%E5%93%94%E5%93%A9%E8%AF%84%E8%AE%BA%E7%9A%84%E5%A4%9A%E8%A1%8C%E6%96%87%E6%9C%AC%E6%94%B6%E8%B5%B7%E3%80%81%E5%B1%95%E5%BC%80%E5%8A%9F%E8%83%BD"><span class="nav-text">如何实现微信朋友圈、哔哩哔哩评论的多行文本收起、展开功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%91%E5%90%AC%E7%88%B6%E7%BA%A7-widget-%E7%9A%84%E5%AE%9E%E9%99%85%E5%AE%BD%E9%AB%98%E4%BF%A1%E6%81%AF"><span class="nav-text">监听父级 widget 的实际宽高信息</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BA%95%E9%83%A8%E5%BC%B9%E5%87%BA%E5%8A%A8%E7%94%BB%E7%9A%84%E4%B8%A4%E7%A7%8D%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="nav-text">底部弹出动画的两种实现方式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-translate-%E5%AE%9E%E7%8E%B0"><span class="nav-text">使用 translate 实现</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Provider-%E8%B0%83%E7%94%A8%E9%97%AE%E9%A2%98"><span class="nav-text">Provider 调用问题</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%BD%91%E6%98%93%E4%BA%91%E9%9F%B3%E4%B9%90%E3%80%81QQ%E9%9F%B3%E4%B9%90%E6%92%AD%E6%94%BE%E9%A1%B5%E9%9D%A2%E7%9A%84%E8%83%8C%E6%99%AF%E5%9B%BE%E7%89%87%E6%A8%A1%E7%B3%8A%E6%95%88%E6%9E%9C"><span class="nav-text">如何实现网易云音乐、QQ音乐播放页面的背景图片模糊效果</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Dart-SDK-is-not-found-in-the-specified-location"><span class="nav-text">Dart SDK is not found in the specified location</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">阿炳</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('-1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
          if(result)$(this).text('Copied')
          else $(this).text('Copy failed')
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('Copy')
        }, 300)
      }).append(e)
    })
  </script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>